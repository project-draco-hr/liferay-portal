{
  StringBundler sb=new StringBundler(13);
  sb.append(themeDisplay.getPortalURL());
  sb.append(themeDisplay.getPathContext());
  sb.append("/documents/");
  sb.append(fileEntry.getRepositoryId());
  sb.append(StringPool.SLASH);
  sb.append(fileEntry.getFolderId());
  sb.append(StringPool.SLASH);
  sb.append(HttpUtil.encodeURL(HtmlUtil.unescape(fileEntry.getTitle()),true));
  sb.append("?version=");
  sb.append(fileVersion.getVersion());
  if (appendToken) {
    sb.append("&t=");
    Date modifiedDate=fileVersion.getModifiedDate();
    sb.append(modifiedDate.getTime());
  }
  sb.append(queryString);
  String previewURL=sb.toString();
  if (themeDisplay.isAddSessionIdToURL()) {
    return PortalUtil.getURLWithSessionId(previewURL,themeDisplay.getSessionId());
  }
  return previewURL;
}
