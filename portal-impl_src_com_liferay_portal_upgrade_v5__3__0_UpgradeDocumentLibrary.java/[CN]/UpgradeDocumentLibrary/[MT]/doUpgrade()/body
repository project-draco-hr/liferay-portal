{
  Connection con=null;
  PreparedStatement ps=null;
  ResultSet rs=null;
  try {
    con=DataAccess.getConnection();
    ps=con.prepareStatement("select * from DLFileEntry");
    rs=ps.executeQuery();
    while (rs.next()) {
      long companyId=rs.getLong("companyId");
      long groupId=rs.getLong("groupId");
      long userId=rs.getLong("userId");
      String userName=rs.getString("userName");
      long folderId=rs.getLong("folderId");
      String name=rs.getString("name");
      String title=rs.getString("title");
      String description=rs.getString("description");
      double version=rs.getDouble("version");
      int size=rs.getInt("size_");
      String portletId=PortletKeys.DOCUMENT_LIBRARY;
      long repositoryId=folderId;
      if (repositoryId == DLFolderConstants.DEFAULT_PARENT_FOLDER_ID) {
        repositoryId=groupId;
      }
      String newName=DLFileEntryNameUpgradeColumnImpl.getNewName(name);
      if (!newName.equals(name)) {
        DLServiceUtil.updateFile(companyId,portletId,groupId,repositoryId,name,newName,false);
      }
      addFileVersion(groupId,companyId,userId,userName,folderId,name,title,description,version,size);
    }
  }
  finally {
    DataAccess.cleanUp(con,ps,rs);
  }
  UpgradeColumn nameColumn=new DLFileEntryNameUpgradeColumnImpl("name");
  UpgradeColumn titleColumn=new DLFileEntryTitleUpgradeColumnImpl(nameColumn,"title");
  UpgradeTable upgradeTable=UpgradeTableFactoryUtil.getUpgradeTable(DLFileEntryImpl.TABLE_NAME,DLFileEntryImpl.TABLE_COLUMNS,nameColumn,titleColumn);
  upgradeTable.updateTable();
  upgradeTable=UpgradeTableFactoryUtil.getUpgradeTable(DLFileRankImpl.TABLE_NAME,DLFileRankImpl.TABLE_COLUMNS,nameColumn);
  upgradeTable.updateTable();
  UpgradeColumn toNameColumn=new DLFileEntryNameUpgradeColumnImpl("toName");
  upgradeTable=UpgradeTableFactoryUtil.getUpgradeTable(DLFileShortcutImpl.TABLE_NAME,DLFileShortcutImpl.TABLE_COLUMNS,toNameColumn);
  upgradeTable.updateTable();
  upgradeTable=UpgradeTableFactoryUtil.getUpgradeTable(DLFileVersionImpl.TABLE_NAME,DLFileVersionImpl.TABLE_COLUMNS,nameColumn);
  upgradeTable.updateTable();
}
