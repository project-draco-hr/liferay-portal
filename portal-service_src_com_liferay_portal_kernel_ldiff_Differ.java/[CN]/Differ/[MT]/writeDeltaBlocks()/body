{
  _firstBlockNumber=-1;
  _lastBlockNumber=-1;
  while (_reader.hasNext()) {
    BlockData blockData=_checksumsMap.get(Integer.valueOf(_reader.weakChecksum()));
    if (blockData != null && MessageDigest.isEqual(blockData.strongChecksum(),_reader.strongChecksum())) {
      int blockNumber=blockData.blockNumber();
      if (_firstBlockNumber == -1) {
        writeDataBlock();
        _firstBlockNumber=blockNumber;
        _lastBlockNumber=blockNumber;
      }
 else       if (_lastBlockNumber + 1 == blockNumber) {
        _lastBlockNumber=blockNumber;
      }
 else {
        writeReferenceBlock();
        _firstBlockNumber=blockNumber;
        _lastBlockNumber=blockNumber;
      }
      _reader.nextBlock();
    }
 else {
      writeReferenceBlock();
      if (!_dataBuffer.hasRemaining()) {
        writeDataBlock();
      }
      _dataBuffer.put(_reader.getFirstByte());
      _reader.nextByte();
    }
  }
  writeReferenceBlock();
  writeDataBlock();
  _delta.ensureSpace(1);
  _deltaBuffer.put(LDiff.EOF_KEY);
}
