{
  for (int i=0; i < _retries; i++) {
    try {
      PrincipalThreadLocal.setName(_userId);
      User user=UserLocalServiceUtil.getUserById(_userId);
      PermissionChecker permissionChecker=PermissionCheckerFactoryUtil.create(user);
      PermissionThreadLocal.setPermissionChecker(permissionChecker);
      doRun();
      _success=true;
      return;
    }
 catch (    Exception e) {
      _log.error(e,e);
    }
 finally {
      PrincipalThreadLocal.setName(null);
      PermissionThreadLocal.setPermissionChecker(null);
    }
  }
}
