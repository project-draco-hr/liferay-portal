{
  long exportImportConfigurationId=GetterUtil.getLong(message.getPayload());
  ExportImportConfiguration exportImportConfiguration=ExportImportConfigurationLocalServiceUtil.getExportImportConfiguration(exportImportConfigurationId);
  messageStatus.setPayload(exportImportConfiguration);
  Map<String,Serializable> settingsMap=exportImportConfiguration.getSettingsMap();
  long userId=MapUtil.getLong(settingsMap,"userId");
  long sourceGroupId=MapUtil.getLong(settingsMap,"sourceGroupId");
  long targetGroupId=MapUtil.getLong(settingsMap,"targetGroupId");
  boolean privateLayout=MapUtil.getBoolean(settingsMap,"privateLayout");
  long[] layoutIds=GetterUtil.getLongValues(settingsMap.get("layoutIds"));
  Map<String,String[]> parameterMap=(Map<String,String[]>)settingsMap.get("parameterMap");
  DateRange dateRange=ExportImportDateUtil.getDateRange(exportImportConfiguration);
  PrincipalThreadLocal.setName(userId);
  User user=UserLocalServiceUtil.getUserById(userId);
  PermissionChecker permissionChecker=null;
  try {
    permissionChecker=PermissionCheckerFactoryUtil.create(user);
  }
 catch (  Exception e) {
    throw new SystemException(e);
  }
  PermissionThreadLocal.setPermissionChecker(permissionChecker);
  ServiceContext serviceContext=new ServiceContext();
  serviceContext.setCompanyId(user.getCompanyId());
  serviceContext.setPathMain(PortalUtil.getPathMain());
  serviceContext.setSignedIn(!user.isDefaultUser());
  serviceContext.setUserId(user.getUserId());
  Map<String,Serializable> attributes=new HashMap<String,Serializable>();
  for (  Map.Entry<String,String[]> entry : parameterMap.entrySet()) {
    String param=entry.getKey();
    String[] values=entry.getValue();
    if (ArrayUtil.isNotEmpty(values)) {
      if (values.length == 1) {
        attributes.put(param,values[0]);
      }
 else {
        attributes.put(param,values);
      }
    }
  }
  serviceContext.setAttributes(attributes);
  ServiceContextThreadLocal.pushServiceContext(serviceContext);
  try {
    if (layoutIds == null) {
      StagingUtil.publishLayouts(userId,sourceGroupId,targetGroupId,privateLayout,parameterMap,dateRange.getStartDate(),dateRange.getEndDate());
    }
 else {
      StagingUtil.publishLayouts(userId,sourceGroupId,targetGroupId,privateLayout,layoutIds,parameterMap,dateRange.getStartDate(),dateRange.getEndDate());
    }
  }
  finally {
    PrincipalThreadLocal.setName(null);
    PermissionThreadLocal.setPermissionChecker(null);
  }
}
