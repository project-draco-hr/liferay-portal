{
  HttpServletRequest request=PortalUtil.getHttpServletRequest(actionRequest);
  HttpServletResponse response=PortalUtil.getHttpServletResponse(actionResponse);
  HttpSession session=request.getSession();
  ThemeDisplay themeDisplay=(ThemeDisplay)actionRequest.getAttribute(WebKeys.THEME_DISPLAY);
  String languageId=ParamUtil.getString(actionRequest,"languageId");
  Locale locale=LocaleUtil.fromLanguageId(languageId);
  List<Locale> availableLocales=ListUtil.fromArray(LanguageUtil.getAvailableLocales(themeDisplay.getSiteGroupId()));
  if (availableLocales.contains(locale)) {
    boolean persistState=ParamUtil.getBoolean(request,"persistState",true);
    if (themeDisplay.isSignedIn() && (persistState)) {
      User user=themeDisplay.getUser();
      Contact contact=user.getContact();
      AdminUtil.updateUser(actionRequest,user.getUserId(),user.getScreenName(),user.getEmailAddress(),user.getFacebookId(),user.getOpenId(),languageId,user.getTimeZoneId(),user.getGreeting(),user.getComments(),contact.getSmsSn(),contact.getAimSn(),contact.getFacebookSn(),contact.getIcqSn(),contact.getJabberSn(),contact.getMsnSn(),contact.getMySpaceSn(),contact.getSkypeSn(),contact.getTwitterSn(),contact.getYmSn());
    }
    session.setAttribute(Globals.LOCALE_KEY,locale);
    LanguageUtil.updateCookie(request,response,locale);
  }
  String redirect=ParamUtil.getString(actionRequest,"redirect");
  String layoutURL=StringPool.BLANK;
  String queryString=StringPool.BLANK;
  String url=StringPool.BLANK;
  int pos=redirect.indexOf(Portal.FRIENDLY_URL_SEPARATOR);
  if (pos == -1) {
    pos=redirect.indexOf(StringPool.QUESTION);
  }
 else {
    url=redirect.substring(0,pos);
    if (url.startsWith(StringPool.SLASH) && (url.length() > 1)) {
      url=url.substring(1);
    }
  }
  if (pos != -1) {
    layoutURL=redirect.substring(0,pos);
    queryString=redirect.substring(pos);
  }
  Layout layout=themeDisplay.getLayout();
  Group group=layout.getGroup();
  boolean groupFriendlyURL=PortalUtil.isGroupFriendlyURL(layoutURL,group.getFriendlyURL(),layout.getFriendlyURL(locale));
  if (groupFriendlyURL && (PropsValues.LOCALE_PREPEND_FRIENDLY_URL_STYLE == 0)) {
    redirect=layoutURL;
  }
 else   if (groupFriendlyURL || ((pos != -1) && Validator.isNull(layoutURL)) || (Validator.isNotNull(url) && (LocaleUtil.fromLanguageId(url,false,false) != null))) {
    redirect=PortalUtil.getGroupFriendlyURL(group,layout.isPrivateLayout(),themeDisplay,locale);
  }
 else {
    if (PropsValues.LOCALE_PREPEND_FRIENDLY_URL_STYLE == 0) {
      if (themeDisplay.isI18n()) {
        redirect=layout.getFriendlyURL(locale);
      }
 else {
        redirect=PortalUtil.getLayoutURL(layout,themeDisplay,locale);
      }
    }
 else {
      redirect=PortalUtil.getLayoutFriendlyURL(layout,themeDisplay,locale);
    }
  }
  int lifecycle=GetterUtil.getInteger(HttpUtil.getParameter(queryString,"p_p_lifecycle",false));
  if (lifecycle == 0) {
    redirect=redirect + queryString;
  }
  actionResponse.sendRedirect(redirect);
}
