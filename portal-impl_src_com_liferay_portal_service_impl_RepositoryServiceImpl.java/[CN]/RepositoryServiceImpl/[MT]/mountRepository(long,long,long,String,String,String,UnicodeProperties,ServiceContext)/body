{
  User user=getUser();
  Date now=new Date();
  long repositoryId=counterLocalService.increment();
  Repository repository=repositoryPersistence.create(repositoryId);
  repository.setGroupId(groupId);
  repository.setCompanyId(user.getCompanyId());
  repository.setCreateDate(now);
  repository.setModifiedDate(now);
  repository.setClassNameId(classNameId);
  repository.setName(name);
  repository.setDescription(description);
  repository.setPortletId(portletId);
  repository.setTypeSettingsProperties(typeSettingsProperties);
  if (classNameId != getDefaultClassNameId()) {
    try {
      createRepositoryImpl(repository,classNameId);
    }
 catch (    Exception e) {
      _log.error(e,e);
      throw new InvalidRepositoryException(e);
    }
  }
  long dlFolderId=getDLFolderId(user,groupId,repositoryId,parentFolderId,name,description,serviceContext);
  repository.setDlFolderId(dlFolderId);
  repositoryPersistence.update(repository,false);
  return repositoryId;
}
