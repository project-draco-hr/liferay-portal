{
  BaseRepository baseRepository=null;
  Repository repository=null;
  try {
    repository=getRepository(repositoryId);
    String repositoryImplClassName=PortalUtil.getClassName(classNameId);
    baseRepository=RepositoryFactoryUtil.getInstance(repositoryImplClassName);
  }
 catch (  Exception e) {
    throw new RepositoryException("There is no valid repository class with class name id " + classNameId,e);
  }
  CMISRepositoryHandler cmisRepositoryHandler=null;
  if (baseRepository instanceof CMISRepositoryHandler) {
    cmisRepositoryHandler=(CMISRepositoryHandler)baseRepository;
  }
 else   if (Proxy.isProxyClass(baseRepository.getClass())) {
    ClassLoaderBeanHandler classLoaderBeanHandler=(ClassLoaderBeanHandler)Proxy.getInvocationHandler(baseRepository);
    Object bean=classLoaderBeanHandler.getBean();
    if (bean instanceof CMISRepositoryHandler) {
      cmisRepositoryHandler=(CMISRepositoryHandler)bean;
    }
  }
  if (cmisRepositoryHandler != null) {
    CMISRepository cmisRepository=new CMISRepository(cmisRepositoryHandler);
    cmisRepositoryHandler.setCmisRepository(cmisRepository);
    setupRepository(repositoryId,repository,cmisRepository);
  }
  setupRepository(repositoryId,repository,baseRepository);
  baseRepository.initRepository();
  return baseRepository;
}
