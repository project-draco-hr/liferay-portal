{
  String servletContextName=_readServletContextName(url);
  String pathString=url.getPath();
  String fileName=pathString.substring(pathString.lastIndexOf('/') + 1,pathString.lastIndexOf(".war"));
  String version=String.valueOf(bundle.getVersion());
  int index=fileName.lastIndexOf('-');
  if (index >= 0) {
    version=fileName.substring(index + 1);
  }
  StringBundler sb=new StringBundler(7);
  sb.append("lpkg://");
  sb.append(URLCodec.encodeURL(bundle.getSymbolicName()));
  sb.append(StringPool.DASH);
  sb.append(bundle.getVersion());
  sb.append(StringPool.SLASH);
  sb.append(servletContextName);
  sb.append(".war");
  String lpkgURL=sb.toString();
  _urls.put(lpkgURL,url);
  try (UnsyncByteArrayOutputStream unsyncByteArrayOutputStream=new UnsyncByteArrayOutputStream()){
    try (JarOutputStream jarOutputStream=new JarOutputStream(unsyncByteArrayOutputStream)){
      _writeManifest(bundle,servletContextName,version,lpkgURL,jarOutputStream);
      _writeClasses(jarOutputStream,WARBundleWrapperBundleActivator.class,URLStreamHandlerServiceServiceTrackerCustomizer.class);
    }
     return new UnsyncByteArrayInputStream(unsyncByteArrayOutputStream.unsafeGetByteArray(),0,unsyncByteArrayOutputStream.size());
  }
 }
