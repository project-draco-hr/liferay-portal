{
  FileEntry fileEntry=DLAppServiceUtil.getFileEntryByUuidAndGroupId(uuid,groupId);
  if (fileEntry.isInTrash()) {
    throw new NoSuchFileEntryException();
  }
  if (Validator.isNull(version)) {
    InputStream inputStream=DLFileEntryLocalServiceUtil.getFileAsStream(userId,fileEntry.getFileEntryId(),fileEntry.getVersion(),false);
    return new DownloadServletInputStream(inputStream,fileEntry.getFileName(),fileEntry.getMimeType(),fileEntry.getSize());
  }
 else {
    if (versionId > 0) {
      DLFileVersion dlFileVersion=DLFileVersionLocalServiceUtil.fetchDLFileVersion(versionId);
      return new DownloadServletInputStream(dlFileVersion.getContentStream(false),dlFileVersion.getFileName(),dlFileVersion.getMimeType(),dlFileVersion.getSize());
    }
 else {
      FileVersion fileVersion=fileEntry.getFileVersion(version);
      return new DownloadServletInputStream(fileVersion.getContentStream(false),fileVersion.getFileName(),fileVersion.getMimeType(),fileVersion.getSize());
    }
  }
}
