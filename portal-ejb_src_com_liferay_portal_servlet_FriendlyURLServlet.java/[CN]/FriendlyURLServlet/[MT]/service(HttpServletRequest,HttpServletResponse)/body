{
  if (!PortalInstances.matches()) {
    return;
  }
  ServletContext ctx=getServletContext();
  String mainPath=MainServlet.DEFAULT_MAIN_PATH;
  String friendlyURLPath=null;
  if (_private) {
    if (_user) {
      friendlyURLPath=(String)ctx.getAttribute(WebKeys.FRIENDLY_URL_PRIVATE_USER_PATH);
    }
 else {
      friendlyURLPath=(String)ctx.getAttribute(WebKeys.FRIENDLY_URL_PRIVATE_GROUP_PATH);
    }
  }
 else {
    friendlyURLPath=(String)ctx.getAttribute(WebKeys.FRIENDLY_URL_PUBLIC_PATH);
  }
  String redirect=mainPath;
  try {
    redirect=getRedirect(req.getPathInfo(),mainPath,req.getParameterMap());
    LastPath lastPath=new LastPath(friendlyURLPath,req.getPathInfo(),req.getParameterMap());
    req.setAttribute(WebKeys.LAST_PATH,lastPath);
  }
 catch (  NoSuchLayoutException nsle) {
    _log.warn(nsle);
    redirect=PropsUtil.get(PropsUtil.LAYOUT_FRIENDLY_URL_PAGE_NOT_FOUND);
  }
catch (  Exception e) {
    if (_log.isWarnEnabled()) {
      _log.warn(e);
    }
  }
  if (Validator.isNull(redirect)) {
    redirect=mainPath;
  }
  if (redirect.startsWith(StringPool.SLASH)) {
    RequestDispatcher rd=ctx.getRequestDispatcher(redirect);
    if (rd != null) {
      rd.forward(req,res);
    }
  }
 else {
    res.sendRedirect(redirect);
  }
}
