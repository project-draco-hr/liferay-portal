{
  StringBuilder shortUrl=new StringBuilder();
  String[] params=url.split(StringPool.AMPERSAND);
  if (num == 0) {
    return null;
  }
  for (int i=0; i < params.length; i++) {
    String param=params[i];
    int redirectIdx=param.indexOf("_redirect=");
    int returnFullIdx=param.indexOf("_returnToFullPageURL=");
    int backUrlIdx=param.indexOf("_backURL=");
    if (redirectIdx > -1 || returnFullIdx > -1 || backUrlIdx > -1) {
      int urlIdx=param.indexOf(StringPool.EQUAL);
      String qName=param.substring(0,urlIdx);
      String redirectUrl=param.substring(urlIdx + 1);
      redirectUrl=HttpUtil.decodeURL(redirectUrl);
      String newUrl=shortenURL(redirectUrl,--num);
      if (newUrl != null) {
        newUrl=HttpUtil.encodeURL(newUrl);
        shortUrl.append(qName);
        shortUrl.append(StringPool.EQUAL);
        shortUrl.append(newUrl);
        if (i < params.length - 1) {
          shortUrl.append(StringPool.AMPERSAND);
        }
      }
    }
 else {
      shortUrl.append(param);
      if (i < params.length - 1) {
        shortUrl.append(StringPool.AMPERSAND);
      }
    }
  }
  return shortUrl.toString();
}
