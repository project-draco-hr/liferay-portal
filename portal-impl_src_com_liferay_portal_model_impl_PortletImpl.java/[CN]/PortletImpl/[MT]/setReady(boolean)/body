{
  Lock lock=_readyLock.get(getRootPortletId());
  if (lock == null) {
    Lock newLock=new ReentrantLock();
    lock=_readyLock.putIfAbsent(getRootPortletId(),newLock);
    if (lock == null) {
      lock=newLock;
    }
  }
  try {
    lock.lock();
    Lock doubleCheckLock=_readyLock.get(getRootPortletId());
    if (lock != doubleCheckLock) {
      return;
    }
    Boolean readyMapValue=_readyMap.get(getRootPortletId());
    if ((readyMapValue != null) && (ready == readyMapValue)) {
      return;
    }
    Registry registry=RegistryUtil.getRegistry();
    if (ready) {
      ServiceRegistrar<Portlet> serviceRegistrar=registry.getServiceRegistrar(Portlet.class);
      Map<String,Object> properties=new HashMap<>();
      properties.put("javax.portlet.name",getPortletName());
      serviceRegistrar.registerService(Portlet.class,this,properties);
      _serviceRegistrars.put(getRootPortletId(),serviceRegistrar);
    }
 else {
      ServiceRegistrar<Portlet> serviceRegistrar=_serviceRegistrars.remove(getRootPortletId());
      serviceRegistrar.destroy();
    }
    _readyMap.put(getRootPortletId(),ready);
  }
  finally {
    lock.unlock();
  }
}
