{
  Registry registry=RegistryUtil.getRegistry();
  Readiness readiness=new Readiness(ready,registry.getServiceRegistrar(Portlet.class));
  String rootPortletId=getRootPortletId();
  Readiness previousReadiness=_readinessMap.putIfAbsent(rootPortletId,readiness);
  if (previousReadiness != null) {
    readiness=previousReadiness;
  }
synchronized (readiness) {
    if (readiness != _readinessMap.get(rootPortletId)) {
      return;
    }
    readiness._ready=ready;
    ServiceRegistrar<Portlet> serviceRegistrar=readiness._serviceRegistrar;
    if (ready) {
      if (serviceRegistrar.isDestroyed()) {
        serviceRegistrar=registry.getServiceRegistrar(Portlet.class);
        readiness._serviceRegistrar=serviceRegistrar;
      }
      Map<String,Object> properties=new HashMap<>();
      properties.put("javax.portlet.name",getPortletName());
      serviceRegistrar.registerService(Portlet.class,this,properties);
    }
 else {
      serviceRegistrar.destroy();
    }
  }
}
