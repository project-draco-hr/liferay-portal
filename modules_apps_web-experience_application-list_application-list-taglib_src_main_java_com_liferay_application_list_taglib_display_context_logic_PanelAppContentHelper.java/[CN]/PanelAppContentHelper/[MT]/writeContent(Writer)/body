{
  ThemeDisplay themeDisplay=_getThemeDisplay();
  String layoutTemplateId="max";
  if (themeDisplay.isStatePopUp()) {
    layoutTemplateId="pop_up";
  }
  Theme theme=themeDisplay.getTheme();
  String velocityTemplateId=theme.getThemeId() + LayoutTemplateConstants.STANDARD_SEPARATOR + layoutTemplateId;
  String content=LayoutTemplateLocalServiceUtil.getContent(layoutTemplateId,true,theme.getThemeId());
  if (Validator.isNotNull(velocityTemplateId) && Validator.isNotNull(content)) {
    HttpServletRequest request=getOriginalHttpServletRequest(_request);
    StringBundler sb=RuntimePageUtil.getProcessedTemplate(request,_response,getPortletId(),new StringTemplateResource(velocityTemplateId,content));
    if (sb != null) {
      sb.writeTo(writer);
    }
  }
}
