{
  List badItemIds=new ArrayList();
  Map items=getItems(groupId,itemIds);
  Iterator itr=items.entrySet().iterator();
  while (itr.hasNext()) {
    Map.Entry entry=(Map.Entry)itr.next();
    ShoppingCartItem cartItem=(ShoppingCartItem)entry.getKey();
    Integer count=(Integer)entry.getValue();
    ShoppingItem item=cartItem.getItem();
    int minQuantity=ShoppingUtil.getMinQuantity(item);
    if (minQuantity > 0) {
      if ((count.intValue() % minQuantity) > 0) {
        badItemIds.add(item.getItemId());
      }
    }
  }
  if (badItemIds.size() > 0) {
    throw new CartMinQuantityException(StringUtil.merge((String[])badItemIds.toArray(new String[0])));
  }
  String[] couponIdsArray=StringUtil.split(couponIds);
  for (int i=0; i < couponIdsArray.length; i++) {
    try {
      ShoppingCoupon coupon=ShoppingCouponUtil.findByPrimaryKey(couponIdsArray[i]);
      if (coupon.getGroupId() != groupId) {
        throw new NoSuchCouponException(couponIdsArray[i]);
      }
 else       if (!coupon.isActive()) {
        throw new CouponActiveException(couponIdsArray[i]);
      }
 else       if (!coupon.hasValidStartDate()) {
        throw new CouponStartDateException(couponIdsArray[i]);
      }
 else       if (!coupon.hasValidEndDate()) {
        throw new CouponEndDateException(couponIdsArray[i]);
      }
    }
 catch (    NoSuchCouponException nsce) {
      throw new NoSuchCouponException(couponIdsArray[i]);
    }
    break;
  }
  User user=UserUtil.findByPrimaryKey(userId);
  Date now=new Date();
  ShoppingCart cart=null;
  if (user.isDefaultUser()) {
    cart=ShoppingCartUtil.create(cartId);
    cart.setGroupId(groupId);
    cart.setCompanyId(user.getCompanyId());
    cart.setUserId(userId);
    cart.setUserName(user.getFullName());
    cart.setCreateDate(now);
  }
 else {
    try {
      cart=ShoppingCartUtil.findByPrimaryKey(cartId);
    }
 catch (    NoSuchCartException nsce) {
      cart=ShoppingCartUtil.create(cartId);
      cart.setGroupId(groupId);
      cart.setCompanyId(user.getCompanyId());
      cart.setUserId(userId);
      cart.setUserName(user.getFullName());
      cart.setCreateDate(now);
    }
  }
  cart.setModifiedDate(now);
  cart.setItemIds(checkItemIds(groupId,itemIds));
  cart.setCouponIds(couponIds);
  cart.setAltShipping(altShipping);
  cart.setInsure(insure);
  if (!user.isDefaultUser()) {
    ShoppingCartUtil.update(cart);
  }
  return cart;
}
