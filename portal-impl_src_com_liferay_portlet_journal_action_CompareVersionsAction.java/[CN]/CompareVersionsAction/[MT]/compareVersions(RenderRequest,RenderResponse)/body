{
  ThemeDisplay themeDisplay=(ThemeDisplay)renderRequest.getAttribute(WebKeys.THEME_DISPLAY);
  long groupId=ParamUtil.getLong(renderRequest,"groupId");
  String articleId=ParamUtil.getString(renderRequest,"articleId");
  String sourceArticleId=ParamUtil.getString(renderRequest,"sourceVersion");
  int index=sourceArticleId.lastIndexOf(EditArticleAction.VERSION_SEPARATOR);
  if (index != -1) {
    sourceArticleId=sourceArticleId.substring(index + EditArticleAction.VERSION_SEPARATOR.length(),sourceArticleId.length());
  }
  double sourceVersion=GetterUtil.getDouble(sourceArticleId);
  String targetArticleId=ParamUtil.getString(renderRequest,"targetVersion");
  index=targetArticleId.lastIndexOf(EditArticleAction.VERSION_SEPARATOR);
  if (index != -1) {
    targetArticleId=targetArticleId.substring(index + EditArticleAction.VERSION_SEPARATOR.length(),targetArticleId.length());
  }
  double targetVersion=GetterUtil.getDouble(targetArticleId);
  if ((sourceVersion == 0) && (targetVersion == 0)) {
    List<JournalArticle> articles=JournalArticleServiceUtil.getArticlesByArticleId(groupId,articleId,0,2,new ArticleVersionComparator(false));
    sourceVersion=articles.get(0).getVersion();
    targetVersion=articles.get(1).getVersion();
  }
  if (sourceVersion > targetVersion) {
    double tempVersion=targetVersion;
    targetVersion=sourceVersion;
    sourceVersion=tempVersion;
  }
  String xmlRequest=PortletRequestUtil.toXML(renderRequest,renderResponse);
  JournalArticle sourceArticle=JournalArticleLocalServiceUtil.fetchArticle(groupId,articleId,sourceVersion);
  JournalArticle targetArticle=JournalArticleLocalServiceUtil.fetchArticle(groupId,articleId,targetVersion);
  Set<Locale> locales=new HashSet<Locale>();
  for (  String locale : sourceArticle.getAvailableLanguageIds()) {
    locales.add(LocaleUtil.fromLanguageId(locale));
  }
  for (  String locale : targetArticle.getAvailableLanguageIds()) {
    locales.add(LocaleUtil.fromLanguageId(locale));
  }
  String languageId=ParamUtil.get(renderRequest,"languageId",targetArticle.getDefaultLanguageId());
  Locale locale=LocaleUtil.fromLanguageId(languageId);
  if (!locales.contains(locale)) {
    languageId=targetArticle.getDefaultLanguageId();
  }
  JournalArticleDisplay sourceArticleDisplay=JournalArticleLocalServiceUtil.getArticleDisplay(groupId,articleId,sourceVersion,null,Constants.VIEW,languageId,1,xmlRequest,themeDisplay);
  JournalArticleDisplay targetArticleDisplay=JournalArticleLocalServiceUtil.getArticleDisplay(groupId,articleId,targetVersion,null,Constants.VIEW,languageId,1,xmlRequest,themeDisplay);
  String diffHtmlResults=DiffHtmlUtil.diff(new UnsyncStringReader(sourceArticleDisplay.getContent()),new UnsyncStringReader(targetArticleDisplay.getContent()));
  renderRequest.setAttribute("languageId",languageId);
  renderRequest.setAttribute(WebKeys.AVAILABLE_LOCALES,locales);
  renderRequest.setAttribute(WebKeys.DIFF_HTML_RESULTS,diffHtmlResults);
  renderRequest.setAttribute(WebKeys.SOURCE_VERSION,sourceVersion);
  renderRequest.setAttribute(WebKeys.TARGET_VERSION,targetVersion);
}
