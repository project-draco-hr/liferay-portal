{
  Folder folder=fromLocalRepository.getFolder(folderId);
  Folder newFolder=toLocalRepository.addFolder(userId,parentFolderId,folder.getName(),folder.getDescription(),serviceContext);
  List<Object> foldersAndFileEntriesAndFileShortcuts=dlAppService.getFoldersAndFileEntriesAndFileShortcuts(fromLocalRepository.getRepositoryId(),folderId,WorkflowConstants.STATUS_ANY,true,QueryUtil.ALL_POS,QueryUtil.ALL_POS);
  try {
    for (    Object folderAndFileEntryAndFileShortcut : foldersAndFileEntriesAndFileShortcuts) {
      if (folderAndFileEntryAndFileShortcut instanceof FileEntry) {
        FileEntry fileEntry=(FileEntry)folderAndFileEntryAndFileShortcut;
        copyFileEntry(userId,toLocalRepository,fileEntry,newFolder.getFolderId(),serviceContext);
      }
 else       if (folderAndFileEntryAndFileShortcut instanceof Folder) {
        Folder currentFolder=(Folder)folderAndFileEntryAndFileShortcut;
        moveFolders(userId,currentFolder.getFolderId(),newFolder.getFolderId(),fromLocalRepository,toLocalRepository,serviceContext);
      }
 else       if (folderAndFileEntryAndFileShortcut instanceof DLFileShortcut) {
        if (newFolder.isSupportsShortcuts()) {
          DLFileShortcut dlFileShorcut=(DLFileShortcut)folderAndFileEntryAndFileShortcut;
          dlFileShortcutLocalService.addFileShortcut(userId,dlFileShorcut.getGroupId(),newFolder.getFolderId(),dlFileShorcut.getToFileEntryId(),serviceContext);
        }
      }
    }
  }
 catch (  PortalException pe) {
    toLocalRepository.deleteFolder(newFolder.getFolderId());
    throw pe;
  }
  try {
    fromLocalRepository.deleteFolder(folderId);
  }
 catch (  PortalException pe) {
    toLocalRepository.deleteFolder(newFolder.getFolderId());
    throw pe;
  }
  return newFolder;
}
