{
  List<FileVersion> fileVersions=fileEntry.getFileVersions(WorkflowConstants.STATUS_ANY);
  int fileVersionsSize=fileVersions.size();
  FileVersion currentFileVersion=fileVersions.get(fileVersionsSize - 1);
  FileEntry destinationFileEntry=toRepository.addFileEntry(userId,newFolderId,fileEntry.getNameWithExtension(),currentFileVersion.getMimeType(),currentFileVersion.getTitle(),currentFileVersion.getDescription(),StringPool.BLANK,currentFileVersion.getContentStream(false),currentFileVersion.getSize(),serviceContext);
  for (int i=fileVersionsSize - 2; i >= 0; i--) {
    currentFileVersion=fileVersions.get(i);
    FileVersion previousFileVersion=fileVersions.get(i + 1);
    try {
      destinationFileEntry=toRepository.updateFileEntry(userId,destinationFileEntry.getFileEntryId(),fileEntry.getNameWithExtension(),destinationFileEntry.getMimeType(),destinationFileEntry.getTitle(),destinationFileEntry.getDescription(),StringPool.BLANK,isMajorVersion(currentFileVersion,previousFileVersion),currentFileVersion.getContentStream(false),currentFileVersion.getSize(),serviceContext);
    }
 catch (    PortalException pe) {
      toRepository.deleteFileEntry(destinationFileEntry.getFileEntryId());
      throw pe;
    }
  }
  return destinationFileEntry;
}
