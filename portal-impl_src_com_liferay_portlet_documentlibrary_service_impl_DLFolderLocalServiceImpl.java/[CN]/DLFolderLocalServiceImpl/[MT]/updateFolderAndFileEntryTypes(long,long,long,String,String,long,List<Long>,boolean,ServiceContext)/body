{
  boolean hasLock=hasFolderLock(userId,folderId);
  Lock lock=null;
  if (!hasLock) {
    lock=lockFolder(userId,folderId,null,false,DLFolderImpl.LOCK_EXPIRATION_TIME);
  }
  try {
    if (!overrideFileEntryTypes) {
      fileEntryTypeIds=Collections.emptyList();
    }
    DLFolder dlFolder=dlFolderPersistence.findByPrimaryKey(folderId);
    parentFolderId=getParentFolderId(dlFolder,parentFolderId);
    validateFolder(folderId,dlFolder.getGroupId(),parentFolderId,name);
    dlFolder.setModifiedDate(serviceContext.getModifiedDate(null));
    dlFolder.setParentFolderId(parentFolderId);
    dlFolder.setTreePath(dlFolder.buildTreePath());
    dlFolder.setName(name);
    dlFolder.setDescription(description);
    dlFolder.setExpandoBridgeAttributes(serviceContext);
    dlFolder.setOverrideFileEntryTypes(overrideFileEntryTypes);
    dlFolder.setDefaultFileEntryTypeId(defaultFileEntryTypeId);
    dlFolderPersistence.update(dlFolder);
    if (fileEntryTypeIds != null) {
      dlFileEntryTypeLocalService.updateFolderFileEntryTypes(dlFolder,fileEntryTypeIds,defaultFileEntryTypeId,serviceContext);
    }
    dlAppHelperLocalService.updateFolder(userId,new LiferayFolder(dlFolder),serviceContext);
    return dlFolder;
  }
  finally {
    if (!hasLock) {
      unlockFolder(folderId,lock.getUuid());
    }
  }
}
