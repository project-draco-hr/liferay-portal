{
  boolean hasLock=hasFolderLock(userId,folderId);
  Lock lock=null;
  if (!hasLock) {
    lock=lockFolder(userId,folderId);
  }
  try {
    DLFolder dlFolder=dlFolderPersistence.findByPrimaryKey(folderId);
    parentFolderId=getParentFolderId(dlFolder,parentFolderId);
    if (dlFolder.getParentFolderId() == parentFolderId) {
      return dlFolder;
    }
    validateFolder(dlFolder.getFolderId(),dlFolder.getGroupId(),parentFolderId,dlFolder.getName());
    dlFolder.setParentFolderId(parentFolderId);
    dlFolder.setTreePath(dlFolder.buildTreePath());
    dlFolder.setExpandoBridgeAttributes(serviceContext);
    dlFolderPersistence.update(dlFolder);
    rebuildTree(dlFolder.getCompanyId(),folderId,dlFolder.getTreePath(),true);
    return dlFolder;
  }
  finally {
    if (!hasLock) {
      unlockFolder(folderId,lock.getUuid());
    }
  }
}
