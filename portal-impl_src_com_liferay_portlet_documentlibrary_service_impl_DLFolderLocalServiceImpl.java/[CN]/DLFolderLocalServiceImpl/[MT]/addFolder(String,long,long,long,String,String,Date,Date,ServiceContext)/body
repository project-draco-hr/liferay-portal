{
  User user=userPersistence.findByPrimaryKey(userId);
  parentFolderId=getParentFolderId(groupId,parentFolderId);
  validate(groupId,parentFolderId,name);
  long folderId=counterLocalService.increment();
  DLFolder folder=dlFolderPersistence.create(folderId);
  folder.setUuid(uuid);
  folder.setGroupId(groupId);
  folder.setCompanyId(user.getCompanyId());
  folder.setUserId(user.getUserId());
  folder.setCreateDate(createDate);
  folder.setModifiedDate(modifiedDate);
  folder.setParentFolderId(parentFolderId);
  folder.setName(name);
  folder.setDescription(description);
  folder.setExpandoBridgeAttributes(serviceContext);
  dlFolderPersistence.update(folder,false);
  if (serviceContext.getAddCommunityPermissions() || serviceContext.getAddGuestPermissions()) {
    addFolderResources(folder,serviceContext.getAddCommunityPermissions(),serviceContext.getAddGuestPermissions());
  }
 else {
    addFolderResources(folder,serviceContext.getCommunityPermissions(),serviceContext.getGuestPermissions());
  }
  if (PropsValues.DL_LAYOUTS_SYNC_ENABLED && (parentFolderId != DLFolderConstants.DEFAULT_PARENT_FOLDER_ID)) {
    String[] pathArray=folder.getPathArray();
    String layoutsSyncPrivateFolder=GetterUtil.getString(PropsUtil.get(PropsKeys.DL_LAYOUTS_SYNC_PRIVATE_FOLDER));
    String layoutsSyncPublicFolder=GetterUtil.getString(PropsUtil.get(PropsKeys.DL_LAYOUTS_SYNC_PUBLIC_FOLDER));
    if (pathArray[0].equals(layoutsSyncPrivateFolder) || pathArray[0].equals(layoutsSyncPublicFolder)) {
      boolean privateLayout=true;
      if (pathArray[0].equals(layoutsSyncPublicFolder)) {
        privateLayout=false;
      }
      long parentLayoutId=LayoutConstants.DEFAULT_PARENT_LAYOUT_ID;
      String title=StringPool.BLANK;
      String layoutDescription=StringPool.BLANK;
      String type=LayoutConstants.TYPE_PORTLET;
      boolean hidden=false;
      String friendlyURL=StringPool.BLANK;
      Layout dlFolderLayout=null;
      try {
        dlFolderLayout=layoutLocalService.getDLFolderLayout(folder.getParentFolderId());
        parentLayoutId=dlFolderLayout.getLayoutId();
      }
 catch (      NoSuchLayoutException nsle) {
      }
      layoutLocalService.addLayout(userId,groupId,privateLayout,parentLayoutId,name,title,layoutDescription,type,hidden,friendlyURL,folder.getFolderId(),new ServiceContext());
    }
  }
  if (parentFolderId != DLFolderConstants.DEFAULT_PARENT_FOLDER_ID) {
    DLFolder parentFolder=dlFolderPersistence.findByPrimaryKey(parentFolderId);
    parentFolder.setLastPostDate(modifiedDate);
    dlFolderPersistence.update(parentFolder,false);
  }
  return folder;
}
