{
  if ((restrictionType == DLFolderConstants.RESTRICTION_TYPE_FILE_ENTRY_TYPES_AND_WORKFLOW) && fileEntryTypeIds.isEmpty()) {
    throw new RequiredFileEntryTypeException("File entry type IDs is empty");
  }
  boolean hasLock=hasFolderLock(userId,folderId);
  Lock lock=null;
  if (!hasLock) {
    lock=lockFolder(userId,folderId,null,false,DLFolderImpl.LOCK_EXPIRATION_TIME);
  }
  try {
    if (restrictionType == DLFolderConstants.RESTRICTION_TYPE_INHERIT) {
      fileEntryTypeIds=Collections.emptyList();
    }
    DLFolder dlFolder=dlFolderPersistence.findByPrimaryKey(folderId);
    parentFolderId=getParentFolderId(dlFolder,parentFolderId);
    validateFolder(folderId,dlFolder.getGroupId(),parentFolderId,name);
    long oldParentFolderId=dlFolder.getParentFolderId();
    if (oldParentFolderId != parentFolderId) {
      dlFolder.setParentFolderId(parentFolderId);
      dlFolder.setTreePath(dlFolder.buildTreePath());
    }
    dlFolder.setName(name);
    dlFolder.setDescription(description);
    dlFolder.setExpandoBridgeAttributes(serviceContext);
    dlFolder.setRestrictionType(restrictionType);
    dlFolder.setDefaultFileEntryTypeId(defaultFileEntryTypeId);
    dlFolderPersistence.update(dlFolder);
    if (fileEntryTypeIds != null) {
      dlFileEntryTypeLocalService.updateFolderFileEntryTypes(dlFolder,fileEntryTypeIds,defaultFileEntryTypeId,serviceContext);
    }
    if (oldParentFolderId != parentFolderId) {
      rebuildTree(dlFolder.getCompanyId(),folderId,dlFolder.getTreePath(),true);
    }
    return dlFolder;
  }
  finally {
    if (!hasLock) {
      unlockFolder(folderId,lock.getUuid());
    }
  }
}
