{
  Connection con=null;
  PreparedStatement ps=null;
  ResultSet rs=null;
  try {
    List kvpList=new ArrayList();
    con=DataAccess.getConnection(Constants.DATA_SOURCE);
    ps=con.prepareStatement(_UPGRADE_MESSAGE_1);
    ps.setString(1,topicId);
    rs=ps.executeQuery();
    while (rs.next()) {
      String oldMessageId=rs.getString("messageId");
      String newMessageId=Long.toString(CounterServiceUtil.increment(MBMessage.class.getName()));
      kvpList.add(new KeyValuePair(oldMessageId,newMessageId));
    }
    for (int i=kvpList.size() - 1; i >= 0; i--) {
      KeyValuePair kvp=(KeyValuePair)kvpList.get(i);
      String oldMessageId=kvp.getKey();
      String newMessageId=kvp.getValue();
      _log.debug("Upgrading message " + new MBMessagePK(topicId,oldMessageId));
      ps=con.prepareStatement(_UPGRADE_MESSAGE_5);
      ps.setString(1,newMessageId);
      ps.setString(2,topicId);
      ps.setString(3,oldMessageId);
      ps.executeUpdate();
    }
    for (int i=0; i < kvpList.size(); i++) {
      KeyValuePair kvp=(KeyValuePair)kvpList.get(i);
      String oldMessageId=kvp.getKey();
      String newMessageId=kvp.getValue();
      _log.debug("Upgrading message " + new MBMessagePK(topicId,oldMessageId));
      _upgradeMessage(categoryId,topicId,oldMessageId,newMessageId);
    }
  }
  finally {
    DataAccess.cleanUp(con,ps,rs);
  }
}
