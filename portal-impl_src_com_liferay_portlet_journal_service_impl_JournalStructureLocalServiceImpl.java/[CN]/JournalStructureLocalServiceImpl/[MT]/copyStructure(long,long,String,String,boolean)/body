{
  User user=userPersistence.findByPrimaryKey(userId);
  oldStructureId=oldStructureId.trim().toUpperCase();
  newStructureId=newStructureId.trim().toUpperCase();
  Date now=new Date();
  JournalStructure oldStructure=journalStructurePersistence.findByG_S(groupId,oldStructureId);
  if (autoStructureId) {
    newStructureId=String.valueOf(counterLocalService.increment());
  }
 else {
    validateStructureId(newStructureId);
    JournalStructure newStructure=journalStructurePersistence.fetchByG_S(groupId,newStructureId);
    if (newStructure != null) {
      throw new DuplicateStructureIdException();
    }
  }
  long id=counterLocalService.increment();
  JournalStructure newStructure=journalStructurePersistence.create(id);
  newStructure.setGroupId(groupId);
  newStructure.setCompanyId(user.getCompanyId());
  newStructure.setUserId(user.getUserId());
  newStructure.setUserName(user.getFullName());
  newStructure.setCreateDate(now);
  newStructure.setModifiedDate(now);
  newStructure.setStructureId(newStructureId);
  newStructure.setNameMap(oldStructure.getNameMap());
  newStructure.setDescriptionMap(oldStructure.getDescriptionMap());
  newStructure.setXsd(oldStructure.getXsd());
  journalStructurePersistence.update(newStructure);
  addStructureResources(newStructure,true,true);
  return newStructure;
}
