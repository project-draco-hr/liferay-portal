{
  User user=userPersistence.findByPrimaryKey(userId);
  structureId=structureId.trim().toUpperCase();
  Date now=new Date();
  try {
    xsd=DDMXMLUtil.formatXML(xsd);
  }
 catch (  Exception e) {
    throw new StructureXsdException();
  }
  if (autoStructureId) {
    structureId=String.valueOf(counterLocalService.increment());
  }
  validate(groupId,structureId,autoStructureId,parentStructureId,nameMap,xsd);
  long id=counterLocalService.increment();
  JournalStructure structure=journalStructurePersistence.create(id);
  structure.setUuid(serviceContext.getUuid());
  structure.setGroupId(groupId);
  structure.setCompanyId(user.getCompanyId());
  structure.setUserId(user.getUserId());
  structure.setUserName(user.getFullName());
  structure.setCreateDate(serviceContext.getCreateDate(now));
  structure.setModifiedDate(serviceContext.getModifiedDate(now));
  structure.setStructureId(structureId);
  structure.setParentStructureId(parentStructureId);
  structure.setNameMap(nameMap);
  structure.setDescriptionMap(descriptionMap);
  structure.setXsd(xsd);
  structure.setExpandoBridgeAttributes(serviceContext);
  journalStructurePersistence.update(structure);
  if (serviceContext.isAddGroupPermissions() || serviceContext.isAddGuestPermissions()) {
    addStructureResources(structure,serviceContext.isAddGroupPermissions(),serviceContext.isAddGuestPermissions());
  }
 else {
    addStructureResources(structure,serviceContext.getGroupPermissions(),serviceContext.getGuestPermissions());
  }
  return structure;
}
