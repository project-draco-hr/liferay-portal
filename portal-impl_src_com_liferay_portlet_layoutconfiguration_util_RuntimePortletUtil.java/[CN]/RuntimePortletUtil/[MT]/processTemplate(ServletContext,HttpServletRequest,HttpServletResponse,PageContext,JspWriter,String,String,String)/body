{
  if (Validator.isNull(velocityTemplateContent)) {
    return;
  }
  TemplateProcessor processor=new TemplateProcessor(servletContext,request,response,portletId);
  VelocityContext velocityContext=VelocityEngineUtil.getWrappedStandardToolsContext();
  velocityContext.put("processor",processor);
  VelocityVariables.insertVariables(velocityContext,request);
  UnsyncStringWriter unsyncStringWriter=new UnsyncStringWriter();
  MethodWrapper methodWrapper=new MethodWrapper("com.liferay.taglib.util.VelocityTaglib","init",new Object[]{servletContext,request,new PipingServletResponse(response,unsyncStringWriter),pageContext});
  Object velocityTaglib=MethodInvoker.invoke(methodWrapper);
  velocityContext.put("taglibLiferay",velocityTaglib);
  velocityContext.put("theme",velocityTaglib);
  try {
    VelocityEngineUtil.mergeTemplate(velocityTemplateId,velocityTemplateContent,velocityContext,unsyncStringWriter);
  }
 catch (  Exception e) {
    _log.error(e,e);
    throw e;
  }
  String output=unsyncStringWriter.toString();
  Map<Portlet,Object[]> portletsMap=processor.getPortletsMap();
  Map<String,String> contentsMap=new HashMap<String,String>(portletsMap.size());
  for (  Map.Entry<Portlet,Object[]> entry : portletsMap.entrySet()) {
    Portlet portlet=entry.getKey();
    Object[] value=entry.getValue();
    String queryString=(String)value[0];
    String columnId=(String)value[1];
    Integer columnPos=(Integer)value[2];
    Integer columnCount=(Integer)value[3];
    String content=processPortlet(servletContext,request,response,portlet,queryString,columnId,columnPos,columnCount,null);
    contentsMap.put(portlet.getPortletId(),content);
  }
  StringBundler sb=StringUtil.replaceToStringBundler(output,"[$TEMPLATE_PORTLET_","$]",contentsMap);
  sb.writeTo(new UnbufferedJspWriter(jspWriter));
}
