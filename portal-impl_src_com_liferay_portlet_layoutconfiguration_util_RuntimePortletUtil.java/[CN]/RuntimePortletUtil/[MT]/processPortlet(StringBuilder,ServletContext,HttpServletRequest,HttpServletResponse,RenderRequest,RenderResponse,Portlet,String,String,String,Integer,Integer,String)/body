{
  ThemeDisplay themeDisplay=(ThemeDisplay)request.getAttribute(WebKeys.THEME_DISPLAY);
  if (portlet == null) {
    portlet=PortletLocalServiceUtil.getPortletById(themeDisplay.getCompanyId(),portletId);
  }
  if ((portlet != null) && (portlet.isInstanceable()) && (!portlet.isAddDefaultResource())) {
    String instanceId=portlet.getInstanceId();
    if (Validator.isNotNull(instanceId) && Validator.isPassword(instanceId) && (instanceId.length() == 4)) {
    }
 else {
      if (_log.isDebugEnabled()) {
        _log.debug("Portlet " + portlet.getPortletId() + " is instanceable but does not have a "+ "valid instance id");
      }
      portlet=null;
    }
  }
  if (portlet == null) {
    return;
  }
  PortletDisplay portletDisplay=themeDisplay.getPortletDisplay();
  PortletDisplay portletDisplayClone=PortletDisplayFactory.create();
  portletDisplay.copyTo(portletDisplayClone);
  PortletConfig portletConfig=(PortletConfig)request.getAttribute(JavaConstants.JAVAX_PORTLET_CONFIG);
  try {
    PortalUtil.renderPortlet(sb,servletContext,request,response,portlet,queryString,columnId,columnPos,columnCount,path);
  }
  finally {
    portletDisplay.copyFrom(portletDisplayClone);
    try {
      PortletDisplayFactory.recycle(portletDisplayClone);
    }
 catch (    Exception e) {
      _log.error(e);
    }
    _defineObjects(request,portletConfig,renderRequest,renderResponse);
  }
}
