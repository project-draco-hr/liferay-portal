{
  User user=UserUtil.findByPrimaryKey(userId);
  long groupId=PortalUtil.getPortletGroupId(plid);
  Date now=new Date();
  Locale locale=null;
  TimeZone timeZone=null;
  if (timeZoneSensitive) {
    locale=user.getLocale();
    timeZone=user.getTimeZone();
  }
 else {
    locale=Locale.getDefault();
    timeZone=TimeZone.getDefault();
  }
  Calendar startDate=new GregorianCalendar(timeZone,locale);
  startDate.set(Calendar.MONTH,startDateMonth);
  startDate.set(Calendar.DATE,startDateDay);
  startDate.set(Calendar.YEAR,startDateYear);
  startDate.set(Calendar.HOUR_OF_DAY,startDateHour);
  startDate.set(Calendar.MINUTE,startDateMinute);
  startDate.set(Calendar.SECOND,0);
  startDate.set(Calendar.MILLISECOND,0);
  Calendar endDate=new GregorianCalendar(timeZone,locale);
  endDate.set(Calendar.MONTH,endDateMonth);
  endDate.set(Calendar.DATE,endDateDay);
  endDate.set(Calendar.YEAR,endDateYear);
  endDate.set(Calendar.HOUR_OF_DAY,23);
  endDate.set(Calendar.MINUTE,59);
  endDate.set(Calendar.SECOND,59);
  endDate.set(Calendar.MILLISECOND,999);
  if (allDay) {
    startDate.set(Calendar.HOUR_OF_DAY,0);
    startDate.set(Calendar.MINUTE,0);
    durationHour=24;
    durationMinute=0;
  }
  validate(title,startDateMonth,startDateDay,startDateYear,endDateMonth,endDateDay,endDateYear,durationHour,durationMinute,allDay);
  long eventId=CounterLocalServiceUtil.increment(Counter.class.getName());
  CalEvent event=CalEventUtil.create(eventId);
  event.setGroupId(groupId);
  event.setCompanyId(user.getCompanyId());
  event.setUserId(user.getUserId());
  event.setUserName(user.getFullName());
  event.setCreateDate(now);
  event.setModifiedDate(now);
  event.setTitle(title);
  event.setDescription(description);
  event.setStartDate(startDate.getTime());
  event.setEndDate(endDate.getTime());
  event.setDurationHour(durationHour);
  event.setDurationMinute(durationMinute);
  event.setAllDay(allDay);
  event.setTimeZoneSensitive(timeZoneSensitive);
  event.setType(type);
  event.setRepeating(repeating);
  event.setRecurrence(Base64.objectToString(recurrence));
  event.setRemindBy(remindBy);
  event.setFirstReminder(firstReminder);
  event.setSecondReminder(secondReminder);
  CalEventUtil.update(event);
  if ((addCommunityPermissions != null) && (addGuestPermissions != null)) {
    addEventResources(event,addCommunityPermissions.booleanValue(),addGuestPermissions.booleanValue());
  }
 else {
    addEventResources(event,communityPermissions,guestPermissions);
  }
  CalEventLocalUtil.clearEventsPool(event.getGroupId());
  return event;
}
