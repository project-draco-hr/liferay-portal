{
  DDMStructure ddmStructure=getDDMStructure(ddmStructureId,ddmTemplateId);
  String defaultLanguageId=GetterUtil.getString(serviceContext.getAttribute("defaultLanguageId"));
  Locale defaultLocale=LocaleUtil.fromLanguageId(defaultLanguageId);
  Set<String> fieldNames=ddmStructure.getFieldNames();
  String fieldsTreeAttribute=GetterUtil.getString(serviceContext.getAttribute("_fieldsTree"));
  String[] fieldsTree=StringUtil.split(fieldsTreeAttribute);
  Map<String,List<String>> fieldsParameterNamesMap=getFieldsParameterNamesMap(fieldNames,fieldNamespace,fieldsTree);
  String languageId=GetterUtil.getString(serviceContext.getAttribute("languageId"),serviceContext.getLanguageId());
  Locale locale=LocaleUtil.fromLanguageId(languageId);
  Fields fields=new Fields();
  for (  String fieldName : fieldNames) {
    List<Serializable> fieldValues=getFieldValues(ddmStructure,fieldName,fieldNamespace,fieldsParameterNamesMap,serviceContext);
    if ((fieldValues == null) || fieldValues.isEmpty()) {
      continue;
    }
    Field field=new Field(ddmStructureId,fieldName,fieldValues,locale);
    field.setDefaultLocale(defaultLocale);
    fields.put(field);
  }
  if (Validator.isNotNull(fieldsTree)) {
    List<Serializable> fieldsTreeValues=getFieldsTreeValues(fieldsTree,fieldNamespace);
    Field fieldsTreeField=new Field(ddmStructureId,"_fieldsTree",fieldsTreeValues,locale);
    fieldsTreeField.setDefaultLocale(defaultLocale);
    fields.put(fieldsTreeField);
  }
  return fields;
}
