{
  Registry registry=RegistryUtil.getRegistry();
  final ServiceDependencyManager serviceDependencyManager=new ServiceDependencyManager();
  final AtomicBoolean dependenciesSatisfied=new AtomicBoolean(false);
  serviceDependencyManager.addServiceDependencyListener(new ServiceDependencyListener(){
    @Override public void dependenciesFulfilled(){
      dependenciesSatisfied.set(true);
    }
    @Override public void destroy(){
    }
  }
);
  Filter filter1=registry.getFilter("(objectClass=" + TrackedOne.class.getName() + ")");
  Filter filter2=registry.getFilter("(objectClass=" + TrackedTwo.class.getName() + ")");
  serviceDependencyManager.registerDependencies(filter1,filter2);
  Thread dependencyWaiter1=new Thread(new Runnable(){
    @Override public void run(){
      serviceDependencyManager.waitForDependencies(0);
    }
  }
);
  dependencyWaiter1.setDaemon(true);
  dependencyWaiter1.start();
  Thread dependencyWaiter2=new Thread(new Runnable(){
    @Override public void run(){
      serviceDependencyManager.waitForDependencies(0);
    }
  }
);
  dependencyWaiter2.setDaemon(true);
  dependencyWaiter2.start();
  try {
    Thread.sleep(250);
    registry.registerService(TrackedOne.class,new TrackedOne());
    registry.registerService(TrackedTwo.class,new TrackedTwo(new TrackedOne()));
    Thread.sleep(250);
    if (dependencyWaiter1.isAlive()) {
      Assert.fail("Dependencies 1 should have been fulfilled");
    }
    if (dependencyWaiter2.isAlive()) {
      Assert.fail("Dependencies 2 should have been fulfilled");
    }
    Assert.assertTrue(dependenciesSatisfied.get());
  }
 catch (  InterruptedException ie) {
  }
}
