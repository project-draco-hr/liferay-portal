{
  Userinfoplus userinfoplus=getUserinfoplus(credential);
  if (userinfoplus == null) {
    return null;
  }
  User user=null;
  String googleUserId=userinfoplus.getId();
  if (Validator.isNotNull(googleUserId)) {
    user=_userLocalService.fetchUserByGoogleUserId(companyId,googleUserId);
    if ((user != null) && (user.getStatus() != WorkflowConstants.STATUS_INCOMPLETE)) {
      session.setAttribute(GoogleWebKeys.GOOGLE_USER_ID,String.valueOf(googleUserId));
    }
  }
  String emailAddress=userinfoplus.getEmail();
  if ((user == null) && Validator.isNotNull(emailAddress)) {
    user=_userLocalService.fetchUserByEmailAddress(companyId,emailAddress);
    if ((user != null) && (user.getStatus() != WorkflowConstants.STATUS_INCOMPLETE)) {
      session.setAttribute(GoogleWebKeys.GOOGLE_USER_EMAIL_ADDRESS,emailAddress);
    }
  }
  if (user != null) {
    if (user.getStatus() == WorkflowConstants.STATUS_INCOMPLETE) {
      session.setAttribute(WebKeys.GOOGLE_INCOMPLETE_USER_ID,userinfoplus.getId());
      user.setEmailAddress(userinfoplus.getEmail());
      user.setFirstName(userinfoplus.getGivenName());
      user.setLastName(userinfoplus.getFamilyName());
      return user;
    }
    user=updateUser(user,userinfoplus);
  }
 else {
    user=addUser(session,companyId,userinfoplus);
  }
  return user;
}
