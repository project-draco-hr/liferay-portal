{
  String viewMode=ParamUtil.getString(renderRequest,"viewMode");
  String languageId=LanguageUtil.getLanguageId(renderRequest);
  String xmlRequest=PortletRequestUtil.toXML(renderRequest,renderResponse);
  if (Validator.isNull(xmlRequest)) {
    xmlRequest="<request />";
  }
  Map<String,String> tokens=JournalUtil.getTokens(recordSet.getGroupId(),themeDisplay,xmlRequest);
  tokens.put("template_id",StringUtil.valueOf(ddmTemplateId));
  String xml=StringPool.BLANK;
  Document document=SAXReaderUtil.createDocument();
  Element rootElement=document.addElement("root");
  Document requestDocument=SAXReaderUtil.read(xmlRequest);
  rootElement.add(requestDocument.getRootElement().createCopy());
  addAllReservedEls(rootElement,tokens,recordSet);
  xml=DDMXMLUtil.formatXML(document);
  DDMTemplate template=DDMTemplateLocalServiceUtil.getTemplate(ddmTemplateId);
  return _transformer.transform(themeDisplay,tokens,viewMode,languageId,xml,template.getScript(),template.getLanguage());
}
