{
  Map<String,Object> contextObjects=new HashMap<>();
  contextObjects.put(DDLConstants.RESERVED_DDM_STRUCTURE_ID,recordSet.getDDMStructureId());
  contextObjects.put(DDLConstants.RESERVED_DDM_TEMPLATE_ID,ddmTemplateId);
  contextObjects.put(DDLConstants.RESERVED_RECORD_SET_DESCRIPTION,recordSet.getDescription(themeDisplay.getLocale()));
  contextObjects.put(DDLConstants.RESERVED_RECORD_SET_ID,recordSet.getRecordSetId());
  contextObjects.put(DDLConstants.RESERVED_RECORD_SET_NAME,recordSet.getName(themeDisplay.getLocale()));
  contextObjects.put(TemplateConstants.TEMPLATE_ID,ddmTemplateId);
  String viewMode=Constants.VIEW;
  if (renderRequest != null) {
    viewMode=ParamUtil.getString(renderRequest,"viewMode",Constants.VIEW);
  }
  contextObjects.put("viewMode",viewMode);
  DDMTemplate ddmTemplate=DDMTemplateLocalServiceUtil.getTemplate(ddmTemplateId);
  contextObjects.put(TemplateConstants.CLASS_NAME_ID,ddmTemplate.getClassNameId());
  TemplateManager templateManager=TemplateManagerUtil.getTemplateManager(ddmTemplate.getLanguage());
  TemplateHandler templateHandler=TemplateHandlerRegistryUtil.getTemplateHandler(DDLRecordSet.class.getName());
  templateManager.addContextObjects(contextObjects,templateHandler.getCustomContextObjects());
  Transformer transformer=TransformerHolder.getTransformer();
  return transformer.transform(themeDisplay,contextObjects,ddmTemplate.getScript(),ddmTemplate.getLanguage(),new UnsyncStringWriter());
}
