{
  ThemeDisplay themeDisplay=(ThemeDisplay)actionRequest.getAttribute(WebKeys.THEME_DISPLAY);
  boolean majorVersion=ParamUtil.getBoolean(actionRequest,"majorVersion");
  DDLRecord record=DDLRecordLocalServiceUtil.fetchRecord(recordId);
  DDLRecordSet recordSet=DDLRecordSetLocalServiceUtil.getDDLRecordSet(recordSetId);
  DDMStructure ddmStructure=recordSet.getDDMStructure();
  Fields fields=getFields(actionRequest,ddmStructure.getStructureId());
  ServiceContext serviceContext=ServiceContextFactory.getInstance(DDLRecord.class.getName(),actionRequest);
  if (record != null) {
    record=DDLRecordServiceUtil.updateRecord(recordId,majorVersion,DDLRecordConstants.DISPLAY_INDEX_DEFAULT,fields,mergeFields,serviceContext);
  }
 else {
    record=DDLRecordServiceUtil.addRecord(themeDisplay.getScopeGroupId(),recordSetId,DDLRecordConstants.DISPLAY_INDEX_DEFAULT,fields,serviceContext);
  }
  UploadPortletRequest uploadPortletRequest=PortalUtil.getUploadPortletRequest(actionRequest);
  uploadRecordFieldFiles(record,uploadPortletRequest,serviceContext);
  return record;
}
