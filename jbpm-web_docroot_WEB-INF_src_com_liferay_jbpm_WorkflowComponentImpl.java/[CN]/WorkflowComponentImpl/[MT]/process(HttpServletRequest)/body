{
  String result=null;
  try {
    userId=ParamUtil.getString(req,"userId");
    timeZoneId=ParamUtil.getString(req,"timeZoneId");
    timeZone=TimeZone.getTimeZone(timeZoneId);
    jbpmContext=JbpmConfiguration.getInstance().createJbpmContext();
    graphSession=new GraphSession(userId,timeZoneId,jbpmContext);
    taskMgmtSession=jbpmContext.getTaskMgmtSession();
    String cmd=ParamUtil.getString(req,"cmd");
    if (cmd.equals("deploy")) {
      String xml=ParamUtil.getString(req,"xml");
      result=deploy(xml);
    }
 else     if (cmd.equals("getDefinitionsCountXml")) {
      long definitionId=ParamUtil.getLong(req,"definitionId");
      String name=ParamUtil.getString(req,"name");
      result=getDefinitionsCountXml(definitionId,name);
    }
 else     if (cmd.equals("getDefinitionsXml")) {
      long definitionId=ParamUtil.getLong(req,"definitionId");
      String name=ParamUtil.getString(req,"name");
      int begin=ParamUtil.getInteger(req,"begin");
      int end=ParamUtil.getInteger(req,"end");
      result=getDefinitionsXml(definitionId,name,begin,end);
    }
 else     if (cmd.equals("getInstancesCountXml")) {
      long definitionId=ParamUtil.getLong(req,"definitionId");
      long instanceId=ParamUtil.getLong(req,"instanceId");
      String workflowName=ParamUtil.getString(req,"workflowName");
      String workflowVersion=ParamUtil.getString(req,"workflowVersion");
      String gtStartDate=ParamUtil.getString(req,"gtStartDate");
      String ltStartDate=ParamUtil.getString(req,"ltStartDate");
      String gtEndDate=ParamUtil.getString(req,"gtEndDate");
      String ltEndDate=ParamUtil.getString(req,"ltEndDate");
      boolean hideEndedTasks=ParamUtil.getBoolean(req,"hideEndedTasks");
      boolean andOperator=ParamUtil.getBoolean(req,"andOperator");
      result=getInstancesCountXml(definitionId,instanceId,workflowName,workflowVersion,gtStartDate,ltStartDate,gtEndDate,ltEndDate,hideEndedTasks,andOperator);
    }
 else     if (cmd.equals("getInstancesXml")) {
      long definitionId=ParamUtil.getLong(req,"definitionId");
      long instanceId=ParamUtil.getLong(req,"instanceId");
      String workflowName=ParamUtil.getString(req,"workflowName");
      String workflowVersion=ParamUtil.getString(req,"workflowVersion");
      String gtStartDate=ParamUtil.getString(req,"gtStartDate");
      String ltStartDate=ParamUtil.getString(req,"ltStartDate");
      String gtEndDate=ParamUtil.getString(req,"gtEndDate");
      String ltEndDate=ParamUtil.getString(req,"ltEndDate");
      boolean hideEndedTasks=ParamUtil.getBoolean(req,"hideEndedTasks");
      boolean andOperator=ParamUtil.getBoolean(req,"andOperator");
      int begin=ParamUtil.getInteger(req,"begin");
      int end=ParamUtil.getInteger(req,"end");
      result=getInstancesXml(definitionId,instanceId,workflowName,workflowVersion,gtStartDate,ltStartDate,gtEndDate,ltEndDate,hideEndedTasks,andOperator,begin,end);
    }
 else     if (cmd.equals("getTaskFormElementsXml")) {
      long taskId=ParamUtil.getLong(req,"taskId");
      result=getTaskFormElementsXml(taskId);
    }
 else     if (cmd.equals("getTaskTransitionsXml")) {
      long taskId=ParamUtil.getLong(req,"taskId");
      result=getTaskTransitionsXml(taskId);
    }
 else     if (cmd.equals("getUserTasksCountXml")) {
      long instanceId=ParamUtil.getLong(req,"instanceId");
      String taskName=ParamUtil.getString(req,"taskName");
      String workflowName=ParamUtil.getString(req,"workflowName");
      String assignedTo=ParamUtil.getString(req,"assignedTo");
      String gtCreateDate=ParamUtil.getString(req,"gtCreateDate");
      String ltCreateDate=ParamUtil.getString(req,"ltCreateDate");
      String gtStartDate=ParamUtil.getString(req,"gtStartDate");
      String ltStartDate=ParamUtil.getString(req,"ltStartDate");
      String gtEndDate=ParamUtil.getString(req,"gtEndDate");
      String ltEndDate=ParamUtil.getString(req,"ltEndDate");
      boolean hideEndedTasks=ParamUtil.getBoolean(req,"hideEndedTasks");
      boolean andOperator=ParamUtil.getBoolean(req,"andOperator");
      result=getUserTasksCountXml(instanceId,taskName,workflowName,assignedTo,gtCreateDate,ltCreateDate,gtStartDate,ltStartDate,gtEndDate,ltEndDate,hideEndedTasks,andOperator);
    }
 else     if (cmd.equals("getUserTasksXml")) {
      long instanceId=ParamUtil.getLong(req,"instanceId");
      String taskName=ParamUtil.getString(req,"taskName");
      String workflowName=ParamUtil.getString(req,"workflowName");
      String assignedTo=ParamUtil.getString(req,"assignedTo");
      String gtCreateDate=ParamUtil.getString(req,"gtCreateDate");
      String ltCreateDate=ParamUtil.getString(req,"ltCreateDate");
      String gtStartDate=ParamUtil.getString(req,"gtStartDate");
      String ltStartDate=ParamUtil.getString(req,"ltStartDate");
      String gtEndDate=ParamUtil.getString(req,"gtEndDate");
      String ltEndDate=ParamUtil.getString(req,"ltEndDate");
      boolean hideEndedTasks=ParamUtil.getBoolean(req,"hideEndedTasks");
      boolean andOperator=ParamUtil.getBoolean(req,"andOperator");
      int begin=ParamUtil.getInteger(req,"begin");
      int end=ParamUtil.getInteger(req,"end");
      result=getUserTasksXml(instanceId,taskName,workflowName,assignedTo,gtCreateDate,ltCreateDate,gtStartDate,ltStartDate,gtEndDate,ltEndDate,hideEndedTasks,andOperator,begin,end);
    }
 else     if (cmd.equals("signalInstance")) {
      long instanceId=ParamUtil.getLong(req,"instanceId");
      signalInstance(instanceId);
    }
 else     if (cmd.equals("signalToken")) {
      long instanceId=ParamUtil.getLong(req,"instanceId");
      long tokenId=ParamUtil.getLong(req,"tokenId");
      signalToken(instanceId,tokenId);
    }
 else     if (cmd.equals("startWorkflow")) {
      long definitionId=ParamUtil.getLong(req,"definitionId");
      result=startWorkflow(definitionId);
    }
 else     if (cmd.equals("updateTaskXml")) {
      long taskId=ParamUtil.getLong(req,"taskId");
      String transition=ParamUtil.getString(req,"transition");
      result=updateTaskXml(taskId,transition,req.getParameterMap());
    }
  }
 catch (  Exception e) {
    _log.error(StackTraceUtil.getStackTrace(e));
  }
 finally {
    try {
      jbpmContext.close();
    }
 catch (    Exception e) {
    }
    try {
      graphSession.close();
    }
 catch (    Exception e) {
    }
  }
  if (Validator.isNull(result)) {
    result="<result />";
  }
  return result;
}
