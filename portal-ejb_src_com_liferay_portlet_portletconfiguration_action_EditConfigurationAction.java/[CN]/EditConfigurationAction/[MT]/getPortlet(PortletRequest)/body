{
  String companyId=PortalUtil.getCompanyId(req);
  ThemeDisplay themeDisplay=(ThemeDisplay)req.getAttribute(WebKeys.THEME_DISPLAY);
  PermissionChecker permissionChecker=themeDisplay.getPermissionChecker();
  String portletId=ParamUtil.getString(req,"portletResource");
  String rootPortletId=Portlet.getRootPortletId(portletId);
  if (!GroupPermission.contains(permissionChecker,themeDisplay.getPortletGroupId(),ActionKeys.MANAGE_LAYOUTS) && !LayoutPermission.contains(permissionChecker,themeDisplay.getLayout(),ActionKeys.UPDATE) && !PortletPermission.contains(permissionChecker,themeDisplay.getPlid(),rootPortletId,ActionKeys.CONFIGURATION)) {
    throw new PrincipalException();
  }
  return PortletLocalServiceUtil.getPortletById(companyId,portletId);
}
