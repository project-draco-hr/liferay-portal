{
  ServiceContext serviceContext=ServiceContextTestUtil.getServiceContext(groupId,userId);
  if (fileEntryTypeId != DLFileEntryTypeConstants.FILE_ENTRY_TYPE_ID_ALL) {
    serviceContext.setAttribute("fileEntryTypeId",fileEntryTypeId);
  }
  serviceContext.setCommand(Constants.ADD);
  serviceContext.setLayoutFullURL("http://localhost");
  if (workflowEnabled && !approved) {
    serviceContext.setWorkflowAction(WorkflowConstants.ACTION_SAVE_DRAFT);
  }
 else {
    serviceContext.setWorkflowAction(WorkflowConstants.ACTION_PUBLISH);
  }
  String name=PrincipalThreadLocal.getName();
  FileEntry fileEntry=null;
  try {
    PrincipalThreadLocal.setName(userId);
    fileEntry=addFileEntry(repositoryId,folderId,sourceFileName,ContentTypes.TEXT_PLAIN,sourceFileName,null,serviceContext.getWorkflowAction(),serviceContext);
    if (workflowEnabled && approved) {
      updateStatus(userId,fileEntry,serviceContext);
    }
  }
  finally {
    PrincipalThreadLocal.setName(name);
  }
  return fileEntry;
}
