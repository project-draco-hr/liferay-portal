{
  if (_smtpServer != null) {
    throw new IllegalStateException("Server is already running");
  }
  try {
    int smtpPort=getFreePort();
    _prefsPropsReplacement=new PrefsPropsTemporarySwapper(PropsKeys.MAIL_SESSION_MAIL_SMTP_PORT,smtpPort,PropsKeys.MAIL_SESSION_MAIL,true);
    _smtpServer=new SmtpServer();
    _smtpServer.setMailStore(new RollingMailStore(){
      @Override public void addMessage(      MailMessage message){
        try {
          List<MailMessage> receivedMail=ReflectionTestUtil.getFieldValue(this,"receivedMail");
          receivedMail.add(message);
          if (getEmailCount() > 100) {
            receivedMail.remove(0);
          }
        }
 catch (        Exception e) {
          throw new RuntimeException(e);
        }
      }
    }
);
    _smtpServer.setPort(smtpPort);
    _smtpServer.setThreaded(false);
    ReflectionTestUtil.invoke(SmtpServerFactory.class,"startServerThread",new Class<?>[]{SmtpServer.class},_smtpServer);
    MailServiceUtil.clearSession();
  }
 catch (  Exception e) {
    throw new RuntimeException(e);
  }
}
