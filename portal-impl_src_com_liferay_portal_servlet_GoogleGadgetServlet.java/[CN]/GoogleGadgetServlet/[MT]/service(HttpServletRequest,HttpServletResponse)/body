{
  try {
    String redirect=getRedirect(request);
    if (redirect == null) {
      PortalUtil.sendError(HttpServletResponse.SC_NOT_FOUND,new NoSuchLayoutException(),request,response);
    }
 else {
      request.setAttribute(WebKeys.GOOGLE_GADGET,Boolean.TRUE);
      String path=GetterUtil.getString(request.getPathInfo());
      String portletId=path.substring(path.indexOf(_SEPARATOR) + _SEPARATOR.length());
      Portlet portlet=PortletLocalServiceUtil.getPortletById(PortalUtil.getCompanyId(request),portletId);
      String gagdetTitle=portlet.getDisplayName();
      String widgetJsURL=PortalUtil.getPortalURL(request) + PortalUtil.getPathContext() + "/html/js/liferay/widget.js";
      String widgetURL=request.getRequestURL().toString().replaceFirst(PropsValues.GOOGLE_GADGET_SERVLET_MAPPING,PropsValues.WIDGET_SERVLET_MAPPING);
      response.setContentType(ContentTypes.TEXT_XML);
      StringBuilder sb=new StringBuilder();
      sb.append("<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n");
      sb.append("<Module>\n");
      sb.append("\t<ModulePrefs title=\"" + gagdetTitle + "\"/>\n");
      sb.append("\t<Content type=\"html\">\n");
      sb.append("\t<![CDATA[\n");
      sb.append("\t\t<script src=\"" + widgetJsURL + "\"");
      sb.append("\t\t\ttype=\"text/javascript\"></script>\n");
      sb.append("\t\t<script type=\"text/javascript\">\n");
      sb.append("\t\t\twindow.Liferay.Widget({url:'" + widgetURL + "'});\n");
      sb.append("\t\t</script>\n");
      sb.append("\t]]>\n");
      sb.append("\t</Content>\n");
      sb.append("</Module>\n");
      response.getOutputStream().print(sb.toString());
    }
  }
 catch (  Exception e) {
    _log.error(e,e);
    PortalUtil.sendError(HttpServletResponse.SC_INTERNAL_SERVER_ERROR,e,request,response);
  }
}
