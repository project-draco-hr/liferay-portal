{
  Map<Long,Layout> layouts=(Map<Long,Layout>)portletDataContext.getNewPrimaryKeysMap(Layout.class + ".layout");
  Map<Long,NavigableSet<Layout>> navigableSets=new HashMap<Long,NavigableSet<Layout>>();
  List<Layout> importedLayouts=new LinkedList<Layout>();
  for (  Element layoutElement : _layoutElements) {
    String action=layoutElement.attributeValue(Constants.ACTION);
    if (action.equals(Constants.ADD)) {
      long layoutId=GetterUtil.getLong(layoutElement.attributeValue("layout-id"));
      Layout layout=layouts.get(layoutId);
      NavigableSet<Layout> navigableSet=navigableSets.get(layout.getParentLayoutId());
      if (navigableSet == null) {
        navigableSets.put(layout.getParentLayoutId(),new TreeSet<Layout>(new LayoutPriorityComparator()));
      }
      importedLayouts.add(LayoutLocalServiceUtil.getLayout(layout.getPlid()));
    }
  }
  List<Layout> unmodifiedLayouts=new LinkedList<Layout>(LayoutLocalServiceUtil.getLayouts(portletDataContext.getGroupId(),portletDataContext.isPrivateLayout()));
  unmodifiedLayouts.removeAll(importedLayouts);
  if (unmodifiedLayouts.isEmpty()) {
    return;
  }
  for (  Layout unmodifiedLayout : unmodifiedLayouts) {
    NavigableSet<Layout> navigableSet=navigableSets.get(unmodifiedLayout.getParentLayoutId());
    if (navigableSet != null) {
      navigableSet.add(unmodifiedLayout);
    }
  }
  for (  Layout importedLayout : importedLayouts) {
    NavigableSet<Layout> navigableSet=navigableSets.get(importedLayout.getParentLayoutId());
    if (navigableSet.isEmpty()) {
      continue;
    }
    Set<Layout> tailLayouts=navigableSet.tailSet(importedLayout,true);
    int priority=importedLayout.getPriority();
    for (    Layout tailLayout : tailLayouts) {
      if (tailLayout.getPriority() == priority) {
        tailLayout.setPriority(++priority);
      }
 else {
        break;
      }
    }
    navigableSet.add(importedLayout);
  }
  for (  NavigableSet<Layout> navigableSet : navigableSets.values()) {
    for (    Layout layout : navigableSet) {
      LayoutUtil.update(layout);
    }
  }
}
