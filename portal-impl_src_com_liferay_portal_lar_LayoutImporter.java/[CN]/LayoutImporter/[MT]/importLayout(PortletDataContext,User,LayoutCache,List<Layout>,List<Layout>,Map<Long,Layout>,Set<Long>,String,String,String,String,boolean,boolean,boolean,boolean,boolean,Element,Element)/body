{
  long groupId=portletDataContext.getGroupId();
  String layoutUuid=GetterUtil.getString(layoutElement.attributeValue("layout-uuid"));
  long layoutId=GetterUtil.getInteger(layoutElement.attributeValue("layout-id"));
  long oldLayoutId=layoutId;
  boolean deleteLayout=GetterUtil.getBoolean(layoutElement.attributeValue("delete"));
  if (deleteLayout) {
    Layout layout=LayoutLocalServiceUtil.fetchLayoutByUuidAndGroupId(layoutUuid,groupId);
    if (layout != null) {
      newLayoutsMap.put(oldLayoutId,layout);
      LayoutLocalServiceUtil.deleteLayout(layout);
    }
    return;
  }
  String path=layoutElement.attributeValue("path");
  if (!portletDataContext.isPathNotProcessed(path)) {
    return;
  }
  Layout layout=(Layout)portletDataContext.getZipEntryAsObject(path);
  Layout existingLayout=null;
  Layout importedLayout=null;
  String friendlyURL=layout.getFriendlyURL();
  if (layoutsImportMode.equals(PortletDataHandlerKeys.LAYOUTS_IMPORT_MODE_ADD_AS_NEW)) {
    layoutId=LayoutLocalServiceUtil.getNextLayoutId(groupId,privateLayout);
    friendlyURL=StringPool.SLASH + layoutId;
  }
 else   if (layoutsImportMode.equals(PortletDataHandlerKeys.LAYOUTS_IMPORT_MODE_MERGE_BY_LAYOUT_NAME)) {
    Locale locale=LocaleUtil.getDefault();
    String localizedName=layout.getName(locale);
    for (    Layout curLayout : previousLayouts) {
      if (localizedName.equals(curLayout.getName(locale)) || friendlyURL.equals(curLayout.getFriendlyURL())) {
        existingLayout=curLayout;
        break;
      }
    }
    if (existingLayout == null) {
      layoutId=LayoutLocalServiceUtil.getNextLayoutId(groupId,privateLayout);
    }
  }
 else   if (layoutsImportMode.equals(PortletDataHandlerKeys.LAYOUTS_IMPORT_MODE_CREATED_FROM_PROTOTYPE)) {
    existingLayout=LayoutUtil.fetchByG_P_TLU(groupId,privateLayout,layout.getUuid());
  }
 else {
    existingLayout=LayoutUtil.fetchByUUID_G(layout.getUuid(),groupId);
    if (existingLayout == null) {
      existingLayout=LayoutUtil.fetchByG_P_F(groupId,privateLayout,friendlyURL);
    }
    if (existingLayout == null) {
      layoutId=LayoutLocalServiceUtil.getNextLayoutId(groupId,privateLayout);
    }
  }
  if (_log.isDebugEnabled()) {
    if (existingLayout == null) {
      _log.debug("Layout with {groupId=" + groupId + ",privateLayout="+ privateLayout+ ",layoutId="+ layoutId+ "} does not exist");
    }
 else {
      _log.debug("Layout with {groupId=" + groupId + ",privateLayout="+ privateLayout+ ",layoutId="+ layoutId+ "} exists");
    }
  }
  if (existingLayout == null) {
    long plid=CounterLocalServiceUtil.increment();
    importedLayout=LayoutUtil.create(plid);
    if (layoutsImportMode.equals(PortletDataHandlerKeys.LAYOUTS_IMPORT_MODE_CREATED_FROM_PROTOTYPE)) {
      importedLayout.setTemplateLayoutUuid(layout.getUuid());
    }
 else {
      importedLayout.setUuid(layout.getUuid());
    }
    importedLayout.setGroupId(groupId);
    importedLayout.setPrivateLayout(privateLayout);
    importedLayout.setLayoutId(layoutId);
    if (layout.isIconImage()) {
      long iconImageId=CounterLocalServiceUtil.increment();
      importedLayout.setIconImageId(iconImageId);
    }
  }
 else {
    importedLayout=existingLayout;
  }
  newLayoutsMap.put(oldLayoutId,importedLayout);
  long parentLayoutId=layout.getParentLayoutId();
  Node parentLayoutNode=rootElement.selectSingleNode("./layouts/layout[@layout-id='" + parentLayoutId + "']");
  String parentLayoutUuid=GetterUtil.getString(layoutElement.attributeValue("parent-layout-uuid"));
  if ((parentLayoutId != LayoutConstants.DEFAULT_PARENT_LAYOUT_ID) && (parentLayoutNode != null)) {
    importLayout(portletDataContext,user,layoutCache,previousLayouts,newLayouts,newLayoutsMap,newLayoutIds,portletsMergeMode,themeId,colorSchemeId,layoutsImportMode,privateLayout,importPermissions,importPublicLayoutPermissions,importUserPermissions,importThemeSettings,rootElement,(Element)parentLayoutNode);
    Layout parentLayout=newLayoutsMap.get(parentLayoutId);
    parentLayoutId=parentLayout.getLayoutId();
  }
 else   if (Validator.isNotNull(parentLayoutUuid)) {
    Layout parentLayout=LayoutLocalServiceUtil.getLayoutByUuidAndGroupId(parentLayoutUuid,groupId);
    parentLayoutId=parentLayout.getLayoutId();
  }
  if (_log.isDebugEnabled()) {
    _log.debug("Importing layout with layout id " + layoutId + " and parent layout id "+ parentLayoutId);
  }
  importedLayout.setCompanyId(user.getCompanyId());
  importedLayout.setParentLayoutId(parentLayoutId);
  importedLayout.setName(layout.getName());
  importedLayout.setTitle(layout.getTitle());
  importedLayout.setDescription(layout.getDescription());
  importedLayout.setKeywords(layout.getKeywords());
  importedLayout.setRobots(layout.getRobots());
  importedLayout.setType(layout.getType());
  if (layout.isTypeArticle()) {
    importJournalArticle(portletDataContext,layout,layoutElement);
    importedLayout.setTypeSettings(layout.getTypeSettings());
  }
 else   if (layout.isTypePortlet() && Validator.isNotNull(layout.getTypeSettings()) && !portletsMergeMode.equals(PortletDataHandlerKeys.PORTLETS_MERGE_MODE_REPLACE)) {
    mergePortlets(importedLayout,layout.getTypeSettings(),portletsMergeMode);
  }
 else   if (layout.isTypeLinkToLayout()) {
    UnicodeProperties typeSettingsProperties=layout.getTypeSettingsProperties();
    long linkToLayoutId=GetterUtil.getLong(typeSettingsProperties.getProperty("linkToLayoutId",StringPool.BLANK));
    if (linkToLayoutId > 0) {
      Node linkedLayoutNode=rootElement.selectSingleNode("./layouts/layout[@layout-id='" + linkToLayoutId + "']");
      if (linkedLayoutNode != null) {
        importLayout(portletDataContext,user,layoutCache,previousLayouts,newLayouts,newLayoutsMap,newLayoutIds,portletsMergeMode,themeId,colorSchemeId,layoutsImportMode,privateLayout,importPermissions,importPublicLayoutPermissions,importUserPermissions,importThemeSettings,rootElement,(Element)linkedLayoutNode);
        Layout linkedLayout=newLayoutsMap.get(linkToLayoutId);
        typeSettingsProperties.setProperty("privateLayout",String.valueOf(linkedLayout.getPrivateLayout()));
        typeSettingsProperties.setProperty("linkToLayoutId",String.valueOf(linkedLayout.getLayoutId()));
      }
 else {
        if (_log.isWarnEnabled()) {
          StringBundler sb=new StringBundler();
          sb.append("Unable to link layout with friendly URL ");
          sb.append(layout.getFriendlyURL());
          sb.append(" and layout id ");
          sb.append(layout.getLayoutId());
          sb.append(" to layout with layout id ");
          sb.append(linkToLayoutId);
          _log.warn(sb.toString());
        }
      }
    }
    importedLayout.setTypeSettings(layout.getTypeSettings());
  }
 else {
    importedLayout.setTypeSettings(layout.getTypeSettings());
  }
  importedLayout.setHidden(layout.isHidden());
  importedLayout.setFriendlyURL(friendlyURL);
  if (importThemeSettings) {
    importedLayout.setThemeId(layout.getThemeId());
    importedLayout.setColorSchemeId(layout.getColorSchemeId());
  }
 else {
    importedLayout.setThemeId(StringPool.BLANK);
    importedLayout.setColorSchemeId(StringPool.BLANK);
  }
  importedLayout.setWapThemeId(layout.getWapThemeId());
  importedLayout.setWapColorSchemeId(layout.getWapColorSchemeId());
  importedLayout.setCss(layout.getCss());
  importedLayout.setPriority(layout.getPriority());
  StagingUtil.updateLastImportSettings(layoutElement,importedLayout,portletDataContext);
  fixTypeSettings(importedLayout);
  if (layout.isIconImage()) {
    String iconImagePath=layoutElement.elementText("icon-image-path");
    byte[] iconBytes=portletDataContext.getZipEntryAsByteArray(iconImagePath);
    if ((iconBytes != null) && (iconBytes.length > 0)) {
      importedLayout.setIconImage(true);
      ImageLocalServiceUtil.updateImage(importedLayout.getIconImageId(),iconBytes);
    }
  }
 else {
    ImageLocalServiceUtil.deleteImage(importedLayout.getIconImageId());
  }
  ServiceContext serviceContext=portletDataContext.createServiceContext(layoutElement,importedLayout,null);
  importedLayout.setExpandoBridgeAttributes(serviceContext);
  LayoutUtil.update(importedLayout,false);
  portletDataContext.setPlid(importedLayout.getPlid());
  portletDataContext.setOldPlid(layout.getPlid());
  newLayoutIds.add(importedLayout.getLayoutId());
  newLayouts.add(importedLayout);
  if (importPermissions) {
    _permissionImporter.importLayoutPermissions(layoutCache,portletDataContext.getCompanyId(),groupId,user.getUserId(),importedLayout,layoutElement,rootElement,importUserPermissions);
  }
  if (importPublicLayoutPermissions) {
    String resourceName=Layout.class.getName();
    String resourcePrimKey=String.valueOf(importedLayout.getPlid());
    Role guestRole=RoleLocalServiceUtil.getRole(importedLayout.getCompanyId(),RoleConstants.GUEST);
    if (PropsValues.PERMISSIONS_USER_CHECK_ALGORITHM == 5) {
      Resource resource=layoutCache.getResource(importedLayout.getCompanyId(),groupId,resourceName,ResourceConstants.SCOPE_INDIVIDUAL,resourcePrimKey,false);
      PermissionLocalServiceUtil.setRolePermissions(guestRole.getRoleId(),new String[]{ActionKeys.VIEW},resource.getResourceId());
    }
 else     if (PropsValues.PERMISSIONS_USER_CHECK_ALGORITHM == 6) {
      ResourcePermissionLocalServiceUtil.setResourcePermissions(importedLayout.getCompanyId(),resourceName,ResourceConstants.SCOPE_INDIVIDUAL,resourcePrimKey,guestRole.getRoleId(),new String[]{ActionKeys.VIEW});
    }
 else {
      Resource resource=layoutCache.getResource(importedLayout.getCompanyId(),groupId,resourceName,ResourceConstants.SCOPE_INDIVIDUAL,resourcePrimKey,false);
      PermissionLocalServiceUtil.setGroupPermissions(groupId,new String[]{ActionKeys.VIEW},resource.getResourceId());
    }
  }
  _portletImporter.importPortletData(portletDataContext,PortletKeys.LAYOUT_CONFIGURATION,null,layoutElement);
}
