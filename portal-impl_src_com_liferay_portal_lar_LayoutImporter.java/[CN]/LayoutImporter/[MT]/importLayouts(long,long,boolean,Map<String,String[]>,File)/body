{
  boolean deleteMissingLayouts=MapUtil.getBoolean(parameterMap,PortletDataHandlerKeys.DELETE_MISSING_LAYOUTS,Boolean.TRUE.booleanValue());
  boolean deletePortletData=MapUtil.getBoolean(parameterMap,PortletDataHandlerKeys.DELETE_PORTLET_DATA);
  boolean importCategories=MapUtil.getBoolean(parameterMap,PortletDataHandlerKeys.CATEGORIES);
  boolean importPermissions=MapUtil.getBoolean(parameterMap,PortletDataHandlerKeys.PERMISSIONS);
  boolean importUserPermissions=MapUtil.getBoolean(parameterMap,PortletDataHandlerKeys.PERMISSIONS);
  boolean importPortletData=MapUtil.getBoolean(parameterMap,PortletDataHandlerKeys.PORTLET_DATA);
  boolean importPortletSetup=MapUtil.getBoolean(parameterMap,PortletDataHandlerKeys.PORTLET_SETUP);
  boolean importPortletArchivedSetups=MapUtil.getBoolean(parameterMap,PortletDataHandlerKeys.PORTLET_ARCHIVED_SETUPS);
  boolean importPortletUserPreferences=MapUtil.getBoolean(parameterMap,PortletDataHandlerKeys.PORTLET_USER_PREFERENCES);
  boolean importTheme=MapUtil.getBoolean(parameterMap,PortletDataHandlerKeys.THEME);
  String layoutsImportMode=MapUtil.getString(parameterMap,PortletDataHandlerKeys.LAYOUTS_IMPORT_MODE,PortletDataHandlerKeys.LAYOUTS_IMPORT_MODE_MERGE_BY_LAYOUT_ID);
  String portletsMergeMode=MapUtil.getString(parameterMap,PortletDataHandlerKeys.PORTLETS_MERGE_MODE,PortletDataHandlerKeys.PORTLETS_MERGE_MODE_REPLACE);
  String userIdStrategy=MapUtil.getString(parameterMap,PortletDataHandlerKeys.USER_ID_STRATEGY);
  if (_log.isDebugEnabled()) {
    _log.debug("Delete portlet data " + deletePortletData);
    _log.debug("Import categories " + importCategories);
    _log.debug("Import permissions " + importPermissions);
    _log.debug("Import user permissions " + importUserPermissions);
    _log.debug("Import portlet data " + importPortletData);
    _log.debug("Import portlet setup " + importPortletSetup);
    _log.debug("Import portlet archived setups " + importPortletArchivedSetups);
    _log.debug("Import portlet user preferences " + importPortletUserPreferences);
    _log.debug("Import theme " + importTheme);
  }
  StopWatch stopWatch=null;
  if (_log.isInfoEnabled()) {
    stopWatch=new StopWatch();
    stopWatch.start();
  }
  LayoutCache layoutCache=new LayoutCache();
  LayoutSet layoutSet=LayoutSetLocalServiceUtil.getLayoutSet(groupId,privateLayout);
  long companyId=layoutSet.getCompanyId();
  User user=UserUtil.findByPrimaryKey(userId);
  UserIdStrategy strategy=_portletImporter.getUserIdStrategy(user,userIdStrategy);
  ZipReader zipReader=ZipReaderFactoryUtil.getZipReader(file);
  PortletDataContext context=new PortletDataContextImpl(companyId,groupId,parameterMap,new HashSet<String>(),strategy,zipReader);
  context.setPortetDataContextListener(new PortletDataContextListenerImpl(context));
  context.setPrivateLayout(privateLayout);
  Element rootElement=null;
  InputStream themeZip=null;
  String xml=context.getZipEntryAsString("/manifest.xml");
  if (xml == null) {
    throw new LARFileException("manifest.xml not found in the LAR");
  }
  try {
    Document document=SAXReaderUtil.read(xml);
    rootElement=document.getRootElement();
  }
 catch (  Exception e) {
    throw new LARFileException(e);
  }
  Element headerElement=rootElement.element("header");
  int buildNumber=ReleaseInfo.getBuildNumber();
  int importBuildNumber=GetterUtil.getInteger(headerElement.attributeValue("build-number"));
  if (buildNumber != importBuildNumber) {
    throw new LayoutImportException("LAR build number " + importBuildNumber + " does not match "+ "portal build number "+ buildNumber);
  }
  String larType=headerElement.attributeValue("type");
  if (!larType.equals("layout-set")) {
    throw new LARTypeException("Invalid type of LAR file (" + larType + ")");
  }
  long sourceGroupId=GetterUtil.getLong(headerElement.attributeValue("group-id"));
  context.setSourceGroupId(sourceGroupId);
  if (importTheme) {
    themeZip=context.getZipEntryAsInputStream("theme.zip");
  }
  String themeId=headerElement.attributeValue("theme-id");
  String colorSchemeId=headerElement.attributeValue("color-scheme-id");
  String css=GetterUtil.getString(headerElement.elementText("css"));
  boolean useThemeZip=false;
  if (themeZip != null) {
    String importThemeId=importTheme(layoutSet,themeZip);
    if (importThemeId != null) {
      themeId=importThemeId;
      colorSchemeId=ColorSchemeImpl.getDefaultRegularColorSchemeId();
      useThemeZip=true;
    }
    if (_log.isDebugEnabled()) {
      _log.debug("Importing theme takes " + stopWatch.getTime() + " ms");
    }
  }
  boolean wapTheme=false;
  LayoutSetLocalServiceUtil.updateLookAndFeel(groupId,privateLayout,themeId,colorSchemeId,css,wapTheme);
  if (importPermissions) {
    _permissionImporter.readPortletDataPermissions(context);
  }
  if (importCategories) {
    _portletImporter.readCategories(context);
  }
  _portletImporter.readComments(context,rootElement);
  _portletImporter.readLocks(context,rootElement);
  _portletImporter.readRatings(context,rootElement);
  _portletImporter.readTags(context,rootElement);
  List<Layout> previousLayouts=LayoutUtil.findByG_P(groupId,privateLayout);
  List<Layout> newLayouts=new ArrayList<Layout>();
  Set<Long> newLayoutIds=new HashSet<Long>();
  Map<Long,Layout> newLayoutsMap=(Map<Long,Layout>)context.getNewPrimaryKeysMap(Layout.class);
  Element layoutsElement=rootElement.element("layouts");
  List<Element> layoutElements=layoutsElement.elements("layout");
  if (_log.isDebugEnabled()) {
    if (layoutElements.size() > 0) {
      _log.debug("Importing layouts");
    }
  }
  for (  Element layoutElement : layoutElements) {
    importLayout(context,user,layoutCache,previousLayouts,newLayouts,newLayoutsMap,newLayoutIds,portletsMergeMode,themeId,colorSchemeId,layoutsImportMode,privateLayout,importPermissions,importUserPermissions,useThemeZip,rootElement,layoutElement);
  }
  Element portletsElement=rootElement.element("portlets");
  List<Element> portletElements=portletsElement.elements("portlet");
  if (deletePortletData) {
    if (_log.isDebugEnabled()) {
      if (portletElements.size() > 0) {
        _log.debug("Deleting portlet data");
      }
    }
    for (    Element portletElement : portletElements) {
      String portletId=portletElement.attributeValue("portlet-id");
      long layoutId=GetterUtil.getLong(portletElement.attributeValue("layout-id"));
      long plid=newLayoutsMap.get(layoutId).getPlid();
      context.setPlid(plid);
      _portletImporter.deletePortletData(context,portletId,plid);
    }
  }
  if (_log.isDebugEnabled()) {
    if (portletElements.size() > 0) {
      _log.debug("Importing portlets");
    }
  }
  for (  Element portletElement : portletElements) {
    String portletPath=portletElement.attributeValue("path");
    String portletId=portletElement.attributeValue("portlet-id");
    long layoutId=GetterUtil.getLong(portletElement.attributeValue("layout-id"));
    long plid=newLayoutsMap.get(layoutId).getPlid();
    long oldPlid=GetterUtil.getLong(portletElement.attributeValue("old-plid"));
    Portlet portlet=PortletLocalServiceUtil.getPortletById(context.getCompanyId(),portletId);
    if (!portlet.isActive() || portlet.isUndeployedPortlet()) {
      continue;
    }
    Layout layout=null;
    try {
      layout=LayoutUtil.findByPrimaryKey(plid);
    }
 catch (    NoSuchLayoutException nsle) {
      continue;
    }
    context.setPlid(plid);
    context.setOldPlid(oldPlid);
    Document portletDocument=SAXReaderUtil.read(context.getZipEntryAsString(portletPath));
    portletElement=portletDocument.getRootElement();
    _portletImporter.importPortletPreferences(context,layoutSet.getCompanyId(),layout.getGroupId(),layout,null,portletElement,importPortletSetup,importPortletArchivedSetups,importPortletUserPreferences,false);
    String scopeLayoutUuid=GetterUtil.getString(portletElement.attributeValue("scope-layout-uuid"));
    context.setScopeLayoutUuid(scopeLayoutUuid);
    Element portletDataElement=portletElement.element("portlet-data");
    if (importPortletData && (portletDataElement != null)) {
      _portletImporter.importPortletData(context,portletId,plid,portletDataElement);
    }
    if (importPermissions) {
      _permissionImporter.importPortletPermissions(layoutCache,companyId,groupId,userId,layout,portletElement,portletId,importUserPermissions);
    }
    _portletImporter.importPortletPreferences(context,layoutSet.getCompanyId(),groupId,null,null,portletElement,importPortletSetup,importPortletArchivedSetups,importPortletUserPreferences,false);
  }
  if (deleteMissingLayouts) {
    deleteMissingLayouts(groupId,privateLayout,newLayoutIds,previousLayouts);
  }
  LayoutSetLocalServiceUtil.updatePageCount(groupId,privateLayout);
  if (_log.isInfoEnabled()) {
    _log.info("Importing layouts takes " + stopWatch.getTime() + " ms");
  }
  for (  Layout layout : newLayouts) {
    UnicodeProperties typeSettingsProperties=layout.getTypeSettingsProperties();
    String articleId=typeSettingsProperties.getProperty("article-id");
    if (Validator.isNotNull(articleId)) {
      Map<String,String> articleIds=(Map<String,String>)context.getNewPrimaryKeysMap(JournalArticle.class);
      typeSettingsProperties.setProperty("article-id",MapUtil.getString(articleIds,articleId,articleId));
      LayoutUtil.update(layout,false);
    }
  }
  zipReader.close();
}
