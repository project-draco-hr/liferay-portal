{
  Map<Long,Layout> layoutMap=(Map<Long,Layout>)portletDataContext.getNewPrimaryKeysMap(Layout.class + ".layout");
  Map<Long,NavigableSet<Layout>> layoutSets=new HashMap<Long,NavigableSet<Layout>>();
  List<Layout> newLayouts=new LinkedList<Layout>();
  for (  Element element : _layoutElements) {
    String action=element.attributeValue(Constants.ACTION);
    if (Constants.ADD.equals(action)) {
      long layoutId=GetterUtil.getLong(element.attributeValue("layout-id"));
      Layout layout=layoutMap.get(layoutId);
      NavigableSet<Layout> layoutSet=layoutSets.get(layout.getParentLayoutId());
      if (layoutSet == null) {
        layoutSets.put(layout.getParentLayoutId(),new TreeSet<Layout>(new LayoutPriorityComparator()));
      }
      newLayouts.add(LayoutLocalServiceUtil.getLayout(layout.getPlid()));
    }
  }
  List<Layout> unmodifiedLayouts=new LinkedList<Layout>(previousLayouts);
  unmodifiedLayouts.removeAll(newLayouts);
  if (unmodifiedLayouts.isEmpty()) {
    return;
  }
  for (  Layout layout : unmodifiedLayouts) {
    NavigableSet<Layout> layoutSet=layoutSets.get(layout.getParentLayoutId());
    if (layoutSet != null) {
      layoutSet.add(layout);
    }
  }
  for (  Layout layout : newLayouts) {
    NavigableSet<Layout> layoutSet=layoutSets.get(layout.getParentLayoutId());
    if (layoutSet.isEmpty()) {
      continue;
    }
    SortedSet<Layout> tailSet=layoutSet.tailSet(layout,true);
    int priority=layout.getPriority();
    for (    Layout tail : tailSet) {
      if (tail.getPriority() == priority) {
        tail.setPriority(++priority);
      }
 else {
        break;
      }
    }
    layoutSet.add(layout);
  }
  for (  NavigableSet<Layout> layoutSet : layoutSets.values()) {
    for (    Layout layout : layoutSet) {
      LayoutUtil.update(layout);
    }
  }
}
