{
  Map<Long,Layout> layoutMap=(Map<Long,Layout>)portletDataContext.getNewPrimaryKeysMap(Layout.class + ".layout");
  List<Layout> newLayouts=new LinkedList<Layout>();
  for (  Element element : _layoutElements) {
    String action=element.attributeValue(Constants.ACTION);
    if (Constants.ADD.equals(action)) {
      long layoutId=GetterUtil.getLong(element.attributeValue("layout-id"));
      Layout layout=layoutMap.get(layoutId);
      newLayouts.add(LayoutLocalServiceUtil.getLayout(layout.getPlid()));
    }
  }
  List<Layout> unmodifiedLayouts=new LinkedList<Layout>(previousLayouts);
  unmodifiedLayouts.removeAll(newLayouts);
  NavigableSet<Layout> layoutSet=new TreeSet<Layout>(new LayoutPriorityComparator());
  layoutSet.addAll(unmodifiedLayouts);
  for (  Layout layout : newLayouts) {
    SortedSet<Layout> tailSet=layoutSet.tailSet(layout,true);
    int priority=layout.getPriority();
    for (    Layout tail : tailSet) {
      if (tail.getPriority() == priority) {
        tail.setPriority(++priority);
      }
 else {
        break;
      }
    }
    layoutSet.add(layout);
  }
  for (  Layout layout : layoutSet) {
    LayoutUtil.update(layout);
  }
}
