{
  boolean deleteMissingLayouts=MapUtil.getBoolean(parameterMap,PortletDataHandlerKeys.DELETE_MISSING_LAYOUTS,Boolean.TRUE.booleanValue());
  boolean deletePortletData=MapUtil.getBoolean(parameterMap,PortletDataHandlerKeys.DELETE_PORTLET_DATA);
  boolean importCategories=MapUtil.getBoolean(parameterMap,PortletDataHandlerKeys.CATEGORIES);
  boolean importPermissions=MapUtil.getBoolean(parameterMap,PortletDataHandlerKeys.PERMISSIONS);
  boolean importPublicLayoutPermissions=MapUtil.getBoolean(parameterMap,PortletDataHandlerKeys.PUBLIC_LAYOUT_PERMISSIONS);
  boolean importPortletData=MapUtil.getBoolean(parameterMap,PortletDataHandlerKeys.PORTLET_DATA);
  boolean importPortletSetup=MapUtil.getBoolean(parameterMap,PortletDataHandlerKeys.PORTLET_SETUP);
  boolean importPortletArchivedSetups=MapUtil.getBoolean(parameterMap,PortletDataHandlerKeys.PORTLET_ARCHIVED_SETUPS);
  boolean importPortletUserPreferences=MapUtil.getBoolean(parameterMap,PortletDataHandlerKeys.PORTLET_USER_PREFERENCES);
  boolean importTheme=MapUtil.getBoolean(parameterMap,PortletDataHandlerKeys.THEME);
  boolean importThemeSettings=MapUtil.getBoolean(parameterMap,PortletDataHandlerKeys.THEME_REFERENCE);
  boolean importLogo=MapUtil.getBoolean(parameterMap,PortletDataHandlerKeys.LOGO);
  boolean importLayoutSetSettings=MapUtil.getBoolean(parameterMap,PortletDataHandlerKeys.LAYOUT_SET_SETTINGS);
  boolean layoutSetPrototypeLinkEnabled=MapUtil.getBoolean(parameterMap,PortletDataHandlerKeys.LAYOUT_SET_PROTOTYPE_LINK_ENABLED,true);
  Group group=GroupLocalServiceUtil.getGroup(groupId);
  if (group.isLayoutSetPrototype()) {
    layoutSetPrototypeLinkEnabled=false;
  }
  String layoutsImportMode=MapUtil.getString(parameterMap,PortletDataHandlerKeys.LAYOUTS_IMPORT_MODE,PortletDataHandlerKeys.LAYOUTS_IMPORT_MODE_MERGE_BY_LAYOUT_UUID);
  String portletsMergeMode=MapUtil.getString(parameterMap,PortletDataHandlerKeys.PORTLETS_MERGE_MODE,PortletDataHandlerKeys.PORTLETS_MERGE_MODE_REPLACE);
  String userIdStrategy=MapUtil.getString(parameterMap,PortletDataHandlerKeys.USER_ID_STRATEGY);
  if (_log.isDebugEnabled()) {
    _log.debug("Delete portlet data " + deletePortletData);
    _log.debug("Import categories " + importCategories);
    _log.debug("Import permissions " + importPermissions);
    _log.debug("Import portlet data " + importPortletData);
    _log.debug("Import portlet setup " + importPortletSetup);
    _log.debug("Import portlet archived setups " + importPortletArchivedSetups);
    _log.debug("Import portlet user preferences " + importPortletUserPreferences);
    _log.debug("Import theme " + importTheme);
  }
  StopWatch stopWatch=null;
  if (_log.isInfoEnabled()) {
    stopWatch=new StopWatch();
    stopWatch.start();
  }
  LayoutCache layoutCache=new LayoutCache();
  LayoutSet layoutSet=LayoutSetLocalServiceUtil.getLayoutSet(groupId,privateLayout);
  long companyId=layoutSet.getCompanyId();
  User user=UserUtil.findByPrimaryKey(userId);
  UserIdStrategy strategy=_portletImporter.getUserIdStrategy(user,userIdStrategy);
  ZipReader zipReader=ZipReaderFactoryUtil.getZipReader(file);
  PortletDataContext portletDataContext=new PortletDataContextImpl(companyId,groupId,parameterMap,new HashSet<String>(),strategy,zipReader);
  portletDataContext.setPortetDataContextListener(new PortletDataContextListenerImpl(portletDataContext));
  portletDataContext.setPrivateLayout(privateLayout);
  Element rootElement=null;
  InputStream themeZip=null;
  String xml=portletDataContext.getZipEntryAsString("/manifest.xml");
  if (xml == null) {
    throw new LARFileException("manifest.xml not found in the LAR");
  }
  try {
    Document document=SAXReaderUtil.read(xml);
    rootElement=document.getRootElement();
  }
 catch (  Exception e) {
    throw new LARFileException(e);
  }
  Element headerElement=rootElement.element("header");
  int buildNumber=ReleaseInfo.getBuildNumber();
  int importBuildNumber=GetterUtil.getInteger(headerElement.attributeValue("build-number"));
  if (buildNumber != importBuildNumber) {
    throw new LayoutImportException("LAR build number " + importBuildNumber + " does not match "+ "portal build number "+ buildNumber);
  }
  String larType=headerElement.attributeValue("type");
  if (!larType.equals("layout-set") && !larType.equals("layout-set-prototype")) {
    throw new LARTypeException("Invalid type of LAR file (" + larType + ")");
  }
  Element layoutsElement=rootElement.element("layouts");
  List<Element> layoutElements=layoutsElement.elements("layout");
  validateLayoutPrototypes(layoutsElement,layoutElements);
  long sourceGroupId=GetterUtil.getLong(headerElement.attributeValue("group-id"));
  portletDataContext.setSourceGroupId(sourceGroupId);
  if (group.isLayoutSetPrototype() && larType.equals("layout-set-prototype")) {
    LayoutSetPrototype layoutSetPrototype=LayoutSetPrototypeLocalServiceUtil.getLayoutSetPrototype(group.getClassPK());
    String layoutSetPrototypeUuid=GetterUtil.getString(headerElement.attributeValue("type-uuid"));
    LayoutSetPrototype existingLayoutSetPrototype=null;
    if (Validator.isNotNull(layoutSetPrototypeUuid)) {
      try {
        existingLayoutSetPrototype=LayoutSetPrototypeLocalServiceUtil.getLayoutSetPrototypeByUuid(layoutSetPrototypeUuid);
      }
 catch (      NoSuchLayoutSetPrototypeException nslspe) {
      }
    }
    if (existingLayoutSetPrototype == null) {
      layoutSetPrototype.setUuid(layoutSetPrototypeUuid);
      LayoutSetPrototypeLocalServiceUtil.updateLayoutSetPrototype(layoutSetPrototype);
    }
  }
  String layoutSetPrototypeUuid=layoutsElement.attributeValue("layout-set-prototype-uuid");
  ServiceContext serviceContext=ServiceContextThreadLocal.getServiceContext();
  if (Validator.isNotNull(layoutSetPrototypeUuid)) {
    layoutSet.setLayoutSetPrototypeUuid(layoutSetPrototypeUuid);
    layoutSet.setLayoutSetPrototypeLinkEnabled(layoutSetPrototypeLinkEnabled);
    LayoutSetLocalServiceUtil.updateLayoutSet(layoutSet);
  }
  if (importTheme) {
    themeZip=portletDataContext.getZipEntryAsInputStream("theme.zip");
  }
  String themeId=layoutSet.getThemeId();
  String colorSchemeId=layoutSet.getColorSchemeId();
  if (importThemeSettings) {
    Attribute themeIdAttribute=headerElement.attribute("theme-id");
    if (themeIdAttribute != null) {
      themeId=themeIdAttribute.getValue();
    }
    Attribute colorSchemeIdAttribute=headerElement.attribute("color-scheme-id");
    if (colorSchemeIdAttribute != null) {
      colorSchemeId=colorSchemeIdAttribute.getValue();
    }
  }
  if (importLogo) {
    String logoPath=headerElement.attributeValue("logo-path");
    byte[] iconBytes=portletDataContext.getZipEntryAsByteArray(logoPath);
    if ((iconBytes != null) && (iconBytes.length > 0)) {
      File logo=FileUtil.createTempFile(iconBytes);
      LayoutSetLocalServiceUtil.updateLogo(groupId,privateLayout,true,logo);
    }
 else {
      LayoutSetLocalServiceUtil.updateLogo(groupId,privateLayout,false,(File)null);
    }
  }
  if (importLayoutSetSettings) {
    String settings=GetterUtil.getString(headerElement.elementText("settings"));
    LayoutSetLocalServiceUtil.updateSettings(groupId,privateLayout,settings);
  }
  String css=GetterUtil.getString(headerElement.elementText("css"));
  if (themeZip != null) {
    String importThemeId=importTheme(layoutSet,themeZip);
    if (importThemeId != null) {
      themeId=importThemeId;
      colorSchemeId=ColorSchemeImpl.getDefaultRegularColorSchemeId();
    }
    if (_log.isDebugEnabled()) {
      _log.debug("Importing theme takes " + stopWatch.getTime() + " ms");
    }
  }
  boolean wapTheme=false;
  LayoutSetLocalServiceUtil.updateLookAndFeel(groupId,privateLayout,themeId,colorSchemeId,css,wapTheme);
  if (importPermissions) {
    _permissionImporter.readPortletDataPermissions(portletDataContext);
  }
  if (importCategories) {
    _portletImporter.readAssetCategories(portletDataContext);
  }
  _portletImporter.readAssetTags(portletDataContext);
  _portletImporter.readComments(portletDataContext);
  _portletImporter.readExpandoTables(portletDataContext);
  _portletImporter.readLocks(portletDataContext);
  _portletImporter.readRatingsEntries(portletDataContext);
  List<Layout> previousLayouts=LayoutUtil.findByG_P(groupId,privateLayout);
  if (Validator.isNotNull(layoutSetPrototypeUuid) && layoutSetPrototypeLinkEnabled) {
    LayoutSetPrototype layoutSetPrototype=LayoutSetPrototypeLocalServiceUtil.getLayoutSetPrototypeByUuid(layoutSetPrototypeUuid);
    Group layoutSetPrototypeGroup=layoutSetPrototype.getGroup();
    for (    Layout layout : previousLayouts) {
      String sourcePrototypeLayoutUuid=layout.getSourcePrototypeLayoutUuid();
      if (Validator.isNull(layout.getSourcePrototypeLayoutUuid())) {
        continue;
      }
      Layout sourcePrototypeLayout=LayoutUtil.fetchByUUID_G(sourcePrototypeLayoutUuid,layoutSetPrototypeGroup.getGroupId());
      if (sourcePrototypeLayout == null) {
        LayoutLocalServiceUtil.deleteLayout(layout,false,serviceContext);
      }
    }
  }
  List<Layout> newLayouts=new ArrayList<Layout>();
  Set<Long> newLayoutIds=new HashSet<Long>();
  Map<Long,Layout> newLayoutsMap=(Map<Long,Layout>)portletDataContext.getNewPrimaryKeysMap(Layout.class);
  if (_log.isDebugEnabled()) {
    if (layoutElements.size() > 0) {
      _log.debug("Importing layouts");
    }
  }
  for (  Element layoutElement : layoutElements) {
    importLayout(portletDataContext,user,layoutCache,previousLayouts,newLayouts,newLayoutsMap,newLayoutIds,portletsMergeMode,themeId,colorSchemeId,layoutsImportMode,privateLayout,importPermissions,importPublicLayoutPermissions,importThemeSettings,rootElement,layoutElement);
  }
  Element portletsElement=rootElement.element("portlets");
  List<Element> portletElements=portletsElement.elements("portlet");
  if (deletePortletData) {
    if (_log.isDebugEnabled()) {
      if (portletElements.size() > 0) {
        _log.debug("Deleting portlet data");
      }
    }
    for (    Element portletElement : portletElements) {
      String portletId=portletElement.attributeValue("portlet-id");
      long layoutId=GetterUtil.getLong(portletElement.attributeValue("layout-id"));
      long plid=newLayoutsMap.get(layoutId).getPlid();
      portletDataContext.setPlid(plid);
      _portletImporter.deletePortletData(portletDataContext,portletId,plid);
    }
  }
  if (_log.isDebugEnabled()) {
    if (portletElements.size() > 0) {
      _log.debug("Importing portlets");
    }
  }
  for (  Element portletElement : portletElements) {
    String portletPath=portletElement.attributeValue("path");
    String portletId=portletElement.attributeValue("portlet-id");
    long layoutId=GetterUtil.getLong(portletElement.attributeValue("layout-id"));
    long plid=newLayoutsMap.get(layoutId).getPlid();
    long oldPlid=GetterUtil.getLong(portletElement.attributeValue("old-plid"));
    Portlet portlet=PortletLocalServiceUtil.getPortletById(portletDataContext.getCompanyId(),portletId);
    if (!portlet.isActive() || portlet.isUndeployedPortlet()) {
      continue;
    }
    Layout layout=null;
    try {
      layout=LayoutUtil.findByPrimaryKey(plid);
    }
 catch (    NoSuchLayoutException nsle) {
      continue;
    }
    portletDataContext.setPlid(plid);
    portletDataContext.setOldPlid(oldPlid);
    Document portletDocument=SAXReaderUtil.read(portletDataContext.getZipEntryAsString(portletPath));
    portletElement=portletDocument.getRootElement();
    _portletImporter.setPortletScope(portletDataContext,portletElement);
    try {
      _portletImporter.importPortletPreferences(portletDataContext,layoutSet.getCompanyId(),layout.getGroupId(),layout,null,portletElement,importPortletSetup,importPortletArchivedSetups,importPortletUserPreferences,false);
      Element portletDataElement=portletElement.element("portlet-data");
      if (importPortletData && (portletDataElement != null)) {
        _portletImporter.importPortletData(portletDataContext,portletId,plid,portletDataElement);
      }
    }
  finally {
      _portletImporter.resetPortletScope(portletDataContext,layout.getGroupId());
    }
    if (importPermissions) {
      _permissionImporter.importPortletPermissions(layoutCache,companyId,groupId,userId,layout,portletElement,portletId);
    }
    _portletImporter.importPortletPreferences(portletDataContext,layoutSet.getCompanyId(),groupId,null,null,portletElement,importPortletSetup,importPortletArchivedSetups,importPortletUserPreferences,false);
  }
  if (importPermissions) {
    if (userId > 0) {
      Indexer indexer=IndexerRegistryUtil.nullSafeGetIndexer(User.class);
      indexer.reindex(userId);
    }
  }
  _portletImporter.readAssetLinks(portletDataContext);
  if (deleteMissingLayouts) {
    deleteMissingLayouts(groupId,privateLayout,newLayoutIds,previousLayouts,serviceContext);
  }
  LayoutSetLocalServiceUtil.updatePageCount(groupId,privateLayout);
  if (_log.isInfoEnabled()) {
    _log.info("Importing layouts takes " + stopWatch.getTime() + " ms");
  }
  GroupLocalServiceUtil.updateSite(groupId,true);
  for (  Layout layout : newLayouts) {
    UnicodeProperties typeSettingsProperties=layout.getTypeSettingsProperties();
    String articleId=typeSettingsProperties.getProperty("article-id");
    if (Validator.isNotNull(articleId)) {
      Map<String,String> articleIds=(Map<String,String>)portletDataContext.getNewPrimaryKeysMap(JournalArticle.class + ".articleId");
      typeSettingsProperties.setProperty("article-id",MapUtil.getString(articleIds,articleId,articleId));
      LayoutUtil.update(layout,false);
    }
  }
  zipReader.close();
}
