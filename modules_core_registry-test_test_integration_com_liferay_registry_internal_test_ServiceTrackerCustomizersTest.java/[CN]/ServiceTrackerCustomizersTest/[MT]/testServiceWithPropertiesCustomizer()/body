{
  ServiceTrackerMap<String,ServiceWithProperties<TrackedOne>> serviceTrackerMap=ServiceTrackerCollections.singleValueMap(TrackedOne.class,"target",ServiceTrackerCustomizerFactory.<TrackedOne>serviceWithProperties());
  serviceTrackerMap.open();
  try {
    Map<String,Object> properties=new Hashtable<>();
    properties.put("property","aProperty");
    properties.put("target","aTarget");
    TrackedOne trackedOne=new TrackedOne();
    ServiceRegistration<TrackedOne> serviceRegistration=RegistryUtil.getRegistry().registerService(TrackedOne.class,trackedOne,properties);
    ServiceWithProperties<TrackedOne> serviceWithProperties=serviceTrackerMap.getService("aTarget");
    Assert.assertEquals(trackedOne,serviceWithProperties.getService());
    Map<String,Object> propertiesMap=serviceWithProperties.getProperties();
    Assert.assertTrue(propertiesMap.containsKey("property"));
    Assert.assertTrue(propertiesMap.containsKey("target"));
    Assert.assertEquals("aProperty",propertiesMap.get("property"));
    Assert.assertEquals("aTarget",propertiesMap.get("target"));
    serviceRegistration.unregister();
  }
  finally {
    serviceTrackerMap.close();
  }
}
