{
  PortletSession portletSession=portletRequest.getPortletSession();
  if (updateResponse == null) {
    return;
  }
  portletSession.setAttribute(WebKeys.MARKUP_CONTEXT,updateResponse.getMarkupContext());
  NavigationalContext navigationalContext=updateResponse.getNavigationalContext();
  if (navigationalContext != null) {
    String opaqueValue=navigationalContext.getOpaqueValue();
    if (Validator.isNotNull(opaqueValue)) {
      byte[] opaqueValueBytes=opaqueValue.getBytes(StringPool.UTF8);
      opaqueValue=Base64.toURLSafe(Base64.encode(opaqueValueBytes));
      stateAwareResponse.setRenderParameter("wsrp-navigationalState",opaqueValue);
    }
    NamedString[] publicValues=navigationalContext.getPublicValues();
    if (publicValues != null) {
      for (      NamedString publicValue : publicValues) {
        String name=publicValue.getName();
        String value=publicValue.getValue();
        if (Validator.isNotNull(value)) {
          stateAwareResponse.setRenderParameter(name,value);
        }
 else {
          stateAwareResponse.removePublicRenderParameter(name);
        }
      }
    }
  }
  PortletContext portletContext=updateResponse.getPortletContext();
  if (portletContext != null) {
    portletSession.setAttribute(WebKeys.PORTLET_CONTEXT,portletContext);
  }
  SessionContext sessionContext=updateResponse.getSessionContext();
  updateSessionContext(portletSession,serviceHolder,sessionContext);
  String portletMode=updateResponse.getNewMode();
  if (Validator.isNotNull(portletMode)) {
    stateAwareResponse.setPortletMode(getPortletMode(portletMode));
  }
  String windowState=updateResponse.getNewWindowState();
  if (Validator.isNotNull(windowState)) {
    stateAwareResponse.setWindowState(getWindowState(windowState));
  }
  Event[] events=updateResponse.getEvents();
  if (events != null) {
    for (    Event event : events) {
      QName qName=wsrpConsumerManager.getEventQName(event.getName());
      event.setName(qName);
      stateAwareResponse.setEvent(qName,event);
    }
  }
}
