{
  String contentType=GetterUtil.get(mimeResponse.getMimeType(),ContentTypes.TEXT_HTML_UTF8);
  jxMimeResponse.setContentType(contentType);
  String charSet=getCharSet(contentType);
  String itemString=mimeResponse.getItemString();
  byte[] itemBinary=mimeResponse.getItemBinary();
  Boolean requiresRewriting=mimeResponse.getRequiresRewriting();
  if (requiresRewriting == null) {
    requiresRewriting=ParamUtil.getBoolean(portletRequest,"wsrp-requiresRewrite");
  }
  if (requiresRewriting && contentType.contains(ContentTypes.TEXT)) {
    if (itemBinary != null) {
      itemString=new String(itemBinary,charSet);
    }
    itemString=rewriteURLs(portletRequest,jxMimeResponse,itemString);
  }
  if (Validator.isNotNull(itemString)) {
    if (jxMimeResponse instanceof ResourceResponse) {
      ResourceResponse resourceResponse=(ResourceResponse)jxMimeResponse;
      resourceResponse.setContentLength(itemString.length());
    }
    PortletResponseUtil.write(jxMimeResponse,itemString);
  }
 else   if (itemBinary != null) {
    if (jxMimeResponse instanceof ResourceResponse) {
      ResourceResponse resourceResponse=(ResourceResponse)jxMimeResponse;
      resourceResponse.setContentLength(itemBinary.length);
    }
    PortletResponseUtil.write(jxMimeResponse,itemBinary);
  }
}
