{
  if ((imagesFile == null) || (!imagesFile.exists())) {
    return;
  }
  ProgressTracker progressTracker=ProgressTrackerThreadLocal.getProgressTracker();
  int count=0;
  ZipReader zipReader=ZipReaderFactoryUtil.getZipReader(imagesFile);
  List<String> entries=zipReader.getEntries();
  int total=entries.size();
  if (total > 0) {
    try {
      WikiPageLocalServiceUtil.getPage(node.getNodeId(),SHARED_IMAGES_TITLE);
    }
 catch (    NoSuchPageException nspe) {
      ServiceContext serviceContext=new ServiceContext();
      serviceContext.setAddGroupPermissions(true);
      serviceContext.setAddGuestPermissions(true);
      WikiPageLocalServiceUtil.addPage(userId,node.getNodeId(),SHARED_IMAGES_TITLE,SHARED_IMAGES_CONTENT,null,true,serviceContext);
    }
  }
  List<File> tempFiles=new ArrayList<File>();
  try {
    List<ObjectValuePair<String,File>> attachments=new ArrayList<ObjectValuePair<String,File>>();
    int percentage=50;
    for (int i=0; i < entries.size(); i++) {
      String entry=entries.get(i);
      String key=entry;
      InputStream is=zipReader.getEntryAsInputStream(entry);
      File file=FileUtil.createTempFile(FileUtil.getExtension(key));
      tempFiles.add(file);
      FileUtil.write(file,is);
      String[] paths=StringUtil.split(key,CharPool.SLASH);
      if (!isValidImage(paths,file)) {
        if (_log.isInfoEnabled()) {
          _log.info("Ignoring " + key);
        }
        continue;
      }
      String fileName=paths[paths.length - 1].toLowerCase();
      attachments.add(new ObjectValuePair<String,File>(fileName,file));
      count++;
      if ((i % 5) == 0) {
        WikiPageLocalServiceUtil.addPageAttachments(userId,node.getNodeId(),SHARED_IMAGES_TITLE,attachments);
        attachments.clear();
        percentage=Math.min(50 + (i * 50) / total,99);
        progressTracker.updateProgress(percentage);
      }
    }
    if (!attachments.isEmpty()) {
      WikiPageLocalServiceUtil.addPageAttachments(userId,node.getNodeId(),SHARED_IMAGES_TITLE,attachments);
    }
  }
  finally {
    for (    File tempFile : tempFiles) {
      if (tempFile.exists()) {
        tempFile.delete();
      }
    }
  }
  zipReader.close();
  if (_log.isInfoEnabled()) {
    _log.info("Imported " + count + " images into "+ node.getName());
  }
}
