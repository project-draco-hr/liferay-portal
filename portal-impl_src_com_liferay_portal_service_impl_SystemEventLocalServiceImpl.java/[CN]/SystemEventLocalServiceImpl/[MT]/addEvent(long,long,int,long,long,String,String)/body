{
  long companyId=0;
  String userName;
  if (userId == 0) {
    userId=PrincipalThreadLocal.getUserId();
  }
  if (userId > 0) {
    User user=userPersistence.findByPrimaryKey(userId);
    companyId=user.getCompanyId();
    userName=user.getFullName();
  }
 else {
    userName=UserConstants.SYSTEM_USER_NAME;
  }
  if (companyId == 0) {
    if (groupId > 0) {
      Group group=groupLocalService.getGroup(groupId);
      companyId=group.getCompanyId();
    }
 else {
      throw new IllegalArgumentException("No company id can be determined");
    }
  }
  long systemEventId=counterLocalService.increment();
  SystemEvent systemEvent=systemEventPersistence.create(systemEventId);
  systemEvent.setCompanyId(companyId);
  systemEvent.setCreateDate(new Date());
  systemEvent.setGroupId(groupId);
  systemEvent.setUserId(userId);
  systemEvent.setUserName(userName);
  systemEvent.setClassNameId(classNameId);
  systemEvent.setClassPK(classPK);
  systemEvent.setClassUuid(classUuid);
  systemEvent.setExtraData(extraData);
  systemEvent.setType(type);
  systemEventPersistence.update(systemEvent);
}
