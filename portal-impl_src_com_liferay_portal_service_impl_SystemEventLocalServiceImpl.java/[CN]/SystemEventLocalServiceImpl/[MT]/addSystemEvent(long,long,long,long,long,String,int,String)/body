{
  if (userId == 0) {
    userId=PrincipalThreadLocal.getUserId();
  }
  String userName=StringPool.BLANK;
  if ((companyId == 0) && (userId > 0)) {
    User user=userPersistence.findByPrimaryKey(userId);
    companyId=user.getCompanyId();
    userName=user.getFullName();
  }
  if (companyId == 0) {
    if (groupId > 0) {
      Group group=groupPersistence.findByPrimaryKey(groupId);
      companyId=group.getCompanyId();
    }
 else {
      throw new IllegalArgumentException("Unable to determine company");
    }
  }
  long systemEventId=counterLocalService.increment();
  SystemEvent systemEvent=systemEventPersistence.create(systemEventId);
  systemEvent.setGroupId(groupId);
  systemEvent.setCompanyId(companyId);
  systemEvent.setUserId(userId);
  systemEvent.setUserName(userName);
  systemEvent.setCreateDate(new Date());
  systemEvent.setClassNameId(classNameId);
  systemEvent.setClassPK(classPK);
  systemEvent.setClassUuid(classUuid);
  systemEvent.setType(type);
  systemEvent.setExtraData(extraData);
  systemEventPersistence.update(systemEvent);
}
