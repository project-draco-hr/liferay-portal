{
  GatheringByteChannel gatheringByteChannel=(GatheringByteChannel)selectionKey.channel();
  ChannelContext channelContext=(ChannelContext)selectionKey.attachment();
  Queue<Datagram> sendingQueue=channelContext.getSendingQueue();
  if (channelContext.getWritingDatagram() == null) {
    channelContext.setWritingDatagram(sendingQueue.poll());
  }
  boolean backOff=false;
  if (channelContext.getWritingDatagram() != null) {
    if (handleWriting(gatheringByteChannel,channelContext)) {
      if (sendingQueue.isEmpty()) {
        backOff=true;
      }
    }
  }
 else {
    backOff=true;
  }
  if (backOff) {
    int ops=selectionKey.interestOps();
    ops&=~SelectionKey.OP_WRITE;
synchronized (selectionKey) {
      if (sendingQueue.isEmpty()) {
        selectionKey.interestOps(ops);
      }
    }
  }
}
