{
  GatheringByteChannel gatheringByteChannel=(GatheringByteChannel)selectionKey.channel();
  ChannelContext channelContext=(ChannelContext)selectionKey.attachment();
  Queue<Datagram> sendingQueue=channelContext.getSendingQueue();
  boolean ready=false;
  if (channelContext.getWritingDatagram() == null) {
    Datagram datagram=sendingQueue.poll();
    if (datagram != null) {
      channelContext.setWritingDatagram(datagram);
      ready=true;
    }
  }
 else {
    ready=true;
  }
  if (ready) {
    if (handleWriting(gatheringByteChannel,channelContext)) {
      if (sendingQueue.isEmpty()) {
        int ops=selectionKey.interestOps();
        ops&=~SelectionKey.OP_WRITE;
synchronized (selectionKey) {
          if (sendingQueue.isEmpty()) {
            selectionKey.interestOps(ops);
          }
        }
      }
    }
  }
}
