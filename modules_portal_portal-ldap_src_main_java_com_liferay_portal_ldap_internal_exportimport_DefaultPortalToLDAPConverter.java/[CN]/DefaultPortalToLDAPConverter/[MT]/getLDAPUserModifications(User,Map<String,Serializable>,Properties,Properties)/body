{
  Modifications modifications=getModifications(user,userMappings,_reservedUserFieldNames);
  if (PrincipalThreadLocal.getPasswordModified() && Validator.isNotNull(PrincipalThreadLocal.getPasswordUnencrypted())) {
    String newPassword=getEncryptedPasswordForLDAP(user,userMappings);
    String passwordKey=userMappings.getProperty(UserConverterKeys.PASSWORD);
    addModificationItem(passwordKey,newPassword,modifications);
  }
  String portraitKey=userMappings.getProperty(UserConverterKeys.PORTRAIT);
  if (Validator.isNotNull(portraitKey)) {
    addModificationItem(new BasicAttribute(portraitKey,getUserPortrait(user)),modifications);
  }
  populateCustomAttributeModifications(user,user.getExpandoBridge(),userExpandoAttributes,userExpandoMappings,modifications);
  return modifications;
}
