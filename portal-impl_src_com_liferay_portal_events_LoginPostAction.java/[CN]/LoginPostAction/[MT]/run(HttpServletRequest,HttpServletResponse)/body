{
  try {
    if (_log.isDebugEnabled()) {
      _log.debug("Running " + request.getRemoteUser());
    }
    HttpSession session=request.getSession();
    session.removeAttribute(Globals.LOCALE_KEY);
    long userId=PortalUtil.getUserId(request);
    if (PropsValues.LIVE_USERS_ENABLED) {
      long companyId=PortalUtil.getCompanyId(request);
      String sessionId=session.getId();
      String remoteAddr=request.getRemoteAddr();
      String remoteHost=request.getRemoteHost();
      String userAgent=request.getHeader(HttpHeaders.USER_AGENT);
      Message message=new Message(MessageTypes.LIVE_USER_MESSAGE);
      message.setDestination(DestinationNames.LIVE_USERS);
      JSONObject jsonObj=JSONFactoryUtil.createJSONObject();
      jsonObj.put("command","signIn");
      jsonObj.put("companyId",companyId);
      jsonObj.put("userId",userId);
      jsonObj.put("sessionId",sessionId);
      jsonObj.put("remoteAddr",remoteAddr);
      jsonObj.put("remoteHost",remoteHost);
      jsonObj.put("userAgent",userAgent);
      message.setPayload(jsonObj.toString());
      MessageBusUtil.sendMessage(DestinationNames.LIVE_USERS,message);
    }
    Message message=new Message(MessageTypes.RUON_MESSAGE);
    message.setDestination(DestinationNames.RUON);
    JSONObject ruonJSON=JSONFactoryUtil.createJSONObject();
    JSONObject setPresenceStatusRequestJSON=JSONFactoryUtil.createJSONObject();
    setPresenceStatusRequestJSON.put("userId",String.valueOf(userId));
    setPresenceStatusRequestJSON.put("status","online");
    ruonJSON.put("setPresenceStatusRequest",setPresenceStatusRequestJSON);
    message.setPayload(ruonJSON.toString());
    MessageBusUtil.sendMessage(DestinationNames.RUON,message);
  }
 catch (  Exception e) {
    throw new ActionException(e);
  }
}
