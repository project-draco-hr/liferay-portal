{
  try {
    if (_log.isDebugEnabled()) {
      _log.debug("Running " + req.getRemoteUser());
    }
    HttpSession ses=req.getSession();
    long companyId=PortalUtil.getCompanyId(req);
    long userId=PortalUtil.getUserId(req);
    if (PropsValues.REVERSE_AJAX_ENABLED) {
      ses.setAttribute(WebKeys.REVERSE_AJAX,new ReverseAjax());
    }
    MessagingUtil.createXMPPConnection(ses,userId);
    LiveUsers.signIn(req);
    if (!PropsValues.LAYOUT_REMEMBER_SESSION_WINDOW_STATE_MAXIMIZED) {
      Group group=GroupLocalServiceUtil.getUserGroup(companyId,userId);
      Iterator itr=LayoutLocalServiceUtil.getLayouts(group.getGroupId(),true).iterator();
      while (itr.hasNext()) {
        Layout layout=(Layout)itr.next();
        LayoutTypePortlet layoutType=(LayoutTypePortlet)layout.getLayoutType();
        if (layoutType.hasStateMax()) {
          layoutType.resetStates();
          layoutType.resetModes();
          LayoutLocalServiceUtil.updateLayout(layout.getGroupId(),layout.isPrivateLayout(),layout.getLayoutId(),layout.getTypeSettings());
        }
      }
    }
    ses.removeAttribute(Globals.LOCALE_KEY);
  }
 catch (  Exception e) {
    throw new ActionException(e);
  }
}
