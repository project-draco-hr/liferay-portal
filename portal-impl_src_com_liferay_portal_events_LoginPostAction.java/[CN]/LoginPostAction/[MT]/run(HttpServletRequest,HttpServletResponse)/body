{
  try {
    if (_log.isDebugEnabled()) {
      _log.debug("Running " + request.getRemoteUser());
    }
    HttpSession session=request.getSession();
    long companyId=PortalUtil.getCompanyId(request);
    long userId=0;
    session.removeAttribute(Globals.LOCALE_KEY);
    if (PropsValues.LIVE_USERS_ENABLED) {
      userId=PortalUtil.getUserId(request);
      String sessionId=session.getId();
      String remoteAddr=request.getRemoteAddr();
      String remoteHost=request.getRemoteHost();
      String userAgent=request.getHeader(HttpHeaders.USER_AGENT);
      JSONObject jsonObject=JSONFactoryUtil.createJSONObject();
      jsonObject.put("command","signIn");
      ClusterNode clusterNode=ClusterExecutorUtil.getLocalClusterNode();
      jsonObject.put("clusterNodeId",clusterNode.getClusterNodeId());
      jsonObject.put("companyId",companyId);
      jsonObject.put("userId",userId);
      jsonObject.put("sessionId",sessionId);
      jsonObject.put("remoteAddr",remoteAddr);
      jsonObject.put("remoteHost",remoteHost);
      jsonObject.put("userAgent",userAgent);
      MessageBusUtil.sendMessage(DestinationNames.LIVE_USERS,jsonObject.toString());
    }
    if (PrefsPropsUtil.getBoolean(companyId,PropsKeys.ADMIN_SYNC_DEFAULT_ASSOCIATIONS)) {
      if (userId == 0) {
        userId=PortalUtil.getUserId(request);
      }
      UserLocalServiceUtil.addDefaultGroups(userId);
      UserLocalServiceUtil.addDefaultRoles(userId);
      UserLocalServiceUtil.addDefaultUserGroups(userId);
    }
  }
 catch (  Exception e) {
    throw new ActionException(e);
  }
}
