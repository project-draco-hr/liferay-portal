{
  StringMaker sm=new StringMaker();
  List<Layout> layouts=LayoutLocalServiceUtil.getLayouts(groupId,false);
  sm.append("update LayoutSet ");
  sm.append("set themeId = 'liferayjedi_WAR_liferayjeditheme', ");
  sm.append("pageCount = ");
  sm.append(layouts.size());
  sm.append(" where groupId = ");
  sm.append(groupId);
  sm.append(" and privateLayout = FALSE;\n\n");
  Collections.sort(layouts,new LayoutComparator(true));
  for (  Layout layout : layouts) {
    getNewPrimaryKey(layout.getPlid());
  }
  for (  Layout layout : layouts) {
    Properties props=layout.getTypeSettingsProperties();
    long linkToPlid=GetterUtil.getLong(props.getProperty("linkToPlid"));
    if (linkToPlid > 0) {
      long newLinkToPlid=getNewPrimaryKey(linkToPlid);
      props.setProperty("linkToPlid",String.valueOf(newLinkToPlid));
    }
    sm.append("insert into Layout (");
    sm.append("plid, groupId, companyId, privateLayout, layoutId, ");
    sm.append("parentLayoutId, name, title, type_, typeSettings, ");
    sm.append("hidden_, friendlyURL, iconImage, iconImageId, ");
    sm.append("css, priority");
    sm.append(") values (");
    addPKColumn(sm,layout.getPlid());
    addColumn(sm,layout.getGroupId());
    addColumn(sm,layout.getCompanyId());
    addColumn(sm,layout.isPrivateLayout());
    addColumn(sm,layout.getLayoutId());
    addColumn(sm,layout.getParentLayoutId());
    addColumn(sm,layout.getName());
    addColumn(sm,layout.getTitle());
    addColumn(sm,layout.getType());
    addColumn(sm,layout.getTypeSettings());
    addColumn(sm,layout.isHidden());
    addColumn(sm,layout.getFriendlyURL());
    addColumn(sm,layout.isIconImage());
    addColumn(sm,layout.getIconImageId());
    addColumn(sm,layout.getCss());
    addColumn(sm,layout.getPriority());
    removeTrailingComma(sm);
    sm.append(");\n");
  }
  sm.append("\n");
  for (  Layout layout : layouts) {
    LayoutTypePortlet layoutType=(LayoutTypePortlet)layout.getLayoutType();
    List<String> portletIds=layoutType.getPortletIds();
    Collections.sort(portletIds);
    for (int i=0; i < portletIds.size(); i++) {
      String portletId=portletIds.get(i);
      try {
        PortletPreferences portletPreferences=PortletPreferencesLocalServiceUtil.getPortletPreferences(PortletKeys.PREFS_OWNER_ID_DEFAULT,PortletKeys.PREFS_OWNER_TYPE_LAYOUT,layout.getPlid(),portletId);
        String prefsXml=portletPreferences.getPreferences();
        PortletPreferencesImpl prefs=(PortletPreferencesImpl)PortletPreferencesSerializer.fromDefaultXML(portletPreferences.getPreferences());
        String articleId=prefs.getValue("article-id",StringPool.BLANK);
        articleId=articleId.toUpperCase();
        if (Validator.isNotNull(articleId)) {
          if (!JournalArticleLocalServiceUtil.hasArticle(layout.getGroupId(),articleId)) {
            continue;
          }
          prefs.setValue("article-id",getNewPrimaryKey(articleId));
          prefsXml=PortletPreferencesSerializer.toXML(prefs);
          long contentSearchId=CounterLocalServiceUtil.increment();
          JournalContentSearch journalContentSearch=JournalContentSearchUtil.create(contentSearchId);
          journalContentSearch.setContentSearchId(contentSearchId);
          journalContentSearch.setCompanyId(layout.getCompanyId());
          journalContentSearch.setGroupId(layout.getGroupId());
          journalContentSearch.setPrivateLayout(layout.isPrivateLayout());
          journalContentSearch.setPortletId(portletId);
          journalContentSearch.setLayoutId(layout.getLayoutId());
          journalContentSearch.setPortletId(portletId);
          journalContentSearch.setArticleId(getNewPrimaryKey(articleId));
          journalContentSearches.add(journalContentSearch);
        }
        sm.append("insert into PortletPreferences (");
        sm.append("portletPreferencesId, ownerId, ownerType, ");
        sm.append("plid, portletId, preferences");
        sm.append(") values (");
        addPKColumn(sm,portletPreferences.getPortletPreferencesId());
        addColumn(sm,portletPreferences.getOwnerId());
        addColumn(sm,portletPreferences.getOwnerType());
        addPKColumn(sm,portletPreferences.getPlid());
        addColumn(sm,portletId);
        addColumn(sm,prefsXml);
        removeTrailingComma(sm);
        sm.append(");\n");
      }
 catch (      NoSuchPortletPreferencesException nsppe) {
        _log.warn(nsppe.getMessage());
      }
    }
    sm.append("\n");
  }
  removeTrailingNewLine(sm);
  removeTrailingNewLine(sm);
  zipWriter.addEntry("portal-data-cms-layout.sql",sm);
}
