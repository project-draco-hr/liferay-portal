{
  if (Validator.isNull(fileName)) {
    return null;
  }
  ServiceContext serviceContext=new ServiceContext();
  serviceContext.setAddGroupPermissions(true);
  serviceContext.setAddGuestPermissions(true);
  Repository repository=addPortletRepository(groupId,portletId,serviceContext);
  serviceContext.setAttribute("className",className);
  serviceContext.setAttribute("classPK",String.valueOf(classPK));
  serviceContext.setIndexingEnabled(indexingEnabled);
  if (Validator.isNull(mimeType) || mimeType.equals(ContentTypes.APPLICATION_OCTET_STREAM)) {
    mimeType=MimeTypesUtil.getContentType(file,fileName);
  }
  boolean dlAppHelperEnabled=DLAppHelperThreadLocal.isEnabled();
  try {
    DLAppHelperThreadLocal.setEnabled(false);
    LocalRepository localRepository=RepositoryProviderUtil.getLocalRepository(repository.getRepositoryId());
    return localRepository.addFileEntry(userId,folderId,fileName,mimeType,fileName,StringPool.BLANK,StringPool.BLANK,file,serviceContext);
  }
  finally {
    DLAppHelperThreadLocal.setEnabled(dlAppHelperEnabled);
  }
}
