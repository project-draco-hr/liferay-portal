{
  User user=userPersistence.findByPrimaryKey(userId);
  Folder folder=folderPersistence.findByPrimaryKey(folderId);
  Date now=new Date();
  long messageId=counterLocalService.increment();
  Message message=messagePersistence.create(messageId);
  message.setCompanyId(user.getCompanyId());
  message.setUserId(user.getUserId());
  message.setUserName(user.getFullName());
  message.setCreateDate(now);
  message.setModifiedDate(now);
  message.setAccountId(folder.getAccountId());
  message.setFolderId(folderId);
  message.setSender(sender);
  message.setTo(to);
  message.setCc(cc);
  message.setBcc(bcc);
  message.setSentDate(sentDate);
  message.setSubject(subject);
  message.setPreview(getPreview(body));
  message.setBody(getBody(body));
  message.setFlags(flags);
  message.setSize(getSize(messageId,body));
  message.setRemoteMessageId(remoteMessageId);
  message.setContentType(removeBoundaryMarker(contentType));
  messagePersistence.update(message);
  Indexer<Message> indexer=IndexerRegistryUtil.getIndexer(Message.class);
  indexer.reindex(message);
  return message;
}
