{
  String servletContextName=servletContext.getServletContextName();
  PortletApp portletApp=portlet.getPortletApp();
  if (!portletApp.isWARFile()) {
    String contextPath=PortalUtil.getPathContext();
    servletContext=VelocityContextPool.get(contextPath);
    portletClassLoader=PortalClassLoaderUtil.getClassLoader();
  }
  Class<?> portletClass=null;
  try {
    portletClass=portletClassLoader.loadClass(portlet.getPortletClass());
  }
 catch (  Throwable e) {
    _log.error(e,e);
    portletsItr.remove();
    PortletLocalServiceUtil.destroyPortlet(portlet);
    return;
  }
  javax.portlet.Portlet portletInstance=(javax.portlet.Portlet)portletClass.newInstance();
  if (ClassUtil.isSubclass(portletClass,StrutsPortlet.class.getName())) {
    _strutsBridges=true;
  }
  ConfigurationAction configurationActionInstance=null;
  if (Validator.isNotNull(portlet.getConfigurationActionClass())) {
    configurationActionInstance=(ConfigurationAction)portletClassLoader.loadClass(portlet.getConfigurationActionClass()).newInstance();
  }
  Indexer indexerInstance=null;
  if (Validator.isNotNull(portlet.getIndexerClass())) {
    indexerInstance=(Indexer)portletClassLoader.loadClass(portlet.getIndexerClass()).newInstance();
    indexerInstance=(Indexer)Proxy.newProxyInstance(portletClassLoader,new Class[]{Indexer.class},new ContextClassLoaderBeanHandler(indexerInstance,portletClassLoader));
    IndexerRegistryUtil.register(indexerInstance);
  }
  OpenSearch openSearchInstance=null;
  if (Validator.isNotNull(portlet.getOpenSearchClass())) {
    openSearchInstance=(OpenSearch)portletClassLoader.loadClass(portlet.getOpenSearchClass()).newInstance();
  }
  Scheduler schedulerInstance=null;
  if (PropsValues.SCHEDULER_ENABLED && Validator.isNotNull(portlet.getSchedulerClass())) {
    schedulerInstance=(Scheduler)portletClassLoader.loadClass(portlet.getSchedulerClass()).newInstance();
    schedulerInstance.schedule();
  }
  if (PropsValues.SCHEDULER_ENABLED) {
    List<SchedulerEntry> schedulerEntries=portlet.getSchedulerEntries();
    if (schedulerEntries != null && schedulerEntries.size() > 0) {
      for (      SchedulerEntry schedulerEntry : schedulerEntries) {
        try {
          com.liferay.portal.kernel.messaging.MessageListener schedulerEventListener=schedulerEntry.getEventListener();
          if (schedulerEventListener == null) {
            throw new SystemException("Unable to create scheduler listener " + "from class:" + schedulerEntry.getEventListenerClass());
          }
          MessageBusUtil.registerMessageListener(DestinationNames.SCHEDULER_DISPATCH,schedulerEventListener);
          SchedulerEngineUtil.schedule(schedulerEntry.getTrigger(),schedulerEntry.getDescription(),DestinationNames.SCHEDULER_DISPATCH,null);
        }
 catch (        Exception ex) {
          if (_log.isErrorEnabled()) {
            _log.error("Failed to create scheduler for portlet:" + portlet.getPortletName(),ex);
          }
          continue;
        }
      }
    }
  }
  FriendlyURLMapper friendlyURLMapperInstance=null;
  if (Validator.isNotNull(portlet.getFriendlyURLMapperClass())) {
    friendlyURLMapperInstance=(FriendlyURLMapper)portletClassLoader.loadClass(portlet.getFriendlyURLMapperClass()).newInstance();
  }
  URLEncoder urlEncoderInstance=null;
  if (Validator.isNotNull(portlet.getURLEncoderClass())) {
    urlEncoderInstance=(URLEncoder)portletClassLoader.loadClass(portlet.getURLEncoderClass()).newInstance();
  }
  PortletDataHandler portletDataHandlerInstance=null;
  if (Validator.isNotNull(portlet.getPortletDataHandlerClass())) {
    portletDataHandlerInstance=(PortletDataHandler)portletClassLoader.loadClass(portlet.getPortletDataHandlerClass()).newInstance();
    portletDataHandlerInstance=(PortletDataHandler)Proxy.newProxyInstance(portletClassLoader,new Class[]{PortletDataHandler.class},new ContextClassLoaderBeanHandler(portletDataHandlerInstance,portletClassLoader));
  }
  PortletLayoutListener portletLayoutListenerInstance=null;
  if (Validator.isNotNull(portlet.getPortletLayoutListenerClass())) {
    portletLayoutListenerInstance=(PortletLayoutListener)portletClassLoader.loadClass(portlet.getPortletLayoutListenerClass()).newInstance();
  }
  PollerProcessor pollerProcessorInstance=null;
  if (Validator.isNotNull(portlet.getPollerProcessorClass())) {
    pollerProcessorInstance=(PollerProcessor)portletClassLoader.loadClass(portlet.getPollerProcessorClass()).newInstance();
    pollerProcessorInstance=(PollerProcessor)Proxy.newProxyInstance(portletClassLoader,new Class[]{PollerProcessor.class},new ContextClassLoaderBeanHandler(pollerProcessorInstance,portletClassLoader));
    PollerProcessorUtil.addPollerProcessor(portlet.getPortletId(),pollerProcessorInstance);
  }
  MessageListener popMessageListenerInstance=null;
  if (Validator.isNotNull(portlet.getPopMessageListenerClass())) {
    popMessageListenerInstance=(MessageListener)portletClassLoader.loadClass(portlet.getPopMessageListenerClass()).newInstance();
    POPServerUtil.addListener(popMessageListenerInstance);
  }
  SocialActivityInterpreter socialActivityInterpreterInstance=null;
  if (Validator.isNotNull(portlet.getSocialActivityInterpreterClass())) {
    socialActivityInterpreterInstance=(SocialActivityInterpreter)portletClassLoader.loadClass(portlet.getSocialActivityInterpreterClass()).newInstance();
    socialActivityInterpreterInstance=new SocialActivityInterpreterImpl(portlet.getPortletId(),socialActivityInterpreterInstance);
    SocialActivityInterpreterLocalServiceUtil.addActivityInterpreter(socialActivityInterpreterInstance);
  }
  SocialRequestInterpreter socialRequestInterpreterInstance=null;
  if (Validator.isNotNull(portlet.getSocialRequestInterpreterClass())) {
    socialRequestInterpreterInstance=(SocialRequestInterpreter)portletClassLoader.loadClass(portlet.getSocialRequestInterpreterClass()).newInstance();
    socialRequestInterpreterInstance=new SocialRequestInterpreterImpl(portlet.getPortletId(),socialRequestInterpreterInstance);
    SocialRequestInterpreterLocalServiceUtil.addRequestInterpreter(socialRequestInterpreterInstance);
  }
  WebDAVStorage webDAVStorageInstance=null;
  if (Validator.isNotNull(portlet.getWebDAVStorageClass())) {
    webDAVStorageInstance=(WebDAVStorage)portletClassLoader.loadClass(portlet.getWebDAVStorageClass()).newInstance();
    webDAVStorageInstance.setToken(portlet.getWebDAVStorageToken());
    WebDAVUtil.addStorage(webDAVStorageInstance);
  }
  ControlPanelEntry controlPanelEntryInstance=null;
  if (Validator.isNotNull(portlet.getControlPanelEntryClass())) {
    controlPanelEntryInstance=(ControlPanelEntry)portletClassLoader.loadClass(portlet.getControlPanelEntryClass()).newInstance();
  }
  List<AssetRendererFactory> assetRendererFactoryInstances=new ArrayList<AssetRendererFactory>();
  for (  String assetRendererFactoryClass : portlet.getAssetRendererFactoryClasses()) {
    AssetRendererFactory assetRendererFactoryInstance=(AssetRendererFactory)portletClassLoader.loadClass(assetRendererFactoryClass).newInstance();
    assetRendererFactoryInstance=(AssetRendererFactory)Proxy.newProxyInstance(portletClassLoader,new Class[]{AssetRendererFactory.class},new ContextClassLoaderBeanHandler(assetRendererFactoryInstance,portletClassLoader));
    assetRendererFactoryInstance.setClassNameId(PortalUtil.getClassNameId(assetRendererFactoryInstance.getClassName()));
    assetRendererFactoryInstance.setPortletId(portlet.getPortletId());
    assetRendererFactoryInstances.add(assetRendererFactoryInstance);
    AssetRendererFactoryRegistryUtil.register(assetRendererFactoryInstance);
  }
  List<CustomAttributesDisplay> customAttributesDisplayInstances=new ArrayList<CustomAttributesDisplay>();
  for (  String customAttributesDisplayClass : portlet.getCustomAttributesDisplayClasses()) {
    CustomAttributesDisplay customAttributesDisplayInstance=(CustomAttributesDisplay)portletClassLoader.loadClass(customAttributesDisplayClass).newInstance();
    customAttributesDisplayInstance=(CustomAttributesDisplay)Proxy.newProxyInstance(portletClassLoader,new Class[]{CustomAttributesDisplay.class},new ContextClassLoaderBeanHandler(customAttributesDisplayInstance,portletClassLoader));
    customAttributesDisplayInstance.setClassNameId(PortalUtil.getClassNameId(customAttributesDisplayInstance.getClassName()));
    customAttributesDisplayInstance.setPortletId(portlet.getPortletId());
    customAttributesDisplayInstances.add(customAttributesDisplayInstance);
  }
  List<WorkflowHandler> workflowHandlerInstances=new ArrayList<WorkflowHandler>();
  for (  String workflowHandlerClass : portlet.getWorkflowHandlerClasses()) {
    WorkflowHandler workflowHandlerInstance=(WorkflowHandler)portletClassLoader.loadClass(workflowHandlerClass).newInstance();
    workflowHandlerInstance=(WorkflowHandler)Proxy.newProxyInstance(portletClassLoader,new Class[]{WorkflowHandler.class},new ContextClassLoaderBeanHandler(workflowHandlerInstance,portletClassLoader));
    workflowHandlerInstances.add(workflowHandlerInstance);
    WorkflowHandlerRegistryUtil.register(workflowHandlerInstance);
  }
  PreferencesValidator preferencesValidatorInstance=null;
  if (Validator.isNotNull(portlet.getPreferencesValidator())) {
    preferencesValidatorInstance=(PreferencesValidator)portletClassLoader.loadClass(portlet.getPreferencesValidator()).newInstance();
    try {
      if (PropsValues.PREFERENCE_VALIDATE_ON_STARTUP) {
        preferencesValidatorInstance.validate(PortletPreferencesSerializer.fromDefaultXML(portlet.getDefaultPreferences()));
      }
    }
 catch (    Exception e) {
      _log.warn("Portlet with the name " + portlet.getPortletId() + " does not have valid default preferences");
    }
  }
  Map<String,ResourceBundle> resourceBundles=null;
  if (Validator.isNotNull(portlet.getResourceBundle())) {
    resourceBundles=new HashMap<String,ResourceBundle>();
    initResourceBundle(resourceBundles,portlet,portletClassLoader,LocaleUtil.getDefault());
    Iterator<String> supportLocalesItr=portlet.getSupportedLocales().iterator();
    while (supportLocalesItr.hasNext()) {
      String supportedLocale=supportLocalesItr.next();
      Locale locale=LocaleUtil.fromLanguageId(supportedLocale);
      initResourceBundle(resourceBundles,portlet,portletClassLoader,locale);
    }
  }
  PortletBag portletBag=new PortletBagImpl(portlet.getPortletId(),servletContext,portletInstance,configurationActionInstance,indexerInstance,openSearchInstance,schedulerInstance,friendlyURLMapperInstance,urlEncoderInstance,portletDataHandlerInstance,portletLayoutListenerInstance,pollerProcessorInstance,popMessageListenerInstance,socialActivityInterpreterInstance,socialRequestInterpreterInstance,webDAVStorageInstance,controlPanelEntryInstance,assetRendererFactoryInstances,customAttributesDisplayInstances,workflowHandlerInstances,preferencesValidatorInstance,resourceBundles);
  PortletBagPool.put(portlet.getPortletId(),portletBag);
  if (!_portletAppInitialized) {
    initPortletApp(portlet,servletContextName,servletContext,portletClassLoader);
    _portletAppInitialized=true;
  }
  try {
    PortletInstanceFactoryUtil.create(portlet,servletContext);
  }
 catch (  Exception e) {
    _log.error(e,e);
  }
}
