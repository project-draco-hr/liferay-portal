{
  if (inputStream == null) {
    throw new IOException("Input stream is null");
  }
  if (length <= 0) {
    return 0;
  }
  int read=0;
  while (true) {
    int available=firstInvalidIndex - index;
    if ((available + read) >= length) {
      int leftSize=length - read;
      System.arraycopy(buffer,index,byteArray,read,leftSize);
      index+=leftSize;
      return length;
    }
    if (available <= 0) {
      readUnderlyingInputStream();
      available=firstInvalidIndex - index;
      if (available <= 0) {
        if (read == 0) {
          return -1;
        }
 else {
          return read;
        }
      }
    }
 else {
      System.arraycopy(buffer,index,byteArray,read,available);
      index+=available;
      read+=available;
    }
  }
}
