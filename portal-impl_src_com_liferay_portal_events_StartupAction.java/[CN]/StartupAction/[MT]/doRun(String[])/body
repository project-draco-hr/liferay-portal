{
  System.out.println("Starting " + ReleaseInfo.getReleaseInfo());
  try {
    LockServiceUtil.clear();
  }
 catch (  Exception e) {
    _log.error(e,e);
  }
  Runtime.getRuntime().addShutdownHook(new Thread(new ShutdownHook()));
  if ((System.getSecurityManager() == null) && (PropsValues.PORTAL_SECURITY_MANAGER_ENABLE)) {
    System.setSecurityManager(new PortalSecurityManager());
  }
  VelocityEngineUtil.init();
  CacheRegistry.setActive(false);
  int buildNumber=ReleaseLocalServiceUtil.getBuildNumberOrCreate();
  if (buildNumber < ReleaseInfo.RELEASE_4_2_1_BUILD_NUMBER) {
    String msg="You must first upgrade to Liferay Portal 4.2.1";
    _log.fatal(msg);
    throw new RuntimeException(msg);
  }
  StartupHelperUtil.upgradeProcess(buildNumber);
  ClassNameLocalServiceUtil.checkClassNames();
  ResourceActionsUtil.init();
  ResourceActionLocalServiceUtil.checkResourceActions();
  ResourceCodeLocalServiceUtil.checkResourceCodes();
  StartupHelperUtil.deleteTempImages();
  if (StartupHelperUtil.isUpgraded()) {
    MultiVMPoolUtil.clear();
  }
  MessageBus messageBus=(MessageBus)PortalBeanLocatorUtil.locate(MessageBus.class.getName());
  MessageSender messageSender=(MessageSender)PortalBeanLocatorUtil.locate(MessageSender.class.getName());
  SynchronousMessageSender synchronousMessageSender=(SynchronousMessageSender)PortalBeanLocatorUtil.locate(SynchronousMessageSender.class.getName());
  MessageBusUtil.init(messageBus,messageSender,synchronousMessageSender);
  SchedulerEngineUtil.init(new SchedulerEngineProxy());
  SchedulerEngineUtil.start();
  Release release=ReleaseLocalServiceUtil.getRelease();
  StartupHelperUtil.verifyProcess(release.isVerified());
  if (StartupHelperUtil.isUpgraded()) {
    StartupHelperUtil.updateIndexes();
  }
  boolean verified=StartupHelperUtil.isVerified();
  if (release.isVerified()) {
    verified=true;
  }
  ReleaseLocalServiceUtil.updateRelease(verified);
  CacheRegistry.setActive(true);
}
