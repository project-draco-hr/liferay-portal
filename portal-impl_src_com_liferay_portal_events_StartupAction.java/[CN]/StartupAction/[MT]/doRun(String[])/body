{
  System.out.println("Starting " + ReleaseInfo.getReleaseInfo());
  try {
    LockServiceUtil.clear();
  }
 catch (  Exception e) {
    _log.error(e,e);
  }
  Runtime.getRuntime().addShutdownHook(new Thread(new ShutdownHook()));
  VelocityEngineUtil.init();
  CacheRegistry.setActive(false);
  int buildNumber=ReleaseLocalServiceUtil.getBuildNumberOrCreate();
  if (buildNumber < ReleaseInfo.RELEASE_4_2_1_BUILD_NUMBER) {
    String msg="You must first upgrade to Liferay Portal 4.2.1";
    _log.fatal(msg);
    throw new RuntimeException(msg);
  }
  StartupActionUtil.upgradeProcess(buildNumber);
  ClassNameLocalServiceUtil.checkClassNames();
  StartupActionUtil.deleteTempImages();
  if (StartupActionUtil.isUpgraded()) {
    MultiVMPoolUtil.clear();
  }
  MessageBus messageBus=(MessageBus)PortalBeanLocatorUtil.locate(MessageBus.class.getName());
  MessageSender messageSender=(MessageSender)PortalBeanLocatorUtil.locate(MessageSender.class.getName());
  SynchronousMessageSender synchronousMessageSender=(SynchronousMessageSender)PortalBeanLocatorUtil.locate(SynchronousMessageSender.class.getName());
  MessageBusUtil.init(messageBus,messageSender,synchronousMessageSender);
  SchedulerEngineUtil.init(new SchedulerEngineProxy());
  SchedulerEngineUtil.start();
  Release release=ReleaseLocalServiceUtil.getRelease();
  StartupActionUtil.verifyProcess(release.isVerified());
  if (StartupActionUtil.isUpgraded()) {
    StartupActionUtil.updateIndexes();
  }
  ReleaseLocalServiceUtil.updateRelease(StartupActionUtil.isVerified());
  CacheRegistry.setActive(true);
}
