{
  ServletContext servletContext=_servletContext;
  String requestPath=getRequestPath(request);
  if (requestPath.endsWith(_CSS_EXTENSION) && PortalUtil.isRightToLeft(request)) {
    int pos=requestPath.lastIndexOf(StringPool.PERIOD);
    requestPath=requestPath.substring(0,pos) + "_rtl" + requestPath.substring(pos);
  }
  URL resourceURL=_servletContext.getResource(requestPath);
  if (resourceURL == null) {
    ServletContext resourceServletContext=PortalWebResourcesUtil.getPathServletContext(requestPath);
    if (resourceServletContext != null) {
      resourceURL=PortalWebResourcesUtil.getResource(resourceServletContext,requestPath);
    }
    if (resourceURL == null) {
      resourceServletContext=PortletResourcesUtil.getPathServletContext(requestPath);
      if (resourceServletContext != null) {
        resourceURL=PortletResourcesUtil.getResource(resourceServletContext,requestPath);
      }
    }
    if (resourceURL == null) {
      return null;
    }
    servletContext=resourceServletContext;
  }
  String cacheCommonFileName=getCacheFileName(request);
  File cacheContentTypeFile=new File(_tempDir,cacheCommonFileName + "_E_CONTENT_TYPE");
  File cacheDataFile=new File(_tempDir,cacheCommonFileName + "_E_DATA");
  if (cacheDataFile.exists() && (cacheDataFile.lastModified() >= URLUtil.getLastModifiedTime(resourceURL))) {
    if (cacheContentTypeFile.exists()) {
      String contentType=FileUtil.read(cacheContentTypeFile);
      response.setContentType(contentType);
    }
    return cacheDataFile;
  }
  String dynamicContent=null;
  String content=null;
  try {
    if (requestPath.endsWith(_CSS_EXTENSION)) {
      if (_log.isInfoEnabled()) {
        _log.info("Replacing tokens on CSS " + requestPath);
      }
      content=StringUtil.read(resourceURL.openStream());
      dynamicContent=DynamicCSSUtil.replaceToken(servletContext,request,content);
      response.setContentType(ContentTypes.TEXT_CSS);
      FileUtil.write(cacheContentTypeFile,ContentTypes.TEXT_CSS);
    }
 else     if (requestPath.endsWith(_JSP_EXTENSION)) {
      if (_log.isInfoEnabled()) {
        _log.info("Replacing tokens on JSP or servlet " + requestPath);
      }
      BufferCacheServletResponse bufferCacheServletResponse=new BufferCacheServletResponse(response);
      processFilter(DynamicCSSFilter.class,request,bufferCacheServletResponse,filterChain);
      bufferCacheServletResponse.finishResponse(false);
      content=bufferCacheServletResponse.getString();
      dynamicContent=DynamicCSSUtil.replaceToken(servletContext,request,content);
      FileUtil.write(cacheContentTypeFile,bufferCacheServletResponse.getContentType());
    }
 else {
      return null;
    }
  }
 catch (  Exception e) {
    _log.error("Unable to replace tokens in CSS " + requestPath,e);
    if (_log.isDebugEnabled()) {
      _log.debug(content);
    }
    response.setHeader(HttpHeaders.CACHE_CONTROL,HttpHeaders.CACHE_CONTROL_NO_CACHE_VALUE);
  }
  if (dynamicContent != null) {
    FileUtil.write(cacheDataFile,dynamicContent);
  }
 else {
    dynamicContent=content;
  }
  return dynamicContent;
}
