{
  List<Portlet> dataSiteLevelPortlets=new ArrayList<>();
  Map<Integer,List<Portlet>> rankedPortletsMap=new TreeMap<>();
  List<Portlet> portlets=_portletLocalService.getPortlets(companyId);
  for (  Portlet portlet : portlets) {
    if (!portlet.isActive()) {
      continue;
    }
    PortletDataHandler portletDataHandler=portlet.getPortletDataHandlerInstance();
    if ((portletDataHandler == null) || !portletDataHandler.isDataSiteLevel() || (excludeDataAlwaysStaged && portletDataHandler.isDataAlwaysStaged())) {
      continue;
    }
    List<Portlet> rankedPortlets=rankedPortletsMap.get(portletDataHandler.getRank());
    if (rankedPortlets == null) {
      rankedPortlets=new ArrayList<>();
    }
    rankedPortlets.add(portlet);
    rankedPortletsMap.put(portletDataHandler.getRank(),rankedPortlets);
  }
  for (  List<Portlet> rankedPortlets : rankedPortletsMap.values()) {
    dataSiteLevelPortlets.addAll(rankedPortlets);
  }
  return dataSiteLevelPortlets;
}
