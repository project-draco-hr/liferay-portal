{
  String className=properties.getProperty(EhcacheConstants.CACHE_MANAGER_LISTENER_FACTORY_CLASS_NAME);
  if (Validator.isNull(className)) {
    return null;
  }
  String portalCacheManagerName=properties.getProperty(EhcacheConstants.PORTAL_CACHE_MANAGER_NAME);
  if (Validator.isNull(portalCacheManagerName)) {
    return null;
  }
  PortalCacheManager<?,?> portalCacheManager=PortalCacheProvider.getPortalCacheManager(portalCacheManagerName);
  if (!(portalCacheManager instanceof EhcachePortalCacheManager)) {
    throw new IllegalArgumentException("PortalCacheManager with name " + portalCacheManagerName + " is not a "+ EhcachePortalCacheManager.class.getName());
  }
  EhcachePortalCacheManager<?,?> ehcachePortalCacheManager=(EhcachePortalCacheManager<?,?>)portalCacheManager;
  CacheManagerEventListenerFactory cacheManagerEventListenerFactory=_cacheManagerEventListenerFactories.get(className);
  if (cacheManagerEventListenerFactory == null) {
    try {
      cacheManagerEventListenerFactory=(CacheManagerEventListenerFactory)InstanceFactory.newInstance(ClassLoaderUtil.getPortalClassLoader(),className);
    }
 catch (    Exception e) {
      _log.error("Unable to instantiate cache manager event listener " + "factory " + className,e);
      return null;
    }
    _cacheManagerEventListenerFactories.put(className,cacheManagerEventListenerFactory);
  }
  return new EhcacheCacheManagerListenerAdapter(cacheManagerEventListenerFactory.createCacheManagerEventListener(ehcachePortalCacheManager.getEhcacheManager(),properties));
}
