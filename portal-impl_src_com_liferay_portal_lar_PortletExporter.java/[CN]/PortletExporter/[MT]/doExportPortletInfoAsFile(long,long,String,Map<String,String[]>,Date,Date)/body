{
  boolean exportCategories=MapUtil.getBoolean(parameterMap,PortletDataHandlerKeys.CATEGORIES);
  boolean exportPermissions=MapUtil.getBoolean(parameterMap,PortletDataHandlerKeys.PERMISSIONS);
  boolean exportPortletArchivedSetups=MapUtil.getBoolean(parameterMap,PortletDataHandlerKeys.PORTLET_ARCHIVED_SETUPS);
  boolean exportPortletData=false;
  if (parameterMap.containsKey(PortletDataHandlerKeys.PORTLET_DATA + "_" + PortletConstants.getRootPortletId(portletId))) {
    exportPortletData=MapUtil.getBoolean(parameterMap,PortletDataHandlerKeys.PORTLET_DATA + "_" + PortletConstants.getRootPortletId(portletId));
  }
 else {
    exportPortletData=MapUtil.getBoolean(parameterMap,PortletDataHandlerKeys.PORTLET_DATA);
  }
  boolean exportPortletDataAll=MapUtil.getBoolean(parameterMap,PortletDataHandlerKeys.PORTLET_DATA_ALL);
  boolean exportPortletSetup=MapUtil.getBoolean(parameterMap,PortletDataHandlerKeys.PORTLET_SETUP);
  boolean exportPortletUserPreferences=MapUtil.getBoolean(parameterMap,PortletDataHandlerKeys.PORTLET_USER_PREFERENCES);
  if (_log.isDebugEnabled()) {
    _log.debug("Export categories " + exportCategories);
    _log.debug("Export permissions " + exportPermissions);
    _log.debug("Export portlet archived setups " + exportPortletArchivedSetups);
    _log.debug("Export portlet data " + exportPortletData);
    _log.debug("Export all portlet data " + exportPortletDataAll);
    _log.debug("Export portlet setup " + exportPortletSetup);
    _log.debug("Export portlet user preferences " + exportPortletUserPreferences);
  }
  if (exportPortletDataAll) {
    exportPortletData=true;
  }
  StopWatch stopWatch=null;
  if (_log.isInfoEnabled()) {
    stopWatch=new StopWatch();
    stopWatch.start();
  }
  LayoutCache layoutCache=new LayoutCache();
  Layout layout=LayoutLocalServiceUtil.getLayout(plid);
  if (!layout.isTypeControlPanel() && !layout.isTypePanel() && !layout.isTypePortlet()) {
    throw new LayoutImportException("Layout type " + layout.getType() + " is not valid");
  }
  long defaultUserId=UserLocalServiceUtil.getDefaultUserId(layout.getCompanyId());
  ZipWriter zipWriter=ZipWriterFactoryUtil.getZipWriter();
  long scopeGroupId=groupId;
  javax.portlet.PortletPreferences jxPreferences=PortletPreferencesFactoryUtil.getLayoutPortletSetup(layout,portletId);
  String scopeType=GetterUtil.getString(jxPreferences.getValue("lfrScopeType",null));
  String scopeLayoutUuid=GetterUtil.getString(jxPreferences.getValue("lfrScopeLayoutUuid",null));
  if (Validator.isNotNull(scopeType)) {
    Group scopeGroup=null;
    if (scopeType.equals("company")) {
      scopeGroup=GroupLocalServiceUtil.getCompanyGroup(layout.getCompanyId());
    }
 else     if (Validator.isNotNull(scopeLayoutUuid)) {
      scopeGroup=layout.getScopeGroup();
    }
    if (scopeGroup != null) {
      scopeGroupId=scopeGroup.getGroupId();
    }
  }
  PortletDataContext portletDataContext=new PortletDataContextImpl(layout.getCompanyId(),scopeGroupId,parameterMap,new HashSet<String>(),startDate,endDate,zipWriter);
  portletDataContext.setPortetDataContextListener(new PortletDataContextListenerImpl(portletDataContext));
  portletDataContext.setPlid(plid);
  portletDataContext.setOldPlid(plid);
  portletDataContext.setScopeType(scopeType);
  portletDataContext.setScopeLayoutUuid(scopeLayoutUuid);
  Document document=SAXReaderUtil.createDocument();
  Element rootElement=document.addElement("root");
  Element headerElement=rootElement.addElement("header");
  headerElement.addAttribute("available-locales",StringUtil.merge(LanguageUtil.getAvailableLocales()));
  headerElement.addAttribute("build-number",String.valueOf(ReleaseInfo.getBuildNumber()));
  headerElement.addAttribute("export-date",Time.getRFC822());
  if (portletDataContext.hasDateRange()) {
    headerElement.addAttribute("start-date",String.valueOf(portletDataContext.getStartDate()));
    headerElement.addAttribute("end-date",String.valueOf(portletDataContext.getEndDate()));
  }
  headerElement.addAttribute("type","portlet");
  Group companyGroup=GroupLocalServiceUtil.getCompanyGroup(layout.getCompanyId());
  headerElement.addAttribute("company-group-id",String.valueOf(companyGroup.getGroupId()));
  headerElement.addAttribute("group-id",String.valueOf(scopeGroupId));
  headerElement.addAttribute("private-layout",String.valueOf(layout.isPrivateLayout()));
  headerElement.addAttribute("root-portlet-id",PortletConstants.getRootPortletId(portletId));
  Element missingReferencesElement=rootElement.addElement("missing-references");
  portletDataContext.setMissingReferencesElement(missingReferencesElement);
  exportPortlet(portletDataContext,layoutCache,portletId,layout,rootElement,defaultUserId,exportPermissions,exportPortletArchivedSetups,exportPortletData,exportPortletSetup,exportPortletUserPreferences);
  if (exportCategories) {
    exportAssetCategories(portletDataContext);
  }
  exportAssetLinks(portletDataContext);
  exportAssetTags(portletDataContext);
  exportComments(portletDataContext);
  exportExpandoTables(portletDataContext);
  exportLocks(portletDataContext);
  if (exportPermissions) {
    _permissionExporter.exportPortletDataPermissions(portletDataContext);
  }
  exportRatingsEntries(portletDataContext,rootElement);
  if (_log.isInfoEnabled()) {
    _log.info("Exporting portlet took " + stopWatch.getTime() + " ms");
  }
  portletDataContext.clearScopedPrimaryKeys();
  try {
    portletDataContext.addZipEntry("/manifest.xml",document.formattedString());
  }
 catch (  IOException ioe) {
    throw new SystemException(ioe);
  }
  return zipWriter.getFile();
}
