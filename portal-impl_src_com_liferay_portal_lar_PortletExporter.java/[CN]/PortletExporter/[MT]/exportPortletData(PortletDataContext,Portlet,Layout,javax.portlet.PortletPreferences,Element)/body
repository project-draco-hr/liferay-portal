{
  PortletDataHandler portletDataHandler=portlet.getPortletDataHandlerInstance();
  if (portletDataHandler == null) {
    return;
  }
  String portletId=portlet.getPortletId();
  Group liveGroup=layout.getGroup();
  if (liveGroup.isStagingGroup()) {
    liveGroup=liveGroup.getLiveGroup();
  }
  boolean staged=liveGroup.isStagedPortlet(portlet.getRootPortletId());
  if (!staged) {
    if (_log.isDebugEnabled()) {
      _log.debug("Not exporting data for " + portletId + " because it is configured not to be staged");
    }
    return;
  }
  if (_log.isDebugEnabled()) {
    _log.debug("Exporting data for " + portletId);
  }
  StringBundler sb=new StringBundler(4);
  sb.append(context.getPortletPath(portletId));
  sb.append(StringPool.SLASH);
  if (portlet.isPreferencesUniquePerLayout()) {
    sb.append(layout.getPlid());
  }
 else {
    sb.append(context.getScopeGroupId());
  }
  sb.append("/portlet-data.xml");
  String path=sb.toString();
  if (!context.isPathNotProcessed(path)) {
    return;
  }
  long lastPublishDate=GetterUtil.getLong(jxPreferences.getValue("last-publish-date",StringPool.BLANK));
  Date startDate=context.getStartDate();
  if ((lastPublishDate > 0) && (startDate != null) && (lastPublishDate < startDate.getTime())) {
    context.setStartDate(new Date(lastPublishDate));
  }
  String data=null;
  long groupId=context.getGroupId();
  context.setGroupId(context.getScopeGroupId());
  try {
    data=portletDataHandler.exportData(context,portletId,jxPreferences);
  }
 catch (  Exception e) {
    throw new SystemException(e);
  }
 finally {
    context.setGroupId(groupId);
    context.setStartDate(startDate);
  }
  if (Validator.isNull(data)) {
    if (_log.isDebugEnabled()) {
      _log.debug("Not exporting data for " + portletId + " because null data was returned");
    }
    return;
  }
  Element portletDataEl=parentEl.addElement("portlet-data");
  portletDataEl.addAttribute("path",path);
  context.addZipEntry(path,data);
  if (context.getEndDate() != null) {
    try {
      jxPreferences.setValue("last-publish-date",String.valueOf(context.getEndDate().getTime()));
      jxPreferences.store();
    }
 catch (    Exception e) {
      _log.error(e,e);
    }
  }
}
