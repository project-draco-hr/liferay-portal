{
  try {
    try {
      while (true) {
        int readyCount=selector.select();
        if (readyCount > 0) {
          Set<SelectionKey> selectionKeys=selector.selectedKeys();
          Iterator<SelectionKey> iterator=selectionKeys.iterator();
          while (iterator.hasNext()) {
            SelectionKey selectionKey=iterator.next();
            iterator.remove();
            try {
              if (selectionKey.isReadable()) {
                _processReading(selectionKey);
              }
              if (selectionKey.isWritable()) {
                _processWriting(selectionKey);
              }
            }
 catch (            CancelledKeyException cke) {
            }
          }
        }
 else         if (!selector.isOpen()) {
          break;
        }
        registerChannels();
        cleanUpTimeoutResponseWaitingDatagrams();
      }
    }
  finally {
      selector.close();
    }
  }
 catch (  ClosedSelectorException cse) {
    if (_log.isInfoEnabled()) {
      _log.info(Thread.currentThread().getName() + " exiting gracefully on Selector closure");
    }
  }
catch (  Throwable t) {
    _log.error(Thread.currentThread().getName() + " exiting exceptionally",t);
  }
  registerChannels();
  responseWaitingMap.clear();
  timeoutMap.clear();
}
