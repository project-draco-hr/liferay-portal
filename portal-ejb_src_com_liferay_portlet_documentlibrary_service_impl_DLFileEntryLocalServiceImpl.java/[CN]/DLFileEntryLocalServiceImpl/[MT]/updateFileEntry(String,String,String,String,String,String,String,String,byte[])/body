{
  User user=UserUtil.findByPrimaryKey(userId);
  DLFolder folder=DLFolderUtil.findByPrimaryKey(folderId);
  if (Validator.isNull(title)) {
    title=name;
  }
  DLFileEntry fileEntry=DLFileEntryUtil.findByPrimaryKey(new DLFileEntryPK(folderId,name));
  fileEntry.setTitle(title);
  fileEntry.setDescription(description);
  fileEntry.setExtraSettings(extraSettings);
  DLFileEntryUtil.update(fileEntry);
  if (Validator.isNotNull(newFolderId) && !folderId.equals(newFolderId)) {
    DLFolder newFolder=DLFolderUtil.findByPrimaryKey(newFolderId);
    if (!folder.getGroupId().equals(newFolder.getGroupId())) {
      throw new NoSuchFolderException();
    }
    try {
      DLLocalServiceUtil.getFileContentNode(user.getCompanyId(),newFolderId,name,0);
      throw new DuplicateFileException(name);
    }
 catch (    NoSuchFileException nsfe) {
    }
    DLFileEntry newFileEntry=DLFileEntryUtil.create(new DLFileEntryPK(newFolderId,name));
    newFileEntry.setCompanyId(fileEntry.getCompanyId());
    newFileEntry.setUserId(fileEntry.getUserId());
    newFileEntry.setUserName(fileEntry.getUserName());
    newFileEntry.setVersionUserId(fileEntry.getVersionUserId());
    newFileEntry.setVersionUserName(fileEntry.getVersionUserName());
    newFileEntry.setCreateDate(fileEntry.getCreateDate());
    newFileEntry.setModifiedDate(fileEntry.getModifiedDate());
    newFileEntry.setTitle(fileEntry.getTitle());
    newFileEntry.setDescription(fileEntry.getDescription());
    newFileEntry.setVersion(fileEntry.getVersion());
    newFileEntry.setSize(fileEntry.getSize());
    newFileEntry.setReadCount(fileEntry.getReadCount());
    newFileEntry.setExtraSettings(extraSettings);
    DLFileEntryUtil.update(newFileEntry);
    DLFileEntryUtil.remove(fileEntry);
    fileEntry=newFileEntry;
    Iterator itr=DLFileVersionUtil.findByF_N(folderId,name).iterator();
    while (itr.hasNext()) {
      DLFileVersion fileVersion=(DLFileVersion)itr.next();
      DLFileVersion newFileVersion=DLFileVersionUtil.create(new DLFileVersionPK(newFolderId,name,fileVersion.getVersion()));
      newFileVersion.setCompanyId(fileVersion.getCompanyId());
      newFileVersion.setUserId(fileVersion.getUserId());
      newFileVersion.setUserName(fileVersion.getUserName());
      newFileVersion.setCreateDate(fileVersion.getCreateDate());
      newFileVersion.setSize(fileVersion.getSize());
      DLFileVersionUtil.update(newFileVersion);
      DLFileVersionUtil.remove(fileVersion);
    }
    DLFileShortcutLocalServiceUtil.updateFileShortcuts(folderId,name,newFolderId,name);
    try {
      DLServiceUtil.updateFile(user.getCompanyId(),PortletKeys.DOCUMENT_LIBRARY,folder.getGroupId(),folderId,newFolderId,name);
    }
 catch (    RemoteException re) {
      throw new SystemException(re);
    }
    folderId=newFolderId;
    folder=newFolder;
  }
  if ((byteArray == null) || (byteArray.length == 0)) {
    return fileEntry;
  }
  double oldVersion=fileEntry.getVersion();
  double newVersion=MathUtil.format(oldVersion + 0.1,1,1);
  DLFileVersion fileVersion=DLFileVersionUtil.create(new DLFileVersionPK(folderId,name,oldVersion));
  String versionUserId=GetterUtil.getString(fileEntry.getVersionUserId(),fileEntry.getUserId());
  String versionUserName=GetterUtil.getString(fileEntry.getVersionUserName(),fileEntry.getUserName());
  fileVersion.setCompanyId(fileEntry.getCompanyId());
  fileVersion.setUserId(versionUserId);
  fileVersion.setUserName(versionUserName);
  fileVersion.setCreateDate(fileEntry.getModifiedDate());
  fileVersion.setSize(fileEntry.getSize());
  DLFileVersionUtil.update(fileVersion);
  fileEntry.setVersionUserId(user.getUserId());
  fileEntry.setVersionUserName(user.getFullName());
  fileEntry.setModifiedDate(new Date());
  fileEntry.setVersion(newVersion);
  fileEntry.setSize(byteArray.length);
  DLFileEntryUtil.update(fileEntry);
  try {
    DLServiceUtil.updateFile(user.getCompanyId(),PortletKeys.DOCUMENT_LIBRARY,folder.getGroupId(),folderId,name,newVersion,sourceFileName,byteArray);
  }
 catch (  RemoteException re) {
    throw new SystemException(re);
  }
  folder.setLastPostDate(fileEntry.getModifiedDate());
  DLFolderUtil.update(folder);
  return fileEntry;
}
