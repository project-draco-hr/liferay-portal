{
  User user=UserUtil.findByPrimaryKey(userId);
  folderId=getFolderId(user.getCompanyId(),folderId);
  DLFolder folder=DLFolderUtil.findByPrimaryKey(folderId);
  Date now=new Date();
  if (title.equals(StringPool.BLANK)) {
    title=name;
  }
  DLServiceUtil.addFile(user.getCompanyId(),PortletKeys.DOCUMENT_LIBRARY,folder.getGroupId(),folderId,name,byteArray);
  DLFileEntryPK pk=new DLFileEntryPK(folderId,name);
  DLFileEntry fileEntry=DLFileEntryUtil.create(pk);
  fileEntry.setCompanyId(user.getCompanyId());
  fileEntry.setUserId(user.getUserId());
  fileEntry.setUserName(user.getFullName());
  fileEntry.setVersionUserId(user.getUserId());
  fileEntry.setVersionUserName(user.getFullName());
  fileEntry.setCreateDate(now);
  fileEntry.setModifiedDate(now);
  fileEntry.setTitle(title);
  fileEntry.setDescription(description);
  fileEntry.setVersion(DLFileEntry.DEFAULT_VERSION);
  fileEntry.setSize(byteArray.length);
  fileEntry.setReadCount(DLFileEntry.DEFAULT_READ_COUNT);
  DLFileEntryUtil.update(fileEntry);
  addFileEntryResources(folder,fileEntry,addCommunityPermissions,addGuestPermissions);
  return fileEntry;
}
