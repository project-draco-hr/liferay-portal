{
  HttpSession session=request.getSession();
  Company company=PortalUtil.getCompany(request);
  long companyId=company.getCompanyId();
  String cdnHost=PortalUtil.getCDNHost(request);
  String dynamicResourcesCDNHost=StringPool.BLANK;
  boolean cdnDynamicResourceEnabled=PortalUtil.isCDNDynamicResourcesEnabled(request);
  if (cdnDynamicResourceEnabled) {
    dynamicResourcesCDNHost=cdnHost;
  }
  String portalURL=PortalUtil.getPortalURL(request);
  String contextPath=PortalUtil.getPathContext();
  String friendlyURLPrivateGroupPath=PortalUtil.getPathFriendlyURLPrivateGroup();
  String friendlyURLPrivateUserPath=PortalUtil.getPathFriendlyURLPrivateUser();
  String friendlyURLPublicPath=PortalUtil.getPathFriendlyURLPublic();
  String imagePath=dynamicResourcesCDNHost.concat(PortalUtil.getPathImage());
  String mainPath=PortalUtil.getPathMain();
  String i18nPath=(String)request.getAttribute(WebKeys.I18N_PATH);
  if (Validator.isNotNull(i18nPath)) {
    if (Validator.isNotNull(contextPath)) {
      String i18nContextPath=contextPath.concat(i18nPath);
      friendlyURLPrivateGroupPath=StringUtil.replaceFirst(friendlyURLPrivateGroupPath,contextPath,i18nContextPath);
      friendlyURLPrivateUserPath=StringUtil.replaceFirst(friendlyURLPrivateUserPath,contextPath,i18nContextPath);
      friendlyURLPublicPath=StringUtil.replaceFirst(friendlyURLPublicPath,contextPath,i18nContextPath);
      mainPath=StringUtil.replaceFirst(mainPath,contextPath,i18nContextPath);
    }
 else {
      friendlyURLPrivateGroupPath=i18nPath.concat(friendlyURLPrivateGroupPath);
      friendlyURLPrivateUserPath=i18nPath.concat(friendlyURLPrivateUserPath);
      friendlyURLPublicPath=i18nPath.concat(friendlyURLPublicPath);
      mainPath=i18nPath.concat(mainPath);
    }
  }
  StringBundler sb=new StringBundler(5);
  sb.append(imagePath);
  sb.append("/company_logo?img_id=");
  sb.append(company.getLogoId());
  sb.append("&t=");
  sb.append(WebServerServletTokenUtil.getToken(company.getLogoId()));
  String companyLogo=sb.toString();
  int companyLogoHeight=0;
  int companyLogoWidth=0;
  Image companyLogoImage=null;
  if (company.getLogoId() > 0) {
    companyLogoImage=ImageLocalServiceUtil.getCompanyLogo(company.getLogoId());
  }
 else {
    companyLogoImage=ImageToolUtil.getDefaultCompanyLogo();
  }
  if (companyLogoImage != null) {
    companyLogoHeight=companyLogoImage.getHeight();
    companyLogoWidth=companyLogoImage.getWidth();
  }
  String realCompanyLogo=companyLogo;
  int realCompanyLogoHeight=companyLogoHeight;
  int realCompanyLogoWidth=companyLogoWidth;
  User user=null;
  try {
    user=PortalUtil.initUser(request);
  }
 catch (  NoSuchUserException nsue) {
    return null;
  }
  boolean signedIn=!user.isDefaultUser();
  if (PropsValues.BROWSER_CACHE_DISABLED || (PropsValues.BROWSER_CACHE_SIGNED_IN_DISABLED && signedIn)) {
    response.setDateHeader(HttpHeaders.EXPIRES,0);
    response.setHeader(HttpHeaders.CACHE_CONTROL,HttpHeaders.CACHE_CONTROL_NO_CACHE_VALUE);
    response.setHeader(HttpHeaders.PRAGMA,HttpHeaders.PRAGMA_NO_CACHE_VALUE);
  }
  User realUser=user;
  Long realUserId=(Long)session.getAttribute(WebKeys.USER_ID);
  if (realUserId != null) {
    if (user.getUserId() != realUserId.longValue()) {
      realUser=UserLocalServiceUtil.getUserById(realUserId.longValue());
    }
  }
  String doAsUserId=ParamUtil.getString(request,"doAsUserId");
  String doAsUserLanguageId=ParamUtil.getString(request,"doAsUserLanguageId");
  long doAsGroupId=ParamUtil.getLong(request,"doAsGroupId");
  long refererGroupId=ParamUtil.getLong(request,"refererGroupId");
  long refererPlid=ParamUtil.getLong(request,"refererPlid");
  if (LayoutLocalServiceUtil.fetchLayout(refererPlid) == null) {
    refererPlid=0;
  }
  String controlPanelCategory=ParamUtil.getString(request,"controlPanelCategory");
  PermissionChecker permissionChecker=PermissionCheckerFactoryUtil.create(user);
  PermissionThreadLocal.setPermissionChecker(permissionChecker);
  String i18nLanguageId=(String)request.getAttribute(WebKeys.I18N_LANGUAGE_ID);
  Locale locale=PortalUtil.getLocale(request,response,true);
  try {
    CookieKeys.validateSupportCookie(request);
  }
 catch (  Exception e) {
    CookieKeys.addSupportCookie(request,response);
  }
  TimeZone timeZone=user.getTimeZone();
  if (timeZone == null) {
    timeZone=company.getTimeZone();
  }
  if (signedIn) {
    updateUserLayouts(user);
  }
  Layout layout=null;
  List<Layout> layouts=null;
  long plid=ParamUtil.getLong(request,"p_l_id");
  if (plid > 0) {
    layout=LayoutLocalServiceUtil.getLayout(plid);
    long sourceGroupId=ParamUtil.getLong(request,"p_v_l_s_g_id");
    if ((sourceGroupId > 0) && (sourceGroupId != layout.getGroupId())) {
      Group sourceGroup=GroupLocalServiceUtil.getGroup(sourceGroupId);
      if (layout.isPublicLayout() || SitesUtil.isUserGroupLayoutSetViewable(permissionChecker,layout.getGroup())) {
        layout=new VirtualLayout(layout,sourceGroup);
      }
 else {
        layout=null;
      }
    }
  }
 else {
    long groupId=ParamUtil.getLong(request,"groupId");
    boolean privateLayout=ParamUtil.getBoolean(request,"privateLayout");
    long layoutId=ParamUtil.getLong(request,"layoutId");
    if ((groupId > 0) && (layoutId > 0)) {
      layout=LayoutLocalServiceUtil.getLayout(groupId,privateLayout,layoutId);
    }
  }
  String ppid=ParamUtil.getString(request,"p_p_id");
  Boolean redirectToDefaultLayout=(Boolean)request.getAttribute(WebKeys.REDIRECT_TO_DEFAULT_LAYOUT);
  if (redirectToDefaultLayout == null) {
    redirectToDefaultLayout=Boolean.FALSE;
  }
  if (layout != null) {
    Group group=layout.getGroup();
    if (!signedIn && PropsValues.AUTH_FORWARD_BY_REDIRECT) {
      request.setAttribute(WebKeys.REQUESTED_LAYOUT,layout);
    }
    if (Validator.isNull(controlPanelCategory) && Validator.isNotNull(ppid) && (LiferayWindowState.isPopUp(request) || LiferayWindowState.isExclusive(request))) {
      controlPanelCategory=PortletCategoryKeys.PORTLET;
    }
 else     if (Validator.isNotNull(ppid)) {
      Portlet portlet=PortletLocalServiceUtil.getPortletById(companyId,ppid);
      String portletControlPanelEntryCategory=portlet.getControlPanelEntryCategory();
      if (!controlPanelCategory.startsWith(PortletCategoryKeys.CURRENT_SITE) && portletControlPanelEntryCategory.startsWith(PortletCategoryKeys.SITE_ADMINISTRATION)) {
        portletControlPanelEntryCategory=PortletCategoryKeys.SITES;
      }
      if (!controlPanelCategory.startsWith(PortletCategoryKeys.CURRENT_SITE) && Validator.isNotNull(portletControlPanelEntryCategory)) {
        controlPanelCategory=portletControlPanelEntryCategory;
      }
    }
    boolean viewableGroup=hasAccessPermission(permissionChecker,layout,doAsGroupId,controlPanelCategory,true);
    boolean viewableStaging=!group.isControlPanel() && GroupPermissionUtil.contains(permissionChecker,group.getGroupId(),ActionKeys.VIEW_STAGING);
    if (viewableStaging) {
      layouts=LayoutLocalServiceUtil.getLayouts(layout.getGroupId(),layout.isPrivateLayout(),LayoutConstants.DEFAULT_PARENT_LAYOUT_ID);
    }
 else     if (!viewableGroup && group.isStagingGroup()) {
      layout=null;
    }
 else     if (!isLoginRequest(request) && (!viewableGroup || (!redirectToDefaultLayout && !hasAccessPermission(permissionChecker,layout,doAsGroupId,controlPanelCategory,false)))) {
      if (user.isDefaultUser() && PropsValues.AUTH_LOGIN_PROMPT_ENABLED) {
        throw new PrincipalException("User is not authenticated");
      }
      sb=new StringBundler(6);
      sb.append("User ");
      sb.append(user.getUserId());
      sb.append(" is not allowed to access the ");
      sb.append(layout.isPrivateLayout() ? "private" : "public");
      sb.append(" pages of group ");
      sb.append(layout.getGroupId());
      if (_log.isWarnEnabled()) {
        _log.warn(sb.toString());
      }
      throw new NoSuchLayoutException(sb.toString());
    }
 else     if (isLoginRequest(request) && !viewableGroup) {
      layout=null;
    }
 else     if (group.isLayoutPrototype()) {
      layouts=new ArrayList<Layout>();
    }
 else {
      layouts=LayoutLocalServiceUtil.getLayouts(layout.getGroupId(),layout.isPrivateLayout(),LayoutConstants.DEFAULT_PARENT_LAYOUT_ID);
      if (!group.isControlPanel()) {
        doAsGroupId=0;
      }
    }
  }
  List<Layout> unfilteredLayouts=layouts;
  if (layout == null) {
    Object[] defaultLayout=getDefaultLayout(request,user,signedIn);
    layout=(Layout)defaultLayout[0];
    layouts=(List<Layout>)defaultLayout[1];
    request.setAttribute(WebKeys.LAYOUT_DEFAULT,Boolean.TRUE);
  }
  Object[] viewableLayouts=getViewableLayouts(request,user,permissionChecker,layout,layouts,doAsGroupId,controlPanelCategory);
  String layoutSetLogo=null;
  layout=(Layout)viewableLayouts[0];
  layouts=(List<Layout>)viewableLayouts[1];
  Group group=null;
  if (layout != null) {
    group=layout.getGroup();
    if (!group.isControlPanel()) {
      rememberVisitedGroupIds(request,group.getGroupId());
    }
  }
  LayoutTypePortlet layoutTypePortlet=null;
  layouts=mergeAdditionalLayouts(request,user,permissionChecker,layout,layouts,doAsGroupId,controlPanelCategory);
  LayoutSet layoutSet=null;
  boolean hasCustomizeLayoutPermission=false;
  boolean hasUpdateLayoutPermission=false;
  boolean customizedView=SessionParamUtil.getBoolean(request,"customized_view",true);
  if (layout != null) {
    if (!layout.isTypeControlPanel()) {
      hasCustomizeLayoutPermission=LayoutPermissionUtil.contains(permissionChecker,layout,ActionKeys.CUSTOMIZE);
      hasUpdateLayoutPermission=LayoutPermissionUtil.contains(permissionChecker,layout,ActionKeys.UPDATE);
    }
    layoutSet=layout.getLayoutSet();
    if (company.isSiteLogo()) {
      long logoId=0;
      if (layoutSet.isLogo()) {
        logoId=layoutSet.getLogoId();
        if (logoId == 0) {
          logoId=layoutSet.getLiveLogoId();
        }
      }
 else {
        LayoutSet siblingLayoutSet=LayoutSetLocalServiceUtil.getLayoutSet(layout.getGroupId(),!layout.isPrivateLayout());
        if (siblingLayoutSet.isLogo()) {
          logoId=siblingLayoutSet.getLogoId();
        }
      }
      if (logoId > 0) {
        sb=new StringBundler(5);
        sb.append(imagePath);
        sb.append("/layout_set_logo?img_id=");
        sb.append(logoId);
        sb.append("&t=");
        sb.append(WebServerServletTokenUtil.getToken(logoId));
        layoutSetLogo=sb.toString();
        Image layoutSetLogoImage=ImageLocalServiceUtil.getCompanyLogo(logoId);
        companyLogo=layoutSetLogo;
        companyLogoHeight=layoutSetLogoImage.getHeight();
        companyLogoWidth=layoutSetLogoImage.getWidth();
      }
    }
    plid=layout.getPlid();
    layout=(Layout)layout.clone();
    layoutTypePortlet=(LayoutTypePortlet)layout.getLayoutType();
    boolean customizable=layoutTypePortlet.isCustomizable();
    if (!customizable || (group.isLayoutPrototype() || group.isLayoutSetPrototype())) {
      customizedView=false;
    }
    layoutTypePortlet.setCustomizedView(customizedView);
    layoutTypePortlet.setUpdatePermission(hasUpdateLayoutPermission);
    if (signedIn && customizable && customizedView&& hasCustomizeLayoutPermission) {
      PortalPreferences portalPreferences=PortletPreferencesFactoryUtil.getPortalPreferences(companyId,user.getUserId(),true);
      layoutTypePortlet.setPortalPreferences(portalPreferences);
    }
    LayoutClone layoutClone=LayoutCloneFactory.getInstance();
    if (layoutClone != null) {
      String typeSettings=layoutClone.get(request,plid);
      if (typeSettings != null) {
        UnicodeProperties typeSettingsProperties=new UnicodeProperties(true);
        typeSettingsProperties.load(typeSettings);
        String stateMax=typeSettingsProperties.getProperty(LayoutTypePortletConstants.STATE_MAX);
        String stateMin=typeSettingsProperties.getProperty(LayoutTypePortletConstants.STATE_MIN);
        String modeAbout=typeSettingsProperties.getProperty(LayoutTypePortletConstants.MODE_ABOUT);
        String modeConfig=typeSettingsProperties.getProperty(LayoutTypePortletConstants.MODE_CONFIG);
        String modeEdit=typeSettingsProperties.getProperty(LayoutTypePortletConstants.MODE_EDIT);
        String modeEditDefaults=typeSettingsProperties.getProperty(LayoutTypePortletConstants.MODE_EDIT_DEFAULTS);
        String modeEditGuest=typeSettingsProperties.getProperty(LayoutTypePortletConstants.MODE_EDIT_GUEST);
        String modeHelp=typeSettingsProperties.getProperty(LayoutTypePortletConstants.MODE_HELP);
        String modePreview=typeSettingsProperties.getProperty(LayoutTypePortletConstants.MODE_PREVIEW);
        String modePrint=typeSettingsProperties.getProperty(LayoutTypePortletConstants.MODE_PRINT);
        layoutTypePortlet.setStateMax(stateMax);
        layoutTypePortlet.setStateMin(stateMin);
        layoutTypePortlet.setModeAbout(modeAbout);
        layoutTypePortlet.setModeConfig(modeConfig);
        layoutTypePortlet.setModeEdit(modeEdit);
        layoutTypePortlet.setModeEditDefaults(modeEditDefaults);
        layoutTypePortlet.setModeEditGuest(modeEditGuest);
        layoutTypePortlet.setModeHelp(modeHelp);
        layoutTypePortlet.setModePreview(modePreview);
        layoutTypePortlet.setModePrint(modePrint);
      }
    }
    request.setAttribute(WebKeys.LAYOUT,layout);
    request.setAttribute(WebKeys.LAYOUTS,layouts);
  }
  long scopeGroupId=PortalUtil.getScopeGroupId(request);
  if ((scopeGroupId <= 0) && (doAsGroupId > 0)) {
    scopeGroupId=doAsGroupId;
  }
  long siteGroupId=PortalUtil.getSiteGroupId(scopeGroupId);
  Theme theme=null;
  ColorScheme colorScheme=null;
  boolean wapTheme=BrowserSnifferUtil.isWap(request);
  if ((layout != null) && group.isControlPanel()) {
    String themeId=PrefsPropsUtil.getString(companyId,PropsKeys.CONTROL_PANEL_LAYOUT_REGULAR_THEME_ID);
    String colorSchemeId=ColorSchemeFactoryUtil.getDefaultRegularColorSchemeId();
    theme=ThemeLocalServiceUtil.getTheme(companyId,themeId,wapTheme);
    colorScheme=ThemeLocalServiceUtil.getColorScheme(companyId,theme.getThemeId(),colorSchemeId,wapTheme);
    if (!wapTheme && theme.isWapTheme()) {
      theme=ThemeLocalServiceUtil.getTheme(companyId,PropsValues.CONTROL_PANEL_LAYOUT_REGULAR_THEME_ID,false);
      colorScheme=ThemeLocalServiceUtil.getColorScheme(companyId,theme.getThemeId(),colorSchemeId,false);
    }
    request.setAttribute(WebKeys.THEME,theme);
    request.setAttribute(WebKeys.COLOR_SCHEME,colorScheme);
  }
  boolean themeCssFastLoad=SessionParamUtil.getBoolean(request,"css_fast_load",PropsValues.THEME_CSS_FAST_LOAD);
  boolean themeImagesFastLoad=SessionParamUtil.getBoolean(request,"images_fast_load",PropsValues.THEME_IMAGES_FAST_LOAD);
  boolean themeJsBarebone=PropsValues.JAVASCRIPT_BAREBONE_ENABLED;
  if (themeJsBarebone) {
    if (signedIn) {
      themeJsBarebone=false;
    }
  }
  boolean themeJsFastLoad=SessionParamUtil.getBoolean(request,"js_fast_load",PropsValues.JAVASCRIPT_FAST_LOAD);
  String lifecycle=ParamUtil.getString(request,"p_p_lifecycle","0");
  lifecycle=ParamUtil.getString(request,"p_t_lifecycle",lifecycle);
  boolean isolated=ParamUtil.getBoolean(request,"p_p_isolated");
  String facebookCanvasPageURL=(String)request.getAttribute(WebKeys.FACEBOOK_CANVAS_PAGE_URL);
  boolean widget=false;
  Boolean widgetObj=(Boolean)request.getAttribute(WebKeys.WIDGET);
  if (widgetObj != null) {
    widget=widgetObj.booleanValue();
  }
  ThemeDisplay themeDisplay=ThemeDisplayFactory.create();
  themeDisplay.setRequest(request);
  themeDisplay.setCDNHost(cdnHost);
  themeDisplay.setCDNDynamicResourcesHost(dynamicResourcesCDNHost);
  themeDisplay.setPortalURL(portalURL);
  themeDisplay.setFacebookCanvasPageURL(facebookCanvasPageURL);
  themeDisplay.setWidget(widget);
  themeDisplay.setCompany(company);
  themeDisplay.setCompanyLogo(companyLogo);
  themeDisplay.setCompanyLogoHeight(companyLogoHeight);
  themeDisplay.setCompanyLogoWidth(companyLogoWidth);
  themeDisplay.setRealCompanyLogo(realCompanyLogo);
  themeDisplay.setRealCompanyLogoHeight(realCompanyLogoHeight);
  themeDisplay.setRealCompanyLogoWidth(realCompanyLogoWidth);
  themeDisplay.setUser(user);
  themeDisplay.setRealUser(realUser);
  themeDisplay.setDoAsUserId(doAsUserId);
  themeDisplay.setDoAsUserLanguageId(doAsUserLanguageId);
  themeDisplay.setDoAsGroupId(doAsGroupId);
  themeDisplay.setRefererGroupId(refererGroupId);
  themeDisplay.setRefererPlid(refererPlid);
  themeDisplay.setControlPanelCategory(controlPanelCategory);
  themeDisplay.setLayoutSet(layoutSet);
  themeDisplay.setLayoutSetLogo(layoutSetLogo);
  themeDisplay.setLayout(layout);
  themeDisplay.setLayouts(layouts);
  themeDisplay.setUnfilteredLayouts(unfilteredLayouts);
  themeDisplay.setPlid(plid);
  themeDisplay.setPpid(ppid);
  themeDisplay.setLayoutTypePortlet(layoutTypePortlet);
  themeDisplay.setScopeGroupId(scopeGroupId);
  themeDisplay.setSiteGroupId(siteGroupId);
  themeDisplay.setSignedIn(signedIn);
  themeDisplay.setPermissionChecker(permissionChecker);
  themeDisplay.setLocale(locale);
  themeDisplay.setLanguageId(LocaleUtil.toLanguageId(locale));
  themeDisplay.setI18nLanguageId(i18nLanguageId);
  themeDisplay.setI18nPath(i18nPath);
  themeDisplay.setTimeZone(timeZone);
  themeDisplay.setLookAndFeel(theme,colorScheme);
  themeDisplay.setThemeCssFastLoad(themeCssFastLoad);
  themeDisplay.setThemeImagesFastLoad(themeImagesFastLoad);
  themeDisplay.setThemeJsBarebone(themeJsBarebone);
  themeDisplay.setThemeJsFastLoad(themeJsFastLoad);
  themeDisplay.setServerName(request.getServerName());
  themeDisplay.setServerPort(request.getServerPort());
  themeDisplay.setSecure(request.isSecure());
  themeDisplay.setLifecycle(lifecycle);
  themeDisplay.setLifecycleAction(lifecycle.equals("1"));
  themeDisplay.setLifecycleEvent(lifecycle.equals("3"));
  themeDisplay.setLifecycleRender(lifecycle.equals("0"));
  themeDisplay.setLifecycleResource(lifecycle.equals("2"));
  themeDisplay.setStateExclusive(LiferayWindowState.isExclusive(request));
  themeDisplay.setStateMaximized(LiferayWindowState.isMaximized(request));
  themeDisplay.setStatePopUp(LiferayWindowState.isPopUp(request));
  themeDisplay.setIsolated(isolated);
  themeDisplay.setPathApplet(contextPath.concat("/applets"));
  themeDisplay.setPathCms(contextPath.concat("/cms"));
  themeDisplay.setPathContext(contextPath);
  themeDisplay.setPathFlash(contextPath.concat("/flash"));
  themeDisplay.setPathFriendlyURLPrivateGroup(friendlyURLPrivateGroupPath);
  themeDisplay.setPathFriendlyURLPrivateUser(friendlyURLPrivateUserPath);
  themeDisplay.setPathFriendlyURLPublic(friendlyURLPublicPath);
  themeDisplay.setPathImage(imagePath);
  themeDisplay.setPathJavaScript(contextPath.concat("/html/js"));
  themeDisplay.setPathMain(mainPath);
  themeDisplay.setPathSound(contextPath.concat("/html/sound"));
  themeDisplay.setShowAddContentIcon(false);
  boolean showControlPanelIcon=false;
  if (signedIn && PortalPermissionUtil.contains(permissionChecker,ActionKeys.VIEW_CONTROL_PANEL)) {
    showControlPanelIcon=true;
  }
  themeDisplay.setShowControlPanelIcon(showControlPanelIcon);
  themeDisplay.setShowHomeIcon(true);
  themeDisplay.setShowMyAccountIcon(signedIn);
  themeDisplay.setShowPageSettingsIcon(false);
  themeDisplay.setShowPortalIcon(true);
  themeDisplay.setShowSignInIcon(!signedIn);
  themeDisplay.setShowSignOutIcon(signedIn);
  themeDisplay.setShowStagingIcon(false);
  boolean showSiteAdministrationIcon=false;
  if (signedIn && GroupPermissionUtil.contains(permissionChecker,group,ActionKeys.VIEW_SITE_ADMINISTRATION)) {
    showSiteAdministrationIcon=true;
  }
  themeDisplay.setShowSiteAdministrationIcon(showSiteAdministrationIcon);
  if (PropsValues.SESSION_ENABLE_URL_WITH_SESSION_ID && !CookieKeys.hasSessionId(request)) {
    themeDisplay.setAddSessionIdToURL(true);
    themeDisplay.setSessionId(session.getId());
  }
  String urlControlPanel=friendlyURLPrivateGroupPath.concat(GroupConstants.CONTROL_PANEL_FRIENDLY_URL);
  if (Validator.isNotNull(doAsUserId)) {
    urlControlPanel=HttpUtil.addParameter(urlControlPanel,"doAsUserId",doAsUserId);
  }
  if (refererGroupId > 0) {
    urlControlPanel=HttpUtil.addParameter(urlControlPanel,"refererGroupId",refererGroupId);
  }
 else   if (scopeGroupId > 0) {
    Layout refererLayout=LayoutLocalServiceUtil.fetchLayout(plid);
    if (refererLayout != null) {
      Group refererLayoutGroup=refererLayout.getGroup();
      if (refererLayoutGroup.isUserGroup()) {
        urlControlPanel=HttpUtil.addParameter(urlControlPanel,"refererGroupId",scopeGroupId);
      }
    }
  }
  if (refererPlid > 0) {
    urlControlPanel=HttpUtil.addParameter(urlControlPanel,"refererPlid",refererPlid);
  }
 else   if (plid > 0) {
    urlControlPanel=HttpUtil.addParameter(urlControlPanel,"refererPlid",plid);
  }
  if (themeDisplay.isAddSessionIdToURL()) {
    urlControlPanel=PortalUtil.getURLWithSessionId(urlControlPanel,session.getId());
  }
  themeDisplay.setURLControlPanel(urlControlPanel);
  String currentURL=PortalUtil.getCurrentURL(request);
  themeDisplay.setURLCurrent(currentURL);
  String urlHome=PortalUtil.getHomeURL(request);
  themeDisplay.setURLHome(urlHome);
  String siteAdministrationURL=urlControlPanel;
  siteAdministrationURL=HttpUtil.addParameter(siteAdministrationURL,"controlPanelCategory",PortletCategoryKeys.CURRENT_SITE);
  siteAdministrationURL=HttpUtil.addParameter(siteAdministrationURL,"doAsGroupId",siteGroupId);
  themeDisplay.setURLSiteAdministration(siteAdministrationURL);
  long controlPanelPlid=PortalUtil.getControlPanelPlid(companyId);
  if (layout != null) {
    if (layout.isTypePortlet()) {
      boolean freeformLayout=layoutTypePortlet.getLayoutTemplateId().equals("freeform");
      themeDisplay.setFreeformLayout(freeformLayout);
      if (hasUpdateLayoutPermission) {
        themeDisplay.setShowAddContentIconPermission(true);
        if (!LiferayWindowState.isMaximized(request)) {
          themeDisplay.setShowAddContentIcon(true);
        }
        themeDisplay.setShowLayoutTemplatesIcon(true);
        if (!group.isUser()) {
          themeDisplay.setShowPageCustomizationIcon(true);
        }
        themeDisplay.setURLAddContent("Liferay.Dockbar.loadAddPanel();");
      }
      if (hasCustomizeLayoutPermission && customizedView) {
        themeDisplay.setShowAddContentIconPermission(true);
        if (!LiferayWindowState.isMaximized(request)) {
          themeDisplay.setShowAddContentIcon(true);
        }
        themeDisplay.setURLAddContent("Liferay.Dockbar.loadAddPanel();");
      }
    }
    if (hasUpdateLayoutPermission) {
      themeDisplay.setShowPageSettingsIcon(true);
      LiferayPortletURL pageSettingsURL=new PortletURLImpl(request,PortletKeys.LAYOUTS_ADMIN,controlPanelPlid,PortletRequest.RENDER_PHASE);
      pageSettingsURL.setDoAsGroupId(scopeGroupId);
      pageSettingsURL.setParameter("struts_action","/layouts_admin/edit_layouts");
      if (layout.isPrivateLayout()) {
        pageSettingsURL.setParameter("tabs1","private-pages");
      }
 else {
        pageSettingsURL.setParameter("tabs1","public-pages");
      }
      pageSettingsURL.setParameter("groupId",String.valueOf(scopeGroupId));
      pageSettingsURL.setParameter("selPlid",String.valueOf(plid));
      pageSettingsURL.setPortletMode(PortletMode.VIEW);
      if (PropsValues.DOCKBAR_ADMINISTRATIVE_LINKS_SHOW_IN_POP_UP) {
        pageSettingsURL.setControlPanelCategory(PortletCategoryKeys.PORTLET);
        pageSettingsURL.setParameter("closeRedirect",currentURL);
        pageSettingsURL.setWindowState(LiferayWindowState.POP_UP);
      }
 else {
        pageSettingsURL.setParameter("redirect",themeDisplay.getURLHome());
        pageSettingsURL.setPlid(plid);
        pageSettingsURL.setWindowState(WindowState.MAXIMIZED);
      }
      themeDisplay.setURLPageSettings(pageSettingsURL);
      boolean site=group.isSite();
      if (!site && group.isStagingGroup()) {
        Group liveGroup=group.getLiveGroup();
        site=liveGroup.isSite();
      }
      if (site && GroupPermissionUtil.contains(permissionChecker,scopeGroupId,ActionKeys.ASSIGN_MEMBERS)) {
        themeDisplay.setShowManageSiteMembershipsIcon(true);
        LiferayPortletURL manageSiteMembershipsURL=new PortletURLImpl(request,PortletKeys.SITE_MEMBERSHIPS_ADMIN,controlPanelPlid,PortletRequest.RENDER_PHASE);
        manageSiteMembershipsURL.setDoAsGroupId(scopeGroupId);
        manageSiteMembershipsURL.setParameter("struts_action","/sites_admin/edit_site_assignments");
        manageSiteMembershipsURL.setParameter("groupId",String.valueOf(scopeGroupId));
        manageSiteMembershipsURL.setParameter("selPlid",String.valueOf(plid));
        manageSiteMembershipsURL.setPortletMode(PortletMode.VIEW);
        if (PropsValues.DOCKBAR_ADMINISTRATIVE_LINKS_SHOW_IN_POP_UP) {
          manageSiteMembershipsURL.setControlPanelCategory(PortletCategoryKeys.PORTLET);
          manageSiteMembershipsURL.setWindowState(LiferayWindowState.POP_UP);
        }
 else {
          manageSiteMembershipsURL.setParameter("redirect",themeDisplay.getURLHome());
          manageSiteMembershipsURL.setParameter("showBackURL",Boolean.FALSE.toString());
          manageSiteMembershipsURL.setPlid(plid);
          manageSiteMembershipsURL.setWindowState(WindowState.MAXIMIZED);
        }
        themeDisplay.setURLManageSiteMemberships(manageSiteMembershipsURL);
      }
 else {
        themeDisplay.setShowManageSiteMembershipsIcon(false);
      }
    }
    boolean hasAddLayoutGroupPermission=GroupPermissionUtil.contains(permissionChecker,scopeGroupId,ActionKeys.ADD_LAYOUT);
    boolean hasAddLayoutLayoutPermission=!layout.isTypeControlPanel() && LayoutPermissionUtil.contains(permissionChecker,layout,ActionKeys.ADD_LAYOUT);
    boolean hasManageLayoutsGroupPermission=GroupPermissionUtil.contains(permissionChecker,scopeGroupId,ActionKeys.MANAGE_LAYOUTS);
    boolean hasManageStagingPermission=GroupPermissionUtil.contains(permissionChecker,scopeGroupId,ActionKeys.MANAGE_STAGING);
    boolean hasPublishStagingPermission=GroupPermissionUtil.contains(permissionChecker,scopeGroupId,ActionKeys.PUBLISH_STAGING);
    boolean hasUpdateGroupPermission=GroupPermissionUtil.contains(permissionChecker,scopeGroupId,ActionKeys.UPDATE);
    boolean hasViewStagingPermission=GroupPermissionUtil.contains(permissionChecker,scopeGroupId,ActionKeys.VIEW_STAGING);
    if (!group.isControlPanel() && !group.isUser() && !group.isUserGroup()&& hasUpdateGroupPermission) {
      themeDisplay.setShowSiteSettingsIcon(true);
      LiferayPortletURL siteSettingsURL=new PortletURLImpl(request,PortletKeys.SITE_SETTINGS,controlPanelPlid,PortletRequest.RENDER_PHASE);
      siteSettingsURL.setDoAsGroupId(scopeGroupId);
      siteSettingsURL.setParameter("struts_action","/sites_admin/edit_site");
      siteSettingsURL.setParameter("groupId",String.valueOf(scopeGroupId));
      siteSettingsURL.setParameter("showBackURL",Boolean.FALSE.toString());
      siteSettingsURL.setPortletMode(PortletMode.VIEW);
      if (PropsValues.DOCKBAR_ADMINISTRATIVE_LINKS_SHOW_IN_POP_UP) {
        siteSettingsURL.setControlPanelCategory(PortletCategoryKeys.PORTLET);
        siteSettingsURL.setParameter("closeRedirect",currentURL);
        siteSettingsURL.setWindowState(LiferayWindowState.POP_UP);
      }
 else {
        siteSettingsURL.setParameter("redirect",themeDisplay.getURLHome());
        siteSettingsURL.setPlid(plid);
        siteSettingsURL.setWindowState(LiferayWindowState.MAXIMIZED);
      }
      themeDisplay.setURLSiteSettings(siteSettingsURL);
    }
    if (!group.isLayoutPrototype() && (hasAddLayoutGroupPermission || hasAddLayoutLayoutPermission || hasManageLayoutsGroupPermission|| hasUpdateGroupPermission)) {
      themeDisplay.setShowSiteMapSettingsIcon(true);
      LiferayPortletURL siteMapSettingsURL=new PortletURLImpl(request,PortletKeys.LAYOUTS_ADMIN,controlPanelPlid,PortletRequest.RENDER_PHASE);
      siteMapSettingsURL.setDoAsGroupId(scopeGroupId);
      siteMapSettingsURL.setParameter("struts_action","/layouts_admin/edit_layouts");
      if (layout.isPrivateLayout()) {
        siteMapSettingsURL.setParameter("tabs1","private-pages");
      }
 else {
        siteMapSettingsURL.setParameter("tabs1","public-pages");
      }
      siteMapSettingsURL.setParameter("groupId",String.valueOf(scopeGroupId));
      siteMapSettingsURL.setPortletMode(PortletMode.VIEW);
      if (PropsValues.DOCKBAR_ADMINISTRATIVE_LINKS_SHOW_IN_POP_UP) {
        siteMapSettingsURL.setControlPanelCategory(PortletCategoryKeys.PORTLET);
        siteMapSettingsURL.setParameter("closeRedirect",currentURL);
        siteMapSettingsURL.setWindowState(LiferayWindowState.POP_UP);
      }
 else {
        siteMapSettingsURL.setParameter("redirect",themeDisplay.getURLHome());
        siteMapSettingsURL.setPlid(plid);
        siteMapSettingsURL.setWindowState(LiferayWindowState.MAXIMIZED);
      }
      themeDisplay.setURLSiteMapSettings(siteMapSettingsURL);
    }
    if (group.hasStagingGroup() && !group.isStagingGroup()) {
      themeDisplay.setShowAddContentIcon(false);
      themeDisplay.setShowLayoutTemplatesIcon(false);
      themeDisplay.setShowPageSettingsIcon(false);
      themeDisplay.setURLPublishToLive(null);
    }
    if (group.isControlPanel()) {
      themeDisplay.setShowPageSettingsIcon(false);
      themeDisplay.setURLPublishToLive(null);
    }
    if (group.isStaged() || group.isStagingGroup()) {
      if (hasManageStagingPermission || hasPublishStagingPermission || hasUpdateLayoutPermission|| hasViewStagingPermission) {
        themeDisplay.setShowStagingIcon(true);
      }
      if (hasPublishStagingPermission) {
        PortletURL publishToLiveURL=new PortletURLImpl(request,PortletKeys.LAYOUTS_ADMIN,plid,PortletRequest.RENDER_PHASE);
        publishToLiveURL.setParameter("struts_action","/layouts_admin/publish_layouts");
        if (layout.isPrivateLayout()) {
          publishToLiveURL.setParameter("tabs1","private-pages");
        }
 else {
          publishToLiveURL.setParameter("tabs1","public-pages");
        }
        publishToLiveURL.setParameter("pagesRedirect",currentURL);
        publishToLiveURL.setParameter("groupId",String.valueOf(scopeGroupId));
        publishToLiveURL.setParameter("selPlid",String.valueOf(plid));
        publishToLiveURL.setPortletMode(PortletMode.VIEW);
        publishToLiveURL.setWindowState(LiferayWindowState.EXCLUSIVE);
        themeDisplay.setURLPublishToLive(publishToLiveURL);
      }
    }
    Portlet myAccountPortlet=PortalUtil.getFirstMyAccountPortlet(themeDisplay);
    if (myAccountPortlet != null) {
      PortletURLImpl myAccountURL=new PortletURLImpl(request,myAccountPortlet.getPortletName(),controlPanelPlid,PortletRequest.RENDER_PHASE);
      if (scopeGroupId > 0) {
        myAccountURL.setDoAsGroupId(scopeGroupId);
      }
      if (refererPlid > 0) {
        myAccountURL.setRefererPlid(refererPlid);
      }
 else {
        myAccountURL.setRefererPlid(plid);
      }
      myAccountURL.setWindowState(WindowState.MAXIMIZED);
      themeDisplay.setURLMyAccount(myAccountURL);
    }
  }
  if (!user.isActive() || (PrefsPropsUtil.getBoolean(companyId,PropsKeys.TERMS_OF_USE_REQUIRED) && !user.isAgreedToTermsOfUse())) {
    themeDisplay.setShowAddContentIcon(false);
    themeDisplay.setShowMyAccountIcon(false);
    themeDisplay.setShowPageSettingsIcon(false);
  }
  if (layout.isLayoutPrototypeLinkActive()) {
    themeDisplay.setShowPageCustomizationIcon(false);
  }
  if (group.isLayoutPrototype()) {
    themeDisplay.setShowHomeIcon(false);
    themeDisplay.setShowManageSiteMembershipsIcon(false);
    themeDisplay.setShowMyAccountIcon(false);
    themeDisplay.setShowPageCustomizationIcon(false);
    themeDisplay.setShowPageSettingsIcon(true);
    themeDisplay.setShowPortalIcon(false);
    themeDisplay.setShowSignInIcon(false);
    themeDisplay.setShowSignOutIcon(false);
    themeDisplay.setShowSiteAdministrationIcon(false);
    themeDisplay.setShowSiteSettingsIcon(false);
    themeDisplay.setShowStagingIcon(false);
  }
  if (group.isLayoutSetPrototype()) {
    themeDisplay.setShowPageCustomizationIcon(false);
    themeDisplay.setShowSiteSettingsIcon(false);
  }
  if (group.hasStagingGroup() && !group.isStagingGroup()) {
    themeDisplay.setShowLayoutTemplatesIcon(false);
    themeDisplay.setShowPageCustomizationIcon(false);
    themeDisplay.setShowPageSettingsIcon(false);
    themeDisplay.setShowSiteMapSettingsIcon(false);
    themeDisplay.setShowSiteSettingsIcon(false);
  }
  themeDisplay.setURLPortal(portalURL.concat(contextPath));
  String urlSignIn=mainPath.concat(_PATH_PORTAL_LOGIN);
  if (layout != null) {
    urlSignIn=HttpUtil.addParameter(urlSignIn,"p_l_id",layout.getPlid());
  }
  themeDisplay.setURLSignIn(urlSignIn);
  themeDisplay.setURLSignOut(mainPath.concat(_PATH_PORTAL_LOGOUT));
  PortletURL updateManagerURL=new PortletURLImpl(request,PortletKeys.MARKETPLACE_STORE,controlPanelPlid,PortletRequest.RENDER_PHASE);
  themeDisplay.setURLUpdateManager(updateManagerURL);
  return themeDisplay;
}
