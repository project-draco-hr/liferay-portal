{
  ThemeDisplay themeDisplay=initThemeDisplay(request,response);
  if (themeDisplay == null) {
    return;
  }
  request.setAttribute(WebKeys.THEME_DISPLAY,themeDisplay);
  ServiceContext serviceContext=ServiceContextFactory.getInstance(request);
  ServiceContextThreadLocal.pushServiceContext(serviceContext);
  boolean parallelRenderEnable=true;
  Layout layout=themeDisplay.getLayout();
  if (layout != null) {
    LayoutTypePortlet layoutTypePortlet=themeDisplay.getLayoutTypePortlet();
    List<String> portletIds=layoutTypePortlet.getPortletIds();
    if (portletIds.size() == 1) {
      String portletId=portletIds.get(0);
      Portlet portlet=PortletLocalServiceUtil.getPortletById(portletId);
      if ((portlet != null) && !portlet.isAjaxable()) {
        parallelRenderEnable=false;
      }
    }
  }
  Boolean parallelRenderEnableObj=Boolean.valueOf(ParamUtil.getBoolean(request,"p_p_parallel",parallelRenderEnable));
  request.setAttribute(WebKeys.PORTLET_PARALLEL_RENDER,parallelRenderEnableObj);
  long mainJournalArticleId=ParamUtil.getLong(request,"p_j_a_id");
  if (mainJournalArticleId > 0) {
    try {
      JournalArticle mainJournalArticle=JournalArticleServiceUtil.getArticle(mainJournalArticleId);
      AssetEntry layoutAssetEntry=AssetEntryLocalServiceUtil.getEntry(JournalArticle.class.getName(),mainJournalArticle.getResourcePrimKey());
      request.setAttribute(WebKeys.LAYOUT_ASSET_ENTRY,layoutAssetEntry);
    }
 catch (    NoSuchArticleException nsae) {
      if (_log.isWarnEnabled()) {
        _log.warn(nsae.getMessage());
      }
    }
  }
}
