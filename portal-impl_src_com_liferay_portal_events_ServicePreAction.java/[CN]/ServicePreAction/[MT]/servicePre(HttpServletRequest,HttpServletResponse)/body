{
  ThemeDisplay themeDisplay=initThemeDisplay(request,response);
  if (themeDisplay == null) {
    return;
  }
  request.setAttribute(WebKeys.THEME_DISPLAY,themeDisplay);
  processControlPanelRedirects(request,response);
  ServiceContext serviceContext=ServiceContextFactory.getInstance(request);
  ServiceContextThreadLocal.pushServiceContext(serviceContext);
  if (PropsValues.LAYOUT_AJAX_RENDER_ENABLE) {
    boolean portletAjaxRender=ParamUtil.getBoolean(request,"p_p_ajax",true);
    request.setAttribute(WebKeys.PORTLET_AJAX_RENDER,portletAjaxRender);
  }
  if (PropsValues.LAYOUT_PARALLEL_RENDER_ENABLE && ServerDetector.isTomcat()) {
    boolean portletParallelRender=ParamUtil.getBoolean(request,"p_p_parallel",true);
    request.setAttribute(WebKeys.PORTLET_PARALLEL_RENDER,portletParallelRender);
  }
}
