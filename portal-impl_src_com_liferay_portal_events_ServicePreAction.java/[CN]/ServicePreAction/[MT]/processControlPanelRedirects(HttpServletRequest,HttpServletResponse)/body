{
  PermissionChecker permissionChecker=PermissionThreadLocal.getPermissionChecker();
  ThemeDisplay themeDisplay=(ThemeDisplay)request.getAttribute(WebKeys.THEME_DISPLAY);
  Layout layout=themeDisplay.getLayout();
  if (layout == null) {
    return;
  }
  Group group=layout.getGroup();
  String controlPanelCategory=themeDisplay.getControlPanelCategory();
  String ppid=themeDisplay.getPpid();
  long scopeGroupId=themeDisplay.getScopeGroupId();
  String currentURL=themeDisplay.getURLCurrent();
  if (group.isControlPanel() && Validator.isNotNull(ppid)) {
    boolean switchGroup=ParamUtil.getBoolean(request,"switchGroup");
    if (switchGroup && !PortletPermissionUtil.hasControlPanelAccessPermission(permissionChecker,scopeGroupId,ppid)) {
      String redirect=HttpUtil.removeParameter(currentURL,"p_p_id");
      response.sendRedirect(redirect);
    }
  }
 else   if (group.isControlPanel() && Validator.isNull(ppid)) {
    if (Validator.isNull(controlPanelCategory)) {
      Map<String,List<Portlet>> categoriesMap=PortalUtil.getControlPanelCategoriesMap(request);
      if (categoriesMap.size() == 1) {
        for (        String curCategory : categoriesMap.keySet()) {
          List<Portlet> categoryPortlets=categoriesMap.get(curCategory);
          if (categoryPortlets.size() == 1) {
            Portlet firstPortlet=categoryPortlets.get(0);
            PortletURL redirectURL=PortalUtil.getSiteAdministrationURL(request,themeDisplay,firstPortlet.getPortletId());
            response.sendRedirect(redirectURL.toString());
          }
        }
      }
    }
    if (controlPanelCategory.startsWith(PortletCategoryKeys.CURRENT_SITE)) {
      if (controlPanelCategory.indexOf(StringPool.PERIOD) == -1) {
        controlPanelCategory=StringUtil.replace(controlPanelCategory,PortletCategoryKeys.CURRENT_SITE,PortletCategoryKeys.SITE_ADMINISTRATION);
      }
 else {
        controlPanelCategory=StringUtil.replace(controlPanelCategory,PortletCategoryKeys.CURRENT_SITE + StringPool.PERIOD,PortletCategoryKeys.SITE_ADMINISTRATION);
      }
    }
    if (controlPanelCategory.equals(PortletCategoryKeys.SITE_ADMINISTRATION)) {
      Portlet firstPortlet=PortalUtil.getFirstSiteAdministrationPortlet(themeDisplay);
      String redirect=HttpUtil.setParameter(currentURL,"p_p_id",firstPortlet.getPortletId());
      response.sendRedirect(PortalUtil.getAbsoluteURL(request,redirect));
    }
 else {
      List<Portlet> portlets=PortalUtil.getControlPanelPortlets(controlPanelCategory,themeDisplay);
      Portlet firstPortlet=null;
      for (      Portlet portlet : portlets) {
        if (PortletPermissionUtil.hasControlPanelAccessPermission(permissionChecker,scopeGroupId,portlet)) {
          firstPortlet=portlet;
          break;
        }
      }
      if ((firstPortlet == null) && controlPanelCategory.startsWith(PortletCategoryKeys.SITE_ADMINISTRATION)) {
        firstPortlet=PortalUtil.getFirstSiteAdministrationPortlet(themeDisplay);
      }
      if (firstPortlet != null) {
        String redirect=HttpUtil.setParameter(currentURL,"p_p_id",firstPortlet.getPortletId());
        response.sendRedirect(PortalUtil.getAbsoluteURL(request,redirect));
      }
    }
  }
}
