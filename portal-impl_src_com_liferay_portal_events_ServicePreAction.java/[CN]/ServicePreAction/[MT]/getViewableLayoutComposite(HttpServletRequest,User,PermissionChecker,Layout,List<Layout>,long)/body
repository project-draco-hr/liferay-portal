{
  if ((layouts == null) || layouts.isEmpty()) {
    return new LayoutComposite(layout,layouts);
  }
  Group group=layout.getGroup();
  boolean hasViewLayoutPermission=false;
  boolean hasViewStagingPermission=(group.isStagingGroup() || group.isStagedRemotely()) && !group.isControlPanel() && GroupPermissionUtil.contains(permissionChecker,group,ActionKeys.VIEW_STAGING);
  if (hasAccessPermission(permissionChecker,layout,doAsGroupId,false) || hasViewStagingPermission) {
    hasViewLayoutPermission=true;
  }
  List<Layout> accessibleLayouts=new ArrayList<>();
  for (int i=0; i < layouts.size(); i++) {
    Layout curLayout=layouts.get(i);
    if (!curLayout.isHidden() && (hasAccessPermission(permissionChecker,curLayout,doAsGroupId,false) || hasViewStagingPermission)) {
      if (accessibleLayouts.isEmpty() && !hasViewLayoutPermission) {
        layout=curLayout;
      }
      accessibleLayouts.add(curLayout);
    }
  }
  if (accessibleLayouts.isEmpty()) {
    layouts=null;
    if (!isLoginRequest(request) && !hasViewLayoutPermission) {
      if (user.isDefaultUser() && PropsValues.AUTH_LOGIN_PROMPT_ENABLED) {
        throw new PrincipalException.MustBeAuthenticated(String.valueOf(user.getUserId()));
      }
      SessionErrors.add(request,LayoutPermissionException.class.getName());
    }
  }
 else {
    layouts=accessibleLayouts;
  }
  return new LayoutComposite(layout,layouts);
}
