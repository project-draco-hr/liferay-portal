{
  if (layout.isTypeControlPanel()) {
    if (!permissionChecker.isSignedIn()) {
      return false;
    }
    if (controlPanelCategory.startsWith(PortletCategoryKeys.CURRENT_SITE) || controlPanelCategory.startsWith(PortletCategoryKeys.SITES)) {
      if (doAsGroupId <= 0) {
        doAsGroupId=layout.getGroupId();
      }
      Group group=GroupLocalServiceUtil.getGroup(doAsGroupId);
      if (group.isLayout()) {
        group=group.getParentGroup();
      }
      if (GroupPermissionUtil.contains(permissionChecker,group,ActionKeys.VIEW_SITE_ADMINISTRATION)) {
        return true;
      }
    }
 else     if (controlPanelCategory.equals(PortletCategoryKeys.MY) || controlPanelCategory.equals(PortletCategoryKeys.PORTLET)) {
      return true;
    }
    return PortalPermissionUtil.contains(permissionChecker,ActionKeys.VIEW_CONTROL_PANEL);
  }
  return LayoutPermissionUtil.contains(permissionChecker,layout,checkViewableGroup,ActionKeys.VIEW);
}
