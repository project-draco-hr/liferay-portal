{
  LayoutSet layoutSet=(LayoutSet)request.getAttribute(WebKeys.VIRTUAL_HOST_LAYOUT_SET);
  if (layoutSet != null) {
    List<Layout> layouts=LayoutLocalServiceUtil.getLayouts(layoutSet.getGroupId(),layoutSet.isPrivateLayout(),LayoutConstants.DEFAULT_PARENT_LAYOUT_ID);
    if (layouts.size() > 0) {
      Layout layout=layouts.get(0);
      return new Object[]{layout,layouts};
    }
  }
  Layout layout=null;
  List<Layout> layouts=null;
  if (signedIn) {
    Group userGroup=user.getGroup();
    layouts=LayoutLocalServiceUtil.getLayouts(userGroup.getGroupId(),true,LayoutConstants.DEFAULT_PARENT_LAYOUT_ID);
    if (layouts.size() == 0) {
      layouts=LayoutLocalServiceUtil.getLayouts(userGroup.getGroupId(),false,LayoutConstants.DEFAULT_PARENT_LAYOUT_ID);
    }
    if (layouts.size() > 0) {
      layout=layouts.get(0);
    }
    if (layout == null) {
      LinkedHashMap<String,Object> groupParams=new LinkedHashMap<String,Object>();
      groupParams.put("usersGroups",new Long(user.getUserId()));
      List<Group> groups=GroupLocalServiceUtil.search(user.getCompanyId(),null,null,groupParams,QueryUtil.ALL_POS,QueryUtil.ALL_POS);
      for (      Group group : groups) {
        layouts=LayoutLocalServiceUtil.getLayouts(group.getGroupId(),true,LayoutConstants.DEFAULT_PARENT_LAYOUT_ID);
        if (layouts.size() == 0) {
          layouts=LayoutLocalServiceUtil.getLayouts(group.getGroupId(),false,LayoutConstants.DEFAULT_PARENT_LAYOUT_ID);
        }
        if (layouts.size() > 0) {
          layout=layouts.get(0);
          break;
        }
      }
    }
  }
 else {
    Group guestGroup=GroupLocalServiceUtil.getGroup(user.getCompanyId(),GroupConstants.GUEST);
    layouts=LayoutLocalServiceUtil.getLayouts(guestGroup.getGroupId(),false,LayoutConstants.DEFAULT_PARENT_LAYOUT_ID);
    if (layouts.size() > 0) {
      layout=layouts.get(0);
    }
  }
  return new Object[]{layout,layouts};
}
