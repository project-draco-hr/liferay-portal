{
  try {
    ThemeDisplay themeDisplay=(ThemeDisplay)request.getAttribute(WebKeys.THEME_DISPLAY);
    int start=(startPage * itemsPerPage) - itemsPerPage;
    int end=startPage * itemsPerPage;
    Hits results=CompanyLocalServiceUtil.search(themeDisplay.getCompanyId(),userId,keywords,start,end);
    String[] queryTerms=results.getQueryTerms();
    int total=results.getLength();
    Object[] values=addSearchResults(queryTerms,keywords,startPage,itemsPerPage,total,start,"Liferay Portal Search: " + keywords,StringPool.BLANK,format,themeDisplay);
    com.liferay.portal.kernel.xml.Document doc=(com.liferay.portal.kernel.xml.Document)values[0];
    Element root=(Element)values[1];
    for (int i=0; i < results.getDocs().length; i++) {
      Document result=results.doc(i);
      String className=result.get(Field.ENTRY_CLASS_NAME);
      String portletId=PortletProviderUtil.getPortletId(className,PortletProvider.Action.VIEW);
      Portlet portlet=PortletLocalServiceUtil.getPortletById(themeDisplay.getCompanyId(),portletId);
      if (portlet == null) {
        continue;
      }
      String portletTitle=PortalUtil.getPortletTitle(portletId,themeDisplay.getUser());
      long resultGroupId=GetterUtil.getLong(result.get(Field.GROUP_ID));
      long resultScopeGroupId=GetterUtil.getLong(result.get(Field.SCOPE_GROUP_ID));
      if (resultScopeGroupId == 0) {
        resultScopeGroupId=themeDisplay.getScopeGroupId();
      }
      String entryClassName=GetterUtil.getString(result.get(Field.ENTRY_CLASS_NAME));
      long entryClassPK=GetterUtil.getLong(result.get(Field.ENTRY_CLASS_PK));
      String title=StringPool.BLANK;
      PortletURL portletURL=getPortletURL(request,portletId,resultScopeGroupId);
      String url=portletURL.toString();
      Date modifiedDate=result.getDate(Field.MODIFIED_DATE);
      String content=StringPool.BLANK;
      Indexer<?> indexer=IndexerRegistryUtil.getIndexer(entryClassName);
      if (indexer != null) {
        String snippet=result.get(Field.SNIPPET);
        Summary summary=indexer.getSummary(result,snippet,null,null);
        if (summary == null) {
          continue;
        }
        title=summary.getTitle();
        url=portletURL.toString();
        content=summary.getContent();
      }
      double score=results.score(i);
      addSearchResult(root,resultGroupId,resultScopeGroupId,entryClassName,entryClassPK,portletTitle + " " + CharPool.RAQUO+ " "+ title,url,modifiedDate,content,score,format);
    }
    if (_log.isDebugEnabled()) {
      _log.debug("Return\n" + doc.asXML());
    }
    return doc.asXML();
  }
 catch (  Exception e) {
    throw new SearchException(e);
  }
}
