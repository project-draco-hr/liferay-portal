{
  Hits hits=null;
  try {
    ThemeDisplay themeDisplay=(ThemeDisplay)req.getAttribute(WebKeys.THEME_DISPLAY);
    hits=CompanyLocalServiceUtil.search(themeDisplay.getCompanyId(),keywords,SearchEngineUtil.ALL_POS,SearchEngineUtil.ALL_POS);
    Object[] values=addSearchResults(keywords,startPage,itemsPerPage,hits,"Liferay Portal Search: " + keywords,SEARCH_PATH,themeDisplay);
    Hits results=(Hits)values[0];
    org.dom4j.Document doc=(org.dom4j.Document)values[1];
    Element root=(Element)values[2];
    for (int i=0; i < results.getLength(); i++) {
      Document result=results.doc(i);
      String portletId=result.get(Field.PORTLET_ID);
      Portlet portlet=PortletLocalServiceUtil.getPortletById(themeDisplay.getCompanyId(),portletId);
      if (portlet == null) {
        continue;
      }
      String portletTitle=PortalUtil.getPortletTitle(portletId,themeDisplay.getUser());
      long groupId=GetterUtil.getLong(result.get(Field.GROUP_ID));
      String title=StringPool.BLANK;
      PortletURL portletURL=getPortletURL(req,portletId,groupId);
      String url=portletURL.toString();
      Date modifedDate=DateTools.stringToDate(result.get(Field.MODIFIED));
      String content=StringPool.BLANK;
      if (Validator.isNotNull(portlet.getIndexerClass())) {
        Indexer indexer=(Indexer)InstancePool.get(portlet.getIndexerClass());
        DocumentSummary docSummary=indexer.getDocumentSummary(result,portletURL);
        title=docSummary.getTitle();
        url=portletURL.toString();
        content=docSummary.getContent();
        if (portlet.getPortletId().equals(PortletKeys.JOURNAL)) {
          url=getJournalURL(themeDisplay,groupId,result);
        }
      }
      double score=hits.score(i);
      addSearchResult(root,portletTitle + " &raquo; " + title,url,modifedDate,content,score);
    }
    if (_log.isDebugEnabled()) {
      _log.debug("Return\n" + doc.asXML());
    }
    return doc.asXML();
  }
 catch (  Exception e) {
    throw new SearchException(e);
  }
 finally {
    if (hits != null) {
      hits.closeSearcher();
    }
  }
}
