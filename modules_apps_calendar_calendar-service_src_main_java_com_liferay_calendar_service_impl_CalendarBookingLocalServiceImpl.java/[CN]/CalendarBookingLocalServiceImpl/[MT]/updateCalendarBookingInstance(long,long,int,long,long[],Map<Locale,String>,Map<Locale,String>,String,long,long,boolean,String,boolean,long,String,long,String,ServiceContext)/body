{
  CalendarBooking calendarBooking=calendarBookingPersistence.findByPrimaryKey(calendarBookingId);
  if ((instanceIndex == 0) && allFollowing) {
    return updateCalendarBooking(userId,calendarBookingId,calendarId,childCalendarIds,titleMap,descriptionMap,location,startTime,endTime,allDay,recurrence,firstReminder,firstReminderType,secondReminder,secondReminderType,serviceContext);
  }
  String oldRecurrence=calendarBooking.getRecurrence();
  deleteCalendarBookingInstance(calendarBooking,instanceIndex,allFollowing);
  if (allFollowing) {
    Recurrence recurrenceObj=RecurrenceSerializer.deserialize(recurrence);
    if (oldRecurrence.equals(recurrence) && (recurrenceObj.getCount() > 0)) {
      recurrenceObj.setCount(recurrenceObj.getCount() - instanceIndex);
      recurrence=RecurrenceSerializer.serialize(recurrenceObj);
    }
  }
 else {
    recurrence=StringPool.BLANK;
  }
  Map<Locale,String> updatedTitleMap=calendarBooking.getTitleMap();
  updatedTitleMap.putAll(titleMap);
  Map<Locale,String> updatedDescriptionMap=calendarBooking.getDescriptionMap();
  updatedDescriptionMap.putAll(descriptionMap);
  return addCalendarBooking(userId,calendarId,childCalendarIds,CalendarBookingConstants.PARENT_CALENDAR_BOOKING_ID_DEFAULT,updatedTitleMap,updatedDescriptionMap,location,startTime,endTime,allDay,recurrence,firstReminder,firstReminderType,secondReminder,secondReminderType,serviceContext);
}
