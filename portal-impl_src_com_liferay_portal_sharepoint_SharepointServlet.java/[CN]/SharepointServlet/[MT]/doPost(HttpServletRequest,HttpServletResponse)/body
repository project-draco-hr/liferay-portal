{
  try {
    String uri=request.getRequestURI();
    if (uri.equals("/_vti_bin/shtml.dll/_vti_rpc") || uri.equals("/sharepoint/_vti_bin/_vti_aut/author.dll")) {
      User user=(User)request.getSession().getAttribute(WebKeys.USER);
      SharepointRequest sharepointRequest=new SharepointRequest(request,response,user);
      Method method=MethodFactory.create(sharepointRequest);
      String rootPath=method.getRootPath(sharepointRequest);
      if (rootPath == null) {
        throw new SharepointException("Unabled to get root path");
      }
      if (_log.isInfoEnabled()) {
        _log.info("Original root path " + rootPath);
      }
      rootPath=SharepointUtil.stripService(rootPath,true);
      if (_log.isInfoEnabled()) {
        _log.info("Modified root path " + rootPath);
      }
      sharepointRequest.setRootPath(rootPath);
      SharepointStorage storage=SharepointUtil.getStorage(rootPath);
      sharepointRequest.setSharepointStorage(storage);
      if (_log.isInfoEnabled()) {
        _log.info(request.getHeader(HttpHeaders.USER_AGENT) + " " + method.getMethodName()+ " "+ uri+ " "+ rootPath);
      }
      method.process(sharepointRequest);
    }
 else {
      if (_log.isInfoEnabled()) {
        _log.info(request.getHeader(HttpHeaders.USER_AGENT) + " " + request.getMethod()+ " "+ uri);
      }
    }
  }
 catch (  SharepointException se) {
    _log.error(se,se);
  }
}
