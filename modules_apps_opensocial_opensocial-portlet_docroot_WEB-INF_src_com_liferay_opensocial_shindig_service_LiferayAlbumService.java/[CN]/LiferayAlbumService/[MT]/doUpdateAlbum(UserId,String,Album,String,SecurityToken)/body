{
  long userIdLong=GetterUtil.getLong(userId.getUserId(securityToken));
  User user=UserLocalServiceUtil.getUserById(userIdLong);
  if (!ShindigUtil.isValidUser(user)) {
    return;
  }
  Group group=user.getGroup();
  long groupIdLong=group.getGroupId();
  ServiceContext serviceContext=new ServiceContext();
  serviceContext.setAddGroupPermissions(true);
  serviceContext.setAddGuestPermissions(true);
  serviceContext.setExpandoBridgeAttributes(SerializerUtil.toExpandoAttributes(album,_ALBUM_FIELDS,user.getCompanyId(),DLFolder.class.getName()));
  serviceContext.setScopeGroupId(groupIdLong);
  if (albumId == null) {
    DLAppServiceUtil.addFolder(groupIdLong,DLFolderConstants.DEFAULT_PARENT_FOLDER_ID,album.getTitle(),album.getDescription(),serviceContext);
  }
 else {
    Folder folder=DLAppLocalServiceUtil.getFolder(GetterUtil.getLong(albumId));
    DLAppServiceUtil.updateFolder(folder.getFolderId(),album.getTitle(),album.getDescription(),serviceContext);
  }
}
