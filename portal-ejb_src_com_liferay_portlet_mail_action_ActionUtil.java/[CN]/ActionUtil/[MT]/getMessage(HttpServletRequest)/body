{
  String folderName=req.getParameter("folder_name");
  int msgNum=Integer.parseInt(req.getParameter("msg_num"));
  Folder folder=MailUtil.getFolder(req,folderName);
  PortletPreferences prefs=PortalUtil.getPreferences(req);
  Message[] messages=folder.getMessages();
  MailUtil.sort(folder.getName(),messages,prefs);
  int msgIndex=0;
  try {
    msgIndex=Integer.parseInt(req.getParameter("msg_i"));
  }
 catch (  NumberFormatException nfe) {
    for (int i=0; i < messages.length; i++) {
      if (messages[i].getMessageNumber() == msgNum) {
        msgIndex=i;
        break;
      }
    }
  }
  int messageCount=folder.getMessageCount();
  if (messageCount <= 1) {
    req.setAttribute("next_msg_num_after_delete","-1");
  }
 else   if (msgIndex == 0) {
    req.setAttribute("msg_next",Integer.toString(messages[1].getMessageNumber()));
    int msgNextNum=messages[1].getMessageNumber() - 1;
    if (messages[0].getMessageNumber() > messages[1].getMessageNumber()) {
      msgNextNum++;
    }
    req.setAttribute("next_msg_num_after_delete",Integer.toString(msgNextNum));
  }
 else   if (msgIndex == (messageCount - 1)) {
    req.setAttribute("msg_previous",Integer.toString(messages[msgIndex - 1].getMessageNumber()));
    int msgNextNum=messages[msgIndex - 1].getMessageNumber() - 1;
    if (messages[msgIndex].getMessageNumber() > messages[msgIndex - 1].getMessageNumber()) {
      msgNextNum++;
    }
    req.setAttribute("next_msg_num_after_delete",Integer.toString(msgNextNum));
  }
 else {
    req.setAttribute("msg_previous",Integer.toString(messages[msgIndex - 1].getMessageNumber()));
    req.setAttribute("msg_next",Integer.toString(messages[msgIndex + 1].getMessageNumber()));
    int msgNextNum=messages[msgIndex + 1].getMessageNumber() - 1;
    if (messages[msgIndex].getMessageNumber() > messages[msgIndex + 1].getMessageNumber()) {
      msgNextNum++;
    }
    req.setAttribute("next_msg_num_after_delete",Integer.toString(msgNextNum));
  }
  req.setAttribute(WebKeys.MAIL_MESSAGE,folder.getMessage(msgNum));
  int messagesPerPage=GetterUtil.getInteger(prefs.getValue("messages-per-page",StringPool.BLANK));
  int msgDiv=(int)Math.ceil(msgIndex / messagesPerPage);
  msgDiv++;
  req.setAttribute(WebKeys.MAIL_MESSAGE_DIV,Integer.toString(msgDiv));
}
