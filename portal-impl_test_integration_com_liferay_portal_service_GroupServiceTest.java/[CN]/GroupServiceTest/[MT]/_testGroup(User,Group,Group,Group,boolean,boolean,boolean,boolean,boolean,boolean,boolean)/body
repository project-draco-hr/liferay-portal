{
  if (group1 == null) {
    group1=ServiceTestUtil.addGroup("Example1");
  }
  if (group11 == null) {
    group11=ServiceTestUtil.addGroup(group1.getGroupId(),"Example11");
  }
  if (group111 == null) {
    group111=ServiceTestUtil.addGroup(group11.getGroupId(),"Example111");
  }
  PermissionChecker permissionChecker=PermissionCheckerFactoryUtil.create(user);
  PermissionThreadLocal.setPermissionChecker(permissionChecker);
  ServiceContext serviceContext=ServiceTestUtil.getServiceContext();
  serviceContext.setScopeGroupId(group1.getGroupId());
  serviceContext.setUserId(user.getUserId());
  if (addGroup) {
    try {
      _addGroup("Test 2",GroupConstants.DEFAULT_PARENT_GROUP_ID,serviceContext);
      Assert.fail("The user should not be able to add top level sites");
    }
 catch (    PrincipalException pe) {
    }
    try {
      _addGroup("Test 1.2",group1.getGroupId(),serviceContext);
      if (!hasManageSubsitePermisionOnGroup1 && !hasManageSite1) {
        Assert.fail("The user should not be able to add this site");
      }
    }
 catch (    PrincipalException pe) {
      if (hasManageSubsitePermisionOnGroup1 || hasManageSite1) {
        Assert.fail("The user should be able to add this site");
      }
    }
    try {
      _addGroup("Test 1.1.2",group11.getGroupId(),serviceContext);
      if (!hasManageSubsitePermisionOnGroup11 && !hasManageSite1) {
        Assert.fail("The user should not be able to add this site");
      }
    }
 catch (    PrincipalException pe) {
      if (hasManageSubsitePermisionOnGroup11 || hasManageSite1) {
        Assert.fail("The user should be able to add this site");
      }
    }
    try {
      _addGroup("Test 1.1.1.2",group111.getGroupId(),serviceContext);
      if (!hasManageSubsitePermisionOnGroup111 && !hasManageSite1) {
        Assert.fail("The user should not be able to add this site");
      }
    }
 catch (    PrincipalException pe) {
      if (hasManageSubsitePermisionOnGroup111 || hasManageSite1) {
        Assert.fail("The user should be able to add this site");
      }
    }
  }
  if (updateGroup) {
    try {
      GroupServiceUtil.updateGroup(group1.getGroupId(),"");
      if (!hasManageSite1) {
        Assert.fail("The user should not be able to update this site");
      }
    }
 catch (    PrincipalException pe) {
      if (hasManageSite1) {
        Assert.fail("The user should be able to update this site");
      }
    }
    try {
      GroupServiceUtil.updateGroup(group11.getGroupId(),"");
      if (!hasManageSubsitePermisionOnGroup1 && !hasManageSite1 && !hasManageSite11) {
        Assert.fail("The user should not be able to update this site");
      }
    }
 catch (    PrincipalException pe) {
      if (hasManageSubsitePermisionOnGroup1 || hasManageSite1 || hasManageSite11) {
        Assert.fail("The user should be able to update this site");
      }
    }
    try {
      GroupServiceUtil.updateGroup(group111.getGroupId(),"");
      if (!hasManageSubsitePermisionOnGroup11 && !hasManageSite1) {
        Assert.fail("The user should not be able to update this site");
      }
    }
 catch (    PrincipalException pe) {
      if (hasManageSubsitePermisionOnGroup1 || hasManageSite1) {
        Assert.fail("The user should be able to update this site");
      }
    }
  }
}
