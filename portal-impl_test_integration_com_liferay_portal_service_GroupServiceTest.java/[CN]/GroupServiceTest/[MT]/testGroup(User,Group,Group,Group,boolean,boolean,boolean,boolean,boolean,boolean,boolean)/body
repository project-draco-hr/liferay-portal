{
  if (group1 == null) {
    group1=GroupTestUtil.addGroup();
  }
  if (group11 == null) {
    group11=GroupTestUtil.addGroup(group1.getGroupId());
  }
  if (group111 == null) {
    group111=GroupTestUtil.addGroup(group11.getGroupId());
  }
  PermissionChecker permissionChecker=PermissionCheckerFactoryUtil.create(user);
  PermissionThreadLocal.setPermissionChecker(permissionChecker);
  ServiceContext serviceContext=ServiceContextTestUtil.getServiceContext(group1.getGroupId(),user.getUserId());
  if (addGroup) {
    try {
      GroupTestUtil.addGroup(GroupConstants.DEFAULT_PARENT_GROUP_ID,serviceContext);
      Assert.fail("The user should not be able to add top level sites");
    }
 catch (    PrincipalException pe) {
    }
    try {
      GroupTestUtil.addGroup(group1.getGroupId(),serviceContext);
      Assert.assertTrue("The user should not be able to add this site",hasManageSubsitePermisionOnGroup1 || hasManageSite1);
    }
 catch (    PrincipalException pe) {
      Assert.assertFalse("The user should be able to add this site",hasManageSubsitePermisionOnGroup1 || hasManageSite1);
    }
    try {
      GroupTestUtil.addGroup(group11.getGroupId(),serviceContext);
      Assert.assertTrue("The user should not be able to add this site",hasManageSubsitePermisionOnGroup11 || hasManageSite1);
    }
 catch (    PrincipalException pe) {
      Assert.assertFalse("The user should be able to add this site",hasManageSubsitePermisionOnGroup11 || hasManageSite1);
    }
    try {
      GroupTestUtil.addGroup(group111.getGroupId(),serviceContext);
      Assert.assertTrue("The user should not be able to add this site",hasManageSubsitePermisionOnGroup111 || hasManageSite1);
    }
 catch (    PrincipalException pe) {
      Assert.assertFalse("The user should be able to add this site",hasManageSubsitePermisionOnGroup111 || hasManageSite1);
    }
  }
  if (updateGroup) {
    try {
      GroupServiceUtil.updateGroup(group1.getGroupId(),"");
      Assert.assertTrue("The user should not be able to update this site",hasManageSite1);
    }
 catch (    PrincipalException pe) {
      Assert.assertFalse("The user should be able to update this site",hasManageSite1);
    }
    try {
      GroupServiceUtil.updateGroup(group11.getGroupId(),"");
      Assert.assertTrue("The user should not be able to update this site",hasManageSubsitePermisionOnGroup1 || hasManageSite1 || hasManageSite11);
    }
 catch (    PrincipalException pe) {
      Assert.assertFalse("The user should be able to update this site",hasManageSubsitePermisionOnGroup1 || hasManageSite1 || hasManageSite11);
    }
    try {
      GroupServiceUtil.updateGroup(group111.getGroupId(),"");
      Assert.assertTrue("The user should not be able to update this site",hasManageSubsitePermisionOnGroup11 || hasManageSite1);
    }
 catch (    PrincipalException pe) {
      Assert.assertFalse("The user should be able to update this site",hasManageSubsitePermisionOnGroup1 || hasManageSite1);
    }
  }
}
