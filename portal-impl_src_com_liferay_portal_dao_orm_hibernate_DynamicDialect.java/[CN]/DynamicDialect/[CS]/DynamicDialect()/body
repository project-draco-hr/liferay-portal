{
  Connection con=null;
  try {
    con=DataAccess.getConnection();
    DatabaseMetaData metaData=con.getMetaData();
    String dbName=metaData.getDatabaseProductName();
    int dbMajorVersion=metaData.getDatabaseMajorVersion();
    if (_log.isInfoEnabled()) {
      _log.info("Determining dialect for " + dbName + " "+ dbMajorVersion);
    }
    if (dbName.startsWith("HSQL")) {
      if (_log.isWarnEnabled()) {
        _log.warn("Liferay is configured to use Hypersonic as its " + "database. Do NOT use Hypersonic in production. " + "Hypersonic is an embedded database useful "+ "for development and demo'ing purposes.");
      }
    }
    if (dbName.equals("ASE") && (dbMajorVersion == 15)) {
      _dialect=new SybaseDialect();
    }
 else     if (dbName.startsWith("DB2") && (dbMajorVersion == 9)) {
      _dialect=new DB2Dialect();
    }
 else {
      _dialect=DialectFactory.determineDialect(dbName,dbMajorVersion);
    }
    DBUtil.setInstance(_dialect);
    if (_log.isInfoEnabled()) {
      _log.info("Using dialect " + _dialect.getClass().getName());
    }
  }
 catch (  Exception e) {
    String msg=GetterUtil.getString(e.getMessage());
    if (msg.indexOf("explicitly set for database: DB2") != -1) {
      _dialect=new DB2400Dialect();
      if (_log.isWarnEnabled()) {
        _log.warn("DB2400Dialect was dynamically chosen as the " + "Hibernate dialect for DB2. This can be " + "overriden in portal.properties");
      }
    }
 else {
      _log.error(e,e);
    }
  }
 finally {
    DataAccess.cleanUp(con);
  }
  if (_dialect == null) {
    throw new RuntimeException("No dialect found");
  }
  Properties dynamicDefaultProps=getDefaultProperties();
  Properties dialectDefaultProps=_dialect.getDefaultProperties();
  dynamicDefaultProps.clear();
  Enumeration<String> enu=(Enumeration<String>)dialectDefaultProps.propertyNames();
  while (enu.hasMoreElements()) {
    String key=enu.nextElement();
    String value=dialectDefaultProps.getProperty(key);
    dynamicDefaultProps.setProperty(key,value);
  }
}
