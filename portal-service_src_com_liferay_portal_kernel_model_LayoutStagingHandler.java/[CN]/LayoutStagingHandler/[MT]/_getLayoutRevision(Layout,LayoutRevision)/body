{
  if (layoutRevision != null) {
    return layoutRevision;
  }
  ServiceContext serviceContext=ServiceContextThreadLocal.getServiceContext();
  if ((serviceContext == null) || !serviceContext.isSignedIn()) {
    LayoutRevision lastLayoutRevision=null;
    lastLayoutRevision=LayoutRevisionLocalServiceUtil.fetchLastLayoutRevision(layout.getPlid(),true);
    if (lastLayoutRevision == null) {
      lastLayoutRevision=LayoutRevisionLocalServiceUtil.fetchLastLayoutRevision(layout.getPlid(),false);
    }
    return lastLayoutRevision;
  }
  User user=UserLocalServiceUtil.getUser(serviceContext.getUserId());
  long layoutSetBranchId=ParamUtil.getLong(serviceContext,"layoutSetBranchId");
  LayoutSet layoutSet=layout.getLayoutSet();
  LayoutSetBranch layoutSetBranch=LayoutSetBranchLocalServiceUtil.getUserLayoutSetBranch(serviceContext.getUserId(),layout.getGroupId(),layout.isPrivateLayout(),layoutSet.getLayoutSetId(),layoutSetBranchId);
  layoutSetBranchId=layoutSetBranch.getLayoutSetBranchId();
  long layoutRevisionId=ParamUtil.getLong(serviceContext,"layoutRevisionId");
  if (layoutRevisionId > 0) {
    layoutRevision=LayoutRevisionLocalServiceUtil.fetchLayoutRevision(layoutRevisionId);
  }
  if ((layoutRevisionId <= 0) || !_isBelongsToLayout(layoutRevision,layout)) {
    layoutRevisionId=StagingUtil.getRecentLayoutRevisionId(user,layoutSetBranchId,layout.getPlid());
    layoutRevision=LayoutRevisionLocalServiceUtil.fetchLayoutRevision(layoutRevisionId);
  }
  if ((layoutRevision != null) && !layoutRevision.isInactive()) {
    return layoutRevision;
  }
  layoutRevision=LayoutRevisionLocalServiceUtil.fetchLatestLayoutRevision(layoutSetBranchId,layout.getPlid());
  if (layoutRevision != null) {
    StagingUtil.setRecentLayoutRevisionId(user,layoutSetBranchId,layout.getPlid(),layoutRevision.getLayoutRevisionId());
    return layoutRevision;
  }
  LayoutBranch layoutBranch=LayoutBranchLocalServiceUtil.getMasterLayoutBranch(layoutSetBranchId,layout.getPlid(),serviceContext);
  if (!MergeLayoutPrototypesThreadLocal.isInProgress()) {
    serviceContext.setWorkflowAction(WorkflowConstants.ACTION_SAVE_DRAFT);
  }
  layoutRevision=LayoutRevisionLocalServiceUtil.addLayoutRevision(serviceContext.getUserId(),layoutSetBranchId,layoutBranch.getLayoutBranchId(),LayoutRevisionConstants.DEFAULT_PARENT_LAYOUT_REVISION_ID,false,layout.getPlid(),LayoutConstants.DEFAULT_PLID,layout.isPrivateLayout(),layout.getName(),layout.getTitle(),layout.getDescription(),layout.getKeywords(),layout.getRobots(),layout.getTypeSettings(),layout.getIconImage(),layout.getIconImageId(),layout.getThemeId(),layout.getColorSchemeId(),layout.getCss(),serviceContext);
  boolean explicitCreation=ParamUtil.getBoolean(serviceContext,"explicitCreation");
  if (!explicitCreation) {
    LayoutRevisionLocalServiceUtil.updateStatus(serviceContext.getUserId(),layoutRevision.getLayoutRevisionId(),WorkflowConstants.STATUS_INCOMPLETE,serviceContext);
  }
  return layoutRevision;
}
