{
  PortletSession portletSession=portletRequest.getPortletSession();
  ThemeDisplay themeDisplay=(ThemeDisplay)portletRequest.getAttribute(WebKeys.THEME_DISPLAY);
  String sessionCartId=ShoppingCart.class.getName() + themeDisplay.getScopeGroupId();
  if (themeDisplay.isSignedIn()) {
    ShoppingCart cart=(ShoppingCart)portletSession.getAttribute(sessionCartId);
    if (cart != null) {
      portletSession.removeAttribute(sessionCartId);
    }
    if ((cart != null) && (cart.getItemsSize() > 0)) {
      cart=ShoppingCartLocalServiceUtil.updateCart(themeDisplay.getUserId(),themeDisplay.getScopeGroupId(),cart.getItemIds(),cart.getCouponCodes(),cart.getAltShipping(),cart.isInsure());
    }
 else {
      try {
        cart=ShoppingCartLocalServiceUtil.getCart(themeDisplay.getUserId(),themeDisplay.getScopeGroupId());
      }
 catch (      NoSuchCartException nsce) {
        cart=getCart(themeDisplay);
        cart=ShoppingCartLocalServiceUtil.updateCart(themeDisplay.getUserId(),themeDisplay.getScopeGroupId(),cart.getItemIds(),cart.getCouponCodes(),cart.getAltShipping(),cart.isInsure());
      }
    }
    return cart;
  }
 else {
    ShoppingCart cart=(ShoppingCart)portletSession.getAttribute(sessionCartId);
    if (cart == null) {
      cart=getCart(themeDisplay);
      portletSession.setAttribute(sessionCartId,cart);
    }
    return cart;
  }
}
