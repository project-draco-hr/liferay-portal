{
  PortletSession ses=req.getPortletSession();
  ThemeDisplay themeDisplay=(ThemeDisplay)req.getAttribute(WebKeys.THEME_DISPLAY);
  String sesCartId=ShoppingCart.class.getName() + "_SESSION_" + ses.getId()+ "_"+ themeDisplay.getPortletGroupId();
  String userCartId=ShoppingCart.class.getName() + "_USER_" + themeDisplay.getUserId()+ "_"+ themeDisplay.getPortletGroupId();
  if (themeDisplay.isSignedIn()) {
    ShoppingCart cart=(ShoppingCart)ses.getAttribute(sesCartId);
    if (cart != null) {
      ses.removeAttribute(sesCartId);
    }
    if ((cart != null) && (cart.getItemsSize() > 0)) {
      cart=ShoppingCartLocalServiceUtil.updateCart(themeDisplay.getUserId(),themeDisplay.getPortletGroupId(),cart.getCartId(),cart.getItemIds(),cart.getCouponIds(),cart.getAltShipping(),cart.isInsure());
    }
 else {
      try {
        cart=ShoppingCartLocalServiceUtil.getCart(userCartId);
      }
 catch (      NoSuchCartException nsce) {
        cart=getCart(userCartId,themeDisplay);
        cart=ShoppingCartLocalServiceUtil.updateCart(themeDisplay.getUserId(),themeDisplay.getPortletGroupId(),cart.getCartId(),cart.getItemIds(),cart.getCouponIds(),cart.getAltShipping(),cart.isInsure());
      }
    }
    return cart;
  }
 else {
    ShoppingCart cart=(ShoppingCart)ses.getAttribute(sesCartId);
    if (cart == null) {
      cart=getCart(sesCartId,themeDisplay);
      ses.setAttribute(sesCartId,cart);
    }
    return cart;
  }
}
