{
  ThreadPoolExecutor threadPoolExecutor=new ThreadPoolExecutor(5,10,TestUtil.KEEPALIVE_TIME,TimeUnit.MILLISECONDS,false,10);
  try {
    Queue<MarkerBlockingJob> markerBlockingJobQueue=new LinkedList<MarkerBlockingJob>();
    assertEquals(0,threadPoolExecutor.getPoolSize());
    for (int i=0; i < 10; i++) {
      MarkerBlockingJob markerBlockingJob=new MarkerBlockingJob(true);
      markerBlockingJobQueue.add(markerBlockingJob);
      threadPoolExecutor.execute(markerBlockingJob);
      markerBlockingJob.waitUntilBlock();
      assertEquals(i + 1,threadPoolExecutor.getPoolSize());
      assertEquals(i + 1,threadPoolExecutor.getLargestPoolSize());
      assertEquals(i + 1,threadPoolExecutor.getTaskCount());
    }
    for (int i=0; i < 10; i++) {
      MarkerBlockingJob markerBlockingJob=new MarkerBlockingJob(true);
      markerBlockingJobQueue.add(markerBlockingJob);
      threadPoolExecutor.execute(markerBlockingJob);
      assertEquals(10,threadPoolExecutor.getPoolSize());
      assertEquals(10,threadPoolExecutor.getLargestPoolSize());
      assertEquals(i + 1,threadPoolExecutor.getPendingTaskCount());
      assertEquals(i + 11,threadPoolExecutor.getTaskCount());
    }
    for (int i=0; i < 10; i++) {
      try {
        threadPoolExecutor.execute(new MarkerBlockingJob(true));
        fail();
      }
 catch (      RejectedExecutionException ree) {
      }
      assertEquals(10,threadPoolExecutor.getPoolSize());
      assertEquals(10,threadPoolExecutor.getLargestPoolSize());
      assertEquals(10,threadPoolExecutor.getPendingTaskCount());
      assertEquals(20,threadPoolExecutor.getTaskCount());
    }
    assertEquals(20,markerBlockingJobQueue.size());
    for (int i=0; i < 10; i++) {
      MarkerBlockingJob markerBlockingJob=markerBlockingJobQueue.remove();
      markerBlockingJob.unBlock();
      TestUtil.waitUntilEnded(markerBlockingJob);
      assertEquals(10,threadPoolExecutor.getPoolSize());
      assertEquals(10,threadPoolExecutor.getLargestPoolSize());
      assertEquals(9 - i,threadPoolExecutor.getPendingTaskCount());
      assertEquals(20,threadPoolExecutor.getTaskCount());
      assertEquals(i + 1,threadPoolExecutor.getCompletedTaskCount());
    }
    for (int i=0; i < 10; i++) {
      MarkerBlockingJob markerBlockingJob=markerBlockingJobQueue.remove();
      markerBlockingJob.unBlock();
      TestUtil.waitUntilEnded(markerBlockingJob);
      Thread.sleep(TestUtil.KEEPALIVE_WAIT);
      assertEquals((i > 4) ? 5 : 9 - i,threadPoolExecutor.getPoolSize());
      assertEquals(10,threadPoolExecutor.getLargestPoolSize());
      assertEquals(0,threadPoolExecutor.getPendingTaskCount());
      assertEquals(20,threadPoolExecutor.getTaskCount());
      assertEquals(i + 11,threadPoolExecutor.getCompletedTaskCount());
    }
  }
  finally {
    TestUtil.closePool(threadPoolExecutor,true);
  }
}
