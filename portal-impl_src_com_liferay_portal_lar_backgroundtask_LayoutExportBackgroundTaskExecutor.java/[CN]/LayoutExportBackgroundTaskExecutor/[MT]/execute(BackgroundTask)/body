{
  Map<String,Serializable> taskContextMap=backgroundTask.getTaskContextMap();
  long userId=MapUtil.getLong(taskContextMap,"userId");
  String fileName=MapUtil.getString(taskContextMap,"fileName");
  long groupId=MapUtil.getLong(taskContextMap,"groupId");
  boolean privateLayout=MapUtil.getBoolean(taskContextMap,"privateLayout");
  long[] layoutIds=GetterUtil.getLongValues(taskContextMap.get("layoutIds"));
  Map<String,String[]> parameterMap=(Map<String,String[]>)taskContextMap.get("parameterMap");
  Date startDate=(Date)taskContextMap.get("startDate");
  Date endDate=(Date)taskContextMap.get("endDate");
  Date lastPublishDate=endDate;
  if (lastPublishDate == null) {
    lastPublishDate=new Date();
  }
  File larFile=LayoutLocalServiceUtil.exportLayoutsAsFile(groupId,privateLayout,layoutIds,parameterMap,startDate,endDate);
  BackgroundTaskLocalServiceUtil.addBackgroundTaskAttachment(userId,backgroundTask.getBackgroundTaskId(),fileName,larFile);
  boolean updateLastPublishDate=MapUtil.getBoolean(parameterMap,PortletDataHandlerKeys.UPDATE_LAST_PUBLISH_DATE);
  if (updateLastPublishDate) {
    StagingUtil.updateLastPublishDate(groupId,privateLayout,lastPublishDate);
  }
  return BackgroundTaskResult.SUCCESS;
}
