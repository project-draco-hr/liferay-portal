{
  PortletConfigImpl configImpl=(PortletConfigImpl)config;
  String portletId=configImpl.getPortletId();
  PortletPreferences prefs=PortletPreferencesFactoryUtil.getPortletSetup(req,portletId);
  String databaseTableName=prefs.getValue("databaseTableName",StringPool.BLANK);
  String title=prefs.getValue("title","no-title");
  StringMaker csvData=new StringMaker();
  List<String> fieldLabels=new ArrayList<String>();
  for (int i=1; i <= WebFormUtil.MAX_FIELDS; i++) {
    String fieldLabel=prefs.getValue("fieldLabel" + i,StringPool.BLANK);
    if (Validator.isNotNull(fieldLabel)) {
      fieldLabels.add(fieldLabel);
      csvData.append("\"");
      csvData.append(fieldLabel.replaceAll("\"","\\\""));
      csvData.append("\";");
    }
  }
  csvData.deleteCharAt(csvData.length() - 1);
  csvData.append("\n");
  if (Validator.isNotNull(databaseTableName)) {
    List<ExpandoRow> rows=ExpandoRowLocalServiceUtil.getRows(WebFormUtil.class.getName(),databaseTableName,-1,-1);
    for (    ExpandoRow row : rows) {
      for (      String fieldName : fieldLabels) {
        String data=ExpandoValueLocalServiceUtil.getData(WebFormUtil.class.getName(),databaseTableName,fieldName,row.getClassPK(),"");
        data=data.replaceAll("\"","\\\"");
        csvData.append("\"");
        csvData.append(data);
        csvData.append("\";");
      }
      csvData.deleteCharAt(csvData.length() - 1);
      csvData.append("\n");
    }
  }
  res.setContentType("application/text");
  String fileName=title + "_form-data.csv";
  res.setProperty("Content-disposition","attachment;filename=" + fileName);
  OutputStream out=res.getPortletOutputStream();
  try {
    out.write(csvData.toString().getBytes());
  }
  finally {
    out.close();
  }
  return null;
}
