{
  PortletPreferences prefs=PortletPreferencesFactoryUtil.getPortletSetup(req);
  String databaseTableName=prefs.getValue("databaseTableName",StringPool.BLANK);
  String title=prefs.getValue("title","no-title");
  StringMaker sm=new StringMaker();
  List<String> fieldLabels=new ArrayList<String>();
  for (int i=1; i <= WebFormUtil.MAX_FIELDS; i++) {
    String fieldLabel=prefs.getValue("fieldLabel" + i,StringPool.BLANK);
    if (Validator.isNotNull(fieldLabel)) {
      fieldLabels.add(fieldLabel);
      sm.append("\"");
      sm.append(fieldLabel.replaceAll("\"","\\\""));
      sm.append("\";");
    }
  }
  sm.deleteCharAt(sm.length() - 1);
  sm.append("\n");
  if (Validator.isNotNull(databaseTableName)) {
    List<ExpandoRow> rows=ExpandoRowLocalServiceUtil.getRows(WebFormUtil.class.getName(),databaseTableName,QueryUtil.ALL_POS,QueryUtil.ALL_POS);
    for (    ExpandoRow row : rows) {
      for (      String fieldName : fieldLabels) {
        String data=ExpandoValueLocalServiceUtil.getData(WebFormUtil.class.getName(),databaseTableName,fieldName,row.getClassPK(),StringPool.BLANK);
        data=data.replaceAll("\"","\\\"");
        sm.append("\"");
        sm.append(data);
        sm.append("\";");
      }
      sm.deleteCharAt(sm.length() - 1);
      sm.append("\n");
    }
  }
  HttpServletResponse httpRes=PortalUtil.getHttpServletResponse(res);
  String fileName=title + ".csv";
  InputStream is=new ByteArrayInputStream(sm.toString().getBytes());
  String contentType=ContentTypes.APPLICATION_TEXT;
  ServletResponseUtil.sendFile(httpRes,fileName,is,contentType);
  setForward(req,ActionConstants.COMMON_NULL);
}
