{
  final long testProcessInstanceId=101;
  MessageListener getHistoryListener=new MessageListener(){
    public void receive(    Message message){
      ProcessInstanceRequest request=(ProcessInstanceRequest)message.getPayload();
      assertEquals(ProcessInstanceRequestType.GET_HISTORY,request.getType());
      assertEquals(testProcessInstanceId,request.getProcessInstanceId());
      String responseDestination=message.getResponseDestination();
      if (responseDestination != null) {
        ProcessInstanceHistory history=new ProcessInstanceHistory(testProcessInstanceId);
        message.setPayload(new WorkflowResultContainer<ProcessInstanceHistory>(history));
        messageBus.sendMessage(responseDestination,message);
      }
    }
  }
;
  messageBus.registerMessageListener(DestinationNames.WORKFLOW_INSTANCE,getHistoryListener);
  ProcessInstanceHistory history=_proxy.getProcessInstanceHistory(testProcessInstanceId);
  assertNotNull(history);
}
