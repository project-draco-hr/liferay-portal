{
  ServiceTracker<ServletContext,ServletContext> serviceTracker=null;
  try {
    InputStream inputStream=getBundleArchive(request);
    BundleContext bundleContext=_bundle.getBundleContext();
    Bundle bundle=bundleContext.installBundle(_location,inputStream);
    bundle.start();
    Filter filter=bundleContext.createFilter("(&(bundle.id=" + bundle.getBundleId() + ")(objectClass=javax.servlet.ServletContext))");
    serviceTracker=new ServiceTracker<ServletContext,ServletContext>(bundleContext,filter,null);
    serviceTracker.open();
    ServletContext servletContext=serviceTracker.waitForService(_timeout);
    Servlet servlet=waitForServlet(servletContext,"ArquillianServletRunner",_timeout);
    if (servlet == null) {
      throw new TimeoutException("The arquillian servlet runner is taking more than " + _timeout + " to deploy");
    }
    response.setStatus(HttpServletResponse.SC_OK);
    response.setContentType("text/text");
    response.setHeader(_contextPathHeader,servletContext.getContextPath());
  }
 catch (  Exception e) {
    sendError(e,response);
  }
 finally {
    if (serviceTracker != null) {
      serviceTracker.close();
    }
    ServletOutputStream servletOutputStream=response.getOutputStream();
    servletOutputStream.flush();
  }
}
