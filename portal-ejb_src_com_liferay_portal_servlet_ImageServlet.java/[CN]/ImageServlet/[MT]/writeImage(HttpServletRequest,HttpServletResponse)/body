{
  String imageId=getImageId(req);
  if (Validator.isNull(imageId)) {
    _log.warn("Image id should never be null or empty, path is " + req.getPathInfo());
    return;
  }
  Image image=ImageLocalUtil.get(imageId);
  if (image == null) {
    _log.warn("Get a default image for " + imageId);
    image=getDefaultImage(req,imageId);
  }
  if (image == null) {
    _log.warn("No default image exists for " + imageId);
  }
 else {
    if (Validator.isNotNull(image.getType())) {
      res.setContentType("image/" + image.getType());
    }
    ServletOutputStream out=res.getOutputStream();
    try {
      if (!res.isCommitted()) {
        out.write(image.getTextObj());
      }
    }
 catch (    Exception e) {
      _log.warn(StackTraceUtil.getStackTrace(e));
    }
 finally {
      out.flush();
      out.close();
    }
  }
}
