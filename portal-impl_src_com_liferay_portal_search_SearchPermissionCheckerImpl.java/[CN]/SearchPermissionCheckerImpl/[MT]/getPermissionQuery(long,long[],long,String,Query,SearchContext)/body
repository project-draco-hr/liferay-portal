{
  if ((PropsValues.PERMISSIONS_USER_CHECK_ALGORITHM != 5) && (PropsValues.PERMISSIONS_USER_CHECK_ALGORITHM != 6)) {
    return query;
  }
  PermissionChecker permissionChecker=PermissionThreadLocal.getPermissionChecker();
  AdvancedPermissionChecker advancedPermissionChecker=null;
  if ((permissionChecker != null) && (permissionChecker instanceof AdvancedPermissionChecker)) {
    advancedPermissionChecker=(AdvancedPermissionChecker)permissionChecker;
  }
  if (advancedPermissionChecker == null) {
    return query;
  }
  try {
    PermissionCheckerBag bag=getUserBag(advancedPermissionChecker,userId);
    if (bag == null) {
      return query;
    }
    List<Group> groups=new UniqueList<Group>();
    List<Role> roles=new UniqueList<Role>();
    List<UserGroupRole> userGroupRoles=new UniqueList<UserGroupRole>();
    Map<Long,List<Role>> groupIdsToRoles=new HashMap<Long,List<Role>>();
    roles.addAll(bag.getRoles());
    if ((groupIds == null) || (groupIds.length == 0)) {
      groups.addAll(GroupLocalServiceUtil.getUserGroups(userId,true));
      groups.addAll(bag.getGroups());
      userGroupRoles=UserGroupRoleLocalServiceUtil.getUserGroupRoles(userId);
    }
 else {
      groups.addAll(bag.getGroups());
      for (      long groupId : groupIds) {
        if (GroupLocalServiceUtil.hasUserGroup(userId,groupId)) {
          Group group=GroupLocalServiceUtil.getGroup(groupId);
          groups.add(group);
        }
        userGroupRoles.addAll(UserGroupRoleLocalServiceUtil.getUserGroupRoles(userId,groupId));
        userGroupRoles.addAll(UserGroupRoleLocalServiceUtil.getUserGroupRolesByUserUserGroupAndGroup(userId,groupId));
      }
    }
    if (advancedPermissionChecker.isSignedIn()) {
      roles.add(RoleLocalServiceUtil.getRole(companyId,RoleConstants.GUEST));
    }
    for (    Group group : groups) {
      PermissionCheckerBag userBag=advancedPermissionChecker.getUserBag(userId,group.getGroupId());
      List<Role> groupRoles=userBag.getRoles();
      groupIdsToRoles.put(group.getGroupId(),groupRoles);
      roles.addAll(groupRoles);
    }
    if (PropsValues.PERMISSIONS_USER_CHECK_ALGORITHM == 5) {
      return doGetPermissionQuery_5(companyId,groupIds,userId,className,query,searchContext,advancedPermissionChecker,groups,roles,userGroupRoles,groupIdsToRoles);
    }
 else     if (PropsValues.PERMISSIONS_USER_CHECK_ALGORITHM == 6) {
      return doGetPermissionQuery_6(companyId,groupIds,userId,className,query,searchContext,advancedPermissionChecker,groups,roles,userGroupRoles,groupIdsToRoles);
    }
  }
 catch (  Exception e) {
    _log.error(e,e);
  }
  return query;
}
