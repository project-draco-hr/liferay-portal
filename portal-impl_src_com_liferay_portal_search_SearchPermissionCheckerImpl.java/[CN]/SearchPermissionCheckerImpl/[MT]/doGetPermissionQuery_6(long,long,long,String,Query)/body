{
  BooleanQuery fullQuery=BooleanQueryFactoryUtil.create();
  BooleanQuery permissionQuery=BooleanQueryFactoryUtil.create();
  List<Role> roles=RoleLocalServiceUtil.getUserRoles(userId);
  roles=ListUtil.copy(roles);
  List<UserGroupRole> userGroupRoles=null;
  if (groupId == 0) {
    userGroupRoles=UserGroupRoleLocalServiceUtil.getUserGroupRoles(userId);
  }
 else {
    userGroupRoles=UserGroupRoleLocalServiceUtil.getUserGroupRoles(userId,groupId);
    userGroupRoles=ListUtil.copy(userGroupRoles);
    userGroupRoles.addAll(UserGroupRoleLocalServiceUtil.getUserGroupRolesByUserUserGroupAndGroup(userId,groupId));
  }
  long defaultUserId=UserLocalServiceUtil.getDefaultUserId(companyId);
  if (defaultUserId != userId) {
    roles.add(RoleLocalServiceUtil.getRole(companyId,RoleConstants.GUEST));
  }
  for (  Role role : roles) {
    if (role.getName().equals(RoleConstants.ADMINISTRATOR)) {
      return query;
    }
    long roleId=role.getRoleId();
    if (ResourcePermissionLocalServiceUtil.hasResourcePermission(companyId,className,ResourceConstants.SCOPE_COMPANY,String.valueOf(companyId),roleId,ActionKeys.VIEW) || ResourcePermissionLocalServiceUtil.hasResourcePermission(companyId,className,ResourceConstants.SCOPE_GROUP,String.valueOf(groupId),roleId,ActionKeys.VIEW)) {
      return query;
    }
    permissionQuery.addTerm(Field.ROLE_ID,roleId);
  }
  for (  UserGroupRole userGroupRole : userGroupRoles) {
    permissionQuery.addTerm(Field.GROUP_ROLE_ID,userGroupRole.getGroupId() + StringPool.DASH + userGroupRole.getRoleId());
  }
  fullQuery.add(query,BooleanClauseOccur.MUST);
  fullQuery.add(permissionQuery,BooleanClauseOccur.MUST);
  return fullQuery;
}
