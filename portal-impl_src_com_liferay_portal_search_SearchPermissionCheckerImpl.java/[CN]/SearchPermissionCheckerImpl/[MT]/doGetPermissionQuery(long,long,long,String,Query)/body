{
  BooleanQuery fullQuery=BooleanQueryFactoryUtil.create();
  BooleanQuery permissionQuery=BooleanQueryFactoryUtil.create();
  List<Role> roles=RoleLocalServiceUtil.getUserRoles(userId);
  roles=ListUtil.copy(roles);
  roles.addAll(RoleLocalServiceUtil.getUserGroupRoles(userId,groupId));
  long companyResourceId=0;
  try {
    Resource companyResource=ResourceLocalServiceUtil.getResource(companyId,className,ResourceConstants.SCOPE_COMPANY,String.valueOf(companyId));
    companyResourceId=companyResource.getResourceId();
  }
 catch (  NoSuchResourceException nsre) {
  }
  long groupResourceId=0;
  try {
    Resource groupResource=ResourceLocalServiceUtil.getResource(companyId,className,ResourceConstants.SCOPE_GROUP,String.valueOf(groupId));
    groupResourceId=groupResource.getResourceId();
  }
 catch (  NoSuchResourceException nsre) {
  }
  for (  Role role : roles) {
    if (role.getName().equals(RoleConstants.ADMINISTRATOR)) {
      return query;
    }
    long roleId=role.getRoleId();
    if (hasPermission(roleId,companyResourceId) || hasPermission(roleId,groupResourceId)) {
      return query;
    }
    permissionQuery.addTerm(Field.ROLE_ID,role.getRoleId());
  }
  fullQuery.add(query,BooleanClauseOccur.MUST);
  fullQuery.add(permissionQuery,BooleanClauseOccur.MUST);
  return fullQuery;
}
