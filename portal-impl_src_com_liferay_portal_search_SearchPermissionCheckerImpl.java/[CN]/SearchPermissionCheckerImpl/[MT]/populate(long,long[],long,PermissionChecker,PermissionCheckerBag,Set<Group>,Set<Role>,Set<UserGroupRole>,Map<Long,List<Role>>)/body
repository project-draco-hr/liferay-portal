{
  roles.addAll(permissionCheckerBag.getRoles());
  if (ArrayUtil.isEmpty(groupIds)) {
    groups.addAll(GroupLocalServiceUtil.getUserGroups(userId,true));
    groups.addAll(permissionCheckerBag.getGroups());
    userGroupRoles.addAll(UserGroupRoleLocalServiceUtil.getUserGroupRoles(userId));
  }
 else {
    for (    long groupId : groupIds) {
      if (GroupLocalServiceUtil.hasUserGroup(userId,groupId)) {
        Group group=GroupLocalServiceUtil.getGroup(groupId);
        groups.add(group);
      }
      userGroupRoles.addAll(UserGroupRoleLocalServiceUtil.getUserGroupRoles(userId,groupId));
      userGroupRoles.addAll(UserGroupRoleLocalServiceUtil.getUserGroupRolesByUserUserGroupAndGroup(userId,groupId));
    }
  }
  if (permissionChecker.isSignedIn()) {
    roles.add(RoleLocalServiceUtil.getRole(companyId,RoleConstants.GUEST));
  }
  for (  Group group : groups) {
    PermissionCheckerBag userBag=permissionChecker.getUserBag(userId,group.getGroupId());
    List<Role> groupRoles=ListUtil.fromCollection(userBag.getRoles());
    groupIdsToRoles.put(group.getGroupId(),groupRoles);
    roles.addAll(groupRoles);
  }
}
