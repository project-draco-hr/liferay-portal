{
  PermissionCheckerBag bag=getUserBag(userId);
  List<Group> groups=new ArrayList<Group>();
  List<Role> roles=bag.getRoles();
  List<UserGroupRole> userGroupRoles=new ArrayList<UserGroupRole>();
  if ((groupIds == null) || (groupIds.length == 0)) {
    groups.addAll(GroupLocalServiceUtil.getUserGroups(userId,true));
    groups.addAll(bag.getGroups());
    userGroupRoles=UserGroupRoleLocalServiceUtil.getUserGroupRoles(userId);
  }
 else {
    for (    long groupId : groupIds) {
      if (GroupLocalServiceUtil.hasUserGroup(userId,groupId)) {
        Group group=GroupLocalServiceUtil.getGroup(groupId);
        groups.add(group);
      }
      userGroupRoles.addAll(UserGroupRoleLocalServiceUtil.getUserGroupRoles(userId,groupId));
      userGroupRoles.addAll(UserGroupRoleLocalServiceUtil.getUserGroupRolesByUserUserGroupAndGroup(userId,groupId));
    }
  }
  long defaultUserId=UserLocalServiceUtil.getDefaultUserId(companyId);
  if (defaultUserId != userId) {
    roles.add(RoleLocalServiceUtil.getRole(companyId,RoleConstants.GUEST));
  }
  long companyResourceId=0;
  try {
    Resource companyResource=ResourceLocalServiceUtil.getResource(companyId,className,ResourceConstants.SCOPE_COMPANY,String.valueOf(companyId));
    companyResourceId=companyResource.getResourceId();
  }
 catch (  NoSuchResourceException nsre) {
  }
  long[] groupResourceIds=new long[groupIds.length];
  try {
    for (int i=0; i < groupIds.length; i++) {
      Resource groupResource=ResourceLocalServiceUtil.getResource(companyId,className,ResourceConstants.SCOPE_GROUP,String.valueOf(groupIds[i]));
      groupResourceIds[i]=groupResource.getResourceId();
    }
  }
 catch (  NoSuchResourceException nsre) {
  }
  BooleanQuery permissionQuery=BooleanQueryFactoryUtil.create();
  if (userId > 0) {
    permissionQuery.addTerm(Field.USER_ID,userId);
  }
  for (  Role role : roles) {
    if (role.getName().equals(RoleConstants.ADMINISTRATOR)) {
      return query;
    }
    long roleId=role.getRoleId();
    if (hasPermission(roleId,companyResourceId)) {
      return query;
    }
    for (    long groupResourceId : groupResourceIds) {
      if (hasPermission(roleId,groupResourceId)) {
        return query;
      }
    }
    permissionQuery.addTerm(Field.ROLE_ID,role.getRoleId());
  }
  for (  Group group : groups) {
    addRequiredMemberRole(group,permissionQuery);
  }
  for (  UserGroupRole userGroupRole : userGroupRoles) {
    permissionQuery.addTerm(Field.GROUP_ROLE_ID,userGroupRole.getGroupId() + StringPool.DASH + userGroupRole.getRoleId());
  }
  BooleanQuery fullQuery=BooleanQueryFactoryUtil.create();
  fullQuery.add(query,BooleanClauseOccur.MUST);
  fullQuery.add(permissionQuery,BooleanClauseOccur.MUST);
  return fullQuery;
}
