{
  Map<Comparable<?>,Lock> locksByPK=_getLocks(className);
  Lock lock=locksByPK.get(pk);
  if (lock != null) {
    if (lock.isExpired()) {
      _unlock(className,pk);
      lock=null;
    }
 else     if (!lock.getOwner().equals(owner)) {
      throw new DuplicateLockException(lock);
    }
  }
  if (lock == null) {
    String uuid=PortalUUIDUtil.generate();
    lock=new Lock(uuid,className,pk,userId,owner,expirationTime);
    locksByPK.put(pk,lock);
    _lockByUuid.put(uuid,lock);
  }
 else {
    lock.setExpirationTime(expirationTime);
  }
  return lock;
}
