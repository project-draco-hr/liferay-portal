{
  User user=userPersistence.findByPrimaryKey(userId);
  feedId=feedId.trim().toUpperCase();
  Date now=new Date();
  validate(user.getCompanyId(),groupId,feedId,autoFeedId,name,structureId,targetLayoutFriendlyUrl,contentField);
  if (autoFeedId) {
    feedId=String.valueOf(counterLocalService.increment());
  }
  long id=counterLocalService.increment();
  JournalFeed feed=journalFeedPersistence.create(id);
  feed.setUuid(serviceContext.getUuid());
  feed.setGroupId(groupId);
  feed.setCompanyId(user.getCompanyId());
  feed.setUserId(user.getUserId());
  feed.setUserName(user.getFullName());
  feed.setCreateDate(serviceContext.getCreateDate(now));
  feed.setModifiedDate(serviceContext.getModifiedDate(now));
  feed.setFeedId(feedId);
  feed.setName(name);
  feed.setDescription(description);
  feed.setType(type);
  feed.setStructureId(structureId);
  feed.setTemplateId(templateId);
  feed.setRendererTemplateId(rendererTemplateId);
  feed.setDelta(delta);
  feed.setOrderByCol(orderByCol);
  feed.setOrderByType(orderByType);
  feed.setTargetLayoutFriendlyUrl(targetLayoutFriendlyUrl);
  feed.setTargetPortletId(targetPortletId);
  feed.setContentField(contentField);
  if (Validator.isNull(feedType)) {
    feed.setFeedType(RSSUtil.TYPE_DEFAULT);
    feed.setFeedVersion(RSSUtil.VERSION_DEFAULT);
  }
 else {
    feed.setFeedType(feedType);
    feed.setFeedVersion(feedVersion);
  }
  journalFeedPersistence.update(feed,false);
  if (serviceContext.getAddGroupPermissions() || serviceContext.getAddGuestPermissions()) {
    addFeedResources(feed,serviceContext.getAddGroupPermissions(),serviceContext.getAddGuestPermissions());
  }
 else {
    addFeedResources(feed,serviceContext.getGroupPermissions(),serviceContext.getGuestPermissions());
  }
  ExpandoBridge expandoBridge=feed.getExpandoBridge();
  expandoBridge.setAttributes(serviceContext);
  return feed;
}
