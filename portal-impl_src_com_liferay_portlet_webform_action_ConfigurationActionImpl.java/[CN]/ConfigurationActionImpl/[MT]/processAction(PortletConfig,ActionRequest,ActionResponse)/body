{
  String cmd=ParamUtil.getString(req,Constants.CMD);
  if (!cmd.equals(Constants.UPDATE)) {
    return;
  }
  String title=ParamUtil.getString(req,"title");
  String description=ParamUtil.getString(req,"description");
  boolean requireCaptcha=ParamUtil.getBoolean(req,"requireCaptcha");
  String successURL=ParamUtil.getString(req,"successURL");
  boolean sendAsEmail=ParamUtil.getBoolean(req,"sendAsEmail");
  String subject=ParamUtil.getString(req,"subject");
  String emailAddress=ParamUtil.getString(req,"emailAddress");
  boolean saveToFile=ParamUtil.getBoolean(req,"saveToFile");
  String fileName=ParamUtil.getString(req,"fileName");
  String portletResource=ParamUtil.getString(req,"portletResource");
  PortletPreferences prefs=PortletPreferencesFactoryUtil.getPortletSetup(req,portletResource,true,true);
  if (Validator.isNull(title)) {
    SessionErrors.add(req,"titleRequired");
  }
  if (Validator.isNull(subject)) {
    SessionErrors.add(req,"subjectRequired");
  }
  if (!sendAsEmail && !saveToFile) {
    SessionErrors.add(req,"handlingRequired");
  }
  if (sendAsEmail) {
    if (Validator.isNull(emailAddress)) {
      SessionErrors.add(req,"emailAddressRequired");
    }
 else     if (!Validator.isEmailAddress(emailAddress)) {
      SessionErrors.add(req,"emailAddressInvalid");
    }
  }
  if (saveToFile) {
    try {
      FileOutputStream fos=new FileOutputStream(fileName,true);
      fos.close();
    }
 catch (    SecurityException es) {
      SessionErrors.add(req,"fileNameInvalid");
    }
catch (    FileNotFoundException fnfe) {
      SessionErrors.add(req,"fileNameInvalid");
    }
  }
  if (!SessionErrors.isEmpty(req)) {
    return;
  }
  prefs.setValue("title",title);
  prefs.setValue("description",description);
  prefs.setValue("requireCaptcha",String.valueOf(requireCaptcha));
  prefs.setValue("successURL",successURL);
  prefs.setValue("sendAsEmail",String.valueOf(sendAsEmail));
  prefs.setValue("subject",subject);
  prefs.setValue("emailAddress",emailAddress);
  prefs.setValue("saveToFile",String.valueOf(saveToFile));
  prefs.setValue("fileName",fileName);
  int i=1;
  String fieldLabel=ParamUtil.getString(req,"fieldLabel" + i);
  String fieldType=ParamUtil.getString(req,"fieldType" + i);
  boolean fieldOptional=ParamUtil.getBoolean(req,"fieldOptional" + i);
  String fieldOptions=ParamUtil.getString(req,"fieldOptions" + i);
  while ((i == 1) || (fieldLabel.trim().length() > 0)) {
    prefs.setValue("fieldLabel" + i,fieldLabel);
    prefs.setValue("fieldType" + i,fieldType);
    prefs.setValue("fieldOptional" + i,String.valueOf(fieldOptional));
    prefs.setValue("fieldOptions" + i,fieldOptions);
    i++;
    fieldLabel=ParamUtil.getString(req,"fieldLabel" + i);
    fieldType=ParamUtil.getString(req,"fieldType" + i);
    fieldOptional=ParamUtil.getBoolean(req,"fieldOptional" + i);
    fieldOptions=ParamUtil.getString(req,"fieldOptions" + i);
  }
  fieldLabel=prefs.getValue("fieldLabel" + i,StringPool.BLANK);
  while (fieldLabel.trim().length() > 0) {
    prefs.setValue("fieldLabel" + i,StringPool.BLANK);
    prefs.setValue("fieldType" + i,StringPool.BLANK);
    prefs.setValue("fieldOptional" + i,StringPool.BLANK);
    prefs.setValue("fieldOptions" + i,StringPool.BLANK);
    i++;
    fieldLabel=prefs.getValue("fieldLabel" + i,StringPool.BLANK);
  }
  if (SessionErrors.isEmpty(req)) {
    prefs.store();
    SessionMessages.add(req,config.getPortletName() + ".doConfigure");
  }
}
