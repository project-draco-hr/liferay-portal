{
  ThemeDisplay themeDisplay=(ThemeDisplay)actionRequest.getAttribute(WebKeys.THEME_DISPLAY);
  Layout layout=themeDisplay.getLayout();
  LayoutTypePortlet layoutTypePortlet=themeDisplay.getLayoutTypePortlet();
  Theme theme=themeDisplay.getTheme();
  LayoutTemplate newLayoutTemplate=_layoutTemplateLocalService.getLayoutTemplate(newLayoutTemplateId,false,theme.getThemeId());
  List<String> newColumns=getColumnNames(newLayoutTemplate.getContent(),portletResource);
  LayoutTemplate oldLayoutTemplate=_layoutTemplateLocalService.getLayoutTemplate(oldLayoutTemplateId,false,theme.getThemeId());
  List<String> oldColumns=getColumnNames(oldLayoutTemplate.getContent(),portletResource);
  layoutTypePortlet.reorganizePortlets(newColumns,oldColumns);
  layoutTypePortlet.setStateMax(StringPool.BLANK);
  _layoutLocalService.updateLayout(layout.getGroupId(),layout.isPrivateLayout(),layout.getLayoutId(),layout.getTypeSettings());
}
