{
  if (!message.contains("companyId")) {
    message.put("companyId",CompanyThreadLocal.getCompanyId());
  }
  if (!message.contains("permissionChecker")) {
    message.put("permissionChecker",PermissionThreadLocal.getPermissionChecker());
  }
  if (!message.contains("principalName")) {
    message.put("principalName",PrincipalThreadLocal.getName());
  }
  if (!message.contains("principalPassword")) {
    message.put("principalPassword",PrincipalThreadLocal.getPassword());
  }
  ThreadPoolExecutor threadPoolExecutor=getThreadPoolExecutor();
  Runnable runnable=new MessageRunnable(message){
    public void run(){
      try {
        long messageCompanyId=message.getLong("companyId");
        if (messageCompanyId > 0) {
          CompanyThreadLocal.setCompanyId(messageCompanyId);
        }
        PermissionChecker permissionChecker=(PermissionChecker)message.get("permissionChecker");
        if (permissionChecker != null) {
          PermissionThreadLocal.setPermissionChecker(permissionChecker);
        }
        String messagePrincipalName=message.getString("principalName");
        if (Validator.isNotNull(messagePrincipalName)) {
          PrincipalThreadLocal.setName(messagePrincipalName);
        }
        String messagePrincipalPassword=message.getString("principalPassword");
        if (Validator.isNotNull(messagePrincipalPassword)) {
          PrincipalThreadLocal.setPassword(messagePrincipalPassword);
        }
        Boolean clusterForwardMessage=(Boolean)message.get(ClusterLinkUtil.CLUSTER_FORWARD_MESSAGE);
        if (clusterForwardMessage != null) {
          MessageValuesThreadLocal.setValue(ClusterLinkUtil.CLUSTER_FORWARD_MESSAGE,clusterForwardMessage);
        }
        for (        MessageListener messageListener : messageListeners) {
          try {
            messageListener.receive(message);
          }
 catch (          MessageListenerException mle) {
            _log.error("Unable to process message " + message,mle);
          }
        }
      }
  finally {
        ThreadLocalCacheManager.clearAll(Lifecycle.REQUEST);
        CentralizedThreadLocal.clearShortLivedThreadLocals();
      }
    }
  }
;
  threadPoolExecutor.execute(runnable);
}
