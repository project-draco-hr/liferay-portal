{
  _companyId=ParamUtil.getLong(request,"companyId");
  String remoteUser=request.getRemoteUser();
  long userId=GetterUtil.getLong(remoteUser);
  if (userId == 0) {
    remoteUser=null;
  }
  if (remoteUser != null) {
    PrincipalThreadLocal.setName(remoteUser);
    _user=UserLocalServiceUtil.getUserById(userId);
    if (_companyId == 0) {
      _companyId=_user.getCompanyId();
    }
  }
 else {
    if (_companyId == 0) {
      _companyId=PortalInstances.getCompanyId(request);
    }
    if (_companyId != 0) {
      _user=UserLocalServiceUtil.getDefaultUser(_companyId);
    }
  }
}
