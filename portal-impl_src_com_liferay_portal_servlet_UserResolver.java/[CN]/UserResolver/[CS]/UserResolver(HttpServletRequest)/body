{
  long companyId=ParamUtil.getLong(request,"companyId");
  String remoteUser=request.getRemoteUser();
  long userId=GetterUtil.getLong(remoteUser);
  if (userId == 0) {
    remoteUser=null;
  }
  User user=null;
  if (remoteUser != null) {
    PrincipalThreadLocal.setName(remoteUser);
    user=UserLocalServiceUtil.getUserById(userId);
    if (companyId == 0) {
      companyId=user.getCompanyId();
    }
  }
 else {
    if (companyId == 0) {
      companyId=PortalInstances.getCompanyId(request);
    }
    if (companyId != 0) {
      user=UserLocalServiceUtil.getDefaultUser(companyId);
    }
  }
  _companyId=companyId;
  _user=user;
}
