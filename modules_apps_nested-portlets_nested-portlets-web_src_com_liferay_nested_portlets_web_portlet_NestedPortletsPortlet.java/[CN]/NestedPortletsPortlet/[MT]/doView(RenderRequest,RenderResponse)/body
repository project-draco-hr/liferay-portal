{
  ThemeDisplay themeDisplay=(ThemeDisplay)renderRequest.getAttribute(WebKeys.THEME_DISPLAY);
  PortletPreferences portletPreferences=renderRequest.getPreferences();
  String layoutTemplateId=NestedPortletUtil.getLayoutTemplateId(portletPreferences);
  String velocityTemplateId=StringPool.BLANK;
  String velocityTemplateContent=StringPool.BLANK;
  Map<String,String> columnIds=new HashMap<String,String>();
  if (Validator.isNotNull(layoutTemplateId)) {
    Theme theme=themeDisplay.getTheme();
    LayoutTemplate layoutTemplate=LayoutTemplateLocalServiceUtil.getLayoutTemplate(layoutTemplateId,false,theme.getThemeId());
    String content=layoutTemplate.getContent();
    Matcher processColumnMatcher=_processColumnPattern.matcher(content);
    while (processColumnMatcher.find()) {
      String columnId=processColumnMatcher.group(2);
      if (Validator.isNotNull(columnId)) {
        columnIds.put(columnId,renderResponse.getNamespace() + StringPool.UNDERLINE + columnId);
      }
    }
    processColumnMatcher.reset();
    StringBundler sb=new StringBundler(4);
    sb.append(theme.getThemeId());
    sb.append(LayoutTemplateConstants.CUSTOM_SEPARATOR);
    sb.append(renderResponse.getNamespace());
    sb.append(layoutTemplateId);
    velocityTemplateId=sb.toString();
    content=processColumnMatcher.replaceAll("$1\\${$2}$3");
    Matcher columnIdMatcher=_columnIdPattern.matcher(content);
    velocityTemplateContent=columnIdMatcher.replaceAll("$1" + renderResponse.getNamespace() + "$2$3");
  }
  checkLayout(themeDisplay.getLayout(),columnIds.values());
  renderRequest.setAttribute(WebKeys.NESTED_PORTLET_VELOCITY_TEMPLATE_ID,velocityTemplateId);
  renderRequest.setAttribute(WebKeys.NESTED_PORTLET_VELOCITY_TEMPLATE_CONTENT,velocityTemplateContent);
  @SuppressWarnings("unchecked") Map<String,Object> vmVariables=(Map<String,Object>)renderRequest.getAttribute(WebKeys.VM_VARIABLES);
  if (vmVariables != null) {
    vmVariables.putAll(columnIds);
  }
 else {
    renderRequest.setAttribute(WebKeys.VM_VARIABLES,columnIds);
  }
  super.include(viewTemplate,renderRequest,renderResponse);
}
