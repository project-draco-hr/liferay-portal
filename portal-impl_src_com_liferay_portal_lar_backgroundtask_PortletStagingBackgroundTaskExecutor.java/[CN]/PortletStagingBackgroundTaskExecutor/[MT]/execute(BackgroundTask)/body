{
  MissingReferences missingReferences=null;
  HashMap<String,Serializable> serializableTaskContextMap=new HashMap<String,Serializable>(backgroundTask.getTaskContextMap());
  try {
    ExportImportThreadLocal.setPortletStagingInProcess(true);
    ExportImportLifecycleManager.fireExportImportLifecycleEvent(ExportImportLifecycleConstants.EVENT_PUBLICATION_PORTLET_LOCAL_STARTED,serializableTaskContextMap);
    missingReferences=TransactionalCallableUtil.call(transactionAttribute,new PortletStagingCallable(backgroundTask.getBackgroundTaskId()));
    ExportImportLifecycleManager.fireExportImportLifecycleEvent(ExportImportLifecycleConstants.EVENT_PUBLICATION_PORTLET_LOCAL_SUCCEEDED,serializableTaskContextMap);
  }
 catch (  Throwable t) {
    ExportImportLifecycleManager.fireExportImportLifecycleEvent(ExportImportLifecycleConstants.EVENT_PUBLICATION_PORTLET_LOCAL_FAILED,serializableTaskContextMap);
    if (_log.isDebugEnabled()) {
      _log.debug(t,t);
    }
 else     if (_log.isWarnEnabled()) {
      _log.warn("Unable to publish portlet: " + t.getMessage());
    }
    throw new SystemException(t);
  }
 finally {
    ExportImportThreadLocal.setPortletStagingInProcess(false);
  }
  return processMissingReferences(backgroundTask.getBackgroundTaskId(),missingReferences);
}
