{
  User user=userPersistence.findByPrimaryKey(serviceContext.getUserId());
  structureKey=structureKey.trim().toUpperCase();
  if (autoStructureKey) {
    structureKey=String.valueOf(counterLocalService.increment());
  }
  try {
    xsd=DDMXMLUtil.formatXML(xsd);
  }
 catch (  Exception e) {
    throw new StructureEntryXsdException();
  }
  Date now=new Date();
  validate(groupId,structureKey,autoStructureKey,name,xsd);
  long structureEntryId=counterLocalService.increment();
  DDMStructureEntry structureEntry=ddmStructureEntryPersistence.create(structureEntryId);
  structureEntry.setUuid(serviceContext.getUuid());
  structureEntry.setGroupId(serviceContext.getScopeGroupId());
  structureEntry.setCompanyId(user.getCompanyId());
  structureEntry.setUserId(user.getUserId());
  structureEntry.setUserName(user.getFullName());
  structureEntry.setCreateDate(serviceContext.getCreateDate(now));
  structureEntry.setModifiedDate(serviceContext.getModifiedDate(now));
  structureEntry.setStructureKey(structureKey);
  structureEntry.setName(name);
  structureEntry.setDescription(description);
  structureEntry.setXsd(xsd);
  ddmStructureEntryPersistence.update(structureEntry,false);
  if (serviceContext.getAddCommunityPermissions() || serviceContext.getAddGuestPermissions()) {
    addStructureEntryResources(structureEntry,serviceContext.getAddCommunityPermissions(),serviceContext.getAddGuestPermissions());
  }
 else {
    addStructureEntryResources(structureEntry,serviceContext.getCommunityPermissions(),serviceContext.getGuestPermissions());
  }
  return structureEntry;
}
