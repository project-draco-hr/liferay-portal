{
  ThemeDisplay themeDisplay=(ThemeDisplay)request.getAttribute(WebKeys.THEME_DISPLAY);
  String cacheability=ParamUtil.getString(request,"cacheability");
  boolean copyCurrentRenderParameters=ParamUtil.getBoolean(request,"copyCurrentRenderParameters");
  long doAsGroupId=ParamUtil.getLong(request,"doAsGroupId");
  long doAsUserId=ParamUtil.getLong(request,"doAsUserId");
  String doAsUserLanguageId=ParamUtil.getString(request,"doAsUserLanguageId");
  boolean escapeXml=ParamUtil.getBoolean(request,"escapeXml");
  String lifecycle=ParamUtil.getString(request,"lifecycle");
  String name=ParamUtil.getString(request,"name");
  boolean portletConfiguration=ParamUtil.getBoolean(request,"portletConfiguration");
  String portletId=ParamUtil.getString(request,"portletId");
  String portletMode=ParamUtil.getString(request,"portletMode");
  String resourceId=ParamUtil.getString(request,"resourceId");
  String returnToFullPageURL=ParamUtil.getString(request,"returnToFullPageURL");
  boolean secure=ParamUtil.getBoolean(request,"secure",request.isSecure());
  String windowState=ParamUtil.getString(request,"windowState");
  PortletURLImpl portletURL=new PortletURLImpl(request,portletId,themeDisplay.getPlid(),lifecycle);
  if (Validator.isNotNull(cacheability)) {
    portletURL.setCacheability(cacheability);
  }
  portletURL.setCopyCurrentRenderParameters(copyCurrentRenderParameters);
  if (doAsGroupId > 0) {
    portletURL.setDoAsGroupId(doAsGroupId);
  }
  if (doAsUserId > 0) {
  }
  if (Validator.isNotNull(doAsUserLanguageId)) {
    portletURL.setDoAsUserLanguageId(doAsUserLanguageId);
  }
  portletURL.setEscapeXml(escapeXml);
  if (lifecycle.equals(PortletRequest.ACTION_PHASE) && Validator.isNotNull(name)) {
    portletURL.setParameter(ActionRequest.ACTION_NAME,name);
  }
  portletURL.setPortletId(portletId);
  if (portletConfiguration) {
    String portletResource=ParamUtil.getString(request,"portletResource");
    String previewWidth=ParamUtil.getString(request,"previewWidth");
    portletURL.setParameter("struts_action","/portlet_configuration/edit_configuration");
    portletURL.setParameter("returnToFullPageURL",returnToFullPageURL);
    portletURL.setParameter("portletResource",portletResource);
    portletURL.setParameter("previewWidth",previewWidth);
  }
  if (Validator.isNotNull(portletMode)) {
    portletURL.setPortletMode(PortletModeFactory.getPortletMode(portletMode));
  }
  if (Validator.isNotNull(resourceId)) {
    portletURL.setResourceID(resourceId);
  }
  if (!themeDisplay.isStateMaximized()) {
    if (Validator.isNotNull(returnToFullPageURL)) {
      portletURL.setParameter("returnToFullPageURL",returnToFullPageURL);
    }
  }
  portletURL.setSecure(secure);
  if (Validator.isNotNull(windowState)) {
    portletURL.setWindowState(WindowStateFactory.getWindowState(windowState));
  }
  String parameterMapString=ParamUtil.getString(request,"parameterMap");
  if (Validator.isNotNull(parameterMapString)) {
    Map<String,String> parameterMap=(Map<String,String>)JSONFactoryUtil.deserialize(parameterMapString);
    for (    Map.Entry<String,String> entry : parameterMap.entrySet()) {
      String key=entry.getKey();
      String value=entry.getValue();
      if ((key != null) && (value != null)) {
        portletURL.setParameter(key,value);
      }
    }
  }
  return portletURL.toString();
}
