{
  ThemeDisplay themeDisplay=(ThemeDisplay)request.getAttribute(WebKeys.THEME_DISPLAY);
  Layout layout=themeDisplay.getLayout();
  String cacheability=ParamUtil.getString(request,"cacheability");
  boolean copyCurrentRenderParameters=ParamUtil.getBoolean(request,"copyCurrentRenderParameters");
  long doAsUserId=ParamUtil.getLong(request,"doAsUserId");
  long plid=ParamUtil.getLong(request,"plid",layout.getPlid());
  boolean encrypt=ParamUtil.getBoolean(request,"encrypt");
  boolean escapeXml=ParamUtil.getBoolean(request,"escapeXml");
  String lifecycle=ParamUtil.getString(request,"lifecycle");
  String name=ParamUtil.getString(request,"name");
  boolean portletConfiguration=ParamUtil.getBoolean(request,"portletConfiguration");
  String portletId=ParamUtil.getString(request,"portletId");
  String portletMode=ParamUtil.getString(request,"portletMode");
  String resourceId=ParamUtil.getString(request,"resourceId");
  String returnToFullPageURL=ParamUtil.getString(request,"returnToFullPageURL");
  boolean secure=ParamUtil.getBoolean(request,"secure");
  String windowState=ParamUtil.getString(request,"windowState");
  PortletURLImpl portletURL=new PortletURLImpl(request,portletId,plid,lifecycle);
  if (Validator.isNotNull(cacheability)) {
    portletURL.setCacheability(cacheability);
  }
  portletURL.setCopyCurrentRenderParameters(copyCurrentRenderParameters);
  if (doAsUserId > 0) {
    portletURL.setDoAsUserId(doAsUserId);
  }
  portletURL.setEncrypt(encrypt);
  portletURL.setEscapeXml(escapeXml);
  if (lifecycle.equals(PortletRequest.ACTION_PHASE) && Validator.isNotNull(name)) {
    portletURL.setParameter(ActionRequest.ACTION_NAME,name);
  }
  portletURL.setPortletId(portletId);
  if (portletConfiguration) {
    String portletResource=ParamUtil.getString(request,"portletResource");
    String previewWidth=ParamUtil.getString(request,"previewWidth");
    portletURL.setParameter("struts_action","/portlet_configuration/edit_configuration");
    portletURL.setParameter("portletResource",portletResource);
    portletURL.setParameter("previewWidth",previewWidth);
    portletURL.setParameter("returnToFullPageURL",returnToFullPageURL);
  }
  if (Validator.isNotNull(portletMode)) {
    portletURL.setPortletMode(PortletModeFactory.getPortletMode(portletMode));
  }
  if (Validator.isNotNull(resourceId)) {
    portletURL.setResourceID(resourceId);
  }
  if (!themeDisplay.isStateMaximized()) {
    if (Validator.isNotNull(returnToFullPageURL)) {
      portletURL.setParameter("returnToFullPageURL",returnToFullPageURL);
    }
  }
  portletURL.setSecure(secure);
  if (Validator.isNotNull(windowState)) {
    portletURL.setWindowState(WindowStateFactory.getWindowState(windowState));
  }
  String parameterMapString=ParamUtil.getString(request,"parameterMap");
  if (Validator.isNotNull(parameterMapString)) {
    Map<String,String> parameterMap=(Map<String,String>)JSONFactoryUtil.deserialize(parameterMapString);
    Iterator<String> itr=parameterMap.keySet().iterator();
    while (itr.hasNext()) {
      String paramName=itr.next();
      String paramValue=parameterMap.get(paramName);
      portletURL.setParameter(paramName,paramValue);
    }
  }
  return portletURL.toString();
}
