{
  try {
    String companyId=_getCompanyId(recipient);
    String categoryId=_getCategoryId(recipient);
    if (_log.isDebugEnabled()) {
      _log.debug("Deliver message from " + from + " to category "+ categoryId);
    }
    Company company=CompanyLocalServiceUtil.getCompany(companyId);
    User user=UserLocalServiceUtil.getUserByEmailAddress(companyId,from);
    MimeMessage message=new MimeMessage(MailEngine.getSession(),data);
    String[] inReplyToHeaders=message.getHeader("In-Reply-To");
    MBMessage prevMessage=null;
    if ((inReplyToHeaders != null) && (inReplyToHeaders.length > 0)) {
      int x=inReplyToHeaders[0].indexOf("<") + 1;
      int y=inReplyToHeaders[0].indexOf("@");
      try {
        if ((x > 0) && (y != -1)) {
          String prevMessageId=inReplyToHeaders[0].substring(x,y);
          prevMessage=MBMessageLocalServiceUtil.getMessage(prevMessageId);
        }
      }
 catch (      NoSuchMessageException nsme) {
      }
    }
    MBMailMessage collector=new MBMailMessage();
    _collectPartContent(message,collector);
    if (prevMessage == null) {
      MBMessageLocalServiceUtil.addMessage(user.getUserId(),categoryId,message.getSubject(),collector.getBody(),collector.getFiles(),false,0.0,null,true,true);
    }
 else {
      MBMessageLocalServiceUtil.addMessage(user.getUserId(),categoryId,prevMessage.getThreadId(),prevMessage.getMessageId(),message.getSubject(),collector.getBody(),collector.getFiles(),false,0.0,null,true,true);
    }
  }
 catch (  Exception e) {
    _log.error(StackTraceUtil.getStackTrace(e));
    throw new MessageListenerException(e);
  }
}
