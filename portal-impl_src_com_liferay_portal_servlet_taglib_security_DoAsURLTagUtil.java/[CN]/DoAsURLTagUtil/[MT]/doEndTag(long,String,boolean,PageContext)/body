{
  try {
    HttpServletRequest request=(HttpServletRequest)pageContext.getRequest();
    ThemeDisplay themeDisplay=(ThemeDisplay)request.getAttribute(WebKeys.THEME_DISPLAY);
    Company company=themeDisplay.getCompany();
    Layout layout=themeDisplay.getLayout();
    String doAsURL=PortalUtil.getLayoutURL(layout,themeDisplay,false);
    if (HttpUtil.hasDomain(doAsURL)) {
      doAsURL=HttpUtil.removeDomain(doAsURL);
    }
    if (doAsUserId <= 0) {
      doAsUserId=company.getDefaultUser().getUserId();
    }
    String encDoAsUserId=Encryptor.encrypt(company.getKeyObj(),String.valueOf(doAsUserId));
    doAsURL=HttpUtil.addParameter(doAsURL,"doAsUserId",encDoAsUserId);
    if (Validator.isNotNull(var)) {
      pageContext.setAttribute(var,doAsURL);
    }
 else     if (writeOutput) {
      pageContext.getOut().print(doAsURL);
    }
    return doAsURL;
  }
 catch (  Exception e) {
    throw new JspException(e);
  }
}
