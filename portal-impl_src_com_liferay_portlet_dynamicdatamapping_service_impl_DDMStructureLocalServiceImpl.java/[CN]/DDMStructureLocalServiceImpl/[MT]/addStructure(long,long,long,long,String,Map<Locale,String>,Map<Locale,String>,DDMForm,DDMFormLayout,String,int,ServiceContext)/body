{
  User user=userPersistence.findByPrimaryKey(userId);
  if (Validator.isNull(structureKey)) {
    structureKey=String.valueOf(counterLocalService.increment());
  }
 else {
    structureKey=StringUtil.toUpperCase(structureKey.trim());
  }
  Date now=new Date();
  validate(groupId,parentStructureId,classNameId,structureKey,nameMap,ddmForm);
  long structureId=counterLocalService.increment();
  DDMStructure structure=ddmStructurePersistence.create(structureId);
  structure.setUuid(serviceContext.getUuid());
  structure.setGroupId(groupId);
  structure.setCompanyId(user.getCompanyId());
  structure.setUserId(user.getUserId());
  structure.setUserName(user.getFullName());
  structure.setCreateDate(serviceContext.getCreateDate(now));
  structure.setModifiedDate(serviceContext.getModifiedDate(now));
  structure.setParentStructureId(parentStructureId);
  structure.setClassNameId(classNameId);
  structure.setStructureKey(structureKey);
  structure.setVersion(DDMStructureConstants.VERSION_DEFAULT);
  structure.setNameMap(nameMap);
  structure.setDescriptionMap(descriptionMap);
  structure.setDefinition(DDMFormXSDSerializerUtil.serialize(ddmForm));
  structure.setStorageType(storageType);
  structure.setType(type);
  ddmStructurePersistence.update(structure);
  if (serviceContext.isAddGroupPermissions() || serviceContext.isAddGuestPermissions()) {
    addStructureResources(structure,serviceContext.isAddGroupPermissions(),serviceContext.isAddGuestPermissions());
  }
 else {
    addStructureResources(structure,serviceContext.getGroupPermissions(),serviceContext.getGuestPermissions());
  }
  DDMStructureVersion structureVersion=addStructureVersion(structure,DDMStructureConstants.VERSION_DEFAULT);
  ddmStructureLayoutLocalService.addStructureLayout(userId,groupId,structureVersion.getStructureVersionId(),ddmFormLayout,serviceContext);
  return structure;
}
