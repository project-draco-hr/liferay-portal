{
  _advisedSupport=advisedSupport;
  Object previousService=serviceWrapper.getWrappedService();
  if (!(previousService instanceof ServiceWrapper)) {
    Class<?> previousServiceClass=previousService.getClass();
    AggregateClassLoader previousServiceAggregateClassLoader=new AggregateClassLoader(previousServiceClass.getClassLoader());
    previousServiceAggregateClassLoader.addClassLoader(IdentifiableOSGiService.class.getClassLoader());
    previousService=ProxyUtil.newProxyInstance(previousServiceAggregateClassLoader,new Class<?>[]{serviceTypeClass,IdentifiableOSGiService.class},new ClassLoaderBeanHandler(previousService,previousServiceAggregateClassLoader));
    serviceWrapper.setWrappedService((V)previousService);
  }
  AggregateClassLoader newServiceAggregateClassLoader=new AggregateClassLoader(serviceTypeClass.getClassLoader());
  newServiceAggregateClassLoader.addClassLoader(IdentifiableOSGiService.class.getClassLoader());
  Object nextTarget=ProxyUtil.newProxyInstance(newServiceAggregateClassLoader,new Class<?>[]{serviceTypeClass,ServiceWrapper.class,IdentifiableOSGiService.class},new ClassLoaderBeanHandler(serviceWrapper,classLoader));
  TargetSource nextTargetSource=new SingletonTargetSource(nextTarget){
    @Override public Class<?> getTargetClass(){
      return serviceWrapper.getClass();
    }
  }
;
  _advisedSupport.setTargetSource(nextTargetSource);
  _serviceWrapper=(ServiceWrapper<?>)nextTarget;
}
