{
  WebDAVStorage storage=webDavRequest.getWebDAVStorage();
  if (!storage.isSupportsClassTwo()) {
    return HttpServletResponse.SC_METHOD_NOT_ALLOWED;
  }
  int statusCode=HttpServletResponse.SC_PRECONDITION_FAILED;
  HttpServletRequest request=webDavRequest.getHttpServletRequest();
  HttpServletResponse response=webDavRequest.getHttpServletResponse();
  long timeout=WebDAVUtil.getTimeout(request);
  long depth=WebDAVUtil.getDepth(request);
  String lockUuid=webDavRequest.getLockUuid();
  boolean exclusive=false;
  String owner=null;
  Lock lock=null;
  if (Validator.isNull(lockUuid)) {
    try {
      String xml=new String(FileUtil.getBytes(request.getInputStream()));
      if (Validator.isNull(xml)) {
        _log.error("Empty request XML");
        return statusCode;
      }
 else {
        if (_log.isDebugEnabled()) {
          _log.debug("Request XML\n" + XMLFormatter.toString(xml));
        }
        SAXReader reader=new SAXReader();
        Document doc=reader.read(new StringReader(xml));
        Element root=doc.getRootElement();
        List<Element> lockscope=root.element("lockscope").elements();
        for (        Element scope : lockscope) {
          String name=GetterUtil.getString(scope.getName());
          if (name.equals("exclusive")) {
            exclusive=true;
          }
        }
        if (!exclusive) {
          return HttpServletResponse.SC_BAD_REQUEST;
        }
        Element ownerEl=root.element("owner");
        owner=ownerEl.getTextTrim();
        if (Validator.isNull(owner)) {
          List<Element> childEls=ownerEl.elements("href");
          for (          Element childEl : childEls) {
            owner=childEl.getTextTrim();
            owner="<D:href>" + owner + "</D:href>";
          }
        }
      }
    }
 catch (    Exception e) {
      throw new WebDAVException(e);
    }
    lock=storage.lockResource(webDavRequest,timeout,owner);
  }
 else {
    lock=storage.refreshResourceLock(webDavRequest,lockUuid,timeout);
  }
  if (Validator.isNotNull(lock)) {
    String xml=getResponseXML(lock,depth);
    if (_log.isDebugEnabled()) {
      _log.debug("Response XML\n" + xml);
    }
    response.setHeader("Lock-Token","<" + WebDAVUtil.TOKEN_PREFIX + lock.getUuid()+ ">");
    response.setStatus(HttpServletResponse.SC_OK);
    response.setContentType(ContentTypes.TEXT_XML_UTF8);
    try {
      ServletResponseUtil.write(response,xml);
    }
 catch (    Exception e) {
      if (_log.isWarnEnabled()) {
        _log.warn(e);
      }
    }
    return -1;
  }
 else {
    return WebDAVUtil.SC_LOCKED;
  }
}
