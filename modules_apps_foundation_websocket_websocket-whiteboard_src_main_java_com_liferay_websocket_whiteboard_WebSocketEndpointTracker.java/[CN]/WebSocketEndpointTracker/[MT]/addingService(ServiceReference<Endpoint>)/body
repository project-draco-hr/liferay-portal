{
  String path=(String)serviceReference.getProperty(_WEBSOCKET_PATH);
  if ((path == null) || path.isEmpty()) {
    return null;
  }
  final ServiceObjects<Endpoint> serviceObjects=_bundleContext.getServiceObjects(serviceReference);
  ServerEndpointConfigWrapper serverEndpointConfig=_webSocketEndpointRegistrations.get(path);
  boolean isNew=false;
  if (serverEndpointConfig == null) {
    serverEndpointConfig=new ServerEndpointConfigWrapper(path,_log);
    isNew=true;
  }
  serverEndpointConfig.setConfigurator(serviceReference,new ServiceObjectsConfigurator(serviceObjects,_log));
  if (isNew) {
    ServerContainer serverContainer=(ServerContainer)_servletContext.getAttribute(ServerContainer.class.getName());
    try {
      serverContainer.addEndpoint(serverEndpointConfig);
    }
 catch (    DeploymentException de) {
      Endpoint endpoint=serviceObjects.getService();
      _log.log(LogService.LOG_ERROR,"Can't add websocket endpoint " + endpoint.getClass() + " in the path "+ path,de);
      return null;
    }
    _webSocketEndpointRegistrations.put(path,serverEndpointConfig);
  }
  return serverEndpointConfig;
}
