{
  initialize();
  Thread currentThread=Thread.currentThread();
  ClassLoader contextClassLoader=currentThread.getContextClassLoader();
  try {
    if ((_classLoader != null) && (contextClassLoader != _classLoader)) {
      currentThread.setContextClassLoader(_classLoader);
    }
    for (    ObjectValuePair<String,Long> ovp : _persistestedSubscribersOVPs) {
      String className=ovp.getKey();
      long classPK=ovp.getValue();
      List<Subscription> subscriptions=SubscriptionLocalServiceUtil.getSubscriptions(companyId,className,classPK);
      for (      Subscription subscription : subscriptions) {
        notifySubscriber(subscription);
      }
      if (bulk) {
        Locale locale=LocaleUtil.getDefault();
        InternetAddress to=new InternetAddress(replaceContent(replyToAddress,locale),replaceContent(replyToAddress,locale));
        sendEmail(to,locale);
      }
    }
    _persistestedSubscribersOVPs.clear();
    for (    ObjectValuePair<String,String> ovp : _runtimeSubscribersOVPs) {
      String toAddress=ovp.getKey();
      String toName=ovp.getValue();
      if (_sentAddresses.contains(toAddress)) {
        if (_log.isDebugEnabled()) {
          _log.debug("Do not send a duplicate email to " + toAddress);
        }
        return;
      }
 else {
        if (_log.isDebugEnabled()) {
          _log.debug("Add " + toAddress + " to the list of users who "+ "have received an email");
        }
        _sentAddresses.add(toAddress);
      }
      InternetAddress to=new InternetAddress(toAddress,toName);
      sendEmail(to,LocaleUtil.getDefault());
    }
    _runtimeSubscribersOVPs.clear();
  }
  finally {
    if ((_classLoader != null) && (contextClassLoader != _classLoader)) {
      currentThread.setContextClassLoader(contextClassLoader);
    }
  }
}
