{
  User user=UserLocalServiceUtil.fetchUserById(subscription.getUserId());
  if (user == null) {
    if (_log.isInfoEnabled()) {
      _log.info("Subscription " + subscription.getSubscriptionId() + " is stale and will be deleted");
    }
    deleteSubscription(subscription);
    return;
  }
  String emailAddress=user.getEmailAddress();
  if (_sentEmailAddresses.contains(emailAddress)) {
    if (_log.isDebugEnabled()) {
      _log.debug("Do not send a duplicate email to " + emailAddress);
    }
    return;
  }
 else {
    if (_log.isDebugEnabled()) {
      _log.debug("Add " + emailAddress + " to the list of users who have received an email");
    }
    _sentEmailAddresses.add(emailAddress);
  }
  if (!user.isActive()) {
    if (_log.isDebugEnabled()) {
      _log.debug("Skip inactive user " + user.getUserId());
    }
    return;
  }
  try {
    if (!hasPermission(subscription,className,classPK,user)) {
      if (_log.isDebugEnabled()) {
        _log.debug("Skip unauthorized user " + user.getUserId());
      }
      return;
    }
  }
 catch (  Exception e) {
    _log.error(e,e);
    return;
  }
  if (bulk) {
    if (contextUserId == user.getUserId()) {
      if (_log.isDebugEnabled()) {
        _log.debug("Skip current user in context " + contextUserId);
      }
      return;
    }
    if (UserNotificationManagerUtil.isDeliver(user.getUserId(),portletId,_notificationClassNameId,_notificationType,UserNotificationDeliveryConstants.TYPE_EMAIL)) {
      InternetAddress bulkAddress=new InternetAddress(user.getEmailAddress(),user.getFullName());
      if (_bulkAddresses == null) {
        _bulkAddresses=new ArrayList<>();
      }
      _bulkAddresses.add(bulkAddress);
    }
    sendUserNotification(user);
  }
 else {
    sendNotification(user);
  }
}
