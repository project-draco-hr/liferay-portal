{
  List<Portlet> allPortlets=_portletLocalService.getPortlets(companyId);
  SortedMap<Integer,List<Portlet>> rankedPortlets=new TreeMap<>();
  for (  Portlet portlet : allPortlets) {
    if (!portlet.isActive()) {
      continue;
    }
    PortletDataHandler portletDataHandler=portlet.getPortletDataHandlerInstance();
    if ((portletDataHandler == null) || !portletDataHandler.isDataSiteLevel() || (excludeDataAlwaysStaged && portletDataHandler.isDataAlwaysStaged())) {
      continue;
    }
    List<Portlet> portlets=rankedPortlets.get(portletDataHandler.getRank());
    if (portlets == null) {
      portlets=new ArrayList<>();
    }
    portlets.add(portlet);
    rankedPortlets.put(portletDataHandler.getRank(),portlets);
  }
  List<Portlet> dataSiteLevelPortlets=new ArrayList<>();
  for (  List<Portlet> portlets : rankedPortlets.values()) {
    dataSiteLevelPortlets.addAll(portlets);
  }
  return dataSiteLevelPortlets;
}
