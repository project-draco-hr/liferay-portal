{
  Registry registry=RegistryUtil.getRegistry();
  InterfaceOne oneA=getInstance();
  InterfaceOne oneB=getInstance();
  AtomicReference<TrackedOne> referenceA=new AtomicReference<TrackedOne>();
  AtomicReference<TrackedOne> referenceB=new AtomicReference<TrackedOne>();
  ServiceTrackerCustomizer<InterfaceOne,TrackedOne> serviceTrackerCustomizer=new TestServiceTrackerCustomizer(oneA,oneB,referenceA,referenceB);
  ServiceTracker<InterfaceOne,TrackedOne> serviceTracker=registry.trackServices(InterfaceOne.class,serviceTrackerCustomizer);
  serviceTracker.open();
  Assert.assertTrue(serviceTracker.isEmpty());
  Assert.assertEquals(0,serviceTracker.size());
  Map<String,Object> properties=new HashMap<String,Object>();
  properties.put("a.property","G");
  ServiceRegistration<InterfaceOne> serviceRegistrationA=registry.registerService(InterfaceOne.class,oneA);
  Assert.assertNotNull(serviceRegistrationA);
  ServiceRegistration<InterfaceOne> serviceRegistrationB=registry.registerService(InterfaceOne.class,oneB,properties);
  Assert.assertNotNull(serviceRegistrationB);
  Assert.assertFalse(serviceTracker.isEmpty());
  Assert.assertEquals(referenceA.get(),serviceTracker.getService());
  Assert.assertEquals(referenceB.get(),serviceTracker.getService(serviceRegistrationB.getServiceReference()));
  ServiceReference<InterfaceOne>[] serviceReferences=serviceTracker.getServiceReferences();
  Assert.assertEquals(2,serviceReferences.length);
  Object[] services=serviceTracker.getServices();
  Assert.assertEquals(2,services.length);
  SortedMap<ServiceReference<InterfaceOne>,TrackedOne> trackedServiceReference=serviceTracker.getTrackedServiceReferences();
  Assert.assertNotNull(trackedServiceReference);
  Assert.assertEquals(2,trackedServiceReference.size());
  Assert.assertEquals(referenceA.get(),trackedServiceReference.get(trackedServiceReference.firstKey()));
  Assert.assertEquals(referenceB.get(),trackedServiceReference.get(trackedServiceReference.lastKey()));
  serviceRegistrationA.unregister();
  Assert.assertEquals(1,serviceTracker.size());
  serviceRegistrationB.unregister();
  Assert.assertEquals(0,serviceTracker.size());
  trackedServiceReference=serviceTracker.getTrackedServiceReferences();
  Assert.assertNotNull(trackedServiceReference);
  Assert.assertEquals(0,trackedServiceReference.size());
  serviceTracker.close();
}
