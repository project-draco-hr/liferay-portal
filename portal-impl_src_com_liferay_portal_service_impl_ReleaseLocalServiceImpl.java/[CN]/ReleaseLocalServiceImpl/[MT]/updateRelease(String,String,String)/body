{
  Release release=releaseLocalService.fetchRelease(servletContextName);
  if (release == null) {
    if ("0.0.0".equals(previousVersion)) {
      release=releaseLocalService.addRelease(servletContextName,previousVersion);
    }
 else {
      throw new IllegalStateException("Refusing to upgrade from a non existent release");
    }
  }
  if (!release.getVersion().equals(previousVersion)) {
    throw new IllegalStateException("Refusing to upgrade because previousVersion does not match!");
  }
  release.setVersion(version);
  releasePersistence.update(release);
}
