{
  String userId=getUserId(req);
  if (userId == null) {
    userId=req.getRemoteUser();
    if (userId == null) {
      return null;
    }
  }
  User user=(User)req.getAttribute(WebKeys.USER);
  if (user == null) {
    user=UserLocalServiceUtil.getUserById(userId);
    req.setAttribute(WebKeys.USER,user);
  }
  return user;
}
