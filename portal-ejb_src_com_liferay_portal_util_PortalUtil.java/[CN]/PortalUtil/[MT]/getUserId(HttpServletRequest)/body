{
  String userId=(String)req.getAttribute(WebKeys.USER_ID);
  if (userId != null) {
    return userId;
  }
  if (!GetterUtil.getBoolean(PropsUtil.get(PropsUtil.PORTAL_JAAS_ENABLE)) && GetterUtil.getBoolean(PropsUtil.get(PropsUtil.PORTAL_IMPERSONATION_ENABLE))) {
    String doAsUserId=ParamUtil.getString(req,"doAsUserId");
    try {
      doAsUserId=_getDoAsUserId(req,doAsUserId);
      if (doAsUserId != null) {
        return doAsUserId;
      }
    }
 catch (    Exception e) {
      _log.error("Unable to impersonate user " + doAsUserId,e);
    }
  }
  HttpSession ses=req.getSession();
  userId=(String)ses.getAttribute(WebKeys.USER_ID);
  if (userId != null) {
    req.setAttribute(WebKeys.USER_ID,userId);
  }
  return userId;
}
