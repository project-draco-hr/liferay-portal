{
  JSONObject jsonObject=FacebookConnectUtil.getGraphResources(companyId,"/me",token,"id,email,first_name,last_name,gender");
  if (jsonObject == null || jsonObject.getJSONObject("error") != null) {
    return;
  }
  User user=null;
  long facebookId=jsonObject.getLong("id");
  if (facebookId > 0) {
    session.setAttribute(WebKeys.FACEBOOK_USER_ID,jsonObject.getString("id"));
    try {
      user=UserLocalServiceUtil.getUserByFacebookId(companyId,facebookId);
    }
 catch (    NoSuchUserException nsue) {
    }
  }
  String emailAddress=jsonObject.getString("email");
  if (user == null && Validator.isNotNull(emailAddress)) {
    session.setAttribute(WebKeys.FACEBOOK_USER_EMAIL_ADDRESS,emailAddress);
    try {
      user=UserLocalServiceUtil.getUserByEmailAddress(companyId,emailAddress);
    }
 catch (    NoSuchUserException nsue) {
    }
  }
  if (user != null) {
    updateUser(companyId,session,user,jsonObject);
  }
 else {
    addUser(companyId,session,jsonObject);
  }
}
