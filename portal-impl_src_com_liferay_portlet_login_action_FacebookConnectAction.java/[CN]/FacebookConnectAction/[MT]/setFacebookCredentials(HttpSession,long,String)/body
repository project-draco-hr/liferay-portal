{
  String url=HttpUtil.addParameter(FacebookConnectUtil.getGraphURL(companyId) + "/me","access_token",token);
  url=HttpUtil.addParameter(url,"fields","email,verified");
  Http.Options options=new Http.Options();
  options.setLocation(url);
  String content=HttpUtil.URLtoString(options);
  if (Validator.isNull(content)) {
    return;
  }
  JSONObject jsonObject=JSONFactoryUtil.createJSONObject(content);
  if (!jsonObject.getBoolean("verified")) {
    return;
  }
  String emailAddress=jsonObject.getString("email");
  if (Validator.isNotNull(emailAddress)) {
    try {
      UserLocalServiceUtil.getUserByEmailAddress(companyId,emailAddress);
      session.setAttribute(WebKeys.FACEBOOK_USER_EMAIL_ADDRESS,emailAddress);
    }
 catch (    NoSuchUserException nsue) {
      session.removeAttribute(WebKeys.FACEBOOK_USER_EMAIL_ADDRESS);
    }
  }
 else {
    session.removeAttribute(WebKeys.FACEBOOK_USER_EMAIL_ADDRESS);
    String facebookUserId=jsonObject.getString("id");
    if (Validator.isNotNull(facebookUserId)) {
      session.setAttribute(WebKeys.FACEBOOK_USER_ID,facebookUserId);
    }
  }
}
