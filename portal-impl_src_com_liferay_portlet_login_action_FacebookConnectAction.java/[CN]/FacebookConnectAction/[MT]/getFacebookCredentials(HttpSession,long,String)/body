{
  JSONObject jsonObject=FacebookConnectUtil.getGraphResources(companyId,"/me",token,"id,email,verified");
  if (Validator.isNotNull(jsonObject) && jsonObject.getBoolean("verified")) {
    String facebookId=jsonObject.getString("id");
    if (Validator.isNotNull(facebookId)) {
      session.setAttribute(WebKeys.FACEBOOK_USER_ID,facebookId);
    }
    String emailAddress=jsonObject.getString("email");
    if (Validator.isNotNull(emailAddress)) {
      try {
        UserLocalServiceUtil.getUserByEmailAddress(companyId,emailAddress);
        session.setAttribute(WebKeys.FACEBOOK_USER_EMAIL_ADDRESS,emailAddress);
      }
 catch (      NoSuchUserException nsue) {
        session.removeAttribute(WebKeys.FACEBOOK_USER_EMAIL_ADDRESS);
      }
    }
  }
}
