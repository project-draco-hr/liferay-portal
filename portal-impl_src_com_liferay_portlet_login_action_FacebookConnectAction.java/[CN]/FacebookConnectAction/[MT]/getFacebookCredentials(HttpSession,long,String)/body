{
  String url=HttpUtil.addParameter(FacebookConnectUtil.getGraphURL(companyId) + "/me","access_token",token);
  url=HttpUtil.addParameter(url,"fields","email,verified");
  Http.Options options=new Http.Options();
  options.setLocation(url);
  String content=HttpUtil.URLtoString(options);
  if (Validator.isNotNull(content)) {
    JSONObject jsonObject=JSONFactoryUtil.createJSONObject(content);
    if (jsonObject.getBoolean("verified")) {
      String email=jsonObject.getString("email");
      if (Validator.isNotNull(email)) {
        try {
          UserLocalServiceUtil.getUserByEmailAddress(companyId,email);
          session.setAttribute(WebKeys.FACEBOOK_USER_EMAIL_ADDRESS,email);
        }
 catch (        NoSuchUserException nsue) {
          session.removeAttribute(WebKeys.FACEBOOK_USER_EMAIL_ADDRESS);
        }
      }
 else {
        session.removeAttribute(WebKeys.FACEBOOK_USER_EMAIL_ADDRESS);
        String facebookId=jsonObject.getString("id");
        if (Validator.isNotNull(facebookId)) {
          session.setAttribute(WebKeys.FACEBOOK_USER_ID,facebookId);
        }
      }
    }
  }
}
