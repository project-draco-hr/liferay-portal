{
  String token=FacebookConnectUtil.getAccessToken(actionRequest);
  long companyId=PortalUtil.getCompanyId(actionRequest);
  String url=HttpUtil.addParameter(FacebookConnectUtil.getGraphURL(companyId) + "/me","access_token",token);
  url=HttpUtil.addParameter(url,"fields","email,first_name,last_name,birthday,gender,verified");
  Http.Options options=new Http.Options();
  options.setLocation(url);
  String content=HttpUtil.URLtoString(options);
  if (Validator.isNotNull(content)) {
    JSONObject jsonObject=JSONFactoryUtil.createJSONObject(content);
    if (jsonObject.getBoolean("verified")) {
      String email=jsonObject.getString("email");
      String firstName=jsonObject.getString("first_name");
      String lastName=jsonObject.getString("last_name");
      String gender=jsonObject.getString("gender");
      long facebookId=jsonObject.getLong("id");
      UserLocalServiceUtil.addUser(0l,companyId,true,null,null,true,null,email,facebookId,StringPool.BLANK,Locale.getDefault(),firstName,StringPool.BLANK,lastName,0,0,gender.equals("male"),Calendar.JANUARY,1,1970,StringPool.BLANK,null,null,null,null,true,new ServiceContext());
      FacebookConnectUtil.setFacebookEmailInSession(actionRequest,email);
      actionResponse.sendRedirect("/");
    }
  }
}
