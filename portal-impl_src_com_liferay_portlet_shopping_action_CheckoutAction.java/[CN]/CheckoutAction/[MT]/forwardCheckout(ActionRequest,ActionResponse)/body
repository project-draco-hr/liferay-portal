{
  ThemeDisplay themeDisplay=(ThemeDisplay)req.getAttribute(WebKeys.THEME_DISPLAY);
  ShoppingCart cart=ShoppingUtil.getCart(req);
  ShoppingOrder order=(ShoppingOrder)req.getAttribute(WebKeys.SHOPPING_ORDER);
  ShoppingPreferences prefs=ShoppingPreferences.getInstance(themeDisplay.getCompanyId(),themeDisplay.getPortletGroupId());
  String returnURL=ShoppingUtil.getPayPalReturnURL(((ActionResponseImpl)res).createActionURL(),order);
  String notifyURL=ShoppingUtil.getPayPalNotifyURL(themeDisplay);
  if (prefs.usePayPal()) {
    double total=ShoppingUtil.calculateTotal(cart.getItems(),order.getBillingState(),cart.getCoupon(),cart.getAltShipping(),cart.isInsure());
    String redirectURL=ShoppingUtil.getPayPalRedirectURL(prefs,order,total,returnURL,notifyURL);
    res.sendRedirect(redirectURL);
  }
 else {
    ShoppingOrderLocalServiceUtil.sendEmail(order,"confirmation");
    res.sendRedirect(returnURL);
  }
}
