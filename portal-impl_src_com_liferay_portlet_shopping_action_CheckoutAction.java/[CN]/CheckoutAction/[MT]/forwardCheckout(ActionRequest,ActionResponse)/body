{
  ThemeDisplay themeDisplay=(ThemeDisplay)actionRequest.getAttribute(WebKeys.THEME_DISPLAY);
  ShoppingCart cart=ShoppingUtil.getCart(actionRequest);
  ShoppingOrder order=(ShoppingOrder)actionRequest.getAttribute(WebKeys.SHOPPING_ORDER);
  ShoppingSettings preferences=ShoppingSettings.getInstance(themeDisplay.getCompanyId(),themeDisplay.getScopeGroupId());
  String returnURL=ShoppingUtil.getPayPalReturnURL(((ActionResponseImpl)actionResponse).createActionURL(),order);
  String notifyURL=ShoppingUtil.getPayPalNotifyURL(themeDisplay);
  if (preferences.usePayPal()) {
    double total=ShoppingUtil.calculateTotal(cart.getItems(),order.getBillingState(),cart.getCoupon(),cart.getAltShipping(),cart.isInsure());
    String redirectURL=ShoppingUtil.getPayPalRedirectURL(preferences,order,total,returnURL,notifyURL);
    actionResponse.sendRedirect(redirectURL);
  }
 else {
    ServiceContext serviceContext=ServiceContextFactory.getInstance(actionRequest);
    ShoppingOrderLocalServiceUtil.sendEmail(order,"confirmation",serviceContext);
    actionResponse.sendRedirect(returnURL);
  }
}
