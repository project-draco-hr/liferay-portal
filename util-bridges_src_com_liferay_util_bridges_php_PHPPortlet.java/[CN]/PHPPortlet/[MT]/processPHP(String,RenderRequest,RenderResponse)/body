{
  try {
    ServletConfig config=(ServletConfig)_factory.getServletConfig(getPortletConfig(),req);
    initQuercus(config);
    HttpServletRequest httpReq=(HttpServletRequest)_factory.getServletRequest(req);
    HttpServletResponse httpRes=(HttpServletResponse)_factory.getServletResponse(req,res);
    PHPServletRequest phpReq=new PHPServletRequest(httpReq,config,req,res,getPortletConfig(),phpURI);
    StringServletResponse phpRes=new StringServletResponse(httpRes);
    quercusServlet.service(phpReq,phpRes);
    String result=phpRes.getString();
    if (phpRes.getContentType().startsWith("text/")) {
      result=rewriteURLs(result,res.createRenderURL());
    }
    res.setContentType(phpRes.getContentType());
    PrintWriter writer=res.getWriter();
    writer.write(result.toCharArray());
  }
 catch (  Exception e) {
    _log.error("Error processing PHP",e);
  }
}
