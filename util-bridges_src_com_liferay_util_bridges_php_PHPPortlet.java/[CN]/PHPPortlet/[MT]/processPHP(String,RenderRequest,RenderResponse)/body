{
  try {
    ServletConfig config=(ServletConfig)req.getAttribute(PortletServlet.PORTLET_SERVLET_CONFIG);
    initQuercus(config);
    HttpServletRequest httpReq=(HttpServletRequest)req.getAttribute(PortletServlet.PORTLET_SERVLET_REQUEST);
    HttpServletResponse httpRes=(HttpServletResponse)req.getAttribute(PortletServlet.PORTLET_SERVLET_RESPONSE);
    PHPServletRequest phpReq=new PHPServletRequest(httpReq,config,req,res,getPortletConfig(),phpURI);
    StringServletResponse phpRes=new StringServletResponse(httpRes);
    quercusServlet.service(phpReq,phpRes);
    String result=phpRes.getString();
    if (phpRes.getContentType().startsWith("text/")) {
      result=rewriteURLs(result,res.createRenderURL());
    }
    PrintWriter writer=httpRes.getWriter();
    writer.write(result.toCharArray());
  }
 catch (  Exception e) {
    _log.error("Error processing PHP",e);
  }
}
