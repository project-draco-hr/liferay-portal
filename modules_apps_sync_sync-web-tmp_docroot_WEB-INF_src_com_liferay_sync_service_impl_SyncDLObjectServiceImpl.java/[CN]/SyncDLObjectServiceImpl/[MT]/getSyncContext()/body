{
  try {
    SyncUtil.checkSyncEnabled(0);
    User user=getGuestOrUser();
    SyncContext syncContext=new SyncContext();
    String authType=PrefsPropsUtil.getString(CompanyThreadLocal.getCompanyId(),PropsKeys.COMPANY_SECURITY_AUTH_TYPE,PropsUtil.get(PropsKeys.COMPANY_SECURITY_AUTH_TYPE));
    syncContext.setAuthType(authType);
    boolean oAuthEnabled=PrefsPropsUtil.getBoolean(user.getCompanyId(),PortletPropsKeys.SYNC_OAUTH_ENABLED,PortletPropsValues.SYNC_OAUTH_ENABLED);
    if (oAuthEnabled) {
      String oAuthConsumerKey=PrefsPropsUtil.getString(user.getCompanyId(),PortletPropsKeys.SYNC_OAUTH_CONSUMER_KEY);
      syncContext.setOAuthConsumerKey(oAuthConsumerKey);
      String oAuthConsumerSecret=PrefsPropsUtil.getString(user.getCompanyId(),PortletPropsKeys.SYNC_OAUTH_CONSUMER_SECRET);
      syncContext.setOAuthConsumerSecret(oAuthConsumerSecret);
    }
    syncContext.setOAuthEnabled(oAuthEnabled);
    PluginPackage syncWebPluginPackage=DeployManagerUtil.getInstalledPluginPackage("sync-web");
    syncContext.setPluginVersion(syncWebPluginPackage.getVersion());
    if (!user.isDefaultUser()) {
      syncContext.setPortalBuildNumber(ReleaseInfo.getBuildNumber());
      PluginPackage soPortletPluginPackage=DeployManagerUtil.getInstalledPluginPackage("so-portlet");
      syncContext.setPortletPreferencesMap(getPortletPreferencesMap());
      if (soPortletPluginPackage != null) {
        syncContext.setSocialOfficeInstalled(true);
      }
 else {
        syncContext.setSocialOfficeInstalled(false);
      }
      syncContext.setUser(user);
      if (!syncDeviceSupports(SyncDeviceConstants.FEATURE_SET_1)) {
        syncContext.setUserSitesGroups(getUserSitesGroups());
      }
    }
    return syncContext;
  }
 catch (  PortalException pe) {
    throw new PortalException(SyncUtil.buildExceptionMessage(pe),pe);
  }
}
