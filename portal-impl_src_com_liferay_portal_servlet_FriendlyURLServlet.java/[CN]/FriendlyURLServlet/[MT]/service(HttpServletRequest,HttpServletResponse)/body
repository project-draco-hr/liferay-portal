{
  ServletContext servletContext=getServletContext();
  String mainPath=PortalImpl.PATH_MAIN;
  String friendlyURLPath=null;
  if (_private) {
    if (_user) {
      friendlyURLPath=PortalUtil.getPathFriendlyURLPrivateUser();
    }
 else {
      friendlyURLPath=PortalUtil.getPathFriendlyURLPrivateGroup();
    }
  }
 else {
    friendlyURLPath=PortalUtil.getPathFriendlyURLPublic();
  }
  request.setAttribute(WebKeys.FRIENDLY_URL,friendlyURLPath + request.getPathInfo());
  String redirect=mainPath;
  try {
    redirect=getRedirect(request,request.getPathInfo(),mainPath,request.getParameterMap());
    if (request.getAttribute(WebKeys.LAST_PATH) == null) {
      LastPath lastPath=new LastPath(friendlyURLPath,request.getPathInfo(),request.getParameterMap());
      request.setAttribute(WebKeys.LAST_PATH,lastPath);
    }
  }
 catch (  NoSuchLayoutException nsle) {
    _log.warn(nsle);
    PortalUtil.sendError(HttpServletResponse.SC_NOT_FOUND,nsle,request,response);
    return;
  }
catch (  Exception e) {
    if (_log.isWarnEnabled()) {
      _log.warn(e);
    }
  }
  if (Validator.isNull(redirect)) {
    redirect=mainPath;
  }
  if (_log.isDebugEnabled()) {
    _log.debug("Redirect " + redirect);
  }
  if (redirect.startsWith(StringPool.SLASH)) {
    RequestDispatcher requestDispatcher=servletContext.getRequestDispatcher(redirect);
    if (requestDispatcher != null) {
      requestDispatcher.forward(request,response);
    }
  }
 else {
    response.sendRedirect(redirect);
  }
}
