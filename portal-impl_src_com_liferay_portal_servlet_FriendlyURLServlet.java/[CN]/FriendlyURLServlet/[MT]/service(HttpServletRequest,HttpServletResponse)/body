{
  String mainPath=Portal.PATH_MAIN;
  String redirect=mainPath;
  String pathInfo=getPathInfo(request);
  request.setAttribute(WebKeys.FRIENDLY_URL,getFriendlyURL(pathInfo));
  Object[] redirectArray=null;
  boolean forcePermanentRedirect=false;
  try {
    redirectArray=getRedirect(request,pathInfo,mainPath,request.getParameterMap());
    redirect=(String)redirectArray[0];
    forcePermanentRedirect=(Boolean)redirectArray[1];
    if (request.getAttribute(WebKeys.LAST_PATH) == null) {
      LastPath lastPath=null;
      String lifecycle=ParamUtil.getString(request,"p_p_lifecycle");
      if (lifecycle.equals("1")) {
        lastPath=new LastPath(_friendlyURLPathPrefix,pathInfo);
      }
 else {
        lastPath=new LastPath(_friendlyURLPathPrefix,pathInfo,request.getParameterMap());
      }
      request.setAttribute(WebKeys.LAST_PATH,lastPath);
    }
  }
 catch (  Exception e) {
    if (_log.isWarnEnabled()) {
      _log.warn(e);
    }
    if ((e instanceof NoSuchGroupException) || (e instanceof NoSuchLayoutException)) {
      PortalUtil.sendError(HttpServletResponse.SC_NOT_FOUND,e,request,response);
      return;
    }
  }
  if (Validator.isNull(redirect)) {
    redirect=mainPath;
  }
  if (_log.isDebugEnabled()) {
    _log.debug("Redirect " + redirect);
  }
  if ((redirect.charAt(0) == CharPool.SLASH) && !forcePermanentRedirect) {
    ServletContext servletContext=getServletContext();
    RequestDispatcher requestDispatcher=servletContext.getRequestDispatcher(redirect);
    if (requestDispatcher != null) {
      requestDispatcher.forward(request,response);
    }
  }
 else {
    if (forcePermanentRedirect) {
      response.setHeader("Location",redirect);
      response.setStatus(HttpServletResponse.SC_MOVED_PERMANENTLY);
    }
 else {
      response.sendRedirect(redirect);
    }
  }
}
