{
  ServletContext ctx=getServletContext();
  String mainPath=PortalUtil.PATH_MAIN;
  String friendlyURLPath=null;
  if (_private) {
    if (_user) {
      friendlyURLPath=PortalUtil.getPathFriendlyURLPrivateUser();
    }
 else {
      friendlyURLPath=PortalUtil.getPathFriendlyURLPrivateGroup();
    }
  }
 else {
    friendlyURLPath=PortalUtil.getPathFriendlyURLPublic();
  }
  req.setAttribute(WebKeys.FRIENDLY_URL,friendlyURLPath + req.getPathInfo());
  String redirect=mainPath;
  try {
    redirect=getRedirect(req,req.getPathInfo(),mainPath,req.getParameterMap());
    LastPath lastPath=new LastPath(friendlyURLPath,req.getPathInfo(),req.getParameterMap());
    req.setAttribute(WebKeys.LAST_PATH,lastPath);
  }
 catch (  NoSuchLayoutException nsle) {
    _log.warn(nsle);
    redirect=PropsUtil.get(PropsUtil.LAYOUT_FRIENDLY_URL_PAGE_NOT_FOUND);
  }
catch (  Exception e) {
    if (_log.isWarnEnabled()) {
      _log.warn(e);
    }
  }
  if (Validator.isNull(redirect)) {
    redirect=mainPath;
  }
  if (_log.isDebugEnabled()) {
    _log.debug("Redirect " + redirect);
  }
  if (redirect.startsWith(StringPool.SLASH)) {
    RequestDispatcher rd=ctx.getRequestDispatcher(redirect);
    if (rd != null) {
      rd.forward(req,res);
    }
  }
 else {
    res.sendRedirect(redirect);
  }
}
