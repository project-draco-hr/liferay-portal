{
  User user=TestPropsValues.getUser();
  ServiceContext serviceContext=new ServiceContext();
  serviceContext.setScopeGroupId(_group.getGroupId());
  int initialNotInTrashCount=_message.getAttachmentsFileEntriesCount();
  int initialTrashEntriesCount=_message.getDeletedAttachmentsFileEntriesCount();
  List<FileEntry> fileEntries=_message.getAttachmentsFileEntries();
  List<String> existingFiles=new ArrayList<String>();
  for (  FileEntry fileEntry : fileEntries) {
    existingFiles.add(fileEntry.getTitle());
  }
  _message=MBMessageLocalServiceUtil.updateMessage(user.getUserId(),_message.getMessageId(),"Subject","Body",getInputStreamOVPs("OSX_Test.docx"),existingFiles,0,false,serviceContext);
  Assert.assertEquals(initialNotInTrashCount + 1,_message.getAttachmentsFileEntriesCount());
  Assert.assertEquals(initialTrashEntriesCount,_message.getDeletedAttachmentsFileEntriesCount());
  FileEntry attachmentFileEntry=fileEntries.get(0);
  MBMessageLocalServiceUtil.moveMessageAttachmentToTrash(user.getUserId(),_message.getMessageId(),attachmentFileEntry.getTitle());
  Assert.assertEquals(initialNotInTrashCount,_message.getAttachmentsFileEntriesCount());
  Assert.assertEquals(initialTrashEntriesCount + 1,_message.getDeletedAttachmentsFileEntriesCount());
  List<FileEntry> deletedAttachmentsFileEntries=_message.getDeletedAttachmentsFileEntries(0,1);
  FileEntry deleteAttachmentFileEntry=deletedAttachmentsFileEntries.get(0);
  DLFileEntry dlFileEntry=(DLFileEntry)deleteAttachmentFileEntry.getModel();
  if (restore) {
    MBMessageLocalServiceUtil.restoreMessageAttachmentFromTrash(user.getUserId(),_message.getMessageId(),dlFileEntry.getTitle());
    Assert.assertEquals(initialNotInTrashCount + 1,_message.getAttachmentsFileEntriesCount());
    Assert.assertEquals(initialTrashEntriesCount,_message.getDeletedAttachmentsFileEntriesCount());
  }
 else {
    MBMessageLocalServiceUtil.deleteMessageAttachment(_message.getMessageId(),dlFileEntry.getTitle());
  }
}
