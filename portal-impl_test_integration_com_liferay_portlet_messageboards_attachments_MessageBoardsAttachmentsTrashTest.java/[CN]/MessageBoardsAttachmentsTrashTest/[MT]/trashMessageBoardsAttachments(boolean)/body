{
  User user=TestPropsValues.getUser();
  ServiceContext serviceContext=new ServiceContext();
  serviceContext.setScopeGroupId(TestPropsValues.getGroupId());
  MBMessage message=MBMessageLocalServiceUtil.addMessage(user.getUserId(),user.getFullName(),TestPropsValues.getGroupId(),MBCategoryConstants.DEFAULT_PARENT_CATEGORY_ID,"Subject","Body",MBMessageConstants.DEFAULT_FORMAT,getInputStreamOVPs("company_logo.png"),false,0,false,serviceContext);
  String[] attachmentsFiles=message.getAttachmentsFiles();
  int initialNotInTrashCount=attachmentsFiles.length;
  String[] deletedAttachmentsFiles=message.getDeletedAttachmentsFiles();
  int initialTrashEntriesCount=deletedAttachmentsFiles.length;
  String[] existingAttachments=DLStoreUtil.getFileNames(message.getCompanyId(),CompanyConstants.SYSTEM,message.getAttachmentsDir());
  List<String> existingFiles=new ArrayList<String>();
  for (int i=0; i < existingAttachments.length; i++) {
    existingFiles.add(existingAttachments[i]);
  }
  message=MBMessageLocalServiceUtil.updateMessage(user.getUserId(),message.getMessageId(),"Subject","Body",getInputStreamOVPs("OSX_Test.docx"),existingFiles,0,false,serviceContext);
  attachmentsFiles=message.getAttachmentsFiles();
  Assert.assertEquals(initialNotInTrashCount + 1,attachmentsFiles.length);
  deletedAttachmentsFiles=message.getDeletedAttachmentsFiles();
  Assert.assertEquals(initialTrashEntriesCount,deletedAttachmentsFiles.length);
  String fileName=attachmentsFiles[0];
  MBMessageLocalServiceUtil.moveMessageAttachmentToTrash(message.getMessageId(),fileName);
  attachmentsFiles=message.getAttachmentsFiles();
  Assert.assertEquals(initialNotInTrashCount,attachmentsFiles.length);
  deletedAttachmentsFiles=message.getDeletedAttachmentsFiles();
  Assert.assertEquals(initialTrashEntriesCount + 1,deletedAttachmentsFiles.length);
  fileName=deletedAttachmentsFiles[0];
  if (restore) {
    MBMessageLocalServiceUtil.moveMessageAttachmentFromTrash(message.getMessageId(),fileName);
    attachmentsFiles=message.getAttachmentsFiles();
    Assert.assertEquals(initialNotInTrashCount + 1,attachmentsFiles.length);
    deletedAttachmentsFiles=message.getDeletedAttachmentsFiles();
    Assert.assertEquals(initialTrashEntriesCount,deletedAttachmentsFiles.length);
  }
 else {
    MBMessageLocalServiceUtil.deleteMessageAttachment(message.getMessageId(),fileName);
  }
}
