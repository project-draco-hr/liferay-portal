{
  User user=getUser();
  List orders=ShoppingOrderUtil.findByU_PPPS(getUserId(),ShoppingOrder.STATUS_LATEST);
  ShoppingOrder order=null;
  if (orders.size() == 0) {
    List pastOrders=ShoppingOrderUtil.findByU_PPPS(getUserId(),ShoppingOrder.STATUS_CHECKOUT);
    if (pastOrders.size() > 0) {
      ShoppingOrder pastOrder=(ShoppingOrder)pastOrders.iterator().next();
      order=(ShoppingOrder)pastOrder.clone();
    }
    String orderId=_getOrderId();
    if (order == null) {
      order=ShoppingOrderUtil.create(orderId);
    }
 else {
      order.setOrderId(orderId);
    }
    Date now=new Date();
    order.setCompanyId(user.getCompanyId());
    order.setUserId(user.getUserId());
    order.setCreateDate(now);
    order.setModifiedDate(now);
    order.setPpPaymentStatus(ShoppingOrder.STATUS_LATEST);
    order.setSendOrderEmail(true);
    order.setSendShippingEmail(true);
    ShoppingOrderUtil.update(order);
  }
 else {
    order=(ShoppingOrder)orders.iterator().next();
  }
  return order;
}
