{
  UploadServletRequest uploadServletRequest=null;
  String contentType=request.getHeader(HttpHeaders.CONTENT_TYPE);
  if ((contentType != null) && contentType.startsWith(ContentTypes.MULTIPART_FORM_DATA)) {
    String portletId=ParamUtil.getString(request,"p_p_id");
    if (Validator.isNotNull(portletId)) {
      long companyId=PortalUtil.getCompanyId(request);
      Portlet portlet=PortletLocalServiceUtil.getPortletById(companyId,portletId);
      if (portlet != null) {
        ServletContext servletContext=(ServletContext)request.getAttribute(WebKeys.CTX);
        InvokerPortlet invokerPortlet=PortletInstanceFactoryUtil.create(portlet,servletContext);
        LiferayPortletConfig liferayPortletConfig=(LiferayPortletConfig)invokerPortlet.getPortletConfig();
        if (invokerPortlet.isStrutsPortlet() || liferayPortletConfig.isCopyRequestParameters() || !liferayPortletConfig.isWARFile()) {
          request.setAttribute(UploadServletRequestFilter.COPY_MULTIPART_STREAM_TO_FILE,Boolean.FALSE);
        }
      }
    }
    uploadServletRequest=PortalUtil.getUploadServletRequest(request);
  }
  if (uploadServletRequest == null) {
    processFilter(UploadServletRequestFilter.class,request,response,filterChain);
  }
 else {
    try {
      processFilter(UploadServletRequestFilter.class,uploadServletRequest,response,filterChain);
    }
  finally {
      uploadServletRequest.cleanUp();
    }
  }
}
