{
  User user=userPersistence.findByPrimaryKey(serviceContext.getUserId());
  formStructureId=formStructureId.trim().toUpperCase();
  Date now=new Date();
  try {
    xsd=FormsXMLUtil.formatXML(xsd);
  }
 catch (  Exception e) {
    throw new FormStructureXsdException();
  }
  if (autoFormStructureId) {
    formStructureId=String.valueOf(counterLocalService.increment());
  }
  validate(groupId,formStructureId,autoFormStructureId,name,xsd);
  long id=counterLocalService.increment();
  FormStructure formStructure=formStructurePersistence.create(id);
  formStructure.setUuid(serviceContext.getUuid());
  formStructure.setFormStructureId(formStructureId);
  formStructure.setGroupId(serviceContext.getScopeGroupId());
  formStructure.setCompanyId(user.getCompanyId());
  formStructure.setUserId(user.getUserId());
  formStructure.setUserName(user.getFullName());
  formStructure.setCreateDate(serviceContext.getCreateDate(now));
  formStructure.setModifiedDate(serviceContext.getModifiedDate(now));
  formStructure.setName(name);
  formStructure.setDescription(description);
  formStructure.setXsd(xsd);
  formStructurePersistence.update(formStructure,false);
  if (serviceContext.getAddCommunityPermissions() || serviceContext.getAddGuestPermissions()) {
    addFormStructureResources(formStructure,serviceContext.getAddCommunityPermissions(),serviceContext.getAddGuestPermissions());
  }
 else {
    addFormStructureResources(formStructure,serviceContext.getCommunityPermissions(),serviceContext.getGuestPermissions());
  }
  ExpandoBridge expandoBridge=formStructure.getExpandoBridge();
  expandoBridge.setAttributes(serviceContext);
  return formStructure;
}
