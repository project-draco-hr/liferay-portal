{
  ThemeDisplay themeDisplay=(ThemeDisplay)resourceRequest.getAttribute(WebKeys.THEME_DISPLAY);
  long messageId=ParamUtil.getLong(resourceRequest,"messageId");
  String fileName=ParamUtil.getString(resourceRequest,"attachment");
  MBMessage message=MBMessageLocalServiceUtil.getMessage(messageId);
  if (!PrivateMessagingUtil.isUserPartOfThread(themeDisplay.getUserId(),message.getThreadId())) {
    throw new PrincipalException();
  }
  FileEntry fileEntry=PortletFileRepositoryUtil.getPortletFileEntry(message.getGroupId(),message.getAttachmentsFolderId(),fileName);
  PortletResponseUtil.sendFile(resourceRequest,resourceResponse,fileName,fileEntry.getContentStream(),(int)fileEntry.getSize(),fileEntry.getMimeType());
}
