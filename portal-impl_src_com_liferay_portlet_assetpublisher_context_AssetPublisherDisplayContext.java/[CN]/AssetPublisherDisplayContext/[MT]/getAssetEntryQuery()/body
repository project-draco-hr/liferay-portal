{
  ThemeDisplay themeDisplay=(ThemeDisplay)_request.getAttribute(WebKeys.THEME_DISPLAY);
  AssetEntryQuery assetEntryQuery=AssetPublisherUtil.getAssetEntryQuery(_portletPreferences,getGroupIds(),getAllAssetCategoryIds(),getAllAssetTagNames());
  String portletName=getPortletName();
  if (!portletName.equals(PortletKeys.RELATED_ASSETS)) {
    assetEntryQuery.setGroupIds(getGroupIds());
  }
  assetEntryQuery.setClassTypeIds(getClassTypeIds());
  assetEntryQuery.setEnablePermissions(isEnablePermissions());
  assetEntryQuery.setExcludeZeroViewCount(isExcludeZeroViewCount());
  configureSubtypeFieldFilter(assetEntryQuery,themeDisplay.getLocale());
  if (isShowOnlyLayoutAssets()) {
    assetEntryQuery.setLayout(themeDisplay.getLayout());
  }
  if (portletName.equals(PortletKeys.RELATED_ASSETS)) {
    AssetEntry layoutAssetEntry=(AssetEntry)_request.getAttribute(WebKeys.LAYOUT_ASSET_ENTRY);
    if (layoutAssetEntry != null) {
      assetEntryQuery.setLinkedAssetEntryId(layoutAssetEntry.getEntryId());
    }
  }
  assetEntryQuery.setPaginationType(getPaginationType());
  assetEntryQuery.setOrderByCol1(getOrderByColumn1());
  assetEntryQuery.setOrderByCol2(getOrderByColumn2());
  assetEntryQuery.setOrderByType1(getOrderByType1());
  assetEntryQuery.setOrderByType2(getOrderByType2());
  AssetPublisherUtil.processAssetEntryQuery(themeDisplay.getUser(),_portletPreferences,assetEntryQuery);
  return assetEntryQuery;
}
