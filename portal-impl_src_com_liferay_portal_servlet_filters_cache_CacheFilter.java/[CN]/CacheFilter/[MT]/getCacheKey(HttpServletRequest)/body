{
  StringBundler sb=new StringBundler(13);
  sb.append(HttpUtil.getProtocol(request));
  sb.append(Http.PROTOCOL_DELIMITER);
  sb.append(request.getContextPath());
  sb.append(request.getServletPath());
  sb.append(request.getPathInfo());
  sb.append(StringPool.QUESTION);
  String queryString=request.getQueryString();
  if (queryString == null) {
    queryString=(String)request.getAttribute(JavaConstants.JAVAX_SERVLET_FORWARD_QUERY_STRING);
    if (queryString == null) {
      String url=(String)request.getAttribute(WebKeys.CURRENT_COMPLETE_URL);
      int pos=url.indexOf(StringPool.QUESTION);
      if (pos > -1) {
        queryString=url.substring(pos + 1);
      }
    }
  }
  if (queryString != null) {
    sb.append(queryString);
  }
  sb.append(StringPool.POUND);
  String languageId=(String)request.getAttribute(WebKeys.I18N_LANGUAGE_ID);
  if (Validator.isNull(languageId)) {
    languageId=LanguageUtil.getLanguageId(request);
  }
  sb.append(languageId);
  String userAgent=GetterUtil.getString(request.getHeader(HttpHeaders.USER_AGENT));
  sb.append(StringPool.POUND);
  sb.append(userAgent.toLowerCase().hashCode());
  sb.append(StringPool.POUND);
  sb.append(BrowserSnifferUtil.acceptsGzip(request));
  return sb.toString().trim().toUpperCase();
}
