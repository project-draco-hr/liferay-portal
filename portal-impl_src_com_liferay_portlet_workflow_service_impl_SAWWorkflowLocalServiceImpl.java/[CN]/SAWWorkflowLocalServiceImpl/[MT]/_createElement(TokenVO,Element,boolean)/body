{
  Element tokenEl=root.addElement("token");
  DocUtil.add(tokenEl,"tokenId",token.getId());
  DocUtil.add(tokenEl,"name",token.getNode().getName());
  if (token.getNode().toString().startsWith("Join")) {
    DocUtil.add(tokenEl,"type","join");
  }
 else {
    DocUtil.add(tokenEl,"type","default");
  }
  String userId=_getLoggedInUserId();
  List<TaskVO> tasks=_getCurrentTasks(new Long(token.getBusinessProcessInstance().getId()).longValue(),new Long(token.getId()).longValue(),userId);
  if (tasks == null) {
    Element task=tokenEl.addElement("task");
    task.addElement("taskId").addText("null");
  }
 else {
    for (int i=0; i < tasks.size(); i++) {
      TaskVO task=tasks.get(i);
      _createElement(task,tokenEl);
    }
  }
  if (checkChildren) {
    Map activeChildren=_getActiveChildren(new Long(token.getBusinessProcessInstance().getId()).longValue());
    if (_hasActiveChildren(activeChildren)) {
      Iterator itr=activeChildren.values().iterator();
      while (itr.hasNext()) {
        TokenVO child=(TokenVO)itr.next();
        _createElement(child,tokenEl,false);
      }
    }
  }
}
