{
  ThemeDisplay themeDisplay=(ThemeDisplay)portletRequest.getAttribute(WebKeys.THEME_DISPLAY);
  boolean allDay=ParamUtil.getBoolean(portletRequest,"allDay");
  if (allDay) {
    return TimeZoneUtil.getTimeZone(StringPool.UTC);
  }
  PortletPreferences preferences=portletRequest.getPreferences();
  User user=themeDisplay.getUser();
  String timeZoneId=preferences.getValue("timeZoneId",user.getTimeZoneId());
  if (Validator.isNull(timeZoneId)) {
    timeZoneId=user.getTimeZoneId();
  }
  return TimeZone.getTimeZone(timeZoneId);
}
