{
  String servletPath=request.getServletPath();
  String pathInfo=URLDecoder.decode(request.getPathInfo(),"UTF-8");
  String path=servletPath.concat(pathInfo);
  if (!isAllowedPath(path)) {
    response.setStatus(HttpServletResponse.SC_NOT_FOUND);
    return;
  }
  File file=new File(_tempDir,path);
  if (!file.exists() || file.isDirectory() || !file.canRead()|| file.isHidden()|| !file.getCanonicalPath().startsWith(_tempDir.getCanonicalPath())) {
    response.setStatus(HttpServletResponse.SC_NOT_FOUND);
    return;
  }
  long lastModified=file.lastModified();
  if (lastModified > 0) {
    long ifModifiedSince=request.getDateHeader(HttpHeaders.IF_MODIFIED_SINCE);
    if ((ifModifiedSince > 0) && (ifModifiedSince == lastModified)) {
      response.setStatus(HttpServletResponse.SC_NOT_MODIFIED);
      return;
    }
  }
  if (lastModified > 0) {
    response.setDateHeader(HttpHeaders.LAST_MODIFIED,lastModified);
  }
  String fileName=file.getName();
  String contentType=MimeTypesUtil.getContentType(fileName);
  if (isSupportsRangeHeader(contentType)) {
    sendFileWithRangeHeader(request,response,fileName,new FileInputStream(file),file.length(),contentType);
  }
 else {
    ServletResponseUtil.sendFile(request,response,fileName,new FileInputStream(file),file.length(),contentType);
  }
}
