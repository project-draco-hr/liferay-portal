{
  if (!MBUtil.isRegularCategoryId(parentCategoryId)) {
    return parentCategoryId;
  }
  if (category.getCategoryId() == parentCategoryId) {
    return category.getParentCategoryId();
  }
 else {
    MBCategory parentCategory=mbCategoryPersistence.fetchByPrimaryKey(parentCategoryId);
    if ((parentCategory == null) || (category.getGroupId() != parentCategory.getGroupId())) {
      return category.getParentCategoryId();
    }
    List<Long> subcategoryIds=new ArrayList<Long>();
    getSubcategoryIds(subcategoryIds,category.getGroupId(),category.getCategoryId());
    if (subcategoryIds.contains(parentCategoryId)) {
      return category.getParentCategoryId();
    }
    return parentCategoryId;
  }
}
