{
  Iterator itr=mbCategoryPersistence.findByG_P(fromCategory.getGroupId(),fromCategory.getCategoryId()).iterator();
  while (itr.hasNext()) {
    MBCategory category=(MBCategory)itr.next();
    mergeCategories(category,toCategoryId);
  }
  Iterator itr1=mbThreadPersistence.findByCategoryId(fromCategory.getCategoryId()).iterator();
  while (itr1.hasNext()) {
    MBThread thread=(MBThread)itr1.next();
    thread.setCategoryId(toCategoryId);
    mbThreadPersistence.update(thread);
    Iterator itr2=mbMessagePersistence.findByThreadId(thread.getThreadId()).iterator();
    while (itr2.hasNext()) {
      MBMessage message=(MBMessage)itr2.next();
      message.setCategoryId(toCategoryId);
      mbMessagePersistence.update(message);
      try {
        if (!fromCategory.isDiscussion()) {
          String[] tagsEntries=tagsEntryLocalService.getEntryNames(MBMessage.class.getName(),message.getMessageId());
          Indexer.updateMessage(message.getCompanyId(),fromCategory.getGroupId(),message.getUserName(),toCategoryId,message.getThreadId(),message.getMessageId(),message.getSubject(),message.getBody(),tagsEntries);
        }
      }
 catch (      IOException ioe) {
        _log.error("Indexing " + message.getMessageId(),ioe);
      }
    }
  }
  mbCategoryPersistence.remove(fromCategory.getCategoryId());
}
