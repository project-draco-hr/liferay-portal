{
  double tax=0.0;
  ShoppingConfig shoppingConfig=null;
  Iterator itr=items.entrySet().iterator();
  while (itr.hasNext()) {
    Map.Entry entry=(Map.Entry)itr.next();
    ShoppingCartItem cartItem=(ShoppingCartItem)entry.getKey();
    ShoppingItem item=cartItem.getItem();
    if (shoppingConfig == null) {
      shoppingConfig=AdminConfigServiceUtil.getShoppingConfig(item.getCompanyId());
      break;
    }
  }
  if (shoppingConfig != null) {
    if (shoppingConfig.getTaxState().equals(stateId)) {
      double subtotal=0.0;
      itr=items.entrySet().iterator();
      while (itr.hasNext()) {
        Map.Entry entry=(Map.Entry)itr.next();
        ShoppingCartItem cartItem=(ShoppingCartItem)entry.getKey();
        Integer count=(Integer)entry.getValue();
        ShoppingItem item=cartItem.getItem();
        if (item.isTaxable()) {
          subtotal+=calculatePrice(item,count.intValue());
        }
      }
      tax=shoppingConfig.getTaxRate() * subtotal;
    }
  }
  return tax;
}
