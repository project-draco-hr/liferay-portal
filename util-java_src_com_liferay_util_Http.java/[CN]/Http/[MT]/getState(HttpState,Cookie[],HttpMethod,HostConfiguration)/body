{
  if (state == null) {
    state=new HttpState();
  }
  if ((cookies != null) && (cookies.length > 0)) {
    state.addCookies(cookies);
    method.getParams().setCookiePolicy(CookiePolicy.BROWSER_COMPATIBILITY);
  }
  Credentials proxyCredentials=_instance._proxyCredentials;
  String host=hostConfig.getHost();
  if (hasProxyConfig() && !isNonProxyHost(host) && proxyCredentials != null) {
    AuthScope scope=new AuthScope(PROXY_HOST,PROXY_PORT,null);
    state.setProxyCredentials(scope,proxyCredentials);
  }
  return state;
}
