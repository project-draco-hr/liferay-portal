{
  HttpSession session=getSession();
  Map<String,WSRPConsumerManager> wsrpConsumerManagers=null;
  if (session != null) {
    TransientValue<Map<String,WSRPConsumerManager>> transientValue=(TransientValue<Map<String,WSRPConsumerManager>>)session.getAttribute(WebKeys.WSRP_CONSUMER_MANAGERS);
    if (transientValue == null) {
      transientValue=new TransientValue<>(new ConcurrentHashMap<String,WSRPConsumerManager>());
      session.setAttribute(WebKeys.WSRP_CONSUMER_MANAGERS,transientValue);
    }
    wsrpConsumerManagers=transientValue.getValue();
  }
  if (wsrpConsumerManagers == null) {
    wsrpConsumerManagers=_wsrpConsumerManagers;
  }
  WSRPConsumerManager wsrpConsumerManager=wsrpConsumerManagers.get(url);
  if (wsrpConsumerManager == null) {
    String userToken=_getUserToken();
    wsrpConsumerManager=new WSRPConsumerManager(url,registrationContext,forwardCookies,forwardHeaders,userToken);
    wsrpConsumerManagers.put(url,wsrpConsumerManager);
  }
  return wsrpConsumerManager;
}
