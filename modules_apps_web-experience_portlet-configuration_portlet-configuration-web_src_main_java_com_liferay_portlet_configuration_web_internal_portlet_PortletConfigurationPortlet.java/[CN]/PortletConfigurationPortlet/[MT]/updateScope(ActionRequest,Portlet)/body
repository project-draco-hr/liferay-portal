{
  ThemeDisplay themeDisplay=(ThemeDisplay)actionRequest.getAttribute(WebKeys.THEME_DISPLAY);
  String oldScopeName=getOldScopeName(actionRequest,portlet);
  PortletPreferences portletPreferences=actionRequest.getPreferences();
  String[] scopes=StringUtil.split(ParamUtil.getString(actionRequest,"scope"));
  String scopeType=scopes[0];
  portletPreferences.setValue("lfrScopeType",scopeType);
  String scopeLayoutUuid=StringPool.BLANK;
  if ((scopes.length > 1) && scopeType.equals("layout")) {
    scopeLayoutUuid=scopes[1];
  }
  portletPreferences.setValue("lfrScopeLayoutUuid",scopeLayoutUuid);
  String portletTitle=getPortletTitle(actionRequest,portlet,portletPreferences);
  Tuple newScopeTuple=getNewScope(actionRequest);
  String newScopeName=(String)newScopeTuple.getObject(1);
  String newPortletTitle=PortalUtil.getNewPortletTitle(portletTitle,oldScopeName,newScopeName);
  if (!newPortletTitle.equals(portletTitle)) {
    portletPreferences.setValue("portletSetupTitle_" + themeDisplay.getLanguageId(),newPortletTitle);
    portletPreferences.setValue("portletSetupUseCustomTitle",Boolean.TRUE.toString());
  }
  portletPreferences.store();
}
