{
  if (_log.isDebugEnabled()) {
    String completeURL=HttpUtil.getCompleteURL(request);
    _log.debug("Flushing scripts buffer for " + completeURL);
  }
  request.setAttribute(SKIP_FILTER,Boolean.TRUE);
  BufferCacheServletResponse bufferCacheServletResponse=new BufferCacheServletResponse(response);
  processFilter(ScriptBufferFilter.class,request,bufferCacheServletResponse,filterChain);
  String content=bufferCacheServletResponse.getString();
  String contentType=response.getContentType();
  if ((contentType != null) && contentType.startsWith(ContentTypes.TEXT_HTML)) {
    String scriptData=AUIUtil.getScriptData(request);
    if (content.indexOf(_CLOSE_BODY) > -1) {
      content=StringUtil.replace(content,_CLOSE_BODY,scriptData.concat(_CLOSE_BODY));
    }
 else {
      content=content.concat(scriptData);
    }
    request.setAttribute(WebKeys.SCRIPT_DATA_OUTPUTED,true);
  }
  ServletResponseUtil.write(response,content);
}
