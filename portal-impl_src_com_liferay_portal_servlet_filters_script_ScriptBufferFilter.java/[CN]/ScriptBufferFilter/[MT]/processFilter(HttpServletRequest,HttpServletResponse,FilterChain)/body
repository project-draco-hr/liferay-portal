{
  if (_log.isDebugEnabled()) {
    String completeURL=HttpUtil.getCompleteURL(request);
    _log.debug("Flushing script buffer for " + completeURL);
  }
  request.setAttribute(SKIP_FILTER,Boolean.TRUE);
  BufferCacheServletResponse bufferCacheServletResponse=new BufferCacheServletResponse(response);
  processFilter(ScriptBufferFilter.class,request,bufferCacheServletResponse,filterChain);
  String content=bufferCacheServletResponse.getString();
  String contentType=response.getContentType();
  if ((contentType != null) && contentType.startsWith(ContentTypes.TEXT_HTML)) {
    String scriptData=AUIUtil.getScriptDataString(request);
    if (content.contains(_BODY_CLOSE)) {
      content=StringUtil.replace(content,_BODY_CLOSE,scriptData.concat(_BODY_CLOSE));
    }
 else {
      content=content.concat(scriptData);
    }
    request.setAttribute(WebKeys.AUI_SCRIPT_DATA_OUTPUTTED,Boolean.TRUE);
  }
  ServletResponseUtil.write(response,content);
}
