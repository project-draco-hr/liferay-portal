{
  JSONObject jsonObj=JSONFactoryUtil.createJSONObject((String)message.getPayload());
  long companyId=jsonObj.getLong("companyId");
  long userId=jsonObj.getLong("userId");
  long nodeId=jsonObj.getLong("nodeId");
  long pageResourcePrimKey=jsonObj.getLong("pageResourcePrimKey");
  String fromName=jsonObj.getString("fromName");
  String fromAddress=jsonObj.getString("fromAddress");
  String subject=jsonObj.getString("subject");
  String body=jsonObj.getString("body");
  String replyToAddress=jsonObj.getString("replyToAddress");
  String mailId=jsonObj.getString("mailId");
  Set<Long> sent=new HashSet<Long>();
  if (_log.isInfoEnabled()) {
    _log.info("Sending notifications for {mailId=" + mailId + ", pageResourcePrimKey="+ pageResourcePrimKey+ ", nodeId="+ nodeId+ "}");
  }
  List<Subscription> subscriptions=SubscriptionLocalServiceUtil.getSubscriptions(companyId,WikiPage.class.getName(),pageResourcePrimKey);
  sendEmail(userId,fromName,fromAddress,subject,body,subscriptions,sent,replyToAddress,mailId);
  subscriptions=SubscriptionLocalServiceUtil.getSubscriptions(companyId,WikiNode.class.getName(),nodeId);
  sendEmail(userId,fromName,fromAddress,subject,body,subscriptions,sent,replyToAddress,mailId);
  if (_log.isInfoEnabled()) {
    _log.info("Finished sending notifications");
  }
}
