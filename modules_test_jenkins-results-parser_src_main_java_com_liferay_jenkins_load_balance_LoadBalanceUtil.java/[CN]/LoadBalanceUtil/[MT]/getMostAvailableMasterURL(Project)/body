{
  String baseInvocationUrl=project.getProperty("base.invocation.url");
  String hostNamePrefix=getHostNamePrefix(baseInvocationUrl);
  if (hostNamePrefix.equals(baseInvocationUrl)) {
    return baseInvocationUrl;
  }
  int hostNameCount=getHostNameCount(project,hostNamePrefix);
  File baseDir=new File(project.getProperty("jenkins.shared.dir") + "/" + hostNamePrefix);
  File semaphoreFile=new File(baseDir,hostNamePrefix + ".semaphore");
  waitForTurn(semaphoreFile,hostNameCount);
  JenkinsResultsParserUtil.write(semaphoreFile,myHostName);
  List<String> coolDownList=getCoolDownList(new File(baseDir,"timeout"));
  List<String> hostNameList=new ArrayList<>(hostNameCount);
  int maxResult=Integer.MIN_VALUE;
  int x=-1;
  try {
    List<FutureTask<Integer>> taskList=new ArrayList<>(hostNameCount);
    startParallelTasks(hostNameList,hostNamePrefix,hostNameCount,project,taskList,coolDownList);
    List<Integer> badIndicies=new ArrayList<>(taskList.size());
    List<Integer> maxIndicies=new ArrayList<>(taskList.size());
    for (int i=0; i < taskList.size(); i++) {
      FutureTask<Integer> task=taskList.get(i);
      Integer result=task.get();
      System.out.println(hostNameList.get(i) + " : " + result);
      if (result == null) {
        badIndicies.add(i);
        continue;
      }
      if (result > maxResult) {
        maxResult=result;
        maxIndicies.clear();
      }
      if (result >= maxResult) {
        maxIndicies.add(i);
      }
    }
    if (maxIndicies.size() > 0) {
      x=maxIndicies.get(getRandomValue(0,maxIndicies.size() - 1));
    }
 else {
      while (true) {
        x=getRandomValue(0,hostNameCount - 1);
        if (badIndicies.contains(x)) {
          continue;
        }
        break;
      }
    }
    JenkinsResultsParserUtil.write(new File(baseDir,"timeout/" + hostNameList.get(x)),Long.toString(System.currentTimeMillis()));
    System.out.println("Most available master: " + hostNameList.get(x) + " with "+ maxResult+ " available slaves.");
  }
  finally {
    JenkinsResultsParserUtil.write(semaphoreFile,"");
  }
  return hostNameList.get(x);
}
