{
  int retries=0;
  while (true) {
    String baseInvocationURL=project.getProperty("base.invocation.url");
    String hostNamePrefix=getHostNamePrefix(baseInvocationURL);
    if (hostNamePrefix.equals(baseInvocationURL)) {
      return baseInvocationURL;
    }
    int hostNameCount=getHostNameCount(project,hostNamePrefix);
    File baseDir=new File(project.getProperty("jenkins.shared.dir") + "/" + hostNamePrefix);
    File semaphoreFile=new File(baseDir,hostNamePrefix + ".semaphore");
    waitForTurn(semaphoreFile,hostNameCount);
    JenkinsResultsParserUtil.write(semaphoreFile,_MY_HOST_NAME);
    Map<String,Integer> recentJobsMap=getRecentJobCountsMap(new File(baseDir,"recentJobs"));
    List<String> hostNames=new ArrayList<>(hostNameCount);
    int maxAvailableCount=Integer.MIN_VALUE;
    int x=-1;
    try {
      List<FutureTask<Integer>> futureTasks=new ArrayList<>(hostNameCount);
      startParallelTasks(recentJobsMap,hostNames,hostNamePrefix,hostNameCount,project,futureTasks);
      List<Integer> badIndices=new ArrayList<>(futureTasks.size());
      List<Integer> maxIndices=new ArrayList<>(futureTasks.size());
      StringBuilder sb=new StringBuilder();
      for (int i=0; i < futureTasks.size(); i++) {
        FutureTask<Integer> futureTask=futureTasks.get(i);
        Integer availableCount=futureTask.get();
        if (availableCount == null) {
          badIndices.add(i);
          continue;
        }
        sb.append(hostNames.get(i));
        sb.append(" : ");
        sb.append(availableCount);
        sb.append("\n");
        if (availableCount > maxAvailableCount) {
          maxAvailableCount=availableCount;
          maxIndices.clear();
        }
        if (availableCount >= maxAvailableCount) {
          maxIndices.add(i);
        }
      }
      if (maxAvailableCount == Integer.MIN_VALUE) {
        if (retries == 3) {
          throw new RuntimeException("Retry limit exceeded. Unable to communicate " + " with masters.");
        }
        retries++;
        continue;
      }
      if (maxIndices.size() > 0) {
        x=maxIndices.get(getRandomValue(0,maxIndices.size() - 1));
      }
 else {
        while (true) {
          x=getRandomValue(0,hostNameCount - 1);
          if (badIndices.contains(x)) {
            continue;
          }
          break;
        }
      }
      sb.append("\nMost available master ");
      sb.append(hostNames.get(x));
      sb.append(" has ");
      sb.append(maxAvailableCount);
      sb.append(" available slaves.");
      System.out.println(sb);
      return hostNames.get(x);
    }
  finally {
      JenkinsResultsParserUtil.write(semaphoreFile,"");
      if (recentJobsPeriod > 0) {
        StringBuilder sb=new StringBuilder();
        File recentJobsFile=new File(baseDir,"recentJobs/" + hostNames.get(x));
        if (recentJobsFile.exists()) {
          sb.append(JenkinsResultsParserUtil.read(recentJobsFile));
          if (sb.length() > 0) {
            sb.append("|");
          }
        }
        String invokedJobBatchSize=project.getProperty("invoked.job.batch.size");
        if ((invokedJobBatchSize == null) || (invokedJobBatchSize.length() == 0)) {
          invokedJobBatchSize="1";
        }
        sb.append(invokedJobBatchSize);
        sb.append("-");
        sb.append(System.currentTimeMillis());
        JenkinsResultsParserUtil.write(recentJobsFile,sb.toString());
      }
    }
  }
}
