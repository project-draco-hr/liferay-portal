{
  String protocol=url.getProtocol();
  if (protocol.equals("reference")) {
    String file=url.getFile();
    url=new URL(file);
    protocol=url.getProtocol();
  }
  if (protocol.equals("file")) {
    return url.toURI();
  }
 else   if (protocol.equals("jar")) {
    String file=url.getFile();
    int pos=file.indexOf("!/");
    if (pos != -1) {
      file=file.substring(0,pos);
    }
    return new URI(file);
  }
  throw new URISyntaxException(url.toString(),"Unknown protocol " + protocol);
}
