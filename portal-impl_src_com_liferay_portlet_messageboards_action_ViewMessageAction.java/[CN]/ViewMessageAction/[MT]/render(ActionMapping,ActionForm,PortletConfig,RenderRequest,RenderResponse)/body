{
  try {
    long messageId=ParamUtil.getLong(renderRequest,"messageId");
    PortalPreferences preferences=PortletPreferencesFactoryUtil.getPortalPreferences(renderRequest);
    String threadView=ParamUtil.getString(renderRequest,"threadView");
    if (Validator.isNotNull(threadView)) {
      preferences.setValue(PortletKeys.MESSAGE_BOARDS,"thread-view",threadView);
    }
 else {
      threadView=preferences.getValue(PortletKeys.MESSAGE_BOARDS,"thread-view",PropsValues.MESSAGE_BOARDS_THREAD_VIEWS_DEFAULT);
    }
    if (!ArrayUtil.contains(PropsValues.MESSAGE_BOARDS_THREAD_VIEWS,threadView)) {
      threadView=PropsValues.MESSAGE_BOARDS_THREAD_VIEWS_DEFAULT;
      preferences.setValue(PortletKeys.MESSAGE_BOARDS,"thread-view",threadView);
    }
    MBMessageDisplay messageDisplay=MBMessageServiceUtil.getMessageDisplay(messageId,WorkflowConstants.STATUS_APPROVED,threadView);
    renderRequest.setAttribute(WebKeys.MESSAGE_BOARDS_MESSAGE,messageDisplay);
    return mapping.findForward("portlet.message_boards.view_message");
  }
 catch (  Exception e) {
    if (e instanceof NoSuchMessageException || e instanceof PrincipalException) {
      SessionErrors.add(renderRequest,e.getClass().getName());
      return mapping.findForward("portlet.message_boards.error");
    }
 else {
      throw e;
    }
  }
}
