{
  try {
    long messageId=ParamUtil.getLong(renderRequest,"messageId");
    PortalPreferences preferences=PortletPreferencesFactoryUtil.getPortalPreferences(renderRequest);
    String threadView=ParamUtil.getString(renderRequest,"threadView");
    if (Validator.isNotNull(threadView)) {
      preferences.setValue(PortletKeys.MESSAGE_BOARDS,"thread-view",threadView);
    }
 else {
      threadView=preferences.getValue(PortletKeys.MESSAGE_BOARDS,"thread-view",PropsValues.MESSAGE_BOARDS_THREAD_VIEWS_DEFAULT);
    }
    if (!ArrayUtil.contains(PropsValues.MESSAGE_BOARDS_THREAD_VIEWS,threadView)) {
      threadView=PropsValues.MESSAGE_BOARDS_THREAD_VIEWS_DEFAULT;
      preferences.setValue(PortletKeys.MESSAGE_BOARDS,"thread-view",threadView);
    }
    boolean includePrevAndNext=PropsValues.MESSAGE_BOARDS_THREAD_PREVIOUS_AND_NEXT_NAVIGATION_ENABLED;
    MBMessageDisplay messageDisplay=MBMessageServiceUtil.getMessageDisplay(messageId,WorkflowConstants.STATUS_ANY,threadView,includePrevAndNext);
    if (messageDisplay != null) {
      MBMessage message=messageDisplay.getMessage();
      if ((message != null) && (message.isInTrash() || message.isInTrashThread())) {
        throw new NoSuchMessageException();
      }
    }
    renderRequest.setAttribute(WebKeys.MESSAGE_BOARDS_MESSAGE,messageDisplay);
    return actionMapping.findForward("portlet.message_boards.view_message");
  }
 catch (  Exception e) {
    if (e instanceof NoSuchMessageException || e instanceof PrincipalException) {
      SessionErrors.add(renderRequest,e.getClass());
      return actionMapping.findForward("portlet.message_boards.error");
    }
 else {
      throw e;
    }
  }
}
