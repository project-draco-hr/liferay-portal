{
  ThemeDisplay themeDisplay=getThemeDisplay();
  String layoutTemplateId="max";
  if (themeDisplay.isStatePopUp()) {
    layoutTemplateId="pop_up";
  }
  Theme theme=themeDisplay.getTheme();
  String velocityTemplateId=theme.getThemeId() + LayoutTemplateConstants.STANDARD_SEPARATOR + layoutTemplateId;
  String content=LayoutTemplateLocalServiceUtil.getContent(layoutTemplateId,true,theme.getThemeId());
  if (Validator.isNotNull(velocityTemplateId) && Validator.isNotNull(content)) {
    HttpServletRequest request=_request;
    PortletRequestImpl portletRequestImpl=(PortletRequestImpl)_request.getAttribute(JavaConstants.JAVAX_PORTLET_REQUEST);
    HttpServletRequest newRequest=request;
    if (portletRequestImpl != null) {
      newRequest=portletRequestImpl.getOriginalHttpServletRequest();
    }
 else {
      HttpServletRequest originalServletRequest=PortalUtil.getOriginalServletRequest(request);
      boolean privateRequestAttributes=getPortlet().isPrivateRequestAttributes();
      DynamicServletRequest dynamicServletRequest=null;
      if (privateRequestAttributes) {
        String namespace=PortalUtil.getPortletNamespace(getPortletId());
        dynamicServletRequest=new NamespaceServletRequest(originalServletRequest,namespace,namespace);
      }
 else {
        dynamicServletRequest=new DynamicServletRequest(originalServletRequest);
      }
      Map<String,String[]> parameterMap=request.getParameterMap();
      for (      Map.Entry<String,String[]> entry : parameterMap.entrySet()) {
        String name=entry.getKey();
        String[] values=entry.getValue();
        String[] oldValues=request.getParameterValues(name);
        if (oldValues != null) {
          values=ArrayUtil.append(values,oldValues);
        }
        dynamicServletRequest.setParameterValues(name,values);
      }
      newRequest=dynamicServletRequest;
    }
    StringBundler sb=RuntimePageUtil.getProcessedTemplate(newRequest,_response,getPortletId(),new StringTemplateResource(velocityTemplateId,content));
    if (sb != null) {
      sb.writeTo(writer);
    }
  }
}
