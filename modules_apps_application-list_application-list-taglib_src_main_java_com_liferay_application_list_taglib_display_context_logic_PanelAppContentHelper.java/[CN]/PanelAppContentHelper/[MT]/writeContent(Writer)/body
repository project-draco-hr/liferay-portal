{
  ThemeDisplay themeDisplay=getThemeDisplay();
  String layoutTemplateId="max";
  if (themeDisplay.isStatePopUp()) {
    layoutTemplateId="pop_up";
  }
  Theme theme=themeDisplay.getTheme();
  String velocityTemplateId=theme.getThemeId() + LayoutTemplateConstants.STANDARD_SEPARATOR + layoutTemplateId;
  String content=LayoutTemplateLocalServiceUtil.getContent(layoutTemplateId,true,theme.getThemeId());
  if (Validator.isNotNull(velocityTemplateId) && Validator.isNotNull(content)) {
    HttpServletRequest request=_request;
    PortletRequestImpl portletRequestImpl=(PortletRequestImpl)_request.getAttribute(JavaConstants.JAVAX_PORTLET_REQUEST);
    if (portletRequestImpl != null) {
      request=portletRequestImpl.getOriginalHttpServletRequest();
    }
    StringBundler sb=RuntimePageUtil.getProcessedTemplate(request,_response,getPortletId(),new StringTemplateResource(velocityTemplateId,content));
    if (sb != null) {
      sb.writeTo(writer);
    }
  }
}
