{
  ThemeDisplay themeDisplay=getThemeDisplay();
  String layoutTemplateId="max";
  if (themeDisplay.isStatePopUp()) {
    layoutTemplateId="pop_up";
  }
  Theme theme=themeDisplay.getTheme();
  String velocityTemplateId=theme.getThemeId() + LayoutTemplateConstants.STANDARD_SEPARATOR + layoutTemplateId;
  String content=LayoutTemplateLocalServiceUtil.getContent(layoutTemplateId,true,theme.getThemeId());
  if (Validator.isNotNull(velocityTemplateId) && Validator.isNotNull(content)) {
    HttpServletRequest request=_request;
    PortletRequestImpl portletRequestImpl=(PortletRequestImpl)_request.getAttribute(JavaConstants.JAVAX_PORTLET_REQUEST);
    if (portletRequestImpl != null) {
      request=portletRequestImpl.getOriginalHttpServletRequest();
    }
 else {
      HttpServletRequest originalServletRequest=PortalUtil.getOriginalServletRequest(request);
      Portlet portlet=getPortlet();
      DynamicServletRequest dynamicServletRequest=null;
      if (portlet.isPrivateRequestAttributes()) {
        String namespace=PortalUtil.getPortletNamespace(getPortletId());
        dynamicServletRequest=new NamespaceServletRequest(originalServletRequest,namespace,namespace);
      }
 else {
        dynamicServletRequest=new DynamicServletRequest(originalServletRequest);
      }
      Map<String,String[]> parameterMap=request.getParameterMap();
      for (      Map.Entry<String,String[]> entry : parameterMap.entrySet()) {
        dynamicServletRequest.setParameterValues(entry.getKey(),entry.getValue());
      }
      request=dynamicServletRequest;
    }
    StringBundler sb=RuntimePageUtil.getProcessedTemplate(request,_response,getPortletId(),new StringTemplateResource(velocityTemplateId,content));
    if (sb != null) {
      sb.writeTo(writer);
    }
  }
}
