{
  ThemeDisplay themeDisplay=(ThemeDisplay)_request.getAttribute(WebKeys.THEME_DISPLAY);
  AssetEntryQuery assetEntryQuery=AssetPublisherUtil.getAssetEntryQuery(_portletPreferences,getSiteGroupIds());
  long[] classNameIds=getClassNameIds();
  long[] classTypeIds=getClassTypeIds();
  if (isSubtypeFieldsFilterEnabled() && (classNameIds.length == 1) && (classTypeIds.length == 1)&& Validator.isNotNull(getDDMStructureFieldName())&& Validator.isNotNull(getDDMStructureFieldValue())) {
    AssetRendererFactory assetRendererFactory=AssetRendererFactoryRegistryUtil.getAssetRendererFactoryByClassNameId(classNameIds[0]);
    Tuple classTypeFieldName=assetRendererFactory.getClassTypeFieldName(classTypeIds[0],getDDMStructureFieldName(),themeDisplay.getLocale());
    long ddmStructureId=GetterUtil.getLong(classTypeFieldName.getObject(3));
    assetEntryQuery.setAttribute("ddmStructureFieldName",DDMIndexerUtil.encodeName(ddmStructureId,getDDMStructureFieldName(),themeDisplay.getLocale()));
    assetEntryQuery.setAttribute("ddmStructureFieldValue",getDDMStructureFieldValue());
  }
  assetEntryQuery.setAllCategoryIds(getAllAssetCategoryIds());
  assetEntryQuery.setAllTagIds(AssetTagLocalServiceUtil.getTagIds(getSiteGroupIds(),getAllAssetTagNames()));
  assetEntryQuery.setClassTypeIds(classTypeIds);
  assetEntryQuery.setEnablePermissions(isEnablePermissions());
  assetEntryQuery.setExcludeZeroViewCount(isExcludeZeroViewCount());
  String portletName=getPortletName();
  if (!portletName.equals(PortletKeys.RELATED_ASSETS)) {
    assetEntryQuery.setGroupIds(getGroupIds());
  }
  if (isShowOnlyLayoutAssets()) {
    assetEntryQuery.setLayout(themeDisplay.getLayout());
  }
  if (portletName.equals(PortletKeys.RELATED_ASSETS)) {
    AssetEntry layoutAssetEntry=(AssetEntry)_request.getAttribute(WebKeys.LAYOUT_ASSET_ENTRY);
    if (layoutAssetEntry != null) {
      assetEntryQuery.setLinkedAssetEntryId(layoutAssetEntry.getEntryId());
    }
  }
  assetEntryQuery.setPaginationType(getPaginationType());
  assetEntryQuery.setOrderByCol1(getOrderByColumn1());
  assetEntryQuery.setOrderByCol2(getOrderByColumn2());
  assetEntryQuery.setOrderByType1(getOrderByType1());
  assetEntryQuery.setOrderByType2(getOrderByType2());
  AssetPublisherUtil.processAssetEntryQuery(themeDisplay.getUser(),_portletPreferences,assetEntryQuery);
  return assetEntryQuery;
}
