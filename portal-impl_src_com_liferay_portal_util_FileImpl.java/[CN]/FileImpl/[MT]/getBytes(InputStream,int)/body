{
  ByteArrayOutputStream baos=null;
  if (bufferSize <= 0) {
    baos=new ByteArrayOutputStream();
  }
 else {
    baos=new ByteArrayOutputStream(bufferSize);
  }
  boolean createBuffered=false;
  try {
    if (!(is instanceof BufferedInputStream)) {
      is=new BufferedInputStream(is);
      createBuffered=true;
    }
    int c=is.read();
    while (c != -1) {
      baos.write(c);
      c=is.read();
    }
  }
  finally {
    if (createBuffered) {
      is.close();
    }
  }
  baos.close();
  return baos.toByteArray();
}
