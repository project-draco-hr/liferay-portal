{
  String text=null;
  try {
    if (!is.markSupported()) {
      is=new BufferedInputStream(is);
    }
    String contentType=MimeTypesUtil.getContentType(is,fileName);
    TextExtractor textExtractor=_textExtractors.get(contentType);
    if (textExtractor != null) {
      if (_log.isInfoEnabled()) {
        _log.info("Using text extractor " + textExtractor.getClass().getName());
      }
      StringBuilder sb=new StringBuilder();
      Reader reader=null;
      if (ServerDetector.isJOnAS() && JavaProps.isJDK6() && contentType.equals(ContentTypes.APPLICATION_MSWORD)) {
        if (_log.isWarnEnabled()) {
          _log.warn("JOnAS 5 with JDK 6 has a known issue with text " + "extraction of Word documents. Use JDK 5 if " + "you require indexing of Word documents.");
        }
        if (_log.isDebugEnabled()) {
          reader=textExtractor.extractText(is,contentType,null);
        }
 else {
          reader=new StringReader(StringPool.BLANK);
        }
      }
 else {
        reader=textExtractor.extractText(is,contentType,null);
      }
      try {
        char[] buffer=new char[1024];
        int result=-1;
        while ((result=reader.read(buffer)) != -1) {
          sb.append(buffer,0,result);
        }
      }
  finally {
        try {
          reader.close();
        }
 catch (        IOException ioe) {
        }
      }
      text=sb.toString();
    }
 else {
      if (contentType.equals(ContentTypes.APPLICATION_ZIP) || contentType.startsWith("application/vnd.openxmlformats-officedocument.")) {
        try {
          POITextExtractor poiTextExtractor=ExtractorFactory.createExtractor(is);
          text=poiTextExtractor.getText();
        }
 catch (        Exception e) {
          if (_log.isWarnEnabled()) {
            _log.warn(e,e);
          }
        }
      }
      if ((text == null) && _log.isInfoEnabled()) {
        _log.info("No text extractor found for " + fileName);
      }
    }
  }
 catch (  Exception e) {
    _log.error(e,e);
  }
  if (_log.isDebugEnabled()) {
    _log.debug("Extractor returned text:\n\n" + text);
  }
  if (text == null) {
    text=StringPool.BLANK;
  }
  return text;
}
