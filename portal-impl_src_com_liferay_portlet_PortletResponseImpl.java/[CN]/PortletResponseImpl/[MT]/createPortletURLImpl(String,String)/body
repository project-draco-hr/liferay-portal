{
  long plid=_plid;
  try {
    Layout layout=(Layout)_portletRequestImpl.getAttribute(WebKeys.LAYOUT);
    PortletPreferences portletSetup=PortletPreferencesFactoryUtil.getLayoutPortletSetup(layout,_portletName);
    plid=GetterUtil.getLong(portletSetup.getValue("portlet-setup-link-to-plid",String.valueOf(_plid)));
    if (plid <= 0) {
      plid=_plid;
    }
  }
 catch (  SystemException e) {
    if (_log.isWarnEnabled()) {
      _log.warn(e);
    }
  }
  PortletURLImpl portletURLImpl=null;
  Portlet portlet=getPortlet();
  String portletURLClass=portlet.getPortletURLClass();
  if (portlet.getPortletId().equals(portletName) && Validator.isNotNull(portletURLClass)) {
    try {
      Class<?> portletURLClassObj=Class.forName(portletURLClass);
      Constructor<?> constructor=portletURLClassObj.getConstructor(new Class[]{com.liferay.portlet.PortletResponseImpl.class,long.class,String.class});
      portletURLImpl=(PortletURLImpl)constructor.newInstance(new Object[]{this,plid,lifecycle});
    }
 catch (    Exception e) {
      _log.error(e);
    }
  }
  if (portletURLImpl == null) {
    portletURLImpl=new PortletURLImpl(_portletRequestImpl,portletName,plid,lifecycle);
  }
  PortletApp portletApp=portlet.getPortletApp();
  Set<PortletURLListener> portletURLListeners=portletApp.getPortletURLListeners();
  for (  PortletURLListener portletURLListener : portletURLListeners) {
    try {
      PortletURLGenerationListener portletURLGenerationListener=PortletURLListenerFactory.create(portletURLListener);
      if (lifecycle.equals(PortletRequest.ACTION_PHASE)) {
        portletURLGenerationListener.filterActionURL(portletURLImpl);
      }
 else       if (lifecycle.equals(PortletRequest.RENDER_PHASE)) {
        portletURLGenerationListener.filterRenderURL(portletURLImpl);
      }
 else       if (lifecycle.equals(PortletRequest.RESOURCE_PHASE)) {
        portletURLGenerationListener.filterResourceURL(portletURLImpl);
      }
    }
 catch (    PortletException pe) {
      _log.error(pe,pe);
    }
  }
  if (!lifecycle.equals(PortletRequest.RESOURCE_PHASE)) {
    try {
      portletURLImpl.setWindowState(_portletRequestImpl.getWindowState());
    }
 catch (    WindowStateException wse) {
      _log.error(wse.getMessage());
    }
    try {
      portletURLImpl.setPortletMode(_portletRequestImpl.getPortletMode());
    }
 catch (    PortletModeException pme) {
      _log.error(pme.getMessage());
    }
  }
 else {
    portletURLImpl.setCopyCurrentRenderParameters(true);
  }
  return portletURLImpl;
}
