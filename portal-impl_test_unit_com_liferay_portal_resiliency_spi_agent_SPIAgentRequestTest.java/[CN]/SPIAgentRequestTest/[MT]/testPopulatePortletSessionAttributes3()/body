{
  ConcurrentMap<String,Object> attributes=LocalProcessLauncher.ProcessContext.getAttributes();
  attributes.put(SPI.SPI_INSTANCE_PUBLICATION_KEY,new MockSPI());
  final List<String> names=new ArrayList<>();
  MockHttpServletRequest mockHttpServletRequest=new BackwardCompatibleMockHttpServletRequest(){
    @Override public Object getAttribute(    String name){
      names.add(name);
      return super.getAttribute(name);
    }
  }
;
  MockHttpSession mockHttpSession=new MockHttpSession();
  SPIAgentRequest.populatePortletSessionAttributes(mockHttpServletRequest,mockHttpSession);
  Assert.assertEquals(2,names.size());
  Assert.assertEquals(WebKeys.PORTLET_SESSION,names.get(0));
  Assert.assertEquals(WebKeys.SPI_AGENT_REQUEST,names.get(1));
  Enumeration<String> enumeration=mockHttpServletRequest.getAttributeNames();
  Assert.assertFalse(enumeration.hasMoreElements());
  enumeration=mockHttpSession.getAttributeNames();
  Assert.assertFalse(enumeration.hasMoreElements());
}
