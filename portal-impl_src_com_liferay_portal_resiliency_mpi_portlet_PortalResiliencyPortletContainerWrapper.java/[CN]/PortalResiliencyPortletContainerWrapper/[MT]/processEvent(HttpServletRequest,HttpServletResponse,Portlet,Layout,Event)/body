{
  SPIAgent spiAgent=_getSPIAgentForPortlet(portlet);
  if (spiAgent == null) {
    return _portletContainer.processEvent(request,response,portlet,layout,event);
  }
  request.setAttribute(WebKeys.SPI_AGENT_LIFECYCLE,SPIAgent.Lifecycle.EVENT);
  request.setAttribute(WebKeys.SPI_AGENT_PORTLET,portlet);
  request.setAttribute(WebKeys.SPI_AGENT_LAYOUT,layout);
  request.setAttribute(WebKeys.SPI_AGENT_EVENT,event);
  try {
    spiAgent.service(request,response);
    return (List<Event>)request.getAttribute(WebKeys.SPI_AGENT_EVENT_RESULT);
  }
 catch (  PortalResiliencyException pre) {
    _log.error(pre,pre);
    return Collections.emptyList();
  }
 finally {
    request.removeAttribute(WebKeys.SPI_AGENT_LIFECYCLE);
    request.removeAttribute(WebKeys.SPI_AGENT_PORTLET);
    request.removeAttribute(WebKeys.SPI_AGENT_LAYOUT);
    request.removeAttribute(WebKeys.SPI_AGENT_EVENT);
    request.removeAttribute(WebKeys.SPI_AGENT_EVENT_RESULT);
  }
}
