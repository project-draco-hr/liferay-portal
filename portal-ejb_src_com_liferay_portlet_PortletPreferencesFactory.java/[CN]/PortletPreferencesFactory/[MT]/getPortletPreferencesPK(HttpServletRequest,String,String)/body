{
  ThemeDisplay themeDisplay=(ThemeDisplay)req.getAttribute(WebKeys.THEME_DISPLAY);
  Layout layout=themeDisplay.getLayout();
  LayoutTypePortlet layoutTypePortlet=themeDisplay.getLayoutTypePortlet();
  Portlet portlet=PortletLocalServiceUtil.getPortletById(themeDisplay.getCompanyId(),portletId);
  String layoutId=null;
  String ownerId=null;
  boolean modeEditGuest=false;
  String portletMode=ParamUtil.getString(req,"p_p_mode");
  if (portletMode.equals(LiferayPortletMode.EDIT_GUEST.toString()) || layoutTypePortlet.hasModeEditGuestPortletId(portletId)) {
    modeEditGuest=true;
  }
  if (modeEditGuest) {
    if (!layout.isPrivateLayout() && themeDisplay.isShowAddContentIcon()) {
    }
 else {
      throw new PrincipalException();
    }
  }
  if (portlet.isPreferencesCompanyWide()) {
    layoutId=PortletKeys.PREFS_LAYOUT_ID_SHARED;
    ownerId=PortletKeys.PREFS_OWNER_ID_COMPANY + StringPool.PERIOD + themeDisplay.getCompanyId();
  }
 else {
    if (portlet.isPreferencesUniquePerLayout()) {
      layoutId=LayoutImpl.getLayoutId(selPlid);
      ownerId=LayoutImpl.getOwnerId(selPlid);
      if (portlet.isPreferencesOwnedByGroup()) {
      }
 else {
        String userId=PortalUtil.getUserId(req);
        if ((userId == null) || modeEditGuest) {
          userId=UserImpl.getDefaultUserId(themeDisplay.getCompanyId());
        }
        ownerId+=StringPool.PERIOD + PortletKeys.PREFS_OWNER_ID_USER + StringPool.PERIOD+ userId;
      }
    }
 else {
      layoutId=PortletKeys.PREFS_LAYOUT_ID_SHARED;
      ownerId=LayoutImpl.getOwnerId(selPlid);
      if (portlet.isPreferencesOwnedByGroup()) {
        ownerId=PortletKeys.PREFS_OWNER_ID_GROUP + StringPool.PERIOD + LayoutImpl.getGroupId(ownerId);
      }
 else {
        String userId=PortalUtil.getUserId(req);
        if ((userId == null) || modeEditGuest) {
          userId=UserImpl.getDefaultUserId(themeDisplay.getCompanyId());
        }
        ownerId=PortletKeys.PREFS_OWNER_ID_USER + StringPool.PERIOD + userId;
      }
    }
  }
  return new PortletPreferencesPK(portletId,layoutId,ownerId);
}
