{
  String companyId=PortalUtil.getCompanyId(req);
  Portlet portlet=PortletLocalServiceUtil.getPortletById(companyId,portletId);
  String layoutId=null;
  String ownerId=null;
  if (portlet.isPreferencesCompanyWide()) {
    layoutId=PortletKeys.PREFS_LAYOUT_ID_SHARED;
    ownerId=PortletKeys.PREFS_OWNER_ID_COMPANY + StringPool.PERIOD + companyId;
  }
 else {
    if (portlet.isPreferencesUniquePerLayout()) {
      layoutId=Layout.getLayoutId(selPlid);
      ownerId=Layout.getOwnerId(selPlid);
      if (portlet.isPreferencesOwnedByGroup()) {
      }
 else {
        String userId=PortalUtil.getUserId(req);
        if (userId == null) {
          userId=User.getDefaultUserId(companyId);
        }
        ownerId+=StringPool.PERIOD + PortletKeys.PREFS_OWNER_ID_USER + StringPool.PERIOD+ userId;
      }
    }
 else {
      layoutId=PortletKeys.PREFS_LAYOUT_ID_SHARED;
      ownerId=Layout.getOwnerId(selPlid);
      if (portlet.isPreferencesOwnedByGroup()) {
        ownerId=PortletKeys.PREFS_OWNER_ID_GROUP + StringPool.PERIOD + Layout.getGroupId(ownerId);
      }
 else {
        String userId=PortalUtil.getUserId(req);
        if (userId == null) {
          userId=User.getDefaultUserId(companyId);
        }
        ownerId=PortletKeys.PREFS_OWNER_ID_USER + StringPool.PERIOD + userId;
      }
    }
  }
  return new PortletPreferencesPK(portletId,layoutId,ownerId);
}
