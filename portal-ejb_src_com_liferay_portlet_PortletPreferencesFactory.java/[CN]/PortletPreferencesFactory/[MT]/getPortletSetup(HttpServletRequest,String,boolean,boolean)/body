{
  Layout layout=(Layout)req.getAttribute(WebKeys.LAYOUT);
  String layoutId=layout.getLayoutId();
  String ownerId=layout.getOwnerId();
  if (!uniquePerLayout) {
    layoutId=PortletKeys.PREFS_LAYOUT_ID_SHARED;
    if (uniquePerGroup) {
      ownerId=PortletKeys.PREFS_OWNER_ID_GROUP + StringPool.PERIOD + LayoutImpl.getGroupId(ownerId);
    }
 else {
      ownerId=PortletKeys.PREFS_OWNER_ID_COMPANY + StringPool.PERIOD + layout.getCompanyId();
    }
  }
  return PortletPreferencesLocalServiceUtil.getPreferences(layout.getCompanyId(),ownerId,layoutId,portletId);
}
