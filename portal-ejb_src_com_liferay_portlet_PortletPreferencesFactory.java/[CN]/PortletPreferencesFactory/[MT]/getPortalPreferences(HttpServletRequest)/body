{
  PortalPreferences portalPrefs=null;
  String portletId=PortletKeys.LIFERAY_PORTAL;
  String layoutId=PortletKeys.PREFS_LAYOUT_ID_SHARED;
  ThemeDisplay themeDisplay=(ThemeDisplay)req.getAttribute(WebKeys.THEME_DISPLAY);
  PortletPreferencesPK pk=new PortletPreferencesPK(portletId,layoutId,themeDisplay.getUserId());
  if (themeDisplay.isSignedIn()) {
    PortletPreferencesImpl prefsImpl=(PortletPreferencesImpl)PortletPreferencesLocalServiceUtil.getPreferences(themeDisplay.getCompanyId(),pk);
    portalPrefs=new PortalPreferences(prefsImpl,themeDisplay.isSignedIn());
  }
 else {
    HttpSession ses=req.getSession();
    portalPrefs=(PortalPreferences)ses.getAttribute(WebKeys.PORTAL_PREFERENCES);
    if (portalPrefs == null) {
      PortletPreferencesImpl prefsImpl=(PortletPreferencesImpl)PortletPreferencesLocalServiceUtil.getPreferences(themeDisplay.getCompanyId(),pk);
      prefsImpl=(PortletPreferencesImpl)prefsImpl.clone();
      portalPrefs=new PortalPreferences(prefsImpl,themeDisplay.isSignedIn());
      ses.setAttribute(WebKeys.PORTAL_PREFERENCES,portalPrefs);
    }
  }
  return portalPrefs;
}
