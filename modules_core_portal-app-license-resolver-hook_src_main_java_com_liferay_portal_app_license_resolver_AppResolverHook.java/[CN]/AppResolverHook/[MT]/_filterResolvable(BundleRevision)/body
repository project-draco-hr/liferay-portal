{
  if (_log.isDebugEnabled()) {
    _log.debug("Resolving bundle " + bundleRevision.getSymbolicName());
  }
  Bundle bundle=bundleRevision.getBundle();
  Dictionary<String,String> headers=bundle.getHeaders();
  String marketplaceProperties=headers.get("X-Liferay-Marketplace");
  if (marketplaceProperties == null) {
    return;
  }
  Attrs parameters=OSGiHeader.parseProperties(marketplaceProperties);
  String productId=parameters.get("productId");
  String productType=parameters.get("productType");
  String productVersion=parameters.get("productVersion");
  String licenseVersion=parameters.get("licenseVersion");
  if (productId == null) {
    return;
  }
  SortedMap<ServiceReference<AppLicenseVerifier>,AppLicenseVerifier> verifiers=_serviceTracker.getTracked();
  boolean verified=false;
  Filter filter=FrameworkUtil.createFilter("(version=" + licenseVersion + ")");
  for (  ServiceReference<AppLicenseVerifier> serviceReference : verifiers.keySet()) {
    if (!filter.match(serviceReference)) {
      continue;
    }
    AppLicenseVerifier appLicenseVerifier=verifiers.get(serviceReference);
    appLicenseVerifier.verify(bundle,productId,productType,productVersion);
    verified=true;
    break;
  }
  if (!verified) {
    throw new Exception(AppLicenseVerifier.class.getName() + " could not be resolved.");
  }
}
