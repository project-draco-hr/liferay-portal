{
  Map<String,Object> context=_getContext();
  context.put("entities",_ejbList);
  String content=_processTemplate(_tplOrmXml,context);
  String mappedClasses="";
  int lastMappedClassStart=content.lastIndexOf("<mapped-superclass");
  if (lastMappedClassStart != -1) {
    int lastMappedClassEnd=content.indexOf("</mapped-superclass>",lastMappedClassStart) + 20;
    mappedClasses=content.substring(0,lastMappedClassEnd);
    content=content.substring(lastMappedClassEnd + 1);
  }
  File xmlFile=new File(_ormFileName);
  if (!xmlFile.exists()) {
    String xml="<?xml version=\"1.0\"?>\n" + "<entity-mappings version=\"1.0\" xmlns=\"http://java.sun.com/xml/ns/persistence/orm\"\n" + "\txmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\"\n"+ "\txsi:schemaLocation=\"http://java.sun.com/xml/ns/persistence/orm http://java.sun.com/xml/ns/persistence/orm_1_0.xsd\"\n"+ ">\n"+ "<persistence-unit-metadata>\n"+ "\t<xml-mapping-metadata-complete />\n"+ "\t<persistence-unit-defaults>\n"+ "\t\t<access>PROPERTY</access>\n"+ "\t</persistence-unit-defaults>\n"+ "</persistence-unit-metadata>\n"+ "</entity-mappings>";
    FileUtil.write(xmlFile,xml);
  }
  String oldContent=FileUtil.read(xmlFile);
  String newContent=oldContent;
  int firstMappedClass=newContent.indexOf("<mapped-superclass class=\"" + _packagePath + ".model.");
  int lastMappedClass=newContent.lastIndexOf("<mapped-superclass class=\"" + _packagePath + ".model.");
  if (firstMappedClass == -1) {
    int x=newContent.indexOf("<entity class=");
    if (x != -1) {
      newContent=newContent.substring(0,x) + mappedClasses + newContent.substring(x);
    }
 else {
      content=mappedClasses + content;
    }
  }
 else {
    firstMappedClass=newContent.indexOf("<mapped-superclass",firstMappedClass) - 1;
    lastMappedClass=newContent.indexOf("</mapped-superclass>",lastMappedClass) + 20;
    newContent=newContent.substring(0,firstMappedClass) + mappedClasses + newContent.substring(lastMappedClass);
  }
  int firstEntity=newContent.indexOf("<entity class=\"" + _packagePath + ".model.impl.");
  int lastEntity=newContent.lastIndexOf("<entity class=\"" + _packagePath + ".model.impl.");
  if (firstEntity == -1) {
    int x=newContent.indexOf("</entity-mappings>");
    if (x != -1) {
      newContent=newContent.substring(0,x) + content + newContent.substring(x,newContent.length());
    }
  }
 else {
    firstEntity=newContent.lastIndexOf("<entity",firstEntity) - 1;
    lastEntity=newContent.indexOf("</entity>",lastEntity) + 9;
    newContent=newContent.substring(0,firstEntity) + content + newContent.substring(lastEntity,newContent.length());
  }
  newContent=_formatXml(newContent);
  newContent=StringUtil.replace(newContent,new String[]{"<attributes></attributes>","<attributes/>"},new String[]{"<attributes />","<attributes />"});
  if (!oldContent.equals(newContent)) {
    FileUtil.write(xmlFile,newContent);
  }
}
