{
  String cmd=ParamUtil.getString(req,Constants.CMD);
  try {
    if (cmd.equals(Constants.SEND) || cmd.equals(Constants.SAVE)) {
      HttpSession ses=((ActionRequestImpl)req).getHttpServletRequest().getSession();
      User user=PortalUtil.getUser(req);
      Address from=new InternetAddress(user.getEmailAddress(),user.getFullName());
      MailMessage mm=new MailMessage();
      mm.setFrom(from);
      mm.setTo(ParamUtil.getString(req,"tos"));
      mm.setCc(ParamUtil.getString(req,"ccs"));
      mm.setBcc(ParamUtil.getString(req,"bccs"));
      mm.setSubject(ParamUtil.getString(req,"subject"));
      mm.setHtmlBody(ParamUtil.getString(req,"body"));
      mm.setMessageUID(ParamUtil.getLong(req,"messageId"));
      Map attachments=_getAttachments(PortalUtil.getUploadPortletRequest(req));
      Set filenames=attachments.keySet();
      for (Iterator itr=filenames.iterator(); itr.hasNext(); ) {
        String filename=(String)itr.next();
        byte[] attachment=(byte[])attachments.get(filename);
        MailAttachment ma=new MailAttachment();
        ma.setFilename(filename);
        ma.setContentType(ContentTypeUtil.getContentType(filename));
        ma.setContent(attachment);
        mm.appendAttachment(ma);
      }
      mm.setRemoteAttachments(_getRemoteAttachments(req));
      MailUtil.completeMessage(ses,mm,cmd.equals(Constants.SEND));
      setForward(req,"portlet.mailbox.view");
    }
 else {
      if (Validator.isNotNull(cmd)) {
      }
    }
  }
 catch (  Exception e) {
    _log.error(StackTraceUtil.getStackTrace(e));
  }
}
