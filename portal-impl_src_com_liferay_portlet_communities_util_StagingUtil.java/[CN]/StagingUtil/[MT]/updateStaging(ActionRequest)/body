{
  ThemeDisplay themeDisplay=(ThemeDisplay)actionRequest.getAttribute(WebKeys.THEME_DISPLAY);
  PermissionChecker permissionChecker=themeDisplay.getPermissionChecker();
  long liveGroupId=ParamUtil.getLong(actionRequest,"liveGroupId");
  if (!GroupPermissionUtil.contains(permissionChecker,liveGroupId,ActionKeys.MANAGE_STAGING)) {
    throw new PrincipalException();
  }
  long stagingGroupId=ParamUtil.getLong(actionRequest,"stagingGroupId");
  boolean stagingEnabled=ParamUtil.getBoolean(actionRequest,"stagingEnabled");
  if ((stagingGroupId > 0) && !stagingEnabled) {
    GroupServiceUtil.deleteGroup(stagingGroupId);
    GroupServiceUtil.updateWorkflow(liveGroupId,false,0,null);
  }
 else   if ((stagingGroupId == 0) && stagingEnabled) {
    Group liveGroup=GroupServiceUtil.getGroup(liveGroupId);
    Group stagingGroup=GroupServiceUtil.addGroup(liveGroup.getGroupId(),liveGroup.getName() + " (Staging)",liveGroup.getDescription(),GroupConstants.TYPE_COMMUNITY_PRIVATE,null,liveGroup.isActive());
    if (liveGroup.hasPrivateLayouts()) {
      Map<String,String[]> parameterMap=getStagingParameters();
      publishLayouts(liveGroup.getGroupId(),stagingGroup.getGroupId(),true,parameterMap,null,null);
    }
    if (liveGroup.hasPublicLayouts()) {
      Map<String,String[]> parameterMap=getStagingParameters();
      publishLayouts(liveGroup.getGroupId(),stagingGroup.getGroupId(),false,parameterMap,null,null);
    }
  }
}
