{
  Group group=groupLocalService.getGroup(groupId);
  User user=userLocalService.getUserById(userId);
  long wallEntryId=counterLocalService.increment();
  WallEntry wallEntry=wallEntryPersistence.create(wallEntryId);
  wallEntry.setGroupId(groupId);
  wallEntry.setCompanyId(user.getCompanyId());
  wallEntry.setUserId(user.getUserId());
  wallEntry.setUserName(user.getFullName());
  wallEntry.setComments(comments);
  wallEntryPersistence.update(wallEntry);
  try {
    sendEmail(wallEntry,themeDisplay);
  }
 catch (  Exception e) {
    throw new SystemException(e);
  }
  JSONObject extraDataJSONObject=JSONFactoryUtil.createJSONObject();
  extraDataJSONObject.put("comments",wallEntry.getComments());
  if (userId != group.getClassPK()) {
    socialActivityLocalService.addActivity(userId,groupId,WallEntry.class.getName(),wallEntryId,WallActivityKeys.ADD_ENTRY,extraDataJSONObject.toString(),group.getClassPK());
  }
  return wallEntry;
}
