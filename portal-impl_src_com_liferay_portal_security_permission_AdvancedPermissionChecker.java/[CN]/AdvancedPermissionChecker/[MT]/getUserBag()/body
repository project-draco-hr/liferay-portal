{
  UserPermissionCheckerBag userPermissionCheckerBag=PermissionCacheUtil.getUserBag(user.getUserId());
  if (userPermissionCheckerBag != null) {
    return userPermissionCheckerBag;
  }
  try {
    List<Group> userGroups=GroupLocalServiceUtil.getUserGroups(user.getUserId(),true);
    List<Organization> userOrgs=getUserOrgs(user.getUserId());
    Set<Group> userOrgGroups=SetUtil.fromList(GroupLocalServiceUtil.getOrganizationsGroups(userOrgs));
    List<UserGroup> userUserGroups=UserGroupLocalServiceUtil.getUserUserGroups(user.getUserId());
    List<Group> userUserGroupGroups=GroupLocalServiceUtil.getUserGroupsGroups(userUserGroups);
    Set<Role> userRoles=new HashSet<>();
    if (!userGroups.isEmpty()) {
      List<Role> userRelatedRoles=RoleLocalServiceUtil.getUserRelatedRoles(user.getUserId(),userGroups);
      userRoles.addAll(userRelatedRoles);
    }
 else {
      userRoles.addAll(RoleLocalServiceUtil.getUserRoles(user.getUserId()));
    }
    userPermissionCheckerBag=new UserPermissionCheckerBagImpl(user.getUserId(),SetUtil.fromList(userGroups),userOrgs,userOrgGroups,userUserGroupGroups,userRoles);
    PermissionCacheUtil.putUserBag(user.getUserId(),userPermissionCheckerBag);
    return userPermissionCheckerBag;
  }
 catch (  Exception e) {
    PermissionCacheUtil.removeUserBag(user.getUserId());
    throw e;
  }
}
