{
  ResourceActionsUtil.checkAction(name,actionId);
  if (name.indexOf(StringPool.PERIOD) != -1) {
    List<String> actions=ResourceActionsUtil.getModelResourceGuestUnsupportedActions(name);
    if (actions.contains(actionId)) {
      return false;
    }
  }
 else {
    List<String> actions=ResourceActionsUtil.getPortletResourceGuestUnsupportedActions(name);
    if (actions.contains(actionId)) {
      return false;
    }
  }
  long companyId=user.getCompanyId();
  List<Resource> resources=getResources(companyId,groupId,name,primKey,actionId);
  Group guestGroup=GroupLocalServiceUtil.getGroup(companyId,GroupConstants.GUEST);
  PermissionCheckerBag bag=PermissionCacheUtil.getBag(defaultUserId,guestGroup.getGroupId());
  if (bag == null) {
    try {
      List<Group> groups=new ArrayList<Group>();
      groups.add(guestGroup);
      List<Role> roles=RoleLocalServiceUtil.getUserRelatedRoles(defaultUserId,groups);
      bag=new PermissionCheckerBagImpl(defaultUserId,new ArrayList<Group>(),new ArrayList<Organization>(),new ArrayList<Group>(),new ArrayList<Group>(),new ArrayList<Group>(),roles);
    }
  finally {
      if (bag == null) {
        bag=new PermissionCheckerBagImpl(defaultUserId,new ArrayList<Group>(),new ArrayList<Organization>(),new ArrayList<Group>(),new ArrayList<Group>(),new ArrayList<Group>(),new ArrayList<Role>());
      }
      PermissionCacheUtil.putBag(defaultUserId,guestGroup.getGroupId(),bag);
    }
  }
  try {
    return PermissionLocalServiceUtil.hasUserPermissions(defaultUserId,groupId,resources,actionId,bag);
  }
 catch (  Exception e) {
    _log.error(e,e);
    return false;
  }
}
