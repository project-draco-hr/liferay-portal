{
  StopWatch stopWatch=new StopWatch();
  stopWatch.start();
  Group group=null;
  try {
    if (groupId > 0) {
      group=GroupLocalServiceUtil.getGroup(groupId);
      if (group.isUser() && (group.getClassPK() == getUserId())) {
        group=GroupLocalServiceUtil.getGroup(getCompanyId(),GroupConstants.USER_PERSONAL_SITE);
        groupId=group.getGroupId();
      }
      if (group.isLayout() && !ResourceBlockLocalServiceUtil.isSupported(name)) {
        Layout layout=LayoutLocalServiceUtil.getLayout(group.getClassPK());
        groupId=layout.getGroupId();
        group=GroupLocalServiceUtil.getGroup(groupId);
      }
      if (group.isStagingGroup()) {
        if (primKey.equals(String.valueOf(groupId))) {
          primKey=String.valueOf(group.getLiveGroupId());
        }
        groupId=group.getLiveGroupId();
        group=group.getLiveGroup();
      }
    }
  }
 catch (  Exception e) {
    _log.error(e,e);
  }
  Boolean value=PermissionCacheUtil.getPermission(user.getUserId(),signedIn,groupId,name,primKey,actionId);
  if (value != null) {
    return value.booleanValue();
  }
  try {
    value=Boolean.valueOf(hasPermissionImpl(groupId,name,primKey,actionId));
    if (_log.isDebugEnabled()) {
      _log.debug("Checking permission for " + groupId + " "+ name+ " "+ primKey+ " "+ actionId+ " takes "+ stopWatch.getTime()+ " ms");
    }
  }
  finally {
    if (value == null) {
      value=Boolean.FALSE;
    }
    PermissionCacheUtil.putPermission(user.getUserId(),signedIn,groupId,name,primKey,actionId,value);
  }
  return value.booleanValue();
}
