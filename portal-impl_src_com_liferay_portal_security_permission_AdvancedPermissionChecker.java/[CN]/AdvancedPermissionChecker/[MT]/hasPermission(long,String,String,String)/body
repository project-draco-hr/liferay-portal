{
  StopWatch stopWatch=new StopWatch();
  stopWatch.start();
  boolean checkOwnerPermission=false;
  Group group=null;
  try {
    if (groupId > 0) {
      group=GroupLocalServiceUtil.getGroup(groupId);
      if (group.isLayout() && !ResourceBlockLocalServiceUtil.isSupported(name)) {
        Layout layout=LayoutLocalServiceUtil.getLayout(group.getClassPK());
        groupId=layout.getGroupId();
        group=GroupLocalServiceUtil.getGroup(groupId);
      }
 else       if (group.isUserPersonalSite()) {
        return false;
      }
      if (group.isUser() && (group.getClassPK() == getUserId())) {
        checkOwnerPermission=true;
        group=GroupLocalServiceUtil.getGroup(getCompanyId(),GroupConstants.USER_PERSONAL_SITE);
        groupId=group.getGroupId();
      }
    }
  }
 catch (  Exception e) {
    _log.error(e,e);
  }
  long[] roleIds=getRoleIds(getUserId(),groupId);
  Boolean value=PermissionCacheUtil.getPermission(groupId,name,primKey,roleIds,actionId);
  if (value != null) {
    return value;
  }
  try {
    if (checkOwnerPermission) {
      value=hasOwnerPermission(getCompanyId(),name,primKey,getUserId(),actionId);
    }
    if ((value == null) || !value) {
      value=hasPermissionImpl(groupId,name,primKey,roleIds,actionId);
    }
    if (_log.isDebugEnabled()) {
      _log.debug("Checking permission for " + groupId + " "+ name+ " "+ primKey+ " "+ actionId+ " takes "+ stopWatch.getTime()+ " ms");
    }
    PermissionCacheUtil.putPermission(groupId,name,primKey,roleIds,actionId,value);
  }
 catch (  Exception e) {
    PermissionCacheUtil.removePermission(groupId,name,primKey,roleIds,actionId);
    throw e;
  }
  return value;
}
