{
  vc.put("request",req);
  PortletConfigImpl portletConfig=(PortletConfigImpl)req.getAttribute(JavaConstants.JAVAX_PORTLET_CONFIG);
  if (portletConfig != null) {
    vc.put("portletConfig",portletConfig);
  }
  PortletRequest portletRequest=(PortletRequest)req.getAttribute(JavaConstants.JAVAX_PORTLET_REQUEST);
  if (portletRequest != null) {
    if (portletRequest instanceof RenderRequest) {
      vc.put("renderRequest",portletRequest);
    }
  }
  PortletResponse portletResponse=(PortletResponse)req.getAttribute(JavaConstants.JAVAX_PORTLET_RESPONSE);
  if (portletResponse != null) {
    if (portletResponse instanceof RenderResponse) {
      vc.put("renderResponse",portletResponse);
    }
  }
  ThemeDisplay themeDisplay=(ThemeDisplay)req.getAttribute(WebKeys.THEME_DISPLAY);
  if (themeDisplay != null) {
    Theme theme=themeDisplay.getTheme();
    Layout layout=themeDisplay.getLayout();
    List layouts=themeDisplay.getLayouts();
    vc.put("themeDisplay",themeDisplay);
    vc.put("company",themeDisplay.getCompany());
    vc.put("user",themeDisplay.getUser());
    vc.put("realUser",themeDisplay.getRealUser());
    vc.put("layout",layout);
    vc.put("layouts",layouts);
    vc.put("plid",String.valueOf(themeDisplay.getPlid()));
    vc.put("layoutTypePortlet",themeDisplay.getLayoutTypePortlet());
    vc.put("portletGroupId",new Long(themeDisplay.getPortletGroupId()));
    vc.put("permissionChecker",themeDisplay.getPermissionChecker());
    vc.put("locale",themeDisplay.getLocale());
    vc.put("timeZone",themeDisplay.getTimeZone());
    vc.put("theme",theme);
    vc.put("colorScheme",themeDisplay.getColorScheme());
    vc.put("portletDisplay",themeDisplay.getPortletDisplay());
    if (layout != null) {
      RequestVars requestVars=new RequestVars(req,themeDisplay,layout.getAncestorPlid(),layout.getAncestorLayoutId());
      List navItems=NavItem.fromLayouts(requestVars,layouts);
      vc.put("navItems",navItems);
    }
    String ctxName=GetterUtil.getString(theme.getServletContextName());
    vc.put("fullCssPath",ctxName + theme.getVelocityResourceListener() + theme.getCssPath());
    vc.put("fullTemplatesPath",ctxName + theme.getVelocityResourceListener() + theme.getTemplatesPath());
    vc.put("init",themeDisplay.getPathContext() + VelocityResourceListener.SERVLET_SEPARATOR + "/html/themes/_unstyled/templates/init.vm");
  }
  String tilesTitle=_insertTilesVariables(vc,req,"tilesTitle","title");
  String tilesContent=_insertTilesVariables(vc,req,"tilesContent","content");
  boolean tilesSelectable=GetterUtil.getBoolean(_insertTilesVariables(vc,req,"tilesSelectable","selectable"));
  if (themeDisplay != null) {
    themeDisplay.setTilesTitle(tilesTitle);
    themeDisplay.setTilesContent(tilesContent);
    themeDisplay.setTilesSelectable(tilesSelectable);
  }
  vc.put("pageTitle",req.getAttribute(WebKeys.PAGE_TITLE));
  vc.put("pageSubtitle",req.getAttribute(WebKeys.PAGE_SUBTITLE));
  insertHelperUtilities(vc);
  Map vmVariables=(Map)req.getAttribute(WebKeys.VM_VARIABLES);
  if (vmVariables != null) {
    Iterator itr=vmVariables.entrySet().iterator();
    while (itr.hasNext()) {
      Map.Entry entry=(Map.Entry)itr.next();
      String key=(String)entry.getKey();
      Object value=entry.getValue();
      if (Validator.isNotNull(key)) {
        vc.put(key,value);
      }
    }
  }
}
