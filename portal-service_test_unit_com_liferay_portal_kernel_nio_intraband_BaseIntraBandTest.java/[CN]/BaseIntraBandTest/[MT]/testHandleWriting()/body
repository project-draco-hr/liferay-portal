{
  List<LogRecord> logRecords=JDKLoggerTestUtil.configureJDKLogger(BaseIntraBand.class.getName(),Level.FINE);
  Datagram requestDatagram=Datagram.createRequestDatagram(_type,_dataContent);
  MockRegistrationReference mockRegistrationReference=new MockRegistrationReference(_mockIntraBand);
  ChannelContext channelContext=new ChannelContext(new LinkedList<Datagram>());
  channelContext.setWritingDatagram(requestDatagram);
  channelContext.setRegistrationReference(mockRegistrationReference);
  boolean stillWritable=_mockIntraBand.handleWriting(new MockGatheringByteChannel(),channelContext);
  Assert.assertFalse(stillWritable);
  Assert.assertFalse(mockRegistrationReference.isValid());
  Assert.assertEquals(1,logRecords.size());
  LogRecord logRecord=logRecords.get(0);
  Assert.assertTrue(logRecord.getMessage().startsWith("Broken write channel, unregister "));
  Assert.assertTrue(logRecord.getThrown() instanceof IOException);
  logRecords=JDKLoggerTestUtil.configureJDKLogger(BaseIntraBand.class.getName(),Level.INFO);
  requestDatagram=Datagram.createRequestDatagram(_type,_dataContent);
  mockRegistrationReference=new MockRegistrationReference(_mockIntraBand);
  channelContext=new ChannelContext(new LinkedList<Datagram>());
  channelContext.setWritingDatagram(requestDatagram);
  channelContext.setRegistrationReference(mockRegistrationReference);
  stillWritable=_mockIntraBand.handleWriting(new MockGatheringByteChannel(),channelContext);
  Assert.assertFalse(stillWritable);
  Assert.assertFalse(mockRegistrationReference.isValid());
  Assert.assertEquals(1,logRecords.size());
  logRecord=logRecords.get(0);
  Assert.assertTrue(logRecord.getMessage().startsWith("Broken write channel, unregister "));
  Assert.assertNull(logRecord.getThrown());
  logRecords=JDKLoggerTestUtil.configureJDKLogger(BaseIntraBand.class.getName(),Level.OFF);
  RecordCompletionHandler<Object> recordCompletionHandler=new RecordCompletionHandler<Object>();
  requestDatagram=Datagram.createRequestDatagram(_type,_dataContent);
  requestDatagram.completionHandler=recordCompletionHandler;
  mockRegistrationReference=new MockRegistrationReference(_mockIntraBand);
  channelContext=new ChannelContext(null);
  channelContext.setWritingDatagram(requestDatagram);
  channelContext.setRegistrationReference(mockRegistrationReference);
  stillWritable=_mockIntraBand.handleWriting(new MockGatheringByteChannel(),channelContext);
  Assert.assertFalse(stillWritable);
  Assert.assertFalse(mockRegistrationReference.isValid());
  recordCompletionHandler.waitUntilFailed();
  Assert.assertNotNull(recordCompletionHandler.getIOException());
  Assert.assertTrue(logRecords.isEmpty());
  Pipe pipe=Pipe.open();
  SourceChannel sourceChannel=pipe.source();
  SinkChannel sinkChannel=pipe.sink();
  sourceChannel.configureBlocking(false);
  sinkChannel.configureBlocking(false);
  int bufferSize=1024 * 1024 * 10;
  ByteBuffer sendByteBuffer=ByteBuffer.allocate(bufferSize);
  ByteBuffer receiveByteBuffer=ByteBuffer.allocate(bufferSize + 14);
  requestDatagram=Datagram.createRequestDatagram(_type,sendByteBuffer);
  channelContext=new ChannelContext(new LinkedList<Datagram>());
  channelContext.setWritingDatagram(requestDatagram);
  int count=0;
  while (!_mockIntraBand.handleWriting(sinkChannel,channelContext)) {
    count++;
    sourceChannel.read(receiveByteBuffer);
    Assert.assertTrue(sendByteBuffer.hasRemaining());
  }
  sourceChannel.read(receiveByteBuffer);
  Assert.assertFalse(sendByteBuffer.hasRemaining());
  Assert.assertFalse(receiveByteBuffer.hasRemaining());
  Assert.assertTrue(count > 0);
  sourceChannel.configureBlocking(true);
  sinkChannel.configureBlocking(true);
  Object attachment=new Object();
  recordCompletionHandler=new RecordCompletionHandler<Object>();
  requestDatagram=Datagram.createRequestDatagram(_type,_dataContent);
  requestDatagram.attachment=attachment;
  requestDatagram.completionHandler=recordCompletionHandler;
  requestDatagram.completionTypes=EnumSet.of(CompletionType.SUBMITTED);
  channelContext=new ChannelContext(new LinkedList<Datagram>());
  channelContext.setWritingDatagram(requestDatagram);
  stillWritable=_mockIntraBand.handleWriting(sinkChannel,channelContext);
  Assert.assertTrue(stillWritable);
  recordCompletionHandler.waitUntilSubmitted();
  Assert.assertSame(attachment,recordCompletionHandler.getAttachment());
  requestDatagram=Datagram.createRequestDatagram(_type,_dataContent);
  requestDatagram.completionTypes=EnumSet.of(CompletionType.REPLIED);
  Queue<Datagram> sendingQueue=new LinkedList<Datagram>();
  channelContext=new ChannelContext(sendingQueue);
  channelContext.setWritingDatagram(requestDatagram);
  stillWritable=_mockIntraBand.handleWriting(sinkChannel,channelContext);
  Assert.assertTrue(stillWritable);
  Assert.assertNull(requestDatagram.getData());
  Assert.assertTrue(requestDatagram.toString().contains("dataChunk=null"));
  sourceChannel.close();
  sinkChannel.close();
  Assert.assertSame(sendingQueue,channelContext.getSendingQueue());
}
