{
  return new ServiceReferenceMapper<K,S>(){
    @Override public void map(    ServiceReference<S> serviceReference,    Emitter<K> emitter){
      S service=bundleContext.getService(serviceReference);
      try {
        serviceMapper.map(service,emitter);
      }
  finally {
        bundleContext.ungetService(serviceReference);
      }
    }
  }
;
}
