{
  try {
    UnicodeProperties previousTypeSettingsProperties=layout.getTypeSettingsProperties();
    LayoutTypePortlet previousLayoutType=(LayoutTypePortlet)layout.getLayoutType();
    LayoutTemplate previousLayoutTemplate=previousLayoutType.getLayoutTemplate();
    List<String> previousColumns=previousLayoutTemplate.getColumns();
    UnicodeProperties newTypeSettingsProperties=new UnicodeProperties(true);
    newTypeSettingsProperties.load(newTypeSettings);
    String layoutTemplateId=newTypeSettingsProperties.getProperty(LayoutTypePortletConstants.LAYOUT_TEMPLATE_ID);
    previousTypeSettingsProperties.setProperty(LayoutTypePortletConstants.LAYOUT_TEMPLATE_ID,layoutTemplateId);
    String nestedColumnIds=newTypeSettingsProperties.getProperty(LayoutTypePortletConstants.NESTED_COLUMN_IDS);
    if (Validator.isNotNull(nestedColumnIds)) {
      previousTypeSettingsProperties.setProperty(LayoutTypePortletConstants.NESTED_COLUMN_IDS,nestedColumnIds);
      String[] nestedColumnIdsArray=StringUtil.split(nestedColumnIds);
      for (      String nestedColumnId : nestedColumnIdsArray) {
        String nestedColumnValue=newTypeSettingsProperties.getProperty(nestedColumnId);
        previousTypeSettingsProperties.setProperty(nestedColumnId,nestedColumnValue);
      }
    }
    LayoutTemplate newLayoutTemplate=LayoutTemplateLocalServiceUtil.getLayoutTemplate(layoutTemplateId,false,null);
    String[] newPortletIds=new String[0];
    for (    String columnId : newLayoutTemplate.getColumns()) {
      String columnValue=newTypeSettingsProperties.getProperty(columnId);
      String[] portletIds=StringUtil.split(columnValue);
      if (!previousColumns.contains(columnId)) {
        newPortletIds=ArrayUtil.append(newPortletIds,portletIds);
      }
 else {
        String[] previousPortletIds=StringUtil.split(previousTypeSettingsProperties.getProperty(columnId));
        portletIds=appendPortletIds(previousPortletIds,portletIds,portletsMergeMode);
        previousTypeSettingsProperties.setProperty(columnId,StringUtil.merge(portletIds));
      }
    }
    String columnId=previousColumns.get(0);
    String[] portletIds=StringUtil.split(previousTypeSettingsProperties.getProperty(columnId));
    appendPortletIds(portletIds,newPortletIds,portletsMergeMode);
    previousTypeSettingsProperties.setProperty(columnId,StringUtil.merge(portletIds));
    layout.setTypeSettings(previousTypeSettingsProperties.toSortedString());
  }
 catch (  IOException ioe) {
    layout.setTypeSettings(newTypeSettings);
  }
}
