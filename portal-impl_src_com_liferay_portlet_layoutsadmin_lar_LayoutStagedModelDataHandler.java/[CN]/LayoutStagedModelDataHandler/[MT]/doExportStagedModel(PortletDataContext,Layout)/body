{
  LayoutRevision layoutRevision=null;
  boolean exportLAR=MapUtil.getBoolean(portletDataContext.getParameterMap(),"exportLAR");
  if (!exportLAR && LayoutStagingUtil.isBranchingLayout(layout) && !layout.isTypeURL()) {
    long layoutSetBranchId=MapUtil.getLong(portletDataContext.getParameterMap(),"layoutSetBranchId");
    if (layoutSetBranchId <= 0) {
      return;
    }
    layoutRevision=LayoutRevisionLocalServiceUtil.fetchLayoutRevision(layoutSetBranchId,true,layout.getPlid());
    if (layoutRevision == null) {
      return;
    }
    LayoutStagingHandler layoutStagingHandler=LayoutStagingUtil.getLayoutStagingHandler(layout);
    layoutStagingHandler.setLayoutRevision(layoutRevision);
  }
  Element layoutElement=portletDataContext.getExportDataElement(layout);
  populateElementLayoutMetadata(layoutElement,layout,layoutRevision);
  layoutElement.addAttribute("action",Constants.ADD);
  portletDataContext.setPlid(layout.getPlid());
  long parentLayoutId=layout.getParentLayoutId();
  if (parentLayoutId != LayoutConstants.DEFAULT_PARENT_LAYOUT_ID) {
    Layout parentLayout=LayoutLocalServiceUtil.fetchLayout(layout.getGroupId(),layout.isPrivateLayout(),parentLayoutId);
    if (parentLayout != null) {
      StagedModelDataHandlerUtil.exportReferenceStagedModel(portletDataContext,layout,parentLayout,PortletDataContext.REFERENCE_TYPE_PARENT);
      layoutElement.addAttribute("parent-layout-uuid",parentLayout.getUuid());
    }
  }
  List<LayoutFriendlyURL> layoutFriendlyURLs=LayoutFriendlyURLLocalServiceUtil.getLayoutFriendlyURLs(layout.getPlid());
  for (  LayoutFriendlyURL layoutFriendlyURL : layoutFriendlyURLs) {
    StagedModelDataHandlerUtil.exportReferenceStagedModel(portletDataContext,layout,layoutFriendlyURL,PortletDataContext.REFERENCE_TYPE_DEPENDENCY);
  }
  if (layout.isIconImage()) {
    exportLayoutIconImage(portletDataContext,layout,layoutElement);
  }
  if (layout.isTypeArticle()) {
    exportJournalArticle(portletDataContext,layout,layoutElement);
  }
 else   if (layout.isTypeLinkToLayout()) {
    exportLinkedLayout(portletDataContext,layout,layoutElement);
  }
  exportTheme(portletDataContext,layout);
  fixExportTypeSettings(layout);
  portletDataContext.addClassedModel(layoutElement,ExportImportPathUtil.getModelPath(layout),layout,LayoutPortletDataHandler.NAMESPACE);
}
