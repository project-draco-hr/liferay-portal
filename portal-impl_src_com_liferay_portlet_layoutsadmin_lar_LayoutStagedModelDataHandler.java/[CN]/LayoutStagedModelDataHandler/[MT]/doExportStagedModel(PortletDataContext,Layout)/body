{
  LayoutRevision layoutRevision=null;
  ServiceContext serviceContext=ServiceContextThreadLocal.getServiceContext();
  boolean exportLAR=ParamUtil.getBoolean(serviceContext,"exportLAR");
  if (!exportLAR && LayoutStagingUtil.isBranchingLayout(layout) && !layout.isTypeURL()) {
    long layoutSetBranchId=ParamUtil.getLong(serviceContext,"layoutSetBranchId");
    if (layoutSetBranchId <= 0) {
      return;
    }
    layoutRevision=LayoutRevisionUtil.fetchByL_H_P(layoutSetBranchId,true,layout.getPlid());
    if (layoutRevision == null) {
      return;
    }
    LayoutStagingHandler layoutStagingHandler=LayoutStagingUtil.getLayoutStagingHandler(layout);
    layoutStagingHandler.setLayoutRevision(layoutRevision);
  }
  Element layoutElement=portletDataContext.getExportDataElement(layout);
  populateElementLayoutMetadata(layoutElement,layout,layoutRevision);
  boolean deleteLayout=MapUtil.getBoolean(portletDataContext.getParameterMap(),"delete_" + layout.getPlid());
  if (deleteLayout) {
    layoutElement.addAttribute("delete",String.valueOf(true));
    return;
  }
  long parentLayoutId=layout.getParentLayoutId();
  if (parentLayoutId != LayoutConstants.DEFAULT_PARENT_LAYOUT_ID) {
    Layout parentLayout=LayoutLocalServiceUtil.fetchLayout(layout.getGroupId(),layout.isPrivateLayout(),parentLayoutId);
    if (parentLayout != null) {
      exportStagedModel(portletDataContext,parentLayout);
      portletDataContext.addReferenceElement(layout,layoutElement,parentLayout,PortletDataContext.REFERENCE_TYPE_PARENT,false);
      layoutElement.addAttribute("parent-layout-uuid",parentLayout.getUuid());
    }
  }
  portletDataContext.setPlid(layout.getPlid());
  if (layout.isIconImage()) {
    exportLayoutIconImage(portletDataContext,layout,layoutElement);
  }
  if (layout.isTypeArticle()) {
    exportJournalArticle(portletDataContext,layout,layoutElement);
  }
 else   if (layout.isTypeLinkToLayout()) {
    exportLinkedLayout(portletDataContext,layout,layoutElement);
  }
  fixExportTypeSettings(layout);
  portletDataContext.addClassedModel(layoutElement,ExportImportPathUtil.getModelPath(layout),layout,LayoutPortletDataHandler.NAMESPACE);
}
