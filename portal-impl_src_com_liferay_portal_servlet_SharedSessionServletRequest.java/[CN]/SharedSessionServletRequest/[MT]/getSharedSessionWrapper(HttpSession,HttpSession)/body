{
  if (CompoundSessionIdFilter.hasCompoundSessionId() && !(portalSession instanceof CompoundSessionIdHttpSession)) {
    portalSession=new CompoundSessionIdHttpSession(portalSession);
  }
  if (CompoundSessionIdFilter.hasCompoundSessionId() && !(portletSession instanceof CompoundSessionIdHttpSession)) {
    portletSession=new CompoundSessionIdHttpSession(portletSession);
  }
  if (ServerDetector.isJetty()) {
    return new JettySharedSessionWrapper(portalSession,portletSession);
  }
 else {
    return new SharedSessionWrapper(portalSession,portletSession);
  }
}
