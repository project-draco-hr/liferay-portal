{
  String portletId=(String)serviceReference.getProperty("javax.portlet.name");
  if (Validator.isNull(portletId)) {
    return null;
  }
  String controlPanelCategory=(String)serviceReference.getProperty("com.liferay.portlet.control-panel-entry-category");
  if (Validator.isNull(controlPanelCategory)) {
    return null;
  }
  PanelApp portletPanelAppAdapter=new PortletPanelAppAdapter(portletId);
  Dictionary<String,Object> panelAppProperties=new HashMapDictionary<>();
  panelAppProperties.put("panel.category.key",PortletCategoryUtil.getPortletCategoryKey(controlPanelCategory));
  Integer serviceRanking=getServiceRanking(serviceReference);
  if (serviceRanking != null) {
    panelAppProperties.put("service.ranking",serviceRanking);
  }
  ServiceRegistration<PanelApp> serviceRegistration=_bundleContext.registerService(PanelApp.class,portletPanelAppAdapter,panelAppProperties);
  _serviceRegistrations.put(serviceReference,serviceRegistration);
  return portletPanelAppAdapter;
}
