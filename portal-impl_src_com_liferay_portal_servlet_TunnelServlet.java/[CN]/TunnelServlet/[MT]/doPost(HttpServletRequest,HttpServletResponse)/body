{
  PermissionCheckerImpl permissionChecker=null;
  try {
    ObjectInputStream ois=new ObjectInputStream(req.getInputStream());
    Object returnObj=null;
    try {
      ObjectValuePair<HttpPrincipal,MethodWrapper> ovp=(ObjectValuePair<HttpPrincipal,MethodWrapper>)ois.readObject();
      HttpPrincipal httpPrincipal=ovp.getKey();
      MethodWrapper methodWrapper=ovp.getValue();
      long companyId=PortalInstances.getCompanyId(req);
      CompanyThreadLocal.setCompanyId(companyId);
      if (Validator.isNotNull(httpPrincipal.getUserId())) {
        User user=null;
        try {
          user=UserLocalServiceUtil.getUserById(GetterUtil.getLong(httpPrincipal.getUserId()));
        }
 catch (        Exception e) {
        }
        if (user == null) {
          try {
            user=UserLocalServiceUtil.getUserByScreenName(companyId,httpPrincipal.getUserId());
          }
 catch (          Exception e) {
          }
        }
        if (user == null) {
          try {
            user=UserLocalServiceUtil.getUserByEmailAddress(companyId,httpPrincipal.getUserId());
          }
 catch (          Exception e) {
          }
        }
        if (user != null) {
          PrincipalThreadLocal.setName(user.getUserId());
          permissionChecker=PermissionCheckerFactory.create(user,true);
          PermissionThreadLocal.setPermissionChecker(permissionChecker);
        }
      }
      if (returnObj == null) {
        returnObj=MethodInvoker.invoke(methodWrapper);
      }
    }
 catch (    InvocationTargetException ite) {
      returnObj=ite.getCause();
      if (!(returnObj instanceof PortalException)) {
        ite.printStackTrace();
        returnObj=new SystemException();
      }
    }
catch (    Exception e) {
      _log.error(e,e);
    }
    if (returnObj != null) {
      ObjectOutputStream oos=new ObjectOutputStream(res.getOutputStream());
      oos.writeObject(returnObj);
      oos.flush();
      oos.close();
    }
  }
  finally {
    try {
      PermissionCheckerFactory.recycle(permissionChecker);
    }
 catch (    Exception e) {
    }
  }
}
