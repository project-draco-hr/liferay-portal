{
  PermissionCheckerImpl permissionChecker=null;
  try {
    ObjectInputStream ois=new ObjectInputStream(req.getInputStream());
    Object returnObj=null;
    try {
      ObjectValuePair<HttpPrincipal,MethodWrapper> ovp=(ObjectValuePair<HttpPrincipal,MethodWrapper>)ois.readObject();
      HttpPrincipal httpPrincipal=ovp.getKey();
      MethodWrapper methodWrapper=ovp.getValue();
      long companyId=PortalInstances.getCompanyId(req);
      CompanyThreadLocal.setCompanyId(companyId);
      if (httpPrincipal.getUserId() > 0) {
        PrincipalThreadLocal.setName(httpPrincipal.getUserId());
        User user=UserLocalServiceUtil.getUserById(httpPrincipal.getUserId());
        permissionChecker=PermissionCheckerFactory.create(user,true);
        PermissionThreadLocal.setPermissionChecker(permissionChecker);
      }
      if (returnObj == null) {
        returnObj=MethodInvoker.invoke(methodWrapper);
      }
    }
 catch (    InvocationTargetException ite) {
      returnObj=ite.getCause();
      if (!(returnObj instanceof PortalException)) {
        ite.printStackTrace();
        returnObj=new SystemException();
      }
    }
catch (    Exception e) {
      _log.error(e,e);
    }
    if (returnObj != null) {
      ObjectOutputStream oos=new ObjectOutputStream(res.getOutputStream());
      oos.writeObject(returnObj);
      oos.flush();
      oos.close();
    }
  }
  finally {
    try {
      PermissionCheckerFactory.recycle(permissionChecker);
    }
 catch (    Exception e) {
    }
  }
}
