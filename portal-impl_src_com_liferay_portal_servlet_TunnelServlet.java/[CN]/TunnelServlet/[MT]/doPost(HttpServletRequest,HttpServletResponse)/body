{
  ObjectInputStream ois=new ObjectInputStream(request.getInputStream());
  Object returnObj=null;
  try {
    ObjectValuePair<HttpPrincipal,MethodWrapper> ovp=(ObjectValuePair<HttpPrincipal,MethodWrapper>)ois.readObject();
    HttpPrincipal httpPrincipal=ovp.getKey();
    MethodWrapper methodWrapper=ovp.getValue();
    if (!isValidRequest(methodWrapper)) {
      return;
    }
    long companyId=PortalInstances.getCompanyId(request);
    if (Validator.isNotNull(httpPrincipal.getLogin())) {
      User user=null;
      try {
        user=UserLocalServiceUtil.getUserByEmailAddress(companyId,httpPrincipal.getLogin());
      }
 catch (      NoSuchUserException nsue) {
      }
      if (user == null) {
        try {
          user=UserLocalServiceUtil.getUserByScreenName(companyId,httpPrincipal.getLogin());
        }
 catch (        NoSuchUserException nsue) {
        }
      }
      if (user == null) {
        try {
          user=UserLocalServiceUtil.getUserById(GetterUtil.getLong(httpPrincipal.getLogin()));
        }
 catch (        NoSuchUserException nsue) {
        }
      }
      if (user != null) {
        PrincipalThreadLocal.setName(user.getUserId());
        PermissionChecker permissionChecker=PermissionCheckerFactoryUtil.create(user,true);
        PermissionThreadLocal.setPermissionChecker(permissionChecker);
      }
    }
    if (returnObj == null) {
      returnObj=MethodInvoker.invoke(methodWrapper);
    }
  }
 catch (  InvocationTargetException ite) {
    returnObj=ite.getCause();
    if (!(returnObj instanceof PortalException)) {
      ite.printStackTrace();
      returnObj=new SystemException();
    }
  }
catch (  Exception e) {
    _log.error(e,e);
  }
 finally {
    CompanyThreadLocal.setCompanyId(0);
    PrincipalThreadLocal.setName(null);
    PermissionThreadLocal.setPermissionChecker(null);
  }
  if (returnObj != null) {
    ObjectOutputStream oos=new ObjectOutputStream(response.getOutputStream());
    oos.writeObject(returnObj);
    oos.flush();
    oos.close();
  }
}
