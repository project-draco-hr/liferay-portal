{
  if (key == null) {
    throw new NullPointerException("Key is null");
  }
  if (value == null) {
    throw new NullPointerException("Value is null");
  }
  if ((timeToLive != DEFAULT_TIME_TO_LIVE) && (timeToLive < 0)) {
    throw new IllegalArgumentException("Time to live is negative");
  }
  boolean replicate=false;
  if (quiet) {
    replicate=ClusterReplicationThreadLocal.isReplicate();
    ClusterReplicationThreadLocal.setReplicate(false);
  }
  try {
    Element newElement=new Element(key,value);
    if (timeToLive >= 0) {
      newElement.setTimeToLive(timeToLive);
    }
    Ehcache ehcache=getEhcache();
    while (true) {
      Element oldElement=ehcache.get(key);
      if (oldElement == null) {
        oldElement=ehcache.putIfAbsent(newElement);
        if (oldElement == null) {
          return;
        }
      }
      V oldValue=(V)oldElement.getObjectValue();
      if (value.getMvccVersion() <= oldValue.getMvccVersion()) {
        return;
      }
      if (ehcache.replace(oldElement,newElement)) {
        return;
      }
    }
  }
  finally {
    if (quiet) {
      ClusterReplicationThreadLocal.setReplicate(replicate);
    }
  }
}
