{
  boolean replicate=false;
  if (quiet) {
    replicate=ClusterReplicationThreadLocal.isReplicate();
    ClusterReplicationThreadLocal.setReplicate(false);
  }
  try {
    Element newElement=new Element(key,value);
    if (timeToLive >= 0) {
      newElement.setTimeToLive(timeToLive);
    }
    Ehcache ehcache=getEhcache();
    while (true) {
      Element oldElement=ehcache.get(key);
      if (oldElement == null) {
        oldElement=ehcache.putIfAbsent(newElement);
        if (oldElement == null) {
          return;
        }
      }
      V oldValue=(V)oldElement.getObjectValue();
      if ((oldValue != null) && (value.getMvccVersion() <= oldValue.getMvccVersion())) {
        return;
      }
      if (ehcache.replace(oldElement,newElement)) {
        return;
      }
    }
  }
  finally {
    if (quiet) {
      ClusterReplicationThreadLocal.setReplicate(replicate);
    }
  }
}
