{
  User user=userLocalService.getUserById(userId);
  Date now=new Date();
  validate(groupId,name);
  long layoutBranchId=counterLocalService.increment();
  LayoutBranch layoutBranch=layoutBranchPersistence.create(layoutBranchId);
  layoutBranch.setGroupId(groupId);
  layoutBranch.setCompanyId(user.getCompanyId());
  layoutBranch.setUserId(user.getUserId());
  layoutBranch.setUserName(user.getFullName());
  layoutBranch.setCreateDate(serviceContext.getCreateDate(now));
  layoutBranch.setModifiedDate(serviceContext.getModifiedDate(now));
  layoutBranch.setName(name);
  layoutBranch.setDescription(description);
  layoutBranchPersistence.update(layoutBranch,false);
  resourceLocalService.addResources(user.getCompanyId(),layoutBranch.getGroupId(),user.getUserId(),LayoutBranch.class.getName(),layoutBranch.getLayoutBranchId(),false,true,false);
  if (layoutBranch.isMaster()) {
    List<Layout> layouts=layoutPersistence.findByGroupId(layoutBranch.getGroupId());
    for (    Layout layout : layouts) {
      layoutRevisionLocalService.addLayoutRevision(userId,layoutBranchId,LayoutRevisionConstants.DEFAULT_PARENT_LAYOUT_REVISION_ID,true,layout.getPlid(),layout.getName(),layout.getTitle(),layout.getDescription(),layout.getTypeSettings(),layout.isIconImage(),layout.getIconImageId(),layout.getThemeId(),layout.getColorSchemeId(),layout.getWapThemeId(),layout.getWapColorSchemeId(),layout.getCss(),serviceContext);
    }
  }
  return layoutBranch;
}
