{
  initalizeThreadLocals();
  ServiceContext serviceContext=new ServiceContext();
  BackgroundTask backgroundTask=BackgroundTaskLocalServiceUtil.addBackgroundTask(_user.getUserId(),_group.getGroupId(),_BACKGROUND_TASK_NAME,null,_TASK_EXECUTOR_CLASS,getTaskContextMap(),serviceContext);
  Assert.assertEquals(BackgroundTaskConstants.STATUS_NEW,backgroundTask.getStatus());
  backgroundTask=BackgroundTaskLocalServiceUtil.amendBackgroundTask(backgroundTask.getBackgroundTaskId(),backgroundTask.getTaskContextMap(),BackgroundTaskConstants.STATUS_SUCCESSFUL,serviceContext);
  Assert.assertEquals(BackgroundTaskConstants.STATUS_SUCCESSFUL,backgroundTask.getStatus());
  Assert.assertTrue(backgroundTask.isCompleted());
  Map<String,Serializable> threadLocalValues=(Map<String,Serializable>)backgroundTask.getTaskContextMap().get("threadLocalValues");
  assertThreadLocalValues(threadLocalValues);
}
