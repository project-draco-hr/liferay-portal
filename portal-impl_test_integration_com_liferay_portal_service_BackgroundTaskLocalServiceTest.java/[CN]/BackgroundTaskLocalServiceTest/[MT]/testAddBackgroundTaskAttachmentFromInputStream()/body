{
  initalizeThreadLocals();
  BackgroundTask backgroundTask=BackgroundTaskLocalServiceUtil.addBackgroundTask(_user.getUserId(),_group.getGroupId(),_BACKGROUND_TASK_NAME,null,_TASK_EXECUTOR_CLASS,getTaskContextMap(),new ServiceContext());
  Assert.assertEquals(backgroundTask.getAttachmentsFileEntriesCount(),0);
  String fileName=RandomTestUtil.randomString();
  Class<?> clazz=getClass();
  InputStream inputStream=clazz.getResourceAsStream(_RESOURCE_NAME);
  BackgroundTaskLocalServiceUtil.addBackgroundTaskAttachment(_user.getUserId(),backgroundTask.getBackgroundTaskId(),fileName,inputStream);
  backgroundTask=BackgroundTaskLocalServiceUtil.fetchBackgroundTask(backgroundTask.getBackgroundTaskId());
  Assert.assertEquals(backgroundTask.getAttachmentsFileEntriesCount(),1);
  List<FileEntry> attachmentsFileEntries=backgroundTask.getAttachmentsFileEntries();
  FileEntry attachment=attachmentsFileEntries.get(0);
  Assert.assertEquals(fileName,attachment.getTitle());
  assertThreadLocalValues(backgroundTask);
}
