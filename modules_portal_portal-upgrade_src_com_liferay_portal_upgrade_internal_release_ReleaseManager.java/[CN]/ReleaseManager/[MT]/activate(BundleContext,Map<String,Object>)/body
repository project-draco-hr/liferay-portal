{
  _logger=new Logger(bundleContext);
  DB db=DBFactoryUtil.getDB();
  ServiceTrackerMapListener<String,UpgradeInfo,List<UpgradeInfo>> serviceTrackerMapListener=null;
  if (GetterUtil.getBoolean(properties.get("autoUpgrade"),true)) {
    serviceTrackerMapListener=new UpgradeInfoServiceTrackerMapListener();
  }
  _serviceTrackerMap=ServiceTrackerMapFactory.multiValueMap(bundleContext,UpgradeStep.class,"(&(upgrade.bundle.symbolic.name=*)(|(upgrade.db.type=any)" + "(upgrade.db.type=" + db.getType() + ")))",new PropertyServiceReferenceMapper<String,UpgradeStep>("upgrade.bundle.symbolic.name"),new UpgradeServiceTrackerCustomizer(bundleContext),Collections.reverseOrder(new PropertyServiceReferenceComparator<UpgradeStep>("upgrade.from.version")),serviceTrackerMapListener);
  _serviceTrackerMap.open();
}
