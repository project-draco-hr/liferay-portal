{
  Long folderId=(Long)folderPKs.get(new Long(igImage.getFolderId()));
  boolean newParentFolder=false;
  if (folderId == null) {
    folderId=new Long(igImage.getFolderId());
  }
 else {
    newParentFolder=true;
  }
  String[] tagsEntries=context.getTagsEntries(IGImage.class,igImage.getPrimaryKeyObj());
  try {
    if (folderId.longValue() != IGFolderImpl.DEFAULT_PARENT_FOLDER_ID) {
      IGFolderUtil.findByPrimaryKey(folderId.longValue());
    }
    if ((IGImageUtil.fetchByPrimaryKey(igImage.getPrimaryKey()) == null) || newParentFolder) {
      Image image=(Image)imagesPKs.get(new Long(igImage.getLargeImageId()));
      if (image != null) {
        File file=new File(igImage.getDescription() + "." + image.getType());
        FileUtil.write(file,image.getTextObj());
        boolean addCommunityPermissions=true;
        boolean addGuestPermissions=true;
        IGImageLocalServiceUtil.addImage(igImage.getUserId(),folderId.longValue(),igImage.getDescription(),file,image.getType(),tagsEntries,addCommunityPermissions,addGuestPermissions);
      }
 else {
        _log.error("Could not find image for IG image " + igImage.getImageId());
      }
    }
 else {
      igImage.setFolderId(folderId.longValue());
      TagsAssetLocalServiceUtil.updateAsset(igImage.getUserId(),igImage.getFolder().getGroupId(),IGImage.class.getName(),igImage.getPrimaryKey(),tagsEntries);
      IGImageUtil.update(igImage,true);
    }
  }
 catch (  NoSuchFolderException nsfe) {
    _log.error("Could not find the parent folder for IG image " + igImage.getImageId());
  }
}
