{
  User user=userPersistence.findByPrimaryKey(serviceContext.getGuestOrUserId());
  Date now=new Date();
  long kaleoTaskFormInstanceId=counterLocalService.increment();
  KaleoTaskFormInstance kaleoTaskFormInstance=kaleoTaskFormInstancePersistence.create(kaleoTaskFormInstanceId);
  kaleoTaskFormInstance.setCompanyId(user.getCompanyId());
  kaleoTaskFormInstance.setGroupId(groupId);
  kaleoTaskFormInstance.setUserId(user.getUserId());
  kaleoTaskFormInstance.setUserName(user.getFullName());
  kaleoTaskFormInstance.setCreateDate(now);
  kaleoTaskFormInstance.setModifiedDate(now);
  kaleoTaskFormInstance.setKaleoDefinitionId(kaleoTaskInstanceToken.getKaleoDefinitionId());
  kaleoTaskFormInstance.setKaleoInstanceId(kaleoTaskInstanceToken.getKaleoInstanceId());
  kaleoTaskFormInstance.setKaleoTaskId(kaleoTaskInstanceToken.getKaleoTaskId());
  kaleoTaskFormInstance.setKaleoTaskInstanceTokenId(kaleoTaskInstanceToken.getKaleoTaskInstanceTokenId());
  kaleoTaskFormInstance.setKaleoTaskFormId(kaleoTaskFormId);
  KaleoTaskForm kaleoTaskForm=kaleoTaskFormLocalService.getKaleoTaskForm(kaleoTaskFormId);
  if (Validator.isNotNull(kaleoTaskForm.getFormDefinition())) {
    kaleoTaskFormInstance.setFormValues(formValues);
  }
 else {
    FormValueProcessor formValueProcessor=getFormValueProcessor();
    if (formValueProcessor != null) {
      kaleoTaskFormInstance=formValueProcessor.processFormValues(kaleoTaskForm,kaleoTaskFormInstance,formValues,serviceContext);
    }
 else {
      if (_log.isWarnEnabled()) {
        _log.warn("No form value processor defined to for form: " + kaleoTaskForm.getKaleoTaskFormId() + " values: "+ formValues);
      }
    }
  }
  kaleoTaskFormInstancePersistence.update(kaleoTaskFormInstance);
  return kaleoTaskFormInstance;
}
