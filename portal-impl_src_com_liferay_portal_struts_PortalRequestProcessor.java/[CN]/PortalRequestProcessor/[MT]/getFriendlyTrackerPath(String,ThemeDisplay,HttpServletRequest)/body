{
  if (!path.equals(_PATH_PORTAL_LAYOUT)) {
    return null;
  }
  long plid=ParamUtil.getLong(request,"p_l_id");
  if (plid == 0) {
    return null;
  }
  Layout layout=LayoutLocalServiceUtil.getLayout(plid);
  String layoutFriendlyURL=PortalUtil.getLayoutFriendlyURL(layout,themeDisplay);
  String portletId=ParamUtil.getString(request,"p_p_id");
  if (Validator.isNull(portletId)) {
    return layoutFriendlyURL;
  }
  long companyId=PortalUtil.getCompanyId(request);
  Portlet portlet=PortletLocalServiceUtil.getPortletById(companyId,portletId);
  if (portlet == null) {
    String strutsPath=path.substring(1,path.lastIndexOf(StringPool.SLASH));
    portlet=PortletLocalServiceUtil.getPortletByStrutsPath(companyId,strutsPath);
  }
  if ((portlet == null) || !portlet.isActive()) {
    return layoutFriendlyURL.concat(StringPool.QUESTION).concat(request.getQueryString());
  }
  String namespace=PortalUtil.getPortletNamespace(portletId);
  FriendlyURLMapper friendlyURLMapper=portlet.getFriendlyURLMapperInstance();
  if (friendlyURLMapper == null) {
    return layoutFriendlyURL.concat(StringPool.QUESTION).concat(request.getQueryString());
  }
  PortletURLImpl portletURL=new PortletURLImpl(request,portletId,plid,PortletRequest.RENDER_PHASE);
  Iterator<Map.Entry<String,String[]>> itr=request.getParameterMap().entrySet().iterator();
  while (itr.hasNext()) {
    Entry<String,String[]> entry=itr.next();
    String key=entry.getKey();
    if (key.startsWith(namespace)) {
      key=key.substring(namespace.length());
      portletURL.setParameter(key,entry.getValue());
    }
  }
  String portletFriendlyURL=friendlyURLMapper.buildPath(portletURL);
  if (portletFriendlyURL != null) {
    return layoutFriendlyURL.concat(portletFriendlyURL);
  }
 else {
    return layoutFriendlyURL.concat(StringPool.QUESTION).concat(request.getQueryString());
  }
}
