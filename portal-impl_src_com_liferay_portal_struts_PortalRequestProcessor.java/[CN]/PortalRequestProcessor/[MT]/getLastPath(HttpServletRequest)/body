{
  HttpSession session=request.getSession();
  ThemeDisplay themeDisplay=(ThemeDisplay)request.getAttribute(WebKeys.THEME_DISPLAY);
  Boolean httpsInitial=(Boolean)session.getAttribute(WebKeys.HTTPS_INITIAL);
  String portalURL=null;
  if ((PropsValues.COMPANY_SECURITY_AUTH_REQUIRES_HTTPS) && (!PropsValues.SESSION_ENABLE_PHISHING_PROTECTION) && (httpsInitial != null)&& (!httpsInitial.booleanValue())) {
    portalURL=PortalUtil.getPortalURL(request,false);
  }
 else {
    portalURL=PortalUtil.getPortalURL(request);
  }
  StringBundler sb=new StringBundler();
  sb.append(portalURL);
  sb.append(themeDisplay.getPathMain());
  sb.append(_PATH_PORTAL_LAYOUT);
  if (!PropsValues.AUTH_FORWARD_BY_LAST_PATH) {
    if (request.getRemoteUser() != null) {
      sb.append(StringPool.QUESTION);
      sb.append("p_l_id");
      sb.append(StringPool.EQUAL);
      sb.append(LayoutConstants.DEFAULT_PLID);
    }
    return sb.toString();
  }
  LastPath lastPath=(LastPath)request.getAttribute(WebKeys.LAST_PATH);
  if (lastPath == null) {
    lastPath=(LastPath)session.getAttribute(WebKeys.LAST_PATH);
  }
  if (lastPath == null) {
    return sb.toString();
  }
  Map<String,String[]> parameterMap=lastPath.getParameterMap();
  if (lastPath.getContextPath().equals(themeDisplay.getPathMain())) {
    ActionMapping actionMapping=(ActionMapping)moduleConfig.findActionConfig(lastPath.getPath());
    if ((actionMapping == null) || (parameterMap == null)) {
      return sb.toString();
    }
  }
  StringBundler lastPathSB=new StringBundler(4);
  lastPathSB.append(portalURL);
  lastPathSB.append(lastPath.getContextPath());
  lastPathSB.append(lastPath.getPath());
  lastPathSB.append(HttpUtil.parameterMapToString(parameterMap));
  return lastPathSB.toString();
}
