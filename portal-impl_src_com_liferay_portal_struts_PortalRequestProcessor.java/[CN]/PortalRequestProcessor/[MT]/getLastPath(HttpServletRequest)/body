{
  HttpSession ses=req.getSession();
  ThemeDisplay themeDisplay=(ThemeDisplay)req.getAttribute(WebKeys.THEME_DISPLAY);
  Boolean httpsInitial=(Boolean)ses.getAttribute(WebKeys.HTTPS_INITIAL);
  String portalURL=null;
  if ((PropsValues.COMPANY_SECURITY_AUTH_REQUIRES_HTTPS) && (httpsInitial != null) && (!httpsInitial.booleanValue())) {
    portalURL=PortalUtil.getPortalURL(req,false);
  }
 else {
    portalURL=PortalUtil.getPortalURL(req);
  }
  StringMaker sm=new StringMaker();
  sm.append(portalURL);
  sm.append(themeDisplay.getPathMain());
  sm.append(_PATH_PORTAL_LAYOUT);
  if (!PropsValues.AUTH_FORWARD_BY_LAST_PATH) {
    if (req.getRemoteUser() != null) {
      sm.append(StringPool.QUESTION);
      sm.append("p_l_id");
      sm.append(StringPool.EQUAL);
      sm.append(LayoutConstants.DEFAULT_PLID);
    }
    return sm.toString();
  }
  LastPath lastPath=(LastPath)ses.getAttribute(WebKeys.LAST_PATH);
  if (lastPath == null) {
    return sm.toString();
  }
  Map<String,String[]> parameterMap=lastPath.getParameterMap();
  if (lastPath.getContextPath().equals(themeDisplay.getPathMain())) {
    ActionMapping mapping=(ActionMapping)moduleConfig.findActionConfig(lastPath.getPath());
    if ((mapping == null) || (parameterMap == null)) {
      return sm.toString();
    }
  }
  StringMaker lastPathSM=new StringMaker();
  lastPathSM.append(portalURL);
  lastPathSM.append(lastPath.getContextPath());
  lastPathSM.append(lastPath.getPath());
  lastPathSM.append(HttpUtil.parameterMapToString(parameterMap));
  return lastPathSM.toString();
}
