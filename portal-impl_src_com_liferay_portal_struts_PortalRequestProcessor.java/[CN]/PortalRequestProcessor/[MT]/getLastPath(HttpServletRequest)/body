{
  HttpSession ses=req.getSession();
  ThemeDisplay themeDisplay=(ThemeDisplay)req.getAttribute(WebKeys.THEME_DISPLAY);
  boolean requiresHttps=GetterUtil.getBoolean(PropsUtil.get(PropsUtil.COMPANY_SECURITY_AUTH_REQUIRES_HTTPS));
  Boolean httpsInitial=(Boolean)req.getAttribute(WebKeys.HTTPS_INITIAL);
  String portalURL=null;
  if ((requiresHttps) && (httpsInitial != null) && (!httpsInitial.booleanValue())) {
    portalURL=PortalUtil.getPortalURL(req,false);
  }
 else {
    portalURL=PortalUtil.getPortalURL(req);
  }
  StringMaker defaultPathSM=new StringMaker();
  defaultPathSM.append(portalURL);
  defaultPathSM.append(themeDisplay.getPathMain());
  defaultPathSM.append(_PATH_PORTAL_LAYOUT);
  boolean forwardByLastPath=GetterUtil.getBoolean(PropsUtil.get(PropsUtil.AUTH_FORWARD_BY_LAST_PATH),true);
  if (!forwardByLastPath) {
    if (req.getRemoteUser() != null) {
      defaultPathSM.append(StringPool.QUESTION);
      defaultPathSM.append("p_l_id");
      defaultPathSM.append(StringPool.EQUAL);
      defaultPathSM.append(LayoutImpl.DEFAULT_PLID);
    }
    return defaultPathSM.toString();
  }
  LastPath lastPath=(LastPath)ses.getAttribute(WebKeys.LAST_PATH);
  if (lastPath == null) {
    return defaultPathSM.toString();
  }
  Map parameterMap=lastPath.getParameterMap();
  if (lastPath.getContextPath().equals(themeDisplay.getPathMain())) {
    ActionMapping mapping=(ActionMapping)moduleConfig.findActionConfig(lastPath.getPath());
    if ((mapping == null) || (parameterMap == null)) {
      return defaultPathSM.toString();
    }
  }
  StringMaker lastPathSM=new StringMaker();
  lastPathSM.append(portalURL);
  lastPathSM.append(lastPath.getContextPath());
  lastPathSM.append(lastPath.getPath());
  lastPathSM.append(HttpUtil.parameterMapToString(parameterMap));
  return lastPathSM.toString();
}
