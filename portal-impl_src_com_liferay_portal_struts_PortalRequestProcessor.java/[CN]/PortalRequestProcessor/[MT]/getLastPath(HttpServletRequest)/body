{
  HttpSession ses=req.getSession();
  ThemeDisplay themeDisplay=(ThemeDisplay)req.getAttribute(WebKeys.THEME_DISPLAY);
  Boolean httpsInitial=(Boolean)ses.getAttribute(WebKeys.HTTPS_INITIAL);
  String portalURL=null;
  if ((PropsValues.COMPANY_SECURITY_AUTH_REQUIRES_HTTPS) && (httpsInitial != null) && (!httpsInitial.booleanValue())) {
    portalURL=PortalUtil.getPortalURL(req,false);
  }
 else {
    portalURL=PortalUtil.getPortalURL(req);
  }
  StringBuilder sb=new StringBuilder();
  sb.append(portalURL);
  sb.append(themeDisplay.getPathMain());
  sb.append(_PATH_PORTAL_LAYOUT);
  if (!PropsValues.AUTH_FORWARD_BY_LAST_PATH) {
    if (req.getRemoteUser() != null) {
      sb.append(StringPool.QUESTION);
      sb.append("p_l_id");
      sb.append(StringPool.EQUAL);
      sb.append(LayoutConstants.DEFAULT_PLID);
    }
    return sb.toString();
  }
  LastPath lastPath=(LastPath)ses.getAttribute(WebKeys.LAST_PATH);
  if (lastPath == null) {
    return sb.toString();
  }
  Map<String,String[]> parameterMap=lastPath.getParameterMap();
  if (lastPath.getContextPath().equals(themeDisplay.getPathMain())) {
    ActionMapping mapping=(ActionMapping)moduleConfig.findActionConfig(lastPath.getPath());
    if ((mapping == null) || (parameterMap == null)) {
      return sb.toString();
    }
  }
  StringBuilder lastPathSB=new StringBuilder();
  lastPathSB.append(portalURL);
  lastPathSB.append(lastPath.getContextPath());
  lastPathSB.append(lastPath.getPath());
  lastPathSB.append(HttpUtil.parameterMapToString(parameterMap));
  return lastPathSB.toString();
}
