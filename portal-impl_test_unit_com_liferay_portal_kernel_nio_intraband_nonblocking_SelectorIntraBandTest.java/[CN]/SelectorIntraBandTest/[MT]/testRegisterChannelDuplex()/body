{
  try {
    _selectorIntraBand.registerChannel(null);
    Assert.fail();
  }
 catch (  NullPointerException npe) {
    Assert.assertEquals("Channel is null",npe.getMessage());
  }
  try {
    _selectorIntraBand.registerChannel(IntraBandTestUtil.<Channel>createProxy(Channel.class));
    Assert.fail();
  }
 catch (  IllegalArgumentException iae) {
    Assert.assertEquals("Channel is not of type ScatteringByteChannel",iae.getMessage());
  }
  try {
    _selectorIntraBand.registerChannel(IntraBandTestUtil.<Channel>createProxy(ScatteringByteChannel.class));
    Assert.fail();
  }
 catch (  IllegalArgumentException iae) {
    Assert.assertEquals("Channel is not of type GatheringByteChannel",iae.getMessage());
  }
  try {
    _selectorIntraBand.registerChannel(IntraBandTestUtil.<Channel>createProxy(ScatteringByteChannel.class,GatheringByteChannel.class));
    Assert.fail();
  }
 catch (  IllegalArgumentException iae) {
    Assert.assertEquals("Channel is not of type SelectableChannel",iae.getMessage());
  }
  try {
    _selectorIntraBand.registerChannel(new MockDuplexSelectableChannel(false,true));
    Assert.fail();
  }
 catch (  IllegalArgumentException iae) {
    Assert.assertEquals("Channel is not valid for reading",iae.getMessage());
  }
  try {
    _selectorIntraBand.registerChannel(new MockDuplexSelectableChannel(true,false));
    Assert.fail();
  }
 catch (  IllegalArgumentException iae) {
    Assert.assertEquals("Channel is not valid for writing",iae.getMessage());
  }
  SocketChannel[] peerSocketChannels=IntraBandTestUtil.createSocketChannelPeers();
  try {
    SocketChannel socketChannel=peerSocketChannels[0];
    final Thread mainThread=Thread.currentThread();
    Thread wakeUpThread=new Thread(new WakeUpRunnable(_selectorIntraBand));
    Thread interruptThread=new Thread(){
      @Override public void run(){
        while (mainThread.getState() != Thread.State.WAITING)         ;
        mainThread.interrupt();
      }
    }
;
    wakeUpThread.start();
    Selector selector=_selectorIntraBand.selector;
synchronized (selector) {
      wakeUpThread.interrupt();
      wakeUpThread.join();
      interruptThread.start();
      try {
        _selectorIntraBand.registerChannel(socketChannel);
        Assert.fail();
      }
 catch (      IOException ioe) {
        Throwable cause=ioe.getCause();
        Assert.assertTrue(cause instanceof InterruptedException);
      }
      interruptThread.join();
    }
    SelectionKeyRegistrationReference selectionKeyRegistrationReference=(SelectionKeyRegistrationReference)_selectorIntraBand.registerChannel(socketChannel);
    Assert.assertNotNull(selectionKeyRegistrationReference);
    Assert.assertSame(selectionKeyRegistrationReference.readSelectionKey,selectionKeyRegistrationReference.writeSelectionKey);
    SelectionKey selectionKey=selectionKeyRegistrationReference.readSelectionKey;
    Assert.assertTrue(selectionKey.isValid());
    Assert.assertEquals(SelectionKey.OP_READ | SelectionKey.OP_WRITE,selectionKey.interestOps());
    Assert.assertNotNull(selectionKey.attachment());
    _selectorIntraBand.close();
    try {
      _selectorIntraBand.registerChannel(socketChannel);
      Assert.fail();
    }
 catch (    ClosedIntraBandException cibe) {
    }
  }
  finally {
    peerSocketChannels[0].close();
    peerSocketChannels[1].close();
  }
}
