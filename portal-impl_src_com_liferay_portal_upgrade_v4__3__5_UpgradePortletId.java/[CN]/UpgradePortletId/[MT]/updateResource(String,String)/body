{
  Connection con=null;
  PreparedStatement ps=null;
  ResultSet rs=null;
  try {
    con=DataAccess.getConnection();
    ps=con.prepareStatement("select primKey from Resource_ where primKey like ?");
    ps.setString(1,"%" + PortletConstants.LAYOUT_SEPARATOR + oldRootPortletId+ "%");
    rs=ps.executeQuery();
    while (rs.next()) {
      String oldPrimKey=rs.getString("primKey");
      int pos=oldPrimKey.indexOf(PortletConstants.LAYOUT_SEPARATOR);
      long plid=GetterUtil.getLong(oldPrimKey.substring(0,pos));
      String portletId=oldPrimKey.substring(pos + PortletConstants.LAYOUT_SEPARATOR.length());
      String newPrimKey=plid + PortletConstants.LAYOUT_SEPARATOR + newRootPortletId;
      String oldPortletId=oldRootPortletId;
      String newPortletId=newRootPortletId;
      pos=portletId.indexOf(PortletConstants.INSTANCE_SEPARATOR);
      if (pos != -1) {
        portletId=portletId.substring(0,pos);
        String instanceId=oldPrimKey.substring(pos + PortletConstants.INSTANCE_SEPARATOR.length());
        newPrimKey+=PortletConstants.INSTANCE_SEPARATOR + instanceId;
        oldPortletId+=PortletConstants.INSTANCE_SEPARATOR + instanceId;
        newPortletId+=PortletConstants.INSTANCE_SEPARATOR + instanceId;
      }
      if (!portletId.equals(oldRootPortletId)) {
        continue;
      }
      runSQL("update Resource_ set primKey = '" + newPrimKey + "' where primKey = '"+ oldPrimKey+ "'");
      updateLayout(plid,oldPortletId,newPortletId);
      runSQL("update PortletPreferences set portletId = '" + newPortletId + "' where portletId = '"+ oldPortletId+ "'");
    }
  }
  finally {
    DataAccess.cleanUp(con,ps,rs);
  }
}
