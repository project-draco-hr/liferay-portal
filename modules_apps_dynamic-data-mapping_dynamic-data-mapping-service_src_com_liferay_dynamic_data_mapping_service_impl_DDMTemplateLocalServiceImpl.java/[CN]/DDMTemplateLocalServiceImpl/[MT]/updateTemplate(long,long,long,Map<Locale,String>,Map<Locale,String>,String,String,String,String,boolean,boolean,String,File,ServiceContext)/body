{
  User user=userPersistence.findByPrimaryKey(userId);
  script=formatScript(type,language,script);
  byte[] smallImageBytes=null;
  try {
    smallImageBytes=FileUtil.getBytes(smallImageFile);
  }
 catch (  IOException ioe) {
  }
  validate(nameMap,script,smallImage,smallImageURL,smallImageFile,smallImageBytes);
  DDMTemplate template=ddmTemplateLocalService.getDDMTemplate(templateId);
  if ((template.getClassPK() == 0) && (classPK > 0)) {
    template.setClassPK(classPK);
  }
  DDMTemplateVersion latestTemplateVersion=ddmTemplateVersionLocalService.getLatestTemplateVersion(templateId);
  boolean majorVersion=GetterUtil.getBoolean(serviceContext.getAttribute("majorVersion"));
  String version=getNextVersion(latestTemplateVersion.getVersion(),majorVersion);
  template.setVersion(version);
  template.setVersionUserId(user.getUserId());
  template.setVersionUserName(user.getFullName());
  template.setNameMap(nameMap);
  template.setDescriptionMap(descriptionMap);
  template.setType(type);
  template.setMode(mode);
  template.setLanguage(language);
  template.setScript(script);
  template.setCacheable(cacheable);
  template.setSmallImage(smallImage);
  template.setSmallImageURL(smallImageURL);
  saveImages(smallImage,template.getSmallImageId(),smallImageFile,smallImageBytes);
  DDMTemplateVersion ddmTemplateVersion=addTemplateVersion(user,template,version,serviceContext);
  if (ddmTemplateVersion.isApproved()) {
    ddmTemplatePersistence.update(template);
  }
  return template;
}
