{
  ThemeDisplay themeDisplay=(ThemeDisplay)resourceRequest.getAttribute(WebKeys.THEME_DISPLAY);
  String languageId=themeDisplay.getLanguageId();
  ZipWriter zipWriter=ZipWriterFactoryUtil.getZipWriter();
  Map<String,ConfigurationModel> configurationModels=_configurationModelRetriever.getConfigurationModels(themeDisplay.getLanguageId());
  for (  ConfigurationModel configurationModel : configurationModels.values()) {
    if (configurationModel.isFactory()) {
      String curFactoryPid=configurationModel.getFactoryPid();
      List<ConfigurationModel> factoryInstances=_configurationModelRetriever.getFactoryInstances(configurationModel);
      for (      ConfigurationModel factoryInstance : factoryInstances) {
        String curPid=factoryInstance.getID();
        String curFileName=getFileName(curFactoryPid,curPid);
        zipWriter.addEntry(curFileName,getPropertiesAsBytes(languageId,curFactoryPid,curPid));
      }
    }
 else     if (configurationModel.hasConfiguration()) {
      String curPid=configurationModel.getID();
      String curFileName=getFileName(null,curPid);
      zipWriter.addEntry(curFileName,getPropertiesAsBytes(languageId,curPid,curPid));
    }
  }
  String fileName="liferay-system-settings.zip";
  PortletResponseUtil.sendFile(resourceRequest,resourceResponse,fileName,new FileInputStream(zipWriter.getFile()),ContentTypes.TEXT_XML_UTF8);
}
