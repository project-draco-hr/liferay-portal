{
  if (_log.isDebugEnabled()) {
    if (USE_LAYOUT_CACHE_FILTER) {
      _log.debug("Layout cache is enabled");
    }
 else {
      _log.debug("Layout cache is disabled");
    }
  }
  HttpServletRequest httpReq=(HttpServletRequest)req;
  HttpServletResponse httpRes=(HttpServletResponse)res;
  httpReq.setCharacterEncoding(ENCODING);
  if (USE_LAYOUT_CACHE_FILTER && !_isPortletRequest(httpReq) && _isLayout(httpReq)&& !_isSignedIn(httpReq)&& !_isInclude(httpReq)&& !_isAlreadyFiltered(httpReq)) {
    httpReq.setAttribute(_ALREADY_FILTERED,Boolean.TRUE);
    String key=getCacheKey(httpReq);
    LayoutCacheResponseData data=LayoutCacheUtil.getLayoutCacheResponseData(_companyId,key);
    if (data == null) {
      if (!_isCacheable(httpReq)) {
        if (_log.isDebugEnabled()) {
          _log.debug("Layout is not cacheable " + key);
        }
        chain.doFilter(req,res);
        return;
      }
      if (_log.isInfoEnabled()) {
        _log.info("Caching layout " + key);
      }
      LayoutCacheResponse layoutCacheResponse=new LayoutCacheResponse(httpRes);
      chain.doFilter(req,layoutCacheResponse);
      data=new LayoutCacheResponseData(layoutCacheResponse.getData(),layoutCacheResponse.getContentType(),layoutCacheResponse.getHeaders());
      if (data.getData().length > 0) {
        LayoutCacheUtil.putLayoutCacheResponseData(_companyId,key,data);
      }
    }
    Map headers=data.getHeaders();
    Iterator itr=headers.keySet().iterator();
    while (itr.hasNext()) {
      String headerKey=(String)itr.next();
      List headerValues=(List)headers.get(headerKey);
      for (int i=0; i < headerValues.size(); i++) {
        Header header=(Header)headerValues.get(i);
        int type=header.getType();
        if (type == Header.DATE_TYPE) {
          httpRes.addDateHeader(headerKey,header.getDateValue());
        }
 else         if (type == Header.INTEGER_TYPE) {
          httpRes.addIntHeader(headerKey,header.getIntValue());
        }
 else         if (type == Header.STRING_TYPE) {
          httpRes.addHeader(headerKey,header.getStringValue());
        }
      }
    }
    byte[] byteArray=data.getData();
    httpRes.setContentLength(byteArray.length);
    httpRes.setContentType(data.getContentType());
    ServletOutputStream out=httpRes.getOutputStream();
    out.write(byteArray,0,byteArray.length);
    out.flush();
    out.close();
  }
 else {
    if (_log.isDebugEnabled()) {
      _log.debug("Did not request a layout");
    }
    chain.doFilter(req,res);
  }
}
