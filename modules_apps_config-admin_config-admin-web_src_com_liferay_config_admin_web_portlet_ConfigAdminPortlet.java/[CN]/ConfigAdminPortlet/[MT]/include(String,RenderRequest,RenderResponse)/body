{
  ThemeDisplay themeDisplay=(ThemeDisplay)renderRequest.getAttribute(WebKeys.THEME_DISPLAY);
  String languageId=themeDisplay.getLanguageId();
  String factoryPid=ParamUtil.getString(renderRequest,"factoryPid");
  String pid=ParamUtil.getString(renderRequest,"pid",factoryPid);
  String viewType=ParamUtil.getString(renderRequest,"viewType");
  ConfigurationHelper configurationHelper=new ConfigurationHelper(_bundleContext,_configurationAdmin,_metaTypeService,languageId);
  if ("/edit_configuration.ftl".equals(path)) {
    ConfigurationModel model=configurationHelper.getModel(pid);
    if (model != null) {
      model=new ConfigurationModel(model.getObjectClassDefinition(),configurationHelper.getConfiguration(pid),model.getBundleLocation(),model.isFactory());
    }
    renderRequest.setAttribute("configurationHelper",configurationHelper);
    renderRequest.setAttribute("factoryPid",factoryPid);
    renderRequest.setAttribute("model",model);
    renderRequest.setAttribute("pid",pid);
  }
 else   if ("factoryInstances".equals(viewType)) {
    ConfigurationModel factoryModel=configurationHelper.getModel(factoryPid);
    renderRequest.setAttribute("factoryModel",factoryModel);
    List<ConfigurationModel> models=configurationHelper.getFactoryInstances(languageId,factoryPid);
    renderRequest.setAttribute("modelIterator",new ConfigurationIterator(models));
  }
 else {
    List<ConfigurationModel> models=configurationHelper.getModels();
    renderRequest.setAttribute("modelIterator",new ConfigurationIterator(models));
  }
  include(path,renderRequest,renderResponse,PortletRequest.RENDER_PHASE);
}
