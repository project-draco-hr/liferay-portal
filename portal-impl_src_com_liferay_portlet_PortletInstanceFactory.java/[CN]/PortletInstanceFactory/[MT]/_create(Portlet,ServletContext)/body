{
  String poolId=PortletInstanceFactory.class.getName();
  if (!portlet.isWARFile()) {
    StringMaker sm=new StringMaker();
    sm.append(poolId);
    sm.append(StringPool.PERIOD);
    sm.append(portlet.getCompanyId());
    poolId=sm.toString();
  }
  Map map=(Map)_pool.get(poolId);
  if (map == null) {
    map=new ConcurrentHashMap();
    _pool.put(poolId,map);
  }
  Map portletInstances=(Map)map.get(portlet.getRootPortletId());
  if (portletInstances == null) {
    portletInstances=new ConcurrentHashMap();
    map.put(portlet.getRootPortletId(),portletInstances);
  }
  CachePortlet portletInstance=(CachePortlet)portletInstances.get(portlet.getPortletId());
  if (portletInstance == null) {
    PortletConfig portletConfig=PortletConfigFactory.create(portlet,ctx);
    if (portlet.isWARFile()) {
      PortletContextWrapper pcw=PortletContextPool.get(portlet.getRootPortletId());
      portletInstance=_init(portlet,portletConfig,pcw.getPortletInstance());
    }
 else {
      portletInstance=_init(portlet,portletConfig);
    }
    portletInstances.put(portlet.getPortletId(),portletInstance);
  }
  return portletInstance;
}
