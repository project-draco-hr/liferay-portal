{
  boolean instanceable=false;
  if ((portlet.isInstanceable()) && (PortletConstants.getInstanceId(portlet.getPortletId()) != null)) {
    instanceable=true;
  }
  Map<String,InvokerPortlet> portletInstances=_pool.get(portlet.getRootPortletId());
  if (portletInstances == null) {
    portletInstances=new ConcurrentHashMap<String,InvokerPortlet>();
    _pool.put(portlet.getRootPortletId(),portletInstances);
  }
  InvokerPortlet instanceInvokerPortletInstance=null;
  if (instanceable) {
    instanceInvokerPortletInstance=portletInstances.get(portlet.getPortletId());
  }
  InvokerPortlet rootInvokerPortletInstance=null;
  if (instanceInvokerPortletInstance == null) {
    rootInvokerPortletInstance=portletInstances.get(portlet.getRootPortletId());
    if (rootInvokerPortletInstance == null) {
      PortletConfig portletConfig=PortletConfigFactory.create(portlet,servletContext);
      PortletApp portletApp=portlet.getPortletApp();
      if (portletApp.isWARFile()) {
        PortletBag portletBag=PortletBagPool.get(portlet.getRootPortletId());
        rootInvokerPortletInstance=_init(portlet,portletConfig,portletBag.getPortletInstance());
      }
 else {
        rootInvokerPortletInstance=_init(portlet,portletConfig);
      }
      portletInstances.put(portlet.getRootPortletId(),rootInvokerPortletInstance);
    }
  }
  if (instanceable) {
    if (instanceInvokerPortletInstance == null) {
      javax.portlet.Portlet portletInstance=rootInvokerPortletInstance.getPortletInstance();
      PortletConfig portletConfig=PortletConfigFactory.create(portlet,servletContext);
      PortletContext portletContext=portletConfig.getPortletContext();
      boolean facesPortlet=rootInvokerPortletInstance.isFacesPortlet();
      boolean strutsPortlet=rootInvokerPortletInstance.isStrutsPortlet();
      boolean strutsBridgePortlet=rootInvokerPortletInstance.isStrutsBridgePortlet();
      if (PropsValues.PORTLET_CONTAINER_IMPL_SUN) {
        instanceInvokerPortletInstance=_sunInvokerPortletPrototype.create(portlet,portletInstance,portletConfig,portletContext,facesPortlet,strutsPortlet,strutsBridgePortlet);
      }
 else {
        instanceInvokerPortletInstance=_internalInvokerPortletPrototype.create(portlet,portletInstance,portletConfig,portletContext,facesPortlet,strutsPortlet,strutsBridgePortlet);
      }
      portletInstances.put(portlet.getPortletId(),instanceInvokerPortletInstance);
    }
  }
 else {
    if (rootInvokerPortletInstance != null) {
      instanceInvokerPortletInstance=rootInvokerPortletInstance;
    }
  }
  return instanceInvokerPortletInstance;
}
