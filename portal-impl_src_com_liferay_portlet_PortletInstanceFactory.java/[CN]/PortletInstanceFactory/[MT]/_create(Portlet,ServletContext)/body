{
  boolean instanceable=false;
  if ((portlet.isInstanceable()) && (PortletImpl.getInstanceId(portlet.getPortletId()) != null)) {
    instanceable=true;
  }
  Map portletInstances=(Map)_pool.get(portlet.getRootPortletId());
  if (portletInstances == null) {
    portletInstances=CollectionFactory.getSyncHashMap();
    _pool.put(portlet.getRootPortletId(),portletInstances);
  }
  CachePortlet instanceCachePortletInstance=null;
  if (instanceable) {
    instanceCachePortletInstance=(CachePortlet)portletInstances.get(portlet.getPortletId());
  }
  CachePortlet rootCachePortletInstance=null;
  if (instanceCachePortletInstance == null) {
    rootCachePortletInstance=(CachePortlet)portletInstances.get(portlet.getRootPortletId());
    if (rootCachePortletInstance == null) {
      PortletConfig portletConfig=PortletConfigFactory.create(portlet,ctx);
      if (portlet.isWARFile()) {
        PortletContextWrapper pcw=PortletContextPool.get(portlet.getRootPortletId());
        rootCachePortletInstance=_init(portlet,portletConfig,pcw.getPortletInstance());
      }
 else {
        rootCachePortletInstance=_init(portlet,portletConfig);
      }
      portletInstances.put(portlet.getRootPortletId(),rootCachePortletInstance);
    }
  }
  if (instanceable) {
    if (instanceCachePortletInstance == null) {
      javax.portlet.Portlet portletInstance=rootCachePortletInstance.getPortletInstance();
      PortletConfig portletConfig=PortletConfigFactory.create(portlet,ctx);
      PortletContext portletCtx=portletConfig.getPortletContext();
      Integer expCache=rootCachePortletInstance.getExpCache();
      boolean facesPortlet=rootCachePortletInstance.isFacesPortlet();
      boolean strutsPortlet=rootCachePortletInstance.isStrutsPortlet();
      boolean strutsBridgePortlet=rootCachePortletInstance.isStrutsBridgePortlet();
      instanceCachePortletInstance=new CachePortlet(portletInstance,portletConfig,portletCtx,expCache,facesPortlet,strutsPortlet,strutsBridgePortlet);
      portletInstances.put(portlet.getPortletId(),instanceCachePortletInstance);
    }
  }
 else {
    if (rootCachePortletInstance != null) {
      instanceCachePortletInstance=rootCachePortletInstance;
    }
  }
  return instanceCachePortletInstance;
}
