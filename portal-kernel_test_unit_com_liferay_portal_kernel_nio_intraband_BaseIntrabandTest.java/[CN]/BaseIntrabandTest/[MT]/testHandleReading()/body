{
  try (CaptureHandler captureHandler=JDKLoggerTestUtil.configureJDKLogger(BaseIntraband.class.getName(),Level.FINE)){
    List<LogRecord> logRecords=captureHandler.getLogRecords();
    ChannelContext channelContext=new ChannelContext(null);
    MockRegistrationReference mockRegistrationReference=new MockRegistrationReference(_mockIntraband);
    channelContext.setRegistrationReference(mockRegistrationReference);
    _mockIntraband.handleReading(new MockScatteringByteChannel(false),channelContext);
    Assert.assertFalse(mockRegistrationReference.isValid());
    Assert.assertEquals(1,logRecords.size());
    LogRecord logRecord=logRecords.get(0);
    assertMessageStartWith(logRecord,"Broken read channel, unregister ");
    Assert.assertTrue(logRecord.getThrown() instanceof IOException);
    logRecords=captureHandler.resetLogLevel(Level.INFO);
    channelContext=new ChannelContext(null);
    mockRegistrationReference=new MockRegistrationReference(_mockIntraband);
    channelContext.setRegistrationReference(mockRegistrationReference);
    _mockIntraband.handleReading(new MockScatteringByteChannel(true),channelContext);
    Assert.assertFalse(mockRegistrationReference.isValid());
    Assert.assertEquals(1,logRecords.size());
    logRecord=logRecords.get(0);
    assertMessageStartWith(logRecord,"Broken read channel, unregister ");
    Assert.assertNull(logRecord.getThrown());
    logRecords=captureHandler.resetLogLevel(Level.OFF);
    channelContext=new ChannelContext(null);
    channelContext.setReadingDatagram(Datagram.createReceiveDatagram());
    mockRegistrationReference=new MockRegistrationReference(_mockIntraband);
    channelContext.setRegistrationReference(mockRegistrationReference);
    _mockIntraband.handleReading(new MockScatteringByteChannel(false),channelContext);
    Assert.assertFalse(mockRegistrationReference.isValid());
    Assert.assertTrue(logRecords.isEmpty());
    logRecords=captureHandler.resetLogLevel(Level.WARNING);
    Pipe pipe=Pipe.open();
    try (SourceChannel sourceChannel=pipe.source();final SinkChannel sinkChannel=pipe.sink()){
      Datagram requestDatagram=Datagram.createRequestDatagram(_TYPE,_data);
      requestDatagram.writeTo(sinkChannel);
      final ByteBuffer byteBuffer=ByteBuffer.allocate(_data.length + 14);
      while (byteBuffer.hasRemaining()) {
        sourceChannel.read(byteBuffer);
      }
      sourceChannel.configureBlocking(false);
      sinkChannel.configureBlocking(false);
      SyncThrowableThread<Void> syncThrowableThread=new SyncThrowableThread<>(new Callable<Void>(){
        @Override public Void call() throws Exception {
          for (          byte b : byteBuffer.array()) {
            sinkChannel.write(ByteBuffer.wrap(new byte[]{b}));
            Thread.sleep(1);
          }
          return null;
        }
      }
);
      syncThrowableThread.start();
      channelContext=new ChannelContext(null);
      Datagram receiveDatagram=Datagram.createReceiveDatagram();
      channelContext.setReadingDatagram(receiveDatagram);
      while (receiveDatagram == channelContext.getReadingDatagram()) {
        _mockIntraband.handleReading(sourceChannel,channelContext);
      }
      syncThrowableThread.sync();
      Assert.assertEquals(_TYPE,receiveDatagram.getType());
      ByteBuffer dataByteBuffer=receiveDatagram.getDataByteBuffer();
      Assert.assertArrayEquals(_data,dataByteBuffer.array());
      Assert.assertEquals(1,logRecords.size());
      logRecord=logRecords.get(0);
      assertMessageStartWith(logRecord,"Dropped ownerless request ");
      logRecords=captureHandler.resetLogLevel(Level.OFF);
      requestDatagram=Datagram.createRequestDatagram(_TYPE,_data);
      requestDatagram.writeTo(sinkChannel);
      receiveDatagram=Datagram.createReceiveDatagram();
      channelContext.setReadingDatagram(receiveDatagram);
      _mockIntraband.handleReading(sourceChannel,channelContext);
      Assert.assertTrue(receiveDatagram.isRequest());
      Assert.assertEquals(_TYPE,receiveDatagram.getType());
      dataByteBuffer=receiveDatagram.getDataByteBuffer();
      Assert.assertArrayEquals(_data,dataByteBuffer.array());
      Assert.assertTrue(logRecords.isEmpty());
      logRecords=captureHandler.resetLogLevel(Level.WARNING);
      long sequenceId=100;
      Datagram ackResponseDatagram=Datagram.createACKResponseDatagram(sequenceId);
      ackResponseDatagram.writeTo(sinkChannel);
      receiveDatagram=Datagram.createReceiveDatagram();
      channelContext.setReadingDatagram(receiveDatagram);
      _mockIntraband.handleReading(sourceChannel,channelContext);
      Assert.assertTrue(receiveDatagram.isAckResponse());
      Assert.assertEquals(1,logRecords.size());
      logRecord=logRecords.get(0);
      assertMessageStartWith(logRecord,"Dropped ownerless ACK response ");
      logRecords=captureHandler.resetLogLevel(Level.OFF);
      ackResponseDatagram=Datagram.createACKResponseDatagram(sequenceId);
      ackResponseDatagram.writeTo(sinkChannel);
      receiveDatagram=Datagram.createReceiveDatagram();
      channelContext.setReadingDatagram(receiveDatagram);
      _mockIntraband.handleReading(sourceChannel,channelContext);
      Assert.assertTrue(receiveDatagram.isAckResponse());
      Assert.assertTrue(logRecords.isEmpty());
      requestDatagram=Datagram.createRequestDatagram(_TYPE,_data);
      requestDatagram.setSequenceId(sequenceId);
      RecordCompletionHandler<Object> recordCompletionHandler=new RecordCompletionHandler<>();
      requestDatagram.completionHandler=recordCompletionHandler;
      requestDatagram.timeout=10000;
      _mockIntraband.addResponseWaitingDatagram(requestDatagram);
      ackResponseDatagram=Datagram.createACKResponseDatagram(sequenceId);
      ackResponseDatagram.writeTo(sinkChannel);
      receiveDatagram=Datagram.createReceiveDatagram();
      channelContext.setReadingDatagram(receiveDatagram);
      _mockIntraband.handleReading(sourceChannel,channelContext);
      recordCompletionHandler.waitUntilDelivered();
      Assert.assertTrue(receiveDatagram.isAckResponse());
      logRecords=captureHandler.resetLogLevel(Level.WARNING);
      Datagram responseDatagram=Datagram.createResponseDatagram(requestDatagram,_data);
      responseDatagram.writeTo(sinkChannel);
      receiveDatagram=Datagram.createReceiveDatagram();
      channelContext.setReadingDatagram(receiveDatagram);
      _mockIntraband.handleReading(sourceChannel,channelContext);
      Assert.assertTrue(receiveDatagram.isResponse());
      Assert.assertEquals(0,receiveDatagram.getType());
      dataByteBuffer=receiveDatagram.getDataByteBuffer();
      Assert.assertArrayEquals(_data,dataByteBuffer.array());
      Assert.assertEquals(1,logRecords.size());
      logRecord=logRecords.get(0);
      assertMessageStartWith(logRecord,"Dropped ownerless response ");
      logRecords=captureHandler.resetLogLevel(Level.OFF);
      responseDatagram=Datagram.createResponseDatagram(requestDatagram,_data);
      responseDatagram.writeTo(sinkChannel);
      receiveDatagram=Datagram.createReceiveDatagram();
      channelContext.setReadingDatagram(receiveDatagram);
      _mockIntraband.handleReading(sourceChannel,channelContext);
      Assert.assertTrue(receiveDatagram.isResponse());
      Assert.assertEquals(0,receiveDatagram.getType());
      dataByteBuffer=receiveDatagram.getDataByteBuffer();
      Assert.assertArrayEquals(_data,dataByteBuffer.array());
      Assert.assertTrue(logRecords.isEmpty());
      requestDatagram=Datagram.createRequestDatagram(_TYPE,_data);
      requestDatagram.setSequenceId(sequenceId);
      recordCompletionHandler=new RecordCompletionHandler<>();
      requestDatagram.completionHandler=recordCompletionHandler;
      requestDatagram.completionTypes=BaseIntraband.REPLIED_ENUM_SET;
      requestDatagram.timeout=10000;
      _mockIntraband.addResponseWaitingDatagram(requestDatagram);
      responseDatagram=Datagram.createResponseDatagram(requestDatagram,_data);
      responseDatagram.writeTo(sinkChannel);
      receiveDatagram=Datagram.createReceiveDatagram();
      channelContext.setReadingDatagram(receiveDatagram);
      _mockIntraband.handleReading(sourceChannel,channelContext);
      recordCompletionHandler.waitUntilReplied();
      Assert.assertTrue(receiveDatagram.isResponse());
      Assert.assertEquals(0,receiveDatagram.getType());
      dataByteBuffer=receiveDatagram.getDataByteBuffer();
      Assert.assertArrayEquals(_data,dataByteBuffer.array());
      logRecords=captureHandler.resetLogLevel(Level.WARNING);
      requestDatagram=Datagram.createRequestDatagram(_TYPE,_data);
      requestDatagram.setSequenceId(sequenceId);
      recordCompletionHandler=new RecordCompletionHandler<>();
      requestDatagram.completionHandler=recordCompletionHandler;
      requestDatagram.completionTypes=EnumSet.noneOf(CompletionType.class);
      requestDatagram.timeout=10000;
      _mockIntraband.addResponseWaitingDatagram(requestDatagram);
      responseDatagram=Datagram.createResponseDatagram(requestDatagram,_data);
      responseDatagram.writeTo(sinkChannel);
      receiveDatagram=Datagram.createReceiveDatagram();
      channelContext.setReadingDatagram(receiveDatagram);
      _mockIntraband.handleReading(sourceChannel,channelContext);
      Assert.assertTrue(receiveDatagram.isResponse());
      Assert.assertEquals(0,receiveDatagram.getType());
      dataByteBuffer=receiveDatagram.getDataByteBuffer();
      Assert.assertArrayEquals(_data,dataByteBuffer.array());
      Assert.assertEquals(1,logRecords.size());
      logRecord=logRecords.get(0);
      assertMessageStartWith(logRecord,"Dropped unconcerned response ");
      logRecords=captureHandler.resetLogLevel(Level.OFF);
      requestDatagram=Datagram.createRequestDatagram(_TYPE,_data);
      requestDatagram.setSequenceId(sequenceId);
      recordCompletionHandler=new RecordCompletionHandler<>();
      requestDatagram.completionHandler=recordCompletionHandler;
      requestDatagram.completionTypes=EnumSet.noneOf(CompletionType.class);
      requestDatagram.timeout=10000;
      _mockIntraband.addResponseWaitingDatagram(requestDatagram);
      responseDatagram=Datagram.createResponseDatagram(requestDatagram,_data);
      responseDatagram.writeTo(sinkChannel);
      receiveDatagram=Datagram.createReceiveDatagram();
      channelContext.setReadingDatagram(receiveDatagram);
      _mockIntraband.handleReading(sourceChannel,channelContext);
      Assert.assertTrue(receiveDatagram.isResponse());
      Assert.assertEquals(0,receiveDatagram.getType());
      dataByteBuffer=receiveDatagram.getDataByteBuffer();
      Assert.assertArrayEquals(_data,dataByteBuffer.array());
      Assert.assertTrue(logRecords.isEmpty());
      logRecords=captureHandler.resetLogLevel(Level.WARNING);
      requestDatagram=Datagram.createRequestDatagram(_TYPE,_data);
      requestDatagram.setAckRequest(true);
      requestDatagram.setSequenceId(sequenceId);
      requestDatagram.writeTo(sinkChannel);
      channelContext=new ChannelContext(null);
      receiveDatagram=Datagram.createReceiveDatagram();
      channelContext.setReadingDatagram(receiveDatagram);
      mockRegistrationReference=new MockRegistrationReference(_mockIntraband);
      channelContext.setRegistrationReference(mockRegistrationReference);
      _mockIntraband.handleReading(sourceChannel,channelContext);
      Assert.assertTrue(receiveDatagram.isAckRequest());
      Assert.assertTrue(receiveDatagram.isRequest());
      Assert.assertEquals(_TYPE,receiveDatagram.getType());
      dataByteBuffer=receiveDatagram.getDataByteBuffer();
      Assert.assertArrayEquals(_data,dataByteBuffer.array());
      Assert.assertEquals(1,logRecords.size());
      logRecord=logRecords.get(0);
      assertMessageStartWith(logRecord,"Dropped ownerless request ");
      Assert.assertSame(mockRegistrationReference,_mockIntraband.getRegistrationReference());
      Datagram datagram=_mockIntraband.getDatagram();
      Assert.assertEquals(sequenceId,datagram.getSequenceId());
      Assert.assertTrue(datagram.isAckResponse());
      logRecords=captureHandler.resetLogLevel(Level.SEVERE);
      RecordDatagramReceiveHandler recordDatagramReceiveHandler=new RecordDatagramReceiveHandler();
      _mockIntraband.registerDatagramReceiveHandler(_TYPE,recordDatagramReceiveHandler);
      requestDatagram=Datagram.createRequestDatagram(_TYPE,_data);
      requestDatagram.setAckRequest(true);
      requestDatagram.setSequenceId(sequenceId);
      recordCompletionHandler=new RecordCompletionHandler<>();
      requestDatagram.completionHandler=recordCompletionHandler;
      requestDatagram.timeout=10000;
      _mockIntraband.addResponseWaitingDatagram(requestDatagram);
      requestDatagram.writeTo(sinkChannel);
      receiveDatagram=Datagram.createReceiveDatagram();
      channelContext.setReadingDatagram(receiveDatagram);
      _mockIntraband.handleReading(sourceChannel,channelContext);
      Assert.assertTrue(receiveDatagram.isRequest());
      Assert.assertEquals(_TYPE,receiveDatagram.getType());
      dataByteBuffer=receiveDatagram.getDataByteBuffer();
      Assert.assertArrayEquals(_data,dataByteBuffer.array());
      Datagram recordDatagram=recordDatagramReceiveHandler.getReceiveDatagram();
      Assert.assertSame(receiveDatagram,recordDatagram);
      Assert.assertEquals(_TYPE,recordDatagram.getType());
      dataByteBuffer=recordDatagram.getDataByteBuffer();
      Assert.assertArrayEquals(_data,dataByteBuffer.array());
      Assert.assertEquals(1,logRecords.size());
      logRecord=logRecords.get(0);
      assertMessageStartWith(logRecord,"Unable to dispatch");
      Assert.assertTrue(logRecord.getThrown() instanceof RuntimeException);
      logRecords=captureHandler.resetLogLevel(Level.SEVERE);
      recordDatagramReceiveHandler=new RecordDatagramReceiveHandler(false);
      _mockIntraband.registerDatagramReceiveHandler(_TYPE,recordDatagramReceiveHandler);
      requestDatagram=Datagram.createRequestDatagram(_TYPE,_data);
      requestDatagram.setAckRequest(true);
      requestDatagram.setSequenceId(sequenceId);
      recordCompletionHandler=new RecordCompletionHandler<>();
      requestDatagram.completionHandler=recordCompletionHandler;
      requestDatagram.timeout=10000;
      _mockIntraband.addResponseWaitingDatagram(requestDatagram);
      requestDatagram.writeTo(sinkChannel);
      receiveDatagram=Datagram.createReceiveDatagram();
      channelContext.setReadingDatagram(receiveDatagram);
      _mockIntraband.handleReading(sourceChannel,channelContext);
      Assert.assertTrue(receiveDatagram.isRequest());
      Assert.assertEquals(_TYPE,receiveDatagram.getType());
      dataByteBuffer=receiveDatagram.getDataByteBuffer();
      Assert.assertArrayEquals(_data,dataByteBuffer.array());
      recordDatagram=recordDatagramReceiveHandler.getReceiveDatagram();
      Assert.assertSame(receiveDatagram,recordDatagram);
      Assert.assertEquals(_TYPE,recordDatagram.getType());
      dataByteBuffer=recordDatagram.getDataByteBuffer();
      Assert.assertArrayEquals(_data,dataByteBuffer.array());
      Assert.assertTrue(logRecords.isEmpty());
    }
   }
 }
