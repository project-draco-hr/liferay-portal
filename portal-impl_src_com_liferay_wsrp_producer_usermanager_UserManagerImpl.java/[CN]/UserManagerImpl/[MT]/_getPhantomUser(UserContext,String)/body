{
  User user=null;
  String screenName=_getPhantomUserScreenName(userContext,registrationHandle);
  Company company=null;
  try {
    company=_getWSRPCompany();
    user=UserLocalServiceUtil.getUserByScreenName(company.getCompanyId(),screenName);
  }
 catch (  Exception e) {
    try {
      if (user == null) {
        UserProfile userProfile=userContext.getProfile();
        if (userProfile == null) {
          userProfile=new UserProfile();
        }
        String email=screenName + StringPool.AT + _MAIL_SERVER;
        Contact userContact=userProfile.getBusinessInfo();
        if (userContact != null) {
          Online online=userContact.getOnline();
          if (online != null && online.getEmail() != null) {
            email=online.getEmail();
          }
        }
        boolean gender=false;
        if (userProfile.getGender() != null) {
          gender=Boolean.parseBoolean(userProfile.getGender());
        }
        String givenName=StringPool.BLANK;
        String middleName=StringPool.BLANK;
        String familyName=StringPool.BLANK;
        if (userProfile.getName() != null) {
          givenName=userProfile.getName().getGiven();
          middleName=userProfile.getName().getMiddle();
          familyName=userProfile.getName().getFamily();
        }
        int birthYear=_defaultCalendar.get(Calendar.YEAR);
        int birthMonth=_defaultCalendar.get(Calendar.MONTH);
        int birthDay=_defaultCalendar.get(Calendar.DAY_OF_MONTH);
        if (userProfile.getBdate() != null) {
          birthYear=userProfile.getBdate().getYear();
          birthMonth=userProfile.getBdate().getMonth();
          birthDay=userProfile.getBdate().getDay();
        }
        long organizations[]=new long[0];
        user=UserServiceUtil.addUser(company.getCompanyId(),false,screenName,screenName,false,screenName,email,StringPool.BLANK,Locale.getDefault(),givenName,middleName,familyName,0,0,gender,birthMonth,birthDay,birthYear,StringPool.BLANK,null,organizations,null,null,false,null);
      }
    }
 catch (    Exception ex) {
      _log.error(ex);
      throw new ProducerException(ex);
    }
  }
  return user;
}
