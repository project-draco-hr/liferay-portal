{
  ThemeDisplay themeDisplay=new ThemeDisplay();
  themeDisplay.setCompany(PortalUtil.getCompany(request));
  themeDisplay.setUser(themeDisplay.getDefaultUser());
  themeDisplay.setLocale(request.getLocale());
  Group guestGroup=GroupLocalServiceUtil.getGroup(PortalInstances.getCompanyId(request),GroupConstants.GUEST);
  List<Layout> layouts=LayoutLocalServiceUtil.getLayouts(guestGroup.getGroupId(),false,LayoutConstants.DEFAULT_PARENT_LAYOUT_ID);
  Layout layout=null;
  if (layouts.size() > 0) {
    layout=layouts.get(0);
  }
  themeDisplay.setLayout(layout);
  themeDisplay.setScopeGroupId(layout.getGroupId());
  PermissionChecker permissionChecker=(PermissionChecker)Class.forName(PropsValues.PERMISSIONS_CHECKER).newInstance();
  permissionChecker.init(themeDisplay.getUser(),true);
  themeDisplay.setPermissionChecker(permissionChecker);
  PermissionThreadLocal.setPermissionChecker(permissionChecker);
  long companyId=PortalInstances.getCompanyId(request);
  CompanyThreadLocal.setCompanyId(companyId);
  long userId=themeDisplay.getUserId();
  PrincipalThreadLocal.setName(String.valueOf(userId));
  request.setAttribute(WebKeys.CTX,ProducerThreadLocalizer.getContext());
  request.setAttribute(WebKeys.LAYOUT,layout);
  request.setAttribute(WebKeys.THEME_DISPLAY,themeDisplay);
}
