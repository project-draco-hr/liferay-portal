{
  try {
    UserContext userContext=new UserContext();
    userContext.setUserContextKey(userKey);
    User phantomUser=_getPhantomUser(userContext,registrationHandle);
    request.setAttribute(_IS_WSRP_REQUEST,"true");
    String portletId=(String)request.getAttribute(_PORTAL_ID);
    Portlet portlet=PortletLocalServiceUtil.getPortletById(PortalInstances.getCompanyId(request),portletId);
    PortletWindowContext portletWindowContext=new PortletWindowContextImpl(request,portlet,PortletRequest.ACTION_PHASE);
    initializeLiferayRequest(request,phantomUser);
    return portletWindowContext;
  }
 catch (  Exception e) {
    _log.error(e,e);
    throw new ProducerException(e);
  }
}
