{
  ThemeDisplay themeDisplay=new ThemeDisplay();
  themeDisplay.setCompany(PortalUtil.getCompany(request));
  themeDisplay.setUser(user);
  Group guestGroup=GroupLocalServiceUtil.getGroup(PortalInstances.getCompanyId(request),GroupConstants.GUEST);
  Group userGroup=user.getGroup();
  if (userGroup == null) {
    userGroup=guestGroup;
  }
  Layout layout=null;
  List<Layout> layouts=LayoutLocalServiceUtil.getLayouts(userGroup.getGroupId(),true,LayoutConstants.DEFAULT_PARENT_LAYOUT_ID);
  if (layouts.size() > 0) {
    layout=layouts.get(0);
  }
  if (layout == null) {
    String friendlyURL=_getFriendlyURL(PropsValues.DEFAULT_USER_PRIVATE_LAYOUT_FRIENDLY_URL);
    layout=LayoutLocalServiceUtil.addLayout(user.getUserId(),userGroup.getGroupId(),true,LayoutConstants.DEFAULT_PARENT_LAYOUT_ID,PropsValues.DEFAULT_USER_PRIVATE_LAYOUT_NAME,StringPool.BLANK,StringPool.BLANK,LayoutConstants.TYPE_PORTLET,false,friendlyURL);
  }
  themeDisplay.setLayout(layout);
  request.setAttribute(WebKeys.THEME_DISPLAY,themeDisplay);
  request.setAttribute(WebKeys.LAYOUT,layout);
}
