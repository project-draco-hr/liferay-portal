{
  long companyId=0;
  long companyGroupId=0;
  long groupId=0;
  if (themeDisplay != null) {
    companyId=themeDisplay.getCompanyId();
    companyGroupId=themeDisplay.getCompanyGroupId();
    groupId=themeDisplay.getScopeGroupId();
  }
 else   if (tokens != null) {
    companyId=GetterUtil.getLong(tokens.get("company_id"));
    companyGroupId=GetterUtil.getLong(tokens.get("company_group_id"));
    groupId=GetterUtil.getLong(tokens.get("group_id"));
  }
  String templateId=tokens.get("template_id");
  templateId=getTemplateId(templateId,companyId,companyGroupId,groupId);
  TemplateResource templateResource=null;
  if (langType.equals(TemplateConstants.LANG_TYPE_XSL)) {
    XSLURIResolver xslURIResolver=new JournalXSLURIResolver(tokens,languageId);
    templateResource=new XSLTemplateResource(templateId,script,xslURIResolver,xml);
  }
 else {
    templateResource=new StringTemplateResource(templateId,script);
  }
  TemplateResource errorTemplateResource=getErrorTemplateResource(langType);
  TemplateContextType templateContextType=getTemplateContextType(langType);
  return TemplateManagerUtil.getTemplate(langType,templateResource,errorTemplateResource,templateContextType);
}
