{
  ObjectInputStream ois=new ObjectInputStream(req.getInputStream());
  Object returnObj=null;
  try {
    ObjectValuePair ovp=(ObjectValuePair)ois.readObject();
    HttpPrincipal httpPrincipal=(HttpPrincipal)ovp.getKey();
    MethodWrapper methodWrapper=(MethodWrapper)ovp.getValue();
    PrincipalThreadLocal.setName(httpPrincipal.getUserId());
    if (returnObj == null) {
      returnObj=MethodInvoker.invoke(methodWrapper);
    }
  }
 catch (  InvocationTargetException ite) {
    returnObj=ite.getCause();
    if (!(returnObj instanceof PortalException)) {
      ite.printStackTrace();
      returnObj=new SystemException();
    }
  }
catch (  Exception e) {
    e.printStackTrace();
  }
  if (returnObj != null) {
    ObjectOutputStream oos=new ObjectOutputStream(res.getOutputStream());
    oos.writeObject(returnObj);
    oos.flush();
    oos.close();
  }
}
