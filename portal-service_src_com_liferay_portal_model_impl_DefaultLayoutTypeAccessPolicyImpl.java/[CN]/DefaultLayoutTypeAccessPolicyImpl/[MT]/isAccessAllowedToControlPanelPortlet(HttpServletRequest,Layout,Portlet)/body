{
  PermissionChecker permissionChecker=PermissionThreadLocal.getPermissionChecker();
  ThemeDisplay themeDisplay=(ThemeDisplay)request.getAttribute(WebKeys.THEME_DISPLAY);
  if (PortletPermissionUtil.hasControlPanelAccessPermission(permissionChecker,themeDisplay.getScopeGroupId(),portlet)) {
    return;
  }
  if (isAccessGrantedByRuntimePortlet(request)) {
    return;
  }
  if (isAccessGrantedByPortletAuthenticationToken(request,layout,portlet)) {
    return;
  }
  throw new PrincipalException("User does not have permission to access control panel portlet " + portlet.getPortletId());
}
