{
  User user=userPersistence.findByPrimaryKey(userId);
  long groupId=serviceContext.getScopeGroupId();
  Date now=new Date();
  long tagId=counterLocalService.increment();
  AssetTag tag=assetTagPersistence.create(tagId);
  tag.setGroupId(groupId);
  tag.setCompanyId(user.getCompanyId());
  tag.setUserId(user.getUserId());
  tag.setUserName(user.getFullName());
  tag.setCreateDate(now);
  tag.setModifiedDate(now);
  name=name.trim();
  name=StringUtil.toLowerCase(name);
  if (hasTag(groupId,name)) {
    throw new DuplicateTagException("A tag with the name " + name + " already exists");
  }
  validate(name);
  tag.setName(name);
  assetTagPersistence.update(tag);
  if (serviceContext.isAddGroupPermissions() || serviceContext.isAddGuestPermissions()) {
    addTagResources(tag,serviceContext.isAddGroupPermissions(),serviceContext.isAddGuestPermissions());
  }
 else {
    addTagResources(tag,serviceContext.getGroupPermissions(),serviceContext.getGuestPermissions());
  }
  return tag;
}
