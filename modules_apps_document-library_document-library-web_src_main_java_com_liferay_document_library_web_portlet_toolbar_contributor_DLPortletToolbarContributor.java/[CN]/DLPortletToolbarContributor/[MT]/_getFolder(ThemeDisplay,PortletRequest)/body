{
  Folder folder=(Folder)portletRequest.getAttribute(WebKeys.DOCUMENT_LIBRARY_FOLDER);
  if (folder != null) {
    return folder;
  }
  PortletDisplay portletDisplay=themeDisplay.getPortletDisplay();
  long rootFolderId=DLFolderConstants.DEFAULT_PARENT_FOLDER_ID;
  try {
    DLPortletInstanceSettings dlPortletInstanceSettings=DLPortletInstanceSettings.getInstance(themeDisplay.getLayout(),portletDisplay.getId());
    rootFolderId=dlPortletInstanceSettings.getRootFolderId();
  }
 catch (  PortalException pe) {
    _log.error(pe,pe);
  }
  long folderId=BeanParamUtil.getLong(folder,portletRequest,"folderId",rootFolderId);
  if (folderId != DLFolderConstants.DEFAULT_PARENT_FOLDER_ID) {
    try {
      folder=_dlAppLocalService.getFolder(folderId);
    }
 catch (    NoSuchFolderException nsfe) {
      folder=null;
    }
catch (    PortalException pe) {
      _log.error(pe,pe);
    }
  }
  return folder;
}
