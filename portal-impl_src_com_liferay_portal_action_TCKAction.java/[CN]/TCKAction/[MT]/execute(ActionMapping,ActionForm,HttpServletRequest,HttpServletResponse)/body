{
  try {
    if (!PropsValues.TCK_URL) {
      throw new PrincipalException("TCK testing is disabled");
    }
    User user=_getUser(request);
    ThemeDisplay themeDisplay=(ThemeDisplay)request.getAttribute(WebKeys.THEME_DISPLAY);
    String[] portletIds=request.getParameterValues("portletId");
    if (portletIds == null) {
      portletIds=request.getParameterValues("portletName");
    }
    for (int i=0; i < portletIds.length; i++) {
      String[] nameAndWar=StringUtil.split(portletIds[i],'/');
      portletIds[i]=PortalUtil.getJsSafePortletId(nameAndWar[1] + PortletConstants.WAR_SEPARATOR + nameAndWar[0]);
    }
    long userId=user.getUserId();
    long groupId=user.getGroup().getGroupId();
    ServiceContext serviceContext=new ServiceContext();
    Layout layout=LayoutLocalServiceUtil.addLayout(userId,groupId,false,LayoutConstants.DEFAULT_PARENT_LAYOUT_ID,"TCKAction",StringPool.BLANK,StringPool.BLANK,LayoutConstants.TYPE_PORTLET,false,StringPool.BLANK,serviceContext);
    LayoutTypePortlet layoutType=(LayoutTypePortlet)layout.getLayoutType();
    for (    String portletId : portletIds) {
      layoutType.addPortletId(userId,portletId,false);
      String rootPortletId=PortletConstants.getRootPortletId(portletId);
      String portletPrimaryKey=PortletPermissionUtil.getPrimaryKey(layout.getPlid(),portletId);
      ResourceLocalServiceUtil.addResources(user.getCompanyId(),groupId,0,rootPortletId,portletPrimaryKey,true,true,true);
    }
    LayoutLocalServiceUtil.updateLayout(layout.getGroupId(),layout.isPrivateLayout(),layout.getLayoutId(),layout.getTypeSettings());
    request.setAttribute(WebKeys.FORWARD_URL,themeDisplay.getPathMain() + "/portal/layout?p_l_id=" + layout.getPlid());
    return mapping.findForward(ActionConstants.COMMON_FORWARD_JSP);
  }
 catch (  Exception e) {
    if (_log.isWarnEnabled()) {
      _log.warn(e,e);
    }
    PortalUtil.sendError(e,request,response);
    return null;
  }
}
