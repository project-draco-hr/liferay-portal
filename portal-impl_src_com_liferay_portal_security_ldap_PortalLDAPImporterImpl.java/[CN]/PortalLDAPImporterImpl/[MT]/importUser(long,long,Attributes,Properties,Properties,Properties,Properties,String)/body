{
  LDAPUserTransactionThreadLocal.setOriginatesFromLDAP(true);
  try {
    AttributesTransformer attributesTransformer=AttributesTransformerFactory.getInstance();
    attributes=attributesTransformer.transformUser(attributes);
    LDAPUser ldapUser=_ldapToPortalConverter.importLDAPUser(companyId,attributes,userMappings,userExpandoMappings,contactMappings,contactExpandoMappings,password);
    User user=getUser(companyId,ldapUser);
    if ((user != null) && user.isDefaultUser()) {
      return user;
    }
    ServiceContext serviceContext=ldapUser.getServiceContext();
    serviceContext.setAttribute("ldapServerId",ldapServerId);
    if (user == null) {
      user=addUser(companyId,ldapUser,password);
    }
    String modifiedDate=LDAPUtil.getAttributeString(attributes,"modifyTimestamp");
    user=updateUser(companyId,ldapUser,user,userMappings,contactMappings,password,modifiedDate);
    updateExpandoAttributes(user,ldapUser,userExpandoMappings,contactExpandoMappings);
    return user;
  }
  finally {
    LDAPUserTransactionThreadLocal.setOriginatesFromLDAP(false);
  }
}
