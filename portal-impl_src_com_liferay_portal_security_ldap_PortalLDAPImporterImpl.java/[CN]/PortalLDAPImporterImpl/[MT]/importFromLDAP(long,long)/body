{
  if (!LDAPSettingsUtil.isImportEnabled(companyId)) {
    return;
  }
  LdapContext ldapContext=PortalLDAPUtil.getContext(ldapServerId,companyId);
  if (ldapContext == null) {
    return;
  }
  try {
    String importMethod=PrefsPropsUtil.getString(companyId,PropsKeys.LDAP_IMPORT_METHOD);
    Properties userMappings=LDAPSettingsUtil.getUserMappings(ldapServerId,companyId);
    Properties groupMappings=LDAPSettingsUtil.getGroupMappings(ldapServerId,companyId);
    Properties userExpandoMappings=LDAPSettingsUtil.getUserExpandoMappings(ldapServerId,companyId);
    Properties contactMappings=LDAPSettingsUtil.getContactMappings(ldapServerId,companyId);
    Properties contactExpandoMappings=LDAPSettingsUtil.getContactExpandoMappings(ldapServerId,companyId);
    if (importMethod.equals(_IMPORT_BY_USER)) {
      List<SearchResult> searchResults=PortalLDAPUtil.getUsers(ldapServerId,companyId,ldapContext,0);
      for (      SearchResult searchResult : searchResults) {
        try {
          Attributes userAttributes=PortalLDAPUtil.getUserAttributes(ldapServerId,companyId,ldapContext,PortalLDAPUtil.getNameInNamespace(ldapServerId,companyId,searchResult));
          User user=addUserFromLdap(companyId,userMappings,userExpandoMappings,contactMappings,contactExpandoMappings,userAttributes,StringPool.BLANK);
          importGroupsAndMembershipFromLDAPUser(ldapServerId,companyId,ldapContext,userAttributes,user,userMappings,groupMappings);
        }
 catch (        Exception e) {
          _log.error("Unable to import user " + searchResult,e);
        }
      }
    }
 else     if (importMethod.equals(_IMPORT_BY_GROUP)) {
      List<SearchResult> searchResults=PortalLDAPUtil.getGroups(ldapServerId,companyId,ldapContext,0);
      for (      SearchResult searchResult : searchResults) {
        try {
          Attributes attributes=PortalLDAPUtil.getGroupAttributes(ldapServerId,companyId,ldapContext,PortalLDAPUtil.getNameInNamespace(ldapServerId,companyId,searchResult),true);
          UserGroup userGroup=addUserGroupFromLdap(companyId,attributes,groupMappings);
          Attribute usersAttribute=getUsersInUserGroup(ldapServerId,companyId,ldapContext,attributes,userGroup,groupMappings);
          if (usersAttribute == null) {
            if (_log.isInfoEnabled()) {
              _log.info("No users found in : " + userGroup.getName());
            }
            continue;
          }
          importUsersAndMembershipFromLDAPGroup(ldapServerId,companyId,ldapContext,userMappings,userExpandoMappings,contactMappings,contactExpandoMappings,userGroup.getUserGroupId(),usersAttribute);
        }
 catch (        Exception e) {
          _log.error("Unable to import group: " + searchResult,e);
        }
      }
    }
  }
 catch (  Exception e) {
    _log.error("Error importing LDAP users and groups",e);
  }
 finally {
    if (ldapContext != null) {
      ldapContext.close();
    }
  }
}
