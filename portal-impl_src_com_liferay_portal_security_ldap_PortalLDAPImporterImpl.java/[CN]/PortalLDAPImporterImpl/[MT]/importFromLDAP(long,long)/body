{
  if (!LDAPSettingsUtil.isImportEnabled(companyId)) {
    return;
  }
  LdapContext ldapContext=PortalLDAPUtil.getContext(ldapServerId,companyId);
  if (ldapContext == null) {
    return;
  }
  if (!PropsValues.LDAP_IMPORT_GROUP_CACHE_ENABLED) {
    _localGroupDNCache.set(new HashMap<String,Long>());
  }
  try {
    Properties userMappings=LDAPSettingsUtil.getUserMappings(ldapServerId,companyId);
    Properties userExpandoMappings=LDAPSettingsUtil.getUserExpandoMappings(ldapServerId,companyId);
    Properties contactMappings=LDAPSettingsUtil.getContactMappings(ldapServerId,companyId);
    Properties contactExpandoMappings=LDAPSettingsUtil.getContactExpandoMappings(ldapServerId,companyId);
    Properties groupMappings=LDAPSettingsUtil.getGroupMappings(ldapServerId,companyId);
    String importMethod=PrefsPropsUtil.getString(companyId,PropsKeys.LDAP_IMPORT_METHOD);
    if (importMethod.equals(_IMPORT_BY_GROUP)) {
      importFromLDAPByGroup(ldapServerId,companyId,ldapContext,userMappings,userExpandoMappings,contactMappings,contactExpandoMappings,groupMappings);
    }
 else     if (importMethod.equals(_IMPORT_BY_USER)) {
      importFromLDAPByUser(ldapServerId,companyId,ldapContext,userMappings,userExpandoMappings,contactMappings,contactExpandoMappings,groupMappings);
    }
  }
 catch (  Exception e) {
    _log.error("Error importing LDAP users and groups",e);
  }
 finally {
    _localGroupDNCache.remove();
    if (ldapContext != null) {
      ldapContext.close();
    }
  }
}
