{
  if (!LDAPSettingsUtil.isImportEnabled(companyId)) {
    return;
  }
  LdapContext ldapContext=PortalLDAPUtil.getContext(ldapServerId,companyId);
  if (ldapContext == null) {
    return;
  }
  try {
    String importMethod=PrefsPropsUtil.getString(companyId,PropsKeys.LDAP_IMPORT_METHOD);
    if (importMethod.equals(_IMPORT_BY_USER)) {
      List<SearchResult> searchResults=PortalLDAPUtil.getUsers(ldapServerId,companyId,ldapContext,0);
      for (      SearchResult searchResult : searchResults) {
        Attributes attributes=PortalLDAPUtil.getUserAttributes(ldapServerId,companyId,ldapContext,PortalLDAPUtil.getNameInNamespace(ldapServerId,companyId,searchResult));
        try {
          importLDAPUser(ldapServerId,companyId,ldapContext,attributes,StringPool.BLANK,true);
        }
 catch (        Exception e) {
          if (_log.isErrorEnabled()) {
            _log.error("Unable to import user: " + searchResult,e);
          }
        }
      }
    }
 else     if (importMethod.equals(_IMPORT_BY_GROUP)) {
      List<SearchResult> searchResults=PortalLDAPUtil.getGroups(ldapServerId,companyId,ldapContext,0);
      for (      SearchResult searchResult : searchResults) {
        Attributes attributes=PortalLDAPUtil.getGroupAttributes(ldapServerId,companyId,ldapContext,PortalLDAPUtil.getNameInNamespace(ldapServerId,companyId,searchResult),true);
        importLDAPGroup(ldapServerId,companyId,ldapContext,attributes,true);
      }
    }
  }
 catch (  Exception e) {
    _log.error("Error importing LDAP users and groups",e);
  }
 finally {
    if (ldapContext != null) {
      ldapContext.close();
    }
  }
}
