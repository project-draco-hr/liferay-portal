{
  int result=DNE;
  User user=null;
  try {
    if (userId > 0) {
      user=UserLocalServiceUtil.getUserById(companyId,userId);
    }
 else     if (Validator.isNotNull(emailAddress)) {
      user=UserLocalServiceUtil.getUserByEmailAddress(companyId,emailAddress);
    }
 else     if (Validator.isNotNull(screenName)) {
      user=UserLocalServiceUtil.getUserByScreenName(companyId,screenName);
    }
 else {
      if (_log.isDebugEnabled()) {
        _log.debug("No user credentials found, cannot fetch preferred LDAP server");
      }
      return result;
    }
  }
 catch (  NoSuchUserException nsue) {
    if (_log.isDebugEnabled()) {
      _log.debug("User not found, cannot fetch preferred LDAP server",nsue);
    }
    return result;
  }
  long ldapServerId=user.getLdapServerId();
  if (ldapServerId < 0) {
    return result;
  }
  String postfix=LDAPSettingsUtil.getPropertyPostfix(ldapServerId);
  String providerUrl=PrefsPropsUtil.getString(user.getCompanyId(),PropsKeys.LDAP_BASE_PROVIDER_URL + postfix);
  if (Validator.isNull(providerUrl)) {
    return result;
  }
  if (_log.isDebugEnabled()) {
    _log.debug("Using ldapServerId: " + ldapServerId + " to authenticate user: "+ user.getScreenName());
  }
  result=authenticate(ldapServerId,companyId,emailAddress,screenName,userId,password);
  return result;
}
