{
  LDAPAuthResult ldapAuthResult=new LDAPAuthResult();
  String authMethod=PrefsPropsUtil.getString(companyId,PropsUtil.LDAP_AUTH_METHOD);
  String userDN=binding.getName() + StringPool.COMMA + baseDN;
  if (authMethod.equals(AUTH_METHOD_BIND)) {
    try {
      env.put(Context.SECURITY_PRINCIPAL,userDN);
      env.put(Context.SECURITY_CREDENTIALS,password);
      ctx=new InitialLdapContext(env,null);
      Control[] responseControls=ctx.getResponseControls();
      ldapAuthResult.setAuthenticated(true);
      ldapAuthResult.setResponseControl(responseControls);
    }
 catch (    Exception e) {
      _log.error("Failed to bind to the LDAP server with userDN " + userDN + " and password "+ password+ ": "+ e.getMessage());
      ldapAuthResult.setAuthenticated(false);
      ldapAuthResult.setErrorMessage(e.getMessage());
    }
  }
 else   if (authMethod.equals(AUTH_METHOD_PASSWORD_COMPARE)) {
    if (userPassword != null) {
      String ldapPassword=new String((byte[])userPassword.get());
      String encryptedPassword=password;
      String algorithm=PrefsPropsUtil.getString(companyId,PropsUtil.LDAP_AUTH_PASSWORD_ENCRYPTION_ALGORITHM);
      if (Validator.isNotNull(algorithm)) {
        encryptedPassword="{" + algorithm + "}"+ PwdEncryptor.encrypt(algorithm,password,ldapPassword);
      }
      if (ldapPassword.equals(encryptedPassword)) {
        ldapAuthResult.setAuthenticated(true);
      }
 else {
        ldapAuthResult.setAuthenticated(false);
        _log.error("LDAP password " + ldapPassword + " does not match with given password "+ encryptedPassword+ " for user id "+ userId);
      }
    }
  }
  return ldapAuthResult;
}
