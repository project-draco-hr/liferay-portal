{
  Registry registry=RegistryUtil.getRegistry();
  RegistryWrapper registryWrapper=new RegistryWrapper(registry);
  RegistryUtil.setRegistry(registryWrapper);
  ServiceTrackerMap<String,TrackedOne> serviceTrackerMap=createServiceTrackerMap();
  ServiceRegistration<TrackedOne> sr1=registerService(new TrackedOne());
  ServiceRegistration<TrackedOne> sr2=registerService(new TrackedOne());
  sr2.unregister();
  sr2=registerService(new TrackedOne());
  sr2.unregister();
  Collection<AtomicInteger> values=registryWrapper.getReferences().values();
  Assert.assertEquals(3,values.size());
  for (  AtomicInteger i : registryWrapper.getReferences().values()) {
    int count=i.get();
    Assert.assertEquals(1,count);
  }
  serviceTrackerMap.close();
  RegistryUtil.setRegistry(registry);
}
