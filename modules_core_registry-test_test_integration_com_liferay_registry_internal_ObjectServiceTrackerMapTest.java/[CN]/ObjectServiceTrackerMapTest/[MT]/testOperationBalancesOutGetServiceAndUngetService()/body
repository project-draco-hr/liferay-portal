{
  RegistryWrapper registryWrapper=getRegistryWrapper();
  try (ServiceTrackerMap<String,TrackedOne> serviceTrackerMap=createServiceTrackerMap()){
    ServiceRegistration<TrackedOne> serviceRegistration1=registerService(new TrackedOne());
    ServiceRegistration<TrackedOne> serviceRegistration2=registerService(new TrackedOne());
    serviceRegistration2.unregister();
    serviceRegistration2=registerService(new TrackedOne());
    serviceRegistration2.unregister();
    serviceRegistration1.unregister();
    Map<ServiceReference<?>,AtomicInteger> serviceReferenceCountsMap=registryWrapper.getServiceReferenceCountsMap();
    Collection<AtomicInteger> serviceReferenceCounts=serviceReferenceCountsMap.values();
    Assert.assertEquals(3,serviceReferenceCounts.size());
    for (    AtomicInteger serviceReferenceCount : serviceReferenceCounts) {
      Assert.assertEquals(0,serviceReferenceCount.get());
    }
  }
  finally {
    RegistryUtil.setRegistry(registryWrapper.getWrappedRegistry());
  }
}
