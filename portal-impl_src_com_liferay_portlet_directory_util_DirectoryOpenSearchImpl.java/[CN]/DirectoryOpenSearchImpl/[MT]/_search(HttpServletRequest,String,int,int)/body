{
  ThemeDisplay themeDisplay=(ThemeDisplay)req.getAttribute(WebKeys.THEME_DISPLAY);
  int begin=(startPage * itemsPerPage) - itemsPerPage;
  int end=startPage * itemsPerPage;
  List results=UserLocalServiceUtil.search(themeDisplay.getCompanyId(),keywords,Boolean.TRUE,null,begin,end,new ContactLastNameComparator(true));
  int total=UserLocalServiceUtil.searchCount(themeDisplay.getCompanyId(),keywords,Boolean.TRUE,null);
  Object[] values=addSearchResults(keywords,startPage,itemsPerPage,total,null,"Liferay Directory Search: " + keywords,SEARCH_PATH,themeDisplay);
  org.dom4j.Document doc=(org.dom4j.Document)values[1];
  Element root=(Element)values[2];
  for (int i=0; i < results.size(); i++) {
    User user=(User)results.get(i);
    String portletId=PortletKeys.DIRECTORY;
    String portletTitle=PortalUtil.getPortletTitle(portletId,themeDisplay.getUser());
    PortletURL portletURL=getPortletURL(req,portletId);
    String title=user.getFullName();
    String url=portletURL.toString();
    Date modifedDate=user.getModifiedDate();
    String content=user.getFullName() + " &lt;" + user.getEmailAddress()+ "&gt;";
    double score=1.0;
    addSearchResult(root,portletTitle + " &raquo; " + title,url,modifedDate,content,score);
  }
  if (_log.isDebugEnabled()) {
    _log.debug("Return\n" + doc.asXML());
  }
  return doc.asXML();
}
