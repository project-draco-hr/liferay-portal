{
  ServletContext servletContext=servletContextEvent.getServletContext();
  String contextPath=servletContext.getRealPath(StringPool.BLANK);
  String embeddedLibsDir=servletContext.getInitParameter("embeddedLibsDir");
  File embeddedLibsFolder=new File(contextPath,embeddedLibsDir);
  if (!embeddedLibsFolder.exists() || !embeddedLibsFolder.isDirectory()) {
    _log.error("Can not find embedded libs folder : " + embeddedLibsFolder.getAbsolutePath());
    return;
  }
  List<File> jarFiles=new ArrayList<File>();
  for (  File file : embeddedLibsFolder.listFiles()) {
    String fileName=file.getName();
    if (fileName.endsWith(".jar")) {
      jarFiles.add(file);
    }
  }
  StringBundler sb=new StringBundler(jarFiles.size() * 2 + 4);
  for (  File file : jarFiles) {
    sb.append(file.getAbsolutePath());
    sb.append(File.pathSeparator);
  }
  if (_log.isDebugEnabled()) {
    _log.debug("Generated embedded libs classpath : " + sb.toString());
  }
  sb.append(contextPath);
  sb.append("/WEB-INF/classes");
  sb.append(File.pathSeparator);
  sb.append(ClassPathUtil.getGlobalClassPath());
  SPI_CLASSPATH=sb.toString();
  if (_log.isDebugEnabled()) {
    _log.debug("Generated SPI classpath : " + SPI_CLASSPATH);
  }
  String spiProviderClassName=servletContext.getInitParameter("spiProviderClassName");
  Thread currentThread=Thread.currentThread();
  ClassLoader contextClassLoader=currentThread.getContextClassLoader();
  try {
    Class<SPIProvider> spiProviderClass=(Class<SPIProvider>)loadClassDirectly(contextClassLoader,spiProviderClassName);
    SPIProvider spiProvider=spiProviderClass.newInstance();
    boolean result=spiProviderReference.compareAndSet(null,spiProvider);
    if (!result) {
      _log.error("Unable to register generated SPIProvider " + spiProvider + ". A SPIProvider already registered in this "+ "ServletContext "+ servletContext);
    }
 else {
      MPIHelperUtil.registerSPIProvider(spiProvider);
    }
  }
 catch (  Exception e) {
    _log.error("Unable to create SPIProvide with name " + spiProviderClassName,e);
  }
}
