{
  try {
    if (readableByteChannel == null) {
      throw new IllegalArgumentException("Readable byte channel cannot be null");
    }
    if (writableByteChannel == null) {
      throw new IllegalArgumentException("Writable byte channel cannot be null");
    }
    ByteBuffer byteBuffer=ByteBuffer.allocateDirect(bufferSize);
    while (readableByteChannel.read(byteBuffer) != -1) {
      byteBuffer.flip();
      writableByteChannel.write(byteBuffer);
      byteBuffer.compact();
    }
    byteBuffer.flip();
    while (byteBuffer.hasRemaining()) {
      writableByteChannel.write(byteBuffer);
    }
  }
  finally {
    if (cleanUp) {
      cleanUp(readableByteChannel,writableByteChannel);
    }
  }
}
