{
  ThemeDisplay themeDisplay=(ThemeDisplay)req.getAttribute(WebKeys.THEME_DISPLAY);
  Layout layout=themeDisplay.getLayout();
  Boolean layoutDefault=(Boolean)req.getAttribute(WebKeys.LAYOUT_DEFAULT);
  if ((layoutDefault != null) && (layoutDefault.booleanValue())) {
    Layout requestedLayout=(Layout)req.getAttribute(WebKeys.REQUESTED_LAYOUT);
    if (requestedLayout != null) {
      String redirect=themeDisplay.getURLSignIn() + "?redirect=" + PortalUtil.getLayoutURL(requestedLayout,themeDisplay);
      if (_log.isDebugEnabled()) {
        _log.debug("Redirect requested layout to " + redirect);
      }
      res.sendRedirect(redirect);
    }
 else {
      String redirect=PortalUtil.getLayoutURL(layout,themeDisplay);
      if (_log.isDebugEnabled()) {
        _log.debug("Redirect default layout to " + redirect);
      }
      res.sendRedirect(redirect);
    }
    return null;
  }
  long plid=ParamUtil.getLong(req,"p_l_id");
  boolean resetLayout=ParamUtil.getBoolean(req,"p_l_reset",PropsValues.LAYOUT_DEFAULT_P_L_RESET);
  String action=ParamUtil.getString(req,"p_p_action");
  if (plid > 0) {
    try {
      if (resetLayout) {
        RenderParametersPool.clear(req,plid);
      }
      if (action.equals("1")) {
        Portlet portlet=processActionRequest(req,res);
        if (portlet != null) {
          ActionResponseImpl actionResponseImpl=(ActionResponseImpl)req.getAttribute(JavaConstants.JAVAX_PORTLET_RESPONSE);
          String redirectLocation=actionResponseImpl.getRedirectLocation();
          if (Validator.isNotNull(redirectLocation)) {
            res.sendRedirect(redirectLocation);
            return null;
          }
          if (portlet.isActionURLRedirect()) {
            redirectActionURL(req,res,actionResponseImpl,portlet);
          }
        }
      }
 else       if (action.equals("0")) {
        processRenderRequest(req,res);
      }
      if (layout != null) {
        includeLayoutContent(req,res,themeDisplay,layout);
      }
      return mapping.findForward("portal.layout");
    }
 catch (    Exception e) {
      req.setAttribute(PageContext.EXCEPTION,e);
      return mapping.findForward(ActionConstants.COMMON_ERROR);
    }
 finally {
      try {
        if (action.equals("1")) {
          ActionRequestImpl actionRequestImpl=(ActionRequestImpl)req.getAttribute(JavaConstants.JAVAX_PORTLET_REQUEST);
          ActionRequestFactory.recycle(actionRequestImpl);
        }
      }
 catch (      Exception e) {
        _log.error(e);
      }
      req.removeAttribute(JavaConstants.JAVAX_PORTLET_REQUEST);
      try {
        if (action.equals("1")) {
          ActionResponseImpl actionResponseImpl=(ActionResponseImpl)req.getAttribute(JavaConstants.JAVAX_PORTLET_RESPONSE);
          ActionResponseFactory.recycle(actionResponseImpl);
        }
      }
 catch (      Exception e) {
        _log.error(e);
      }
      req.removeAttribute(JavaConstants.JAVAX_PORTLET_RESPONSE);
    }
  }
 else {
    try {
      forwardLayout(req);
      return mapping.findForward(ActionConstants.COMMON_FORWARD);
    }
 catch (    Exception e) {
      req.setAttribute(PageContext.EXCEPTION,e);
      return mapping.findForward(ActionConstants.COMMON_ERROR);
    }
  }
}
