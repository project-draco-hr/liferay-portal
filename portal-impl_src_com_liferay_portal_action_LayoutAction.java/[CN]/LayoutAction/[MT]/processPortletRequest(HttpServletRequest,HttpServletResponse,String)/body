{
  HttpSession ses=req.getSession();
  long companyId=PortalUtil.getCompanyId(req);
  User user=PortalUtil.getUser(req);
  Layout layout=(Layout)req.getAttribute(WebKeys.LAYOUT);
  String portletId=ParamUtil.getString(req,"p_p_id");
  Portlet portlet=PortletLocalServiceUtil.getPortletById(companyId,portletId);
  if (portlet == null) {
    return null;
  }
  ServletContext ctx=(ServletContext)req.getAttribute(WebKeys.CTX);
  InvokerPortlet invokerPortlet=PortletInstanceFactory.create(portlet,ctx);
  if (user != null) {
    InvokerPortlet.clearResponse(ses,layout.getPrimaryKey(),portletId,LanguageUtil.getLanguageId(req));
  }
  PortletConfig portletConfig=PortletConfigFactory.create(portlet,ctx);
  PortletContext portletCtx=portletConfig.getPortletContext();
  WindowState windowState=WindowStateFactory.getWindowState(ParamUtil.getString(req,"p_p_state"));
  PortletMode portletMode=PortletModeFactory.getPortletMode(ParamUtil.getString(req,"p_p_mode"));
  PortletPreferencesIds portletPreferencesIds=PortletPreferencesFactoryUtil.getPortletPreferencesIds(req,portletId);
  PortletPreferences portletPreferences=PortletPreferencesLocalServiceUtil.getPreferences(portletPreferencesIds);
  if (lifecycle.equals(PortletRequest.ACTION_PHASE)) {
    String contentType=req.getHeader(HttpHeaders.CONTENT_TYPE);
    if (_log.isDebugEnabled()) {
      _log.debug("Content type " + contentType);
    }
    UploadServletRequest uploadReq=null;
    try {
      if ((contentType != null) && (contentType.startsWith(ContentTypes.MULTIPART_FORM_DATA))) {
        if (!invokerPortlet.getPortletConfig().isWARFile() || invokerPortlet.isStrutsPortlet()) {
          uploadReq=new UploadServletRequestImpl(req);
          req=uploadReq;
        }
      }
      ActionRequestImpl actionReqImpl=ActionRequestFactory.create(req,portlet,invokerPortlet,portletCtx,windowState,portletMode,portletPreferences,layout.getPlid());
      ActionResponseImpl actionResImpl=ActionResponseFactory.create(actionReqImpl,res,portletId,user,layout,windowState,portletMode);
      actionReqImpl.defineObjects(portletConfig,actionResImpl);
      invokerPortlet.processAction(actionReqImpl,actionResImpl);
      actionResImpl.transferHeaders(res);
      RenderParametersPool.put(req,layout.getPlid(),portletId,actionResImpl.getRenderParameterMap());
      if (actionResImpl.getEvents().size() > 0) {
        if (layout.getType().equals(LayoutConstants.TYPE_PORTLET)) {
          LayoutTypePortlet layoutTypePortlet=(LayoutTypePortlet)layout.getLayoutType();
          List<Portlet> portlets=layoutTypePortlet.getPortlets();
          processEvents(actionReqImpl,actionResImpl,portlets);
          actionReqImpl.defineObjects(portletConfig,actionResImpl);
        }
      }
    }
  finally {
      if (uploadReq != null) {
        uploadReq.cleanUp();
      }
    }
  }
 else   if (lifecycle.equals(PortletRequest.RENDER_PHASE) || lifecycle.equals(PortletRequest.RESOURCE_PHASE)) {
    PortalUtil.updateWindowState(portletId,user,layout,windowState,req);
    PortalUtil.updatePortletMode(portletId,user,layout,portletMode,req);
  }
  if (lifecycle.equals(PortletRequest.RESOURCE_PHASE)) {
    ResourceRequestImpl resourceReqImpl=ResourceRequestFactory.create(req,portlet,invokerPortlet,portletCtx,windowState,portletMode,portletPreferences,layout.getPlid());
    StringServletResponse stringServletRes=new StringServletResponse(res);
    ResourceResponseImpl resourceResImpl=ResourceResponseFactory.create(resourceReqImpl,stringServletRes,portletId,companyId);
    resourceReqImpl.defineObjects(portletConfig,resourceResImpl);
    invokerPortlet.serveResource(resourceReqImpl,resourceResImpl);
    resourceResImpl.transferHeaders(res);
    if (stringServletRes.isCalledGetOutputStream()) {
      InputStream is=new ByteArrayInputStream(stringServletRes.getByteArrayMaker().toByteArray());
      ServletResponseUtil.sendFile(res,resourceReqImpl.getResourceID(),is,resourceResImpl.getContentType());
    }
 else {
      byte[] content=stringServletRes.getString().getBytes(StringPool.UTF8);
      ServletResponseUtil.sendFile(res,resourceReqImpl.getResourceID(),content,resourceResImpl.getContentType());
    }
  }
  return portlet;
}
