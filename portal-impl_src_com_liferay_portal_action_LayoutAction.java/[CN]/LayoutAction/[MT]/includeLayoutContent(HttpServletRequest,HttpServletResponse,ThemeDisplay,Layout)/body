{
  ServletContext servletContext=(ServletContext)request.getAttribute(WebKeys.CTX);
  String path=StrutsUtil.TEXT_HTML_DIR;
  if (BrowserSnifferUtil.isWap(request)) {
    path=StrutsUtil.TEXT_WAP_DIR;
  }
  String ppid=ParamUtil.getString(request,"p_p_id");
  if (Validator.isNotNull(ppid)) {
    if (layout.isTypePanel()) {
      path+="/portal/layout/view/panel.jsp";
    }
 else     if (layout.isTypeControlPanel()) {
      path+="/portal/layout/view/control_panel.jsp";
    }
 else {
      path+="/portal/layout/view/portlet.jsp";
    }
  }
 else {
    path+=PortalUtil.getLayoutViewPage(layout);
  }
  RequestDispatcher requestDispatcher=servletContext.getRequestDispatcher(path);
  UnsyncStringWriter unsyncStringWriter=new UnsyncStringWriter();
  PipingServletResponse pipingServletResponse=new PipingServletResponse(response,unsyncStringWriter);
  String contentType=pipingServletResponse.getContentType();
  requestDispatcher.include(request,pipingServletResponse);
  if (contentType != null) {
    response.setContentType(contentType);
  }
  request.setAttribute(WebKeys.LAYOUT_CONTENT,unsyncStringWriter.getStringBundler());
}
