{
  RenderRequestImpl renderRequestImpl=(RenderRequestImpl)req.getAttribute(JavaConstants.JAVAX_PORTLET_REQUEST);
  RenderResponseImpl renderResponseImpl=(RenderResponseImpl)req.getAttribute(JavaConstants.JAVAX_PORTLET_RESPONSE);
  StringServletResponse stringServletResponse=(StringServletResponse)renderRequestImpl.getAttribute(WebKeys.STRING_SERVLET_RESPONSE);
  renderResponseImpl.transferHeaders(res);
  if (stringServletResponse.isCalledGetOutputStream()) {
    InputStream is=new ByteArrayInputStream(stringServletResponse.getByteArrayMaker().toByteArray());
    ServletResponseUtil.sendFile(res,renderResponseImpl.getResourceName(),is,renderResponseImpl.getContentType());
  }
 else {
    byte[] content=stringServletResponse.getString().getBytes();
    ServletResponseUtil.sendFile(res,renderResponseImpl.getResourceName(),content,renderResponseImpl.getContentType());
  }
  RenderRequestFactory.recycle(renderRequestImpl);
  RenderResponseFactory.recycle(renderResponseImpl);
}
