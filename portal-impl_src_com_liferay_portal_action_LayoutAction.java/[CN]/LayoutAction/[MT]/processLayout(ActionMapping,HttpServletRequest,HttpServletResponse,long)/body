{
  ThemeDisplay themeDisplay=(ThemeDisplay)req.getAttribute(WebKeys.THEME_DISPLAY);
  try {
    Layout layout=themeDisplay.getLayout();
    boolean resetLayout=ParamUtil.getBoolean(req,"p_l_reset",PropsValues.LAYOUT_DEFAULT_P_L_RESET);
    if (!PropsValues.TCK_URL && resetLayout) {
      RenderParametersPool.clear(req,plid);
    }
    if (themeDisplay.isLifecycleAction()) {
      Portlet portlet=processPortletRequest(req,res,PortletRequest.ACTION_PHASE);
      if (portlet != null) {
        ActionResponseImpl actionResImpl=(ActionResponseImpl)req.getAttribute(JavaConstants.JAVAX_PORTLET_RESPONSE);
        String redirectLocation=actionResImpl.getRedirectLocation();
        if (Validator.isNotNull(redirectLocation)) {
          res.sendRedirect(redirectLocation);
          return null;
        }
        if (portlet.isActionURLRedirect()) {
          redirectActionURL(req,res,actionResImpl,portlet);
          return null;
        }
      }
    }
 else     if (themeDisplay.isLifecycleRender()) {
      processPortletRequest(req,res,PortletRequest.RENDER_PHASE);
    }
    if (themeDisplay.isLifecycleResource()) {
      processPortletRequest(req,res,PortletRequest.RESOURCE_PHASE);
      return null;
    }
 else {
      if (layout != null) {
        includeLayoutContent(req,res,themeDisplay,layout);
        if (themeDisplay.isStateExclusive()) {
          renderExclusive(req,res,themeDisplay);
          return null;
        }
      }
      return mapping.findForward("portal.layout");
    }
  }
 catch (  Exception e) {
    PortalUtil.sendError(e,req,res);
    return null;
  }
 finally {
    PortletRequest portletReq=(PortletRequest)req.getAttribute(JavaConstants.JAVAX_PORTLET_REQUEST);
    try {
      if (portletReq != null) {
        if (themeDisplay.isLifecycleAction()) {
          ActionRequestImpl actionReqImpl=(ActionRequestImpl)portletReq;
          ActionRequestFactory.recycle(actionReqImpl);
        }
 else         if (themeDisplay.isLifecycleRender()) {
          RenderRequestImpl renderReqImpl=(RenderRequestImpl)portletReq;
          RenderRequestFactory.recycle(renderReqImpl);
        }
 else         if (themeDisplay.isLifecycleResource()) {
          ResourceRequestImpl resourceReqImpl=(ResourceRequestImpl)portletReq;
          ResourceRequestFactory.recycle(resourceReqImpl);
        }
      }
    }
 catch (    Exception e) {
      _log.error(e);
    }
    req.removeAttribute(JavaConstants.JAVAX_PORTLET_REQUEST);
    PortletResponse portletRes=(PortletResponse)req.getAttribute(JavaConstants.JAVAX_PORTLET_RESPONSE);
    try {
      if (portletRes != null) {
        if (themeDisplay.isLifecycleAction()) {
          ActionResponseImpl actionResImpl=(ActionResponseImpl)portletRes;
          ActionResponseFactory.recycle(actionResImpl);
        }
 else         if (themeDisplay.isLifecycleRender()) {
          RenderResponseImpl renderResImpl=(RenderResponseImpl)portletRes;
          RenderResponseFactory.recycle(renderResImpl);
        }
 else         if (themeDisplay.isLifecycleResource()) {
          ResourceResponseImpl resourceResImpl=(ResourceResponseImpl)portletRes;
          ResourceResponseFactory.recycle(resourceResImpl);
        }
      }
    }
 catch (    Exception e) {
      _log.error(e);
    }
    req.removeAttribute(JavaConstants.JAVAX_PORTLET_RESPONSE);
  }
}
