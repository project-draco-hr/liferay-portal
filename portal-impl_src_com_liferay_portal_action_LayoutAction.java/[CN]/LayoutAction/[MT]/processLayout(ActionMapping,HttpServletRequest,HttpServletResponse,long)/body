{
  ThemeDisplay themeDisplay=(ThemeDisplay)request.getAttribute(WebKeys.THEME_DISPLAY);
  try {
    Layout layout=themeDisplay.getLayout();
    HttpSession session=request.getSession();
    boolean resetLayout=ParamUtil.getBoolean(request,"p_l_reset",PropsValues.LAYOUT_DEFAULT_P_L_RESET);
    Layout lastLayout=(Layout)session.getAttribute(WebKeys.LAST_LAYOUT);
    if (!PropsValues.TCK_URL && resetLayout && isChangedLayout(layout,lastLayout)) {
      RenderParametersPool.clear(request,plid);
    }
    session.setAttribute(WebKeys.LAST_LAYOUT,layout);
    if (themeDisplay.isLifecycleAction()) {
      Portlet portlet=processPortletRequest(request,response,PortletRequest.ACTION_PHASE);
      if (portlet != null) {
        ActionResponseImpl actionResponseImpl=(ActionResponseImpl)request.getAttribute(JavaConstants.JAVAX_PORTLET_RESPONSE);
        String redirectLocation=actionResponseImpl.getRedirectLocation();
        if (Validator.isNotNull(redirectLocation)) {
          response.sendRedirect(redirectLocation);
          return null;
        }
        if (portlet.isActionURLRedirect()) {
          redirectActionURL(request,response,actionResponseImpl,portlet);
          return null;
        }
      }
    }
 else     if (themeDisplay.isLifecycleRender()) {
      processPortletRequest(request,response,PortletRequest.RENDER_PHASE);
    }
    if (themeDisplay.isLifecycleResource()) {
      processPortletRequest(request,response,PortletRequest.RESOURCE_PHASE);
      return null;
    }
 else {
      if (response.isCommitted()) {
        return null;
      }
      if (layout != null) {
        includeLayoutContent(request,response,themeDisplay,layout);
        if (themeDisplay.isStateExclusive()) {
          renderExclusive(request,response,themeDisplay);
          return null;
        }
      }
      return mapping.findForward("portal.layout");
    }
  }
 catch (  Exception e) {
    PortalUtil.sendError(e,request,response);
    return null;
  }
 finally {
    PortletRequest portletRequest=(PortletRequest)request.getAttribute(JavaConstants.JAVAX_PORTLET_REQUEST);
    if (portletRequest != null) {
      PortletRequestImpl portletRequestImpl=(PortletRequestImpl)portletRequest;
      portletRequestImpl.cleanUp();
    }
  }
}
