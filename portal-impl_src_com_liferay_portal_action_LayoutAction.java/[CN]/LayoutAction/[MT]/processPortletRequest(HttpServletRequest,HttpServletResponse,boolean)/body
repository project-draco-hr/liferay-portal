{
  HttpSession ses=req.getSession();
  long companyId=PortalUtil.getCompanyId(req);
  User user=PortalUtil.getUser(req);
  Layout layout=(Layout)req.getAttribute(WebKeys.LAYOUT);
  String portletId=ParamUtil.getString(req,"p_p_id");
  Portlet portlet=PortletLocalServiceUtil.getPortletById(companyId,portletId);
  if (portlet == null) {
    return null;
  }
  ServletContext ctx=(ServletContext)req.getAttribute(WebKeys.CTX);
  CachePortlet cachePortlet=PortletInstanceFactory.create(portlet,ctx);
  if (user != null) {
    CachePortlet.clearResponse(ses,layout.getPrimaryKey(),portletId,LanguageUtil.getLanguageId(req));
  }
  PortletPreferencesIds portletPreferencesIds=PortletPreferencesFactoryUtil.getPortletPreferencesIds(req,portletId);
  PortletPreferences portletPreferences=PortletPreferencesLocalServiceUtil.getPreferences(portletPreferencesIds);
  PortletConfig portletConfig=PortletConfigFactory.create(portlet,ctx);
  PortletContext portletCtx=portletConfig.getPortletContext();
  WindowState windowState=new WindowState(ParamUtil.getString(req,"p_p_state"));
  PortletMode portletMode=new PortletMode(ParamUtil.getString(req,"p_p_mode"));
  if (action) {
    String contentType=req.getHeader(HttpHeaders.CONTENT_TYPE);
    if (_log.isDebugEnabled()) {
      _log.debug("Content type " + contentType);
    }
    UploadServletRequest uploadReq=null;
    try {
      if ((contentType != null) && (contentType.startsWith(ContentTypes.MULTIPART_FORM_DATA))) {
        if (!cachePortlet.getPortletConfig().isWARFile() || cachePortlet.isStrutsPortlet()) {
          uploadReq=new UploadServletRequest(req);
          req=uploadReq;
        }
      }
      ActionRequestImpl actionRequestImpl=ActionRequestFactory.create(req,portlet,cachePortlet,portletCtx,windowState,portletMode,portletPreferences,layout.getPlid());
      ActionResponseImpl actionResponseImpl=ActionResponseFactory.create(actionRequestImpl,res,portletId,user,layout,windowState,portletMode);
      actionRequestImpl.defineObjects(portletConfig,actionResponseImpl);
      cachePortlet.processAction(actionRequestImpl,actionResponseImpl);
      RenderParametersPool.put(req,layout.getPlid(),portletId,actionResponseImpl.getRenderParameters());
    }
  finally {
      if (uploadReq != null) {
        uploadReq.cleanUp();
      }
    }
  }
 else {
    PortalUtil.updateWindowState(portletId,user,layout,windowState,req);
    PortalUtil.updatePortletMode(portletId,user,layout,portletMode,req);
  }
  return portlet;
}
