{
  long targetLayoutPlid=ParamUtil.getLong(actionRequest,"layoutPlid");
  ThemeDisplay themeDisplay=(ThemeDisplay)actionRequest.getAttribute(WebKeys.THEME_DISPLAY);
  Layout targetLayout=LayoutLocalServiceUtil.getLayout(targetLayoutPlid);
  LayoutPrototype layoutPrototype=LayoutPrototypeLocalServiceUtil.getLayoutPrototypeByUuidAndCompanyId(targetLayout.getLayoutPrototypeUuid(),themeDisplay.getCompanyId());
  long layoutPrototypeId=layoutPrototype.getLayoutPrototypeId();
  Layout layoutPrototypeLayout=layoutPrototype.getLayout();
  SitesUtil.setMergeFailCount(layoutPrototypeLayout,0);
  LayoutLocalServiceUtil.updateLayout(layoutPrototypeLayout);
  if (!targetLayout.isLayoutPrototypeLinkEnabled()) {
    targetLayout.setLayoutPrototypeLinkEnabled(true);
    targetLayout.setLayoutPrototypeUuid(layoutPrototype.getUuid());
    LayoutLocalServiceUtil.updateLayout(targetLayout);
    targetLayout=LayoutLocalServiceUtil.getLayout(targetLayoutPlid);
  }
  SitesUtil.resetPrototype(targetLayout);
  SitesUtil.mergeLayoutPrototypeLayout(targetLayout.getGroup(),targetLayout);
  layoutPrototype=LayoutPrototypeServiceUtil.getLayoutPrototype(layoutPrototypeId);
  int mergeFailCountAfterMerge=SitesUtil.getMergeFailCount(layoutPrototype);
  if (mergeFailCountAfterMerge > 0) {
    SessionErrors.add(actionRequest,"templateMergeFailedSeeLogsForDetails");
  }
}
