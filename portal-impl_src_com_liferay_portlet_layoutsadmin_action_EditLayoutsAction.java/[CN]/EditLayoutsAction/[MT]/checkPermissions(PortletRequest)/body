{
  Group group=getGroup(portletRequest);
  if (group == null) {
    throw new PrincipalException();
  }
  ThemeDisplay themeDisplay=(ThemeDisplay)portletRequest.getAttribute(WebKeys.THEME_DISPLAY);
  PermissionChecker permissionChecker=themeDisplay.getPermissionChecker();
  Layout layout=themeDisplay.getLayout();
  String cmd=ParamUtil.getString(portletRequest,Constants.CMD);
  long selPlid=ParamUtil.getLong(portletRequest,"selPlid");
  if (selPlid > 0) {
    layout=LayoutLocalServiceUtil.getLayout(selPlid);
  }
  if (cmd.equals(Constants.ADD)) {
    long parentPlid=ParamUtil.getLong(portletRequest,"parentPlid");
    if (parentPlid == LayoutConstants.DEFAULT_PARENT_LAYOUT_ID) {
      if (!GroupPermissionUtil.contains(permissionChecker,group,ActionKeys.ADD_LAYOUT)) {
        throw new PrincipalException();
      }
    }
 else {
      layout=LayoutLocalServiceUtil.getLayout(parentPlid);
      if (!LayoutPermissionUtil.contains(permissionChecker,layout,ActionKeys.ADD_LAYOUT)) {
        throw new PrincipalException();
      }
    }
  }
 else   if (cmd.equals(Constants.DELETE)) {
    if (!LayoutPermissionUtil.contains(permissionChecker,layout,ActionKeys.DELETE)) {
      throw new PrincipalException();
    }
  }
 else   if (cmd.equals(Constants.UPDATE)) {
    if (group.isCompany()) {
      if (!permissionChecker.isCompanyAdmin()) {
        throw new PrincipalException();
      }
    }
 else     if (group.isLayoutPrototype()) {
      LayoutPrototypePermissionUtil.check(permissionChecker,group.getClassPK(),ActionKeys.UPDATE);
    }
 else     if (group.isLayoutSetPrototype()) {
      LayoutSetPrototypePermissionUtil.check(permissionChecker,group.getClassPK(),ActionKeys.UPDATE);
    }
 else     if (group.isUser()) {
      long groupUserId=group.getClassPK();
      User groupUser=UserLocalServiceUtil.getUserById(groupUserId);
      long[] organizationIds=groupUser.getOrganizationIds();
      UserPermissionUtil.check(permissionChecker,groupUserId,organizationIds,ActionKeys.UPDATE);
    }
 else {
      checkPermission(permissionChecker,group,layout,selPlid);
    }
  }
 else   if (cmd.equals("publish_to_live") || cmd.equals("publish_to_remote")) {
    boolean hasUpdateLayoutPermission=false;
    if (layout != null) {
      hasUpdateLayoutPermission=LayoutPermissionUtil.contains(permissionChecker,layout,ActionKeys.UPDATE);
    }
    if (group.isCompany() || group.isSite()) {
      boolean publishToLive=GroupPermissionUtil.contains(permissionChecker,group,ActionKeys.PUBLISH_STAGING);
      if (!hasUpdateLayoutPermission && !publishToLive) {
        throw new PrincipalException();
      }
    }
 else {
      checkPermission(permissionChecker,group,layout,selPlid);
    }
  }
 else   if (cmd.equals("reset_customized_view")) {
    if (!LayoutPermissionUtil.contains(permissionChecker,layout,ActionKeys.CUSTOMIZE)) {
      throw new PrincipalException();
    }
  }
 else {
    checkPermission(permissionChecker,group,layout,selPlid);
  }
}
