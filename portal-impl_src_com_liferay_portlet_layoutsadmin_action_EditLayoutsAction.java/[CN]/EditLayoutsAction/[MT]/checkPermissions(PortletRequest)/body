{
  Group group=getGroup(portletRequest);
  if (group == null) {
    throw new PrincipalException();
  }
  ThemeDisplay themeDisplay=(ThemeDisplay)portletRequest.getAttribute(WebKeys.THEME_DISPLAY);
  PermissionChecker permissionChecker=themeDisplay.getPermissionChecker();
  Layout layout=themeDisplay.getLayout();
  String cmd=ParamUtil.getString(portletRequest,Constants.CMD);
  if (cmd.equals("reset_personalized_view")) {
    if (!LayoutPermissionUtil.contains(permissionChecker,layout,ActionKeys.PERSONALIZE)) {
      throw new PrincipalException();
    }
 else {
      return;
    }
  }
  boolean hasUpdateLayoutPermission=false;
  if (layout != null) {
    hasUpdateLayoutPermission=LayoutPermissionUtil.contains(permissionChecker,layout.getGroupId(),layout.isPrivateLayout(),layout.getLayoutId(),ActionKeys.UPDATE);
  }
  if (group.isRegularSite()) {
    boolean publishToLive=GroupPermissionUtil.contains(permissionChecker,group.getGroupId(),ActionKeys.PUBLISH_STAGING) && cmd.equals("publish_to_live");
    if (!GroupPermissionUtil.contains(permissionChecker,group.getGroupId(),ActionKeys.MANAGE_LAYOUTS) && !hasUpdateLayoutPermission && !publishToLive) {
      throw new PrincipalException();
    }
  }
 else   if (group.isCompany()) {
    if (!permissionChecker.isCompanyAdmin()) {
      throw new PrincipalException();
    }
  }
 else   if (group.isLayoutPrototype()) {
    LayoutPrototypePermissionUtil.check(permissionChecker,group.getClassPK(),ActionKeys.UPDATE);
  }
 else   if (group.isLayoutSetPrototype()) {
    LayoutSetPrototypePermissionUtil.check(permissionChecker,group.getClassPK(),ActionKeys.UPDATE);
  }
 else   if (group.isOrganization()) {
    long organizationId=group.getOrganizationId();
    boolean publishToLive=OrganizationPermissionUtil.contains(permissionChecker,organizationId,ActionKeys.PUBLISH_STAGING) && cmd.equals("publish_to_live");
    if (!OrganizationPermissionUtil.contains(permissionChecker,organizationId,ActionKeys.MANAGE_LAYOUTS) && !hasUpdateLayoutPermission && !publishToLive) {
      throw new PrincipalException();
    }
  }
 else   if (group.isUser()) {
    long groupUserId=group.getClassPK();
    User groupUser=UserLocalServiceUtil.getUserById(groupUserId);
    long[] organizationIds=groupUser.getOrganizationIds();
    UserPermissionUtil.check(permissionChecker,groupUserId,organizationIds,ActionKeys.UPDATE);
    if (!PropsValues.LAYOUT_USER_PRIVATE_LAYOUTS_MODIFIABLE && !PropsValues.LAYOUT_USER_PUBLIC_LAYOUTS_MODIFIABLE) {
      throw new PrincipalException();
    }
  }
}
