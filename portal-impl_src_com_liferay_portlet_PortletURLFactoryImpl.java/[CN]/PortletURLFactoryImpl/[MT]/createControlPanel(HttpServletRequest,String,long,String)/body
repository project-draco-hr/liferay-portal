{
  ThemeDisplay themeDisplay=(ThemeDisplay)request.getAttribute(WebKeys.THEME_DISPLAY);
  long plid=0;
  try {
    plid=PortalUtil.getControlPanelPlid(themeDisplay.getCompanyId());
  }
 catch (  Exception e) {
    _log.error("Unable to determine control panel layout id",e);
  }
  LiferayPortletURL portletURL=new PortletURLImpl(request,portletId,plid,lifecycle);
  portletURL.setDoAsGroupId(themeDisplay.getScopeGroupId());
  portletURL.setRefererPlid(themeDisplay.getPlid());
  return portletURL;
}
