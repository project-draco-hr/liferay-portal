{
  if (layoutRevision != null) {
    return layoutRevision;
  }
  long layoutRevisionId=0;
  long layoutSetBranchId=0;
  ServiceContext serviceContext=ServiceContextThreadLocal.getServiceContext();
  if (serviceContext != null) {
    layoutRevisionId=ParamUtil.getLong(serviceContext,"layoutRevisionId");
    layoutSetBranchId=ParamUtil.getLong(serviceContext,"layoutSetBranchId");
  }
  if (layoutRevisionId > 0) {
    return LayoutRevisionLocalServiceUtil.getLayoutRevision(layoutRevisionId);
  }
  LayoutSetBranch layoutSetBranch=null;
  if (layoutSetBranchId > 0) {
    layoutSetBranch=LayoutSetBranchLocalServiceUtil.getLayoutSetBranch(layoutSetBranchId);
    try {
      return LayoutRevisionLocalServiceUtil.getLayoutRevision(layoutSetBranch.getLayoutSetBranchId(),layout.getPlid(),true);
    }
 catch (    NoSuchLayoutRevisionException nslre) {
    }
  }
 else {
    layoutSetBranch=LayoutSetBranchLocalServiceUtil.getMasterLayoutSetBranch(layout.getGroupId(),layout.isPrivateLayout());
  }
  try {
    layoutRevision=LayoutRevisionLocalServiceUtil.getLayoutRevision(layoutSetBranch.getLayoutSetBranchId(),layout.getPlid(),true);
  }
 catch (  NoSuchLayoutRevisionException nslre) {
    if (layoutSetBranchId <= 0) {
      layoutSetBranchId=layoutSetBranch.getLayoutSetBranchId();
    }
    layoutRevision=LayoutRevisionLocalServiceUtil.addLayoutRevision(serviceContext.getUserId(),layoutSetBranchId,LayoutRevisionConstants.DEFAULT_PARENT_LAYOUT_REVISION_ID,true,layout.getPlid(),layout.getPrivateLayout(),layout.getName(),layout.getTitle(),layout.getDescription(),layout.getTypeSettings(),layout.getIconImage(),layout.getIconImageId(),layout.getThemeId(),layout.getColorSchemeId(),layout.getWapThemeId(),layout.getWapColorSchemeId(),layout.getCss(),serviceContext);
  }
  return layoutRevision;
}
