{
  if (layoutRevision != null) {
    return layoutRevision;
  }
  ServiceContext serviceContext=ServiceContextThreadLocal.getServiceContext();
  if (!serviceContext.isSignedIn()) {
    LayoutRevision lastLayoutRevision=null;
    lastLayoutRevision=LayoutRevisionLocalServiceUtil.fetchLastLayoutRevision(layout.getPlid(),true);
    if (lastLayoutRevision == null) {
      lastLayoutRevision=LayoutRevisionLocalServiceUtil.fetchLastLayoutRevision(layout.getPlid(),false);
    }
    return lastLayoutRevision;
  }
  long layoutSetBranchId=ParamUtil.getLong(serviceContext,"layoutSetBranchId");
  LayoutSet layoutSet=layout.getLayoutSet();
  LayoutSetBranch layoutSetBranch=LayoutSetBranchLocalServiceUtil.getUserLayoutSetBranch(serviceContext.getUserId(),layout.getGroupId(),layout.isPrivateLayout(),layoutSet.getLayoutSetId(),layoutSetBranchId);
  layoutSetBranchId=layoutSetBranch.getLayoutSetBranchId();
  long layoutRevisionId=ParamUtil.getLong(serviceContext,"layoutRevisionId");
  if (layoutSetBranchId > 0) {
    if (layoutRevisionId <= 0) {
      User user=UserLocalServiceUtil.getUser(serviceContext.getUserId());
      layoutRevisionId=StagingUtil.getRecentLayoutRevisionId(user,layoutSetBranchId,layout.getPlid());
      if (layoutRevisionId > 0) {
        try {
          layoutRevision=LayoutRevisionLocalServiceUtil.getLayoutRevision(layoutRevisionId);
          if (layoutRevision.getStatus() != WorkflowConstants.STATUS_INACTIVE) {
            return layoutRevision;
          }
          StagingUtil.setRecentLayoutRevisionId(user,layoutSetBranchId,layout.getPlid(),LayoutRevisionConstants.DEFAULT_PARENT_LAYOUT_REVISION_ID);
          layoutRevisionId=StagingUtil.getRecentLayoutRevisionId(user,layoutSetBranchId,layout.getPlid());
        }
 catch (        NoSuchLayoutRevisionException nslre) {
        }
      }
    }
    if (layoutRevisionId > 0) {
      try {
        return LayoutRevisionLocalServiceUtil.getLayoutRevision(layoutRevisionId);
      }
 catch (      NoSuchLayoutRevisionException nslre) {
      }
    }
    try {
      return LayoutRevisionLocalServiceUtil.getLayoutRevision(layoutSetBranchId,layout.getPlid(),true);
    }
 catch (    NoSuchLayoutRevisionException nslre) {
      List<LayoutRevision> layoutRevisions=LayoutRevisionLocalServiceUtil.getChildLayoutRevisions(layoutSetBranchId,LayoutRevisionConstants.DEFAULT_PARENT_LAYOUT_REVISION_ID,layout.getPlid());
      if (!layoutRevisions.isEmpty()) {
        return layoutRevisions.get(0);
      }
    }
  }
  LayoutBranch layoutBranch=LayoutBranchLocalServiceUtil.addOrFetchMasterLayoutBranch(layoutSetBranchId,layout.getPlid(),serviceContext);
  if (!MergeLayoutPrototypesThreadLocal.isInProgress()) {
    serviceContext.setWorkflowAction(WorkflowConstants.ACTION_SAVE_DRAFT);
  }
  return LayoutRevisionLocalServiceUtil.addLayoutRevision(serviceContext.getUserId(),layoutSetBranchId,layoutBranch.getLayoutBranchId(),LayoutRevisionConstants.DEFAULT_PARENT_LAYOUT_REVISION_ID,false,layout.getPlid(),LayoutConstants.DEFAULT_PLID,layout.isPrivateLayout(),layout.getName(),layout.getTitle(),layout.getDescription(),layout.getKeywords(),layout.getRobots(),layout.getTypeSettings(),layout.getIconImage(),layout.getIconImageId(),layout.getThemeId(),layout.getColorSchemeId(),layout.getWapThemeId(),layout.getWapColorSchemeId(),layout.getCss(),serviceContext);
}
