{
  if (layoutRevision != null) {
    return layoutRevision;
  }
  ServiceContext serviceContext=ServiceContextThreadLocal.getServiceContext();
  if (!serviceContext.isSignedIn()) {
    return layoutRevision;
  }
  long layoutSetBranchId=ParamUtil.getLong(serviceContext,"layoutSetBranchId");
  LayoutSetBranch layoutSetBranch=LayoutSetBranchLocalServiceUtil.getUserLayoutSetBranch(serviceContext.getUserId(),layout.getGroupId(),layout.isPrivateLayout(),layoutSetBranchId);
  layoutSetBranchId=layoutSetBranch.getLayoutSetBranchId();
  long layoutRevisionId=ParamUtil.getLong(serviceContext,"layoutRevisionId");
  if (layoutRevisionId <= 0) {
    User user=UserLocalServiceUtil.getUser(serviceContext.getUserId());
    layoutRevisionId=StagingUtil.getRecentLayoutRevisionId(user,layoutSetBranchId,layout.getPlid());
  }
  if (layoutRevisionId > 0) {
    try {
      return LayoutRevisionLocalServiceUtil.getLayoutRevision(layoutRevisionId);
    }
 catch (    NoSuchLayoutRevisionException nslre) {
    }
  }
  try {
    return LayoutRevisionLocalServiceUtil.getLayoutRevision(layoutSetBranchId,layout.getPlid(),true);
  }
 catch (  NoSuchLayoutRevisionException nslre) {
    List<LayoutRevision> layoutRevisions=LayoutRevisionLocalServiceUtil.getLayoutRevisions(layoutSetBranchId,LayoutRevisionConstants.DEFAULT_PARENT_LAYOUT_REVISION_ID,layout.getPlid());
    if (!layoutRevisions.isEmpty()) {
      return layoutRevisions.get(0);
    }
  }
  layoutRevision=LayoutRevisionLocalServiceUtil.addLayoutRevision(serviceContext.getUserId(),layoutSetBranchId,LayoutRevisionConstants.DEFAULT_PARENT_LAYOUT_REVISION_ID,false,LayoutRevisionConstants.DEFAULT_LAYOUT_VARIATION_NAME,layout.getPlid(),layout.isPrivateLayout(),layout.getName(),layout.getTitle(),layout.getDescription(),layout.getKeywords(),layout.getRobots(),layout.getTypeSettings(),layout.getIconImage(),layout.getIconImageId(),layout.getThemeId(),layout.getColorSchemeId(),layout.getWapThemeId(),layout.getWapColorSchemeId(),layout.getCss(),serviceContext);
  boolean explicitCreation=ParamUtil.getBoolean(serviceContext,"explicitCreation");
  if (!explicitCreation) {
    LayoutRevisionLocalServiceUtil.updateStatus(serviceContext.getUserId(),layoutRevision.getLayoutRevisionId(),WorkflowConstants.STATUS_INCOMPLETE,serviceContext);
  }
  return layoutRevision;
}
