{
  long mbThreadId=0;
  JSONObject jsonObject=JSONFactoryUtil.createJSONObject(userNotificationEvent.getPayload());
  long classPK=jsonObject.getLong("classPK");
  MBMessage mbMessage=MBMessageLocalServiceUtil.fetchMBMessage(classPK);
  if (mbMessage == null) {
    MBThread mbThread=MBThreadLocalServiceUtil.fetchMBThread(classPK);
    if (mbThread == null) {
      UserNotificationEventLocalServiceUtil.deleteUserNotificationEvent(userNotificationEvent.getUserNotificationEventId());
      return null;
    }
    mbThreadId=classPK;
  }
 else {
    mbThreadId=mbMessage.getThreadId();
  }
  ThemeDisplay themeDisplay=serviceContext.getThemeDisplay();
  User user=themeDisplay.getUser();
  Group group=user.getGroup();
  long portletPlid=PortalUtil.getPlidFromPortletId(group.getGroupId(),true,PortletKeys.PRIVATE_MESSAGING);
  PortletURL portletURL=null;
  if (portletPlid != 0) {
    portletURL=PortletURLFactoryUtil.create(serviceContext.getLiferayPortletRequest(),PortletKeys.PRIVATE_MESSAGING,portletPlid,PortletRequest.RENDER_PHASE);
    portletURL.setParameter("mbThreadId",String.valueOf(mbThreadId));
  }
 else {
    LiferayPortletResponse liferayPortletResponse=serviceContext.getLiferayPortletResponse();
    portletURL=liferayPortletResponse.createRenderURL(PortletKeys.PRIVATE_MESSAGING);
    portletURL.setParameter("mvcPath","/view.jsp");
    portletURL.setParameter("mbThreadId",String.valueOf(mbThreadId));
    portletURL.setWindowState(WindowState.MAXIMIZED);
  }
  return portletURL.toString();
}
