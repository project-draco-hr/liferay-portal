{
  String body=null;
  long userId=0;
  JSONObject jsonObject=JSONFactoryUtil.createJSONObject(userNotificationEvent.getPayload());
  long classPK=jsonObject.getLong("classPK");
  MBMessage mbMessage=MBMessageLocalServiceUtil.fetchMBMessage(classPK);
  if (mbMessage == null) {
    body=jsonObject.getString("body");
    if (Validator.isNull(body)) {
      UserNotificationEventLocalServiceUtil.deleteUserNotificationEvent(userNotificationEvent.getUserNotificationEventId());
      return null;
    }
    userId=jsonObject.getLong("userId");
  }
 else {
    UserThread userThread=UserThreadLocalServiceUtil.fetchUserThread(serviceContext.getUserId(),mbMessage.getThreadId());
    if ((userThread == null) || userThread.isDeleted()) {
      UserNotificationEventLocalServiceUtil.deleteUserNotificationEvent(userNotificationEvent.getUserNotificationEventId());
      return null;
    }
    body=mbMessage.getBody();
    userId=mbMessage.getUserId();
  }
  String title=serviceContext.translate("x-sent-you-a-message",HtmlUtil.escape(PortalUtil.getUserName(userId,StringPool.BLANK)));
  return StringUtil.replace(getBodyTemplate(),new String[]{"[$BODY$]","[$TITLE$]"},new String[]{HtmlUtil.escape(StringUtil.shorten(body,50)),title});
}
