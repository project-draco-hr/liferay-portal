{
  _invokeSuper=true;
  Layout layout1=getLayout();
  Layout layout2=getLayout();
  addPortletPreferences(layout1,"23");
  addPortletPreferences(layout1,"71_INSTANCE_LhZwzy867qfr");
  addPortletPreferences(layout1,"56_INSTANCE_LhZwzy867qqb");
  addPortletPreferences(layout1,"56_INSTANCE_LhZwzy867qxc");
  addPortletPreferences(layout2,"56_INSTANCE_LhZwzy867qxc");
  long ownerId=1234;
  int ownerType=PortletKeys.PREFS_OWNER_TYPE_USER;
  String preferences=getPortalPreferencesString();
  preferences=StringUtil.replace(preferences,new String[]{"@plid@","@portlet_1@","@portlet_2@","@portlet_3@","@portlet_4@"},ArraysUtil.join(new String[]{String.valueOf(layout1.getPlid())},_PORTLET_IDS));
  PortalPreferencesWrapper portalPreferencesWrapper=getPortalPreferences(ownerId,ownerType,preferences);
  portalPreferencesWrapper.store();
  doUpgrade();
  Assert.assertEquals(_newPortletIds.size(),4);
  Assert.assertFalse(PortletConstants.hasUserId(_newPortletIds.get(0)));
  Assert.assertTrue(PortletConstants.hasUserId(_newPortletIds.get(1)));
  Assert.assertTrue(PortletConstants.hasUserId(_newPortletIds.get(2)));
  Assert.assertTrue(PortletConstants.hasUserId(_newPortletIds.get(3)));
  Assert.assertFalse(PortletConstants.hasInstanceId(_newPortletIds.get(0)));
  Assert.assertTrue(PortletConstants.hasInstanceId(_newPortletIds.get(1)));
  Assert.assertTrue(PortletConstants.hasInstanceId(_newPortletIds.get(2)));
  Assert.assertTrue(PortletConstants.hasInstanceId(_newPortletIds.get(3)));
  List<PortletPreferences> portletPreferencesList=PortletPreferencesLocalServiceUtil.getPortletPreferences(layout1.getPlid(),_newPortletIds.get(0));
  Assert.assertEquals(portletPreferencesList.size(),1);
  portletPreferencesList=PortletPreferencesLocalServiceUtil.getPortletPreferences(layout1.getPlid(),_newPortletIds.get(1));
  Assert.assertEquals(portletPreferencesList.size(),1);
  portletPreferencesList=PortletPreferencesLocalServiceUtil.getPortletPreferences(layout1.getPlid(),_PORTLET_IDS[1]);
  Assert.assertEquals(portletPreferencesList.size(),0);
  portletPreferencesList=PortletPreferencesLocalServiceUtil.getPortletPreferences(layout1.getPlid(),_newPortletIds.get(2));
  Assert.assertEquals(portletPreferencesList.size(),1);
  portletPreferencesList=PortletPreferencesLocalServiceUtil.getPortletPreferences(layout1.getPlid(),_PORTLET_IDS[2]);
  Assert.assertEquals(portletPreferencesList.size(),0);
  portletPreferencesList=PortletPreferencesLocalServiceUtil.getPortletPreferences(layout1.getPlid(),_newPortletIds.get(3));
  Assert.assertEquals(portletPreferencesList.size(),1);
  portletPreferencesList=PortletPreferencesLocalServiceUtil.getPortletPreferences(layout1.getPlid(),_PORTLET_IDS[3]);
  Assert.assertEquals(portletPreferencesList.size(),0);
  GroupLocalServiceUtil.deleteGroup(layout1.getGroup());
  GroupLocalServiceUtil.deleteGroup(layout2.getGroup());
}
