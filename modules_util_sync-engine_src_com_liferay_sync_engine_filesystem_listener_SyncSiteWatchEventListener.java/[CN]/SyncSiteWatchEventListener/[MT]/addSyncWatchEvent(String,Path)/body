{
  try {
    String filePathName=filePath.toString();
    Path parentFilePath=filePath.getParent();
    String parentFilePathName=parentFilePath.toString();
    SyncAccount syncAccount=SyncAccountService.fetchSyncAccount(getSyncAccountId());
    if (isDuplicateEvent(eventType,filePath.toString(),getSyncAccountId())) {
      return;
    }
    if (filePathName.equals(syncAccount.getFilePathName()) || parentFilePathName.equals(syncAccount.getFilePathName())) {
      return;
    }
    long repositoryId=getRepositoryId(filePath);
    if (repositoryId <= 0) {
      return;
    }
    SyncSite syncSite=SyncSiteService.fetchSyncSite(repositoryId,getSyncAccountId());
    Set<Long> activeSyncSiteIds=SyncSiteService.getActiveSyncSiteIds(getSyncAccountId());
    if (!activeSyncSiteIds.contains(syncSite.getSyncSiteId())) {
      return;
    }
    if (eventType.equals(SyncWatchEvent.EVENT_TYPE_RENAME_FROM)) {
      _previousFilePath=filePath;
      return;
    }
    String fileType=getFileType(eventType,filePath);
    String previousFilePathName=null;
    if (eventType.equals(SyncWatchEvent.EVENT_TYPE_RENAME_TO)) {
      if (_previousFilePath == null) {
        eventType=SyncWatchEvent.EVENT_TYPE_CREATE;
        if (fileType.equals(SyncFile.TYPE_FOLDER)) {
          SyncFile syncFile=SyncFileService.fetchSyncFile(filePathName);
          if (syncFile != null) {
            FileUtil.fireDeleteEvents(Paths.get(filePathName));
          }
          Watcher watcher=WatcherRegistry.getWatcher(getSyncAccountId());
          watcher.walkFileTree(Paths.get(filePathName));
        }
      }
 else {
        previousFilePathName=_previousFilePath.toString();
        if (parentFilePath.equals(_previousFilePath.getParent())) {
          eventType=SyncWatchEvent.EVENT_TYPE_RENAME;
        }
 else {
          SyncFile syncFile=SyncFileService.fetchSyncFile(filePathName);
          if ((syncFile != null) && fileType.equals(SyncFile.TYPE_FOLDER)) {
            _previousFilePath=null;
            FileUtil.fireDeleteEvents(Paths.get(filePathName));
            Watcher watcher=WatcherRegistry.getWatcher(getSyncAccountId());
            watcher.walkFileTree(Paths.get(filePathName));
            watchEvent(SyncWatchEvent.EVENT_TYPE_DELETE,filePath);
            return;
          }
 else {
            eventType=SyncWatchEvent.EVENT_TYPE_MOVE;
          }
        }
      }
    }
 else     if (_previousFilePath != null) {
      eventType=SyncWatchEvent.EVENT_TYPE_DELETE;
      filePathName=_previousFilePath.toString();
    }
    SyncWatchEventService.addSyncWatchEvent(eventType,filePathName,fileType,previousFilePathName,getSyncAccountId());
    _previousFilePath=null;
  }
 catch (  Exception e) {
    _logger.error(e.getMessage(),e);
  }
}
