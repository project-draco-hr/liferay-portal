{
  if (_localRepositories.containsKey(repositoryId)) {
    return _localRepositories.get(repositoryId);
  }
  InitializedLocalRepository initializedLocalRepository=new InitializedLocalRepository();
  DefaultCapabilityRegistry defaultCapabilityRegistry=new DefaultCapabilityRegistry(initializedLocalRepository);
  _repositoryDefiner.registerCapabilities(defaultCapabilityRegistry);
  DefaultRepositoryEventRegistry defaultRepositoryEventRegistry=new DefaultRepositoryEventRegistry(_rootRepositoryEventTrigger);
  setUpCommonCapabilities(initializedLocalRepository,defaultCapabilityRegistry,defaultRepositoryEventRegistry);
  defaultCapabilityRegistry.registerCapabilityRepositoryEvents(defaultRepositoryEventRegistry);
  LocalRepository localRepository=_repositoryFactory.createLocalRepository(repositoryId);
  LocalRepository wrappedLocalRepository=defaultCapabilityRegistry.invokeCapabilityWrappers(localRepository);
  CapabilityLocalRepository capabilityLocalRepository=new CapabilityLocalRepository(wrappedLocalRepository,defaultCapabilityRegistry,defaultRepositoryEventRegistry);
  initializedLocalRepository.setDocumentRepository(capabilityLocalRepository);
  _localRepositories.put(repositoryId,capabilityLocalRepository);
  return capabilityLocalRepository;
}
