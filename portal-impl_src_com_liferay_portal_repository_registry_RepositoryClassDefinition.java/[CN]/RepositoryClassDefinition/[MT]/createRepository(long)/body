{
  if (_repositoryCache.containsKey(repositoryId)) {
    return _repositoryCache.get(repositoryId);
  }
  InitializedRepository initializedRepository=new InitializedRepository();
  DefaultCapabilityRegistry defaultCapabilityRegistry=new DefaultCapabilityRegistry(initializedRepository);
  _repositoryDefiner.registerCapabilities(defaultCapabilityRegistry);
  DefaultRepositoryEventRegistry defaultRepositoryEventRegistry=new DefaultRepositoryEventRegistry(_rootRepositoryEventTrigger);
  setUpCommonCapabilities(initializedRepository,defaultCapabilityRegistry,defaultRepositoryEventRegistry);
  Repository repository=_repositoryFactory.createRepository(repositoryId);
  defaultCapabilityRegistry.registerCapabilityRepositoryEvents(defaultRepositoryEventRegistry);
  Repository wrappedRepository=defaultCapabilityRegistry.invokeCapabilityWrappers(repository);
  CapabilityRepository capabilityRepository=new CapabilityRepository(wrappedRepository,defaultCapabilityRegistry,defaultRepositoryEventRegistry);
  initializedRepository.setDocumentRepository(capabilityRepository);
  _repositoryCache.put(repositoryId,capabilityRepository);
  return capabilityRepository;
}
