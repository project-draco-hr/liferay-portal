{
  if (isEnabled(req)) {
    HttpSession ses=req.getSession();
    String captchaText=(String)ses.getAttribute(WebKeys.CAPTCHA_TEXT);
    if (captchaText != null) {
      if (!captchaText.equals(ParamUtil.getString(req,"captchaText"))) {
        throw new CaptchaTextException();
      }
 else {
        if (_log.isDebugEnabled()) {
          _log.debug("Captcha text is valid");
        }
        ses.removeAttribute(WebKeys.CAPTCHA_TEXT);
        if ((PropsValues.CAPTCHA_MAX_CHALLENGES > 0) && (Validator.isNotNull(req.getRemoteUser()))) {
          Integer count=(Integer)ses.getAttribute(WebKeys.CAPTCHA_COUNT);
          if (count == null) {
            count=new Integer(1);
          }
 else {
            count=new Integer(count.intValue() + 1);
          }
          ses.setAttribute(WebKeys.CAPTCHA_COUNT,count);
        }
      }
    }
 else {
      if (_log.isErrorEnabled()) {
        _log.error("Captcha text is null. User " + req.getRemoteUser() + " may be trying to circumvent the captcha.");
      }
      throw new CaptchaTextException();
    }
  }
}
