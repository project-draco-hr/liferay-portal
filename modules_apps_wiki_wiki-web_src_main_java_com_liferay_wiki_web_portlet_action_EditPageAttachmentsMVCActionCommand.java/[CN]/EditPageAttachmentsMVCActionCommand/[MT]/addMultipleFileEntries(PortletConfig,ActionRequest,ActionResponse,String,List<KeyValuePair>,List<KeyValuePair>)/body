{
  ThemeDisplay themeDisplay=(ThemeDisplay)actionRequest.getAttribute(WebKeys.THEME_DISPLAY);
  long nodeId=ParamUtil.getLong(actionRequest,"nodeId");
  String title=ParamUtil.getString(actionRequest,"title");
  FileEntry tempFileEntry=null;
  try {
    tempFileEntry=TempFileEntryUtil.getTempFileEntry(themeDisplay.getScopeGroupId(),themeDisplay.getUserId(),_TEMP_FOLDER_NAME,selectedFileName);
    String originalSelectedFileName=TempFileEntryUtil.getOriginalTempFileName(tempFileEntry.getFileName());
    InputStream inputStream=tempFileEntry.getContentStream();
    String mimeType=tempFileEntry.getMimeType();
    FileEntry fileEntry=_wikiPageService.addPageAttachment(nodeId,title,originalSelectedFileName,inputStream,mimeType);
    validFileNameKVPs.add(new KeyValuePair(fileEntry.getTitle(),selectedFileName));
  }
 catch (  Exception e) {
    String errorMessage=getAddMultipleFileEntriesErrorMessage(portletConfig,actionRequest,actionResponse,e);
    invalidFileNameKVPs.add(new KeyValuePair(selectedFileName,errorMessage));
  }
 finally {
    if (tempFileEntry != null) {
      TempFileEntryUtil.deleteTempFileEntry(tempFileEntry.getFileEntryId());
    }
  }
}
