{
  boolean autoScreenName=PrefsPropsUtil.getBoolean(companyId,PropsKeys.USERS_SCREEN_NAME_ALWAYS_AUTOGENERATE);
  String screenName=LDAPUtil.getAttributeString(attributes,userMappings,UserConverterKeys.SCREEN_NAME).toLowerCase();
  String emailAddress=LDAPUtil.getAttributeString(attributes,userMappings,UserConverterKeys.EMAIL_ADDRESS);
  if (_log.isDebugEnabled()) {
    _log.debug("Screen name " + screenName + " and email address "+ emailAddress);
  }
  String firstName=LDAPUtil.getAttributeString(attributes,userMappings,UserConverterKeys.FIRST_NAME);
  String middleName=LDAPUtil.getAttributeString(attributes,userMappings,UserConverterKeys.MIDDLE_NAME);
  String lastName=LDAPUtil.getAttributeString(attributes,userMappings,UserConverterKeys.LAST_NAME);
  if (Validator.isNull(firstName) || Validator.isNull(lastName)) {
    String fullName=LDAPUtil.getAttributeString(attributes,userMappings,UserConverterKeys.FULL_NAME);
    FullNameGenerator fullNameGenerator=FullNameGeneratorFactory.getInstance();
    String[] names=fullNameGenerator.splitFullName(fullName);
    firstName=names[0];
    middleName=names[1];
    lastName=names[2];
  }
  if (!autoScreenName && Validator.isNull(screenName)) {
    throw new UserScreenNameException("Screen name cannot be null for " + ContactConstants.getFullName(firstName,middleName,lastName));
  }
  if (Validator.isNull(emailAddress) && PrefsPropsUtil.getBoolean(companyId,PropsKeys.USERS_EMAIL_ADDRESS_REQUIRED)) {
    throw new UserEmailAddressException("Email address cannot be null for " + ContactConstants.getFullName(firstName,middleName,lastName));
  }
  LDAPUser ldapUser=new LDAPUser();
  ldapUser.setAutoPassword(password.equals(StringPool.BLANK));
  ldapUser.setAutoScreenName(autoScreenName);
  Contact contact=new ContactImpl();
  Calendar birthdayCalendar=CalendarFactoryUtil.getCalendar(Calendar.JANUARY,1,1970);
  contact.setBirthday(birthdayCalendar.getTime());
  contact.setMale(true);
  contact.setPrefixId(0);
  contact.setSuffixId(0);
  ldapUser.setContact(contact);
  Map<String,String> contactExpandoAttributes=getExpandoAttributes(attributes,contactExpandoMappings);
  ldapUser.setContactExpandoAttributes(contactExpandoAttributes);
  ldapUser.setCreatorUserId(0);
  ldapUser.setGroupIds(null);
  ldapUser.setOrganizationIds(null);
  ldapUser.setPasswordReset(false);
  Object portrait=LDAPUtil.getAttributeObject(attributes,userMappings.getProperty(UserConverterKeys.PORTRAIT));
  if (portrait != null) {
    byte[] portraitBytes=(byte[])portrait;
    if (portraitBytes.length > 0) {
      ldapUser.setPortraitBytes((byte[])portrait);
    }
    ldapUser.setUpdatePortrait(true);
  }
  ldapUser.setRoleIds(null);
  ldapUser.setSendEmail(false);
  ServiceContext serviceContext=new ServiceContext();
  String uuid=LDAPUtil.getAttributeString(attributes,userMappings,UserConverterKeys.UUID);
  serviceContext.setUuid(uuid);
  ldapUser.setServiceContext(serviceContext);
  ldapUser.setUpdatePassword(!password.equals(StringPool.BLANK));
  User user=new UserImpl();
  user.setCompanyId(companyId);
  user.setEmailAddress(emailAddress);
  user.setFirstName(firstName);
  String jobTitle=LDAPUtil.getAttributeString(attributes,userMappings,UserConverterKeys.JOB_TITLE);
  user.setJobTitle(jobTitle);
  Locale locale=LocaleUtil.getDefault();
  user.setLanguageId(locale.toString());
  user.setLastName(lastName);
  user.setMiddleName(middleName);
  user.setOpenId(StringPool.BLANK);
  user.setPasswordUnencrypted(password);
  user.setScreenName(screenName);
  ldapUser.setUser(user);
  Map<String,String> userExpandoAttributes=getExpandoAttributes(attributes,userExpandoMappings);
  ldapUser.setUserExpandoAttributes(userExpandoAttributes);
  ldapUser.setUserGroupIds(null);
  ldapUser.setUserGroupRoles(null);
  return ldapUser;
}
