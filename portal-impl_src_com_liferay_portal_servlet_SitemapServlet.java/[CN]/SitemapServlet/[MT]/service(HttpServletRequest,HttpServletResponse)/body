{
  res.setContentType("text/xml; charset=UTF-8");
  OutputStreamWriter out=new OutputStreamWriter(res.getOutputStream());
  try {
    String host=PortalUtil.getHost(req);
    long groupId=ParamUtil.getLong(req,"groupId");
    boolean privateLayout=ParamUtil.getBoolean(req,"privateLayout");
    LayoutSet layoutSet=null;
    if (groupId > 0) {
      layoutSet=LayoutSetLocalServiceUtil.getLayoutSet(groupId,privateLayout);
    }
 else {
      layoutSet=LayoutSetLocalServiceUtil.getLayoutSet(host);
    }
    String portalURL=PortalUtil.getPortalURL(host,req.getServerPort(),req.isSecure());
    String mainPath=PortalUtil.PATH_MAIN;
    String sitemap=SitemapUtil.getSitemap(layoutSet.getGroupId(),layoutSet.isPrivateLayout(),portalURL + mainPath);
    if (!res.isCommitted()) {
      out.write(sitemap);
    }
  }
 catch (  NoSuchLayoutSetException e) {
    res.sendError(HttpServletResponse.SC_NOT_FOUND);
  }
catch (  Exception e) {
    if (_log.isWarnEnabled()) {
      _log.warn(e,e);
    }
    res.sendError(HttpServletResponse.SC_INTERNAL_SERVER_ERROR,e.getMessage());
  }
 finally {
    out.flush();
    out.close();
  }
}
