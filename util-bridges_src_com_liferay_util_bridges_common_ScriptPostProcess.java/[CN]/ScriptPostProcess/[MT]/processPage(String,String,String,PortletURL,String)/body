{
  final String SINGLE_QUOTE="\'";
  final String DOUBLE_QUOTE="\"";
  StringBuffer finalPage=new StringBuffer();
  String page=internalPage.toString();
  int ixTagOpen, ixTagEnd, ixRefStart, ixRefEnd;
  ixTagOpen=page.indexOf(startTag);
  try {
    while (ixTagOpen != -1) {
      finalPage.append(page.substring(0,ixTagOpen));
      page=page.substring(ixTagOpen);
      ixTagEnd=page.indexOf(endTag);
      ixRefStart=page.indexOf(ref);
      if (ixRefStart == -1 || ixRefStart > ixTagEnd) {
        finalPage.append(page.substring(0,ixTagEnd));
        page=page.substring(ixTagEnd);
      }
 else {
        String strQuote="";
        String url="";
        ixRefStart=ixRefStart + ref.length();
        finalPage.append(page.substring(0,ixRefStart));
        page=page.substring(ixRefStart);
        if (page.startsWith(SINGLE_QUOTE)) {
          strQuote=SINGLE_QUOTE;
        }
 else         if (page.startsWith(DOUBLE_QUOTE)) {
          strQuote=DOUBLE_QUOTE;
        }
        if (strQuote.length() > 0) {
          finalPage.append(strQuote);
          page=page.substring(1);
          ixRefEnd=page.indexOf(strQuote);
          url=page.substring(0,ixRefEnd);
        }
 else {
          ixTagEnd=page.indexOf(endTag);
          ixRefEnd=0;
          StringBuffer nqurl=new StringBuffer();
          boolean bEnd=false;
          while (bEnd == false) {
            char c=page.charAt(ixRefEnd);
            if ((Character.isSpaceChar(c) == false) && (ixRefEnd < ixTagEnd)) {
              ixRefEnd++;
              nqurl.append(c);
            }
 else {
              bEnd=true;
              ixRefEnd--;
            }
          }
          url=nqurl.toString();
        }
        if (url.charAt(0) == '#' || url.startsWith("http")) {
          finalPage.append(url).append(strQuote);
        }
 else {
          actionURL.setParameter(actionParameterName,url);
          finalPage.append(actionURL.toString()).append(strQuote);
        }
        page=page.substring(ixRefEnd + 1);
      }
      ixTagOpen=page.indexOf(startTag);
    }
    finalPage.append(page);
  }
 catch (  Exception e) {
    _log.error(e);
  }
  internalPage=finalPage;
}
