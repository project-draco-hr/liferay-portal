{
  ThemeDisplay themeDisplay=(ThemeDisplay)req.getAttribute(WebKeys.THEME_DISPLAY);
  Layout layout=themeDisplay.getLayout();
  LayoutTypePortlet layoutTypePortlet=themeDisplay.getLayoutTypePortlet();
  Theme theme=themeDisplay.getTheme();
  LayoutTemplate newLayoutTemplate=LayoutTemplateLocalServiceUtil.getLayoutTemplate(newLayoutTemplateId,false,theme.getThemeId());
  List<String> newColumns=getColumnNames(newLayoutTemplate.getContent(),portletResource);
  LayoutTemplate oldLayoutTemplate=LayoutTemplateLocalServiceUtil.getLayoutTemplate(oldLayoutTemplateId,false,theme.getThemeId());
  List<String> oldColumns=getColumnNames(oldLayoutTemplate.getContent(),portletResource);
  layoutTypePortlet.reorganizeNestedColumns(portletResource,newColumns,oldColumns);
  LayoutLocalServiceUtil.updateLayout(layout.getGroupId(),layout.isPrivateLayout(),layout.getLayoutId(),layout.getTypeSettings());
}
