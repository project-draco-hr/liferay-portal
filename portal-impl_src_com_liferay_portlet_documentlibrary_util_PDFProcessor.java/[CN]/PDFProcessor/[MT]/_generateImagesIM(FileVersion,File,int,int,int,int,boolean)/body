{
  String id=DLUtil.getTempFileId(fileVersion.getFileEntryId(),fileVersion.getVersion());
  IMOperation imOperation=new IMOperation();
  imOperation.density(dpi,dpi);
  if (height != 0) {
    imOperation.adaptiveResize(width,height);
  }
 else {
    imOperation.adaptiveResize(width);
  }
  imOperation.depth(depth);
  if (thumbnail) {
    imOperation.addImage(file.getPath() + "[0]");
    imOperation.addImage(getThumbnailTempFilePath(id));
  }
 else {
    imOperation.addImage(file.getPath());
    imOperation.addImage(getPreviewTempFilePath(id,-1));
  }
  try {
    _convertCmd.run(imOperation);
  }
 catch (  IOException ioe) {
    throw ioe;
  }
catch (  Exception e) {
    throw new SystemException(e);
  }
  if (thumbnail) {
    File tempFile=getThumbnailTempFile(id);
    try {
      addFileToStore(fileVersion.getCompanyId(),THUMBNAIL_PATH,getThumbnailFilePath(fileVersion),tempFile);
    }
  finally {
      FileUtil.delete(tempFile);
    }
  }
 else {
    File singlePagePreviewFile=getPreviewTempFile(id,-1);
    if (singlePagePreviewFile.exists()) {
      singlePagePreviewFile.renameTo(getPreviewTempFile(id,1));
    }
    int total=getPreviewTempFileCount(fileVersion);
    for (int i=0; i < total; i++) {
      File tempFile=getPreviewTempFile(id,i + 1);
      try {
        addFileToStore(fileVersion.getCompanyId(),PREVIEW_PATH,getPreviewFilePath(fileVersion,i + 1),tempFile);
      }
  finally {
        FileUtil.delete(tempFile);
      }
    }
  }
}
