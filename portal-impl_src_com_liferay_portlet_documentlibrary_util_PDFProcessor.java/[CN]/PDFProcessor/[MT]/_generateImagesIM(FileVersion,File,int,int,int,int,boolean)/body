{
  String tempFileId=DLUtil.getTempFileId(fileVersion.getFileEntryId(),fileVersion.getVersion());
  String inputfilePath=file.getPath();
  String outputFilePath=null;
  if (thumbnail) {
    inputfilePath+="[0]";
    outputFilePath=getThumbnailTempFilePath(tempFileId);
  }
 else {
    outputFilePath=getPreviewTempFilePath(tempFileId,-1);
  }
  ProcessExecutor.execute(new ImageMagickProcessCallable(_globalSearchPath,inputfilePath,outputFilePath,depth,dpi,height,width),ClassPathUtil.getPortalClassPath());
  if (thumbnail) {
    File thumbnailTempFile=getThumbnailTempFile(tempFileId);
    try {
      addFileToStore(fileVersion.getCompanyId(),THUMBNAIL_PATH,getThumbnailFilePath(fileVersion),thumbnailTempFile);
    }
  finally {
      FileUtil.delete(thumbnailTempFile);
    }
  }
 else {
    File singlePagePreviewFile=getPreviewTempFile(tempFileId,-1);
    if (singlePagePreviewFile.exists()) {
      singlePagePreviewFile.renameTo(getPreviewTempFile(tempFileId,1));
    }
    int total=getPreviewTempFileCount(fileVersion);
    for (int i=0; i < total; i++) {
      File previewTempFile=getPreviewTempFile(tempFileId,i + 1);
      try {
        addFileToStore(fileVersion.getCompanyId(),PREVIEW_PATH,getPreviewFilePath(fileVersion,i + 1),previewTempFile);
      }
  finally {
        FileUtil.delete(previewTempFile);
      }
    }
  }
}
