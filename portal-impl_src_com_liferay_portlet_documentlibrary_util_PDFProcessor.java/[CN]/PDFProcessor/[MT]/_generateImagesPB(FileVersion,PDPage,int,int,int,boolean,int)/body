{
  String id=DLUtil.getTempFileId(fileVersion.getFileEntryId(),fileVersion.getVersion());
  RenderedImage renderedImage=pdPage.convertToImage(BufferedImage.TYPE_INT_RGB,PropsValues.DL_FILE_ENTRY_THUMBNAIL_DPI);
  if (height != 0) {
    renderedImage=ImageProcessorUtil.scale(renderedImage,width,height);
  }
 else {
    renderedImage=ImageProcessorUtil.scale(renderedImage,width);
  }
  File tempFile=null;
  try {
    if (thumbnail) {
      tempFile=getThumbnailTempFile(id);
      tempFile.createNewFile();
      ImageIO.write(renderedImage,THUMBNAIL_TYPE,new FileOutputStream(tempFile));
      addFileToStore(fileVersion.getCompanyId(),THUMBNAIL_PATH,getThumbnailFilePath(fileVersion),tempFile);
    }
 else {
      tempFile=getPreviewTempFile(id,index);
      tempFile.createNewFile();
      ImageIO.write(renderedImage,PREVIEW_TYPE,new FileOutputStream(tempFile));
      addFileToStore(fileVersion.getCompanyId(),PREVIEW_PATH,getPreviewFilePath(fileVersion,index),tempFile);
    }
  }
  finally {
    FileUtil.delete(tempFile);
  }
}
