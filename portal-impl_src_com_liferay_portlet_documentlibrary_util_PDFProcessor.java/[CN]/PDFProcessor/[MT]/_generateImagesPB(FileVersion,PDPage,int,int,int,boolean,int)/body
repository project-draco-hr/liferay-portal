{
  RenderedImage renderedImage=pdPage.convertToImage(BufferedImage.TYPE_INT_RGB,PropsValues.DL_FILE_ENTRY_THUMBNAIL_DPI);
  if (height != 0) {
    renderedImage=ImageProcessorUtil.scale(renderedImage,width,height);
  }
 else {
    renderedImage=ImageProcessorUtil.scale(renderedImage,width);
  }
  String tempFileId=DLUtil.getTempFileId(fileVersion.getFileEntryId(),fileVersion.getVersion());
  File thumbnailTempFile=null;
  try {
    if (thumbnail) {
      thumbnailTempFile=getThumbnailTempFile(tempFileId);
      thumbnailTempFile.createNewFile();
      ImageIO.write(renderedImage,THUMBNAIL_TYPE,new FileOutputStream(thumbnailTempFile));
      addFileToStore(fileVersion.getCompanyId(),THUMBNAIL_PATH,getThumbnailFilePath(fileVersion),thumbnailTempFile);
    }
 else {
      thumbnailTempFile=getPreviewTempFile(tempFileId,index);
      thumbnailTempFile.createNewFile();
      ImageIO.write(renderedImage,PREVIEW_TYPE,new FileOutputStream(thumbnailTempFile));
      addFileToStore(fileVersion.getCompanyId(),PREVIEW_PATH,getPreviewFilePath(fileVersion,index),thumbnailTempFile);
    }
  }
  finally {
    FileUtil.delete(thumbnailTempFile);
  }
}
