{
  String alias=GetterUtil.getString(reference.getProperty(HttpServicePropsKeys.ALIAS));
  if (Validator.isNull(alias)) {
    return servlet;
  }
  String contextId=GetterUtil.getString(reference.getProperty(HttpServicePropsKeys.CONTEXT_ID));
  Hashtable<String,String> initParameters=new Hashtable<String,String>();
  if (action != Action.REMOVED) {
    for (    String key : reference.getPropertyKeys()) {
      if (key.startsWith(HttpServicePropsKeys.INIT_PREFIX)) {
        String value=GetterUtil.getString(reference.getProperty(key));
        initParameters.put(key.substring(HttpServicePropsKeys.INIT_PREFIX.length()),value);
      }
    }
  }
  Bundle bundle=reference.getBundle();
  try {
    BundleServletContext servletContext=_httpSupport.getServletContext(bundle);
    if (action != Action.ADDING) {
      servletContext.unregister(alias);
    }
    if (action != Action.REMOVED) {
      HttpContext httpContext=_httpSupport.getHttpContext(contextId);
      if (httpContext == null) {
        httpContext=servletContext.getHttpContext();
      }
      servletContext.registerServlet(alias,servlet,initParameters,httpContext);
    }
  }
 catch (  Exception e) {
    _log.error(e);
  }
  return servlet;
}
