{
  try (LoggingTimer loggingTimer=new LoggingTimer()){
    runSQL("alter table DLFileEntry add fileName VARCHAR(255) null");
    try (PreparedStatement ps1=connection.prepareStatement("select fileEntryId, groupId, folderId, extension, title," + " version from DLFileEntry");PreparedStatement ps2=AutoBatchPreparedStatementUtil.autoBatch(connection.prepareStatement("update DLFileEntry set fileName = ?, title = ? " + "where fileEntryId = ?"));PreparedStatement ps3=AutoBatchPreparedStatementUtil.concurrentAutoBatch(connection,"update DLFileVersion set title = ? where " + "fileEntryId = " + "? and version = ?");ResultSet rs=ps1.executeQuery()){
      Set<String> generatedUniqueFileNames=new HashSet<>();
      Set<String> generatedUniqueTitles=new HashSet<>();
      while (rs.next()) {
        long fileEntryId=rs.getLong("fileEntryId");
        long groupId=rs.getLong("groupId");
        long folderId=rs.getLong("folderId");
        String extension=GetterUtil.getString(rs.getString("extension"));
        String title=GetterUtil.getString(rs.getString("title"));
        String version=rs.getString("version");
        String uniqueFileName=DLUtil.getSanitizedFileName(title,extension);
        String titleExtension=StringPool.BLANK;
        String titleWithoutExtension=title;
        if (title.endsWith(StringPool.PERIOD + extension)) {
          titleExtension=extension;
          titleWithoutExtension=FileUtil.stripExtension(title);
        }
        String uniqueTitle=title;
        boolean foundNameClash=false;
        for (int i=1; ; i++) {
          if (!generatedUniqueFileNames.contains(uniqueFileName) && !generatedUniqueTitles.contains(uniqueTitle) && !hasFileEntry(groupId,folderId,fileEntryId,uniqueTitle,uniqueFileName)) {
            break;
          }
          foundNameClash=true;
          uniqueTitle=titleWithoutExtension + StringPool.UNDERLINE + String.valueOf(i);
          if (Validator.isNotNull(titleExtension)) {
            uniqueTitle+=StringPool.PERIOD.concat(titleExtension);
          }
          uniqueFileName=DLUtil.getSanitizedFileName(uniqueTitle,extension);
        }
        if (foundNameClash) {
          generatedUniqueFileNames.add(uniqueFileName);
          generatedUniqueTitles.add(uniqueTitle);
        }
        ps2.setString(1,uniqueFileName);
        if (Validator.isNotNull(uniqueTitle)) {
          ps2.setString(2,uniqueTitle);
        }
 else {
          ps2.setString(2,title);
        }
        ps2.setLong(3,fileEntryId);
        ps2.addBatch();
        if (Validator.isNotNull(uniqueTitle)) {
          ps3.setString(1,uniqueTitle);
          ps3.setLong(2,fileEntryId);
          ps3.setString(3,version);
          ps3.addBatch();
        }
      }
      ps2.executeBatch();
      ps3.executeBatch();
    }
   }
 }
