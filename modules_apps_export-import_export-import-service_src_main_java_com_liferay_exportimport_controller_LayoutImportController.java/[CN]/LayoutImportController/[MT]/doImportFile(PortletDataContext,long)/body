{
  Map<String,String[]> parameterMap=portletDataContext.getParameterMap();
  boolean deleteMissingLayouts=MapUtil.getBoolean(parameterMap,PortletDataHandlerKeys.DELETE_MISSING_LAYOUTS,Boolean.TRUE.booleanValue());
  boolean importPermissions=MapUtil.getBoolean(parameterMap,PortletDataHandlerKeys.PERMISSIONS);
  boolean importLogo=MapUtil.getBoolean(parameterMap,PortletDataHandlerKeys.LOGO);
  boolean importLayoutSetSettings=MapUtil.getBoolean(parameterMap,PortletDataHandlerKeys.LAYOUT_SET_SETTINGS);
  boolean layoutSetPrototypeLinkEnabled=MapUtil.getBoolean(parameterMap,PortletDataHandlerKeys.LAYOUT_SET_PROTOTYPE_LINK_ENABLED);
  Group group=_groupLocalService.getGroup(portletDataContext.getGroupId());
  if (group.isLayoutSetPrototype()) {
    layoutSetPrototypeLinkEnabled=false;
  }
  String layoutsImportMode=MapUtil.getString(parameterMap,PortletDataHandlerKeys.LAYOUTS_IMPORT_MODE,PortletDataHandlerKeys.LAYOUTS_IMPORT_MODE_MERGE_BY_LAYOUT_UUID);
  if (_log.isDebugEnabled()) {
    _log.debug("Import permissions " + importPermissions);
  }
  StopWatch stopWatch=new StopWatch();
  stopWatch.start();
  LayoutCache layoutCache=new LayoutCache();
  LayoutSet layoutSet=_layoutSetLocalService.getLayoutSet(portletDataContext.getGroupId(),portletDataContext.isPrivateLayout());
  long companyId=layoutSet.getCompanyId();
  ServiceContext serviceContext=ServiceContextThreadLocal.getServiceContext();
  if (serviceContext == null) {
    serviceContext=new ServiceContext();
  }
  serviceContext.setCompanyId(companyId);
  serviceContext.setSignedIn(false);
  serviceContext.setUserId(userId);
  ServiceContextThreadLocal.pushServiceContext(serviceContext);
  validateFile(companyId,portletDataContext.getGroupId(),parameterMap,portletDataContext.getZipReader());
  Map<Long,Long> groupIds=(Map<Long,Long>)portletDataContext.getNewPrimaryKeysMap(Group.class);
  groupIds.put(portletDataContext.getSourceGroupId(),portletDataContext.getGroupId());
  ManifestSummary manifestSummary=ExportImportHelperUtil.getManifestSummary(portletDataContext);
  portletDataContext.setManifestSummary(manifestSummary);
  Element layoutsElement=portletDataContext.getImportDataGroupElement(Layout.class);
  String layoutSetPrototypeUuid=layoutsElement.attributeValue("layout-set-prototype-uuid");
  Element rootElement=portletDataContext.getImportDataRootElement();
  Element headerElement=rootElement.element("header");
  String larType=headerElement.attributeValue("type");
  if (group.isLayoutPrototype() && larType.equals("layout-prototype")) {
    deleteMissingLayouts=false;
    LayoutPrototype layoutPrototype=_layoutPrototypeLocalService.getLayoutPrototype(group.getClassPK());
    String layoutPrototypeUuid=GetterUtil.getString(headerElement.attributeValue("type-uuid"));
    LayoutPrototype existingLayoutPrototype=null;
    if (Validator.isNotNull(layoutPrototypeUuid)) {
      try {
        existingLayoutPrototype=_layoutPrototypeLocalService.getLayoutPrototypeByUuidAndCompanyId(layoutPrototypeUuid,companyId);
      }
 catch (      NoSuchLayoutPrototypeException nslpe) {
      }
    }
    if (existingLayoutPrototype == null) {
      List<Layout> layouts=_layoutLocalService.getLayoutsByLayoutPrototypeUuid(layoutPrototype.getUuid());
      layoutPrototype.setUuid(layoutPrototypeUuid);
      _layoutPrototypeLocalService.updateLayoutPrototype(layoutPrototype);
      for (      Layout layout : layouts) {
        layout.setLayoutPrototypeUuid(layoutPrototypeUuid);
        _layoutLocalService.updateLayout(layout);
      }
    }
  }
 else   if (group.isLayoutSetPrototype() && larType.equals("layout-set-prototype")) {
    LayoutSetPrototype layoutSetPrototype=_layoutSetPrototypeLocalService.getLayoutSetPrototype(group.getClassPK());
    String importedLayoutSetPrototypeUuid=GetterUtil.getString(headerElement.attributeValue("type-uuid"));
    LayoutSetPrototype existingLayoutSetPrototype=null;
    if (Validator.isNotNull(importedLayoutSetPrototypeUuid)) {
      try {
        existingLayoutSetPrototype=_layoutSetPrototypeLocalService.getLayoutSetPrototypeByUuidAndCompanyId(importedLayoutSetPrototypeUuid,companyId);
      }
 catch (      NoSuchLayoutSetPrototypeException nslspe) {
      }
    }
    if (existingLayoutSetPrototype == null) {
      List<LayoutSet> layoutSets=_layoutSetLocalService.getLayoutSetsByLayoutSetPrototypeUuid(layoutSetPrototype.getUuid());
      layoutSetPrototype.setUuid(importedLayoutSetPrototypeUuid);
      _layoutSetPrototypeLocalService.updateLayoutSetPrototype(layoutSetPrototype);
      for (      LayoutSet curLayoutSet : layoutSets) {
        curLayoutSet.setLayoutSetPrototypeUuid(importedLayoutSetPrototypeUuid);
        _layoutSetLocalService.updateLayoutSet(curLayoutSet);
      }
    }
  }
 else   if (larType.equals("layout-set-prototype")) {
    layoutSetPrototypeUuid=GetterUtil.getString(headerElement.attributeValue("type-uuid"));
  }
  if (Validator.isNotNull(layoutSetPrototypeUuid)) {
    layoutSet.setLayoutSetPrototypeUuid(layoutSetPrototypeUuid);
    layoutSet.setLayoutSetPrototypeLinkEnabled(layoutSetPrototypeLinkEnabled);
    _layoutSetLocalService.updateLayoutSet(layoutSet);
  }
  if (importLogo) {
    String logoPath=headerElement.attributeValue("logo-path");
    byte[] iconBytes=portletDataContext.getZipEntryAsByteArray(logoPath);
    if (ArrayUtil.isNotEmpty(iconBytes)) {
      _layoutSetLocalService.updateLogo(portletDataContext.getGroupId(),portletDataContext.isPrivateLayout(),true,iconBytes);
    }
 else {
      _layoutSetLocalService.updateLogo(portletDataContext.getGroupId(),portletDataContext.isPrivateLayout(),false,(File)null);
    }
  }
  _themeImporter.importTheme(portletDataContext,layoutSet);
  if (importLayoutSetSettings) {
    String settings=GetterUtil.getString(headerElement.elementText("settings"));
    _layoutSetLocalService.updateSettings(portletDataContext.getGroupId(),portletDataContext.isPrivateLayout(),settings);
  }
  Element portletsElement=rootElement.element("portlets");
  List<Element> portletElements=portletsElement.elements("portlet");
  if (BackgroundTaskThreadLocal.hasBackgroundTask()) {
    List<String> portletIds=new ArrayList<>();
    for (    Element portletElement : portletElements) {
      String portletId=portletElement.attributeValue("portlet-id");
      Portlet portlet=_portletLocalService.getPortletById(portletDataContext.getCompanyId(),portletId);
      if (!portlet.isActive() || portlet.isUndeployedPortlet()) {
        continue;
      }
      portletIds.add(portletId);
    }
    PortletDataHandlerStatusMessageSenderUtil.sendStatusMessage("layout",ArrayUtil.toStringArray(portletIds),manifestSummary);
  }
  if (importPermissions) {
    for (    Element portletElement : portletElements) {
      String portletPath=portletElement.attributeValue("path");
      Document portletDocument=SAXReaderUtil.read(portletDataContext.getZipEntryAsString(portletPath));
      _permissionImporter.checkRoles(layoutCache,companyId,portletDataContext.getGroupId(),userId,portletDocument.getRootElement());
    }
    _permissionImporter.readPortletDataPermissions(portletDataContext);
  }
  _portletImportController.readExpandoTables(portletDataContext);
  _portletImportController.readLocks(portletDataContext);
  Set<Layout> modifiedLayouts=new HashSet<>();
  List<Layout> previousLayouts=LayoutUtil.findByG_P(portletDataContext.getGroupId(),portletDataContext.isPrivateLayout());
  if (Validator.isNotNull(layoutSetPrototypeUuid) && layoutSetPrototypeLinkEnabled) {
    LayoutSetPrototype layoutSetPrototype=_layoutSetPrototypeLocalService.getLayoutSetPrototypeByUuidAndCompanyId(layoutSetPrototypeUuid,companyId);
    for (    Layout layout : previousLayouts) {
      String sourcePrototypeLayoutUuid=layout.getSourcePrototypeLayoutUuid();
      if (Validator.isNull(layout.getSourcePrototypeLayoutUuid())) {
        continue;
      }
      if (SitesUtil.isLayoutModifiedSinceLastMerge(layout)) {
        modifiedLayouts.add(layout);
        continue;
      }
      Layout sourcePrototypeLayout=LayoutUtil.fetchByUUID_G_P(sourcePrototypeLayoutUuid,layoutSetPrototype.getGroupId(),true);
      if (sourcePrototypeLayout == null) {
        _layoutLocalService.deleteLayout(layout,false,serviceContext);
      }
    }
  }
  List<Element> layoutElements=layoutsElement.elements();
  if (_log.isDebugEnabled()) {
    if (!layoutElements.isEmpty()) {
      _log.debug("Importing layouts");
    }
  }
  List<String> sourceLayoutsUuids=new ArrayList<>();
  for (  Element layoutElement : layoutElements) {
    importLayout(portletDataContext,sourceLayoutsUuids,layoutElement);
  }
  if (_log.isDebugEnabled()) {
    if (!portletElements.isEmpty()) {
      _log.debug("Importing portlets");
    }
  }
  Map<Long,Layout> layouts=(Map<Long,Layout>)portletDataContext.getNewPrimaryKeysMap(Layout.class + ".layout");
  for (  Element portletElement : portletElements) {
    String portletPath=portletElement.attributeValue("path");
    String portletId=portletElement.attributeValue("portlet-id");
    long layoutId=GetterUtil.getLong(portletElement.attributeValue("layout-id"));
    long oldPlid=GetterUtil.getLong(portletElement.attributeValue("old-plid"));
    Portlet portlet=_portletLocalService.getPortletById(portletDataContext.getCompanyId(),portletId);
    if (!portlet.isActive() || portlet.isUndeployedPortlet()) {
      continue;
    }
    Layout layout=layouts.get(layoutId);
    long plid=LayoutConstants.DEFAULT_PLID;
    if (layout != null) {
      plid=layout.getPlid();
      if (modifiedLayouts.contains(layout)) {
        continue;
      }
    }
    portletDataContext.setPlid(plid);
    portletDataContext.setOldPlid(oldPlid);
    portletDataContext.setPortletId(portletId);
    if (BackgroundTaskThreadLocal.hasBackgroundTask()) {
      PortletDataHandlerStatusMessageSenderUtil.sendStatusMessage("portlet",portletId,manifestSummary);
    }
    Document portletDocument=SAXReaderUtil.read(portletDataContext.getZipEntryAsString(portletPath));
    portletElement=portletDocument.getRootElement();
    setPortletScope(portletDataContext,portletElement);
    long portletPreferencesGroupId=portletDataContext.getGroupId();
    Element portletDataElement=portletElement.element("portlet-data");
    Map<String,Boolean> importPortletControlsMap=ExportImportHelperUtil.getImportPortletControlsMap(companyId,portletId,parameterMap,portletDataElement,manifestSummary);
    if (layout != null) {
      portletPreferencesGroupId=layout.getGroupId();
    }
    try {
      _exportImportLifecycleManager.fireExportImportLifecycleEvent(EVENT_PORTLET_IMPORT_STARTED,getProcessFlag(),PortletDataContextFactoryUtil.clonePortletDataContext(portletDataContext));
      _portletImportController.importPortletPreferences(portletDataContext,layoutSet.getCompanyId(),portletPreferencesGroupId,layout,portletElement,false,importPortletControlsMap.get(PortletDataHandlerKeys.PORTLET_ARCHIVED_SETUPS),importPortletControlsMap.get(PortletDataHandlerKeys.PORTLET_DATA),importPortletControlsMap.get(PortletDataHandlerKeys.PORTLET_SETUP),importPortletControlsMap.get(PortletDataHandlerKeys.PORTLET_USER_PREFERENCES));
      if (importPortletControlsMap.get(PortletDataHandlerKeys.PORTLET_DATA)) {
        _portletImportController.importPortletData(portletDataContext,portletDataElement);
      }
      _exportImportLifecycleManager.fireExportImportLifecycleEvent(EVENT_PORTLET_IMPORT_SUCCEEDED,getProcessFlag(),PortletDataContextFactoryUtil.clonePortletDataContext(portletDataContext));
    }
 catch (    Throwable t) {
      _exportImportLifecycleManager.fireExportImportLifecycleEvent(EVENT_PORTLET_IMPORT_FAILED,getProcessFlag(),PortletDataContextFactoryUtil.clonePortletDataContext(portletDataContext),t);
      throw t;
    }
 finally {
      _portletImportController.resetPortletScope(portletDataContext,portletPreferencesGroupId);
    }
    if (importPermissions) {
      _permissionImporter.importPortletPermissions(layoutCache,companyId,portletDataContext.getGroupId(),userId,layout,portletElement,portletId);
    }
    _portletImportController.importPortletPreferences(portletDataContext,layoutSet.getCompanyId(),portletDataContext.getGroupId(),null,portletElement,false,importPortletControlsMap.get(PortletDataHandlerKeys.PORTLET_ARCHIVED_SETUPS),importPortletControlsMap.get(PortletDataHandlerKeys.PORTLET_DATA),importPortletControlsMap.get(PortletDataHandlerKeys.PORTLET_SETUP),importPortletControlsMap.get(PortletDataHandlerKeys.PORTLET_USER_PREFERENCES));
  }
  if (_log.isDebugEnabled() && !portletElements.isEmpty()) {
    _log.debug("Importing services");
  }
  Element servicesElement=rootElement.element("services");
  List<Element> serviceElements=servicesElement.elements("service");
  for (  Element serviceElement : serviceElements) {
    String path=serviceElement.attributeValue("path");
    Document serviceDocument=SAXReaderUtil.read(portletDataContext.getZipEntryAsString(path));
    serviceElement=serviceDocument.getRootElement();
    _portletImportController.importServicePortletPreferences(portletDataContext,serviceElement);
  }
  _portletImportController.readAssetLinks(portletDataContext);
  if (deleteMissingLayouts) {
    deleteMissingLayouts(portletDataContext,sourceLayoutsUuids,previousLayouts,serviceContext);
  }
  layoutSet=_layoutSetLocalService.updatePageCount(portletDataContext.getGroupId(),portletDataContext.isPrivateLayout());
  _groupLocalService.updateSite(portletDataContext.getGroupId(),true);
  updateLayoutPriorities(portletDataContext,layoutElements,portletDataContext.isPrivateLayout());
  if (layoutsImportMode.equals(PortletDataHandlerKeys.LAYOUTS_IMPORT_MODE_CREATED_FROM_PROTOTYPE)) {
    long lastMergeTime=System.currentTimeMillis();
    for (    Layout layout : layouts.values()) {
      layout=_layoutLocalService.getLayout(layout.getPlid());
      if (modifiedLayouts.contains(layout)) {
        continue;
      }
      UnicodeProperties typeSettingsProperties=layout.getTypeSettingsProperties();
      typeSettingsProperties.setProperty(Sites.LAST_MERGE_TIME,String.valueOf(lastMergeTime));
      LayoutUtil.update(layout);
    }
    layoutSet=_layoutSetLocalService.getLayoutSet(layoutSet.getLayoutSetId());
    UnicodeProperties settingsProperties=layoutSet.getSettingsProperties();
    String mergeFailFriendlyURLLayouts=settingsProperties.getProperty(Sites.MERGE_FAIL_FRIENDLY_URL_LAYOUTS);
    if (Validator.isNull(mergeFailFriendlyURLLayouts) && modifiedLayouts.isEmpty()) {
      settingsProperties.setProperty(Sites.LAST_MERGE_TIME,String.valueOf(lastMergeTime));
      _layoutSetLocalService.updateLayoutSet(layoutSet);
    }
  }
  if (_log.isInfoEnabled()) {
    _log.info("Importing layouts takes " + stopWatch.getTime() + " ms");
  }
  ZipReader zipReader=portletDataContext.getZipReader();
  zipReader.close();
}
