{
  Connection con=null;
  PreparedStatement ps=null;
  ResultSet rs=null;
  try {
    con=DataAccess.getUpgradeOptimizedConnection();
    String sql=getUpgradeRecordVersionsSQL();
    ps=con.prepareStatement(sql);
    rs=ps.executeQuery();
    Set<Long> ddmStorageIds=new HashSet<>();
    while (rs.next()) {
      long recordVersionId=rs.getLong("recordVersionId");
      long groupId=rs.getLong("groupId");
      long companyId=rs.getLong("companyId");
      long userId=rs.getLong("userId");
      String userName=rs.getString("userName");
      Timestamp createDate=rs.getTimestamp("createDate");
      long ddmStorageId=rs.getLong("DDMStorageId");
      long recordId=rs.getLong("recordId");
      String version=rs.getString("version");
      long ddmContentId=increment();
      Map<String,String> expandoValuesMap=getExpandoValuesMap(ddmStorageId);
      String xml=toXML(expandoValuesMap);
      addDDMContent(PortalUUIDUtil.generate(),ddmContentId,groupId,companyId,userId,userName,createDate,createDate,DDMStorageLink.class.getName(),null,xml);
      updateRecordVersionDDMStorageId(recordVersionId,ddmContentId);
      updateRecordDDMStorageId(recordId,version,ddmContentId);
      updateDDMStorageLink(_expandoStorageAdapterClassNameId,ddmStorageId,_ddmContentClassNameId,ddmContentId);
      ddmStorageIds.add(ddmStorageId);
    }
    if (ddmStorageIds.isEmpty()) {
      return;
    }
    updateDDMStructureStorageType();
    deleteExpandoData(ddmStorageIds);
  }
  finally {
    DataAccess.cleanUp(con,ps,rs);
  }
}
