{
  User user=userPersistence.fetchByPrimaryKey(userId);
  if (user.isDefaultUser()) {
    return Collections.emptyList();
  }
  List<Group> userPlaces=new UniqueList<Group>();
  int start=QueryUtil.ALL_POS;
  int end=QueryUtil.ALL_POS;
  if (max != QueryUtil.ALL_POS) {
    start=0;
    end=max;
  }
  if ((classNames == null) || ArrayUtil.contains(classNames,Group.class.getName())) {
    LinkedHashMap<String,Object> groupParams=new LinkedHashMap<String,Object>();
    groupParams.put("active",Boolean.TRUE);
    groupParams.put("usersGroups",new Long(userId));
    userPlaces.addAll(groupLocalService.search(user.getCompanyId(),null,null,groupParams,start,end));
  }
  if ((classNames == null) || ArrayUtil.contains(classNames,Organization.class.getName())) {
    LinkedHashMap<String,Object> organizationParams=new LinkedHashMap<String,Object>();
    organizationParams.put("usersOrgs",new Long(userId));
    List<Organization> userOrgs=organizationLocalService.search(user.getCompanyId(),organizationParams,start,end);
    for (    Organization organization : userOrgs) {
      userPlaces.add(0,organization.getGroup());
      if (!PropsValues.ORGANIZATIONS_MEMBERSHIP_STRICT) {
        for (        Organization ancestorOrganization : organization.getAncestors()) {
          userPlaces.add(0,ancestorOrganization.getGroup());
        }
      }
    }
  }
  if ((classNames == null) || ArrayUtil.contains(classNames,User.class.getName())) {
    if (PropsValues.LAYOUT_USER_PRIVATE_LAYOUTS_ENABLED || PropsValues.LAYOUT_USER_PUBLIC_LAYOUTS_ENABLED) {
      Group userGroup=user.getGroup();
      userPlaces.add(0,userGroup);
    }
  }
  PermissionChecker permissionChecker=getPermissionChecker();
  if (permissionChecker.getUserId() != userId) {
    try {
      permissionChecker=PermissionCheckerFactoryUtil.create(user,true);
    }
 catch (    Exception e) {
      throw new PrincipalException(e);
    }
  }
  if (PortalPermissionUtil.contains(permissionChecker,ActionKeys.VIEW_CONTROL_PANEL)) {
    Group controlPanelGroup=groupLocalService.getGroup(user.getCompanyId(),GroupConstants.CONTROL_PANEL);
    userPlaces.add(0,controlPanelGroup);
  }
  if ((max != QueryUtil.ALL_POS) && (userPlaces.size() > max)) {
    userPlaces=ListUtil.subList(userPlaces,start,end);
  }
  return Collections.unmodifiableList(userPlaces);
}
