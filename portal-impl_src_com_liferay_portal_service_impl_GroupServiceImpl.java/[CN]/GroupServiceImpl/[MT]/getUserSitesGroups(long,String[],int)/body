{
  User user=userPersistence.findByPrimaryKey(userId);
  boolean checkPermissions=true;
  if (userId == getUserId()) {
    checkPermissions=false;
  }
  if (checkPermissions) {
    UserPermissionUtil.check(getPermissionChecker(),userId,ActionKeys.VIEW);
  }
  if (user.isDefaultUser()) {
    return Collections.emptyList();
  }
  Set<Group> userSiteGroups=new LinkedHashSet<>();
  if (classNames == null) {
    classNames=new String[]{Company.class.getName(),Group.class.getName(),Organization.class.getName(),User.class.getName()};
  }
  if (ArrayUtil.contains(classNames,User.class.getName())) {
    if (PropsValues.LAYOUT_USER_PRIVATE_LAYOUTS_ENABLED || PropsValues.LAYOUT_USER_PUBLIC_LAYOUTS_ENABLED) {
      userSiteGroups.add(user.getGroup());
      if (userSiteGroups.size() == max) {
        if (checkPermissions) {
          return filterGroups(new ArrayList<>(userSiteGroups));
        }
        return new ArrayList<>(userSiteGroups);
      }
    }
  }
  if (ArrayUtil.contains(classNames,Company.class.getName())) {
    Group companyGroup=groupLocalService.getCompanyGroup(user.getCompanyId());
    if (GroupPermissionUtil.contains(getPermissionChecker(),companyGroup,ActionKeys.VIEW_SITE_ADMINISTRATION)) {
      userSiteGroups.add(companyGroup);
      if (userSiteGroups.size() == max) {
        return new ArrayList<>(userSiteGroups);
      }
    }
  }
  if (ArrayUtil.contains(classNames,Group.class.getName()) || ArrayUtil.contains(classNames,Organization.class.getName())) {
    UserBag userBag=UserBagFactoryUtil.create(userId);
    if (ArrayUtil.contains(classNames,Group.class.getName())) {
      for (      Group group : userBag.getUserGroups()) {
        if (group.isActive() && group.isSite()) {
          if (userSiteGroups.add(group) && (userSiteGroups.size() == max)) {
            if (checkPermissions) {
              return filterGroups(new ArrayList<>(userSiteGroups));
            }
            return new ArrayList<>(userSiteGroups);
          }
        }
      }
    }
    if (ArrayUtil.contains(classNames,Organization.class.getName())) {
      for (      Group group : userBag.getUserOrgGroups()) {
        if (group.isActive() && group.isSite()) {
          if (userSiteGroups.add(group) && (userSiteGroups.size() == max)) {
            if (checkPermissions) {
              return filterGroups(new ArrayList<>(userSiteGroups));
            }
            return new ArrayList<>(userSiteGroups);
          }
        }
      }
    }
  }
  if (checkPermissions) {
    return filterGroups(new ArrayList<>(userSiteGroups));
  }
  return new ArrayList<>(userSiteGroups);
}
