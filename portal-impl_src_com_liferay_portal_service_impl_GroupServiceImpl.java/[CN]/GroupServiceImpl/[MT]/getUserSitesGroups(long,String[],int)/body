{
  User user=userPersistence.fetchByPrimaryKey(userId);
  if (user.isDefaultUser()) {
    return Collections.emptyList();
  }
  List<Group> userSiteGroups=new ArrayList<>();
  if (classNames == null) {
    classNames=new String[]{Company.class.getName(),Group.class.getName(),Organization.class.getName(),User.class.getName()};
  }
  if (ArrayUtil.contains(classNames,User.class.getName())) {
    if (PropsValues.LAYOUT_USER_PRIVATE_LAYOUTS_ENABLED || PropsValues.LAYOUT_USER_PUBLIC_LAYOUTS_ENABLED) {
      Group userGroup=user.getGroup();
      userSiteGroups.add(userGroup);
    }
  }
  if (ArrayUtil.contains(classNames,Company.class.getName())) {
    userSiteGroups.add(groupLocalService.getCompanyGroup(user.getCompanyId()));
  }
  UserBag userBag=UserBagFactoryUtil.create(userId);
  if (ArrayUtil.contains(classNames,Group.class.getName())) {
    for (    Group group : userBag.getUserGroups()) {
      if (group.isActive() && (group.hasPrivateLayouts() || group.hasPublicLayouts())) {
        userSiteGroups.add(group);
      }
    }
  }
  if (ArrayUtil.contains(classNames,Organization.class.getName())) {
    if (PropsValues.ORGANIZATIONS_MEMBERSHIP_STRICT) {
      List<Organization> userOrgs=organizationLocalService.getOrganizations(userId,QueryUtil.ALL_POS,QueryUtil.ALL_POS,null);
      for (      Organization organization : userOrgs) {
        Group group=organization.getGroup();
        if (group.isActive() && (group.hasPrivateLayouts() || group.hasPublicLayouts())) {
          userSiteGroups.add(group);
        }
      }
    }
 else {
      for (      Group group : userBag.getUserOrgGroups()) {
        if (group.isActive() && (group.hasPrivateLayouts() || group.hasPublicLayouts())) {
          userSiteGroups.add(group);
        }
      }
    }
  }
  return Collections.unmodifiableList(ListUtil.subList(ListUtil.unique(userSiteGroups),0,max));
}
