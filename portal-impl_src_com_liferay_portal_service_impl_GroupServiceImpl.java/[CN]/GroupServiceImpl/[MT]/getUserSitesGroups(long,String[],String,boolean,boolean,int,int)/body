{
  User user=userPersistence.fetchByPrimaryKey(userId);
  if (user.isDefaultUser()) {
    return Collections.emptyList();
  }
  List<Group> userSiteGroups=new UniqueList<Group>();
  if ((classNames == null) || ArrayUtil.contains(classNames,Group.class.getName())) {
    LinkedHashMap<String,Object> groupParams=new LinkedHashMap<String,Object>();
    groupParams.put("active",active);
    groupParams.put("usersGroups",new Long(userId));
    userSiteGroups.addAll(groupLocalService.search(user.getCompanyId(),name,groupParams,start,end));
  }
  if ((classNames == null) || ArrayUtil.contains(classNames,Organization.class.getName())) {
    List<Organization> userOrgs=organizationLocalService.getOrganizations(userId,start,end,null);
    for (    Organization organization : userOrgs) {
      if (!organization.hasPrivateLayouts() && !organization.hasPublicLayouts()) {
        userSiteGroups.remove(organization.getGroup());
      }
 else {
        userSiteGroups.add(0,organization.getGroup());
      }
      if (!PropsValues.ORGANIZATIONS_MEMBERSHIP_STRICT) {
        for (        Organization ancestorOrganization : organization.getAncestors()) {
          if (!organization.hasPrivateLayouts() && !organization.hasPublicLayouts()) {
            continue;
          }
          userSiteGroups.add(0,ancestorOrganization.getGroup());
        }
      }
    }
  }
  if ((classNames == null) || ArrayUtil.contains(classNames,User.class.getName())) {
    if (PropsValues.LAYOUT_USER_PRIVATE_LAYOUTS_ENABLED || PropsValues.LAYOUT_USER_PUBLIC_LAYOUTS_ENABLED) {
      Group userGroup=user.getGroup();
      userSiteGroups.add(0,userGroup);
    }
  }
  PermissionChecker permissionChecker=getPermissionChecker();
  if (permissionChecker.getUserId() != userId) {
    try {
      permissionChecker=PermissionCheckerFactoryUtil.create(user);
    }
 catch (    Exception e) {
      throw new PrincipalException(e);
    }
  }
  if (includeControlPanel && PortalPermissionUtil.contains(permissionChecker,ActionKeys.VIEW_CONTROL_PANEL)) {
    Group controlPanelGroup=groupLocalService.getGroup(user.getCompanyId(),GroupConstants.CONTROL_PANEL);
    userSiteGroups.add(0,controlPanelGroup);
  }
  return Collections.unmodifiableList(ListUtil.subList(userSiteGroups,start,end));
}
