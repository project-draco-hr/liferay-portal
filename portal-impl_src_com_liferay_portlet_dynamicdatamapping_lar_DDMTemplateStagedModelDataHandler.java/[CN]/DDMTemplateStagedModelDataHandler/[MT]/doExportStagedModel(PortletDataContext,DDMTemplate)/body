{
  DDMStructure structure=DDMStructureLocalServiceUtil.fetchStructure(template.getClassPK());
  if (structure != null) {
    StagedModelDataHandlerUtil.exportStagedModel(portletDataContext,structure);
  }
  Element dlFileEntryTypesElement=portletDataContext.getExportDataGroupElement(DLFileEntryType.class);
  Element dlFoldersElement=portletDataContext.getExportDataGroupElement(DLFolder.class);
  Element dlFileEntriesElement=portletDataContext.getExportDataGroupElement(DLFileEntry.class);
  Element dlFileRanksElement=portletDataContext.getExportDataGroupElement(DLFileRank.class);
  Element dlRepositoriesElement=portletDataContext.getExportDataGroupElement(Repository.class);
  Element dlRepositoryEntriesElement=portletDataContext.getExportDataGroupElement(RepositoryEntry.class);
  Element templateElement=portletDataContext.getExportDataStagedModelElement(template);
  if (template.isSmallImage()) {
    Image smallImage=ImageUtil.fetchByPrimaryKey(template.getSmallImageId());
    if (Validator.isNotNull(template.getSmallImageURL())) {
      String smallImageURL=DDMPortletDataHandler.exportReferencedContent(portletDataContext,dlFileEntryTypesElement,dlFoldersElement,dlFileEntriesElement,dlFileRanksElement,dlRepositoriesElement,dlRepositoryEntriesElement,templateElement,template.getSmallImageURL().concat(StringPool.SPACE));
      template.setSmallImageURL(smallImageURL);
    }
 else     if (smallImage != null) {
      String smallImagePath=StagedModelPathUtil.getPath(template,smallImage.getImageId() + StringPool.PERIOD + template.getSmallImageType());
      templateElement.addAttribute("small-image-path",smallImagePath);
      template.setSmallImageType(smallImage.getType());
      portletDataContext.addZipEntry(smallImagePath,smallImage.getTextObj());
    }
  }
  if (portletDataContext.getBooleanParameter(DDMPortletDataHandler.NAMESPACE,"embedded-assets")) {
    String content=DDMPortletDataHandler.exportReferencedContent(portletDataContext,dlFileEntryTypesElement,dlFoldersElement,dlFileEntriesElement,dlFileRanksElement,dlRepositoriesElement,dlRepositoryEntriesElement,templateElement,template.getScript());
    template.setScript(content);
  }
  portletDataContext.addClassedModel(templateElement,StagedModelPathUtil.getPath(template),template,DDMPortletDataHandler.NAMESPACE);
}
