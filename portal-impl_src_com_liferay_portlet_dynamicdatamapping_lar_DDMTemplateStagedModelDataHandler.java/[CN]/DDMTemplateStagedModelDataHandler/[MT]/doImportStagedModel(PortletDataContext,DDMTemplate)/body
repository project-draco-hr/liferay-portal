{
  long userId=portletDataContext.getUserId(template.getUserUuid());
  long classPK=template.getClassPK();
  if (classPK > 0) {
    StagedModelDataHandlerUtil.importReferenceStagedModel(portletDataContext,template,DDMStructure.class,classPK);
    Map<Long,Long> structureIds=(Map<Long,Long>)portletDataContext.getNewPrimaryKeysMap(DDMStructure.class);
    classPK=MapUtil.getLong(structureIds,classPK,classPK);
  }
  File smallFile=null;
  try {
    if (template.isSmallImage()) {
      Element element=portletDataContext.getImportDataStagedModelElement(template);
      String smallImagePath=element.attributeValue("small-image-path");
      if (Validator.isNotNull(template.getSmallImageURL())) {
        String smallImageURL=ExportImportHelperUtil.replaceImportContentReferences(portletDataContext,template,template.getSmallImageURL());
        template.setSmallImageURL(smallImageURL);
      }
 else       if (Validator.isNotNull(smallImagePath)) {
        byte[] bytes=portletDataContext.getZipEntryAsByteArray(smallImagePath);
        if (bytes != null) {
          smallFile=FileUtil.createTempFile(template.getSmallImageType());
          FileUtil.write(smallFile,bytes);
        }
      }
    }
    String script=ExportImportHelperUtil.replaceImportContentReferences(portletDataContext,template,template.getScript());
    template.setScript(script);
    ServiceContext serviceContext=portletDataContext.createServiceContext(template);
    DDMTemplate importedTemplate=null;
    if (portletDataContext.isDataStrategyMirror()) {
      Element element=portletDataContext.getImportDataStagedModelElement(template);
      boolean preloaded=GetterUtil.getBoolean(element.attributeValue("preloaded"));
      DDMTemplate existingTemplate=fetchExistingTemplate(template.getUuid(),portletDataContext.getScopeGroupId(),template.getClassNameId(),template.getTemplateKey(),preloaded);
      if (existingTemplate == null) {
        serviceContext.setUuid(template.getUuid());
        importedTemplate=DDMTemplateLocalServiceUtil.addTemplate(userId,portletDataContext.getScopeGroupId(),template.getClassNameId(),classPK,template.getTemplateKey(),template.getNameMap(),template.getDescriptionMap(),template.getType(),template.getMode(),template.getLanguage(),template.getScript(),template.isCacheable(),template.isSmallImage(),template.getSmallImageURL(),smallFile,serviceContext);
      }
 else {
        importedTemplate=DDMTemplateLocalServiceUtil.updateTemplate(existingTemplate.getTemplateId(),template.getClassPK(),template.getNameMap(),template.getDescriptionMap(),template.getType(),template.getMode(),template.getLanguage(),template.getScript(),template.isCacheable(),template.isSmallImage(),template.getSmallImageURL(),smallFile,serviceContext);
      }
    }
 else {
      importedTemplate=DDMTemplateLocalServiceUtil.addTemplate(userId,portletDataContext.getScopeGroupId(),template.getClassNameId(),classPK,null,template.getNameMap(),template.getDescriptionMap(),template.getType(),template.getMode(),template.getLanguage(),template.getScript(),template.isCacheable(),template.isSmallImage(),template.getSmallImageURL(),smallFile,serviceContext);
    }
    portletDataContext.importClassedModel(template,importedTemplate);
    Map<String,String> ddmTemplateKeys=(Map<String,String>)portletDataContext.getNewPrimaryKeysMap(DDMTemplate.class + ".ddmTemplateKey");
    ddmTemplateKeys.put(template.getTemplateKey(),importedTemplate.getTemplateKey());
  }
  finally {
    if (smallFile != null) {
      smallFile.delete();
    }
  }
}
