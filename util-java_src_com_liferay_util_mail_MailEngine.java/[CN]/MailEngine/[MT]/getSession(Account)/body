{
  Session session=null;
  Properties properties=null;
  String protocol=account.getProtocol();
  if (protocol.equals(_IMAP_PROTOCOL) || protocol.equals(_IMAPS_PROTOCOL)) {
    properties=_getMailProperties(account,_IMAP_PORT,_IMAPS_PORT);
  }
 else   if (protocol.equals(_POP3_PROTOCOL) || protocol.equals(_POP3S_PROTOCOL)) {
    properties=_getMailProperties(account,_POP3_PORT,_POP3S_PORT);
  }
 else   if (protocol.equals(_SMTP_PROTOCOL) || protocol.equals(_SMTPS_PROTOCOL)) {
    properties=_getMailProperties(account,_SMTP_PORT,_SMTPS_PORT);
    if (account.isRequiresAuthentication()) {
      properties.put("mail.transport.protocol",protocol);
      properties.put("mail." + protocol + ".auth","true");
      properties.put("mail." + protocol + ".user",account.getUserName());
      properties.put("mail." + protocol + ".password",account.getPassword());
    }
  }
  if (properties != null) {
    session=Session.getInstance(properties);
  }
 else {
    _log.warn("Mail protocol not recognized: " + protocol);
    session=getSession();
  }
  if (_log.isDebugEnabled()) {
    session.setDebug(true);
    session.getProperties().list(System.out);
  }
  return session;
}
