{
  Session session=null;
  if (smtpAccount.isRequiresAuthentication()) {
    String protocol=_SMTP_PROTOCOL;
    int port=_SMTP_PORT;
    if (smtpAccount.isUseSSL()) {
      protocol=_SMTPS_PROTOCOL;
      port=_SMTPS_PORT;
    }
    if (smtpAccount.getServerPort() > 0) {
      port=smtpAccount.getServerPort();
    }
    Properties properties=new Properties();
    properties.put("mail.transport.protocol",protocol);
    properties.put("mail." + protocol + ".auth","true");
    properties.put("mail." + protocol + ".host",smtpAccount.getServerName());
    properties.put("mail." + protocol + ".port",port);
    properties.put("mail." + protocol + ".user",smtpAccount.getUserName());
    properties.put("mail." + protocol + ".password",smtpAccount.getPassword());
    properties.put("mail." + protocol + ".socketFactory.class","javax.net.ssl.SSLSocketFactory");
    properties.put("mail." + protocol + ".socketFactory.fallback","false");
    session=Session.getInstance(properties);
  }
 else {
    session=getSession();
  }
  if (_log.isDebugEnabled()) {
    session.setDebug(true);
    session.getProperties().list(System.out);
  }
  return session;
}
