{
  long start=0;
  if (_log.isDebugEnabled()) {
    start=System.currentTimeMillis();
    _log.debug("From: " + from);
    _log.debug("To: " + to);
    _log.debug("CC: " + cc);
    _log.debug("BCC: " + bcc);
    _log.debug("Subject: " + subject);
    _log.debug("Body: " + body);
    _log.debug("HTML Format: " + htmlFormat);
    _log.debug("Reply to: " + replyTo);
    _log.debug("Message ID: " + messageId);
    _log.debug("In Reply To: " + inReplyTo);
  }
  try {
    Session session=getSession();
    Message msg=new LiferayMimeMessage(session);
    msg.setFrom(from);
    msg.setRecipients(Message.RecipientType.TO,to);
    if (cc != null) {
      msg.setRecipients(Message.RecipientType.CC,cc);
    }
    if (bcc != null) {
      msg.setRecipients(Message.RecipientType.BCC,bcc);
    }
    msg.setSubject(subject);
    if (htmlFormat) {
      msg.setContent(body,_TEXT_HTML);
    }
 else {
      msg.setContent(body,_TEXT_PLAIN);
    }
    msg.setSentDate(new Date());
    if (replyTo != null) {
      msg.setReplyTo(replyTo);
    }
    if (messageId != null) {
      msg.setHeader("Message-ID",messageId);
    }
    if (inReplyTo != null) {
      msg.setHeader("In-Reply-To",inReplyTo);
    }
    _send(session,msg);
  }
 catch (  SendFailedException sfe) {
    _log.error(sfe);
  }
catch (  Exception e) {
    throw new MailEngineException(e);
  }
  if (_log.isDebugEnabled()) {
    long end=System.currentTimeMillis();
    _log.debug("Sending mail takes " + (end - start) + " ms");
  }
}
