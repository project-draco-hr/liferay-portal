{
  StopWatch stopWatch=null;
  if (_log.isDebugEnabled()) {
    stopWatch=new StopWatch();
    stopWatch.start();
    _log.debug("From: " + from);
    _log.debug("To: " + to);
    _log.debug("CC: " + cc);
    _log.debug("BCC: " + bcc);
    _log.debug("List Addresses: " + bulkAddresses);
    _log.debug("Subject: " + subject);
    _log.debug("Body: " + body);
    _log.debug("HTML Format: " + htmlFormat);
    _log.debug("Reply to: " + replyTo);
    _log.debug("Message ID: " + messageId);
    _log.debug("In Reply To: " + inReplyTo);
    if (attachments != null) {
      for (int i=0; i < attachments.length; i++) {
        File attachment=attachments[i];
        if (attachment != null) {
          String path=attachment.getAbsolutePath();
          _log.debug("Attachment #" + (i + 1) + ": "+ path);
        }
      }
    }
  }
  try {
    Session session=null;
    if (smtpAccount == null) {
      session=getSession();
    }
 else {
      session=getSession(smtpAccount);
    }
    Message msg=new LiferayMimeMessage(session);
    msg.setFrom(from);
    msg.setRecipients(Message.RecipientType.TO,to);
    if (cc != null) {
      msg.setRecipients(Message.RecipientType.CC,cc);
    }
    if (bcc != null) {
      msg.setRecipients(Message.RecipientType.BCC,bcc);
    }
    msg.setSubject(subject);
    if ((attachments != null) && (attachments.length > 0)) {
      MimeMultipart rootMultipart=new MimeMultipart(_MULTIPART_TYPE_MIXED);
      MimeMultipart messageMultipart=new MimeMultipart(_MULTIPART_TYPE_ALTERNATIVE);
      MimeBodyPart messageBodyPart=new MimeBodyPart();
      messageBodyPart.setContent(messageMultipart);
      rootMultipart.addBodyPart(messageBodyPart);
      if (htmlFormat) {
        MimeBodyPart bodyPart=new MimeBodyPart();
        bodyPart.setContent(body,_TEXT_HTML);
        messageMultipart.addBodyPart(bodyPart);
      }
 else {
        MimeBodyPart bodyPart=new MimeBodyPart();
        bodyPart.setText(body);
        messageMultipart.addBodyPart(bodyPart);
      }
      for (int i=0; i < attachments.length; i++) {
        File attachment=attachments[i];
        if (attachment != null) {
          MimeBodyPart bodyPart=new MimeBodyPart();
          DataSource source=new FileDataSource(attachment);
          bodyPart.setDisposition(Part.ATTACHMENT);
          bodyPart.setDataHandler(new DataHandler(source));
          bodyPart.setFileName(attachment.getName());
          rootMultipart.addBodyPart(bodyPart);
        }
      }
      msg.setContent(rootMultipart);
      msg.saveChanges();
    }
 else {
      if (htmlFormat) {
        msg.setContent(body,_TEXT_HTML);
      }
 else {
        msg.setContent(body,_TEXT_PLAIN);
      }
    }
    msg.setSentDate(new Date());
    if (replyTo != null) {
      msg.setReplyTo(replyTo);
    }
    if (messageId != null) {
      msg.setHeader("Message-ID",messageId);
    }
    if (inReplyTo != null) {
      msg.setHeader("In-Reply-To",inReplyTo);
      msg.setHeader("References",inReplyTo);
    }
    _send(session,msg,bulkAddresses);
  }
 catch (  SendFailedException sfe) {
    _log.error(sfe);
  }
catch (  Exception e) {
    throw new MailEngineException(e);
  }
  if (_log.isDebugEnabled()) {
    _log.debug("Sending mail takes " + stopWatch.getTime() + " ms");
  }
}
