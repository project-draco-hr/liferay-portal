{
  long plid=ParamUtil.getLong(request,"p_l_id");
  if (plid <= 0) {
    return;
  }
  ThemeDisplay themeDisplay=(ThemeDisplay)request.getAttribute(WebKeys.THEME_DISPLAY);
  long companyId=PortalUtil.getCompanyId(request);
  long userId=themeDisplay.getRealUserId();
  long impersonatedUserId=themeDisplay.getUserId();
  String impersonatedUserName=PortalUtil.getUserName(impersonatedUserId,StringPool.BLANK);
  String doAsUserId=themeDisplay.getDoAsUserId();
  String userName=PortalUtil.getUserName(userId,StringPool.BLANK);
  String clientIP=request.getRemoteAddr();
  String serverIP=request.getServerName();
  HttpSession session=request.getSession();
  String sessionID=session.getId();
  if (doAsUserId != null && userId != impersonatedUserId) {
    if (session.getAttribute(_IMPERSONATING_FLAG) == null) {
      session.setAttribute(_IMPERSONATING_FLAG,StringPool.TRUE);
      try {
        JSONObject additionalInfo=new JSONObject();
        additionalInfo.put("userId",impersonatedUserId);
        additionalInfo.put("userName",impersonatedUserName);
        AuditMessage message=new AuditMessage(companyId,userId,userName,String.valueOf(impersonatedUserId),User.class.getName(),"impersonate",sessionID,clientIP,serverIP,additionalInfo);
        AuditMessageSenderUtil.send(message);
      }
 catch (      JSONException e) {
        throw new ActionException(e);
      }
    }
  }
 else   if (session.getAttribute(_IMPERSONATING_FLAG) != null) {
    session.removeAttribute(_IMPERSONATING_FLAG);
    if (_log.isDebugEnabled()) {
      _log.debug("Impersonalization ended");
    }
  }
}
