{
  StringBundler sb=new StringBundler(11);
  sb.append("select sysobjects.name as table_name, syscolumns.name AS ");
  sb.append("column_name, systypes.name as data_type, ");
  sb.append("syscolumns.length, syscolumns.isnullable as is_nullable ");
  sb.append("FROM sysobjects inner join syscolumns on sysobjects.id = ");
  sb.append("syscolumns.id inner join systypes on syscolumns.xtype = ");
  sb.append("systypes.xtype where (sysobjects.xtype = 'U') and ");
  sb.append("(sysobjects.category != 2) and ");
  sb.append(_FILTER_NONUNICODE_DATA_TYPES);
  sb.append(" and ");
  sb.append(_FILTER_EXCLUDED_TABLES);
  sb.append(" order by sysobjects.name, syscolumns.colid");
  String sql=sb.toString();
  try (Connection con=DataAccess.getUpgradeOptimizedConnection();PreparedStatement ps=con.prepareStatement(sql);ResultSet rs=ps.executeQuery()){
    dropNonunicodeTableIndexes(con);
    while (rs.next()) {
      String tableName=rs.getString("table_name");
      if (!isPortalTableName(tableName)) {
        continue;
      }
      String columnName=rs.getString("column_name");
      String dataType=rs.getString("data_type");
      int length=rs.getInt("length");
      boolean nullable=rs.getBoolean("is_nullable");
      if (dataType.equals("varchar")) {
        convertVarcharColumn(con,tableName,columnName,length,nullable);
      }
 else       if (dataType.equals("ntext") || dataType.equals("text")) {
        convertTextColumn(con,tableName,columnName,nullable);
      }
    }
    for (    String addPrimaryKeySQL : _addPrimaryKeySQLs) {
      runSQL(con,addPrimaryKeySQL);
    }
  }
 catch (  Exception e) {
    _log.error(e,e);
  }
}
