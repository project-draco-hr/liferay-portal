{
  HttpServletRequest request=(HttpServletRequest)pageContext.getRequest();
  ThemeDisplay themeDisplay=(ThemeDisplay)request.getAttribute(WebKeys.THEME_DISPLAY);
  if (Validator.isNull(resourceGroupId)) {
    resourceGroupId=String.valueOf(themeDisplay.getScopeGroupId());
  }
  PortletDisplay portletDisplay=themeDisplay.getPortletDisplay();
  Layout layout=themeDisplay.getLayout();
  if (Validator.isNull(redirect) && (Validator.isNull(windowState) || !windowState.equals(LiferayWindowState.POP_UP.toString()))) {
    redirect=PortalUtil.getCurrentURL(request);
  }
  PortletURL portletURL=PortletURLFactoryUtil.create(request,PortletKeys.PORTLET_CONFIGURATION,layout.getPlid(),PortletRequest.RENDER_PHASE);
  if (Validator.isNotNull(windowState)) {
    portletURL.setWindowState(WindowStateFactory.getWindowState(windowState));
  }
 else   if (themeDisplay.isStatePopUp()) {
    portletURL.setWindowState(LiferayWindowState.POP_UP);
  }
 else {
    portletURL.setWindowState(WindowState.MAXIMIZED);
  }
  portletURL.setParameter("struts_action","/portlet_configuration/edit_permissions");
  if (Validator.isNotNull(redirect)) {
    portletURL.setParameter("redirect",redirect);
    if (!themeDisplay.isStateMaximized()) {
      portletURL.setParameter("returnToFullPageURL",redirect);
    }
  }
  portletURL.setParameter("portletResource",portletDisplay.getId());
  portletURL.setParameter("modelResource",modelResource);
  portletURL.setParameter("modelResourceDescription",modelResourceDescription);
  portletURL.setParameter("resourceGroupId",resourceGroupId);
  portletURL.setParameter("resourcePrimKey",resourcePrimKey);
  if (roleTypes != null) {
    portletURL.setParameter("roleTypes",StringUtil.merge(roleTypes));
  }
  String portletURLToString=portletURL.toString();
  if (Validator.isNotNull(var)) {
    pageContext.setAttribute(var,portletURLToString);
  }
 else {
    JspWriter jspWriter=pageContext.getOut();
    jspWriter.write(portletURLToString);
  }
}
