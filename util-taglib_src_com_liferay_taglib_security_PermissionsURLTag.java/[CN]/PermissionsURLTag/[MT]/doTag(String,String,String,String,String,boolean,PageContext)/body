{
  HttpServletRequest request=(HttpServletRequest)pageContext.getRequest();
  ThemeDisplay themeDisplay=(ThemeDisplay)request.getAttribute(WebKeys.THEME_DISPLAY);
  PortletDisplay portletDisplay=themeDisplay.getPortletDisplay();
  Layout layout=themeDisplay.getLayout();
  if (Validator.isNull(redirect)) {
    redirect=PortalUtil.getCurrentURL(request);
  }
  PortletURL portletURL=PortletURLFactoryUtil.create(request,PortletKeys.PORTLET_CONFIGURATION,layout.getPlid(),PortletRequest.RENDER_PHASE);
  if (themeDisplay.isStatePopUp()) {
    portletURL.setWindowState(LiferayWindowState.POP_UP);
  }
 else {
    portletURL.setWindowState(WindowState.MAXIMIZED);
  }
  portletURL.setParameter("struts_action","/portlet_configuration/edit_permissions");
  portletURL.setParameter("redirect",redirect);
  if (!themeDisplay.isStateMaximized()) {
    portletURL.setParameter("returnToFullPageURL",redirect);
  }
  portletURL.setParameter("portletResource",portletDisplay.getId());
  portletURL.setParameter("modelResource",modelResource);
  portletURL.setParameter("modelResourceDescription",modelResourceDescription);
  portletURL.setParameter("resourcePrimKey",resourcePrimKey);
  String portletURLToString=portletURL.toString();
  if (Validator.isNotNull(var)) {
    pageContext.setAttribute(var,portletURLToString);
  }
 else   if (writeOutput) {
    pageContext.getOut().print(portletURLToString);
  }
  return portletURL.toString();
}
