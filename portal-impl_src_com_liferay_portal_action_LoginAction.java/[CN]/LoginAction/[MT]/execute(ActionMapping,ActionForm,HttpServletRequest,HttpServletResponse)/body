{
  HttpSession session=request.getSession();
  ThemeDisplay themeDisplay=(ThemeDisplay)request.getAttribute(WebKeys.THEME_DISPLAY);
  if (session.getAttribute("j_username") != null && session.getAttribute("j_password") != null) {
    if (PropsValues.PORTAL_JAAS_ENABLE) {
      return mapping.findForward("/portal/touch_protected.jsp");
    }
 else {
      response.sendRedirect(themeDisplay.getPathMain());
      return null;
    }
  }
  String redirect=PortalUtil.getCommunityLoginURL(themeDisplay);
  if (Validator.isNull(redirect)) {
    redirect=PropsValues.AUTH_LOGIN_URL;
  }
  if (Validator.isNull(redirect)) {
    PortletURL portletURL=new PortletURLImpl(request,PortletKeys.LOGIN,themeDisplay.getPlid(),PortletRequest.RENDER_PHASE);
    portletURL.setWindowState(WindowState.MAXIMIZED);
    portletURL.setPortletMode(PortletMode.VIEW);
    portletURL.setParameter("saveLastPath","0");
    portletURL.setParameter("struts_action","/login/login");
    redirect=portletURL.toString();
  }
  if (PropsValues.COMPANY_SECURITY_AUTH_REQUIRES_HTTPS) {
    redirect=HttpUtil.protocolize(redirect,true);
  }
  String loginRedirect=ParamUtil.getString(request,"redirect");
  if (Validator.isNotNull(loginRedirect)) {
    String loginPortletNamespace=PortalUtil.getPortletNamespace(PropsValues.AUTH_LOGIN_PORTLET_NAME);
    String loginRedirectParameter=loginPortletNamespace + "redirect";
    redirect=HttpUtil.setParameter(redirect,"p_p_id",PropsValues.AUTH_LOGIN_PORTLET_NAME);
    redirect=HttpUtil.setParameter(redirect,"p_p_lifecycle","0");
    redirect=HttpUtil.setParameter(redirect,loginRedirectParameter,loginRedirect);
  }
  response.sendRedirect(redirect);
  return null;
}
