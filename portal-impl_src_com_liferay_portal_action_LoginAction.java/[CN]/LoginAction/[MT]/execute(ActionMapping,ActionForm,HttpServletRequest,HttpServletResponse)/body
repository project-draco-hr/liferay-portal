{
  ThemeDisplay themeDisplay=(ThemeDisplay)request.getAttribute(WebKeys.THEME_DISPLAY);
  String login=ParamUtil.getString(request,"login");
  String password=request.getParameter("password");
  boolean rememberMe=ParamUtil.getBoolean(request,"rememberMe");
  String authType=ParamUtil.getString(request,"authType");
  if (Validator.isNotNull(login) && Validator.isNotNull(password)) {
    LoginUtil.login(request,response,login,password,rememberMe,authType);
  }
  HttpSession session=request.getSession();
  if ((session.getAttribute("j_username") != null) && (session.getAttribute("j_password") != null)) {
    if (PropsValues.PORTAL_JAAS_ENABLE) {
      return mapping.findForward("/portal/touch_protected.jsp");
    }
 else {
      response.sendRedirect(themeDisplay.getPathMain());
      return null;
    }
  }
  String redirect=PortalUtil.getCommunityLoginURL(themeDisplay);
  if (Validator.isNull(redirect)) {
    redirect=PropsValues.AUTH_LOGIN_URL;
  }
  if (Validator.isNull(redirect)) {
    PortletURL portletURL=PortletURLFactoryUtil.create(request,PortletKeys.LOGIN,themeDisplay.getPlid(),PortletRequest.RENDER_PHASE);
    portletURL.setWindowState(getWindowState(request));
    portletURL.setPortletMode(PortletMode.VIEW);
    portletURL.setParameter("saveLastPath","0");
    portletURL.setParameter("struts_action","/login/login");
    redirect=portletURL.toString();
  }
  if (PropsValues.COMPANY_SECURITY_AUTH_REQUIRES_HTTPS) {
    String portalURL=PortalUtil.getPortalURL(request);
    String portalURLSecure=PortalUtil.getPortalURL(request,true);
    if (!portalURL.equals(portalURLSecure)) {
      redirect=StringUtil.replaceFirst(redirect,portalURL,portalURLSecure);
    }
  }
  String loginRedirect=ParamUtil.getString(request,"redirect");
  if (Validator.isNotNull(loginRedirect)) {
    if (PrefsPropsUtil.getBoolean(themeDisplay.getCompanyId(),PropsKeys.CAS_AUTH_ENABLED,PropsValues.CAS_AUTH_ENABLED)) {
      redirect=loginRedirect;
    }
 else {
      String loginPortletNamespace=PortalUtil.getPortletNamespace(PropsValues.AUTH_LOGIN_PORTLET_NAME);
      String loginRedirectParameter=loginPortletNamespace + "redirect";
      redirect=HttpUtil.setParameter(redirect,"p_p_id",PropsValues.AUTH_LOGIN_PORTLET_NAME);
      redirect=HttpUtil.setParameter(redirect,"p_p_lifecycle","0");
      redirect=HttpUtil.setParameter(redirect,loginRedirectParameter,loginRedirect);
    }
  }
  response.sendRedirect(redirect);
  return null;
}
