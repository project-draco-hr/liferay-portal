{
  if (PropsValues.COMPANY_SECURITY_AUTH_REQUIRES_HTTPS && !req.isSecure()) {
    ThemeDisplay themeDisplay=(ThemeDisplay)req.getAttribute(WebKeys.THEME_DISPLAY);
    StringBuilder sb=new StringBuilder();
    sb.append(PortalUtil.getPortalURL(req,true));
    sb.append(themeDisplay.getURLSignIn());
    res.sendRedirect(sb.toString());
    return null;
  }
  HttpSession ses=req.getSession();
  ThemeDisplay themeDisplay=(ThemeDisplay)req.getAttribute(WebKeys.THEME_DISPLAY);
  if (ses.getAttribute("j_username") != null && ses.getAttribute("j_password") != null) {
    if (PropsValues.PORTAL_JAAS_ENABLE) {
      return mapping.findForward("/portal/touch_protected.jsp");
    }
 else {
      res.sendRedirect(themeDisplay.getPathMain());
      return null;
    }
  }
  String cmd=ParamUtil.getString(req,Constants.CMD);
  if (cmd.equals("already-registered")) {
    try {
      login(req,res);
      if (PropsValues.PORTAL_JAAS_ENABLE) {
        return mapping.findForward("/portal/touch_protected.jsp");
      }
 else {
        String redirect=ParamUtil.getString(req,"redirect");
        if (Validator.isNotNull(redirect)) {
          res.sendRedirect(redirect);
        }
 else {
          res.sendRedirect(themeDisplay.getPathMain());
        }
        return null;
      }
    }
 catch (    Exception e) {
      if (e instanceof AuthException) {
        Throwable cause=e.getCause();
        if (cause instanceof PasswordExpiredException || cause instanceof UserLockoutException) {
          SessionErrors.add(req,cause.getClass().getName());
        }
 else {
          SessionErrors.add(req,e.getClass().getName());
        }
        return mapping.findForward("portal.login");
      }
 else       if (e instanceof CookieNotSupportedException || e instanceof NoSuchUserException || e instanceof PasswordExpiredException|| e instanceof UserEmailAddressException|| e instanceof UserIdException|| e instanceof UserLockoutException|| e instanceof UserPasswordException|| e instanceof UserScreenNameException) {
        SessionErrors.add(req,e.getClass().getName());
        return mapping.findForward("portal.login");
      }
 else {
        PortalUtil.sendError(e,req,res);
        return null;
      }
    }
  }
 else   if (cmd.equals("forgot-password")) {
    try {
      sendPassword(req);
      return mapping.findForward("portal.login");
    }
 catch (    Exception e) {
      if (e instanceof CaptchaTextException || e instanceof NoSuchUserException || e instanceof SendPasswordException|| e instanceof UserEmailAddressException) {
        SessionErrors.add(req,e.getClass().getName());
        return mapping.findForward("portal.login");
      }
 else {
        PortalUtil.sendError(e,req,res);
        return null;
      }
    }
  }
 else {
    String authLoginURL=PortalUtil.getCommunityLoginURL(themeDisplay);
    if (Validator.isNull(authLoginURL)) {
      authLoginURL=PropsValues.AUTH_LOGIN_URL;
    }
    if (Validator.isNotNull(authLoginURL)) {
      res.sendRedirect(authLoginURL);
      return null;
    }
 else {
      return mapping.findForward("portal.login");
    }
  }
}
