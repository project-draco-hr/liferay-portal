{
  HttpSession ses=req.getSession();
  ThemeDisplay themeDisplay=(ThemeDisplay)req.getAttribute(WebKeys.THEME_DISPLAY);
  if (ses.getAttribute("j_username") != null && ses.getAttribute("j_password") != null) {
    if (GetterUtil.getBoolean(PropsUtil.get(PropsUtil.PORTAL_JAAS_ENABLE))) {
      return mapping.findForward("/portal/touch_protected.jsp");
    }
 else {
      res.sendRedirect(themeDisplay.getPathMain());
      return null;
    }
  }
  String cmd=ParamUtil.getString(req,Constants.CMD);
  if (cmd.equals("already-registered")) {
    try {
      login(req,res);
      if (GetterUtil.getBoolean(PropsUtil.get(PropsUtil.PORTAL_JAAS_ENABLE))) {
        return mapping.findForward("/portal/touch_protected.jsp");
      }
 else {
        res.sendRedirect(themeDisplay.getPathMain());
        return null;
      }
    }
 catch (    Exception e) {
      if (e instanceof AuthException || e instanceof CookieNotSupportedException || e instanceof NoSuchUserException|| e instanceof UserEmailAddressException|| e instanceof UserIdException|| e instanceof UserLockoutException|| e instanceof UserPasswordException|| e instanceof UserScreenNameException) {
        SessionErrors.add(req,e.getClass().getName());
        return mapping.findForward("portal.login");
      }
 else {
        req.setAttribute(PageContext.EXCEPTION,e);
        return mapping.findForward(Constants.COMMON_ERROR);
      }
    }
  }
 else   if (cmd.equals("forgot-password")) {
    try {
      sendPassword(req);
      return mapping.findForward("portal.login");
    }
 catch (    Exception e) {
      if (e instanceof NoSuchUserException || e instanceof SendPasswordException || e instanceof UserEmailAddressException) {
        SessionErrors.add(req,e.getClass().getName());
        return mapping.findForward("portal.login");
      }
 else {
        req.setAttribute(PageContext.EXCEPTION,e);
        return mapping.findForward(Constants.COMMON_ERROR);
      }
    }
  }
 else {
    return mapping.findForward("portal.login");
  }
}
