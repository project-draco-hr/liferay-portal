{
  ThemeDisplay themeDisplay=(ThemeDisplay)request.getAttribute(WebKeys.THEME_DISPLAY);
  Company company=themeDisplay.getCompany();
  String emailAddress=ParamUtil.getString(request,"emailAddress");
  if (!company.isSendPassword()) {
    return;
  }
  if (PropsValues.USERS_REMINDER_QUERIES_ENABLED) {
    User user=UserLocalServiceUtil.getUserByEmailAddress(PortalUtil.getCompanyId(request),emailAddress);
    String realAnswer=user.getReminderQueryAnswer();
    String userAnswer=ParamUtil.getString(request,"reminderQueryAnswer");
    if (!Validator.equals(realAnswer.toLowerCase(),userAnswer.toLowerCase())) {
      throw new UserReminderQueryException("Invalid reminder query answer");
    }
  }
 else {
    if (PropsValues.CAPTCHA_CHECK_PORTAL_SEND_PASSWORD) {
      CaptchaUtil.check(request);
    }
  }
  String remoteAddr=request.getRemoteAddr();
  String remoteHost=request.getRemoteHost();
  String userAgent=request.getHeader(HttpHeaders.USER_AGENT);
  UserLocalServiceUtil.sendPassword(PortalUtil.getCompanyId(request),emailAddress,remoteAddr,remoteHost,userAgent);
  SessionMessages.add(request,"request_processed",emailAddress);
}
