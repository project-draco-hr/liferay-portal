{
  long userId=PortalUtil.getUserId(request);
  String remoteUser=request.getRemoteUser();
  String userPrincipalStrategy=portlet.getUserPrincipalStrategy();
  if (userPrincipalStrategy.equals(PortletConstants.USER_PRINCIPAL_STRATEGY_SCREEN_NAME)) {
    try {
      User user=PortalUtil.getUser(request);
      _remoteUser=user.getScreenName();
      _remoteUserId=user.getUserId();
      _userPrincipal=new ProtectedPrincipal(_remoteUser);
    }
 catch (    Exception e) {
      _log.error(e);
    }
  }
 else {
    if ((userId > 0) && (remoteUser == null)) {
      _remoteUser=String.valueOf(userId);
      _remoteUserId=userId;
      _userPrincipal=new ProtectedPrincipal(_remoteUser);
    }
 else {
      _remoteUser=remoteUser;
      _remoteUserId=GetterUtil.getLong(remoteUser);
      _userPrincipal=request.getUserPrincipal();
    }
  }
}
