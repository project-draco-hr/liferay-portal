{
  PortletException portletException=(PortletException)req.getAttribute(_portletId + PortletException.class.getName());
  if (portletException != null) {
    throw portletException;
  }
  StopWatch stopWatch=null;
  if (_log.isDebugEnabled()) {
    stopWatch=new StopWatch();
    stopWatch.start();
  }
  String remoteUser=req.getRemoteUser();
  if ((remoteUser == null) || (getExpCache() == null) || (getExpCache().intValue() == 0)) {
    String title=invokeRender(req,res);
  }
 else {
    RenderResponseImpl resImpl=(RenderResponseImpl)res;
    PortletSession ses=req.getPortletSession();
    long now=System.currentTimeMillis();
    Layout layout=(Layout)req.getAttribute(WebKeys.LAYOUT);
    Map<String,InvokerPortletResponse> sesResponses=getResponses(ses);
    String sesResponseId=encodeResponseKey(layout.getPlid(),_portletId,LanguageUtil.getLanguageId(req));
    InvokerPortletResponse response=sesResponses.get(sesResponseId);
    if (response == null) {
      String title=invokeRender(req,res);
      StringServletResponse stringServletRes=(StringServletResponse)resImpl.getHttpServletResponse();
      response=new InvokerPortletResponse(title,stringServletRes.getString(),now + Time.SECOND * getExpCache().intValue());
      sesResponses.put(sesResponseId,response);
    }
 else     if ((response.getTime() < now) && (getExpCache().intValue() > 0)) {
      String title=invokeRender(req,res);
      StringServletResponse stringServletRes=(StringServletResponse)resImpl.getHttpServletResponse();
      response.setTitle(title);
      response.setContent(stringServletRes.getString());
      response.setTime(now + Time.SECOND * getExpCache().intValue());
    }
 else {
      resImpl.setTitle(response.getTitle());
      StringServletResponse stringServletRes=(StringServletResponse)resImpl.getHttpServletResponse();
      stringServletRes.getWriter().print(response.getContent());
    }
  }
  if (_log.isDebugEnabled()) {
    _log.debug("render for " + _portletId + " takes "+ stopWatch.getTime()+ " ms");
  }
}
