{
  long sourceVersionId=ParamUtil.getLong(renderRequest,"sourceVersionId");
  long targetVersionId=ParamUtil.getLong(renderRequest,"targetVersionId");
  FileVersion sourceFileVersion=DLAppServiceUtil.getFileVersion(sourceVersionId);
  InputStream sourceIs=sourceFileVersion.getContentStream(false);
  String sourceExtension=sourceFileVersion.getExtension();
  if (sourceExtension.equals("css") || sourceExtension.equals("htm") || sourceExtension.equals("html")|| sourceExtension.equals("js")|| sourceExtension.equals("txt")|| sourceExtension.equals("xml")) {
    String sourceContent=HtmlUtil.escape(StringUtil.read(sourceIs));
    sourceIs=new UnsyncByteArrayInputStream(sourceContent.getBytes(StringPool.UTF8));
  }
  FileVersion targetFileVersion=DLAppLocalServiceUtil.getFileVersion(targetVersionId);
  InputStream targetIs=targetFileVersion.getContentStream(false);
  String targetExtension=targetFileVersion.getExtension();
  if (targetExtension.equals("css") || targetExtension.equals("htm") || targetExtension.equals("html")|| targetExtension.equals("js")|| targetExtension.equals("txt")|| targetExtension.equals("xml")) {
    String targetContent=HtmlUtil.escape(StringUtil.read(targetIs));
    targetIs=new UnsyncByteArrayInputStream(targetContent.getBytes(StringPool.UTF8));
  }
  String targetVersion=targetFileVersion.getVersion();
  String sourceVersion=sourceFileVersion.getVersion();
  if (DocumentConversionUtil.isEnabled()) {
    if (DocumentConversionUtil.isConvertBeforeCompare(sourceExtension)) {
      String sourceTempFileId=DLUtil.getTempFileId(sourceFileVersion.getFileEntryId(),sourceVersion);
      sourceIs=new FileInputStream(DocumentConversionUtil.convert(sourceTempFileId,sourceIs,sourceExtension,"txt"));
    }
    if (DocumentConversionUtil.isConvertBeforeCompare(targetExtension)) {
      String targetTempFileId=DLUtil.getTempFileId(targetFileVersion.getFileEntryId(),targetVersion);
      targetIs=new FileInputStream(DocumentConversionUtil.convert(targetTempFileId,targetIs,targetExtension,"txt"));
    }
  }
  List<DiffResult>[] diffResults=DiffUtil.diff(new InputStreamReader(sourceIs),new InputStreamReader(targetIs));
  renderRequest.setAttribute(WebKeys.SOURCE_NAME,sourceFileVersion.getTitle() + StringPool.SPACE + sourceVersion);
  renderRequest.setAttribute(WebKeys.TARGET_NAME,targetFileVersion.getTitle() + StringPool.SPACE + targetVersion);
  renderRequest.setAttribute(WebKeys.DIFF_RESULTS,diffResults);
}
