{
  long fileEntryId=ParamUtil.getLong(renderRequest,"fileEntryId");
  String sourceVersion=ParamUtil.getString(renderRequest,"sourceVersion");
  String targetVersion=ParamUtil.getString(renderRequest,"targetVersion");
  FileEntry fileEntry=DLAppServiceUtil.getFileEntry(fileEntryId);
  FileVersion sourceFileVersion=fileEntry.getFileVersion(sourceVersion);
  InputStream sourceIs=sourceFileVersion.getContentStream(false);
  String sourceExtension=sourceFileVersion.getExtension();
  if (sourceExtension.equals("css") || sourceExtension.equals("js") || sourceExtension.equals("htm")|| sourceExtension.equals("html")|| sourceExtension.equals("txt")|| sourceExtension.equals("xml")) {
    String sourceContent=HtmlUtil.escape(StringUtil.read(sourceIs));
    sourceIs=new UnsyncByteArrayInputStream(sourceContent.getBytes(StringPool.UTF8));
  }
  FileVersion targetFileVersion=fileEntry.getFileVersion(targetVersion);
  InputStream targetIs=targetFileVersion.getContentStream(false);
  String targetExtension=targetFileVersion.getExtension();
  if (targetExtension.equals("css") || targetExtension.equals("js") || targetExtension.equals("htm")|| targetExtension.equals("html")|| targetExtension.equals("txt")|| targetExtension.equals("xml")) {
    String targetContent=HtmlUtil.escape(StringUtil.read(targetIs));
    targetIs=new UnsyncByteArrayInputStream(targetContent.getBytes(StringPool.UTF8));
  }
  if (DocumentConversionUtil.isEnabled()) {
    if (DocumentConversionUtil.isConvertBeforeCompare(sourceExtension)) {
      String sourceTempFileId=DLUtil.getTempFileId(fileEntryId,sourceVersion);
      sourceIs=new FileInputStream(DocumentConversionUtil.convert(sourceTempFileId,sourceIs,sourceExtension,"txt"));
    }
    if (DocumentConversionUtil.isConvertBeforeCompare(targetExtension)) {
      String targetTempFileId=DLUtil.getTempFileId(fileEntryId,targetVersion);
      targetIs=new FileInputStream(DocumentConversionUtil.convert(targetTempFileId,targetIs,targetExtension,"txt"));
    }
  }
  List<DiffResult>[] diffResults=DiffUtil.diff(new InputStreamReader(sourceIs),new InputStreamReader(targetIs));
  renderRequest.setAttribute(WebKeys.SOURCE_NAME,sourceFileVersion.getTitle() + StringPool.SPACE + sourceVersion);
  renderRequest.setAttribute(WebKeys.TARGET_NAME,targetFileVersion.getTitle() + StringPool.SPACE + targetVersion);
  renderRequest.setAttribute(WebKeys.DIFF_RESULTS,diffResults);
}
