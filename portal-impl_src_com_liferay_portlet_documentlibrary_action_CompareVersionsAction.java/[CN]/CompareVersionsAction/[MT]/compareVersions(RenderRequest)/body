{
  ThemeDisplay themeDisplay=(ThemeDisplay)renderRequest.getAttribute(WebKeys.THEME_DISPLAY);
  long companyId=themeDisplay.getCompanyId();
  long userId=themeDisplay.getUserId();
  long fileEntryId=ParamUtil.getLong(renderRequest,"fileEntryId");
  long groupId=themeDisplay.getScopeGroupId();
  long folderId=ParamUtil.getLong(renderRequest,"folderId");
  String name=ParamUtil.getString(renderRequest,"name");
  DLFileEntryPermission.check(themeDisplay.getPermissionChecker(),groupId,folderId,name,ActionKeys.VIEW);
  String extension=FileUtil.getExtension(name);
  String titleWithExtension=ParamUtil.getString(renderRequest,"titleWithExtension");
  double sourceVersion=ParamUtil.getDouble(renderRequest,"sourceVersion");
  double targetVersion=ParamUtil.getDouble(renderRequest,"targetVersion");
  InputStream sourceIs=DLFileEntryLocalServiceUtil.getFileAsStream(companyId,userId,groupId,folderId,name,sourceVersion);
  InputStream targetIs=DLFileEntryLocalServiceUtil.getFileAsStream(companyId,userId,groupId,folderId,name,targetVersion);
  if (extension.equals("htm") || extension.equals("html") || extension.equals("xml")) {
    String escapedSource=HtmlUtil.escape(StringUtil.read(sourceIs));
    String escapedTarget=HtmlUtil.escape(StringUtil.read(targetIs));
    sourceIs=new UnsyncByteArrayInputStream(escapedSource.getBytes(StringPool.UTF8));
    targetIs=new UnsyncByteArrayInputStream(escapedTarget.getBytes(StringPool.UTF8));
  }
  if (PrefsPropsUtil.getBoolean(PropsKeys.OPENOFFICE_SERVER_ENABLED,PropsValues.OPENOFFICE_SERVER_ENABLED) && isConvertBeforeCompare(extension)) {
    String sourceTempFileId=DocumentConversionUtil.getTempFileId(fileEntryId,sourceVersion);
    String targetTempFileId=DocumentConversionUtil.getTempFileId(fileEntryId,targetVersion);
    sourceIs=DocumentConversionUtil.convert(sourceTempFileId,sourceIs,extension,"txt");
    targetIs=DocumentConversionUtil.convert(targetTempFileId,targetIs,extension,"txt");
  }
  List<DiffResult>[] diffResults=DiffUtil.diff(new InputStreamReader(sourceIs),new InputStreamReader(targetIs));
  renderRequest.setAttribute(WebKeys.SOURCE_NAME,titleWithExtension + StringPool.SPACE + sourceVersion);
  renderRequest.setAttribute(WebKeys.TARGET_NAME,titleWithExtension + StringPool.SPACE + targetVersion);
  renderRequest.setAttribute(WebKeys.DIFF_RESULTS,diffResults);
}
