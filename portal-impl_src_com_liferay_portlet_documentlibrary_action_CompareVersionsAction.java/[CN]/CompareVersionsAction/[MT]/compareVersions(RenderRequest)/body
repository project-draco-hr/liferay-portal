{
  long fileEntryId=ParamUtil.getLong(renderRequest,"fileEntryId");
  String sourceVersion=ParamUtil.getString(renderRequest,"sourceVersion");
  String targetVersion=ParamUtil.getString(renderRequest,"targetVersion");
  FileEntry fileEntry=DLAppServiceUtil.getFileEntry(fileEntryId);
  FileVersion sourceFileVersion=fileEntry.getFileVersion(sourceVersion);
  String sourceExtension=sourceFileVersion.getExtension();
  String sourceTitle=sourceFileVersion.getTitle();
  FileVersion targetFileVersion=fileEntry.getFileVersion(targetVersion);
  String targetExtension=targetFileVersion.getExtension();
  String targetTitle=targetFileVersion.getTitle();
  InputStream sourceIs=fileEntry.getContentStream(sourceVersion);
  InputStream targetIs=fileEntry.getContentStream(targetVersion);
  if (sourceExtension.equals("htm") || sourceExtension.equals("html") || sourceExtension.equals("xml")) {
    String escapedSource=HtmlUtil.escape(StringUtil.read(sourceIs));
    sourceIs=new UnsyncByteArrayInputStream(escapedSource.getBytes(StringPool.UTF8));
  }
  if (sourceExtension.equals("htm") || sourceExtension.equals("html") || sourceExtension.equals("xml")) {
    String escapedTarget=HtmlUtil.escape(StringUtil.read(targetIs));
    targetIs=new UnsyncByteArrayInputStream(escapedTarget.getBytes(StringPool.UTF8));
  }
  if (DocumentConversionUtil.isEnabled()) {
    if (DocumentConversionUtil.isConvertBeforeCompare(sourceExtension)) {
      String sourceTempFileId=DLUtil.getTempFileId(fileEntryId,sourceVersion);
      sourceIs=new FileInputStream(DocumentConversionUtil.convert(sourceTempFileId,sourceIs,sourceExtension,"txt"));
    }
    if (DocumentConversionUtil.isConvertBeforeCompare(targetExtension)) {
      String targetTempFileId=DLUtil.getTempFileId(fileEntryId,targetVersion);
      targetIs=new FileInputStream(DocumentConversionUtil.convert(targetTempFileId,targetIs,targetExtension,"txt"));
    }
  }
  List<DiffResult>[] diffResults=DiffUtil.diff(new InputStreamReader(sourceIs),new InputStreamReader(targetIs));
  renderRequest.setAttribute(WebKeys.SOURCE_NAME,sourceTitle + StringPool.SPACE + sourceVersion);
  renderRequest.setAttribute(WebKeys.TARGET_NAME,targetTitle + StringPool.SPACE + targetVersion);
  renderRequest.setAttribute(WebKeys.DIFF_RESULTS,diffResults);
}
