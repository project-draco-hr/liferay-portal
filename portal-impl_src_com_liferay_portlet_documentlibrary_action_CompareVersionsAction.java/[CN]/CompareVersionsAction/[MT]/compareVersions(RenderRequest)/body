{
  long fileEntryId=ParamUtil.getLong(renderRequest,"fileEntryId");
  String sourceVersion=ParamUtil.getString(renderRequest,"sourceVersion");
  String targetVersion=ParamUtil.getString(renderRequest,"targetVersion");
  FileEntry fileEntry=DLAppServiceUtil.getFileEntry(fileEntryId);
  String extension=fileEntry.getExtension();
  FileVersion sourceFileVersion=fileEntry.getFileVersion(sourceVersion);
  String sourceTitle=sourceFileVersion.getTitle();
  FileVersion targetFileVersion=fileEntry.getFileVersion(targetVersion);
  String targetTitle=targetFileVersion.getTitle();
  InputStream sourceIs=fileEntry.getContentStream(sourceVersion);
  InputStream targetIs=fileEntry.getContentStream(targetVersion);
  if (extension.equals("htm") || extension.equals("html") || extension.equals("xml")) {
    String escapedSource=HtmlUtil.escape(StringUtil.read(sourceIs));
    String escapedTarget=HtmlUtil.escape(StringUtil.read(targetIs));
    sourceIs=new UnsyncByteArrayInputStream(escapedSource.getBytes(StringPool.UTF8));
    targetIs=new UnsyncByteArrayInputStream(escapedTarget.getBytes(StringPool.UTF8));
  }
  if (DocumentConversionUtil.isEnabled() && DocumentConversionUtil.isConvertBeforeCompare(extension)) {
    String sourceTempFileId=DLUtil.getTempFileId(fileEntryId,sourceVersion);
    String targetTempFileId=DLUtil.getTempFileId(fileEntryId,targetVersion);
    sourceIs=new FileInputStream(DocumentConversionUtil.convert(sourceTempFileId,sourceIs,extension,"txt"));
    targetIs=new FileInputStream(DocumentConversionUtil.convert(targetTempFileId,targetIs,extension,"txt"));
  }
  List<DiffResult>[] diffResults=DiffUtil.diff(new InputStreamReader(sourceIs),new InputStreamReader(targetIs));
  renderRequest.setAttribute(WebKeys.SOURCE_NAME,sourceTitle + StringPool.SPACE + sourceVersion);
  renderRequest.setAttribute(WebKeys.TARGET_NAME,targetTitle + StringPool.SPACE + targetVersion);
  renderRequest.setAttribute(WebKeys.DIFF_RESULTS,diffResults);
}
