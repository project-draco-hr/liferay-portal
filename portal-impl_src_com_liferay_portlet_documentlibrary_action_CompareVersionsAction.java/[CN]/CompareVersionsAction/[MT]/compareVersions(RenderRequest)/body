{
  ThemeDisplay themeDisplay=(ThemeDisplay)req.getAttribute(WebKeys.THEME_DISPLAY);
  long companyId=themeDisplay.getCompanyId();
  long userId=themeDisplay.getUserId();
  long fileEntryId=ParamUtil.getLong(req,"fileEntryId");
  long folderId=ParamUtil.getLong(req,"folderId");
  String name=ParamUtil.getString(req,"name");
  DLFileEntryPermission.check(themeDisplay.getPermissionChecker(),folderId,name,ActionKeys.VIEW);
  String extension=FileUtil.getExtension(name);
  String titleWithExtension=ParamUtil.getString(req,"titleWithExtension");
  double sourceVersion=ParamUtil.getDouble(req,"sourceVersion");
  double targetVersion=ParamUtil.getDouble(req,"targetVersion");
  InputStream sourceIs=DLFileEntryLocalServiceUtil.getFileAsStream(companyId,userId,folderId,name,sourceVersion);
  InputStream targetIs=DLFileEntryLocalServiceUtil.getFileAsStream(companyId,userId,folderId,name,targetVersion);
  if (extension.equals("htm") || extension.equals("html") || extension.equals("xml")) {
    String escapedSource=HtmlUtil.escape(StringUtil.read(sourceIs));
    String escapedTarget=HtmlUtil.escape(StringUtil.read(targetIs));
    sourceIs=new ByteArrayInputStream(escapedSource.getBytes(StringPool.UTF8));
    targetIs=new ByteArrayInputStream(escapedTarget.getBytes(StringPool.UTF8));
  }
  if (PrefsPropsUtil.getBoolean(PropsKeys.OPENOFFICE_SERVER_ENABLED,PropsValues.OPENOFFICE_SERVER_ENABLED) && isConvertBeforeCompare(extension)) {
    String sourceTempFileId=DocumentConversionUtil.getTempFileId(fileEntryId,sourceVersion);
    String targetTempFileId=DocumentConversionUtil.getTempFileId(fileEntryId,targetVersion);
    sourceIs=DocumentConversionUtil.convert(sourceTempFileId,sourceIs,extension,"txt");
    targetIs=DocumentConversionUtil.convert(targetTempFileId,targetIs,extension,"txt");
  }
  List<DiffResult>[] diffResults=DiffUtil.diff(new InputStreamReader(sourceIs),new InputStreamReader(targetIs));
  req.setAttribute(WebKeys.SOURCE_NAME,titleWithExtension + StringPool.SPACE + sourceVersion);
  req.setAttribute(WebKeys.TARGET_NAME,titleWithExtension + StringPool.SPACE + targetVersion);
  req.setAttribute(WebKeys.DIFF_RESULTS,diffResults);
}
