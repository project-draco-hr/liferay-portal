{
  ThemeDisplay themeDisplay=(ThemeDisplay)req.getAttribute(WebKeys.THEME_DISPLAY);
  long companyId=themeDisplay.getCompanyId();
  long userId=themeDisplay.getUserId();
  long folderId=ParamUtil.getLong(req,"folderId");
  long fileEntryId=ParamUtil.getLong(req,"fileEntryId");
  String name=ParamUtil.getString(req,"name");
  DLFileEntryPermission.check(themeDisplay.getPermissionChecker(),folderId,name,ActionKeys.VIEW);
  String titleWithExtension=ParamUtil.getString(req,"titleWithExtension");
  double sourceVersion=ParamUtil.getDouble(req,"sourceVersion");
  double targetVersion=ParamUtil.getDouble(req,"targetVersion");
  InputStream sourceIs=DLFileEntryLocalServiceUtil.getFileAsStream(companyId,userId,folderId,name,sourceVersion);
  InputStream targetIs=DLFileEntryLocalServiceUtil.getFileAsStream(companyId,userId,folderId,name,targetVersion);
  if ((PrefsPropsUtil.getBoolean(PropsUtil.OPENOFFICE_SERVER_ENABLED,PropsValues.OPENOFFICE_SERVER_ENABLED)) && (_convertBeforeCompare(FileUtil.getExtension(name)))) {
    String id=DocumentConversionUtil.getTempFileId(fileEntryId,sourceVersion);
    sourceIs=DocumentConversionUtil.convert(id,sourceIs,FileUtil.getExtension(name),"txt");
    id=DocumentConversionUtil.getTempFileId(fileEntryId,targetVersion);
    targetIs=DocumentConversionUtil.convert(id,targetIs,FileUtil.getExtension(name),"txt");
  }
  List[] diffResults=DiffUtil.diff(new InputStreamReader(sourceIs),new InputStreamReader(targetIs));
  req.setAttribute(WebKeys.SOURCE_NAME,titleWithExtension + StringPool.SPACE + sourceVersion);
  req.setAttribute(WebKeys.TARGET_NAME,titleWithExtension + StringPool.SPACE + targetVersion);
  req.setAttribute(WebKeys.DIFF_RESULTS,diffResults);
}
