{
  PermissionChecker permissionChecker=PermissionThreadLocal.getPermissionChecker();
  if (permissionChecker == null) {
    return methodInvocation.proceed();
  }
  Method method=methodInvocation.getMethod();
  String methodName=method.getName();
  Object[] arguments=methodInvocation.getArguments();
  Class<?>[] parameterTypes=method.getParameterTypes();
  boolean workflowEnabled=WorkflowThreadLocal.isEnabled();
  if (methodName.equals("getLayout") && (Arrays.equals(parameterTypes,_TYPES_L) || Arrays.equals(parameterTypes,_TYPES_L_B_L))) {
    Layout layout=(Layout)methodInvocation.proceed();
    if (Validator.isNull(layout.getSourcePrototypeLayoutUuid())) {
      return layout;
    }
    Group group=layout.getGroup();
    LayoutSet layoutSet=layout.getLayoutSet();
    try {
      MergeLayoutPrototypesThreadLocal.setInProgress(true);
      WorkflowThreadLocal.setEnabled(false);
      mergeLayoutProtypeLayout(group,layout);
      mergeLayoutSetProtypeLayouts(group,layoutSet);
    }
  finally {
      MergeLayoutPrototypesThreadLocal.setInProgress(false);
      WorkflowThreadLocal.setEnabled(workflowEnabled);
    }
  }
 else   if (methodName.equals("getLayouts") && (Arrays.equals(parameterTypes,_TYPES_L_B_L) || Arrays.equals(parameterTypes,_TYPES_L_B_L_B_I_I))) {
    long groupId=(Long)arguments[0];
    boolean privateLayout=(Boolean)arguments[1];
    long parentLayoutId=(Long)arguments[2];
    try {
      Group group=GroupLocalServiceUtil.getGroup(groupId);
      LayoutSet layoutSet=LayoutSetLocalServiceUtil.getLayoutSet(groupId,privateLayout);
      try {
        MergeLayoutPrototypesThreadLocal.setInProgress(true);
        WorkflowThreadLocal.setEnabled(false);
        mergeLayoutSetProtypeLayouts(group,layoutSet);
      }
  finally {
        MergeLayoutPrototypesThreadLocal.setInProgress(false);
        WorkflowThreadLocal.setEnabled(workflowEnabled);
      }
      if (!PropsValues.USER_GROUPS_COPY_LAYOUTS_TO_USER_PERSONAL_SITE && group.isUser() && (parentLayoutId == LayoutConstants.DEFAULT_PARENT_LAYOUT_ID)) {
        Object returnValue=methodInvocation.proceed();
        return addUserGroupLayouts(group,layoutSet,(List<Layout>)returnValue);
      }
    }
 catch (    Exception e) {
      _log.error(e,e);
      throw e;
    }
  }
  return methodInvocation.proceed();
}
