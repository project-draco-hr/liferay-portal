{
  try {
    if (!SitesUtil.isLayoutSetMergeable(group,layoutSet)) {
      return;
    }
    MergeLayoutPrototypesThreadLocal.setInProgress(true);
    WorkflowThreadLocal.setEnabled(false);
    int count=LayoutLocalServiceUtil.getLayoutsCount(group,privateLayout);
    if (count == 0) {
      SitesUtil.mergeLayoutSetPrototypeLayouts(group,layoutSet);
      return;
    }
    List<Layout> layouts=LayoutLocalServiceUtil.getLayouts(group.getGroupId(),privateLayout);
    for (    Layout layout : layouts) {
      if (SitesUtil.isLayoutModifiedSinceLastMerge(layout)) {
        return;
      }
    }
    SitesUtil.mergeLayoutSetPrototypeLayouts(group,layoutSet);
  }
 catch (  Exception e) {
    if (_log.isWarnEnabled()) {
      _log.warn("Unable to merge layouts for site template",e);
    }
  }
 finally {
    MergeLayoutPrototypesThreadLocal.setInProgress(false);
    WorkflowThreadLocal.setEnabled(workflowEnabled);
  }
}
