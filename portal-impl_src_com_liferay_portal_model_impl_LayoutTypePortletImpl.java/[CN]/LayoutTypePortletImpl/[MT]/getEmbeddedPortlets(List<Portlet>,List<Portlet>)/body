{
  if (_embeddedPortlets != null) {
    return _embeddedPortlets;
  }
  List<Portlet> portlets=new ArrayList<Portlet>();
  Layout layout=getLayout();
  List<PortletPreferences> portletPreferences=PortletPreferencesLocalServiceUtil.getPortletPreferences(PortletKeys.PREFS_OWNER_ID_DEFAULT,PortletKeys.PREFS_OWNER_TYPE_LAYOUT,layout.getPlid());
  if (isCustomizable() && hasUserPreferences()) {
    portletPreferences=ListUtil.copy(portletPreferences);
    portletPreferences.addAll(PortletPreferencesLocalServiceUtil.getPortletPreferences(_portalPreferences.getUserId(),PortletKeys.PREFS_OWNER_TYPE_USER,layout.getPlid()));
  }
  Set<String> portletAddDefaultResourceCheckWhiteList=PortalUtil.getPortletAddDefaultResourceCheckWhitelist();
  for (  PortletPreferences portletPreference : portletPreferences) {
    String portletId=portletPreference.getPortletId();
    Portlet portlet=PortletLocalServiceUtil.getPortletById(getCompanyId(),portletId);
    if (Validator.isNull(portletId) || columnPortlets.contains(portlet) || staticPortlets.contains(portlet)|| portlet.isSystem()|| portlet.isUndeployedPortlet()|| !portlet.isActive()|| portletAddDefaultResourceCheckWhiteList.contains(portletId)) {
      continue;
    }
    if (portlet != null) {
      Portlet embeddedPortlet=portlet;
      if (portlet.isInstanceable()) {
      }
 else {
        embeddedPortlet=(Portlet)embeddedPortlet.clone();
      }
      embeddedPortlet.setStatic(true);
      portlets.add(embeddedPortlet);
    }
  }
  _embeddedPortlets=portlets;
  return _embeddedPortlets;
}
