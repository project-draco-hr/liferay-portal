{
  List<Portlet> portlets=new ArrayList<>();
  Layout layout=getLayout();
  List<PortletPreferences> portletPreferences=PortletPreferencesLocalServiceUtil.getPortletPreferences(layout.getGroupId(),PortletKeys.PREFS_OWNER_TYPE_LAYOUT,PortletKeys.PREFS_PLID_SHARED);
  if (isCustomizable() && hasUserPreferences()) {
    portletPreferences=ListUtil.copy(portletPreferences);
    portletPreferences.addAll(PortletPreferencesLocalServiceUtil.getPortletPreferences(_portalPreferences.getUserId(),PortletKeys.PREFS_OWNER_TYPE_USER,layout.getPlid()));
  }
  for (  PortletPreferences portletPreference : portletPreferences) {
    String portletId=portletPreference.getPortletId();
    Portlet portlet=PortletLocalServiceUtil.getPortletById(getCompanyId(),portletId);
    if ((portlet == null) || !portlet.isReady() || portlet.isUndeployedPortlet()|| !portlet.isActive()) {
      continue;
    }
    Portlet embeddedPortlet=portlet;
    if (portlet.isInstanceable()) {
    }
 else {
      embeddedPortlet=(Portlet)embeddedPortlet.clone();
    }
    embeddedPortlet.setStatic(true);
    portlets.add(embeddedPortlet);
  }
  _embeddedPortlets=portlets;
  return _embeddedPortlets;
}
