{
  List<Portlet> portlets=new ArrayList<Portlet>();
  ThemeDisplay themeDisplay=(ThemeDisplay)_request.getAttribute(WebKeys.THEME_DISPLAY);
  try {
    List<Layout> layouts=themeDisplay.getLayouts();
    for (    Layout layout : layouts) {
      LayoutTypePortlet layoutTypePortlet=(LayoutTypePortlet)layout.getLayoutType();
      for (      Portlet portlet : layoutTypePortlet.getAllPortlets()) {
        PortletApp portletApp=portlet.getPortletApp();
        if (portletApp.isWARFile() || portlet.isRemote()) {
          portlets.add(portlet);
        }
      }
    }
  }
 catch (  SystemException se) {
    throw new PortletWindowContextException(se);
  }
  return portlets;
}
