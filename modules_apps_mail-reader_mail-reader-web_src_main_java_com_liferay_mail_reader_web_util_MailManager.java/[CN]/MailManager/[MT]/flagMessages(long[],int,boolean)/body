{
  try {
    if (messageIds.length == 0) {
      return createJSONResult("failure","no-messages-selected");
    }
    Message message=MessageLocalServiceUtil.getMessage(messageIds[0]);
    Mailbox mailbox=MailboxFactoryUtil.getMailbox(_user.getUserId(),message.getAccountId(),_passwordRetriever.getPassword(message.getAccountId()));
    mailbox.updateFlags(message.getFolderId(),messageIds,flag,value);
    return createJSONResult("success","messages-have-been-flagged");
  }
 catch (  MailException me) {
    if (me.getType() == MailException.MESSAGE_INVALID_FLAG) {
      return createJSONResult("failure","this-flag-is-not-supported");
    }
    _log.error(me,me);
    return createJSONResult("failure","unable-to-flag-messages");
  }
}
