{
  UploadPortletRequest uploadPortletRequest=PortalUtil.getUploadPortletRequest(actionRequest);
  ThemeDisplay themeDisplay=(ThemeDisplay)actionRequest.getAttribute(WebKeys.THEME_DISPLAY);
  checkPermission(themeDisplay.getScopeGroupId(),themeDisplay.getPermissionChecker());
  UploadException uploadException=(UploadException)actionRequest.getAttribute(WebKeys.UPLOAD_EXCEPTION);
  if (uploadException != null) {
    if (uploadException.isExceededLiferayFileItemSizeLimit()) {
      throw new LiferayFileItemException();
    }
 else     if (uploadException.isExceededSizeLimit()) {
      throw new FileSizeException(uploadException.getCause());
    }
    throw new PortalException(uploadException.getCause());
  }
  JSONObject jsonObject=JSONFactoryUtil.createJSONObject();
  String randomId=ParamUtil.getString(uploadPortletRequest,"randomId");
  try {
    JSONObject imageJSONObject=getImageJSONObject(actionRequest);
    jsonObject.put("success",Boolean.TRUE);
    imageJSONObject.put("randomId",randomId);
    jsonObject.put("image",imageJSONObject);
    JSONResponseUtil.writeJSON(actionRequest,actionResponse,jsonObject);
  }
 catch (  IOException ioe) {
    throw new SystemException(ioe);
  }
catch (  PortalException pe) {
    handleUploadException(actionRequest,actionResponse,pe,jsonObject);
  }
}
