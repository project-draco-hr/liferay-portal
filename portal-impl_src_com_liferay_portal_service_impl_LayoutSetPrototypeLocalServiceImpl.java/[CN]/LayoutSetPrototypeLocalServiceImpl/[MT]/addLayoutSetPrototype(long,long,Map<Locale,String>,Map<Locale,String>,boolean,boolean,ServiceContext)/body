{
  User user=userPersistence.findByPrimaryKey(userId);
  Date now=new Date();
  long layoutSetPrototypeId=counterLocalService.increment();
  LayoutSetPrototype layoutSetPrototype=layoutSetPrototypePersistence.create(layoutSetPrototypeId);
  layoutSetPrototype.setUuid(serviceContext.getUuid());
  layoutSetPrototype.setCompanyId(companyId);
  layoutSetPrototype.setUserId(userId);
  layoutSetPrototype.setUserName(user.getFullName());
  layoutSetPrototype.setCreateDate(serviceContext.getCreateDate(now));
  layoutSetPrototype.setModifiedDate(serviceContext.getModifiedDate(now));
  layoutSetPrototype.setNameMap(nameMap);
  layoutSetPrototype.setDescriptionMap(descriptionMap);
  layoutSetPrototype.setActive(active);
  UnicodeProperties settingsProperties=layoutSetPrototype.getSettingsProperties();
  settingsProperties.put("layoutsUpdateable",String.valueOf(layoutsUpdateable));
  layoutSetPrototype.setSettingsProperties(settingsProperties);
  layoutSetPrototypePersistence.update(layoutSetPrototype);
  resourceLocalService.addResources(companyId,0,userId,LayoutSetPrototype.class.getName(),layoutSetPrototype.getLayoutSetPrototypeId(),false,true,false);
  String friendlyURL="/template-" + layoutSetPrototype.getLayoutSetPrototypeId();
  Group group=groupLocalService.addGroup(userId,GroupConstants.DEFAULT_PARENT_GROUP_ID,LayoutSetPrototype.class.getName(),layoutSetPrototype.getLayoutSetPrototypeId(),GroupConstants.DEFAULT_LIVE_GROUP_ID,layoutSetPrototype.getNameMap(),null,0,true,GroupConstants.DEFAULT_MEMBERSHIP_RESTRICTION,friendlyURL,false,true,serviceContext);
  if (GetterUtil.getBoolean(serviceContext.getAttribute("addDefaultLayout"),true)) {
    layoutLocalService.addLayout(userId,group.getGroupId(),true,LayoutConstants.DEFAULT_PARENT_LAYOUT_ID,"home",null,null,LayoutConstants.TYPE_PORTLET,false,"/home",serviceContext);
  }
  return layoutSetPrototype;
}
