{
  PortletApp portletApp=portlet.getPortletApp();
  try {
    UserAttributes userAttributes=new UserAttributes(user);
    userInfo.put(UserAttributes.LIFERAY_COMPANY_ID,userAttributes.getValue(UserAttributes.LIFERAY_COMPANY_ID));
    userInfo.put(UserAttributes.LIFERAY_USER_ID,userAttributes.getValue(UserAttributes.LIFERAY_USER_ID));
    for (    String userAttributeName : portletApp.getUserAttributes()) {
      String userAttributeValue=userAttributes.getValue(userAttributeName);
      if (userAttributeValue != null) {
        userInfo.put(userAttributeName,userAttributeValue);
      }
    }
  }
 catch (  Exception e) {
    _log.error(e,e);
  }
  Map<String,String> unmodifiableUserInfo=Collections.unmodifiableMap((Map<String,String>)userInfo.clone());
  Map<String,CustomUserAttributes> customUserAttributesMap=new HashMap<>();
  Map<String,String> customUserAttributesClassNames=portletApp.getCustomUserAttributes();
  for (  Map.Entry<String,String> entry : customUserAttributesClassNames.entrySet()) {
    String userAttributeName=entry.getKey();
    String customUserAttributesClassName=entry.getValue();
    CustomUserAttributes customUserAttributes=customUserAttributesMap.get(customUserAttributesClassName);
    if (customUserAttributes == null) {
      if (portletApp.isWARFile()) {
        PortletContextBag portletContextBag=PortletContextBagPool.get(portletApp.getServletContextName());
        Map<String,CustomUserAttributes> portletContextBagCustomUserAttributes=portletContextBag.getCustomUserAttributes();
        customUserAttributes=portletContextBagCustomUserAttributes.get(customUserAttributesClassName);
        if (customUserAttributes == null) {
          customUserAttributes=newInstance(customUserAttributesClassName);
        }
        customUserAttributes=(CustomUserAttributes)customUserAttributes.clone();
      }
 else {
        customUserAttributes=newInstance(customUserAttributesClassName);
      }
      customUserAttributesMap.put(customUserAttributesClassName,customUserAttributes);
    }
    if (customUserAttributes != null) {
      String attrValue=customUserAttributes.getValue(userAttributeName,unmodifiableUserInfo);
      if (attrValue != null) {
        userInfo.put(userAttributeName,attrValue);
      }
    }
  }
  return userInfo;
}
