{
  ThemeDisplay themeDisplay=(ThemeDisplay)resourceRequest.getAttribute(WebKeys.THEME_DISPLAY);
  String portletId=PortalUtil.getPortletId(resourceRequest);
  PortletPermissionUtil.check(themeDisplay.getPermissionChecker(),themeDisplay.getPlid(),portletId,ActionKeys.CONFIGURATION);
  PortletPreferences preferences=PortletPreferencesFactoryUtil.getPortletSetup(resourceRequest);
  String databaseTableName=preferences.getValue("databaseTableName",StringPool.BLANK);
  String title=preferences.getValue("title","no-title");
  StringBundler sb=new StringBundler();
  List<String> fieldLabels=new ArrayList<>();
  for (int i=1; true; i++) {
    String fieldLabel=preferences.getValue("fieldLabel" + i,StringPool.BLANK);
    String localizedfieldLabel=LocalizationUtil.getPreferencesValue(preferences,"fieldLabel" + i,themeDisplay.getLanguageId());
    if (Validator.isNull(fieldLabel)) {
      break;
    }
    fieldLabels.add(fieldLabel);
    sb.append(getCSVFormattedValue(localizedfieldLabel));
    sb.append(PortletPropsValues.CSV_SEPARATOR);
  }
  sb.setIndex(sb.index() - 1);
  sb.append(CharPool.NEW_LINE);
  if (Validator.isNotNull(databaseTableName)) {
    List<ExpandoRow> rows=ExpandoRowLocalServiceUtil.getRows(themeDisplay.getCompanyId(),WebFormUtil.class.getName(),databaseTableName,QueryUtil.ALL_POS,QueryUtil.ALL_POS);
    for (    ExpandoRow row : rows) {
      for (      String fieldName : fieldLabels) {
        String data=ExpandoValueLocalServiceUtil.getData(themeDisplay.getCompanyId(),WebFormUtil.class.getName(),databaseTableName,fieldName,row.getClassPK(),StringPool.BLANK);
        sb.append(getCSVFormattedValue(data));
        sb.append(PortletPropsValues.CSV_SEPARATOR);
      }
      sb.setIndex(sb.index() - 1);
      sb.append(CharPool.NEW_LINE);
    }
  }
  String fileName=title + ".csv";
  byte[] bytes=sb.toString().getBytes();
  String contentType=ContentTypes.APPLICATION_TEXT;
  PortletResponseUtil.sendFile(resourceRequest,resourceResponse,fileName,bytes,contentType);
}
