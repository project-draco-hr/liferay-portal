{
  _myFacesPortlet=false;
  _sunFacesPortlet=false;
  if (!facesXML.exists()) {
    return;
  }
  Document doc=SAXReaderUtil.read(portletXML,true);
  Element root=doc.getRootElement();
  List<Element> elements=root.elements("portlet");
  Iterator<Element> itr=elements.iterator();
  while (itr.hasNext()) {
    Element portlet=itr.next();
    String portletClass=portlet.elementText("portlet-class");
    if (portletClass.equals(JSF_MYFACES)) {
      _myFacesPortlet=true;
      break;
    }
 else     if (portletClass.equals(JSF_SUN)) {
      _sunFacesPortlet=true;
      break;
    }
  }
  doc=SAXReaderUtil.read(facesXML,true);
  root=doc.getRootElement();
  Element factoryEl=root.element("factory");
  Element renderKitFactoryEl=null;
  Element facesContextFactoryEl=null;
  if (factoryEl == null) {
    factoryEl=root.addElement("factory");
  }
  renderKitFactoryEl=factoryEl.element("render-kit-factory");
  facesContextFactoryEl=factoryEl.element("faces-context-factory");
  if ((appServerType.equals("orion") && (_sunFacesPortlet) && (renderKitFactoryEl == null))) {
    renderKitFactoryEl=factoryEl.addElement("render-kit-factory");
    renderKitFactoryEl.addText(LIFERAY_RENDER_KIT_FACTORY);
  }
 else   if (_myFacesPortlet && (facesContextFactoryEl == null)) {
    facesContextFactoryEl=factoryEl.addElement("faces-context-factory");
    facesContextFactoryEl.addText(MYFACES_CONTEXT_FACTORY);
  }
  if (!appServerType.equals("orion") && (_sunFacesPortlet)) {
    factoryEl.detach();
  }
  XMLMerger merger=new XMLMerger(new FacesXMLDescriptor());
  DocumentImpl docImpl=(DocumentImpl)doc;
  merger.organizeXML(docImpl.getDocument());
  FileUtil.write(facesXML,doc.formattedString(),true);
}
