{
  UserBag userBag=PermissionCacheUtil.getUserBag(userId);
  if (userBag != null) {
    return userBag;
  }
  try {
    List<Group> userGroups=GroupLocalServiceUtil.getUserGroups(userId,true);
    Collection<Organization> userOrgs=getUserOrgs(userId);
    Set<Group> userOrgGroups=new HashSet<>(userOrgs.size());
    for (    Organization organization : userOrgs) {
      userOrgGroups.add(organization.getGroup());
    }
    List<Role> userRoles=null;
    if (!userGroups.isEmpty()) {
      userRoles=RoleLocalServiceUtil.getUserRelatedRoles(userId,userGroups);
    }
 else {
      userRoles=RoleLocalServiceUtil.getUserRoles(userId);
    }
    userBag=new UserBagImpl(userId,userGroups,userOrgs,userOrgGroups,userRoles);
    PermissionCacheUtil.putUserBag(userId,userBag);
    return userBag;
  }
 catch (  Exception e) {
    PermissionCacheUtil.removeUserBag(userId);
    throw e;
  }
}
