{
  UserBag userBag=PermissionCacheUtil.getUserBag(userId);
  if (userBag != null) {
    return userBag;
  }
  try {
    List<Group> userGroups=GroupLocalServiceUtil.getUserGroups(userId,true);
    Set<Organization> userOrgs=getUserOrgs(userId);
    Set<Group> userOrgGroups=new HashSet<>(userOrgs.size());
    for (    Organization organization : userOrgs) {
      userOrgGroups.add(organization.getGroup());
    }
    List<UserGroup> userUserGroups=UserGroupLocalServiceUtil.getUserUserGroups(userId);
    List<Group> userUserGroupGroups=GroupLocalServiceUtil.getUserGroupsGroups(userUserGroups);
    Set<Role> userRoles=new HashSet<>();
    if (!userGroups.isEmpty()) {
      List<Role> userRelatedRoles=RoleLocalServiceUtil.getUserRelatedRoles(userId,userGroups);
      userRoles.addAll(userRelatedRoles);
    }
 else {
      userRoles.addAll(RoleLocalServiceUtil.getUserRoles(userId));
    }
    userBag=new UserBagImpl(userId,SetUtil.fromList(userGroups),userOrgs,userOrgGroups,SetUtil.fromList(userUserGroupGroups),userRoles);
    PermissionCacheUtil.putUserBag(userId,userBag);
    return userBag;
  }
 catch (  Exception e) {
    PermissionCacheUtil.removeUserBag(userId);
    throw e;
  }
}
