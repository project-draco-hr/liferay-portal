{
  final TestClassLoader testClassLoader=new TestClassLoader();
  AbstractMessagingConfigurator pluginMessagingConfigurator=new AbstractMessagingConfigurator(){
    @Override protected ClassLoader getOperatingClassloader(){
      return testClassLoader;
    }
  }
;
  Set<DestinationConfiguration> destinationConfigurations=new HashSet<>();
  destinationConfigurations.add(DestinationConfiguration.createSynchronousDestinationConfiguration("liferay/plugintest"));
  destinationConfigurations.add(DestinationConfiguration.createParallelDestinationConfiguration("liferay/plugintest2"));
  pluginMessagingConfigurator.setDestinationConfigurations(destinationConfigurations);
  Map<String,List<MessageListener>> messageListeners=new HashMap<>();
  List<MessageListener> testListeners=new ArrayList<>();
  messageListeners.put("liferay/plugintest",testListeners);
  testListeners.add(new TestClassLoaderMessageListener(testClassLoader));
  pluginMessagingConfigurator.setMessageListeners(messageListeners);
  pluginMessagingConfigurator.afterPropertiesSet();
  Registry registry=RegistryUtil.getRegistry();
  Filter filter=registry.getFilter("(&(objectClass=com.liferay.portal.kernel.messaging.Destination)" + "(destination.name=*plugintest*))");
  ServiceTracker<Destination,Destination> tracker=registry.trackServices(filter);
  tracker.open();
  try {
    while (ArrayUtil.isEmpty(tracker.getServices())) {
      Thread.currentThread().sleep(1000);
    }
    Object[] services=tracker.getServices();
    Assert.assertEquals(2,services.length);
    for (    Object service : services) {
      Destination destination=(Destination)service;
      Assert.assertTrue(destination.getName().contains("plugintest"));
      if (destination.getName().equals("liferay/plugintest")) {
        Assert.assertEquals(1,destination.getMessageListenerCount());
      }
      if (destination.getMessageListenerCount() > 0) {
        Message message=new Message();
        message.setDestinationName(destination.getName());
        destination.send(message);
      }
    }
  }
 catch (  Exception e) {
    Assert.fail(StackTraceUtil.getStackTrace(e));
  }
}
