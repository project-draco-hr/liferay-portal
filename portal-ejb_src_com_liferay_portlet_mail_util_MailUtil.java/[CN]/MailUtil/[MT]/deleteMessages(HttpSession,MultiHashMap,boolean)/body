{
  try {
    MailSessionLock.lock(ses.getId());
    for (Iterator itr=msgMap.keySet().iterator(); itr.hasNext(); ) {
      String key=(String)itr.next();
      IMAPFolder folder=_getFolder(ses);
      String folderName=_getResolvedFolderName(folder.getName());
      if (permanently || folderName.equals(MAIL_TRASH_NAME)) {
        Message[] messages=folder.getMessagesByUID(_getMessageIds(msgMap,key));
        folder.setFlags(messages,new Flags(Flags.Flag.DELETED),true);
        folder.expunge();
        msgMap.remove(key);
      }
    }
    if (!msgMap.isEmpty()) {
      moveMessages(ses,msgMap,MAIL_TRASH_NAME);
    }
  }
 catch (  MessagingException me) {
    throw new FolderException(me);
  }
 finally {
    MailSessionLock.unlock(ses.getId());
  }
}
