{
  Set envelopes=new TreeSet(comparator);
  try {
    MailSessionLock.lock(req);
    IMAPFolder folder=_getFolder(req);
    String folderName=_getResolvedFolderName(folder.getName());
    Message[] messages=folder.getMessages();
    FetchProfile fetchProfile=new FetchProfile();
    fetchProfile.add(IMAPFolder.FetchProfileItem.SIZE);
    fetchProfile.add(FetchProfile.Item.ENVELOPE);
    fetchProfile.add(FetchProfile.Item.FLAGS);
    fetchProfile.add(FetchProfileItem.UID);
    folder.fetch(messages,fetchProfile);
    _convertEnvelopes(folder,folderName,messages,envelopes);
    return envelopes;
  }
 catch (  MessagingException me) {
    throw new FolderException(me);
  }
 finally {
    MailSessionLock.unlock(req);
  }
}
