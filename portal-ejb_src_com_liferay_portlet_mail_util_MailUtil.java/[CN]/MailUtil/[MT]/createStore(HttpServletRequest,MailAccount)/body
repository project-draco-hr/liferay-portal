{
  User user=_getMailUser(req);
  MailCache.removeStore(user.getUserId(),account.getName());
  String login=getLogin(account.getUserId());
  String password=account.getPassword();
  Session session=getSession();
  Store store=session.getStore("imap");
  store.addConnectionListener(new ConnectionListener());
  String imapHost=getIMAPHost();
  try {
    if (_log.isDebugEnabled()) {
      _log.debug("Connecting to IMAP host " + imapHost);
      _log.debug("User login is " + login);
    }
    store.connect(imapHost,login,password);
  }
 catch (  AuthenticationFailedException afe) {
    try {
      MailServiceUtil.updatePassword(user.getUserId(),password);
    }
 catch (    Exception e) {
      throw new MessagingException(e.getMessage(),e);
    }
    store.connect(imapHost,login,password);
  }
  MailCache.putStore(user.getUserId(),account.getName(),store);
  account.setStore(store);
  return store;
}
