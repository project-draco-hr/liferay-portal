{
  try {
    Store store=(Store)ses.getAttribute(WebKeys.MAIL_STORE);
    if (store != null && !store.isConnected()) {
      if (_log.isInfoEnabled()) {
        _log.info("The store needs to be reconnected");
      }
      cleanUp(ses);
      store=null;
    }
    if (store == null) {
      String userId=(String)ses.getAttribute(WebKeys.USER_ID);
      if (GetterUtil.getBoolean(PropsUtil.get(PropsUtil.MAIL_USERNAME_REPLACE))) {
        userId=StringUtil.replace(userId,".","_");
      }
      String serviceName=userId + StringPool.COLON + WebKeys.MAIL_STORE;
      Session session=MailEngine.getSession();
      String password=(String)ses.getAttribute(WebKeys.USER_PASSWORD);
      String imapHost=session.getProperty("mail.imap.host");
      store=session.getStore("imap");
      store.addConnectionListener(new ConnectionListener(serviceName));
      store.connect(imapHost,userId,password);
      ses.setAttribute(WebKeys.MAIL_STORE,store);
      List list=getFolders(ses);
      if (_log.isInfoEnabled()) {
        _log.info("Store has " + list.size() + " folders");
      }
      for (int i=0; i < DEFAULT_FOLDERS.length; i++) {
        Folder folder=store.getFolder(DEFAULT_FOLDERS[i]);
        if (!folder.exists()) {
          folder.create(Folder.HOLDS_MESSAGES);
          if (_log.isInfoEnabled()) {
            _log.info("Created default folder " + DEFAULT_FOLDERS[i]);
          }
        }
      }
      if (ses.getAttribute(WebKeys.MAIL_FOLDER) == null) {
        setFolder(ses,MAIL_INBOX_NAME);
      }
    }
    return store;
  }
 catch (  NoSuchProviderException pe) {
    throw new StoreException(pe);
  }
catch (  NamingException ne) {
    throw new StoreException(ne);
  }
catch (  MessagingException me) {
    throw new StoreException(me);
  }
}
