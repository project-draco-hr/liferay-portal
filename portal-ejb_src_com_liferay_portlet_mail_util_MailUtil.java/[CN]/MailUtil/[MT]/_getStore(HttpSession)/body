{
  String userId=(String)ses.getAttribute(WebKeys.USER_ID);
  if (GetterUtil.getBoolean(PropsUtil.get(PropsUtil.MAIL_USERNAME_REPLACE))) {
    userId=StringUtil.replace(userId,".","_");
  }
  try {
    MailAccount currentAccount=MailAccounts.getCurrentAccount(ses);
    Store store=MailCache.getStore(ses,currentAccount.getName());
    if (store != null && !store.isConnected()) {
      if (_log.isInfoEnabled()) {
        _log.info("The store needs to be reconnected");
      }
      cleanUp(ses);
      store=null;
    }
    if (store == null) {
      store=_createStore(ses,currentAccount);
    }
    return store;
  }
 catch (  AuthenticationFailedException afe) {
    _log.error("Failed to authenticate the userId " + userId + "");
    throw new StoreException(afe);
  }
catch (  MessagingException me) {
    throw new StoreException(me);
  }
catch (  NamingException ne) {
    throw new StoreException(ne);
  }
}
