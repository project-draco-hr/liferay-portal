{
  try {
    Store store=(Store)ses.getAttribute(WebKeys.MAIL_STORE);
    if (store != null && !store.isConnected()) {
      if (_log.isInfoEnabled()) {
        _log.info("The store needs to be reconnected");
      }
      cleanUp(ses);
      store=null;
    }
    if (store == null) {
      Session session=MailEngine.getSession();
      String imapHost=session.getProperty("mail.imap.host");
      String userId=(String)ses.getAttribute(WebKeys.USER_ID);
      String serviceName=userId + StringPool.COLON + WebKeys.MAIL_STORE;
      if (GetterUtil.getBoolean(PropsUtil.get(PropsUtil.MAIL_USERNAME_REPLACE))) {
        userId=StringUtil.replace(userId,".","_");
      }
      String password=(String)ses.getAttribute(WebKeys.USER_PASSWORD);
      store=session.getStore("imap");
      store.addConnectionListener(new ConnectionListener(serviceName));
      store.connect(imapHost,userId,password);
      ses.setAttribute(WebKeys.MAIL_STORE,store);
      List list=getFolders(ses);
      for (int i=0; i < DEFAULT_FOLDERS.length; i++) {
        boolean exists=false;
        Iterator itr=list.iterator();
        while (itr.hasNext()) {
          MailFolder mailFolder=(MailFolder)itr.next();
          if (DEFAULT_FOLDERS[i].equals(mailFolder.getName())) {
            exists=true;
            break;
          }
        }
        if (!exists) {
          createFolder(ses,DEFAULT_FOLDERS[i]);
        }
      }
      if (ses.getAttribute(WebKeys.MAIL_FOLDER) == null) {
        setFolder(ses,MAIL_INBOX_NAME);
      }
    }
    return store;
  }
 catch (  MessagingException me) {
    throw new StoreException(me);
  }
catch (  NamingException ne) {
    throw new StoreException(ne);
  }
}
