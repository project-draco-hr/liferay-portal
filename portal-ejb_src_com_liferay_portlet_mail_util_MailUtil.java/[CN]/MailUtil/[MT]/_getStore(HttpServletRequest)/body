{
  HttpSession ses=req.getSession();
  MailAccount currentAccount=MailAccounts.getCurrentAccount(req);
  try {
    Store store=MailCache.getStore(ses,currentAccount.getName());
    if (store != null && !store.isConnected()) {
      if (_log.isInfoEnabled()) {
        _log.info("The store needs to be reconnected");
      }
      cleanUp(ses);
      store=null;
    }
    if (store == null) {
      store=_createStore(req,currentAccount);
    }
    return store;
  }
 catch (  AuthenticationFailedException afe) {
    _log.error("Failed to authenticate the userId " + currentAccount.getUserId());
    throw new StoreException(afe);
  }
catch (  MessagingException me) {
    Exception ne=me.getNextException();
    if (ne instanceof SocketException) {
      if (_log.isWarnEnabled()) {
        _log.warn("Failed to connect to a valid mail server.  " + "Please make sure one is properly configured.");
      }
      throw new MailServerException(ne);
    }
 else {
      throw new StoreException(me);
    }
  }
catch (  NamingException ne) {
    throw new StoreException(ne);
  }
}
