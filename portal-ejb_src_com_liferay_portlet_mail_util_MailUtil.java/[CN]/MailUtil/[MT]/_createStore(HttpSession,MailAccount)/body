{
  Session session=MailEngine.getSession();
  Store store=session.getStore("imap");
  String serviceName=account.getUserId() + StringPool.COLON + WebKeys.MAIL_STORE;
  store.addConnectionListener(new ConnectionListener(serviceName));
  String imapHost=session.getProperty("mail.imap.host");
  store.connect(imapHost,account.getUserId(),account.getPassword());
  MailCache.putStore(ses,account.getName(),store);
  List list=getFolders(ses);
  for (int i=0; i < DEFAULT_FOLDERS.length; i++) {
    boolean exists=false;
    Iterator itr=list.iterator();
    while (itr.hasNext()) {
      MailFolder mailFolder=(MailFolder)itr.next();
      if (DEFAULT_FOLDERS[i].equals(mailFolder.getName())) {
        exists=true;
        break;
      }
    }
    if (!exists) {
      createFolder(ses,DEFAULT_FOLDERS[i]);
    }
  }
  if (ses.getAttribute(WebKeys.MAIL_FOLDER) == null) {
    setFolder(ses,MAIL_INBOX_NAME);
  }
  return store;
}
