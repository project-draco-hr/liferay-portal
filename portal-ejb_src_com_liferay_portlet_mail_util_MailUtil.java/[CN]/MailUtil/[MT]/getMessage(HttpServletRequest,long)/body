{
  HttpSession ses=req.getSession();
  MailMessage mailMessage=new MailMessage();
  try {
    MailSessionLock.lock(req);
    IMAPFolder folder=_getFolder(req);
    Message message=folder.getMessageByUID(messageId);
    mailMessage.setMessageId(messageId);
    if (!Validator.isNull(message.getFrom())) {
      mailMessage.setFrom(message.getFrom()[0]);
    }
    mailMessage.setTo(message.getRecipients(RecipientType.TO));
    mailMessage.setCc(message.getRecipients(RecipientType.CC));
    mailMessage.setBcc(message.getRecipients(RecipientType.BCC));
    mailMessage.setReplyTo(message.getReplyTo());
    String[] messageIdHeader=message.getHeader("Message-ID");
    if ((messageIdHeader != null) && (messageIdHeader.length > 0)) {
      mailMessage.setInReplyTo(messageIdHeader[0]);
    }
    mailMessage.setSubject(message.getSubject());
    mailMessage.setSentDate(message.getSentDate());
    String contentPath=RemoteMailAttachment.buildContentPath(folder.getName(),messageId);
    mailMessage=_getContent(message,mailMessage,contentPath);
    _replaceContentIds(mailMessage,_getAttachmentURL(req));
    ses.setAttribute(WebKeys.MAIL_MESSAGE_ID,new Long(messageId));
    return mailMessage;
  }
 catch (  MessagingException me) {
    throw new FolderException(me);
  }
 finally {
    MailSessionLock.unlock(req);
  }
}
