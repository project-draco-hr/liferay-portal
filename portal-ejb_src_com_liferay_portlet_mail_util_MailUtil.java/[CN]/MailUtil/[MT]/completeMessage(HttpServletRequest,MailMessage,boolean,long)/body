{
  HttpSession ses=req.getSession();
  try {
    if (send && Validator.isNull(mailMessage.getTo()) && Validator.isNull(mailMessage.getCc())&& Validator.isNull(mailMessage.getBcc())) {
      _log.error("A message with no recipients cannot be sent");
      throw new RecipientException();
    }
    Message message=new MimeMessage(MailEngine.getSession());
    message.setFrom(mailMessage.getFrom());
    if (!Validator.isNull(mailMessage.getTo())) {
      message.setRecipients(Message.RecipientType.TO,mailMessage.getTo());
    }
    if (!Validator.isNull(mailMessage.getCc())) {
      message.setRecipients(Message.RecipientType.CC,mailMessage.getCc());
    }
    if (!Validator.isNull(mailMessage.getBcc())) {
      message.setRecipients(Message.RecipientType.BCC,mailMessage.getBcc());
    }
    message.setSubject(mailMessage.getSubject());
    _replaceEmbeddedImages(ses,mailMessage,_getAttachmentURL(req));
    Multipart multipart=new MimeMultipart();
    BodyPart bodyPart=new MimeBodyPart();
    bodyPart.setContent(mailMessage.getHtmlBody(),Constants.TEXT_HTML);
    multipart.addBodyPart(bodyPart);
    List attachments=mailMessage.getAttachments();
    Iterator itr=attachments.iterator();
    while (itr.hasNext()) {
      MailAttachment mailAttachment=(MailAttachment)itr.next();
      DataSource dataSource=new ByteArrayDataSource(mailAttachment.getContent(),mailAttachment.getContentType());
      BodyPart attachment=new MimeBodyPart();
      attachment.setFileName(mailAttachment.getFilename());
      attachment.setDataHandler(new DataHandler(dataSource));
      if (Validator.isNotNull(mailAttachment.getContentId())) {
        attachment.addHeader(Constants.CONTENT_ID,mailAttachment.getContentId());
      }
      multipart.addBodyPart(attachment);
    }
    List remoteAttachments=mailMessage.getRemoteAttachments();
    itr=remoteAttachments.iterator();
    while (itr.hasNext()) {
      RemoteMailAttachment remoteMailAttachment=(RemoteMailAttachment)itr.next();
      Object[] parts=getAttachment(ses,remoteMailAttachment.getContentPath());
      DataSource dataSource=new ByteArrayDataSource((byte[])parts[0],(String)parts[1]);
      BodyPart attachment=new MimeBodyPart();
      attachment.setFileName(remoteMailAttachment.getFilename());
      attachment.setDataHandler(new DataHandler(dataSource));
      multipart.addBodyPart(attachment);
    }
    message.setContent(multipart);
    message.setSentDate(new Date());
    if (send) {
      Transport.send(message);
    }
    try {
      MailSessionLock.lock(ses.getId());
      String lastFolderName=getFolderName(ses);
      IMAPFolder folder=null;
      if (send) {
        folder=_getFolder(ses,MAIL_SENT_NAME);
      }
 else {
        folder=_getFolder(ses,MAIL_DRAFTS_NAME);
      }
      folder.appendMessages(new Message[]{message});
      if (draftId > 0) {
        folder=_getFolder(ses,MAIL_DRAFTS_NAME);
        Message msg=folder.getMessageByUID(draftId);
        folder.setFlags(new Message[]{msg},new Flags(Flags.Flag.DELETED),true);
        folder.expunge();
      }
      _closeFolder(ses);
      setFolder(ses,lastFolderName);
    }
  finally {
      MailSessionLock.unlock(ses.getId());
    }
  }
 catch (  MessagingException me) {
    throw new ContentException(me);
  }
catch (  NamingException ne) {
    throw new ContentException(ne);
  }
}
