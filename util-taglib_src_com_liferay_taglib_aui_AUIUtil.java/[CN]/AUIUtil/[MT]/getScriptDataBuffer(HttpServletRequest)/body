{
  ScriptData scriptData=(ScriptData)request.getAttribute(ScriptTag.class.getName());
  if (scriptData == null) {
    scriptData=(ScriptData)request.getAttribute(WebKeys.AUI_SCRIPT_DATA);
    if (scriptData != null) {
      request.removeAttribute(WebKeys.AUI_SCRIPT_DATA);
    }
  }
  if (scriptData == null) {
    return StringPool.BLANK;
  }
  StringBundler sb=new StringBundler();
  sb.append("<script type=\"text/javascript\">\n// <![CDATA[\n");
  sb.append(scriptData.getRawSB());
  StringBundler callbackSB=scriptData.getCallbackSB();
  if (callbackSB.index() > 0) {
    String loadMethod="use";
    if (BrowserSnifferUtil.isIe(request) && (BrowserSnifferUtil.getMajorVersion(request) < 8)) {
      loadMethod="ready";
    }
    sb.append("AUI().");
    sb.append(loadMethod);
    sb.append("(");
    Set<String> useSet=scriptData.getUseSet();
    for (    String use : useSet) {
      sb.append(StringPool.APOSTROPHE);
      sb.append(use);
      sb.append(StringPool.APOSTROPHE);
      sb.append(StringPool.COMMA_AND_SPACE);
    }
    sb.append("function(A) {");
    sb.append(callbackSB);
    sb.append("});");
  }
  sb.append("\n// ]]>\n</script>");
  return sb.toString();
}
