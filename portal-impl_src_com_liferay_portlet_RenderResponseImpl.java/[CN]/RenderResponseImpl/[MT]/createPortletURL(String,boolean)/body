{
  Portlet portlet=getPortlet();
  String portletURLClass=portlet.getPortletURLClass();
  if (portlet.getPortletId().equals(portletName) && Validator.isNotNull(portletURLClass)) {
    try {
      Class portletURLClassObj=Class.forName(portletURLClass);
      Constructor constructor=portletURLClassObj.getConstructor(new Class[]{com.liferay.portlet.RenderResponseImpl.class,boolean.class});
      return (PortletURL)constructor.newInstance(new Object[]{this,new Boolean(action)});
    }
 catch (    Exception e) {
      _log.error(e);
    }
  }
  long plid=_plid;
  try {
    PortletPreferences portletSetup=PortletPreferencesFactoryUtil.getPortletSetup(_req,_portletName,true,true);
    plid=GetterUtil.getLong(portletSetup.getValue("portlet-setup-link-to-plid",String.valueOf(_plid)));
    if (plid <= 0) {
      plid=_plid;
    }
  }
 catch (  PortalException e) {
    if (_log.isWarnEnabled()) {
      _log.warn(e);
    }
  }
catch (  SystemException e) {
    if (_log.isWarnEnabled()) {
      _log.warn(e);
    }
  }
  return new PortletURLImpl(_req,portletName,plid,action);
}
