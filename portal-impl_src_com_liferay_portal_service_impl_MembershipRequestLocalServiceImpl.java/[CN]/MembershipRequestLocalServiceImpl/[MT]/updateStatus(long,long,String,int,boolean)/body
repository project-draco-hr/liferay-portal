{
  validate(replyComments);
  MembershipRequest membershipRequest=membershipRequestPersistence.findByPrimaryKey(membershipRequestId);
  membershipRequest.setReplyComments(replyComments);
  membershipRequest.setReplyDate(new Date());
  if (replierUserId != 0) {
    membershipRequest.setReplierUserId(replierUserId);
  }
 else {
    long defaultUserId=userLocalService.getDefaultUserId(membershipRequest.getCompanyId());
    membershipRequest.setReplierUserId(defaultUserId);
  }
  membershipRequest.setStatusId(statusId);
  membershipRequestPersistence.update(membershipRequest,false);
  if ((statusId == MembershipRequestConstants.STATUS_APPROVED) && addUserToGroup) {
    long[] addUserIds=new long[]{membershipRequest.getUserId()};
    userLocalService.addGroupUsers(membershipRequest.getGroupId(),addUserIds);
  }
  try {
    if (replierUserId != 0) {
      notify(membershipRequest.getUserId(),membershipRequest,PropsKeys.COMMUNITIES_EMAIL_MEMBERSHIP_REPLY_SUBJECT,PropsKeys.COMMUNITIES_EMAIL_MEMBERSHIP_REPLY_BODY);
    }
  }
 catch (  IOException ioe) {
    throw new SystemException(ioe);
  }
}
