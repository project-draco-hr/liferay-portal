{
  try {
    Group group=GroupServiceUtil.getGroup(membershipRequest.getGroupId());
    String fromName=PrefsPropsUtil.getString(membershipRequest.getCompanyId(),PropsUtil.COMMUNITIES_EMAIL_FROM_NAME);
    String fromAddress=PrefsPropsUtil.getString(membershipRequest.getCompanyId(),PropsUtil.COMMUNITIES_EMAIL_FROM_ADDRESS);
    User user=UserLocalServiceUtil.getUserById(userId);
    Company company=CompanyLocalServiceUtil.getCompanyById(membershipRequest.getCompanyId());
    String toName=user.getFullName();
    String toAddress=user.getEmailAddress();
    String subject=PrefsPropsUtil.getContent(membershipRequest.getCompanyId(),subjectProperty);
    String body=PrefsPropsUtil.getContent(membershipRequest.getCompanyId(),bodyProperty);
    String statusKey;
    if (membershipRequest.getStatusId() == MembershipRequestImpl.STATUS_APPROVED) {
      statusKey="approved";
    }
 else     if (membershipRequest.getStatusId() == MembershipRequestImpl.STATUS_DENIED) {
      statusKey="denied";
    }
 else {
      statusKey="pending";
    }
    subject=StringUtil.replace(subject,new String[]{"[$COMMUNITY_NAME$]","[$COMPANY_ID$]","[$COMPANY_MX$]","[$COMPANY_NAME$]","[$FROM_NAME$]","[$FROM_ADDRESS$]","[$PORTAL_URL$]","[$STATUS$]","[$TO_NAME$]","[$USER_EMAIL$]","[$USER_NAME$]"},new String[]{group.getName(),String.valueOf(company.getCompanyId()),company.getMx(),company.getName(),fromName,fromAddress,company.getVirtualHost(),LanguageUtil.get(user.getLocale(),statusKey),toName,user.getEmailAddress(),user.getFullName()});
    body=StringUtil.replace(body,new String[]{"[$COMMENTS$]","[$COMMUNITY_NAME$]","[$COMPANY_ID$]","[$COMPANY_MX$]","[$COMPANY_NAME$]","[$FROM_NAME$]","[$FROM_ADDRESS$]","[$PORTAL_URL$]","[$REPLY_COMMENTS$]","[$STATUS$]","[$TO_NAME$]","[$USER_EMAIL$]","[$USER_NAME$]"},new String[]{membershipRequest.getComments(),group.getName(),String.valueOf(company.getCompanyId()),company.getMx(),company.getName(),fromName,fromAddress,company.getVirtualHost(),membershipRequest.getReplyComments(),LanguageUtil.get(user.getLocale(),statusKey),toName,user.getEmailAddress(),user.getFullName()});
    InternetAddress from=new InternetAddress(fromAddress,fromName);
    InternetAddress to=new InternetAddress(toAddress,toName);
    MailMessage message=new MailMessage(from,to,subject,body,true);
    MailServiceUtil.sendEmail(message);
  }
 catch (  IOException ioe) {
    throw new SystemException(ioe);
  }
}
