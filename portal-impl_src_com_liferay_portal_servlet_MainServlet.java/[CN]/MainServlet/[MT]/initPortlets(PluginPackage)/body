{
  ServletContext servletContext=getServletContext();
  String[] xmls=new String[PropsValues.PORTLET_CONFIGS.length];
  for (int i=0; i < PropsValues.PORTLET_CONFIGS.length; i++) {
    xmls[i]=HttpUtil.URLtoString(servletContext.getResource(PropsValues.PORTLET_CONFIGS[i]));
  }
  PortletLocalServiceUtil.initEAR(servletContext,xmls,pluginPackage);
  PortletBagFactory portletBagFactory=new PortletBagFactory();
  portletBagFactory.setClassLoader(ClassLoaderUtil.getPortalClassLoader());
  portletBagFactory.setServletContext(servletContext);
  portletBagFactory.setWARFile(false);
  List<Portlet> portlets=PortletLocalServiceUtil.getPortlets();
  for (int i=0; i < portlets.size(); i++) {
    Portlet portlet=portlets.get(i);
    portletBagFactory.create(portlet);
    if (i == 0) {
      initPortletApp(portlet,servletContext);
    }
  }
  servletContext.setAttribute(WebKeys.PLUGIN_PORTLETS,portlets);
  return portlets;
}
