{
  ServletContext servletContext=getServletContext();
  String[] xmls=new String[]{HttpUtil.URLtoString(servletContext.getResource("/WEB-INF/" + Portal.PORTLET_XML_FILE_NAME_CUSTOM)),HttpUtil.URLtoString(servletContext.getResource("/WEB-INF/portlet-ext.xml")),HttpUtil.URLtoString(servletContext.getResource("/WEB-INF/liferay-portlet.xml")),HttpUtil.URLtoString(servletContext.getResource("/WEB-INF/liferay-portlet-ext.xml")),HttpUtil.URLtoString(servletContext.getResource("/WEB-INF/web.xml"))};
  PortletLocalServiceUtil.initEAR(servletContext,xmls,pluginPackage);
  PortletBagFactory portletBagFactory=new PortletBagFactory();
  portletBagFactory.setClassLoader(PACLClassLoaderUtil.getPortalClassLoader());
  portletBagFactory.setServletContext(servletContext);
  portletBagFactory.setWARFile(false);
  List<Portlet> portlets=PortletLocalServiceUtil.getPortlets();
  for (int i=0; i < portlets.size(); i++) {
    Portlet portlet=portlets.get(i);
    portletBagFactory.create(portlet);
    if (i == 0) {
      initPortletApp(portlet,servletContext);
    }
  }
  return portlets;
}
