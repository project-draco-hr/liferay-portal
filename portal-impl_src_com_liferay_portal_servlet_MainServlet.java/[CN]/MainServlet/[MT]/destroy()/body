{
  List<Portlet> portlets=PortletLocalServiceUtil.getPortlets();
  if (_log.isDebugEnabled()) {
    _log.debug("Scheduler");
  }
  try {
    if (PropsValues.SCHEDULER_ENABLED) {
      for (      String className : PropsValues.SCHEDULER_CLASSES) {
        Scheduler scheduler=(Scheduler)InstancePool.get(className,false);
        if (scheduler != null) {
          scheduler.unschedule();
        }
      }
      Iterator<Portlet> itr=portlets.iterator();
      while (itr.hasNext()) {
        Portlet portlet=itr.next();
        String className=portlet.getSchedulerClass();
        if (!portlet.isActive() || Validator.isNull(className)) {
          continue;
        }
        Scheduler scheduler=(Scheduler)InstancePool.get(className,false);
        if (scheduler != null) {
          scheduler.unschedule();
        }
      }
    }
    if (PropsValues.SCHEDULER_ENABLED) {
      Iterator<Portlet> itr=portlets.iterator();
      while (itr.hasNext()) {
        Portlet portlet=itr.next();
        if (!portlet.isActive()) {
          continue;
        }
        List<com.liferay.portal.kernel.scheduler.Scheduler> schedulerList=portlet.getSchedulers();
        if (schedulerList != null && schedulerList.size() > 0) {
          for (          com.liferay.portal.kernel.scheduler.Scheduler schedulerNew : schedulerList) {
            try {
              com.liferay.portal.kernel.messaging.MessageListener schedulerListener=schedulerNew.getListener();
              if (schedulerListener == null) {
                throw new SystemException("Unable to create scheduler listener " + "from class:" + schedulerNew.getListenerClass());
              }
              MessageBusUtil.unregisterMessageListener(DestinationNames.SCHEDULER_DISPATCH,schedulerListener);
              SchedulerEngineUtil.unschedule(schedulerNew.getTrigger());
            }
 catch (            Exception ex) {
              if (_log.isErrorEnabled()) {
                _log.error("Failed to remove scheduler for " + "portlet:" + portlet.getPortletName(),ex);
              }
              continue;
            }
          }
        }
      }
    }
  }
 catch (  Exception e) {
    _log.error(e,e);
  }
  try {
    Iterator<Portlet> itr=portlets.iterator();
    while (itr.hasNext()) {
      Portlet portlet=itr.next();
      PortletInstanceFactoryUtil.destroy(portlet);
    }
  }
 catch (  Exception e) {
    _log.error(e,e);
  }
  long[] companyIds=PortalInstances.getCompanyIds();
  for (int i=0; i < companyIds.length; i++) {
    destroyCompany(companyIds[i]);
  }
  if (_log.isDebugEnabled()) {
    _log.debug("Process global shutdown events");
  }
  try {
    EventsProcessorUtil.process(PropsKeys.GLOBAL_SHUTDOWN_EVENTS,PropsValues.GLOBAL_SHUTDOWN_EVENTS);
  }
 catch (  Exception e) {
    _log.error(e,e);
  }
  super.destroy();
}
