{
  ServiceDependencyManager serviceDependencyManager=new ServiceDependencyManager();
  serviceDependencyManager.addServiceDependencyListener(new ServiceDependencyListener(){
    @Override public void dependenciesFulfilled(){
      try {
        if (_log.isDebugEnabled()) {
          _log.debug("Initialize companies");
        }
        ServletContext servletContext=getServletContext();
        try {
          String[] webIds=PortalInstances.getWebIds();
          for (          String webId : webIds) {
            PortalInstances.initCompany(servletContext,webId);
          }
        }
  finally {
          CompanyThreadLocal.setCompanyId(PortalInstances.getDefaultCompanyId());
          ShardDataSourceTargetSource shardDataSourceTargetSource=(ShardDataSourceTargetSource)InfrastructureUtil.getShardDataSourceTargetSource();
          if (shardDataSourceTargetSource != null) {
            shardDataSourceTargetSource.resetDataSource();
          }
        }
      }
 catch (      Exception e) {
        _log.error(e,e);
      }
    }
    @Override public void destroy(){
    }
  }
);
  Registry registry=RegistryUtil.getRegistry();
  Filter systemEngineFilter=registry.getFilter("(search.engine.id=SYSTEM_ENGINE)");
  serviceDependencyManager.registerDependencies(systemEngineFilter);
}
