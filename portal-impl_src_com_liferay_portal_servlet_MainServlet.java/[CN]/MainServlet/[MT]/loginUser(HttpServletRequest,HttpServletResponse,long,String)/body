{
  if ((userId > 0) || (remoteUser == null)) {
    return userId;
  }
  userId=GetterUtil.getLong(remoteUser);
  EventsProcessorUtil.process(PropsKeys.LOGIN_EVENTS_PRE,PropsValues.LOGIN_EVENTS_PRE,request,response);
  User user=UserLocalServiceUtil.getUserById(userId);
  if (PropsValues.USERS_UPDATE_LAST_LOGIN) {
    UserLocalServiceUtil.updateLastLogin(userId,request.getRemoteAddr());
  }
  HttpSession session=request.getSession();
  session.setAttribute(WebKeys.USER,user);
  session.setAttribute(WebKeys.USER_ID,new Long(userId));
  session.setAttribute(Globals.LOCALE_KEY,user.getLocale());
  EventsProcessorUtil.process(PropsKeys.LOGIN_EVENTS_POST,PropsValues.LOGIN_EVENTS_POST,request,response);
  return userId;
}
