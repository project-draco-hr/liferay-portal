{
  PrintStream oldOutPrintStream=System.out;
  ObjectOutputStream objectOutputStream=null;
  ProcessOutputStream outProcessOutputStream=null;
synchronized (oldOutPrintStream) {
    oldOutPrintStream.flush();
    FileOutputStream fileOutputStream=new FileOutputStream(FileDescriptor.out);
    objectOutputStream=new ObjectOutputStream(new UnsyncBufferedOutputStream(fileOutputStream));
    outProcessOutputStream=new ProcessOutputStream(objectOutputStream,false);
    ProcessContext._setProcessOutputStream(outProcessOutputStream);
    PrintStream newOutPrintStream=new PrintStream(outProcessOutputStream,true);
    System.setOut(newOutPrintStream);
  }
  ProcessOutputStream errProcessOutputStream=new ProcessOutputStream(objectOutputStream,true);
  PrintStream errPrintStream=new PrintStream(errProcessOutputStream,true);
  System.setErr(errPrintStream);
  try {
    ObjectInputStream objectInputStream=new ObjectInputStream(System.in);
    ProcessCallable<?> processCallable=(ProcessCallable<?>)objectInputStream.readObject();
    String logPrefixString=StringPool.OPEN_BRACKET.concat(processCallable.toString()).concat(StringPool.CLOSE_BRACKET);
    byte[] logPrefix=logPrefixString.getBytes(StringPool.UTF8);
    outProcessOutputStream.setLogPrefix(logPrefix);
    errProcessOutputStream.setLogPrefix(logPrefix);
    Serializable result=processCallable.call();
    System.out.flush();
    outProcessOutputStream.writeProcessCallable(new ReturnProcessCallable<Serializable>(result));
    outProcessOutputStream.flush();
  }
 catch (  ProcessException pe) {
    errPrintStream.flush();
    errProcessOutputStream.writeProcessCallable(new ExceptionProcessCallable(pe));
    errProcessOutputStream.flush();
  }
}
