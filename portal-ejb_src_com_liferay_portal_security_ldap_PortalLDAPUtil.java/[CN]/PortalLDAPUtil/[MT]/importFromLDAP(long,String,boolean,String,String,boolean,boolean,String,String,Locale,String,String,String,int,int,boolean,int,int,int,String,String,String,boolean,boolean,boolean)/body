{
  User user=null;
  if (_log.isDebugEnabled()) {
    _log.debug("Screen name " + screenName + " and email address "+ emailAddress);
  }
  if (Validator.isNull(screenName) || Validator.isNull(emailAddress)) {
    if (_log.isWarnEnabled()) {
      _log.warn("Cannot add user because screen name and email address " + "are required");
    }
    return user;
  }
  boolean create=true;
  if (checkExists) {
    try {
      user=UserLocalServiceUtil.getUserByEmailAddress(companyId,emailAddress);
      if (updatePassword) {
        UserLocalServiceUtil.updatePassword(user.getUserId(),password1,password2,passwordReset);
      }
      create=false;
    }
 catch (    NoSuchUserException nsue) {
    }
  }
  if (create) {
    try {
      user=UserLocalServiceUtil.addUser(creatorUserId,companyId,autoPassword,password1,password2,passwordReset,autoScreenName,screenName,emailAddress,locale,firstName,middleName,lastName,prefixId,suffixId,male,birthdayMonth,birthdayDay,birthdayYear,jobTitle,organizationId,locationId,sendEmail);
    }
 catch (    Exception e) {
      _log.error("Problem adding user with screen name " + screenName + " and email address "+ emailAddress,e);
    }
  }
  return user;
}
