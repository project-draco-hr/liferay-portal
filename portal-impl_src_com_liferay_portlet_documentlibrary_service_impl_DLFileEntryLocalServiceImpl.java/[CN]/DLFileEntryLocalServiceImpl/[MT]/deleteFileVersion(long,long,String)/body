{
  if (Validator.isNull(version) || version.equals(DLFileEntryConstants.PRIVATE_WORKING_COPY_VERSION)) {
    throw new InvalidFileVersionException();
  }
  if (!hasFileEntryLock(userId,fileEntryId)) {
    lockFileEntry(userId,fileEntryId);
  }
  try {
    DLFileVersion fileVersion=dlFileVersionPersistence.findByF_V(fileEntryId,version);
    if (!fileVersion.isApproved()) {
      throw new InvalidFileVersionException("Cannot delete an unapproved file version");
    }
 else {
      int count=dlFileVersionPersistence.countByF_S(fileEntryId,WorkflowConstants.STATUS_APPROVED);
      if (count <= 1) {
        throw new InvalidFileVersionException("Cannot delete the only approved file version");
      }
    }
    dlFileVersionPersistence.remove(fileVersion);
    expandoValueLocalService.deleteValues(DLFileVersion.class.getName(),fileVersion.getFileVersionId());
    DLFileEntry dlFileEntry=dlFileEntryPersistence.findByPrimaryKey(fileEntryId);
    if (version.equals(dlFileEntry.getVersion())) {
      try {
        DLFileVersion dlLatestFileVersion=dlFileVersionLocalService.getLatestFileVersion(dlFileEntry.getFileEntryId(),true);
        dlFileEntry.setVersion(dlLatestFileVersion.getVersion());
        dlFileEntry.setSize(dlLatestFileVersion.getSize());
        dlFileEntryPersistence.update(dlFileEntry,false);
      }
 catch (      NoSuchFileVersionException nsfve) {
      }
    }
    try {
      DLStoreUtil.deleteFile(dlFileEntry.getCompanyId(),dlFileEntry.getDataRepositoryId(),dlFileEntry.getName(),version);
    }
 catch (    NoSuchModelException nsme) {
    }
  }
  finally {
    unlockFileEntry(fileEntryId);
  }
}
