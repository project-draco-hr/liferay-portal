{
  try {
    RenderedImage renderedImage=null;
    Image largeImage=imageLocalService.getImage(largeImageId);
    byte[] bytes=largeImage.getTextObj();
    String contentType=largeImage.getType();
    if (bytes != null) {
      ImageBag imageBag=ImageProcessorUtil.read(bytes);
      renderedImage=imageBag.getRenderedImage();
    }
    if (renderedImage != null) {
      int height=PrefsPropsUtil.getInteger(PropsKeys.DL_FILE_ENTRY_THUMBNAIL_MAX_HEIGHT);
      int width=PrefsPropsUtil.getInteger(PropsKeys.DL_FILE_ENTRY_THUMBNAIL_MAX_WIDTH);
      RenderedImage thumbnail=ImageProcessorUtil.scale(renderedImage,height,width);
      imageLocalService.updateImage(smallImageId,ImageProcessorUtil.getBytes(thumbnail,contentType));
    }
  }
 catch (  IOException ioe) {
    throw new ImageSizeException(ioe);
  }
}
