{
  User user=userPersistence.findByPrimaryKey(userId);
  DLFileEntry dlFileEntry=dlFileEntryPersistence.findByPrimaryKey(fileEntryId);
  long oldDataRepositoryId=dlFileEntry.getDataRepositoryId();
  validateFile(dlFileEntry.getGroupId(),newFolderId,dlFileEntry.getFileEntryId(),dlFileEntry.getFileName(),dlFileEntry.getTitle());
  dlFileEntry.setFolderId(newFolderId);
  dlFileEntry.setTreePath(dlFileEntry.buildTreePath());
  dlFileEntryPersistence.update(dlFileEntry);
  List<DLFileVersion> dlFileVersions=dlFileVersionPersistence.findByFileEntryId(fileEntryId);
  for (  DLFileVersion dlFileVersion : dlFileVersions) {
    dlFileVersion.setFolderId(newFolderId);
    dlFileVersion.setTreePath(dlFileVersion.buildTreePath());
    dlFileVersion.setStatusByUserId(userId);
    dlFileVersion.setStatusByUserName(user.getFullName());
    dlFileVersionPersistence.update(dlFileVersion);
  }
  if (newFolderId != DLFolderConstants.DEFAULT_PARENT_FOLDER_ID) {
    DLFolder dlFolder=dlFolderPersistence.findByPrimaryKey(newFolderId);
    dlFolder.setModifiedDate(serviceContext.getModifiedDate(null));
    dlFolderPersistence.update(dlFolder);
  }
  DLStoreUtil.updateFile(user.getCompanyId(),oldDataRepositoryId,dlFileEntry.getDataRepositoryId(),dlFileEntry.getName());
  return dlFileEntry;
}
