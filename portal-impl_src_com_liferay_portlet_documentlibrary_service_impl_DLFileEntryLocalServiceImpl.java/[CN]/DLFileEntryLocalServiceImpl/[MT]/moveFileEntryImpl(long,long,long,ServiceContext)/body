{
  User user=userPersistence.findByPrimaryKey(userId);
  DLFileEntry dlFileEntry=dlFileEntryPersistence.findByPrimaryKey(fileEntryId);
  long oldFileEntryId=dlFileEntry.getFileEntryId();
  if (dlLocalService.hasFile(user.getCompanyId(),DLFolderConstants.getDataRepositoryId(dlFileEntry.getGroupId(),newFolderId),dlFileEntry.getName(),StringPool.BLANK)) {
    throw new DuplicateFileException(dlFileEntry.getName());
  }
  Date now=new Date();
  long newFileEntryId=counterLocalService.increment();
  DLFileEntry newDLFileEntry=dlFileEntryPersistence.create(newFileEntryId);
  newDLFileEntry.setUuid(dlFileEntry.getUuid());
  newDLFileEntry.setGroupId(dlFileEntry.getGroupId());
  newDLFileEntry.setCompanyId(dlFileEntry.getCompanyId());
  newDLFileEntry.setUserId(dlFileEntry.getUserId());
  newDLFileEntry.setUserName(dlFileEntry.getUserName());
  newDLFileEntry.setVersionUserId(dlFileEntry.getVersionUserId());
  newDLFileEntry.setVersionUserName(dlFileEntry.getVersionUserName());
  newDLFileEntry.setCreateDate(dlFileEntry.getCreateDate());
  newDLFileEntry.setModifiedDate(dlFileEntry.getModifiedDate());
  newDLFileEntry.setRepositoryId(dlFileEntry.getRepositoryId());
  newDLFileEntry.setFolderId(newFolderId);
  newDLFileEntry.setName(dlFileEntry.getName());
  newDLFileEntry.setExtension(dlFileEntry.getExtension());
  newDLFileEntry.setTitle(dlFileEntry.getTitle());
  newDLFileEntry.setDescription(dlFileEntry.getDescription());
  newDLFileEntry.setExtraSettings(dlFileEntry.getExtraSettings());
  newDLFileEntry.setVersion(dlFileEntry.getVersion());
  newDLFileEntry.setSize(dlFileEntry.getSize());
  newDLFileEntry.setReadCount(dlFileEntry.getReadCount());
  dlFileEntryPersistence.remove(dlFileEntry);
  dlFileEntryPersistence.update(newDLFileEntry,false);
  workflowInstanceLinkLocalService.updateClassPK(dlFileEntry.getCompanyId(),dlFileEntry.getGroupId(),DLFileEntry.class.getName(),oldFileEntryId,newFileEntryId);
  List<DLFileVersion> dlFileVersions=dlFileVersionPersistence.findByFileEntryId(oldFileEntryId);
  for (  DLFileVersion dlFileVersion : dlFileVersions) {
    long newFileVersionId=counterLocalService.increment();
    DLFileVersion newDLFileVersion=dlFileVersionPersistence.create(newFileVersionId);
    newDLFileVersion.setGroupId(dlFileVersion.getGroupId());
    newDLFileVersion.setCompanyId(dlFileVersion.getCompanyId());
    newDLFileVersion.setUserId(dlFileVersion.getUserId());
    newDLFileVersion.setUserName(dlFileVersion.getUserName());
    newDLFileVersion.setCreateDate(dlFileVersion.getCreateDate());
    newDLFileVersion.setFileEntryId(newFileEntryId);
    newDLFileVersion.setExtension(dlFileVersion.getExtension());
    newDLFileVersion.setTitle(dlFileVersion.getTitle());
    newDLFileVersion.setDescription(dlFileVersion.getDescription());
    newDLFileVersion.setChangeLog(dlFileVersion.getChangeLog());
    newDLFileVersion.setExtraSettings(dlFileVersion.getExtraSettings());
    newDLFileVersion.setVersion(dlFileVersion.getVersion());
    newDLFileVersion.setSize(dlFileVersion.getSize());
    newDLFileVersion.setStatus(dlFileVersion.getStatus());
    newDLFileVersion.setStatusByUserId(userId);
    newDLFileVersion.setStatusByUserName(user.getFullName());
    newDLFileVersion.setStatusDate(serviceContext.getModifiedDate(now));
    ExpandoBridge newDLFileVersionExpandoBridge=newDLFileVersion.getExpandoBridge();
    ExpandoBridge dlFileVersionExpandoBridge=dlFileVersion.getExpandoBridge();
    newDLFileVersionExpandoBridge.setAttributes(dlFileVersionExpandoBridge.getAttributes());
    dlFileVersionPersistence.update(newDLFileVersion,false);
    dlFileVersionPersistence.remove(dlFileVersion);
  }
  resourceLocalService.updateResources(dlFileEntry.getCompanyId(),DLFileEntry.class.getName(),ResourceConstants.SCOPE_INDIVIDUAL,String.valueOf(dlFileEntry.getFileEntryId()),String.valueOf(newFileEntryId));
  expandoValueLocalService.deleteValues(DLFileEntry.class.getName(),dlFileEntry.getFileEntryId());
  dlAppHelperLocalService.moveFileEntry(oldFileEntryId,newFileEntryId);
  dlLocalService.updateFile(user.getCompanyId(),PortletKeys.DOCUMENT_LIBRARY,newDLFileEntry.getGroupId(),dlFileEntry.getDataRepositoryId(),newDLFileEntry.getDataRepositoryId(),dlFileEntry.getName(),newFileEntryId);
  return newDLFileEntry;
}
