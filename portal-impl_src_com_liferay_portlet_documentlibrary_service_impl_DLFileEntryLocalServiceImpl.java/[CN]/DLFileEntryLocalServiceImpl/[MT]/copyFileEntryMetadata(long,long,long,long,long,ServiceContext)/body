{
  Map<String,Fields> fieldsMap=new HashMap<String,Fields>();
  List<DDMStructure> ddmStructures=null;
  if (fileEntryTypeId > 0) {
    DLFileEntryType dlFileEntryType=dlFileEntryTypeLocalService.getFileEntryType(fileEntryTypeId);
    ddmStructures=dlFileEntryType.getDDMStructures();
    for (    DDMStructure ddmStructure : ddmStructures) {
      long ddmStructureId=ddmStructure.getStructureId();
      try {
        DLFileEntryMetadata dlFileEntryMetadata=dlFileEntryMetadataLocalService.getFileEntryMetadata(ddmStructureId,fromFileVersionId);
        Fields fields=StorageEngineUtil.getFields(ddmStructureId,dlFileEntryMetadata.getDDMStorageId());
        fieldsMap.put(ddmStructure.getStructureKey(),fields);
      }
 catch (      NoSuchFileEntryMetadataException nsfeme) {
      }
    }
    dlFileEntryMetadataLocalService.updateFileEntryMetadata(companyId,ddmStructures,fileEntryTypeId,fileEntryId,toFileVersionId,fieldsMap,serviceContext);
  }
  long classNameId=PortalUtil.getClassNameId(DLFileEntry.class);
  ddmStructures=ddmStructureLocalService.getClassStructures(classNameId);
  for (  DDMStructure ddmStructure : ddmStructures) {
    long ddmStructureId=ddmStructure.getStructureId();
    try {
      DLFileEntryMetadata fileEntryMetadata=dlFileEntryMetadataLocalService.getFileEntryMetadata(ddmStructureId,fromFileVersionId);
      Fields fields=StorageEngineUtil.getFields(ddmStructureId,fileEntryMetadata.getDDMStorageId());
      fieldsMap.put(ddmStructure.getStructureKey(),fields);
    }
 catch (    NoSuchFileEntryMetadataException nsfme) {
    }
  }
  dlFileEntryMetadataLocalService.updateFileEntryMetadata(companyId,ddmStructures,fileEntryTypeId,fileEntryId,toFileVersionId,fieldsMap,serviceContext);
}
