{
  DLFileEntry dlFileEntry=dlFileEntryPersistence.findByPrimaryKey(fileEntryId);
  boolean hasLock=hasFileEntryLock(userId,fileEntryId);
  if (!hasLock) {
    if ((expirationTime <= 0) || (expirationTime > DLFileEntryImpl.LOCK_EXPIRATION_TIME)) {
      expirationTime=DLFileEntryImpl.LOCK_EXPIRATION_TIME;
    }
    lockLocalService.lock(userId,DLFileEntry.class.getName(),fileEntryId,owner,false,expirationTime);
  }
  User user=userPersistence.findByPrimaryKey(userId);
  dlFileEntryPersistence.update(dlFileEntry,false);
  DLFileVersion dlFileVersion=dlFileVersionLocalService.getLatestFileVersion(fileEntryId,false);
  long dlFileVersionId=dlFileVersion.getFileVersionId();
  String version=dlFileVersion.getVersion();
  if (!version.equals(DLFileEntryConstants.PRIVATE_WORKING_COPY_VERSION)) {
    ServiceContext serviceContext=new ServiceContext();
    serviceContext.setCompanyId(user.getCompanyId());
    serviceContext.setUserId(userId);
    dlFileVersion=addFileVersion(user,dlFileEntry,new Date(),dlFileVersion.getExtension(),dlFileVersion.getMimeType(),dlFileVersion.getTitle(),dlFileVersion.getDescription(),dlFileVersion.getChangeLog(),dlFileVersion.getExtraSettings(),dlFileVersion.getFileEntryTypeId(),null,DLFileEntryConstants.PRIVATE_WORKING_COPY_VERSION,dlFileVersion.getSize(),WorkflowConstants.STATUS_DRAFT,serviceContext);
    try {
      DLStoreUtil.deleteFile(dlFileEntry.getCompanyId(),dlFileEntry.getDataRepositoryId(),dlFileEntry.getName(),DLFileEntryConstants.PRIVATE_WORKING_COPY_VERSION);
    }
 catch (    NoSuchFileException nsfe) {
    }
    DLStoreUtil.copyFileVersion(user.getCompanyId(),dlFileEntry.getDataRepositoryId(),dlFileEntry.getName(),version,DLFileEntryConstants.PRIVATE_WORKING_COPY_VERSION);
    copyFileEntryMetadata(dlFileEntry.getCompanyId(),dlFileVersion.getFileEntryTypeId(),fileEntryId,dlFileVersionId,dlFileVersion.getFileVersionId(),serviceContext);
    index(dlFileEntry,serviceContext);
  }
  return dlFileEntry;
}
