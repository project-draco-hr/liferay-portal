{
  User user=UserUtil.findByPrimaryKey(userId);
  folderId=getFolderId(user.getCompanyId(),folderId);
  DLFolder folder=DLFolderUtil.findByPrimaryKey(folderId);
  Date now=new Date();
  if (Validator.isNull(title)) {
    title=name;
  }
  name=getName(name);
  if (is == null) {
    throw new FileSizeException();
  }
  if (DLLocalServiceUtil.hasFile(user.getCompanyId(),folderId,name,0)) {
    throw new DuplicateFileException(name);
  }
  long fileEntryId=CounterLocalServiceUtil.increment();
  DLFileEntry fileEntry=DLFileEntryUtil.create(fileEntryId);
  fileEntry.setCompanyId(user.getCompanyId());
  fileEntry.setUserId(user.getUserId());
  fileEntry.setUserName(user.getFullName());
  fileEntry.setVersionUserId(user.getUserId());
  fileEntry.setVersionUserName(user.getFullName());
  fileEntry.setCreateDate(now);
  fileEntry.setModifiedDate(now);
  fileEntry.setFolderId(folderId);
  fileEntry.setName(name);
  fileEntry.setTitle(title);
  fileEntry.setDescription(description);
  fileEntry.setVersion(DLFileEntryImpl.DEFAULT_VERSION);
  fileEntry.setSize((int)size);
  fileEntry.setReadCount(DLFileEntryImpl.DEFAULT_READ_COUNT);
  fileEntry.setExtraSettings(extraSettings);
  DLFileEntryUtil.update(fileEntry);
  DLLocalServiceUtil.addFile(user.getCompanyId(),PortletKeys.DOCUMENT_LIBRARY,folder.getGroupId(),folderId,name,is);
  if ((addCommunityPermissions != null) && (addGuestPermissions != null)) {
    addFileEntryResources(folder,fileEntry,addCommunityPermissions.booleanValue(),addGuestPermissions.booleanValue());
  }
 else {
    addFileEntryResources(folder,fileEntry,communityPermissions,guestPermissions);
  }
  updateAsset(fileEntry,tagsEntries);
  folder.setLastPostDate(fileEntry.getModifiedDate());
  DLFolderUtil.update(folder);
  return fileEntry;
}
