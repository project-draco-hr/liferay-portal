{
  User user=userPersistence.findByPrimaryKey(userId);
  Date now=new Date();
  if (Validator.isNull(title)) {
    title=sourceFileName;
    if (Validator.isNull(title)) {
      title=name;
    }
  }
  DLFileEntry fileEntry=dlFileEntryPersistence.findByG_F_N(groupId,folderId,name);
  title=getTitle(fileEntry.getTitle(),title);
  validate(groupId,folderId,newFolderId,name,title,sourceFileName,is);
  fileEntry.setTitle(title);
  fileEntry.setDescription(description);
  fileEntry.setExtraSettings(extraSettings);
  dlFileEntryPersistence.update(fileEntry,false);
  if (folderId != newFolderId) {
    long oldFileEntryId=fileEntry.getFileEntryId();
    if (dlLocalService.hasFile(user.getCompanyId(),getRepositoryId(groupId,newFolderId),name,0)) {
      throw new DuplicateFileException(name);
    }
    long newFileEntryId=counterLocalService.increment();
    DLFileEntry newFileEntry=dlFileEntryPersistence.create(newFileEntryId);
    newFileEntry.setGroupId(fileEntry.getGroupId());
    newFileEntry.setCompanyId(fileEntry.getCompanyId());
    newFileEntry.setUserId(fileEntry.getUserId());
    newFileEntry.setUserName(fileEntry.getUserName());
    newFileEntry.setVersionUserId(fileEntry.getVersionUserId());
    newFileEntry.setVersionUserName(fileEntry.getVersionUserName());
    newFileEntry.setCreateDate(fileEntry.getCreateDate());
    newFileEntry.setModifiedDate(fileEntry.getModifiedDate());
    newFileEntry.setFolderId(newFolderId);
    newFileEntry.setName(name);
    newFileEntry.setTitle(fileEntry.getTitle());
    newFileEntry.setDescription(fileEntry.getDescription());
    newFileEntry.setVersion(fileEntry.getVersion());
    newFileEntry.setSize(fileEntry.getSize());
    newFileEntry.setReadCount(fileEntry.getReadCount());
    newFileEntry.setExtraSettings(extraSettings);
    dlFileEntryPersistence.update(newFileEntry,false);
    dlFileEntryPersistence.remove(fileEntry);
    List<DLFileVersion> fileVersions=dlFileVersionPersistence.findByG_F_N(groupId,folderId,name);
    for (    DLFileVersion fileVersion : fileVersions) {
      long newFileVersionId=counterLocalService.increment();
      DLFileVersion newFileVersion=dlFileVersionPersistence.create(newFileVersionId);
      newFileVersion.setGroupId(fileVersion.getGroupId());
      newFileVersion.setCompanyId(fileVersion.getCompanyId());
      newFileVersion.setUserId(fileVersion.getUserId());
      newFileVersion.setUserName(fileVersion.getUserName());
      newFileVersion.setCreateDate(fileVersion.getCreateDate());
      newFileVersion.setFolderId(newFolderId);
      newFileVersion.setName(name);
      newFileVersion.setVersion(fileVersion.getVersion());
      newFileVersion.setSize(fileVersion.getSize());
      newFileVersion.setStatus(fileVersion.getStatus());
      newFileVersion.setStatusByUserId(userId);
      newFileVersion.setStatusByUserName(user.getFullName());
      newFileVersion.setStatusDate(now);
      dlFileVersionPersistence.update(newFileVersion,false);
      dlFileVersionPersistence.remove(fileVersion);
    }
    dlFileShortcutLocalService.updateFileShortcuts(groupId,folderId,name,newFolderId,name);
    Resource resource=resourceLocalService.getResource(fileEntry.getCompanyId(),DLFileEntry.class.getName(),ResourceConstants.SCOPE_INDIVIDUAL,String.valueOf(fileEntry.getPrimaryKey()));
    resource.setPrimKey(String.valueOf(newFileEntryId));
    resourcePersistence.update(resource,false);
    assetEntryLocalService.deleteEntry(DLFileEntry.class.getName(),fileEntry.getFileEntryId());
    List<DLFileShortcut> fileShortcuts=dlFileShortcutPersistence.findByG_TF_TN(groupId,folderId,name);
    for (    DLFileShortcut fileShortcut : fileShortcuts) {
      assetEntryLocalService.deleteEntry(DLFileShortcut.class.getName(),fileShortcut.getFileShortcutId());
    }
    expandoValueLocalService.deleteValues(DLFileEntry.class.getName(),fileEntry.getFileEntryId());
    long repositoryId=getRepositoryId(groupId,folderId);
    long newRepositoryId=getRepositoryId(groupId,newFolderId);
    dlService.updateFile(user.getCompanyId(),PortletKeys.DOCUMENT_LIBRARY,newFileEntry.getGroupId(),repositoryId,newRepositoryId,name,newFileEntryId);
    RatingsStats stats=ratingsStatsLocalService.getStats(DLFileEntry.class.getName(),oldFileEntryId);
    stats.setClassPK(newFileEntryId);
    ratingsStatsPersistence.update(stats,false);
    long classNameId=PortalUtil.getClassNameId(DLFileEntry.class.getName());
    List<RatingsEntry> entries=ratingsEntryPersistence.findByC_C(classNameId,oldFileEntryId);
    for (    RatingsEntry entry : entries) {
      entry.setClassPK(newFileEntryId);
      ratingsEntryPersistence.update(entry,false);
    }
    MBDiscussion discussion=mbDiscussionPersistence.fetchByC_C(classNameId,oldFileEntryId);
    if (discussion != null) {
      discussion.setClassPK(newFileEntryId);
      mbDiscussionPersistence.update(discussion,false);
    }
    socialActivityLocalService.deleteActivities(DLFileEntry.class.getName(),fileEntry.getFileEntryId());
    folderId=newFolderId;
    fileEntry=newFileEntry;
  }
  updateAsset(userId,fileEntry,serviceContext.getAssetCategoryIds(),serviceContext.getAssetTagNames());
  ExpandoBridge expandoBridge=fileEntry.getExpandoBridge();
  expandoBridge.setAttributes(serviceContext);
  socialActivityLocalService.addActivity(userId,fileEntry.getGroupId(),DLFileEntry.class.getName(),fileEntry.getFileEntryId(),DLActivityKeys.UPDATE_FILE_ENTRY,StringPool.BLANK,0);
  double oldVersion=Math.max(fileEntry.getVersion(),fileEntry.getPendingVersion());
  double newVersion=MathUtil.format(oldVersion + 0.1,1,1);
  if (is == null) {
    long repositoryId=getRepositoryId(groupId,folderId);
    fileEntry.setVersion(newVersion);
    dlFileEntryPersistence.update(fileEntry,false);
    is=dlLocalService.getFileAsStream(user.getCompanyId(),repositoryId,name);
    dlLocalService.updateFile(user.getCompanyId(),PortletKeys.DOCUMENT_LIBRARY,fileEntry.getGroupId(),repositoryId,name,false,newVersion,name,fileEntry.getFileEntryId(),fileEntry.getLuceneProperties(),fileEntry.getModifiedDate(),serviceContext,is);
    return fileEntry;
  }
  addFileVersion(user,fileEntry,newVersion,serviceContext.getStatus());
  fileEntry.setVersionUserId(user.getUserId());
  fileEntry.setVersionUserName(user.getFullName());
  fileEntry.setModifiedDate(new Date());
  fileEntry.setVersion(newVersion);
  fileEntry.setSize((int)size);
  dlFileEntryPersistence.update(fileEntry,false);
  long repositoryId=getRepositoryId(groupId,folderId);
  dlLocalService.updateFile(user.getCompanyId(),PortletKeys.DOCUMENT_LIBRARY,fileEntry.getGroupId(),repositoryId,name,false,newVersion,sourceFileName,fileEntry.getFileEntryId(),fileEntry.getLuceneProperties(),fileEntry.getModifiedDate(),serviceContext,is);
  if (fileEntry.getFolderId() != DLFolderConstants.DEFAULT_PARENT_FOLDER_ID) {
    DLFolder folder=dlFolderPersistence.findByPrimaryKey(fileEntry.getFolderId());
    folder.setLastPostDate(fileEntry.getModifiedDate());
    dlFolderPersistence.update(folder,false);
  }
  return fileEntry;
}
