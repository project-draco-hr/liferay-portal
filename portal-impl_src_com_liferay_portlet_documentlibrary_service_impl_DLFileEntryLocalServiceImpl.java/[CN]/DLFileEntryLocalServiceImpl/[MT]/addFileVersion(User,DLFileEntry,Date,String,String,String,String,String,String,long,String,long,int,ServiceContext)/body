{
  long fileVersionId=counterLocalService.increment();
  DLFileVersion dlFileVersion=dlFileVersionPersistence.create(fileVersionId);
  long versionUserId=dlFileEntry.getVersionUserId();
  if (versionUserId <= 0) {
    versionUserId=dlFileEntry.getUserId();
  }
  String versionUserName=GetterUtil.getString(dlFileEntry.getVersionUserName(),dlFileEntry.getUserName());
  dlFileVersion.setGroupId(dlFileEntry.getGroupId());
  dlFileVersion.setCompanyId(dlFileEntry.getCompanyId());
  dlFileVersion.setUserId(versionUserId);
  dlFileVersion.setUserName(versionUserName);
  dlFileVersion.setCreateDate(modifiedDate);
  dlFileVersion.setRepositoryId(dlFileEntry.getRepositoryId());
  dlFileVersion.setFileEntryId(dlFileEntry.getFileEntryId());
  dlFileVersion.setExtension(extension);
  dlFileVersion.setMimeType(mimeType);
  dlFileVersion.setTitle(title);
  dlFileVersion.setDescription(description);
  dlFileVersion.setChangeLog(changeLog);
  dlFileVersion.setExtraSettings(extraSettings);
  dlFileVersion.setDocumentTypeId(documentTypeId);
  dlFileVersion.setVersion(version);
  dlFileVersion.setSize(size);
  dlFileVersion.setStatus(status);
  dlFileVersion.setStatusByUserId(user.getUserId());
  dlFileVersion.setStatusByUserName(user.getFullName());
  dlFileVersion.setStatusDate(dlFileEntry.getModifiedDate());
  dlFileVersion.setExpandoBridgeAttributes(serviceContext);
  dlFileVersionPersistence.update(dlFileVersion,false);
  Map<String,Fields> fieldsMap=(Map<String,Fields>)serviceContext.getAttribute("fieldsMap");
  if (documentTypeId > 0) {
    dlDocumentMetadataSetLocalService.updateDocumentMetadataSets(documentTypeId,fileVersionId,fieldsMap,serviceContext);
  }
  return dlFileVersion;
}
