{
  User user=userPersistence.findByPrimaryKey(userId);
  DLFileEntry fileEntry=dlFileEntryPersistence.findByPrimaryKey(fileEntryId);
  DLFileVersion fileVersion=dlFileVersionLocalService.getLatestFileVersion(fileEntry.getGroupId(),fileEntry.getFolderId(),fileEntry.getName());
  fileVersion.setStatus(serviceContext.getStatus());
  fileVersion.setStatusByUserId(user.getUserId());
  fileVersion.setStatusByUserName(user.getFullName());
  fileVersion.setStatusDate(new Date());
  if (fileVersion.isApproved() && (DLUtil.compareVersions(fileVersion.getVersion(),DLFileEntryConstants.DEFAULT_VERSION) < 0)) {
    fileVersion.setVersion(DLFileEntryConstants.DEFAULT_VERSION);
  }
  dlFileVersionPersistence.update(fileVersion,false);
  if (fileVersion.isApproved() && (DLUtil.compareVersions(fileEntry.getVersion(),fileVersion.getVersion()) < 0)) {
    fileEntry.setVersion(fileVersion.getVersion());
    fileEntry.setPendingVersion(StringPool.BLANK);
    dlFileEntryPersistence.update(fileEntry,false);
  }
 else   if (!fileVersion.isApproved() && (DLUtil.compareVersions(fileEntry.getVersion(),fileVersion.getVersion()) == 0)) {
    String newVersion=DLFileEntryConstants.DEFAULT_VERSION;
    if (DLUtil.compareVersions(fileVersion.getVersion(),newVersion) > 1) {
      List<DLFileVersion> approvedFileVersions=dlFileVersionPersistence.findByG_F_N_S(fileEntry.getGroupId(),fileEntry.getFolderId(),fileEntry.getName(),StatusConstants.APPROVED);
      if (!approvedFileVersions.isEmpty()) {
        newVersion=approvedFileVersions.get(0).getVersion();
      }
    }
    fileEntry.setPendingVersion(fileVersion.getVersion());
    fileEntry.setVersion(newVersion);
    dlFileEntryPersistence.update(fileEntry,false);
  }
  if (fileVersion.isApproved() && (DLUtil.compareVersions(fileEntry.getVersion(),fileVersion.getVersion()) == 0)) {
    assetEntryLocalService.updateVisible(DLFileEntry.class.getName(),fileEntry.getFileEntryId(),true);
  }
 else   if (Validator.isNull(fileEntry.getVersion())) {
    assetEntryLocalService.updateVisible(DLFileEntry.class.getName(),fileEntry.getFileEntryId(),false);
  }
  if (fileVersion.isApproved() && (DLUtil.compareVersions(fileEntry.getVersion(),fileVersion.getVersion()) == 0)) {
    if (fileVersion.getVersion().equals(DLFileEntryConstants.DEFAULT_VERSION)) {
      socialActivityLocalService.addUniqueActivity(fileVersion.getUserId(),fileVersion.getGroupId(),fileVersion.getCreateDate(),DLFileEntry.class.getName(),fileEntryId,DLActivityKeys.ADD_FILE_ENTRY,StringPool.BLANK,0);
    }
 else {
      socialActivityLocalService.addActivity(fileVersion.getUserId(),fileVersion.getGroupId(),fileVersion.getCreateDate(),DLFileEntry.class.getName(),fileEntryId,DLActivityKeys.UPDATE_FILE_ENTRY,StringPool.BLANK,0);
    }
  }
  Indexer indexer=IndexerRegistryUtil.getIndexer(DLFileEntry.class);
  if (fileVersion.isApproved() && (DLUtil.compareVersions(fileEntry.getVersion(),fileVersion.getVersion()) == 0)) {
    indexer.reindex(fileEntry);
  }
 else   if (Validator.isNull(fileEntry.getVersion())) {
    indexer.delete(fileEntry);
  }
  return fileEntry;
}
