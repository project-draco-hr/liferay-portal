{
  User user=userPersistence.findByPrimaryKey(userId);
  DLFileEntry dlFileEntry=dlFileEntryPersistence.findByPrimaryKey(fileEntryId);
  String extension=(String)serviceContext.getAttribute("extension");
  if (Validator.isNull(extension)) {
    extension=dlFileEntry.getExtension();
  }
  String mimeType=(String)serviceContext.getAttribute("contentType");
  if (Validator.isNull(mimeType)) {
    mimeType=dlFileEntry.getMimeType();
  }
  if (Validator.isNull(title)) {
    title=sourceFileName;
    if (Validator.isNull(title)) {
      title=dlFileEntry.getTitle();
    }
  }
  Long documentTypeId=(Long)serviceContext.getAttribute("documentTypeId");
  if (documentTypeId == null) {
    documentTypeId=0L;
  }
  Date now=new Date();
  validateFile(dlFileEntry.getGroupId(),dlFileEntry.getFolderId(),dlFileEntry.getFileEntryId(),dlFileEntry.getExtension(),title,sourceFileName,is);
  String version=getNextVersion(dlFileEntry,majorVersion,serviceContext.getWorkflowAction());
  DLFileVersion dlFileVersion=null;
  boolean updatedFileVersion=false;
  try {
    DLFileVersion latestDLFileVersion=dlFileEntry.getLatestFileVersion();
    if (size == 0) {
      size=latestDLFileVersion.getSize();
    }
    if (!latestDLFileVersion.isApproved()) {
      if (!PropsValues.DL_FILE_ENTRY_DRAFTS_ENABLED) {
        version=latestDLFileVersion.getVersion();
      }
      if (version.equals(latestDLFileVersion.getVersion())) {
        updatedFileVersion=true;
      }
      if (latestDLFileVersion.isPending()) {
        serviceContext.setWorkflowAction(WorkflowConstants.ACTION_SAVE_DRAFT);
      }
      updateFileVersion(user,latestDLFileVersion,sourceFileName,extension,mimeType,title,description,changeLog,extraSettings,documentTypeId,version,size,latestDLFileVersion.getStatus(),serviceContext.getModifiedDate(now),serviceContext);
    }
 else {
      if (latestDLFileVersion.getSize() == 0) {
        version=latestDLFileVersion.getVersion();
        updateFileVersion(user,latestDLFileVersion,sourceFileName,extension,mimeType,title,description,changeLog,extraSettings,documentTypeId,version,size,latestDLFileVersion.getStatus(),serviceContext.getModifiedDate(now),serviceContext);
      }
 else {
        dlFileVersion=addFileVersion(user,dlFileEntry,serviceContext.getModifiedDate(now),extension,mimeType,title,description,changeLog,extraSettings,documentTypeId,version,size,WorkflowConstants.STATUS_DRAFT,serviceContext);
      }
    }
    if (dlFileVersion == null) {
      dlFileVersion=latestDLFileVersion;
    }
  }
 catch (  NoSuchFileVersionException nsfve) {
    dlFileVersion=addFileVersion(user,dlFileEntry,serviceContext.getModifiedDate(now),extension,mimeType,title,description,changeLog,extraSettings,documentTypeId,version,size,WorkflowConstants.STATUS_DRAFT,serviceContext);
  }
  File file=null;
  if ((is == null) && !updatedFileVersion) {
    int fetchFailures=0;
    while (is == null) {
      try {
        is=dlLocalService.getFileAsStream(user.getCompanyId(),dlFileEntry.getDataRepositoryId(),dlFileEntry.getName());
        file=FileUtil.createTempFile(FileUtil.getExtension(title));
        FileUtil.write(file,is);
      }
 catch (      IOException ioe) {
        throw new SystemException(ioe);
      }
catch (      NoSuchFileException nsfe) {
        fetchFailures++;
        if (PropsValues.DL_HOOK_IMPL.equals(JCRHook.class.getName()) && (fetchFailures < PropsValues.DL_HOOK_JCR_FETCH_MAX_FAILURES)) {
          try {
            Thread.sleep(PropsValues.DL_HOOK_JCR_FETCH_DELAY);
          }
 catch (          InterruptedException ie) {
          }
        }
 else {
          throw nsfe;
        }
      }
    }
  }
  updateAsset(userId,dlFileEntry,dlFileVersion,serviceContext.getAssetCategoryIds(),serviceContext.getAssetTagNames(),serviceContext.getAssetLinkEntryIds());
  if (dlFileEntry.getFolderId() != DLFolderConstants.DEFAULT_PARENT_FOLDER_ID) {
    DLFolder dlFolder=dlFolderPersistence.findByPrimaryKey(dlFileEntry.getFolderId());
    dlFolder.setLastPostDate(dlFileEntry.getModifiedDate());
    dlFolderPersistence.update(dlFolder,false);
  }
  if ((is != null) || (file != null)) {
    try {
      dlLocalService.deleteFile(user.getCompanyId(),PortletKeys.DOCUMENT_LIBRARY,dlFileEntry.getDataRepositoryId(),dlFileEntry.getName(),version);
    }
 catch (    NoSuchFileException nsfe) {
    }
    if (file != null) {
      try {
        is=new FileInputStream(file);
      }
 catch (      IOException ioe) {
        throw new SystemException(ioe);
      }
    }
    dlLocalService.updateFile(user.getCompanyId(),PortletKeys.DOCUMENT_LIBRARY,dlFileEntry.getGroupId(),dlFileEntry.getDataRepositoryId(),dlFileEntry.getName(),dlFileEntry.getExtension(),false,version,sourceFileName,dlFileEntry.getFileEntryId(),dlFileEntry.getLuceneProperties(),dlFileEntry.getModifiedDate(),serviceContext,is);
  }
  if (serviceContext.getWorkflowAction() == WorkflowConstants.ACTION_PUBLISH) {
    WorkflowHandlerRegistryUtil.startWorkflowInstance(user.getCompanyId(),dlFileEntry.getGroupId(),userId,DLFileEntry.class.getName(),dlFileEntry.getFileEntryId(),dlFileEntry,serviceContext);
  }
  return dlFileEntry;
}
