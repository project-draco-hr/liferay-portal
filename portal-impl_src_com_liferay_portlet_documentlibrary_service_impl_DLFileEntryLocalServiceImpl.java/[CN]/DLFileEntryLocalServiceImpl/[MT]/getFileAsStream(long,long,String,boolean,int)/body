{
  DLFileEntry dlFileEntry=dlFileEntryPersistence.findByPrimaryKey(fileEntryId);
  incrementViewCounter(dlFileEntry,incrementCounter,increment);
  dlAppHelperLocalService.getFileAsStream(userId,new LiferayFileEntry(dlFileEntry),incrementCounter);
  InputStream inputStream=DLStoreUtil.getFileAsStream(dlFileEntry.getCompanyId(),dlFileEntry.getDataRepositoryId(),dlFileEntry.getName(),version);
  DB db=DBFactoryUtil.getDB();
  String dbType=db.getType();
  if (dbType.equals(DB.TYPE_POSTGRESQL)) {
    try {
      File tempFile=FileUtil.createTempFile(inputStream);
      inputStream.close();
      inputStream=new FileInputStream(tempFile);
      FinalizeManager.register(inputStream,new DeleteFileFinalizeAction(tempFile.getAbsolutePath()));
    }
 catch (    IOException ioe) {
      throw new SystemException(ioe);
    }
  }
  return inputStream;
}
