{
  long fileVersionId=counterLocalService.increment();
  DLFileVersion dlFileVersion=dlFileVersionPersistence.create(fileVersionId);
  String uuid=ParamUtil.getString(serviceContext,"fileVersionUuid",serviceContext.getUuid());
  dlFileVersion.setUuid(uuid);
  dlFileVersion.setGroupId(dlFileEntry.getGroupId());
  dlFileVersion.setCompanyId(dlFileEntry.getCompanyId());
  dlFileVersion.setUserId(user.getUserId());
  dlFileVersion.setUserName(user.getFullName());
  dlFileVersion.setRepositoryId(dlFileEntry.getRepositoryId());
  dlFileVersion.setFolderId(dlFileEntry.getFolderId());
  dlFileVersion.setFileEntryId(dlFileEntry.getFileEntryId());
  dlFileVersion.setTreePath(dlFileVersion.buildTreePath());
  dlFileVersion.setFileName(fileName);
  dlFileVersion.setExtension(extension);
  dlFileVersion.setMimeType(mimeType);
  dlFileVersion.setTitle(title);
  dlFileVersion.setDescription(description);
  dlFileVersion.setChangeLog(changeLog);
  dlFileVersion.setExtraSettings(extraSettings);
  dlFileVersion.setFileEntryTypeId(fileEntryTypeId);
  dlFileVersion.setVersion(version);
  dlFileVersion.setSize(size);
  dlFileVersion.setStatus(status);
  dlFileVersion.setStatusByUserId(user.getUserId());
  dlFileVersion.setStatusByUserName(user.getFullName());
  dlFileVersion.setStatusDate(dlFileEntry.getModifiedDate());
  ExpandoBridge oldExpandoBridge=dlFileVersion.getExpandoBridge();
  DLFileVersion latestFileVersion=dlFileVersionLocalService.fetchLatestFileVersion(dlFileEntry.getFileEntryId(),false);
  if (latestFileVersion != null) {
    oldExpandoBridge=latestFileVersion.getExpandoBridge();
  }
  ExpandoBridgeUtil.setExpandoBridgeAttributes(oldExpandoBridge,dlFileVersion.getExpandoBridge(),serviceContext);
  dlFileVersionPersistence.update(dlFileVersion);
  if ((fileEntryTypeId > 0) && (ddmFormValuesMap != null)) {
    dlFileEntryMetadataLocalService.updateFileEntryMetadata(fileEntryTypeId,dlFileEntry.getFileEntryId(),fileVersionId,ddmFormValuesMap,serviceContext);
  }
  return dlFileVersion;
}
