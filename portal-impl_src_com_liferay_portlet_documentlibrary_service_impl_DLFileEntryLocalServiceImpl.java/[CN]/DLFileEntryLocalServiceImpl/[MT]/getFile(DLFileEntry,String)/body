{
  File file=null;
  InputStream is=null;
  int fetchFailures=0;
  while (is == null) {
    try {
      is=dlLocalService.getFileAsStream(dlFileEntry.getCompanyId(),dlFileEntry.getDataRepositoryId(),dlFileEntry.getName(),version);
      file=FileUtil.createTempFile(FileUtil.getExtension(dlFileEntry.getTitle()));
      FileUtil.write(file,is);
    }
 catch (    IOException ioe) {
      throw new SystemException(ioe);
    }
catch (    NoSuchFileException nsfe) {
      fetchFailures++;
      if (PropsValues.DL_HOOK_IMPL.equals(JCRHook.class.getName()) && (fetchFailures < PropsValues.DL_HOOK_JCR_FETCH_MAX_FAILURES)) {
        try {
          Thread.sleep(PropsValues.DL_HOOK_JCR_FETCH_DELAY);
        }
 catch (        InterruptedException ie) {
        }
      }
 else {
        throw nsfe;
      }
    }
  }
  return file;
}
