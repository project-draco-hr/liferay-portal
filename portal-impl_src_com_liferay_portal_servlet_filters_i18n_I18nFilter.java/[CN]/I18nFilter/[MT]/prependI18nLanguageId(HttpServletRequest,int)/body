{
  String userLanguageId=null;
  User user=(User)request.getAttribute(WebKeys.USER);
  if (user != null) {
    userLanguageId=user.getLanguageId();
  }
  String guestLanguageId=userLanguageId;
  if (Validator.isNull(guestLanguageId)) {
    guestLanguageId=CookieKeys.getCookie(request,CookieKeys.GUEST_LANGUAGE_ID,false);
  }
  String defaultLanguageId=LocaleUtil.toLanguageId(LocaleUtil.getDefault());
  if (Validator.isNull(guestLanguageId)) {
    guestLanguageId=defaultLanguageId;
  }
  if ((prependFriendlyUrlStyle == 1) || ((prependFriendlyUrlStyle == 3) && Validator.isNull(userLanguageId))) {
    if (!defaultLanguageId.equals(guestLanguageId)) {
      return guestLanguageId;
    }
 else {
      return null;
    }
  }
 else   if (prependFriendlyUrlStyle == 2) {
    return LocaleUtil.toLanguageId(PortalUtil.getLocale(request));
  }
 else   if (prependFriendlyUrlStyle == 3) {
    if (Validator.isNotNull(userLanguageId)) {
      HttpSession session=request.getSession();
      Locale locale=(Locale)session.getAttribute(Globals.LOCALE_KEY);
      if (!userLanguageId.equals(LocaleUtil.toLanguageId(locale))) {
        PortalUtil.addUserLocaleOptionsMessage(request);
        return LocaleUtil.toLanguageId(locale);
      }
 else {
        return null;
      }
    }
  }
  return null;
}
