{
  if (!SPIUtil.isSPI()) {
    return;
  }
  if (request.getAttribute(WebKeys.PORTLET_SESSION) != null) {
    return;
  }
  SPIAgentRequest spiAgentRequest=(SPIAgentRequest)request.getAttribute(WebKeys.SPI_AGENT_REQUEST);
  if (spiAgentRequest == null) {
    return;
  }
  request.setAttribute(WebKeys.PORTLET_SESSION,session);
  Map<String,Serializable> originalSessionAttributes=spiAgentRequest.originalSessionAttributes;
  Map<String,Serializable> portletSessionAttributes=(Map<String,Serializable>)originalSessionAttributes.remove(WebKeys.PORTLET_SESSION_ATTRIBUTES.concat(spiAgentRequest.servletContextName));
  Set<String> sessionAttributeNames=SetUtil.fromEnumeration(session.getAttributeNames());
  if (portletSessionAttributes != null) {
    for (    Map.Entry<String,Serializable> entry : portletSessionAttributes.entrySet()) {
      session.setAttribute(entry.getKey(),entry.getValue());
    }
    sessionAttributeNames.removeAll(portletSessionAttributes.keySet());
  }
  for (  String sessionAttributeName : sessionAttributeNames) {
    session.removeAttribute(sessionAttributeName);
  }
}
