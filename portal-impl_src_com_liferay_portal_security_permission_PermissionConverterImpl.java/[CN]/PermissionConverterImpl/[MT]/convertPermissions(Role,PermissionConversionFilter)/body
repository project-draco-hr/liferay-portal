{
  int[] scopes=new int[0];
  if (role.getType() == RoleConstants.TYPE_REGULAR) {
    scopes=new int[]{ResourceConstants.SCOPE_COMPANY,ResourceConstants.SCOPE_GROUP};
  }
 else   if ((role.getType() == RoleConstants.TYPE_ORGANIZATION) || (role.getType() == RoleConstants.TYPE_PROVIDER) || (role.getType() == RoleConstants.TYPE_SITE)) {
    scopes=new int[]{ResourceConstants.SCOPE_GROUP_TEMPLATE};
  }
  List<Permission> permissions=new ArrayList<>();
  List<ResourcePermission> resourcePermissions=ResourcePermissionLocalServiceUtil.getRoleResourcePermissions(role.getRoleId(),scopes,QueryUtil.ALL_POS,QueryUtil.ALL_POS);
  for (  ResourcePermission resourcePermission : resourcePermissions) {
    if ((permissionConversionFilter != null) && !permissionConversionFilter.accept(role,resourcePermission)) {
      continue;
    }
    List<ResourceAction> resourceActions=ResourceActionLocalServiceUtil.getResourceActions(resourcePermission.getName());
    for (    ResourceAction resourceAction : resourceActions) {
      if (ResourcePermissionLocalServiceUtil.hasActionId(resourcePermission,resourceAction)) {
        Permission permission=new PermissionImpl();
        permission.setName(resourcePermission.getName());
        permission.setScope(resourcePermission.getScope());
        permission.setPrimKey(resourcePermission.getPrimKey());
        permission.setActionId(resourceAction.getActionId());
        permissions.add(permission);
      }
    }
  }
  List<ResourceTypePermission> resourceTypePermissions=ResourceTypePermissionLocalServiceUtil.getRoleResourceTypePermissions(role.getRoleId());
  for (  ResourceTypePermission resourceTypePermission : resourceTypePermissions) {
    if ((permissionConversionFilter != null) && !permissionConversionFilter.accept(role,resourceTypePermission)) {
      continue;
    }
    List<String> actionIds=ResourceBlockLocalServiceUtil.getActionIds(resourceTypePermission.getName(),resourceTypePermission.getActionIds());
    for (    String actionId : actionIds) {
      Permission permission=new PermissionImpl();
      permission.setName(resourceTypePermission.getName());
      if (role.getType() == RoleConstants.TYPE_REGULAR) {
        if (resourceTypePermission.isCompanyScope()) {
          permission.setScope(ResourceConstants.SCOPE_COMPANY);
        }
 else {
          permission.setScope(ResourceConstants.SCOPE_GROUP);
        }
      }
 else {
        permission.setScope(ResourceConstants.SCOPE_GROUP_TEMPLATE);
      }
      permission.setPrimKey(String.valueOf(resourceTypePermission.getGroupId()));
      permission.setActionId(actionId);
      permissions.add(permission);
    }
  }
  return permissions;
}
