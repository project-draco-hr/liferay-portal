{
  Layout layout=addLayout();
  LayoutTypePortlet layoutTypePortlet=(LayoutTypePortlet)layout.getLayoutType();
  Map<Long,String[]> roleIdsToActionIds=new HashMap<>();
  Role role=RoleLocalServiceUtil.getRole(TestPropsValues.getCompanyId(),RoleConstants.GUEST);
  roleIdsToActionIds.put(role.getRoleId(),new String[]{ActionKeys.CONFIGURATION});
  Portlet portlet=null;
  for (  String oldPortletId : _PORTLET_IDS) {
    String portletId=getPortletId(oldPortletId);
    portlet=PortletLocalServiceUtil.getPortletById(TestPropsValues.getCompanyId(),portletId);
    layoutTypePortlet.addPortletId(TestPropsValues.getUserId(),portletId,false);
    addPortletPreferences(layout,portletId);
    String portletPrimaryKey=PortletPermissionUtil.getPrimaryKey(layout.getPlid(),portletId);
    ResourcePermissionLocalServiceUtil.setResourcePermissions(TestPropsValues.getCompanyId(),oldPortletId,ResourceConstants.SCOPE_INDIVIDUAL,portletPrimaryKey,roleIdsToActionIds);
    PortletLocalServiceUtil.destroyPortlet(portlet);
  }
  LayoutLocalServiceUtil.updateLayout(layout.getGroupId(),layout.isPrivateLayout(),layout.getLayoutId(),layout.getTypeSettings());
  upgrade();
  CacheRegistryUtil.clear();
  layout=LayoutLocalServiceUtil.getLayout(layout.getPlid());
  layoutTypePortlet=(LayoutTypePortlet)layout.getLayoutType();
  for (  String portletId : _PORTLET_IDS) {
    String newRootPortletId=portletId;
    if (_testInstanceable) {
      newRootPortletId+="_test";
    }
    String newPortletId=getNewPortletId(layoutTypePortlet,newRootPortletId);
    portlet.setCompanyId(TestPropsValues.getCompanyId());
    portlet.setPortletId(newPortletId);
    List<String> portletActions=ResourceActionsUtil.getPortletResourceActions(newRootPortletId);
    ResourceActionLocalServiceUtil.checkResourceActions(newRootPortletId,portletActions);
    PortletLocalServiceUtil.checkPortlet(portlet);
    Assert.assertTrue(layoutTypePortlet.hasPortletId(newPortletId));
    String portletPrimaryKey=PortletPermissionUtil.getPrimaryKey(layout.getPlid(),newPortletId);
    boolean hasViewPermission=ResourcePermissionLocalServiceUtil.hasResourcePermission(TestPropsValues.getCompanyId(),newRootPortletId,ResourceConstants.SCOPE_INDIVIDUAL,portletPrimaryKey,role.getRoleId(),ActionKeys.VIEW);
    Assert.assertFalse(hasViewPermission);
    boolean hasConfigurationPermission=ResourcePermissionLocalServiceUtil.hasResourcePermission(TestPropsValues.getCompanyId(),newRootPortletId,ResourceConstants.SCOPE_INDIVIDUAL,portletPrimaryKey,role.getRoleId(),ActionKeys.CONFIGURATION);
    Assert.assertTrue(hasConfigurationPermission);
  }
  GroupLocalServiceUtil.deleteGroup(layout.getGroup());
}
