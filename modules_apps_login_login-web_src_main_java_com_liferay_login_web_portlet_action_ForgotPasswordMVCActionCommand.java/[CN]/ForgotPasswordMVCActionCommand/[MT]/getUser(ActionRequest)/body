{
  PortletSession portletSession=actionRequest.getPortletSession();
  ThemeDisplay themeDisplay=(ThemeDisplay)actionRequest.getAttribute(WebKeys.THEME_DISPLAY);
  String sessionEmailAddress=(String)portletSession.getAttribute(WebKeys.FORGOT_PASSWORD_REMINDER_USER_EMAIL_ADDRESS);
  User user=null;
  if (Validator.isNotNull(sessionEmailAddress)) {
    user=UserLocalServiceUtil.getUserByEmailAddress(themeDisplay.getCompanyId(),sessionEmailAddress);
  }
 else {
    long userId=ParamUtil.getLong(actionRequest,"userId");
    String screenName=ParamUtil.getString(actionRequest,"screenName");
    String emailAddress=ParamUtil.getString(actionRequest,"emailAddress");
    if (Validator.isNotNull(emailAddress)) {
      user=UserLocalServiceUtil.getUserByEmailAddress(themeDisplay.getCompanyId(),emailAddress);
    }
 else     if (Validator.isNotNull(screenName)) {
      user=UserLocalServiceUtil.getUserByScreenName(themeDisplay.getCompanyId(),screenName);
    }
 else     if (userId > 0) {
      user=UserLocalServiceUtil.getUserById(userId);
    }
 else {
      throw new NoSuchUserException("User does not exist");
    }
  }
  if (!user.isActive()) {
    throw new UserActiveException("Inactive user " + user.getUuid());
  }
  UserLocalServiceUtil.checkLockout(user);
  return user;
}
