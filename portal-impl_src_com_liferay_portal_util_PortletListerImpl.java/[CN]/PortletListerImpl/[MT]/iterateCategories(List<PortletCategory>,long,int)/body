{
  categories=ListUtil.sort(categories,new PortletCategoryComparator(_user.getLocale()));
  for (int i=0; i < categories.size(); i++) {
    PortletCategory portletCategory=categories.get(i);
    if (portletCategory.isHidden()) {
      continue;
    }
    if (i == 0) {
      depth++;
      if (depth > _depth) {
        _depth=depth;
      }
    }
    TreeNodeView nodeView=new TreeNodeView(++_nodeId);
    nodeView.setDepth(depth);
    nodeView.setLeaf(false);
    if ((i + 1) == categories.size()) {
      nodeView.setLs("1");
    }
 else {
      nodeView.setLs("0");
    }
    nodeView.setName(portletCategory.getName());
    nodeView.setObjId(portletCategory.getPath());
    nodeView.setParentId(parentId);
    _list.add(nodeView);
    int nodeId=_nodeId;
    List<PortletCategory> subCategories=ListUtil.fromCollection(portletCategory.getCategories());
    iterateCategories(subCategories,nodeId,depth);
    if (_iteratePortlets) {
      _iteratePortlets(portletCategory,portletCategory.getPortletIds(),nodeId,depth + 1);
    }
  }
}
