{
  List<Portlet> portlets=new ArrayList<Portlet>();
  String externalPortletCategory=null;
  for (  String portletId : portletIds) {
    Portlet portlet=PortletLocalServiceUtil.getPortletById(_user.getCompanyId(),portletId);
    if (portlet != null) {
      if (portlet.isSystem()) {
      }
 else       if (!portlet.isActive()) {
      }
 else       if (portlet.isInstanceable() && !_includeInstanceablePortlets) {
      }
 else       if (!portlet.isInstanceable() && _layoutTypePortlet.hasPortletId(portlet.getPortletId())) {
        portlets.add(portlet);
      }
 else       if (!portlet.hasAddPortletPermission(_user.getUserId())) {
      }
 else {
        portlets.add(portlet);
      }
      PortletApp portletApp=portlet.getPortletApp();
      if (portletApp.isWARFile() && Validator.isNull(externalPortletCategory)) {
        PortletConfig portletConfig=PortletConfigFactoryUtil.create(portlet,_servletContext);
        ResourceBundle resourceBundle=portletConfig.getResourceBundle(_themeDisplay.getLocale());
        externalPortletCategory=ResourceBundleUtil.getString(resourceBundle,portletCategory.getName());
      }
    }
  }
  portlets=ListUtil.sort(portlets,new PortletTitleComparator(_themeDisplay.getLocale()));
  for (int i=0; i < portlets.size(); i++) {
    Portlet portlet=portlets.get(i);
    TreeNodeView nodeView=new TreeNodeView(++_nodeId);
    nodeView.setDepth(depth);
    nodeView.setLeaf(true);
    if ((i + 1) == portlets.size()) {
      nodeView.setLs("1");
    }
 else {
      nodeView.setLs("0");
    }
    nodeView.setName(PortalUtil.getPortletTitle(portlet,_servletContext,_themeDisplay.getLocale()));
    nodeView.setObjId(portlet.getRootPortletId());
    nodeView.setParentId(parentNodeId);
    _list.add(nodeView);
  }
}
