{
  String html=Html.escape(bbcode);
  html=StringUtil.replace(html,_BBCODE_TAGS,_HTML_TAGS);
  for (int i=0; i < EMOTICONS.length; i++) {
    String imgTag="<img src='" + EMOTICONS[i][0] + "' />";
    html=StringUtil.replace(html,EMOTICONS[i][1],imgTag);
  }
  BBCodeTag tag=null;
  StringMaker sm=null;
  while ((tag=getFirstTag(html,"code")) != null) {
    String preTag=html.substring(0,tag.getStartPos());
    String postTag=html.substring(tag.getEndPos());
    String code=tag.getElement().replaceAll("\t","    ");
    String[] lines=Html.escape(code).split("\\n");
    int digits=Integer.toString(lines.length + 1).length();
    sm=new StringMaker(preTag);
    sm.append("<div class='message-board-code'>");
    for (int i=0; i < lines.length; i++) {
      String index=Integer.toString(i + 1);
      int ld=index.length();
      sm.append("<span class='message-board-code-lines'>");
      for (int j=0; j < digits - ld; j++) {
        sm.append("&nbsp;");
      }
      lines[i]=StringUtil.replace(lines[i],"   ",StringPool.NBSP + StringPool.SPACE + StringPool.NBSP);
      lines[i]=StringUtil.replace(lines[i],"  ",StringPool.NBSP + StringPool.SPACE);
      sm.append(index + "</span>");
      sm.append(lines[i]);
      if (index.length() < lines.length) {
        sm.append("<br />");
      }
    }
    sm.append("</div>");
    sm.append(postTag);
    html=sm.toString();
  }
  while ((tag=getFirstTag(html,"color")) != null) {
    String preTag=html.substring(0,tag.getStartPos());
    String postTag=html.substring(tag.getEndPos());
    sm=new StringMaker(preTag);
    if (tag.hasParameter()) {
      sm.append("<span style='color: ");
      sm.append(tag.getParameter() + ";'>");
      sm.append(tag.getElement() + "</span>");
    }
 else {
      sm.append(tag.getElement());
    }
    sm.append(postTag);
    html=sm.toString();
  }
  while ((tag=getFirstTag(html,"email")) != null) {
    String preTag=html.substring(0,tag.getStartPos());
    String postTag=html.substring(tag.getEndPos());
    String mailto=GetterUtil.getString(tag.getParameter(),tag.getElement().trim());
    sm=new StringMaker(preTag);
    sm.append("<a href='mailto: " + mailto + "'>");
    sm.append(tag.getElement() + "</a>");
    sm.append(postTag);
    html=sm.toString();
  }
  while ((tag=getFirstTag(html,"font")) != null) {
    String preTag=html.substring(0,tag.getStartPos());
    String postTag=html.substring(tag.getEndPos());
    sm=new StringMaker(preTag);
    if (tag.hasParameter()) {
      sm.append("<span style='font-family: ");
      sm.append(tag.getParameter() + "';>");
      sm.append(tag.getElement() + "</span>");
    }
 else {
      sm.append(tag.getElement());
    }
    sm.append(postTag);
    html=sm.toString();
  }
  while ((tag=getFirstTag(html,"img")) != null) {
    String preTag=html.substring(0,tag.getStartPos());
    String postTag=html.substring(tag.getEndPos());
    sm=new StringMaker(preTag);
    sm.append("<img src='" + tag.getElement().trim() + "' />");
    sm.append(postTag);
    html=sm.toString();
  }
  while ((tag=getFirstTag(html,"list")) != null) {
    String preTag=html.substring(0,tag.getStartPos());
    String postTag=html.substring(tag.getEndPos());
    String[] items=StringUtil.split(tag.getElement(),"[*]");
    sm=new StringMaker(preTag);
    if (tag.hasParameter() && listStyles.containsKey(tag.getParameter())) {
      sm.append(listStyles.get(tag.getParameter()));
      for (int i=0; i < items.length; i++) {
        if (items[i].trim().length() > 0) {
          sm.append("<li>" + items[i].trim() + "</li>");
        }
      }
      sm.append("</ol>");
    }
 else {
      sm.append("<ul style='list-style-type: disc';>");
      for (int i=0; i < items.length; i++) {
        if (items[i].trim().length() > 0) {
          sm.append("<li>" + items[i].trim() + "</li>");
        }
      }
      sm.append("</ul>");
    }
    sm.append(postTag);
    html=sm.toString();
  }
  while ((tag=getFirstTag(html,"quote")) != null) {
    String preTag=html.substring(0,tag.getStartPos());
    String postTag=html.substring(tag.getEndPos());
    sm=new StringMaker(preTag);
    if (tag.hasParameter()) {
      sm.append("<div class='message-board-quote-title'>");
      sm.append(tag.getParameter() + ":</div>");
    }
    sm.append("<div class='message-board-quote'>");
    sm.append("<div class='message-board-quote-content'>");
    sm.append(tag.getElement());
    sm.append("</div></div>");
    sm.append(postTag);
    html=sm.toString();
  }
  while ((tag=getFirstTag(html,"size")) != null) {
    String preTag=html.substring(0,tag.getStartPos());
    String postTag=html.substring(tag.getEndPos());
    sm=new StringMaker(preTag);
    if (tag.hasParameter()) {
      Integer size=new Integer(GetterUtil.getInteger(tag.getParameter()));
      if (size.intValue() > 7) {
        size=new Integer(7);
      }
      if (fontSizes.containsKey(size)) {
        sm.append(fontSizes.get(size));
        sm.append(tag.getElement() + "</span>");
      }
 else {
        sm.append(tag.getElement());
      }
    }
 else {
      sm.append(tag.getElement());
    }
    sm.append(postTag);
    html=sm.toString();
  }
  while ((tag=getFirstTag(html,"url")) != null) {
    String preTag=html.substring(0,tag.getStartPos());
    String postTag=html.substring(tag.getEndPos());
    String url=GetterUtil.getString(tag.getParameter(),tag.getElement().trim());
    sm=new StringMaker(preTag);
    sm.append("<a href='" + url + "'>");
    sm.append(tag.getElement() + "</a>");
    sm.append(postTag);
    html=sm.toString();
  }
  html=StringUtil.replace(html,"\n","<br />");
  return html;
}
