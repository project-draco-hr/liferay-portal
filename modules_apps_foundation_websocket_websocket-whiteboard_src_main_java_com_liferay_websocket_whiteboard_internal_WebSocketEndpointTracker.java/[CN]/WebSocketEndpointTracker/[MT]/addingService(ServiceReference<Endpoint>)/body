{
  String path=(String)serviceReference.getProperty("org.osgi.http.websocket.endpoint.path");
  if ((path == null) || path.isEmpty()) {
    return null;
  }
  List<Class<? extends Decoder>> decoders=(List<Class<? extends Decoder>>)serviceReference.getProperty("org.osgi.http.websocket.endpoint.decoders");
  List<Class<? extends Encoder>> encoders=(List<Class<? extends Encoder>>)serviceReference.getProperty("org.osgi.http.websocket.endpoint.encoders");
  List<String> subprotocol=(List<String>)serviceReference.getProperty("org.osgi.http.websocket.endpoint.subprotocol");
  final ServiceObjects<Endpoint> serviceObjects=_bundleContext.getServiceObjects(serviceReference);
  ServerEndpointConfigWrapper serverEndpointConfigWrapper=_serverEndpointConfigWrappers.get(path);
  boolean isNew=false;
  if (serverEndpointConfigWrapper == null) {
    serverEndpointConfigWrapper=new ServerEndpointConfigWrapper(path,decoders,encoders,subprotocol,_logService);
    isNew=true;
  }
  serverEndpointConfigWrapper.setConfigurator(serviceReference,new ServiceObjectsConfigurator(serviceObjects,_logService));
  if (isNew) {
    ServerContainer serverContainer=(ServerContainer)_servletContext.getAttribute(ServerContainer.class.getName());
    try {
      serverContainer.addEndpoint(serverEndpointConfigWrapper);
    }
 catch (    DeploymentException de) {
      Endpoint endpoint=serviceObjects.getService();
      _logService.log(LogService.LOG_ERROR,"Unable to register WebSocket endpoint " + endpoint.getClass() + " for path "+ path,de);
      return null;
    }
    _serverEndpointConfigWrappers.put(path,serverEndpointConfigWrapper);
  }
  return serverEndpointConfigWrapper;
}
