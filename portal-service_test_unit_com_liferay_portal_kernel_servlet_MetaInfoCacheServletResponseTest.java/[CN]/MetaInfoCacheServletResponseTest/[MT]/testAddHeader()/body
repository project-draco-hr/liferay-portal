{
  final List<ObjectValuePair<String,String>> headerList=new ArrayList<ObjectValuePair<String,String>>();
  final AtomicReference<String> contentTypeReference=new AtomicReference<String>();
  StubHttpServletResponse stubHttpServletResponse=new StubHttpServletResponse(){
    @Override public void addHeader(    String name,    String value){
      headerList.add(new ObjectValuePair<String,String>(name,value));
    }
    @Override public boolean isCommitted(){
      return false;
    }
    @Override public void setContentType(    String contentType){
      contentTypeReference.set(contentType);
    }
  }
;
  MetaInfoCacheServletResponse metaInfoCacheServletResponse=new MetaInfoCacheServletResponse(stubHttpServletResponse);
  Map<String,Set<Header>> headers=metaInfoCacheServletResponse.getHeaders();
  assertEquals(0,headers.size());
  metaInfoCacheServletResponse.addHeader(HttpHeaders.CONTENT_TYPE,ContentTypes.TEXT_HTML);
  assertEquals(0,headers.size());
  assertEquals(ContentTypes.TEXT_HTML,metaInfoCacheServletResponse.getContentType());
  assertEquals(ContentTypes.TEXT_HTML,contentTypeReference.get());
  metaInfoCacheServletResponse.addHeader("name1","value1");
  assertEquals(1,headers.size());
  assertTrue(metaInfoCacheServletResponse.containsHeader("name1"));
  Set<Header> headers1=headers.get("name1");
  assertEquals(1,headers1.size());
  assertTrue(headers1.contains(new Header("value1")));
  assertEquals(1,headerList.size());
  assertEquals(new ObjectValuePair<String,String>("name1","value1"),headerList.get(0));
  metaInfoCacheServletResponse.addHeader("name1","value2");
  assertEquals(1,headers.size());
  assertTrue(metaInfoCacheServletResponse.containsHeader("name1"));
  headers1=headers.get("name1");
  assertEquals(2,headers1.size());
  assertTrue(headers1.contains(new Header("value2")));
  assertEquals(2,headerList.size());
  assertEquals(new ObjectValuePair<String,String>("name1","value2"),headerList.get(1));
  metaInfoCacheServletResponse.addHeader("name2","value1");
  assertEquals(2,headers.size());
  assertTrue(metaInfoCacheServletResponse.containsHeader("name2"));
  Set<Header> headers2=headers.get("name2");
  assertEquals(1,headers2.size());
  assertTrue(headers2.contains(new Header("value1")));
  assertEquals(3,headerList.size());
  assertEquals(new ObjectValuePair<String,String>("name2","value1"),headerList.get(2));
}
