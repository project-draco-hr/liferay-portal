{
  ThemeDisplay themeDisplay=(ThemeDisplay)actionRequest.getAttribute(WebKeys.THEME_DISPLAY);
  long recordId=ParamUtil.getLong(actionRequest,"recordId");
  long recordSetId=ParamUtil.getLong(actionRequest,"recordSetId");
  boolean majorVersion=ParamUtil.getBoolean(actionRequest,"majorVersion");
  DDLRecordSet recordSet=DDLRecordSetLocalServiceUtil.getRecordSet(recordSetId);
  DDMStructure ddmStructure=recordSet.getDDMStructure();
  Set<String> fieldNames=ddmStructure.getFieldNames();
  DDLRecord record=DDLRecordLocalServiceUtil.fetchByPrimaryKey(recordId);
  Fields fields=new Fields();
  for (  String fieldName : fieldNames) {
    String fieldDataType=ddmStructure.getFieldDataType(fieldName);
    String fieldValue=ParamUtil.getString(actionRequest,fieldName);
    if (fieldDataType.equals(FieldConstants.DOCUMENT_LIBRARY)) {
      UploadPortletRequest uploadPortletRequest=PortalUtil.getUploadPortletRequest(actionRequest);
      File file=uploadPortletRequest.getFile(fieldName);
      if (file != null) {
        JSONObject fileJSONObject=null;
        if (record != null) {
          String oldFieldValue=String.valueOf(record.getFieldValue(fieldName));
          fileJSONObject=JSONFactoryUtil.createJSONObject(oldFieldValue);
        }
        ServiceContext serviceContext=ServiceContextFactory.getInstance(DLFileEntry.class.getName(),actionRequest);
        FileEntry fileEntry=DDLUtil.uploadFieldFile(ddmStructure,fieldName,fileJSONObject,uploadPortletRequest,serviceContext);
        JSONObject recordFileEntryJSONObject=DDLUtil.getRecordFileJSONObject(fileEntry);
        fieldValue=recordFileEntryJSONObject.toString();
      }
    }
    Serializable fieldValueSerializable=FieldConstants.getSerializable(fieldDataType,fieldValue);
    Field field=new Field(ddmStructure.getStructureId(),fieldName,fieldValueSerializable);
    fields.put(field);
  }
  ServiceContext serviceContext=ServiceContextFactory.getInstance(DDLRecord.class.getName(),actionRequest);
  if (record != null) {
    record=DDLRecordServiceUtil.updateRecord(recordId,majorVersion,DDLRecordConstants.DISPLAY_INDEX_DEFAULT,fields,false,serviceContext);
  }
 else {
    record=DDLRecordServiceUtil.addRecord(themeDisplay.getScopeGroupId(),recordSetId,DDLRecordConstants.DISPLAY_INDEX_DEFAULT,fields,serviceContext);
  }
  return record;
}
