{
  if (_closed) {
    throw new IOException("Stream closed");
  }
  if (length <= 0) {
    return 0;
  }
  bufferLock.lock();
  try {
    if (waitUntilNotEmpty()) {
      return -1;
    }
    int read=length;
    if (length > count) {
      read=count;
    }
    if ((buffer.length - readIndex) >= read) {
      System.arraycopy(buffer,readIndex,chars,offset,read);
    }
 else {
      int tailLength=buffer.length - readIndex;
      int headLength=read - tailLength;
      System.arraycopy(buffer,readIndex,chars,offset,tailLength);
      System.arraycopy(buffer,0,chars,offset + tailLength,headLength);
    }
    increaseReadIndex(read);
    return read;
  }
  finally {
    bufferLock.unlock();
  }
}
