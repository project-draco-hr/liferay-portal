{
  ThemeDisplay themeDisplay=(ThemeDisplay)actionRequest.getAttribute(WebKeys.THEME_DISPLAY);
  PermissionChecker permissionChecker=themeDisplay.getPermissionChecker();
  boolean exportAllUsers=PortalPermissionUtil.contains(permissionChecker,ActionKeys.EXPORT_USER);
  if (!exportAllUsers && !PortletPermissionUtil.contains(permissionChecker,PortletKeys.USERS_ADMIN,ActionKeys.EXPORT_USER)) {
    return Collections.emptyList();
  }
  PortletURL portletURL=((ActionResponseImpl)actionResponse).createRenderURL(PortletKeys.USERS_ADMIN);
  UserSearch userSearch=new UserSearch(actionRequest,portletURL);
  UserSearchTerms searchTerms=(UserSearchTerms)userSearch.getSearchTerms();
  searchTerms.setStatus(WorkflowConstants.STATUS_APPROVED);
  LinkedHashMap<String,Object> params=new LinkedHashMap<String,Object>();
  long organizationId=searchTerms.getOrganizationId();
  if (organizationId > 0) {
    params.put("usersOrgs",new Long(organizationId));
  }
 else   if (!exportAllUsers) {
    User user=themeDisplay.getUser();
    Long[] organizationIds=ArrayUtil.toArray(user.getOrganizationIds(true));
    if (organizationIds.length > 0) {
      params.put("usersOrgs",organizationIds);
    }
  }
  long roleId=searchTerms.getRoleId();
  if (roleId > 0) {
    params.put("usersRoles",new Long(roleId));
  }
  long userGroupId=searchTerms.getUserGroupId();
  if (userGroupId > 0) {
    params.put("usersUserGroups",new Long(userGroupId));
  }
  if (PropsValues.USERS_INDEXER_ENABLED && PropsValues.USERS_SEARCH_WITH_INDEX) {
    params.put("expandoAttributes",searchTerms.getKeywords());
    Hits hits=null;
    if (searchTerms.isAdvancedSearch()) {
      hits=UserLocalServiceUtil.search(themeDisplay.getCompanyId(),searchTerms.getFirstName(),searchTerms.getMiddleName(),searchTerms.getLastName(),searchTerms.getScreenName(),searchTerms.getEmailAddress(),searchTerms.getStatus(),params,searchTerms.isAndOperator(),QueryUtil.ALL_POS,QueryUtil.ALL_POS,(Sort)null);
    }
 else {
      hits=UserLocalServiceUtil.search(themeDisplay.getCompanyId(),searchTerms.getKeywords(),searchTerms.getStatus(),params,QueryUtil.ALL_POS,QueryUtil.ALL_POS,(Sort)null);
    }
    Tuple tuple=UsersAdminUtil.getUsers(hits);
    return (List<User>)tuple.getObject(0);
  }
 else {
    if (searchTerms.isAdvancedSearch())     return UserLocalServiceUtil.search(themeDisplay.getCompanyId(),searchTerms.getFirstName(),searchTerms.getMiddleName(),searchTerms.getLastName(),searchTerms.getScreenName(),searchTerms.getEmailAddress(),searchTerms.getStatus(),params,searchTerms.isAndOperator(),QueryUtil.ALL_POS,QueryUtil.ALL_POS,(OrderByComparator)null);
 else {
      return UserLocalServiceUtil.search(themeDisplay.getCompanyId(),searchTerms.getKeywords(),searchTerms.getStatus(),params,QueryUtil.ALL_POS,QueryUtil.ALL_POS,(OrderByComparator)null);
    }
  }
}
