{
  byte[] newByteArray=new byte[oldByteArray.length];
  int newByteArrayPos=0;
  int state=_STATE_NORMAL;
  boolean removeStartingWhitespace=true;
  ByteArrayMaker scriptBytes=new ByteArrayMaker();
  ByteArrayMaker styleBytes=new ByteArrayMaker();
  for (int i=0; i < oldByteArray.length; i++) {
    byte b=oldByteArray[i];
    char c=(char)b;
    if (c == CharPool.LESS_THAN) {
      if (state == _STATE_NORMAL) {
        if (hasMarker(oldByteArray,i,_MARKER_PRE_OPEN) || hasMarker(oldByteArray,i,_MARKER_TEXTAREA_OPEN)) {
          state=_STATE_IGNORE;
        }
 else         if (hasMarker(oldByteArray,i,_MARKER_DIV_CLOSE) || hasMarker(oldByteArray,i,_MARKER_FORM_CLOSE) || hasMarker(oldByteArray,i,_MARKER_LI_CLOSE)|| hasMarker(oldByteArray,i,_MARKER_SCRIPT_CLOSE)|| hasMarker(oldByteArray,i,_MARKER_STYLE_CLOSE)|| hasMarker(oldByteArray,i,_MARKER_TABLE_CLOSE)|| hasMarker(oldByteArray,i,_MARKER_TD_CLOSE)|| hasMarker(oldByteArray,i,_MARKER_TD_OPEN)|| hasMarker(oldByteArray,i,_MARKER_TR_CLOSE)|| hasMarker(oldByteArray,i,_MARKER_TR_OPEN)|| hasMarker(oldByteArray,i,_MARKER_UL_CLOSE)) {
          state=_STATE_FOUND_ELEMENT;
        }
 else         if (hasMarker(oldByteArray,i,_MARKER_JAVASCRIPT_OPEN) || hasMarker(oldByteArray,i,_MARKER_SCRIPT_OPEN)) {
          state=_STATE_MINIFY_SCRIPT;
        }
 else         if (hasMarker(oldByteArray,i,_MARKER_STYLE_OPEN)) {
          state=_STATE_MINIFY_STYLE;
        }
      }
 else       if (state == _STATE_IGNORE) {
        if (hasMarker(oldByteArray,i,_MARKER_PRE_CLOSE) || hasMarker(oldByteArray,i,_MARKER_TEXTAREA_CLOSE)) {
          state=_STATE_NORMAL;
        }
      }
 else       if (state == _STATE_MINIFY_SCRIPT) {
        if (hasMarker(oldByteArray,i,_MARKER_SCRIPT_CLOSE)) {
          state=_STATE_NORMAL;
          String scriptContent=scriptBytes.toString(StringPool.UTF8);
          scriptBytes=new ByteArrayMaker();
          int pos=scriptContent.indexOf(CharPool.GREATER_THAN);
          scriptContent=scriptContent.substring(pos + 1).trim();
          if (Validator.isNull(scriptContent)) {
            i+=_MARKER_SCRIPT_CLOSE.length;
            continue;
          }
          scriptContent="/*<![CDATA[*/" + MinifierUtil.minifyJavaScript(scriptContent) + "/*]]>*/";
          if (Validator.isNull(scriptContent)) {
            i+=_MARKER_SCRIPT_CLOSE.length;
            continue;
          }
          scriptContent=_SCRIPT_TYPE_JAVASCRIPT + scriptContent;
          byte[] scriptContentBytes=scriptContent.getBytes(StringPool.UTF8);
          for (          byte curByte : scriptContentBytes) {
            newByteArray[newByteArrayPos++]=curByte;
          }
          state=_STATE_FOUND_ELEMENT;
        }
      }
 else       if (state == _STATE_MINIFY_STYLE) {
        if (hasMarker(oldByteArray,i,_MARKER_STYLE_CLOSE)) {
          state=_STATE_NORMAL;
          String styleContent=styleBytes.toString(StringPool.UTF8);
          styleBytes=new ByteArrayMaker();
          styleContent=styleContent.substring(_STYLE_TYPE_CSS.length()).trim();
          if (Validator.isNull(styleContent)) {
            i+=_MARKER_STYLE_CLOSE.length;
            continue;
          }
          styleContent=MinifierUtil.minifyCss(styleContent);
          if (Validator.isNull(styleContent)) {
            i+=_MARKER_STYLE_CLOSE.length;
            continue;
          }
          styleContent=_STYLE_TYPE_CSS + styleContent;
          byte[] styleContentBytes=styleContent.getBytes(StringPool.UTF8);
          for (          byte curByte : styleContentBytes) {
            newByteArray[newByteArrayPos++]=curByte;
          }
          state=_STATE_FOUND_ELEMENT;
        }
      }
    }
 else     if (c == CharPool.GREATER_THAN) {
      if (state == _STATE_FOUND_ELEMENT) {
        state=_STATE_NORMAL;
        newByteArray[newByteArrayPos++]=b;
        while ((i + 1) < oldByteArray.length) {
          char nextChar=(char)oldByteArray[i + 1];
          if (Validator.isWhitespace(nextChar)) {
            i++;
          }
 else {
            break;
          }
        }
        continue;
      }
    }
    if (state == _STATE_NORMAL) {
      if ((i + 1) < oldByteArray.length) {
        if (removeStartingWhitespace) {
          if (Validator.isWhitespace(c)) {
            continue;
          }
 else {
            removeStartingWhitespace=false;
          }
        }
        if ((c == CharPool.NEW_LINE) || (c == CharPool.RETURN) || (c == CharPool.TAB)) {
          char nextChar=(char)oldByteArray[i + 1];
          if ((nextChar == CharPool.NEW_LINE) || (nextChar == CharPool.RETURN) || (nextChar == CharPool.TAB)) {
            continue;
          }
        }
      }
    }
    if (state == _STATE_MINIFY_SCRIPT) {
      scriptBytes.write(b);
    }
 else     if (state == _STATE_MINIFY_STYLE) {
      styleBytes.write(b);
    }
 else {
      newByteArray[newByteArrayPos++]=b;
    }
  }
  if (newByteArrayPos > 1) {
    for (int i=newByteArrayPos - 1; i > 0; i--) {
      byte b=newByteArray[i];
      char c=(char)b;
      if (Validator.isWhitespace(c)) {
        newByteArrayPos--;
      }
 else {
        break;
      }
    }
  }
  if (state == _STATE_MINIFY_SCRIPT) {
    _log.error("Missing </script>");
  }
 else   if (state == _STATE_MINIFY_STYLE) {
    _log.error("Missing </style>");
  }
  return new Object[]{newByteArray,newByteArrayPos};
}
