{
  ByteArrayOutputStream newBytes=new ByteArrayOutputStream(oldByteArray.length);
  int state=_STATE_NORMAL;
  boolean removeStartingWhitespace=true;
  for (int i=0; i < oldByteArray.length; i++) {
    byte b=oldByteArray[i];
    char c=(char)b;
    if (c == CharPool.LESS_THAN) {
      if (state == _STATE_NORMAL) {
        if (hasMarker(oldByteArray,i,_MARKER_PRE_OPEN)) {
          i=processPre(oldByteArray,newBytes,i) - 1;
          state=_STATE_NORMAL;
          continue;
        }
 else         if (hasMarker(oldByteArray,i,_MARKER_TEXTAREA_OPEN)) {
          i=processTextArea(oldByteArray,newBytes,i) - 1;
          state=_STATE_NORMAL;
          continue;
        }
 else         if (hasMarker(oldByteArray,i,_MARKER_DIV_CLOSE) || hasMarker(oldByteArray,i,_MARKER_FORM_CLOSE) || hasMarker(oldByteArray,i,_MARKER_LI_CLOSE)|| hasMarker(oldByteArray,i,_MARKER_SCRIPT_CLOSE)|| hasMarker(oldByteArray,i,_MARKER_STYLE_CLOSE)|| hasMarker(oldByteArray,i,_MARKER_TABLE_CLOSE)|| hasMarker(oldByteArray,i,_MARKER_TD_CLOSE)|| hasMarker(oldByteArray,i,_MARKER_TD_OPEN)|| hasMarker(oldByteArray,i,_MARKER_TR_CLOSE)|| hasMarker(oldByteArray,i,_MARKER_TR_OPEN)|| hasMarker(oldByteArray,i,_MARKER_UL_CLOSE)) {
          state=_STATE_FOUND_ELEMENT;
        }
 else         if (hasMarker(oldByteArray,i,_MARKER_JAVASCRIPT_OPEN)) {
          i=processJavaScript(oldByteArray,newBytes,i,_MARKER_JAVASCRIPT_OPEN) - 1;
          state=_STATE_NORMAL;
          continue;
        }
 else         if (hasMarker(oldByteArray,i,_MARKER_SCRIPT_OPEN)) {
          i=processJavaScript(oldByteArray,newBytes,i,_MARKER_SCRIPT_OPEN) - 1;
          state=_STATE_NORMAL;
          continue;
        }
 else         if (hasMarker(oldByteArray,i,_MARKER_STYLE_OPEN)) {
          i=processCSS(oldByteArray,newBytes,i) - 1;
          state=_STATE_NORMAL;
          continue;
        }
      }
    }
 else     if (c == CharPool.GREATER_THAN) {
      if (state == _STATE_FOUND_ELEMENT) {
        state=_STATE_NORMAL;
        newBytes.write(b);
        while ((i + 1) < oldByteArray.length) {
          char nextChar=(char)oldByteArray[i + 1];
          if (Validator.isWhitespace(nextChar)) {
            i++;
          }
 else {
            break;
          }
        }
        continue;
      }
    }
    if (state == _STATE_NORMAL) {
      if ((i + 1) < oldByteArray.length) {
        if (removeStartingWhitespace) {
          if (Validator.isWhitespace(c)) {
            continue;
          }
 else {
            removeStartingWhitespace=false;
          }
        }
        if ((c == CharPool.NEW_LINE) || (c == CharPool.RETURN) || (c == CharPool.TAB)) {
          char nextChar=(char)oldByteArray[i + 1];
          if ((nextChar == CharPool.NEW_LINE) || (nextChar == CharPool.RETURN) || (nextChar == CharPool.TAB)) {
            continue;
          }
        }
      }
    }
    newBytes.write(b);
  }
  return newBytes.toByteArray();
}
