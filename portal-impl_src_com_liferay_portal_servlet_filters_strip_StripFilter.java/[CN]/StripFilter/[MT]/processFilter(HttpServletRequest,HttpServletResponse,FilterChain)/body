{
  if (_log.isDebugEnabled()) {
    String completeURL=HttpUtil.getCompleteURL(request);
    _log.debug("Stripping " + completeURL);
  }
  request.setAttribute(SKIP_FILTER,Boolean.TRUE);
  BufferCacheServletResponse bufferCacheServletResponse=new BufferCacheServletResponse(response);
  processFilter(StripFilter.class,request,bufferCacheServletResponse,filterChain);
  String contentType=GetterUtil.getString(bufferCacheServletResponse.getContentType());
  contentType=StringUtil.toLowerCase(contentType);
  if (_log.isDebugEnabled()) {
    _log.debug("Stripping content of type " + contentType);
  }
  response.setContentType(contentType);
  if (isStripContentType(contentType) && (bufferCacheServletResponse.getStatus() == HttpServletResponse.SC_OK)) {
    CharBuffer oldCharBuffer=bufferCacheServletResponse.getCharBuffer();
    boolean ensureContentLength=ParamUtil.getBoolean(request,_ENSURE_CONTENT_LENGTH);
    if (ensureContentLength) {
      UnsyncByteArrayOutputStream unsyncByteArrayOutputStream=new UnsyncByteArrayOutputStream();
      strip(request,response,oldCharBuffer,new OutputStreamWriter(unsyncByteArrayOutputStream));
      response.setContentLength(unsyncByteArrayOutputStream.size());
      unsyncByteArrayOutputStream.writeTo(response.getOutputStream());
    }
 else     if (!response.isCommitted()) {
      strip(request,response,oldCharBuffer,response.getWriter());
    }
  }
 else {
    ServletResponseUtil.write(response,bufferCacheServletResponse);
  }
}
