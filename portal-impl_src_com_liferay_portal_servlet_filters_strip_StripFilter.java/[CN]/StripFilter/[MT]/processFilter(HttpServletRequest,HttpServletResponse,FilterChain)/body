{
  if (_log.isDebugEnabled()) {
    String completeURL=HttpUtil.getCompleteURL(request);
    _log.debug("Stripping " + completeURL);
  }
  request.setAttribute(SKIP_FILTER,Boolean.TRUE);
  StringServletResponse stringResponse=new StringServletResponse(response);
  processFilter(StripFilter.class,request,stringResponse,filterChain);
  String contentType=GetterUtil.getString(stringResponse.getContentType()).toLowerCase();
  if (_log.isDebugEnabled()) {
    _log.debug("Stripping content of type " + contentType);
  }
  response.setContentType(contentType);
  if (contentType.startsWith(ContentTypes.TEXT_HTML) && (stringResponse.getStatus() == HttpServletResponse.SC_OK)) {
    CharBuffer oldCharBuffer=CharBuffer.wrap(stringResponse.getString());
    boolean ensureContentLength=ParamUtil.getBoolean(request,_ENSURE_CONTENT_LENGTH);
    if (ensureContentLength) {
      UnsyncByteArrayOutputStream unsyncByteArrayOutputStream=new UnsyncByteArrayOutputStream();
      strip(request,response,oldCharBuffer,new OutputStreamWriter(unsyncByteArrayOutputStream));
      response.setContentLength(unsyncByteArrayOutputStream.size());
      unsyncByteArrayOutputStream.writeTo(response.getOutputStream());
    }
 else {
      strip(request,response,oldCharBuffer,response.getWriter());
    }
  }
 else {
    ServletResponseUtil.write(response,stringResponse);
  }
}
