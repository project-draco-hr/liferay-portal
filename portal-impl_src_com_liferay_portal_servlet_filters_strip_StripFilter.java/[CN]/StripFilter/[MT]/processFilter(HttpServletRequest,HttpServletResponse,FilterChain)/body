{
  if (isStrip(request) && !isInclude(request) && !isAlreadyFiltered(request)) {
    if (_log.isDebugEnabled()) {
      String completeURL=HttpUtil.getCompleteURL(request);
      _log.debug("Stripping " + completeURL);
    }
    request.setAttribute(SKIP_FILTER,Boolean.TRUE);
    StringServletResponse stringResponse=new StringServletResponse(response);
    processFilter(StripFilter.class,request,stringResponse,filterChain);
    String contentType=GetterUtil.getString(stringResponse.getContentType()).toLowerCase();
    if (_log.isDebugEnabled()) {
      _log.debug("Stripping content of type " + contentType);
    }
    response.setContentType(contentType);
    if (contentType.startsWith(ContentTypes.TEXT_HTML)) {
      CharBuffer oldCharBuffer=CharBuffer.wrap(stringResponse.getString());
      if (PropsValues.STRIP_ENSURE_CONTENT_LENGTH_ENABLE) {
        UnsyncByteArrayOutputStream unsyncByteArrayOutputStream=new UnsyncByteArrayOutputStream();
        strip(oldCharBuffer,new OutputStreamWriter(unsyncByteArrayOutputStream));
        response.setContentLength(unsyncByteArrayOutputStream.size());
        unsyncByteArrayOutputStream.writeTo(response.getOutputStream());
      }
 else {
        strip(oldCharBuffer,response.getWriter());
      }
    }
 else {
      ServletResponseUtil.write(response,stringResponse);
    }
  }
 else {
    if (_log.isDebugEnabled()) {
      String completeURL=HttpUtil.getCompleteURL(request);
      _log.debug("Not stripping " + completeURL);
    }
    processFilter(StripFilter.class,request,response,filterChain);
  }
}
