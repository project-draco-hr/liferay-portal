{
  String completeURL=HttpUtil.getCompleteURL(request);
  if (isStrip(request) && !isInclude(request) && !isAlreadyFiltered(request)) {
    if (_log.isDebugEnabled()) {
      _log.debug("Stripping " + completeURL);
    }
    request.setAttribute(SKIP_FILTER,Boolean.TRUE);
    StripResponse stripResponse=new StripResponse(response);
    processFilter(StripFilter.class,request,stripResponse,filterChain);
    String contentType=GetterUtil.getString(stripResponse.getContentType());
    byte[] oldByteArray=stripResponse.getData();
    if ((oldByteArray != null) && (oldByteArray.length > 0)) {
      byte[] newByteArray=new byte[oldByteArray.length];
      int newByteArrayPos=0;
      if (_log.isDebugEnabled()) {
        _log.debug("Stripping content of type " + contentType);
      }
      if (contentType.toLowerCase().indexOf("text/") != -1) {
        boolean ignore=false;
        char prevChar='\n';
        for (int i=0; i < oldByteArray.length; i++) {
          byte b=oldByteArray[i];
          char c=(char)b;
          if (c == '<') {
            if (!ignore) {
              if ((i + 4) < oldByteArray.length) {
                char c1=(char)oldByteArray[i + 1];
                char c2=(char)oldByteArray[i + 2];
                char c3=(char)oldByteArray[i + 3];
                char c4=(char)oldByteArray[i + 4];
                if (((c1 == 'p') || (c1 == 'P')) && ((c2 == 'r') || (c2 == 'R')) && ((c3 == 'e') || (c3 == 'E'))&& ((c4 == '>'))) {
                  ignore=true;
                }
              }
              if (!ignore && ((i + 9) < oldByteArray.length)) {
                char c1=(char)oldByteArray[i + 1];
                char c2=(char)oldByteArray[i + 2];
                char c3=(char)oldByteArray[i + 3];
                char c4=(char)oldByteArray[i + 4];
                char c5=(char)oldByteArray[i + 5];
                char c6=(char)oldByteArray[i + 6];
                char c7=(char)oldByteArray[i + 7];
                char c8=(char)oldByteArray[i + 8];
                char c9=(char)oldByteArray[i + 9];
                if (((c1 == 't') || (c1 == 'T')) && ((c2 == 'e') || (c2 == 'E')) && ((c3 == 'x') || (c3 == 'X'))&& ((c4 == 't') || (c4 == 'T'))&& ((c5 == 'a') || (c5 == 'A'))&& ((c6 == 'r') || (c6 == 'R'))&& ((c7 == 'e') || (c7 == 'E'))&& ((c8 == 'a') || (c8 == 'A'))&& ((c9 == ' '))) {
                  ignore=true;
                }
              }
            }
 else             if (ignore) {
              if ((i + 5) < oldByteArray.length) {
                char c1=(char)oldByteArray[i + 1];
                char c2=(char)oldByteArray[i + 2];
                char c3=(char)oldByteArray[i + 3];
                char c4=(char)oldByteArray[i + 4];
                char c5=(char)oldByteArray[i + 5];
                if (((c1 == '/')) && ((c2 == 'p') || (c2 == 'P')) && ((c3 == 'r') || (c3 == 'R'))&& ((c4 == 'e') || (c4 == 'E'))&& ((c5 == '>'))) {
                  ignore=false;
                }
              }
              if (ignore && ((i + 10) < oldByteArray.length)) {
                char c1=(char)oldByteArray[i + 1];
                char c2=(char)oldByteArray[i + 2];
                char c3=(char)oldByteArray[i + 3];
                char c4=(char)oldByteArray[i + 4];
                char c5=(char)oldByteArray[i + 5];
                char c6=(char)oldByteArray[i + 6];
                char c7=(char)oldByteArray[i + 7];
                char c8=(char)oldByteArray[i + 8];
                char c9=(char)oldByteArray[i + 9];
                char c10=(char)oldByteArray[i + 10];
                if (((c1 == '/')) && ((c2 == 't') || (c2 == 'T')) && ((c3 == 'e') || (c3 == 'E'))&& ((c4 == 'x') || (c4 == 'X'))&& ((c5 == 't') || (c5 == 'T'))&& ((c6 == 'a') || (c6 == 'A'))&& ((c7 == 'r') || (c7 == 'R'))&& ((c8 == 'e') || (c8 == 'E'))&& ((c9 == 'a') || (c9 == 'A'))&& ((c10 == '>'))) {
                  ignore=false;
                }
              }
            }
          }
          if ((!ignore) && ((c == '\n') || (c == '\r') || (c == '\t'))) {
            if ((i + 1) == oldByteArray.length) {
            }
            if ((prevChar == '\n') || (prevChar == '\r')) {
            }
 else {
              if (c != '\t') {
                prevChar=c;
              }
              newByteArray[newByteArrayPos++]=b;
            }
          }
 else {
            prevChar=c;
            newByteArray[newByteArrayPos++]=b;
          }
        }
      }
 else {
        newByteArray=oldByteArray;
        newByteArrayPos=oldByteArray.length;
      }
      ServletResponseUtil.write(response,newByteArray,newByteArrayPos);
    }
  }
 else {
    if (_log.isDebugEnabled()) {
      _log.debug("Not stripping " + completeURL);
    }
    processFilter(StripFilter.class,request,response,filterChain);
  }
}
