{
  if (isStrip(request) && !isInclude(request) && !isAlreadyFiltered(request)) {
    if (_log.isDebugEnabled()) {
      String completeURL=HttpUtil.getCompleteURL(request);
      _log.debug("Stripping " + completeURL);
    }
    request.setAttribute(SKIP_FILTER,Boolean.TRUE);
    DeterminateKeyGenerator.reset();
    StripResponse stripResponse=new StripResponse(response);
    processFilter(StripFilter.class,request,stripResponse,filterChain);
    String contentType=GetterUtil.getString(stripResponse.getContentType()).toLowerCase();
    byte[] oldByteArray=stripResponse.getData();
    if ((oldByteArray != null) && (oldByteArray.length > 0)) {
      byte[] newByteArray=null;
      if (_log.isDebugEnabled()) {
        _log.debug("Stripping content of type " + contentType);
      }
      if (contentType.indexOf("text/") != -1) {
        newByteArray=strip(oldByteArray);
      }
 else {
        newByteArray=oldByteArray;
      }
      if (!ETagUtil.processETag(request,response,newByteArray)) {
        response.setContentType(contentType);
        ServletResponseUtil.write(response,newByteArray);
      }
    }
  }
 else {
    if (_log.isDebugEnabled()) {
      String completeURL=HttpUtil.getCompleteURL(request);
      _log.debug("Not stripping " + completeURL);
    }
    processFilter(StripFilter.class,request,response,filterChain);
  }
}
