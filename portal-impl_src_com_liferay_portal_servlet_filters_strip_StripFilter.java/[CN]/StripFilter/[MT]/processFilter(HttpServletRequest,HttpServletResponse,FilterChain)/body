{
  String completeURL=HttpUtil.getCompleteURL(request);
  if (isStrip(request) && !isInclude(request) && !isAlreadyFiltered(request)) {
    if (_log.isDebugEnabled()) {
      _log.debug("Stripping " + completeURL);
    }
    request.setAttribute(SKIP_FILTER,Boolean.TRUE);
    StripResponse stripResponse=new StripResponse(response);
    processFilter(StripFilter.class,request,stripResponse,filterChain);
    String contentType=GetterUtil.getString(stripResponse.getContentType()).toLowerCase();
    byte[] oldByteArray=stripResponse.getData();
    if ((oldByteArray != null) && (oldByteArray.length > 0)) {
      byte[] newByteArray=null;
      int newByteArrayPos=0;
      if (_log.isDebugEnabled()) {
        _log.debug("Stripping content of type " + contentType);
      }
      if (contentType.indexOf("text/") != -1) {
        Object[] value=strip(oldByteArray);
        newByteArray=(byte[])value[0];
        newByteArrayPos=(Integer)value[1];
      }
 else {
        newByteArray=oldByteArray;
        newByteArrayPos=oldByteArray.length;
      }
      String eTag=Integer.toHexString(Arrays.hashCode(newByteArray));
      request.setAttribute(ETagFilter.ETAG,eTag);
      ServletResponseUtil.write(response,newByteArray,newByteArrayPos);
    }
  }
 else {
    if (_log.isDebugEnabled()) {
      _log.debug("Not stripping " + completeURL);
    }
    processFilter(StripFilter.class,request,response,filterChain);
  }
}
