{
  if (isStrip(request) && !isInclude(request) && !isAlreadyFiltered(request)) {
    if (_log.isDebugEnabled()) {
      String completeURL=HttpUtil.getCompleteURL(request);
      _log.debug("Stripping " + completeURL);
    }
    request.setAttribute(SKIP_FILTER,Boolean.TRUE);
    StringServletResponse stringResponse=new StringServletResponse(response);
    processFilter(StripFilter.class,request,stringResponse,filterChain);
    String contentType=GetterUtil.getString(stringResponse.getContentType()).toLowerCase();
    if (_log.isDebugEnabled()) {
      _log.debug("Stripping content of type " + contentType);
    }
    response.setContentType(contentType);
    if (contentType.indexOf("text/") != -1) {
      byte[] oldByteArray=null;
      int length=0;
      if (stringResponse.isCalledGetOutputStream()) {
        UnsyncByteArrayOutputStream unsyncByteArrayOutputStream=stringResponse.getUnsyncByteArrayOutputStream();
        oldByteArray=unsyncByteArrayOutputStream.unsafeGetByteArray();
        length=unsyncByteArrayOutputStream.size();
      }
 else {
        String content=stringResponse.getString();
        oldByteArray=content.getBytes(StringPool.UTF8);
        length=oldByteArray.length;
      }
      UnsyncByteArrayOutputStream outputStream=new UnsyncByteArrayOutputStream((int)(length * _COMPRESSION_RATE));
      strip(oldByteArray,length,outputStream);
      ServletResponseUtil.write(response,outputStream.unsafeGetByteArray(),outputStream.size());
    }
 else {
      ServletResponseUtil.write(response,stringResponse);
    }
  }
 else {
    if (_log.isDebugEnabled()) {
      String completeURL=HttpUtil.getCompleteURL(request);
      _log.debug("Not stripping " + completeURL);
    }
    processFilter(StripFilter.class,request,response,filterChain);
  }
}
