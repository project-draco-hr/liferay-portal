{
  PushNotificationsPermission.check(getPermissionChecker(),PushNotificationsActionKeys.MANAGE_DEVICES);
  PushNotificationsDevice pushNotificationsDevice=pushNotificationsDevicePersistence.fetchByToken(token);
  if (pushNotificationsDevice == null) {
    pushNotificationsDevice=pushNotificationsDeviceLocalService.addPushNotificationsDevice(getGuestOrUserId(),platform,token);
  }
 else {
    long userId=getGuestOrUserId();
    if (pushNotificationsDevice.getUserId() != userId) {
      pushNotificationsDevice=null;
      if (_log.isInfoEnabled()) {
        _log.info("Device found with token " + token + " does not belong to user "+ userId);
      }
    }
  }
  return pushNotificationsDevice;
}
