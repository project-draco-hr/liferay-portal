{
  ThemeDisplay themeDisplay=(ThemeDisplay)actionRequest.getAttribute(WebKeys.THEME_DISPLAY);
  String title=ParamUtil.getString(actionRequest,"title");
  String excerpt=ParamUtil.getString(actionRequest,"excerpt");
  String url=ParamUtil.getString(actionRequest,"url");
  String blogName=ParamUtil.getString(actionRequest,"blog_name");
  if (!isCommentsEnabled(actionRequest)) {
    sendError(actionRequest,actionResponse,"Comments have been disabled for this blog entry.");
    return;
  }
  if (Validator.isNull(url)) {
    sendError(actionRequest,actionResponse,"Trackback requires a valid permanent URL.");
    return;
  }
  HttpServletRequest request=PortalUtil.getHttpServletRequest(actionRequest);
  String remoteIp=request.getRemoteAddr();
  String trackbackIp=HttpUtil.getIpAddress(url);
  if (!remoteIp.equals(trackbackIp)) {
    sendError(actionRequest,actionResponse,"Remote IP " + remoteIp + " does not match trackback URL's IP "+ trackbackIp+ ".");
    return;
  }
  try {
    ActionUtil.getEntry(actionRequest);
  }
 catch (  PrincipalException pe) {
    sendError(actionRequest,actionResponse,"Blog entry must have guest view permissions to enable " + "trackbacks.");
    return;
  }
  BlogsEntry entry=(BlogsEntry)actionRequest.getAttribute(WebKeys.BLOGS_ENTRY);
  if (!entry.isAllowTrackbacks()) {
    sendError(actionRequest,actionResponse,"Trackbacks are not enabled on this blog entry.");
    return;
  }
  long userId=UserLocalServiceUtil.getDefaultUserId(themeDisplay.getCompanyId());
  String className=BlogsEntry.class.getName();
  long classPK=entry.getEntryId();
  ServiceContext serviceContext=ServiceContextFactory.getInstance(MBMessage.class.getName(),actionRequest);
  MBMessageDisplay messageDisplay=MBMessageLocalServiceUtil.getDiscussionMessageDisplay(userId,className,classPK,WorkflowConstants.STATUS_APPROVED);
  MBThread thread=messageDisplay.getThread();
  long threadId=thread.getThreadId();
  long parentMessageId=thread.getRootMessageId();
  String body="[...] " + excerpt + " [...] [url="+ url+ "]"+ themeDisplay.translate("read-more")+ "[/url]";
  MBMessage message=MBMessageLocalServiceUtil.addDiscussionMessage(userId,blogName,className,classPK,threadId,parentMessageId,title,body,serviceContext);
  String entryURL=PortalUtil.getLayoutFullURL(themeDisplay) + Portal.FRIENDLY_URL_SEPARATOR + "blogs/"+ entry.getUrlTitle();
  LinkbackConsumerUtil.addNewTrackback(message.getMessageId(),url,entryURL);
  sendSuccess(actionRequest,actionResponse);
}
