{
  WebDAVStorage webDAVStorage=new DLWebDAVStorageImpl();
  webDAVStorage.setToken("document_library");
  WebDAVUtil.addStorage(webDAVStorage);
  WebDAVServlet webDAVServlet=new WebDAVServlet();
  String requestURI=_CONTEXT_PATH + _SERVLET_PATH + _PATH_INFO_PREFACE+ path;
  MockHttpServletRequest mockHttpServletRequest=new MockHttpServletRequest(method,requestURI);
  mockHttpServletRequest.setContextPath(_CONTEXT_PATH);
  mockHttpServletRequest.setServletPath(_SERVLET_PATH);
  mockHttpServletRequest.setPathInfo(_PATH_INFO_PREFACE + path);
  try {
    mockHttpServletRequest.setRemoteUser(String.valueOf(TestPropsValues.getUserId()));
  }
 catch (  Exception e) {
    Assert.fail("User ID cannot be initialized");
  }
  if (headers == null) {
    headers=new HashMap<String,String>();
  }
  headers.put(HttpHeaders.USER_AGENT,getUserAgent());
  try {
    throw new Exception();
  }
 catch (  Exception e) {
    StackTraceElement[] stackTraceElements=e.getStackTrace();
    for (    StackTraceElement stackTraceElement : stackTraceElements) {
      String methodName=stackTraceElement.getMethodName();
      if (methodName.equals("setUp") || methodName.equals("tearDown") || methodName.startsWith("test")) {
        String testName=StringUtil.extractLast(stackTraceElement.getClassName(),CharPool.PERIOD);
        testName=StringUtil.replace(testName,new String[]{"WebDAV","Test"},new String[]{"",""});
        headers.put("X-Litmus",testName + ": (" + stackTraceElement.getMethodName()+ ":"+ stackTraceElement.getLineNumber()+ ")");
        break;
      }
    }
  }
  if (data != null) {
    mockHttpServletRequest.setContent(data);
    String contentType=headers.remove(HttpHeaders.CONTENT_TYPE);
    if (contentType != null) {
      mockHttpServletRequest.setContentType(contentType);
    }
 else {
      mockHttpServletRequest.setContentType(ContentTypes.TEXT_PLAIN);
    }
  }
  for (  Map.Entry<String,String> entry : headers.entrySet()) {
    String key=entry.getKey();
    String value=entry.getValue();
    mockHttpServletRequest.addHeader(key,value);
  }
  try {
    MockHttpServletResponse mockHttpServletResponse=new MockHttpServletResponse();
    webDAVServlet.service(mockHttpServletRequest,mockHttpServletResponse);
    int statusCode=mockHttpServletResponse.getStatus();
    byte[] responseBody=mockHttpServletResponse.getContentAsByteArray();
    Map<String,String> responseHeaders=new HashMap<String,String>();
    for (    String name : mockHttpServletResponse.getHeaderNames()) {
      responseHeaders.put(name,mockHttpServletResponse.getHeader(name));
    }
    return new Tuple(statusCode,responseBody,responseHeaders);
  }
 catch (  Exception e) {
    e.printStackTrace();
  }
  return null;
}
