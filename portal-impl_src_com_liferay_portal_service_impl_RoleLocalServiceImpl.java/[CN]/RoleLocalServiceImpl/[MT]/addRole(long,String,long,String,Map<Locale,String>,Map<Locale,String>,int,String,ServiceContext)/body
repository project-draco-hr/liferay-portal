{
  User user=userPersistence.findByPrimaryKey(userId);
  className=GetterUtil.getString(className);
  long classNameId=PortalUtil.getClassNameId(className);
  long roleId=counterLocalService.increment();
  if ((classNameId <= 0) || className.equals(Role.class.getName())) {
    classNameId=PortalUtil.getClassNameId(Role.class);
    classPK=roleId;
  }
  Date now=new Date();
  validate(0,user.getCompanyId(),classNameId,name);
  Role role=rolePersistence.create(roleId);
  if (serviceContext != null) {
    role.setUuid(serviceContext.getUuid());
  }
  role.setCompanyId(user.getCompanyId());
  role.setUserId(user.getUserId());
  role.setUserName(user.getFullName());
  if (serviceContext != null) {
    role.setCreateDate(serviceContext.getCreateDate(now));
    role.setModifiedDate(serviceContext.getModifiedDate(now));
  }
 else {
    role.setCreateDate(now);
    role.setModifiedDate(now);
  }
  role.setClassNameId(classNameId);
  role.setClassPK(classPK);
  role.setName(name);
  role.setTitleMap(titleMap);
  role.setDescriptionMap(descriptionMap);
  role.setType(type);
  role.setSubtype(subtype);
  role.setExpandoBridgeAttributes(serviceContext);
  rolePersistence.update(role);
  if (!user.isDefaultUser()) {
    resourceLocalService.addResources(user.getCompanyId(),0,userId,Role.class.getName(),role.getRoleId(),false,false,false);
    if (!ExportImportThreadLocal.isImportInProcess()) {
      Indexer indexer=IndexerRegistryUtil.nullSafeGetIndexer(User.class);
      indexer.reindex(userId);
    }
  }
  return role;
}
