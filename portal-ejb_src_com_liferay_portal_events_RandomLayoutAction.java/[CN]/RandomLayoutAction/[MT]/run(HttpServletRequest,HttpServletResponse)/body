{
  try {
    PropsUtil.set(PropsUtil.LAST_MODIFIED_CHECK,"false");
    ThemeDisplay themeDisplay=(ThemeDisplay)req.getAttribute(WebKeys.THEME_DISPLAY);
    if (!themeDisplay.isSignedIn()) {
      return;
    }
    String requestURI=GetterUtil.getString(req.getRequestURI());
    if (!requestURI.endsWith("/portal/layout")) {
      return;
    }
    Layout layout=themeDisplay.getLayout();
    if ((layout == null) || layout.isShared()) {
      return;
    }
    Group generalGuestGroup=GroupLocalServiceUtil.getGroup(themeDisplay.getCompanyId(),GroupImpl.GUEST);
    List layouts=LayoutLocalServiceUtil.getLayouts(LayoutImpl.PUBLIC + generalGuestGroup.getGroupId());
    if (layouts.size() > 0) {
      Layout randomLayout=(Layout)layouts.get(Randomizer.getInstance().nextInt(layouts.size()));
      themeDisplay.setLayout(randomLayout);
      themeDisplay.setLayoutTypePortlet((LayoutTypePortlet)randomLayout.getLayoutType());
      req.setAttribute(WebKeys.LAYOUT,randomLayout);
    }
  }
 catch (  Exception e) {
    _log.error(StackTraceUtil.getStackTrace(e));
    throw new ActionException(e);
  }
}
