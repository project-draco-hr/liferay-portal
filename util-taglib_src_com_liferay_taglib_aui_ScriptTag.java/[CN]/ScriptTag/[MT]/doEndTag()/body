{
  HttpServletRequest request=(HttpServletRequest)pageContext.getRequest();
  boolean positionInline=isPositionInLine();
  try {
    String portletId=null;
    Portlet portlet=(Portlet)request.getAttribute(WebKeys.RENDER_PORTLET);
    if (portlet != null) {
      portletId=portlet.getPortletId();
    }
    StringBundler bodyContentSB=getBodyContentAsStringBundler();
    String use=getUse();
    if (positionInline) {
      ScriptData scriptData=new ScriptData();
      request.setAttribute(ScriptTag.class.getName(),scriptData);
      scriptData.append(portletId,bodyContentSB,use);
      String page=getPage();
      if (FileAvailabilityUtil.isAvailable(pageContext.getServletContext(),page)) {
        PortalIncludeUtil.include(pageContext,page);
      }
 else {
        processEndTag(scriptData);
      }
    }
 else {
      ScriptData scriptData=(ScriptData)request.getAttribute(WebKeys.AUI_SCRIPT_DATA);
      if (scriptData == null) {
        scriptData=new ScriptData();
        request.setAttribute(WebKeys.AUI_SCRIPT_DATA,scriptData);
      }
      scriptData.append(portletId,bodyContentSB,use);
    }
    return EVAL_PAGE;
  }
 catch (  Exception e) {
    throw new JspException(e);
  }
 finally {
    if (positionInline) {
      request.removeAttribute(ScriptTag.class.getName());
    }
    if (!ServerDetector.isResin()) {
      cleanUp();
    }
    request.removeAttribute(WebKeys.JS_CONTEXT);
  }
}
