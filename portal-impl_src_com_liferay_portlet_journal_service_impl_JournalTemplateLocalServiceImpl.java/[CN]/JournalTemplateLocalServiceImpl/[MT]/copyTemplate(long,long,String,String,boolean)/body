{
  User user=userPersistence.findByPrimaryKey(userId);
  oldTemplateId=StringUtil.toUpperCase(oldTemplateId.trim());
  newTemplateId=StringUtil.toUpperCase(newTemplateId.trim());
  Date now=new Date();
  JournalTemplate oldTemplate=doGetTemplate(groupId,oldTemplateId);
  if (autoTemplateId) {
    newTemplateId=String.valueOf(counterLocalService.increment());
  }
 else {
    validateTemplateId(newTemplateId);
    JournalTemplate newTemplate=fetchTemplate(groupId,newTemplateId);
    if (newTemplate != null) {
      throw new DuplicateTemplateIdException();
    }
  }
  long id=counterLocalService.increment();
  JournalTemplate newTemplate=createJournalTemplate(id);
  newTemplate.setGroupId(groupId);
  newTemplate.setCompanyId(user.getCompanyId());
  newTemplate.setUserId(user.getUserId());
  newTemplate.setUserName(user.getFullName());
  newTemplate.setCreateDate(now);
  newTemplate.setModifiedDate(now);
  newTemplate.setTemplateId(newTemplateId);
  newTemplate.setStructureId(oldTemplate.getStructureId());
  newTemplate.setNameMap(oldTemplate.getNameMap());
  newTemplate.setDescriptionMap(oldTemplate.getDescriptionMap());
  newTemplate.setXsl(oldTemplate.getXsl());
  newTemplate.setLangType(oldTemplate.getLangType());
  newTemplate.setCacheable(oldTemplate.isCacheable());
  newTemplate.setSmallImage(oldTemplate.isSmallImage());
  newTemplate.setSmallImageId(counterLocalService.increment());
  newTemplate.setSmallImageURL(oldTemplate.getSmallImageURL());
  newTemplate.setExpandoBridgeAttributes(oldTemplate);
  updateTemplate(newTemplate);
  if (oldTemplate.getSmallImage()) {
    Image image=imageLocalService.getImage(oldTemplate.getSmallImageId());
    byte[] smallImageBytes=image.getTextObj();
    imageLocalService.updateImage(newTemplate.getSmallImageId(),smallImageBytes);
  }
  return newTemplate;
}
