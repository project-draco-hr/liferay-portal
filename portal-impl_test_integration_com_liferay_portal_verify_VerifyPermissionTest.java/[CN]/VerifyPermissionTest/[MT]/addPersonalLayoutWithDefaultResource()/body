{
  ThemeDisplay themeDisplay=new ThemeDisplay();
  User user=UserTestUtil.addUser();
  themeDisplay.setUser(user);
  Company company=CompanyLocalServiceUtil.getCompany(user.getCompanyId());
  themeDisplay.setCompany(company);
  TestServicePreAction.INSTANCE.addDefaultUserPublicLayouts(user);
  Group userGroup=user.getGroup();
  List<Layout> layouts=LayoutLocalServiceUtil.getLayouts(userGroup.getGroupId(),true,LayoutConstants.DEFAULT_PARENT_LAYOUT_ID);
  if (layouts.isEmpty()) {
    layouts=LayoutLocalServiceUtil.getLayouts(userGroup.getGroupId(),false,LayoutConstants.DEFAULT_PARENT_LAYOUT_ID);
  }
  Layout layout=layouts.get(0);
  themeDisplay.setLayout(layout);
  _request.setAttribute(WebKeys.THEME_DISPLAY,themeDisplay);
  Portlet portlet=PortletLocalServiceUtil.getPortletById(user.getCompanyId(),PortletKeys.TEST);
  PortalUtil.addPortletDefaultResource(_request,portlet);
  return layout;
}
