{
  LayoutRevision revision=null;
  List<LayoutRevision> revisions=Collections.EMPTY_LIST;
  LayoutBranch branch=layoutBranchPersistence.findByPrimaryKey(branchId);
  long revisionId=ParamUtil.getLong(serviceContext,"revisionId");
  if (revisionId > 0) {
    revision=layoutRevisionPersistence.findByPrimaryKey(revisionId);
  }
  if (revision == null) {
    revisions=layoutRevisionPersistence.findByB_P(branchId,plid,0,1);
    if (!revisions.isEmpty()) {
      revision=revisions.get(0);
    }
  }
  if (revision == null) {
    Layout layout=layoutPersistence.findByPrimaryKey(plid);
    revision=layoutRevisionLocalService.addRevision(branch.getBranchId(),plid,layout.getGroupId(),layout.getName(),layout.getTitle(),layout.getDescription(),layout.getTypeSettings(),layout.getIconImage(),layout.getIconImageId(),layout.getThemeId(),layout.getColorSchemeId(),layout.getWapThemeId(),layout.getWapColorSchemeId(),layout.getCss(),false,serviceContext);
    if (!branch.isMaster()) {
      branch=layoutBranchLocalService.getMasterBranch(branch.getGroupId());
      revisions=layoutRevisionPersistence.findByB_P(branch.getBranchId(),plid,0,1);
      if (revisions.isEmpty()) {
        layoutRevisionLocalService.addRevision(branch.getBranchId(),plid,layout.getGroupId(),layout.getName(),layout.getTitle(),layout.getDescription(),layout.getTypeSettings(),layout.getIconImage(),layout.getIconImageId(),layout.getThemeId(),layout.getColorSchemeId(),layout.getWapThemeId(),layout.getWapColorSchemeId(),layout.getCss(),false,serviceContext);
      }
    }
  }
  return revision;
}
