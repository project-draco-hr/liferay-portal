{
  if (portlet.isSystem()) {
    return;
  }
  PermissionChecker permissionChecker=PermissionThreadLocal.getPermissionChecker();
  ThemeDisplay themeDisplay=(ThemeDisplay)request.getAttribute(WebKeys.THEME_DISPLAY);
  long scopeGroupId=themeDisplay.getScopeGroupId();
  if (PortletPermissionUtil.hasControlPanelAccessPermission(permissionChecker,scopeGroupId,portlet)) {
    return;
  }
  if (isAccessGrantedByRuntimePortlet(request,portlet)) {
    return;
  }
  if (isAccessGrantedByPPAuthToken(request,portlet)) {
    return;
  }
  throw new PrincipalException();
}
