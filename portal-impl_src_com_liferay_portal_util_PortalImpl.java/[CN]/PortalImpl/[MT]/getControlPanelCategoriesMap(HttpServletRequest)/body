{
  Map<String,List<Portlet>> categoriesMap=(Map<String,List<Portlet>>)request.getAttribute(WebKeys.CONTROL_PANEL_CATEGORIES_MAP);
  if (categoriesMap != null) {
    return categoriesMap;
  }
  ThemeDisplay themeDisplay=(ThemeDisplay)request.getAttribute(WebKeys.THEME_DISPLAY);
  categoriesMap=new LinkedHashMap<String,List<Portlet>>();
  for (  String category : PortletCategoryKeys.ALL) {
    List<Portlet> portlets=getControlPanelPortlets(category,themeDisplay);
    if (!portlets.isEmpty()) {
      categoriesMap.put(category,portlets);
    }
  }
  request.setAttribute(WebKeys.CONTROL_PANEL_CATEGORIES_MAP,categoriesMap);
  return categoriesMap;
}
