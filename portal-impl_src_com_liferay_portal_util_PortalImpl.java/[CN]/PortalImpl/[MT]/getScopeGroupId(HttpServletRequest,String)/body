{
  Layout layout=(Layout)request.getAttribute(WebKeys.LAYOUT);
  long scopeGroupId=0;
  if (layout != null) {
    Group group=layout.getGroup();
    if (group.isControlPanel()) {
      long doAsGroupId=ParamUtil.getLong(request,"doAsGroupId");
      Group doAsGroup=GroupLocalServiceUtil.fetchGroup(doAsGroupId);
      if ((doAsGroupId <= 0) || (doAsGroup == null)) {
        Group guestGroup=GroupLocalServiceUtil.fetchGroup(group.getCompanyId(),GroupConstants.GUEST);
        if (guestGroup != null) {
          doAsGroupId=guestGroup.getGroupId();
        }
      }
      if (doAsGroupId > 0) {
        scopeGroupId=doAsGroupId;
      }
      group=GroupLocalServiceUtil.fetchGroup(scopeGroupId);
      if ((group != null) && group.hasStagingGroup()) {
        try {
          Group stagingGroup=group.getStagingGroup();
          scopeGroupId=stagingGroup.getGroupId();
        }
 catch (        Exception e) {
        }
      }
    }
    if ((portletId != null) && (group.isStaged() || group.isStagingGroup())) {
      Group liveGroup=group;
      if (group.isStagingGroup()) {
        liveGroup=group.getLiveGroup();
      }
      if (liveGroup.isStaged() && !liveGroup.isStagedPortlet(portletId)) {
        Layout liveGroupLayout=LayoutLocalServiceUtil.fetchLayoutByUuidAndGroupId(layout.getUuid(),liveGroup.getGroupId());
        if ((liveGroupLayout != null) && liveGroupLayout.hasScopeGroup()) {
          scopeGroupId=getScopeGroupId(liveGroupLayout,portletId);
        }
 else {
          scopeGroupId=liveGroup.getGroupId();
        }
      }
    }
  }
  if (scopeGroupId <= 0) {
    scopeGroupId=getScopeGroupId(layout,portletId);
  }
  return scopeGroupId;
}
