{
  Layout layout=(Layout)request.getAttribute(WebKeys.LAYOUT);
  long scopeGroupId=0;
  if (layout != null) {
    Group group=layout.getGroup();
    if (group.getName().equals(GroupConstants.CONTROL_PANEL)) {
      long doAsGroupId=ParamUtil.getLong(request,"doAsGroupId");
      if (doAsGroupId <= 0) {
        try {
          Group guestGroup=GroupLocalServiceUtil.getGroup(group.getCompanyId(),GroupConstants.GUEST);
          doAsGroupId=guestGroup.getGroupId();
        }
 catch (        Exception e) {
        }
      }
      if (doAsGroupId > 0) {
        scopeGroupId=doAsGroupId;
      }
      try {
        group=GroupLocalServiceUtil.getGroup(scopeGroupId);
        if (group.hasStagingGroup()) {
          Group stagingGroup=group.getStagingGroup();
          scopeGroupId=stagingGroup.getGroupId();
        }
      }
 catch (      Exception e) {
      }
    }
  }
  if (scopeGroupId <= 0) {
    scopeGroupId=getScopeGroupId(layout,portletId);
  }
  return scopeGroupId;
}
