{
  String serverName=themeDisplay.getServerName();
  if (layout == null) {
    layout=themeDisplay.getLayout();
  }
  if (layout != null) {
    LayoutSet layoutSet=null;
    long refererPlid=ParamUtil.getLong(themeDisplay.getRequest(),"refererPlid");
    if (refererPlid > 0) {
      layout=LayoutLocalServiceUtil.getLayout(refererPlid);
    }
    layoutSet=layout.getLayoutSet();
    String virtualHostname=layoutSet.getVirtualHostname();
    String domain=HttpUtil.getDomain(themeDisplay.getURLPortal());
    if (Validator.isNotNull(virtualHostname) && domain.startsWith(virtualHostname)) {
      serverName=virtualHostname;
    }
  }
  return getPortalURL(serverName,themeDisplay.getServerPort(),themeDisplay.isSecure());
}
