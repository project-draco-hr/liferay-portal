{
  LayoutSet layoutSet=LayoutSetLocalServiceUtil.getLayoutSet(group.getGroupId(),privateLayoutSet);
  String portalURL=StringPool.BLANK;
  if (canonicalURL || !themeDisplay.getServerName().equals(_LOCALHOST)) {
    String virtualHostname=layoutSet.getVirtualHostname();
    if (Validator.isNull(virtualHostname) && Validator.isNotNull(PropsValues.VIRTUAL_HOSTS_DEFAULT_SITE_NAME) && !layoutSet.isPrivateLayout()) {
      try {
        Group defaultGroup=GroupLocalServiceUtil.getGroup(themeDisplay.getCompanyId(),PropsValues.VIRTUAL_HOSTS_DEFAULT_SITE_NAME);
        if (layoutSet.getGroupId() == defaultGroup.getGroupId()) {
          Company company=themeDisplay.getCompany();
          virtualHostname=company.getVirtualHostname();
        }
      }
 catch (      Exception e) {
        _log.error(e,e);
      }
    }
    if (Validator.isNotNull(virtualHostname) && (canonicalURL || !virtualHostname.equalsIgnoreCase(_LOCALHOST))) {
      virtualHostname=getPortalURL(virtualHostname,themeDisplay.getServerPort(),themeDisplay.isSecure());
      String portalDomain=HttpUtil.getDomain(themeDisplay.getPortalURL());
      if (canonicalURL || virtualHostname.contains(portalDomain)) {
        String path=StringPool.BLANK;
        if (themeDisplay.isWidget()) {
          path=PropsValues.WIDGET_SERVLET_MAPPING;
        }
        if (themeDisplay.isI18n() && !canonicalURL) {
          path=themeDisplay.getI18nPath();
        }
        return virtualHostname.concat(_pathContext).concat(path);
      }
    }
 else {
      LayoutSet curLayoutSet=LayoutSetLocalServiceUtil.getLayoutSet(themeDisplay.getSiteGroupId(),privateLayoutSet);
      if (canonicalURL || ((layoutSet.getLayoutSetId() != curLayoutSet.getLayoutSetId()) && (group.getClassPK() != themeDisplay.getUserId()))) {
        if (group.isControlPanel()) {
          virtualHostname=themeDisplay.getServerName();
          if (Validator.isNull(virtualHostname) || virtualHostname.equalsIgnoreCase(_LOCALHOST)) {
            virtualHostname=curLayoutSet.getVirtualHostname();
          }
        }
        if (Validator.isNull(virtualHostname) || virtualHostname.equalsIgnoreCase(_LOCALHOST)) {
          Company company=themeDisplay.getCompany();
          virtualHostname=company.getVirtualHostname();
        }
        if (canonicalURL || !virtualHostname.equalsIgnoreCase(_LOCALHOST)) {
          portalURL=getPortalURL(virtualHostname,themeDisplay.getServerPort(),themeDisplay.isSecure());
        }
      }
    }
  }
  String friendlyURL=null;
  if (privateLayoutSet) {
    if (group.isUser()) {
      friendlyURL=_PRIVATE_USER_SERVLET_MAPPING;
    }
 else {
      friendlyURL=_PRIVATE_GROUP_SERVLET_MAPPING;
    }
  }
 else {
    friendlyURL=_PUBLIC_GROUP_SERVLET_MAPPING;
  }
  StringBundler sb=new StringBundler(6);
  sb.append(portalURL);
  sb.append(_pathContext);
  if (themeDisplay.isI18n() && !canonicalURL) {
    sb.append(themeDisplay.getI18nPath());
  }
  if (themeDisplay.isWidget()) {
    sb.append(PropsValues.WIDGET_SERVLET_MAPPING);
  }
  sb.append(friendlyURL);
  sb.append(group.getFriendlyURL());
  return sb.toString();
}
