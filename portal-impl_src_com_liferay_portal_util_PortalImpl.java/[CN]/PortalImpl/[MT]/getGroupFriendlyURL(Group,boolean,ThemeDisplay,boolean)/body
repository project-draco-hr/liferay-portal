{
  LayoutSet layoutSet=LayoutSetLocalServiceUtil.getLayoutSet(group.getGroupId(),privateLayoutSet);
  String portalURL=themeDisplay.getPortalURL();
  boolean useGroupVirtualHostName=false;
  if (canonicalURL || !StringUtil.equalsIgnoreCase(themeDisplay.getServerName(),_LOCALHOST)) {
    useGroupVirtualHostName=true;
  }
  long refererPlid=themeDisplay.getRefererPlid();
  if (refererPlid > 0) {
    Layout refererLayout=LayoutLocalServiceUtil.fetchLayout(refererPlid);
    if ((refererLayout != null) && ((refererLayout.getGroupId() != group.getGroupId()) || (refererLayout.isPrivateLayout() != privateLayoutSet))) {
      useGroupVirtualHostName=false;
    }
  }
  if (useGroupVirtualHostName) {
    String virtualHostname=getVirtualHostname(layoutSet);
    String portalDomain=HttpUtil.getDomain(portalURL);
    if (Validator.isNotNull(virtualHostname) && (canonicalURL || !StringUtil.equalsIgnoreCase(virtualHostname,_LOCALHOST))) {
      virtualHostname=getCanonicalDomain(virtualHostname,portalDomain);
      virtualHostname=getPortalURL(virtualHostname,themeDisplay.getServerPort(),themeDisplay.isSecure());
      String path=StringPool.BLANK;
      if (themeDisplay.isWidget()) {
        path=PropsValues.WIDGET_SERVLET_MAPPING;
      }
      if (themeDisplay.isI18n() && !canonicalURL) {
        path=themeDisplay.getI18nPath();
      }
      return virtualHostname.concat(_pathContext).concat(path);
    }
 else {
      LayoutSet curLayoutSet=LayoutSetLocalServiceUtil.getLayoutSet(themeDisplay.getSiteGroupId(),privateLayoutSet);
      if (canonicalURL || ((layoutSet.getLayoutSetId() != curLayoutSet.getLayoutSetId()) && (group.getClassPK() != themeDisplay.getUserId()))) {
        if (group.isControlPanel()) {
          virtualHostname=themeDisplay.getServerName();
          if (Validator.isNull(virtualHostname) || StringUtil.equalsIgnoreCase(virtualHostname,_LOCALHOST)) {
            virtualHostname=curLayoutSet.getVirtualHostname();
          }
        }
        if (Validator.isNull(virtualHostname) || StringUtil.equalsIgnoreCase(virtualHostname,_LOCALHOST)) {
          Company company=themeDisplay.getCompany();
          virtualHostname=company.getVirtualHostname();
        }
        if (canonicalURL || !StringUtil.equalsIgnoreCase(virtualHostname,_LOCALHOST)) {
          virtualHostname=getCanonicalDomain(virtualHostname,portalDomain);
          portalURL=getPortalURL(virtualHostname,themeDisplay.getServerPort(),themeDisplay.isSecure());
        }
      }
    }
  }
  String friendlyURL=null;
  if (privateLayoutSet) {
    if (group.isUser()) {
      friendlyURL=_PRIVATE_USER_SERVLET_MAPPING;
    }
 else {
      friendlyURL=_PRIVATE_GROUP_SERVLET_MAPPING;
    }
  }
 else {
    friendlyURL=_PUBLIC_GROUP_SERVLET_MAPPING;
  }
  StringBundler sb=new StringBundler(6);
  sb.append(portalURL);
  sb.append(_pathContext);
  if (themeDisplay.isI18n() && !canonicalURL) {
    sb.append(themeDisplay.getI18nPath());
  }
  if (themeDisplay.isWidget()) {
    sb.append(PropsValues.WIDGET_SERVLET_MAPPING);
  }
  sb.append(friendlyURL);
  sb.append(group.getFriendlyURL());
  return sb.toString();
}
