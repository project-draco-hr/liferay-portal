{
  PermissionChecker permissionChecker=themeDisplay.getPermissionChecker();
  Group scopeGroup=themeDisplay.getScopeGroup();
  Group group=scopeGroup;
  List<Portlet> filteredPortlets=new ArrayList<Portlet>();
  boolean contentCategory=category.equals(PortletCategoryKeys.CONTENT);
  if (contentCategory && group.isLayout()) {
    for (    Portlet portlet : portlets) {
      if (portlet.isScopeable()) {
        filteredPortlets.add(portlet);
      }
    }
  }
 else {
    filteredPortlets.addAll(portlets);
  }
  if (permissionChecker.isCompanyAdmin()) {
    return filteredPortlets;
  }
  if (category.equals(PortletCategoryKeys.CONTENT) && permissionChecker.isCommunityAdmin(group.getGroupId())) {
    return filteredPortlets;
  }
  Iterator<Portlet> itr=filteredPortlets.iterator();
  while (itr.hasNext()) {
    Portlet portlet=itr.next();
    try {
      if (PortletPermissionUtil.contains(permissionChecker,LayoutConstants.DEFAULT_PLID,portlet.getPortletId(),ActionKeys.ACCESS_IN_CONTROL_PANEL,true)) {
        continue;
      }
      ControlPanelEntry controlPanelEntry=portlet.getControlPanelEntryInstance();
      if ((controlPanelEntry == null) || (!controlPanelEntry.isVisible(permissionChecker,portlet))) {
        itr.remove();
      }
    }
 catch (    Exception e) {
      _log.error(e,e);
      itr.remove();
    }
  }
  return filteredPortlets;
}
