{
  ThemeDisplay themeDisplay=(ThemeDisplay)request.getAttribute(WebKeys.THEME_DISPLAY);
  Layout layout=themeDisplay.getLayout();
  String layoutFriendlyURL=getLayoutFriendlyURL(layout,themeDisplay,locale);
  int pos=url.indexOf(Portal.FRIENDLY_URL_SEPARATOR);
  if (pos == -1) {
    pos=url.indexOf(StringPool.QUESTION);
  }
  if (pos != -1) {
    url=url.substring(pos);
  }
 else {
    url=StringPool.BLANK;
  }
  String host=StringPool.BLANK;
  Group group=layout.getGroup();
  String groupFriendlyURL=group.getFriendlyURL();
  pos=layoutFriendlyURL.indexOf(groupFriendlyURL);
  if (pos != -1) {
    host=getPortalURL(request);
  }
  if (layout.isFirstParent() && Validator.isNull(url)) {
    String friendlyURL=layoutFriendlyURL.substring(0,layoutFriendlyURL.indexOf(layout.getFriendlyURL()));
    url=host.concat(friendlyURL);
  }
 else {
    url=host.concat(layoutFriendlyURL).concat(url);
  }
  return url;
}
