{
  List<Group> groups=new ArrayList<Group>();
  Group siteGroup=doGetCurrentSiteGroup(groupId);
  if (siteGroup != null) {
    groups.add(siteGroup);
    groups.addAll(GroupLocalServiceUtil.getGroups(siteGroup.getCompanyId(),Layout.class.getName(),siteGroup.getGroupId()));
  }
  if (PrefsPropsUtil.getBoolean(companyId,PropsKeys.SITES_CONTENT_SHARING_THROUGH_ADMINISTRATORS_ENABLED)) {
    LinkedHashMap<String,Object> groupParams=new LinkedHashMap<String,Object>();
    groupParams.put("site",Boolean.TRUE);
    groupParams.put("usersGroups",userId);
    groups.addAll(GroupLocalServiceUtil.search(companyId,null,null,groupParams,QueryUtil.ALL_POS,QueryUtil.ALL_POS,null));
  }
  groups.addAll(siteGroup.getDescendants(true));
  int sitesContentSharingWithChildrenEnabled=PrefsPropsUtil.getInteger(companyId,PropsKeys.SITES_CONTENT_SHARING_WITH_CHILDREN_ENABLED);
  if (sitesContentSharingWithChildrenEnabled != Sites.CONTENT_SHARING_WITH_CHILDREN_DISABLED) {
    groups.addAll(doGetAncestorSiteGroups(groupId,true));
  }
  long[] groupIds=new long[groups.size()];
  groups=ListUtil.unique(groups);
  for (int i=0; i < groups.size(); i++) {
    Group group=groups.get(i);
    groupIds[i]=group.getGroupId();
  }
  return groupIds;
}
