{
  LayoutTypePortlet layoutType=(LayoutTypePortlet)layout.getLayoutType();
  if ((windowState == null) || (Validator.isNull(windowState.toString()))) {
    if (layoutType.hasStateMaxPortletId(portletId)) {
      return WindowState.MAXIMIZED;
    }
 else     if (layoutType.hasStateMinPortletId(portletId)) {
      return WindowState.MINIMIZED;
    }
 else {
      return WindowState.NORMAL;
    }
  }
 else {
    boolean updateLayout=false;
    if (windowState.equals(WindowState.MAXIMIZED) && !layoutType.hasStateMaxPortletId(portletId)) {
      layoutType.addStateMaxPortletId(portletId);
      updateLayout=true;
    }
 else     if (windowState.equals(WindowState.MINIMIZED) && !layoutType.hasStateMinPortletId(portletId)) {
      layoutType.addStateMinPortletId(portletId);
      updateLayout=true;
    }
 else     if (windowState.equals(WindowState.NORMAL) && !layoutType.hasStateNormalPortletId(portletId)) {
      layoutType.removeStatesPortletId(portletId);
      updateLayout=true;
    }
    if (portletId.equals(PortletKeys.PORTLET_CONFIGURATION) || portletId.equals(PortletKeys.LAYOUT_MANAGEMENT)) {
      updateLayout=false;
    }
    if (updateLayout) {
      LayoutClone layoutClone=LayoutCloneFactory.getInstance();
      if (layoutClone != null) {
        layoutClone.update(request,layout.getPlid(),layout.getTypeSettings());
      }
    }
    return windowState;
  }
}
