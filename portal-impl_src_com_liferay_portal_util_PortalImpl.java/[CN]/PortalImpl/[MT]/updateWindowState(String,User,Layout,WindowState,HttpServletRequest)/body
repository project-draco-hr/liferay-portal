{
  LayoutTypePortlet layoutType=(LayoutTypePortlet)layout.getLayoutType();
  if ((windowState == null) || Validator.isNull(windowState.toString())) {
    if (layoutType.hasStateMaxPortletId(portletId)) {
      windowState=WindowState.MAXIMIZED;
    }
 else     if (layoutType.hasStateMinPortletId(portletId)) {
      windowState=WindowState.MINIMIZED;
    }
 else {
      windowState=WindowState.NORMAL;
    }
  }
 else {
    boolean updateLayout=false;
    if (windowState.equals(WindowState.MAXIMIZED) && !layoutType.hasStateMaxPortletId(portletId)) {
      layoutType.addStateMaxPortletId(portletId);
      if (PropsValues.LAYOUT_REMEMBER_MAXIMIZED_WINDOW_STATE) {
        updateLayout=true;
      }
    }
 else     if (windowState.equals(WindowState.MINIMIZED) && !layoutType.hasStateMinPortletId(portletId)) {
      layoutType.addStateMinPortletId(portletId);
      updateLayout=true;
    }
 else     if (windowState.equals(WindowState.NORMAL) && !layoutType.hasStateNormalPortletId(portletId)) {
      layoutType.removeStatesPortletId(portletId);
      updateLayout=true;
    }
    if (updateLayout) {
      LayoutClone layoutClone=LayoutCloneFactory.getInstance();
      if (layoutClone != null) {
        layoutClone.update(request,layout.getPlid(),layout.getTypeSettings());
      }
    }
  }
  ThemeDisplay themeDisplay=(ThemeDisplay)request.getAttribute(WebKeys.THEME_DISPLAY);
  themeDisplay.setStateExclusive(windowState.equals(LiferayWindowState.EXCLUSIVE));
  themeDisplay.setStateMaximized(windowState.equals(WindowState.MAXIMIZED));
  themeDisplay.setStatePopUp(windowState.equals(LiferayWindowState.POP_UP));
  request.setAttribute(WebKeys.WINDOW_STATE,windowState);
  return windowState;
}
