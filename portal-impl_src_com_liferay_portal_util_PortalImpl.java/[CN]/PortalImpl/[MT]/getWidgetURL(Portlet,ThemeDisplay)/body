{
  String layoutURL=getLayoutURL(themeDisplay);
  StringBuilder sb=new StringBuilder();
  if (Validator.isNull(_pathContext)) {
    if (_hasDomain(layoutURL)) {
      String protocol=HttpUtil.getProtocol(layoutURL);
      layoutURL=HttpUtil.removeProtocol(layoutURL);
      String[] parts=layoutURL.split("/",2);
      sb.append(protocol);
      sb.append(StringPool.PROTOCOL_SEPARATOR);
      sb.append(parts[0]);
      sb.append("/widget/");
      sb.append(parts[1]);
    }
 else {
      sb.append(themeDisplay.getPortalURL());
      sb.append("/widget");
      sb.append(layoutURL);
    }
  }
 else {
    if (_hasDomain(layoutURL)) {
      String protocol=HttpUtil.getProtocol(layoutURL);
      layoutURL=HttpUtil.removeProtocol(layoutURL);
      String[] parts=layoutURL.split("/",2);
      sb.append(protocol);
      sb.append(StringPool.PROTOCOL_SEPARATOR);
      sb.append(parts[0]);
      sb.append(_pathContext);
      sb.append("/widget/");
      sb.append(StringUtil.replace(parts[1],_pathContext,StringPool.BLANK));
    }
 else {
      sb.append(themeDisplay.getPortalURL());
      sb.append("/widget");
      sb.append(layoutURL);
    }
  }
  sb.append("/-/");
  FriendlyURLMapper friendlyURLMapper=portlet.getFriendlyURLMapperInstance();
  if (friendlyURLMapper != null) {
    sb.append(friendlyURLMapper.getMapping());
  }
 else {
    sb.append(portlet.getPortletId());
  }
  return sb.toString();
}
