{
  String layoutURL=getLayoutURL(themeDisplay);
  Layout layout=themeDisplay.getLayout();
  StringBuilder sb=new StringBuilder();
  if (HttpUtil.hasDomain(layoutURL)) {
    String protocol=HttpUtil.getProtocol(layoutURL);
    String domain=HttpUtil.getDomain(layoutURL);
    HttpUtil.removeDomain(layoutURL);
    sb.append(protocol);
    sb.append(Http.PROTOCOL_DELIMITER);
    sb.append(domain);
    if (Validator.isNotNull(_pathContext)) {
      sb.append(_pathContext);
    }
    if (themeDisplay.isI18n()) {
      sb.append(StringPool.SLASH);
      sb.append(themeDisplay.getI18nLanguageId());
    }
    sb.append(PropsValues.WIDGET_SERVLET_MAPPING);
    sb.append(layout.getFriendlyURL());
  }
 else {
    sb.append(themeDisplay.getPortalURL());
    if (Validator.isNotNull(_pathContext)) {
      sb.append(_pathContext);
    }
    if (themeDisplay.isI18n()) {
      sb.append(StringPool.SLASH);
      sb.append(themeDisplay.getI18nLanguageId());
    }
    sb.append(PropsValues.WIDGET_SERVLET_MAPPING);
    Group group=layout.getGroup();
    if (layout.isPrivateLayout()) {
      if (group.isUser()) {
        sb.append(_PRIVATE_USER_SERVLET_MAPPING);
      }
 else {
        sb.append(_PRIVATE_GROUP_SERVLET_MAPPING);
      }
    }
 else {
      sb.append(_PUBLIC_GROUP_SERVLET_MAPPING);
    }
    sb.append(group.getFriendlyURL());
    sb.append(layout.getFriendlyURL());
  }
  sb.append("/-/");
  FriendlyURLMapper friendlyURLMapper=portlet.getFriendlyURLMapperInstance();
  if (friendlyURLMapper != null) {
    sb.append(friendlyURLMapper.getMapping());
  }
 else {
    sb.append(portlet.getPortletId());
  }
  return sb.toString();
}
