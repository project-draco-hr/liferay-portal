{
  String groupFriendlyURL=StringPool.BLANK;
  String parametersURL=StringPool.BLANK;
  if (Validator.isNotNull(completeURL)) {
    completeURL=removeRedirectParameter(completeURL);
    int pos=completeURL.indexOf(Portal.FRIENDLY_URL_SEPARATOR);
    if (pos == -1) {
      pos=completeURL.indexOf(StringPool.QUESTION);
    }
    groupFriendlyURL=completeURL;
    if (pos != -1) {
      groupFriendlyURL=completeURL.substring(0,pos);
      parametersURL=completeURL.substring(pos);
    }
  }
  if (layout == null) {
    layout=themeDisplay.getLayout();
  }
  String canonicalLayoutFriendlyURL=StringPool.BLANK;
  String layoutFriendlyURL=layout.getFriendlyURL(themeDisplay.getLocale());
  if ((groupFriendlyURL.contains(layoutFriendlyURL) || groupFriendlyURL.contains(StringPool.SLASH + layout.getLayoutId())) && (!layout.isFirstParent() || Validator.isNotNull(parametersURL))) {
    canonicalLayoutFriendlyURL=layoutFriendlyURL;
  }
 else   if (forceLayoutFriendlyURL) {
    canonicalLayoutFriendlyURL=layoutFriendlyURL;
  }
  Group group=layout.getGroup();
  groupFriendlyURL=getGroupFriendlyURL(group,layout.isPrivateLayout(),themeDisplay,true);
  return groupFriendlyURL.concat(canonicalLayoutFriendlyURL).concat(parametersURL);
}
