{
  String virtualHostname=getVirtualHostname(themeDisplay.getLayoutSet());
  if (Validator.isNull(virtualHostname)) {
    Company company=themeDisplay.getCompany();
    virtualHostname=company.getVirtualHostname();
  }
  String portalURL=themeDisplay.getPortalURL();
  String portalDomain=HttpUtil.getDomain(portalURL);
  if (!Validator.isBlank(portalDomain) && !StringUtil.equalsIgnoreCase(portalDomain,_LOCALHOST) && StringUtil.equalsIgnoreCase(virtualHostname,_LOCALHOST)) {
    virtualHostname=portalDomain;
  }
  String i18nPath=buildI18NPath(locale);
  if (Validator.isNull(virtualHostname)) {
    return canonicalURL.replaceFirst(_PUBLIC_GROUP_SERVLET_MAPPING,i18nPath.concat(_PUBLIC_GROUP_SERVLET_MAPPING));
  }
  int pos=canonicalURL.indexOf(virtualHostname);
  if (pos > 0) {
    pos=canonicalURL.indexOf(CharPool.SLASH,pos + virtualHostname.length());
    if (Validator.isNotNull(_pathContext)) {
      pos=canonicalURL.indexOf(CharPool.SLASH,pos + _pathContext.length());
    }
    if ((pos > 0) && (pos < canonicalURL.length())) {
      String currentURL=canonicalURL.substring(pos);
      int[] friendlyURLIndex=getGroupFriendlyURLIndex(currentURL);
      boolean replaceFriendlyURL=true;
      if (friendlyURLIndex != null) {
        int y=friendlyURLIndex[1];
        currentURL=currentURL.substring(y);
        if (currentURL.equals(StringPool.SLASH)) {
          replaceFriendlyURL=false;
        }
      }
      if (replaceFriendlyURL) {
        String canonicalURLPrefix=canonicalURL.substring(0,pos);
        String canonicalURLSuffix=canonicalURL.substring(pos);
        canonicalURLSuffix=StringUtil.replaceFirst(canonicalURLSuffix,layout.getFriendlyURL(),layout.getFriendlyURL(locale));
        canonicalURL=canonicalURLPrefix.concat(canonicalURLSuffix);
      }
      Locale siteDefaultLocale=getSiteDefaultLocale(layout.getGroupId());
      if (siteDefaultLocale.equals(locale)) {
        return canonicalURL;
      }
      return canonicalURL.substring(0,pos).concat(i18nPath).concat(canonicalURL.substring(pos));
    }
  }
  return canonicalURL.concat(i18nPath);
}
