{
  ThemeDisplay themeDisplay=(ThemeDisplay)request.getAttribute(WebKeys.THEME_DISPLAY);
  long plid=0;
  try {
    plid=getControlPanelPlid(themeDisplay.getCompanyId());
  }
 catch (  Exception e) {
    _log.error("Unable to determine control panel layout id",e);
  }
  LiferayPortletURL liferayPortletURL=new PortletURLImpl(request,portletId,plid,lifecycle);
  liferayPortletURL.setDoAsGroupId(themeDisplay.getScopeGroupId());
  liferayPortletURL.setRefererPlid(themeDisplay.getPlid());
  return liferayPortletURL;
}
