{
  User user=(User)request.getAttribute(WebKeys.USER);
  if (user != null) {
    return user;
  }
  long userId=getUserId(request);
  if (userId <= 0) {
    String remoteUser=request.getRemoteUser();
    if (remoteUser == null) {
      return null;
    }
    if (PropsValues.PORTAL_JAAS_ENABLE) {
      long companyId=getCompanyId(request);
      try {
        userId=JAASHelper.getJaasUserId(companyId,remoteUser);
      }
 catch (      Exception e) {
        if (_log.isWarnEnabled()) {
          _log.warn(e);
        }
      }
    }
 else {
      userId=GetterUtil.getLong(remoteUser);
    }
  }
  if (userId > 0) {
    user=UserLocalServiceUtil.getUserById(userId);
    request.setAttribute(WebKeys.USER,user);
  }
  Cookie[] cookies=request.getCookies();
  if (cookies != null) {
    for (    Cookie cookie : cookies) {
      String cookieName=cookie.getName();
      if (cookieName.startsWith(CookieKeys.REMOTE_PREFERENCE_PREFIX)) {
        user.addRemotePreference(new CookieRemotePreference(cookie));
      }
    }
  }
  return user;
}
