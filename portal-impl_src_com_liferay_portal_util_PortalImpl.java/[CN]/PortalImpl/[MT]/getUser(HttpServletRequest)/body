{
  User user=(User)request.getAttribute(WebKeys.USER);
  if (user != null) {
    return user;
  }
  long userId=getUserId(request);
  if (userId <= 0) {
    String remoteUser=request.getRemoteUser();
    if (remoteUser == null) {
      return null;
    }
    userId=GetterUtil.getLong(remoteUser);
  }
  if (userId > 0) {
    user=UserLocalServiceUtil.getUserById(userId);
    request.setAttribute(WebKeys.USER,user);
  }
  for (  Cookie cookie : request.getCookies()) {
    String cookieName=cookie.getName();
    if (cookieName.startsWith(CookieKeys.REMOTE_PREFERENCES_PREFIX)) {
      String name=cookieName.substring(CookieKeys.REMOTE_PREFERENCES_PREFIX.length());
      user.addRemotePreference(name,cookie.getValue());
    }
  }
  return user;
}
