{
  String i18nPath=generateI18NPath(locale);
  ThemeDisplay themeDisplay=(ThemeDisplay)request.getAttribute(WebKeys.THEME_DISPLAY);
  String virtualHost=themeDisplay.getLayout().getLayoutSet().getVirtualHostname();
  int posVirtualHost=-1;
  if (Validator.isNotNull(virtualHost)) {
    posVirtualHost=url.indexOf(virtualHost);
  }
  if (posVirtualHost == -1) {
    virtualHost=getCompany(request).getVirtualHostname();
    if (Validator.isNotNull(virtualHost)) {
      posVirtualHost=url.indexOf(virtualHost);
    }
  }
  if (posVirtualHost != -1) {
    String pattern=virtualHost + "(:\\d{1,5})?";
    String parts[]=url.split(pattern,2);
    if (parts[1].length() > 0) {
      StringBuffer sb=new StringBuffer(url);
      int posPage=url.indexOf(parts[1],parts[0].length());
      sb.insert(posPage,i18nPath);
      url=sb.toString();
    }
 else {
      url=url.concat(i18nPath);
    }
  }
 else {
    url=url.replaceFirst(_PUBLIC_GROUP_SERVLET_MAPPING,i18nPath.concat(_PUBLIC_GROUP_SERVLET_MAPPING));
  }
  return url;
}
