{
  ThemeDisplay themeDisplay=(ThemeDisplay)request.getAttribute(WebKeys.THEME_DISPLAY);
  LayoutSet layoutSet=themeDisplay.getLayoutSet();
  String virtualHost=null;
  if (Validator.isNotNull(layoutSet.getVirtualHostname())) {
    virtualHost=layoutSet.getVirtualHostname();
  }
 else {
    Company company=themeDisplay.getCompany();
    virtualHost=company.getVirtualHostname();
  }
  String i18nPath=buildI18NPath(locale);
  if (Validator.isNull(virtualHost)) {
    return canonicalURL.replaceFirst(_PUBLIC_GROUP_SERVLET_MAPPING,i18nPath.concat(_PUBLIC_GROUP_SERVLET_MAPPING));
  }
  String[] canonicalURLParts=canonicalURL.split(virtualHost.concat("(:\\d{1,5})?"),2);
  if ((canonicalURLParts.length > 0) && Validator.isNotNull(canonicalURLParts[1])) {
    int pos=canonicalURL.indexOf(canonicalURLParts[1],canonicalURLParts[0].length());
    return canonicalURL.substring(0,pos).concat(i18nPath).concat(canonicalURL.substring(pos));
  }
  return canonicalURL.concat(i18nPath);
}
