{
  ThemeDisplay themeDisplay=(ThemeDisplay)request.getAttribute(WebKeys.THEME_DISPLAY);
  LayoutSet layoutSet=themeDisplay.getLayoutSet();
  String virtualHost=null;
  if (Validator.isNotNull(layoutSet.getVirtualHostname())) {
    virtualHost=layoutSet.getVirtualHostname();
  }
 else {
    Company company=themeDisplay.getCompany();
    virtualHost=company.getVirtualHostname();
  }
  String i18nPath=generateI18NPath(locale);
  if (Validator.isNull(virtualHost)) {
    return canonicalURL.replaceFirst(_PUBLIC_GROUP_SERVLET_MAPPING,i18nPath.concat(_PUBLIC_GROUP_SERVLET_MAPPING));
  }
  String pattern=virtualHost.concat("(:\\d{1,5})?");
  String parts[]=canonicalURL.split(pattern,2);
  if (parts.length > 0 && Validator.isNotNull(parts[1])) {
    StringBuffer sb=new StringBuffer(canonicalURL);
    int posPage=canonicalURL.indexOf(parts[1],parts[0].length());
    sb.insert(posPage,i18nPath);
    return sb.toString();
  }
 else {
    return canonicalURL.concat(i18nPath);
  }
}
