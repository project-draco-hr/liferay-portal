{
  long imageId=BeanPropertiesUtil.getLong(baseModel,fieldName);
  if (image) {
    if (ArrayUtil.isNotEmpty(bytes)) {
      if ((imageMaxSize > 0) && ((bytes == null) || (bytes.length > imageMaxSize))) {
        throw new ImageSizeException();
      }
      if (imageId <= 0) {
        imageId=CounterLocalServiceUtil.increment();
        BeanPropertiesUtil.setProperty(baseModel,fieldName,imageId);
      }
      if ((maxHeight > 0) || (maxWidht > 0)) {
        try {
          ImageBag imageBag=ImageToolUtil.read(bytes);
          RenderedImage renderedImage=imageBag.getRenderedImage();
          if (renderedImage == null) {
            throw new ImageTypeException();
          }
          renderedImage=ImageToolUtil.scale(renderedImage,maxHeight,maxWidht);
          bytes=ImageToolUtil.getBytes(renderedImage,imageBag.getType());
        }
 catch (        IOException ioe) {
          throw new ImageSizeException(ioe);
        }
      }
      ImageLocalServiceUtil.updateImage(imageId,bytes);
    }
  }
 else   if (imageId > 0) {
    ImageLocalServiceUtil.deleteImage(imageId);
    BeanPropertiesUtil.setProperty(baseModel,fieldName,0);
  }
}
