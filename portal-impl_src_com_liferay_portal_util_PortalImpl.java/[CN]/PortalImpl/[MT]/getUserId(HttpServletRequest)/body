{
  Long userIdObj=(Long)request.getAttribute(WebKeys.USER_ID);
  if (userIdObj != null) {
    return userIdObj.longValue();
  }
  String path=GetterUtil.getString(request.getPathInfo());
  String strutsAction=getStrutsAction(request);
  String actionName=_getPortletParam(request,"actionName");
  boolean alwaysAllowDoAsUser=false;
  if (path.equals("/portal/session_click") || strutsAction.equals("/document_library/edit_file_entry") || strutsAction.equals("/document_library_display/edit_file_entry")|| strutsAction.equals("/image_gallery_display/edit_file_entry")|| strutsAction.equals("/image_gallery_display/edit_image")|| strutsAction.equals("/wiki/edit_page_attachment")|| strutsAction.equals("/wiki_admin/edit_page_attachment")|| actionName.equals("addFile")) {
    try {
      alwaysAllowDoAsUser=isAlwaysAllowDoAsUser(request);
    }
 catch (    Exception e) {
      _log.error(e,e);
    }
  }
  if ((!PropsValues.PORTAL_JAAS_ENABLE && PropsValues.PORTAL_IMPERSONATION_ENABLE) || (alwaysAllowDoAsUser)) {
    String doAsUserIdString=ParamUtil.getString(request,"doAsUserId");
    try {
      long doAsUserId=getDoAsUserId(request,doAsUserIdString,alwaysAllowDoAsUser);
      if (doAsUserId > 0) {
        if (_log.isDebugEnabled()) {
          _log.debug("Impersonating user " + doAsUserId);
        }
        return doAsUserId;
      }
    }
 catch (    Exception e) {
      _log.error("Unable to impersonate user " + doAsUserIdString,e);
    }
  }
  HttpSession session=request.getSession();
  String jRemoteUser=null;
  if (PropsValues.PORTAL_JAAS_ENABLE) {
    jRemoteUser=(String)session.getAttribute("j_remoteuser");
  }
  if (Validator.isNotNull(jRemoteUser)) {
    userIdObj=GetterUtil.getLong(jRemoteUser);
  }
 else {
    userIdObj=(Long)session.getAttribute(WebKeys.USER_ID);
  }
  if (userIdObj != null) {
    request.setAttribute(WebKeys.USER_ID,userIdObj);
    return userIdObj.longValue();
  }
 else {
    return 0;
  }
}
