{
  String virtualHostname=layoutSet.getVirtualHostname();
  if (Validator.isNull(virtualHostname) && Validator.isNotNull(PropsValues.VIRTUAL_HOSTS_DEFAULT_SITE_NAME) && !layoutSet.isPrivateLayout()) {
    try {
      Group group=GroupLocalServiceUtil.getGroup(themeDisplay.getCompanyId(),PropsValues.VIRTUAL_HOSTS_DEFAULT_SITE_NAME);
      if (layoutSet.getGroupId() == group.getGroupId()) {
        Company company=themeDisplay.getCompany();
        virtualHostname=company.getVirtualHostname();
      }
    }
 catch (    Exception e) {
      _log.error(e,e);
    }
  }
  if (Validator.isNotNull(virtualHostname)) {
    String portalURL=getPortalURL(virtualHostname,themeDisplay.getServerPort(),themeDisplay.isSecure());
    long curLayoutSetId=themeDisplay.getLayout().getLayoutSet().getLayoutSetId();
    if ((layoutSet.getLayoutSetId() != curLayoutSetId) || portalURL.startsWith(themeDisplay.getURLPortal())) {
      String friendlyURL=StringPool.BLANK;
      if (themeDisplay.isI18n()) {
        friendlyURL=themeDisplay.getI18nPath();
      }
      String layoutSetFriendlyURL=portalURL + _pathContext + friendlyURL;
      return addPreservedParameters(themeDisplay,layoutSetFriendlyURL);
    }
  }
  Group group=GroupLocalServiceUtil.getGroup(layoutSet.getGroupId());
  String friendlyURL=null;
  if (layoutSet.isPrivateLayout()) {
    if (group.isUser()) {
      friendlyURL=_PRIVATE_USER_SERVLET_MAPPING;
    }
 else {
      friendlyURL=_PRIVATE_GROUP_SERVLET_MAPPING;
    }
  }
 else {
    friendlyURL=_PUBLIC_GROUP_SERVLET_MAPPING;
  }
  if (themeDisplay.isI18n()) {
    friendlyURL=themeDisplay.getI18nPath() + friendlyURL;
  }
  String layoutSetFriendlyURL=_pathContext + friendlyURL + group.getFriendlyURL();
  return addPreservedParameters(themeDisplay,layoutSetFriendlyURL);
}
