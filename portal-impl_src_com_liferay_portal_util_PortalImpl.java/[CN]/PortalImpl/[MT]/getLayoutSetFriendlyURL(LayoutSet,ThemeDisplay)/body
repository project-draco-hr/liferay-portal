{
  String virtualHost=layoutSet.getVirtualHost();
  if (Validator.isNull(virtualHost) && !layoutSet.isPrivateLayout() && Validator.isNotNull(PropsValues.VIRTUAL_HOSTS_DEFAULT_COMMUNITY_NAME)) {
    try {
      Group group=GroupLocalServiceUtil.getGroup(themeDisplay.getCompanyId(),PropsValues.VIRTUAL_HOSTS_DEFAULT_COMMUNITY_NAME);
      if (layoutSet.getGroupId() == group.getGroupId()) {
        Company company=themeDisplay.getCompany();
        virtualHost=company.getVirtualHost();
      }
    }
 catch (    Exception e) {
      _log.error(e,e);
    }
  }
  if (Validator.isNotNull(virtualHost)) {
    String portalURL=getPortalURL(virtualHost,themeDisplay.getServerPort(),themeDisplay.isSecure());
    long curLayoutSetId=themeDisplay.getLayout().getLayoutSet().getLayoutSetId();
    if ((layoutSet.getLayoutSetId() != curLayoutSetId) || (portalURL.startsWith(themeDisplay.getURLPortal()))) {
      String layoutSetFriendlyURL=StringPool.BLANK;
      if (themeDisplay.isI18n()) {
        layoutSetFriendlyURL=themeDisplay.getI18nPath();
      }
      return portalURL + _pathContext + layoutSetFriendlyURL;
    }
  }
  Group group=GroupLocalServiceUtil.getGroup(layoutSet.getGroupId());
  String friendlyURL=null;
  if (layoutSet.isPrivateLayout()) {
    if (group.isUser()) {
      friendlyURL=_PRIVATE_USER_SERVLET_MAPPING;
    }
 else {
      friendlyURL=_PRIVATE_GROUP_SERVLET_MAPPING;
    }
  }
 else {
    friendlyURL=_PUBLIC_GROUP_SERVLET_MAPPING;
  }
  if (themeDisplay.isI18n()) {
    friendlyURL=themeDisplay.getI18nPath() + friendlyURL;
  }
  return _pathContext + friendlyURL + group.getFriendlyURL();
}
