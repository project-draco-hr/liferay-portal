{
  if (layout == null) {
    return themeDisplay.getPathMain() + PATH_PORTAL_LAYOUT;
  }
  if (!layout.getType().equals(LayoutConstants.TYPE_URL)) {
    String layoutFriendlyURL=getLayoutFriendlyURL(layout,themeDisplay);
    if (Validator.isNotNull(layoutFriendlyURL)) {
      if (doAsUser) {
        if (Validator.isNotNull(themeDisplay.getDoAsUserId())) {
          layoutFriendlyURL=HttpUtil.addParameter(layoutFriendlyURL,"doAsUserId",themeDisplay.getDoAsUserId());
        }
        if (Validator.isNotNull(themeDisplay.getDoAsUserLanguageId())) {
          layoutFriendlyURL=HttpUtil.addParameter(layoutFriendlyURL,"doAsUserLanguageId",themeDisplay.getDoAsUserLanguageId());
        }
      }
      if (layout.getGroup().getName().equals(GroupConstants.CONTROL_PANEL)) {
        if (Validator.isNotNull(themeDisplay.getDoAsGroupId())) {
          layoutFriendlyURL=HttpUtil.addParameter(layoutFriendlyURL,"doAsGroupId",themeDisplay.getDoAsGroupId());
        }
        if (themeDisplay.getRefererPlid() != LayoutConstants.DEFAULT_PLID) {
          layoutFriendlyURL=HttpUtil.addParameter(layoutFriendlyURL,"refererPlid",themeDisplay.getRefererPlid());
        }
      }
      return layoutFriendlyURL;
    }
  }
  String layoutURL=getLayoutActualURL(layout);
  if (doAsUser) {
    if (Validator.isNotNull(themeDisplay.getDoAsUserId())) {
      layoutURL=HttpUtil.addParameter(layoutURL,"doAsUserId",themeDisplay.getDoAsUserId());
    }
    if (Validator.isNotNull(themeDisplay.getDoAsUserLanguageId())) {
      layoutURL=HttpUtil.addParameter(layoutURL,"doAsUserLanguageId",themeDisplay.getDoAsUserLanguageId());
    }
  }
  if (layout.getGroup().getName().equals(GroupConstants.CONTROL_PANEL)) {
    if (Validator.isNotNull(themeDisplay.getDoAsGroupId())) {
      layoutURL=HttpUtil.addParameter(layoutURL,"doAsGroupId",themeDisplay.getDoAsGroupId());
    }
    if (themeDisplay.getRefererPlid() != LayoutConstants.DEFAULT_PLID) {
      layoutURL=HttpUtil.addParameter(layoutURL,"refererPlid",themeDisplay.getRefererPlid());
    }
  }
  return layoutURL;
}
