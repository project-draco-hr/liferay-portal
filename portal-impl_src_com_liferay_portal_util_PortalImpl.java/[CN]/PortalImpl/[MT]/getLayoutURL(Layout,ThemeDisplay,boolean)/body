{
  if (layout == null) {
    return themeDisplay.getPathMain() + PATH_PORTAL_LAYOUT;
  }
  if (!layout.getType().equals(LayoutConstants.TYPE_URL)) {
    String layoutFriendlyURL=getLayoutFriendlyURL(layout,themeDisplay);
    if (Validator.isNotNull(layoutFriendlyURL)) {
      if (doAsUser) {
        if (Validator.isNotNull(themeDisplay.getDoAsUserId())) {
          layoutFriendlyURL=HttpUtil.addParameter(layoutFriendlyURL,"doAsUserId",themeDisplay.getDoAsUserId());
        }
        if (Validator.isNotNull(themeDisplay.getDoAsUserLanguageId())) {
          layoutFriendlyURL=HttpUtil.addParameter(layoutFriendlyURL,"doAsUserLanguageId",themeDisplay.getDoAsUserLanguageId());
        }
      }
      return layoutFriendlyURL;
    }
  }
  String layoutURL=getLayoutActualURL(layout);
  if (doAsUser) {
    if (Validator.isNotNull(themeDisplay.getDoAsUserId())) {
      layoutURL=HttpUtil.addParameter(layoutURL,"doAsUserId",themeDisplay.getDoAsUserId());
    }
    if (Validator.isNotNull(themeDisplay.getDoAsUserLanguageId())) {
      layoutURL=HttpUtil.addParameter(layoutURL,"doAsUserLanguageId",themeDisplay.getDoAsUserLanguageId());
    }
  }
  return layoutURL;
}
