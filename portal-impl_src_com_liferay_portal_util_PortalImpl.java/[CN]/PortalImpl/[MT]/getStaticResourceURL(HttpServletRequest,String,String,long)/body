{
  ThemeDisplay themeDisplay=(ThemeDisplay)request.getAttribute(WebKeys.THEME_DISPLAY);
  Theme theme=themeDisplay.getTheme();
  ColorScheme colorScheme=themeDisplay.getColorScheme();
  Map<String,String[]> parameterMap=null;
  if (Validator.isNotNull(queryString)) {
    parameterMap=HttpUtil.getParameterMap(queryString);
  }
  StringBuilder sb=new StringBuilder();
  sb.append(uri);
  sb.append(StringPool.QUESTION);
  if ((parameterMap == null) || (!parameterMap.containsKey("browserId"))) {
    sb.append("&browserId=");
    sb.append(BrowserSnifferUtil.getBrowserId(request));
  }
  if (uri.endsWith(".jsp")) {
    if ((parameterMap == null) || (!parameterMap.containsKey("themeId"))) {
      sb.append("&themeId=");
      sb.append(theme.getThemeId());
    }
    if ((parameterMap == null) || (!parameterMap.containsKey("colorSchemeId"))) {
      sb.append("&colorSchemeId=");
      sb.append(colorScheme.getColorSchemeId());
    }
  }
  if (themeDisplay.isThemeCssFastLoad()) {
    if ((parameterMap == null) || (!parameterMap.containsKey("minifierType"))) {
      String minifierType="js";
      if (uri.endsWith(".css") || uri.endsWith("css.jsp")) {
        minifierType="css";
      }
      sb.append("&minifierType=");
      sb.append(minifierType);
    }
  }
  if (Validator.isNotNull(queryString)) {
    if (!queryString.startsWith(StringPool.AMPERSAND)) {
      sb.append(StringPool.AMPERSAND);
    }
    sb.append(queryString);
  }
  if ((parameterMap == null) || (!parameterMap.containsKey("t"))) {
    sb.append("&t=");
    sb.append(theme.getTimestamp());
  }
  String url=sb.toString();
  url=StringUtil.replace(url,"?&",StringPool.QUESTION);
  return url;
}
