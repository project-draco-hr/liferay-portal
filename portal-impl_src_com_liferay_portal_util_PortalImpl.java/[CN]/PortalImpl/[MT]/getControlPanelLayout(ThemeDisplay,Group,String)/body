{
  Layout layout=null;
  try {
    long plid=getControlPanelPlid(themeDisplay.getCompanyId());
    layout=LayoutLocalServiceUtil.getLayout(plid);
  }
 catch (  PortalException pe) {
    _log.error("Unable to get control panel layout",pe);
    return null;
  }
  if (group == null) {
    Portlet portlet=PortletLocalServiceUtil.getPortletById(themeDisplay.getCompanyId(),portletId);
    String portletCategory=portlet.getControlPanelEntryCategory();
    if (portletCategory.equals(PortletCategoryKeys.CONTROL_PANEL_APPS) || portletCategory.equals(PortletCategoryKeys.CONTROL_PANEL_CONFIGURATION) || portletCategory.equals(PortletCategoryKeys.CONTROL_PANEL_SITES)|| portletCategory.equals(PortletCategoryKeys.CONTROL_PANEL_SYSTEM)|| portletCategory.equals(PortletCategoryKeys.CONTROL_PANEL_USERS)) {
      return layout;
    }
 else     if (portletCategory.equals(PortletCategoryKeys.USER_MY_ACCOUNT)) {
      User user=null;
      try {
        user=UserLocalServiceUtil.getUser(themeDisplay.getUserId());
      }
 catch (      PortalException pe) {
        _log.error("Unable to get user " + themeDisplay.getUserId());
      }
      group=user.getGroup();
    }
 else {
      long groupId=themeDisplay.getDoAsGroupId();
      if (groupId > 0) {
        group=GroupLocalServiceUtil.fetchGroup(groupId);
      }
      if (group == null) {
        group=themeDisplay.getScopeGroup();
      }
    }
  }
  return new VirtualLayout(layout,group);
}
