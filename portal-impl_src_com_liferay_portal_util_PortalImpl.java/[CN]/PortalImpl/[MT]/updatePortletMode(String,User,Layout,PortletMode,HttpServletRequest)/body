{
  LayoutTypePortlet layoutType=(LayoutTypePortlet)layout.getLayoutType();
  if ((portletMode == null) || Validator.isNull(portletMode.toString())) {
    if (layoutType.hasModeAboutPortletId(portletId)) {
      return LiferayPortletMode.ABOUT;
    }
 else     if (layoutType.hasModeConfigPortletId(portletId)) {
      return LiferayPortletMode.CONFIG;
    }
 else     if (layoutType.hasModeEditPortletId(portletId)) {
      return PortletMode.EDIT;
    }
 else     if (layoutType.hasModeEditDefaultsPortletId(portletId)) {
      return LiferayPortletMode.EDIT_DEFAULTS;
    }
 else     if (layoutType.hasModeEditGuestPortletId(portletId)) {
      return LiferayPortletMode.EDIT_GUEST;
    }
 else     if (layoutType.hasModeHelpPortletId(portletId)) {
      return PortletMode.HELP;
    }
 else     if (layoutType.hasModePreviewPortletId(portletId)) {
      return LiferayPortletMode.PREVIEW;
    }
 else     if (layoutType.hasModePrintPortletId(portletId)) {
      return LiferayPortletMode.PRINT;
    }
 else {
      return PortletMode.VIEW;
    }
  }
 else {
    Portlet portlet=PortletLocalServiceUtil.getPortletById(getCompanyId(request),portletId);
    ThemeDisplay themeDisplay=(ThemeDisplay)request.getAttribute(WebKeys.THEME_DISPLAY);
    PermissionChecker permissionChecker=themeDisplay.getPermissionChecker();
    if (!PortletPermissionUtil.contains(permissionChecker,getScopeGroupId(request),layout,portlet,ActionKeys.VIEW)) {
      return portletMode;
    }
    boolean updateLayout=false;
    if (portletMode.equals(LiferayPortletMode.ABOUT) && !layoutType.hasModeAboutPortletId(portletId)) {
      layoutType.addModeAboutPortletId(portletId);
      updateLayout=true;
    }
 else     if (portletMode.equals(LiferayPortletMode.CONFIG) && !layoutType.hasModeConfigPortletId(portletId) && PortletPermissionUtil.contains(permissionChecker,getScopeGroupId(request),layout,portlet,ActionKeys.CONFIGURATION)) {
      layoutType.addModeConfigPortletId(portletId);
      updateLayout=true;
    }
 else     if (portletMode.equals(PortletMode.EDIT) && !layoutType.hasModeEditPortletId(portletId) && PortletPermissionUtil.contains(permissionChecker,getScopeGroupId(request),layout,portlet,ActionKeys.PREFERENCES)) {
      layoutType.addModeEditPortletId(portletId);
      updateLayout=true;
    }
 else     if (portletMode.equals(LiferayPortletMode.EDIT_DEFAULTS) && !layoutType.hasModeEditDefaultsPortletId(portletId) && PortletPermissionUtil.contains(permissionChecker,getScopeGroupId(request),layout,portlet,ActionKeys.PREFERENCES)) {
      layoutType.addModeEditDefaultsPortletId(portletId);
      updateLayout=true;
    }
 else     if (portletMode.equals(LiferayPortletMode.EDIT_GUEST) && !layoutType.hasModeEditGuestPortletId(portletId) && PortletPermissionUtil.contains(permissionChecker,getScopeGroupId(request),layout,portlet,ActionKeys.GUEST_PREFERENCES)) {
      layoutType.addModeEditGuestPortletId(portletId);
      updateLayout=true;
    }
 else     if (portletMode.equals(PortletMode.HELP) && !layoutType.hasModeHelpPortletId(portletId)) {
      layoutType.addModeHelpPortletId(portletId);
      updateLayout=true;
    }
 else     if (portletMode.equals(LiferayPortletMode.PREVIEW) && !layoutType.hasModePreviewPortletId(portletId)) {
      layoutType.addModePreviewPortletId(portletId);
      updateLayout=true;
    }
 else     if (portletMode.equals(LiferayPortletMode.PRINT) && !layoutType.hasModePrintPortletId(portletId)) {
      layoutType.addModePrintPortletId(portletId);
      updateLayout=true;
    }
 else     if (portletMode.equals(PortletMode.VIEW) && !layoutType.hasModeViewPortletId(portletId)) {
      layoutType.removeModesPortletId(portletId);
      updateLayout=true;
    }
    if (updateLayout) {
      LayoutClone layoutClone=LayoutCloneFactory.getInstance();
      if (layoutClone != null) {
        layoutClone.update(request,layout.getPlid(),layout.getTypeSettings());
      }
    }
    return portletMode;
  }
}
