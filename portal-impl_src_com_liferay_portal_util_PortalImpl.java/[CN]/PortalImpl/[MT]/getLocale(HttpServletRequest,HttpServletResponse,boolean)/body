{
  User user=null;
  if (initialize) {
    try {
      user=initUser(request);
    }
 catch (    NoSuchUserException nsue) {
      return null;
    }
catch (    Exception e) {
    }
  }
  ThemeDisplay themeDisplay=(ThemeDisplay)request.getAttribute(WebKeys.THEME_DISPLAY);
  if (themeDisplay != null) {
    return themeDisplay.getLocale();
  }
  String i18nLanguageId=(String)request.getAttribute(WebKeys.I18N_LANGUAGE_ID);
  if (Validator.isNotNull(i18nLanguageId)) {
    return LocaleUtil.fromLanguageId(i18nLanguageId);
  }
  String doAsUserLanguageId=ParamUtil.getString(request,"doAsUserLanguageId");
  if (Validator.isNotNull(doAsUserLanguageId)) {
    return LocaleUtil.fromLanguageId(doAsUserLanguageId);
  }
  HttpSession session=request.getSession();
  if (session.getAttribute(Globals.LOCALE_KEY) != null) {
    return (Locale)session.getAttribute(Globals.LOCALE_KEY);
  }
  if (user == null) {
    try {
      user=getUser(request);
    }
 catch (    Exception e) {
    }
  }
  if ((user != null) && !user.isDefaultUser()) {
    Locale userLocale=getAvailableLocale(user.getLocale());
    if (userLocale != null) {
      if (initialize) {
        setLocale(request,response,userLocale);
      }
      return userLocale;
    }
  }
  String languageId=CookieKeys.getCookie(request,CookieKeys.GUEST_LANGUAGE_ID,false);
  if (Validator.isNotNull(languageId)) {
    Locale cookieLocale=getAvailableLocale(LocaleUtil.fromLanguageId(languageId));
    if (cookieLocale != null) {
      if (initialize) {
        setLocale(request,response,cookieLocale);
      }
      return cookieLocale;
    }
  }
  if (PropsValues.LOCALE_DEFAULT_REQUEST) {
    Enumeration<Locale> locales=request.getLocales();
    while (locales.hasMoreElements()) {
      Locale requestLocale=getAvailableLocale(locales.nextElement());
      if (requestLocale != null) {
        if (initialize) {
          setLocale(request,response,requestLocale);
        }
        return requestLocale;
      }
    }
  }
  Company company=null;
  try {
    company=getCompany(request);
  }
 catch (  Exception e) {
  }
  if (company == null) {
    return null;
  }
  User defaultUser=null;
  try {
    defaultUser=company.getDefaultUser();
  }
 catch (  Exception e) {
  }
  if (defaultUser == null) {
    return null;
  }
  Locale defaultUserLocale=getAvailableLocale(defaultUser.getLocale());
  if (defaultUserLocale == null) {
    return null;
  }
  if (initialize) {
    setLocale(request,response,defaultUserLocale);
  }
  return defaultUserLocale;
}
