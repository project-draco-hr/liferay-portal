{
  User user=null;
  if (initialize) {
    try {
      user=initUser(request);
    }
 catch (    NoSuchUserException nsue) {
      return null;
    }
catch (    Exception e) {
    }
  }
  Locale locale=null;
  ThemeDisplay themeDisplay=(ThemeDisplay)request.getAttribute(WebKeys.THEME_DISPLAY);
  if (themeDisplay != null) {
    locale=themeDisplay.getLocale();
    if (LanguageUtil.isAvailableLocale(themeDisplay.getSiteGroupId(),locale)) {
      return locale;
    }
  }
  long groupId=0;
  Layout layout=(Layout)request.getAttribute(WebKeys.LAYOUT);
  if ((layout != null) && !layout.isTypeControlPanel()) {
    try {
      long scopeGroupId=getScopeGroupId(request);
      groupId=getSiteGroupId(scopeGroupId);
    }
 catch (    Exception e) {
    }
  }
  String i18nLanguageId=(String)request.getAttribute(WebKeys.I18N_LANGUAGE_ID);
  if (Validator.isNotNull(i18nLanguageId)) {
    locale=LocaleUtil.fromLanguageId(i18nLanguageId);
    if (LanguageUtil.isAvailableLocale(groupId,locale)) {
      return locale;
    }
  }
  String doAsUserLanguageId=ParamUtil.getString(request,"doAsUserLanguageId");
  if (Validator.isNotNull(doAsUserLanguageId)) {
    locale=LocaleUtil.fromLanguageId(doAsUserLanguageId);
    if (LanguageUtil.isAvailableLocale(groupId,locale)) {
      return locale;
    }
  }
  HttpSession session=request.getSession();
  if (session.getAttribute(Globals.LOCALE_KEY) != null) {
    locale=(Locale)session.getAttribute(Globals.LOCALE_KEY);
    if (LanguageUtil.isAvailableLocale(groupId,locale)) {
      return locale;
    }
  }
  if (user == null) {
    try {
      user=getUser(request);
    }
 catch (    Exception e) {
    }
  }
  if ((user != null) && !user.isDefaultUser()) {
    Locale userLocale=getAvailableLocale(groupId,user.getLocale());
    if (userLocale != null) {
      if (LanguageUtil.isAvailableLocale(groupId,userLocale)) {
        if (initialize) {
          setLocale(request,response,userLocale);
        }
        return userLocale;
      }
    }
  }
  String languageId=CookieKeys.getCookie(request,CookieKeys.GUEST_LANGUAGE_ID,false);
  if (Validator.isNotNull(languageId)) {
    Locale cookieLocale=getAvailableLocale(groupId,LocaleUtil.fromLanguageId(languageId));
    if (cookieLocale != null) {
      if (LanguageUtil.isAvailableLocale(groupId,cookieLocale)) {
        if (initialize) {
          setLocale(request,response,cookieLocale);
        }
        return cookieLocale;
      }
    }
  }
  if (PropsValues.LOCALE_DEFAULT_REQUEST) {
    Enumeration<Locale> locales=request.getLocales();
    while (locales.hasMoreElements()) {
      Locale requestLocale=getAvailableLocale(groupId,locales.nextElement());
      if (requestLocale != null) {
        if (LanguageUtil.isAvailableLocale(groupId,requestLocale)) {
          if (initialize) {
            setLocale(request,response,requestLocale);
          }
          return requestLocale;
        }
      }
    }
  }
  Company company=null;
  try {
    company=getCompany(request);
  }
 catch (  Exception e) {
  }
  if (company == null) {
    return null;
  }
  User defaultUser=null;
  try {
    defaultUser=company.getDefaultUser();
  }
 catch (  Exception e) {
  }
  if (defaultUser == null) {
    return null;
  }
  Locale defaultUserLocale=getAvailableLocale(groupId,defaultUser.getLocale());
  if (defaultUserLocale != null) {
    if (LanguageUtil.isAvailableLocale(groupId,defaultUserLocale)) {
      if (initialize) {
        setLocale(request,response,defaultUserLocale);
      }
      return defaultUserLocale;
    }
  }
  try {
    if (themeDisplay != null) {
      return themeDisplay.getSiteDefaultLocale();
    }
  }
 catch (  Exception e) {
  }
  try {
    return PortalUtil.getSiteDefaultLocale(groupId);
  }
 catch (  Exception e) {
    return LocaleUtil.getDefault();
  }
}
