{
  if (!isLayoutFriendliable(layout)) {
    return null;
  }
  String layoutFriendlyURL=layout.getFriendlyURL();
  LayoutSet layoutSet=layout.getLayoutSet();
  long curLayoutSetId=themeDisplay.getLayout().getLayoutSet().getLayoutSetId();
  String portalURL=StringPool.BLANK;
  if (!themeDisplay.getServerName().equals(_LOCALHOST)) {
    String virtualHost=layoutSet.getVirtualHost();
    if (Validator.isNull(virtualHost) && Validator.isNotNull(PropsValues.VIRTUAL_HOSTS_DEFAULT_COMMUNITY_NAME) && !layoutSet.isPrivateLayout()) {
      try {
        Group group=GroupLocalServiceUtil.getGroup(themeDisplay.getCompanyId(),PropsValues.VIRTUAL_HOSTS_DEFAULT_COMMUNITY_NAME);
        if (layoutSet.getGroupId() == group.getGroupId()) {
          Company company=themeDisplay.getCompany();
          virtualHost=company.getVirtualHost();
        }
      }
 catch (      Exception e) {
        _log.error(e,e);
      }
    }
    if (Validator.isNotNull(virtualHost)) {
      virtualHost=getPortalURL(virtualHost,themeDisplay.getServerPort(),themeDisplay.isSecure());
      String portalDomain=HttpUtil.getDomain(themeDisplay.getPortalURL());
      if ((layoutSet.getLayoutSetId() != curLayoutSetId) || (virtualHost.indexOf(portalDomain) != -1)) {
        if (themeDisplay.isWidget()) {
          layoutFriendlyURL=PropsValues.WIDGET_SERVLET_MAPPING + layoutFriendlyURL;
        }
        if (themeDisplay.isI18n()) {
          layoutFriendlyURL=themeDisplay.getI18nPath() + layoutFriendlyURL;
        }
        return virtualHost + _pathContext + layoutFriendlyURL;
      }
    }
 else {
      if ((layoutSet.getLayoutSetId() != curLayoutSetId) && (layout.getGroup().getClassPK() != themeDisplay.getUserId())) {
        virtualHost=themeDisplay.getCompany().getVirtualHost();
        if (!virtualHost.equalsIgnoreCase(_LOCALHOST)) {
          portalURL=getPortalURL(virtualHost,themeDisplay.getServerPort(),themeDisplay.isSecure());
        }
      }
    }
  }
  Group group=layout.getGroup();
  String friendlyURL=null;
  if (layout.isPrivateLayout()) {
    if (group.isUser()) {
      friendlyURL=_PRIVATE_USER_SERVLET_MAPPING;
    }
 else {
      friendlyURL=_PRIVATE_GROUP_SERVLET_MAPPING;
    }
  }
 else {
    friendlyURL=_PUBLIC_GROUP_SERVLET_MAPPING;
  }
  if (themeDisplay.isWidget()) {
    friendlyURL=PropsValues.WIDGET_SERVLET_MAPPING + friendlyURL;
  }
  if (themeDisplay.isI18n()) {
    friendlyURL=themeDisplay.getI18nPath() + friendlyURL;
  }
  return portalURL + _pathContext + friendlyURL+ group.getFriendlyURL()+ layoutFriendlyURL;
}
