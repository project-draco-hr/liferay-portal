{
  ThemeDisplay themeDisplay=(ThemeDisplay)request.getAttribute(WebKeys.THEME_DISPLAY);
  if (themeDisplay != null) {
    return themeDisplay.getLocale();
  }
  String i18nLanguageId=(String)request.getAttribute(WebKeys.I18N_LANGUAGE_ID);
  if (Validator.isNotNull(i18nLanguageId)) {
    return LocaleUtil.fromLanguageId(i18nLanguageId);
  }
  String doAsUserLanguageId=ParamUtil.getString(request,"doAsUserLanguageId");
  if (Validator.isNotNull(doAsUserLanguageId)) {
    return LocaleUtil.fromLanguageId(doAsUserLanguageId);
  }
  HttpSession session=request.getSession();
  if (session.getAttribute(Globals.LOCALE_KEY) != null) {
    return (Locale)session.getAttribute(Globals.LOCALE_KEY);
  }
  User user=null;
  try {
    user=getUser(request);
  }
 catch (  Exception e) {
  }
  if ((user != null) && !user.isDefaultUser()) {
    Locale userLocale=getLocale(user.getLocale());
    if (userLocale != null) {
      return userLocale;
    }
  }
  String languageId=CookieKeys.getCookie(request,CookieKeys.GUEST_LANGUAGE_ID,false);
  if (Validator.isNotNull(languageId)) {
    Locale cookieLocale=getLocale(LocaleUtil.fromLanguageId(languageId));
    if (cookieLocale != null) {
      return cookieLocale;
    }
  }
  if (PropsValues.LOCALE_DEFAULT_REQUEST) {
    Enumeration<Locale> locales=request.getLocales();
    while (locales.hasMoreElements()) {
      Locale requestLocale=getLocale(locales.nextElement());
      if (requestLocale != null) {
        return requestLocale;
      }
    }
  }
  Company company=null;
  try {
    company=getCompany(request);
  }
 catch (  Exception e) {
  }
  if (company == null) {
    return null;
  }
  User defaultUser=null;
  try {
    defaultUser=company.getDefaultUser();
  }
 catch (  Exception e) {
  }
  if (defaultUser == null) {
    return null;
  }
  return getLocale(defaultUser.getLocale());
}
