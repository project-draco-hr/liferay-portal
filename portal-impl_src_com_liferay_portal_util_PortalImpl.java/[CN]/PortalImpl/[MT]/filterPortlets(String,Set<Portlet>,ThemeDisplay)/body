{
  PermissionChecker permissionChecker=themeDisplay.getPermissionChecker();
  Group group=themeDisplay.getScopeGroup();
  List<Portlet> filteredPortlets=new ArrayList<Portlet>();
  boolean contentCategory=category.equals(PortletCategoryKeys.CONTENT);
  if (contentCategory && group.isLayout()) {
    for (    Portlet portlet : portlets) {
      if (portlet.isScopeable()) {
        filteredPortlets.add(portlet);
      }
    }
  }
 else {
    filteredPortlets.addAll(portlets);
  }
  if (permissionChecker.isCompanyAdmin()) {
    return filteredPortlets;
  }
  if (category.equals(PortletCategoryKeys.CONTENT) && permissionChecker.isCommunityAdmin(group.getGroupId())) {
    return filteredPortlets;
  }
  Iterator<Portlet> itr=filteredPortlets.iterator();
  while (itr.hasNext()) {
    Portlet portlet=itr.next();
    if (!isShowPortlet(permissionChecker,portlet)) {
      itr.remove();
    }
  }
  return filteredPortlets;
}
