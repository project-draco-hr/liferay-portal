{
  String contextPath=getPathContext();
  String requestURI=request.getRequestURI();
  if (Validator.isNotNull(contextPath) && requestURI.contains(contextPath)) {
    requestURI=requestURI.substring(contextPath.length());
  }
  requestURI=StringUtil.replace(requestURI,StringPool.DOUBLE_SLASH,StringPool.SLASH);
  String path=request.getPathInfo();
  int x=path.indexOf(CharPool.SLASH,1);
  String layoutFriendlyURL=null;
  if ((x != -1) && ((x + 1) != path.length())) {
    layoutFriendlyURL=path.substring(x);
  }
  int y=layoutFriendlyURL.indexOf(VirtualLayoutConstants.CANONICAL_URL_SEPARATOR);
  if (y != -1) {
    y=layoutFriendlyURL.indexOf(CharPool.SLASH,3);
    if ((y != -1) && ((y + 1) != layoutFriendlyURL.length())) {
      layoutFriendlyURL=layoutFriendlyURL.substring(y);
    }
  }
  y=layoutFriendlyURL.indexOf(Portal.FRIENDLY_URL_SEPARATOR);
  if (y != -1) {
    layoutFriendlyURL=layoutFriendlyURL.substring(0,y);
  }
  if (requestURI.contains(layoutFriendlyURL)) {
    requestURI=StringUtil.replaceFirst(requestURI,layoutFriendlyURL,layout.getFriendlyURL(locale));
  }
  String i18nPath=getI18nPathLanguageId(locale,LocaleUtil.toLanguageId(locale));
  String localizedFriendlyURL=contextPath + StringPool.SLASH + i18nPath+ requestURI;
  String queryString=request.getQueryString();
  if (Validator.isNotNull(queryString)) {
    localizedFriendlyURL+=StringPool.QUESTION + request.getQueryString();
  }
  return localizedFriendlyURL;
}
