{
  InputStream inputStream=null;
  try {
    if (sourceFileVersion != null) {
      copy(sourceFileVersion,destinationFileVersion);
      return;
    }
    if (!PropsValues.DL_FILE_ENTRY_THUMBNAIL_ENABLED && !PropsValues.DL_FILE_ENTRY_PREVIEW_ENABLED) {
      return;
    }
    inputStream=destinationFileVersion.getContentStream(false);
    byte[] bytes=FileUtil.getBytes(inputStream);
    ImageBag imageBag=ImageToolUtil.read(bytes);
    RenderedImage renderedImage=imageBag.getRenderedImage();
    if (renderedImage == null) {
      return;
    }
    if (renderedImage.getColorModel().getNumComponents() == 4) {
      Future<RenderedImage> future=ImageToolUtil.convertCMYKtoRGB(bytes,imageBag.getType());
      if (future == null) {
        return;
      }
      String processIdentity=String.valueOf(destinationFileVersion.getFileVersionId());
      futures.put(processIdentity,future);
      RenderedImage convertedRenderedImage=future.get();
      if (convertedRenderedImage != null) {
        renderedImage=convertedRenderedImage;
      }
    }
    if (!_hasPreview(destinationFileVersion)) {
      _storePreviewImage(destinationFileVersion,renderedImage);
    }
    if (!hasThumbnails(destinationFileVersion)) {
      storeThumbnailImages(destinationFileVersion,renderedImage);
    }
  }
 catch (  NoSuchFileEntryException nsfee) {
  }
 finally {
    StreamUtil.cleanUp(inputStream);
    _fileVersionIds.remove(destinationFileVersion.getFileVersionId());
  }
}
