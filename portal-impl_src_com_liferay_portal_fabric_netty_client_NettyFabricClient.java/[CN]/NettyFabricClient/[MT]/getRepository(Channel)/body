{
  Attribute<Repository<Channel>> attribute=channel.attr(_repositoryAttributeKey);
  Repository<Channel> repository=attribute.get();
  if (repository == null) {
    Path repositoryPath=_nettyFabricClientConfig.getRepositoryPath();
    Files.createDirectories(repositoryPath);
    repository=new NettyRepository(repositoryPath,_nettyFabricClientConfig.getRepositoryGetFileTimeout());
    Repository<Channel> previousRepository=attribute.setIfAbsent(repository);
    if (previousRepository != null) {
      repository.dispose(true);
      repository=previousRepository;
    }
    ChannelPipeline channelPipeline=channel.pipeline();
    channelPipeline.addLast(new FileResponseChannelHandler(repository.getAsyncBroker(),getEventExecutorGroup(_channel,_fileServerEventExecutorGroupAttributeKey)));
  }
  return repository;
}
