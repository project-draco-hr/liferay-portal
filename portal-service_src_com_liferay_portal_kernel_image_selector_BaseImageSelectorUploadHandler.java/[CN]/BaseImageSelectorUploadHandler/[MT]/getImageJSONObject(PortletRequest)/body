{
  UploadPortletRequest uploadPortletRequest=PortalUtil.getUploadPortletRequest(portletRequest);
  ThemeDisplay themeDisplay=(ThemeDisplay)portletRequest.getAttribute(WebKeys.THEME_DISPLAY);
  JSONObject imageJSONObject=JSONFactoryUtil.createJSONObject();
  InputStream inputStream=null;
  try {
    imageJSONObject.put("attributeDataImageId",EditorConstants.ATTRIBUTE_DATA_IMAGE_ID);
    String fileName=uploadPortletRequest.getFileName("imageSelectorFileName");
    String contentType=uploadPortletRequest.getContentType("imageSelectorFileName");
    long size=uploadPortletRequest.getSize("imageSelectorFileName");
    validateFile(fileName,contentType,size);
    inputStream=uploadPortletRequest.getFileAsStream("imageSelectorFileName");
    FileEntry existingFileEntry=_fetchTempFileEntry(themeDisplay,fileName);
    int counterSuffixValue=1;
    while (existingFileEntry != null) {
      String curfileName=FileUtil.updateFileName(fileName,String.valueOf(counterSuffixValue));
      existingFileEntry=_fetchTempFileEntry(themeDisplay,curfileName);
      if (existingFileEntry == null) {
        fileName=curfileName;
        break;
      }
      counterSuffixValue++;
    }
    FileEntry fileEntry=TempFileEntryUtil.addTempFileEntry(themeDisplay.getScopeGroupId(),themeDisplay.getUserId(),_TEMP_FOLDER_NAME,fileName,inputStream,contentType);
    imageJSONObject.put("fileEntryId",fileEntry.getFileEntryId());
    imageJSONObject.put("url",PortletFileRepositoryUtil.getPortletFileEntryURL(themeDisplay,fileEntry,StringPool.BLANK));
    return imageJSONObject;
  }
 catch (  IOException ioe) {
    throw new SystemException(ioe);
  }
 finally {
    StreamUtil.cleanUp(inputStream);
  }
}
