{
  String poolId=PortletConfigFactory.class.getName();
  if (!portlet.isWARFile()) {
    StringMaker sm=new StringMaker();
    sm.append(poolId);
    sm.append(StringPool.PERIOD);
    sm.append(portlet.getCompanyId());
    poolId=sm.toString();
  }
  Map map=(Map)_pool.get(poolId);
  if (map == null) {
    map=CollectionFactory.getSyncHashMap();
    _pool.put(poolId,map);
  }
  Map portletConfigs=(Map)map.get(portlet.getRootPortletId());
  if (portletConfigs == null) {
    portletConfigs=CollectionFactory.getSyncHashMap();
    map.put(portlet.getRootPortletId(),portletConfigs);
  }
  PortletConfig portletConfig=(PortletConfig)portletConfigs.get(portlet.getPortletId());
  if (portletConfig == null) {
    PortletContext portletCtx=PortletContextFactory.create(portlet,ctx);
    portletConfig=new PortletConfigImpl(portlet.getPortletId(),portletCtx,portlet.getInitParams(),portlet.getResourceBundle(),portlet.getPortletInfo());
    portletConfigs.put(portlet.getPortletId(),portletConfig);
  }
  return portletConfig;
}
