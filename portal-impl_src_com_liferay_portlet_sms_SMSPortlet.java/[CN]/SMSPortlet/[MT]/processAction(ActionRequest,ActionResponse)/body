{
  try {
    String cmd=ParamUtil.getString(actionRequest,Constants.CMD);
    if (cmd.equals(Constants.SEND)) {
      String to=actionRequest.getParameter("to");
      String subject=ParamUtil.getString(actionRequest,"subject");
      String message=ParamUtil.getString(actionRequest,"message");
      if (!Validator.isEmailAddress(to)) {
        SessionErrors.add(actionRequest,"to");
      }
      if (SessionErrors.isEmpty(actionRequest)) {
        User user=PortalUtil.getUser(actionRequest);
        MailServiceUtil.sendEmail(new MailMessage(new InternetAddress(user.getEmailAddress(),user.getFullName()),new InternetAddress(to),subject,message));
        actionResponse.setRenderParameter("to",StringPool.BLANK);
        actionResponse.setRenderParameter("subject",StringPool.BLANK);
        actionResponse.setRenderParameter("message",StringPool.BLANK);
        SessionMessages.add(actionRequest,getPortletConfig().getPortletName() + ".send",to);
      }
 else {
        actionResponse.setRenderParameter("to",to);
        actionResponse.setRenderParameter("subject",subject);
        actionResponse.setRenderParameter("message",message);
      }
    }
  }
 catch (  Exception e) {
    throw new PortletException(e);
  }
}
