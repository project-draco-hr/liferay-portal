{
  try {
    String cmd=ParamUtil.getString(req,Constants.CMD);
    if (cmd.equals(Constants.SEND)) {
      String to=req.getParameter("to");
      String subject=ParamUtil.getString(req,"subject");
      String message=ParamUtil.getString(req,"message");
      if (!Validator.isEmailAddress(to)) {
        SessionErrors.add(req,"to");
      }
      if (SessionErrors.isEmpty(req)) {
        User user=PortalUtil.getUser(req);
        MailServiceUtil.sendEmail(new MailMessage(new InternetAddress(user.getEmailAddress(),user.getFullName()),new InternetAddress(to),subject,message));
        res.setRenderParameter("to",StringPool.BLANK);
        res.setRenderParameter("subject",StringPool.BLANK);
        res.setRenderParameter("message",StringPool.BLANK);
        SessionMessages.add(req,getPortletConfig().getPortletName() + ".send",to);
      }
 else {
        res.setRenderParameter("to",to);
        res.setRenderParameter("subject",subject);
        res.setRenderParameter("message",message);
      }
    }
  }
 catch (  Exception e) {
    throw new PortletException(e);
  }
}
