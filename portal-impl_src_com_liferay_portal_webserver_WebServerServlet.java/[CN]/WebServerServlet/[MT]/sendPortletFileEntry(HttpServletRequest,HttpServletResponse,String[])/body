{
  FileEntry fileEntry=getPortletFileEntry(request,pathArray);
  if (fileEntry == null) {
    return;
  }
  long fileEntryCompanyId=fileEntry.getCompanyId();
  if (_processCompanyInactiveRequest(request,response,fileEntryCompanyId)) {
    return;
  }
  String fileName=HttpUtil.decodeURL(HtmlUtil.escape(pathArray[2]));
  if (fileEntry.isInTrash()) {
    fileName=TrashUtil.getOriginalTitle(fileName);
  }
  boolean download=ParamUtil.getBoolean(request,"download");
  if (download) {
    ServletResponseUtil.sendFile(request,response,fileName,fileEntry.getContentStream(),fileEntry.getSize(),fileEntry.getMimeType(),HttpHeaders.CONTENT_DISPOSITION_ATTACHMENT);
  }
 else {
    InputStream is=fileEntry.getContentStream();
    FlashMagicBytesUtil.Result flashMagicBytesUtilResult=FlashMagicBytesUtil.check(is);
    is=flashMagicBytesUtilResult.getInputStream();
    if (flashMagicBytesUtilResult.isFlash()) {
      fileName=FileUtil.stripExtension(fileName) + ".swf";
    }
    ServletResponseUtil.sendFile(request,response,fileName,is,fileEntry.getSize(),fileEntry.getMimeType());
  }
}
