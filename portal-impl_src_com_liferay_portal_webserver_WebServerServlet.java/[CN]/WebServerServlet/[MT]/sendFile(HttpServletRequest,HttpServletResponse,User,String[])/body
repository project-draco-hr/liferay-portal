{
  FileEntry fileEntry=getFileEntry(pathArray);
  if (fileEntry == null) {
    throw new NoSuchFileEntryException();
  }
  String version=ParamUtil.getString(request,"version");
  if (Validator.isNull(version)) {
    if (Validator.isNotNull(fileEntry.getVersion())) {
      version=fileEntry.getVersion();
    }
  }
  String tempFileId=DLUtil.getTempFileId(fileEntry.getFileEntryId(),version);
  FileVersion fileVersion=fileEntry.getFileVersion(version);
  String fileName=fileVersion.getTitle();
  String extension=fileVersion.getExtension();
  if (!fileName.endsWith(StringPool.PERIOD + extension)) {
    fileName+=StringPool.PERIOD + extension;
  }
  boolean converted=false;
  String targetExtension=ParamUtil.getString(request,"targetExtension");
  int imageThumbnail=ParamUtil.getInteger(request,"imageThumbnail");
  boolean documentThumbnail=ParamUtil.getBoolean(request,"documentThumbnail");
  int previewFileIndex=ParamUtil.getInteger(request,"previewFileIndex");
  boolean audioPreview=ParamUtil.getBoolean(request,"audioPreview");
  boolean videoPreview=ParamUtil.getBoolean(request,"videoPreview");
  boolean videoThumbnail=ParamUtil.getBoolean(request,"videoThumbnail");
  InputStream inputStream=null;
  long contentLength=0;
  if ((imageThumbnail > 0) && (imageThumbnail < 3)) {
    fileName=FileUtil.stripExtension(fileName).concat(StringPool.PERIOD).concat(fileVersion.getExtension());
    if (imageThumbnail == 1) {
      inputStream=ImageProcessor.getThumbnailAsStream(fileVersion);
      contentLength=ImageProcessor.getThumbnailFileSize(fileVersion);
    }
 else     if (imageThumbnail == 2) {
      inputStream=ImageProcessor.getCustom1AsStream(fileVersion);
      contentLength=ImageProcessor.getCustom1FileSize(fileVersion);
    }
 else     if (imageThumbnail == 3) {
      inputStream=ImageProcessor.getCustom2AsStream(fileVersion);
      contentLength=ImageProcessor.getCustom2FileSize(fileVersion);
    }
    converted=true;
  }
 else   if (documentThumbnail) {
    fileName=FileUtil.stripExtension(fileName).concat(StringPool.PERIOD).concat(PDFProcessor.THUMBNAIL_TYPE);
    inputStream=PDFProcessor.getThumbnailAsStream(fileVersion);
    contentLength=PDFProcessor.getThumbnailFileSize(fileVersion);
    converted=true;
  }
 else   if (previewFileIndex > 0) {
    fileName=FileUtil.stripExtension(fileName).concat(StringPool.PERIOD).concat(PDFProcessor.PREVIEW_TYPE);
    inputStream=PDFProcessor.getPreviewAsStream(fileVersion,previewFileIndex);
    contentLength=PDFProcessor.getPreviewFileSize(fileVersion,previewFileIndex);
    converted=true;
  }
 else   if (audioPreview) {
    fileName=FileUtil.stripExtension(fileName).concat(StringPool.PERIOD).concat(AudioProcessor.PREVIEW_TYPE);
    inputStream=AudioProcessor.getPreviewAsStream(fileVersion);
    contentLength=AudioProcessor.getPreviewFileSize(fileVersion);
    converted=true;
  }
 else   if (videoPreview) {
    String type=ParamUtil.getString(request,"type");
    fileName=FileUtil.stripExtension(fileName).concat(StringPool.PERIOD).concat(type);
    inputStream=VideoProcessor.getPreviewAsStream(fileVersion,type);
    contentLength=VideoProcessor.getPreviewFileSize(fileVersion,type);
    response.setHeader(HttpHeaders.ACCEPT_RANGES,HttpHeaders.ACCEPT_RANGES_BYTES_VALUE);
    List<Range> ranges=null;
    try {
      ranges=ServletResponseUtil.getRanges(request,response,contentLength);
    }
 catch (    IOException ioe) {
      if (_log.isErrorEnabled()) {
        _log.error(ioe);
      }
      response.setHeader(HttpHeaders.CONTENT_RANGE,"bytes */" + contentLength);
      response.sendError(HttpServletResponse.SC_REQUESTED_RANGE_NOT_SATISFIABLE);
      return;
    }
    if ((ranges != null) && (ranges.size() > 0)) {
      if (_log.isDebugEnabled()) {
        _log.debug("Video range requested");
      }
      String contentType=MimeTypesUtil.getContentType(fileName);
      ServletResponseUtil.write(request,response,fileName,ranges,inputStream,contentLength,contentType);
      return;
    }
    converted=true;
  }
 else   if (videoThumbnail) {
    fileName=FileUtil.stripExtension(fileName).concat(StringPool.PERIOD).concat(VideoProcessor.THUMBNAIL_TYPE);
    inputStream=VideoProcessor.getThumbnailAsStream(fileVersion);
    contentLength=VideoProcessor.getThumbnailFileSize(fileVersion);
    converted=true;
  }
 else {
    inputStream=fileVersion.getContentStream(true);
    contentLength=fileVersion.getSize();
    if (Validator.isNotNull(targetExtension)) {
      File convertedFile=DocumentConversionUtil.convert(tempFileId,inputStream,extension,targetExtension);
      if (convertedFile != null) {
        fileName=FileUtil.stripExtension(fileName).concat(StringPool.PERIOD).concat(targetExtension);
        inputStream=new FileInputStream(convertedFile);
        contentLength=convertedFile.length();
        converted=true;
      }
    }
  }
  String contentType=null;
  if (converted) {
    contentType=MimeTypesUtil.getContentType(fileName);
  }
 else {
    contentType=fileVersion.getMimeType();
  }
  ServletResponseUtil.sendFile(request,response,fileName,inputStream,contentLength,contentType);
}
