{
  FileEntry fileEntry=getFileEntry(pathArray);
  if (fileEntry == null) {
    throw new NoSuchFileEntryException();
  }
  String version=ParamUtil.getString(request,"version");
  if (Validator.isNull(version)) {
    if (Validator.isNotNull(fileEntry.getVersion())) {
      version=fileEntry.getVersion();
    }
 else {
      throw new NoSuchFileEntryException();
    }
  }
  String tempFileId=DLUtil.getTempFileId(fileEntry.getFileEntryId(),version);
  InputStream inputStream=fileEntry.getContentStream(version);
  long contentLength=0;
  FileVersion fileVersion=fileEntry.getFileVersion(version);
  String fileName=fileVersion.getTitle();
  String extension=GetterUtil.getString(FileUtil.getExtension(fileName));
  if (Validator.isNull(extension) || !extension.equals(fileVersion.getExtension())) {
    fileName+=StringPool.PERIOD + fileVersion.getExtension();
  }
  boolean converted=false;
  String targetExtension=ParamUtil.getString(request,"targetExtension");
  boolean documentThumbnail=ParamUtil.getBoolean(request,"documentThumbnail");
  int previewFileIndex=ParamUtil.getInteger(request,"previewFileIndex");
  boolean audioPreview=ParamUtil.getBoolean(request,"audioPreview");
  boolean videoPreview=ParamUtil.getBoolean(request,"videoPreview");
  boolean videoThumbnail=ParamUtil.getBoolean(request,"videoThumbnail");
  if (Validator.isNotNull(targetExtension)) {
    File convertedFile=DocumentConversionUtil.convert(tempFileId,inputStream,extension,targetExtension);
    if (convertedFile != null) {
      fileName=FileUtil.stripExtension(fileName).concat(StringPool.PERIOD).concat(targetExtension);
      inputStream=new FileInputStream(convertedFile);
      contentLength=convertedFile.length();
      converted=true;
    }
  }
 else   if (documentThumbnail) {
    fileName=FileUtil.stripExtension(fileName).concat(StringPool.PERIOD).concat(PDFProcessor.THUMBNAIL_TYPE);
    File thumbnailFile=PDFProcessor.getThumbnailFile(tempFileId);
    inputStream=new FileInputStream(thumbnailFile);
    contentLength=thumbnailFile.length();
    converted=true;
  }
 else   if (previewFileIndex > 0) {
    fileName=FileUtil.stripExtension(fileName).concat(StringPool.PERIOD).concat(PDFProcessor.PREVIEW_TYPE);
    File previewFile=PDFProcessor.getPreviewFile(tempFileId,previewFileIndex);
    inputStream=new FileInputStream(previewFile);
    contentLength=previewFile.length();
    converted=true;
  }
 else   if (audioPreview) {
    fileName=FileUtil.stripExtension(fileName).concat(StringPool.PERIOD).concat(AudioProcessor.PREVIEW_TYPE);
    File previewFile=AudioProcessor.getPreviewFile(tempFileId);
    inputStream=new FileInputStream(previewFile);
    contentLength=previewFile.length();
    converted=true;
  }
 else   if (videoPreview) {
    fileName=FileUtil.stripExtension(fileName).concat(StringPool.PERIOD).concat(VideoProcessor.PREVIEW_TYPE);
    File previewFile=VideoProcessor.getPreviewFile(tempFileId);
    inputStream=new FileInputStream(previewFile);
    contentLength=previewFile.length();
    converted=true;
  }
 else   if (videoThumbnail) {
    fileName=FileUtil.stripExtension(fileName).concat(StringPool.PERIOD).concat(VideoProcessor.THUMBNAIL_TYPE);
    File thumbnailFile=VideoProcessor.getThumbnailFile(tempFileId);
    inputStream=new FileInputStream(thumbnailFile);
    contentLength=thumbnailFile.length();
    converted=true;
  }
  String contentType=fileEntry.getMimeType(version);
  if (!converted) {
    if (DLUtil.compareVersions(version,fileEntry.getVersion()) >= 0) {
      contentLength=fileEntry.getSize();
    }
 else {
      contentLength=fileVersion.getSize();
    }
  }
 else {
    contentType=MimeTypesUtil.getContentType(fileName);
  }
  ServletResponseUtil.sendFile(request,response,fileName,inputStream,contentLength,contentType);
}
