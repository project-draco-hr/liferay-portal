{
  FileEntry dlFileEntry=getDLFileEntry(pathArray);
  if (dlFileEntry == null) {
    throw new NoSuchFileEntryException();
  }
  String fileName=dlFileEntry.getTitle();
  String version=ParamUtil.getString(request,"version");
  String targetExtension=ParamUtil.getString(request,"targetExtension");
  if (Validator.isNull(version)) {
    if (Validator.isNotNull(dlFileEntry.getVersion())) {
      version=dlFileEntry.getVersion();
    }
 else {
      throw new NoSuchFileEntryException();
    }
  }
  FileVersion dlFileVersion=dlFileEntry.getFileVersion(version);
  fileName=dlFileVersion.getTitle();
  String extension=GetterUtil.getString(FileUtil.getExtension(fileName));
  if (Validator.isNull(extension) || !extension.equals(dlFileVersion.getExtension())) {
    fileName+=StringPool.PERIOD + dlFileVersion.getExtension();
  }
  InputStream inputStream=dlFileEntry.getContentStream(version);
  boolean converted=false;
  if (Validator.isNotNull(targetExtension)) {
    String id=DocumentConversionUtil.getTempFileId(dlFileEntry.getFileEntryId(),version);
    String sourceExtension=FileUtil.getExtension(fileName);
    InputStream convertedInputStream=DocumentConversionUtil.convert(id,inputStream,sourceExtension,targetExtension);
    if ((convertedInputStream != null) && (convertedInputStream != inputStream)) {
      fileName=FileUtil.stripExtension(fileName).concat(StringPool.PERIOD).concat(targetExtension);
      inputStream=convertedInputStream;
      converted=true;
    }
  }
  int contentLength=0;
  if (!converted) {
    if (DLUtil.compareVersions(version,dlFileEntry.getVersion()) >= 0) {
      contentLength=(int)dlFileEntry.getSize();
    }
 else {
      contentLength=(int)dlFileVersion.getSize();
    }
  }
  String contentType=MimeTypesUtil.getContentType(fileName);
  ServletResponseUtil.sendFile(request,response,fileName,inputStream,contentLength,contentType);
}
