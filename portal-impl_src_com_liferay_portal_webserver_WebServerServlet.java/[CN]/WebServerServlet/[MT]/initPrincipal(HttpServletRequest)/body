{
  long companyId=PortalUtil.getCompanyId(request);
  User user=PortalUtil.getUser(request);
  if (user == null) {
    Company company=CompanyLocalServiceUtil.getCompany(companyId);
    user=company.getDefaultUser();
  }
  PrincipalThreadLocal.setName(user.getUserId());
  PermissionChecker permissionChecker=PermissionCheckerFactoryUtil.create(user,true);
  PermissionThreadLocal.setPermissionChecker(permissionChecker);
  return user;
}
