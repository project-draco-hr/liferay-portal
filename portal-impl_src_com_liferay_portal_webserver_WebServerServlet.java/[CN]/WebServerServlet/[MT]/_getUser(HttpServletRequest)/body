{
  User user=PortalUtil.getUser(request);
  if (user == null) {
    long companyId=PortalUtil.getCompanyId(request);
    Company company=CompanyLocalServiceUtil.getCompany(companyId);
    user=company.getDefaultUser();
    HttpSession session=request.getSession();
    if (session != null) {
      String userIdString=(String)session.getAttribute("j_username");
      String passwordString=(String)session.getAttribute("j_password");
      if (userIdString != null && passwordString != null) {
        long userId=Long.valueOf(userIdString).longValue();
        user=UserLocalServiceUtil.getUser(userId);
      }
    }
  }
  return user;
}
