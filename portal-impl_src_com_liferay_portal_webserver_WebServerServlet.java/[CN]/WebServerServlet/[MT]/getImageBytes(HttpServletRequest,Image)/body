{
  byte[] textObj=image.getTextObj();
  if ((textObj == null) || (textObj.length == 0)) {
    throw new NoSuchFileException();
  }
  try {
    if (!PropsValues.IMAGE_AUTO_SCALE) {
      return textObj;
    }
    ImageBag imageBag=null;
    if (image.getImageId() == 0) {
      imageBag=ImageToolUtil.read(textObj);
      RenderedImage renderedImage=imageBag.getRenderedImage();
      image.setHeight(renderedImage.getHeight());
      image.setWidth(renderedImage.getWidth());
    }
    int height=ParamUtil.getInteger(request,"height",image.getHeight());
    int width=ParamUtil.getInteger(request,"width",image.getWidth());
    if ((height >= image.getHeight()) && (width >= image.getWidth())) {
      return textObj;
    }
    if (image.getImageId() != 0) {
      imageBag=ImageToolUtil.read(textObj);
    }
    RenderedImage renderedImage=ImageToolUtil.scale(imageBag.getRenderedImage(),height,width);
    return ImageToolUtil.getBytes(renderedImage,imageBag.getType());
  }
 catch (  Exception e) {
    if (_log.isWarnEnabled()) {
      _log.warn("Error scaling image " + image.getImageId(),e);
    }
  }
  return textObj;
}
