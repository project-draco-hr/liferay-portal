{
  if (!PropsValues.IMAGE_AUTO_SCALE) {
    return image.getTextObj();
  }
  try {
    ImageBag imageBag=null;
    if (image.getImageId() == 0) {
      imageBag=ImageProcessorUtil.read(image.getTextObj());
      RenderedImage renderedImage=imageBag.getRenderedImage();
      image.setHeight(renderedImage.getHeight());
      image.setWidth(renderedImage.getWidth());
    }
    int height=ParamUtil.getInteger(request,"height",image.getHeight());
    int width=ParamUtil.getInteger(request,"width",image.getWidth());
    if ((height >= image.getHeight()) && (width >= image.getWidth())) {
      return image.getTextObj();
    }
    if (image.getImageId() != 0) {
      imageBag=ImageProcessorUtil.read(image.getTextObj());
    }
    RenderedImage renderedImage=ImageProcessorUtil.scale(imageBag.getRenderedImage(),height,width);
    return ImageProcessorUtil.getBytes(renderedImage,imageBag.getType());
  }
 catch (  Exception e) {
    if (_log.isWarnEnabled()) {
      _log.warn("Error scaling image " + image.getImageId(),e);
    }
  }
  return image.getTextObj();
}
