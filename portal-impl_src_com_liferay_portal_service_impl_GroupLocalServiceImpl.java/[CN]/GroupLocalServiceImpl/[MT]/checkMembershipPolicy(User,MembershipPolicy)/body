{
  if (membershipPolicy == null) {
    throw new NullPointerException("Missing MembershipPolicy");
  }
  LinkedHashMap<String,Object> groupParams=new LinkedHashMap<String,Object>();
  groupParams.put("inherit",Boolean.FALSE);
  groupParams.put("site",Boolean.TRUE);
  groupParams.put("usersGroups",user.getUserId());
  List<Group> userGroups=search(user.getCompanyId(),groupParams,QueryUtil.ALL_POS,QueryUtil.ALL_POS);
  for (  Group userGroup : userGroups) {
    if (!membershipPolicy.isMembershipAllowed(userGroup,user)) {
      unsetUserGroups(user.getUserId(),new long[]{userGroup.getGroupId()});
    }
  }
  List<Group> groups=membershipPolicy.getMandatoryGroups(user);
  for (  Group group : groups) {
    if (!hasUserGroup(user.getUserId(),group.getGroupId(),false)) {
      addUserGroups(user.getUserId(),new long[]{group.getGroupId()});
    }
  }
}
