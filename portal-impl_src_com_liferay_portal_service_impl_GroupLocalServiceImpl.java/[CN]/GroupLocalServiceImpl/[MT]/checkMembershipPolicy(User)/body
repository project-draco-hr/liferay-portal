{
  MembershipPolicy membershipPolicy=MembershipPolicyFactory.getInstance();
  LinkedHashMap<String,Object> groupParams=new LinkedHashMap<String,Object>();
  groupParams.put("inherit",Boolean.FALSE);
  groupParams.put("site",Boolean.TRUE);
  groupParams.put("usersGroups",new Long(user.getUserId()));
  List<Group> userGroups=search(user.getCompanyId(),groupParams,QueryUtil.ALL_POS,QueryUtil.ALL_POS);
  for (  Group userGroup : userGroups) {
    if (!membershipPolicy.isMembershipAllowed(userGroup,user)) {
      unsetUserGroups(user.getUserId(),new long[]{userGroup.getGroupId()});
    }
  }
  List<Group> mandatorySites=membershipPolicy.getMandatorySites(user);
  for (  Group mandatorySite : mandatorySites) {
    if (!hasUserGroup(user.getUserId(),mandatorySite.getGroupId(),false)) {
      addUserGroups(user.getUserId(),new long[]{mandatorySite.getGroupId()});
    }
  }
}
