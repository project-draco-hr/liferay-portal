{
  User user=userPersistence.findByPrimaryKey(userId);
  className=GetterUtil.getString(className);
  long classNameId=classNameLocalService.getClassNameId(className);
  String groupKey=StringPool.BLANK;
  String friendlyName=StringPool.BLANK;
  if (nameMap != null) {
    groupKey=nameMap.get(LocaleUtil.getDefault());
    friendlyName=nameMap.get(LocaleUtil.getDefault());
  }
  long groupId=0;
  while (true) {
    groupId=counterLocalService.increment();
    User screenNameUser=userPersistence.fetchByC_SN(user.getCompanyId(),String.valueOf(groupId));
    if (screenNameUser == null) {
      break;
    }
  }
  boolean staging=isStaging(serviceContext);
  long groupClassNameId=classNameLocalService.getClassNameId(Group.class);
  if ((classNameId <= 0) || className.equals(Group.class.getName()) || (className.equals(Company.class.getName()) && staging)) {
    className=Group.class.getName();
    classNameId=groupClassNameId;
    classPK=groupId;
  }
 else   if (className.equals(Organization.class.getName())) {
    groupKey=getOrgGroupName(groupKey);
  }
 else   if (!GroupConstants.USER_PERSONAL_SITE.equals(groupKey)) {
    groupKey=String.valueOf(classPK);
  }
  if (className.equals(Organization.class.getName()) && staging) {
    classPK=liveGroupId;
  }
  if (className.equals(Layout.class.getName())) {
    Layout layout=layoutLocalService.getLayout(classPK);
    parentGroupId=layout.getGroupId();
  }
  friendlyURL=getFriendlyURL(user.getCompanyId(),groupId,classNameId,classPK,friendlyName,friendlyURL);
  if (staging) {
    groupKey=groupKey.concat("-staging");
    for (    Locale locale : nameMap.keySet()) {
      String name=nameMap.get(locale);
      if (Validator.isNull(name)) {
        continue;
      }
      nameMap.put(locale,name.concat(ORGANIZATION_STAGING_SUFFIX));
    }
    friendlyURL=getFriendlyURL(friendlyURL.concat("-staging"));
  }
  if (parentGroupId == GroupConstants.DEFAULT_PARENT_GROUP_ID) {
    membershipRestriction=GroupConstants.DEFAULT_MEMBERSHIP_RESTRICTION;
  }
  if (className.equals(Group.class.getName())) {
    if (!site && (liveGroupId == 0) && !(groupKey.equals(GroupConstants.CONTROL_PANEL) || groupKey.equals(GroupConstants.FORMS))) {
      throw new IllegalArgumentException();
    }
  }
 else   if (!className.equals(Company.class.getName()) && !className.equals(Organization.class.getName()) && className.startsWith("com.liferay.portal.kernel.model.")) {
    if (site) {
      throw new IllegalArgumentException();
    }
  }
  if ((classNameId <= 0) || className.equals(Group.class.getName())) {
    validateGroupKey(groupId,user.getCompanyId(),groupKey,site);
  }
  validateInheritContent(parentGroupId,inheritContent);
  validateFriendlyURL(user.getCompanyId(),groupId,classNameId,classPK,friendlyURL);
  validateParentGroup(groupId,parentGroupId);
  Group group=groupPersistence.create(groupId);
  if (serviceContext != null) {
    group.setUuid(serviceContext.getUuid());
  }
  group.setCompanyId(user.getCompanyId());
  group.setCreatorUserId(userId);
  group.setClassNameId(classNameId);
  group.setClassPK(classPK);
  group.setParentGroupId(parentGroupId);
  group.setLiveGroupId(liveGroupId);
  group.setTreePath(group.buildTreePath());
  group.setGroupKey(groupKey);
  group.setNameMap(nameMap);
  group.setDescriptionMap(descriptionMap);
  group.setType(type);
  group.setManualMembership(manualMembership);
  group.setMembershipRestriction(membershipRestriction);
  group.setFriendlyURL(friendlyURL);
  group.setInheritContent(inheritContent);
  group.setSite(site);
  group.setActive(active);
  if ((serviceContext != null) && (classNameId == groupClassNameId) && !user.isDefaultUser()) {
    group.setExpandoBridgeAttributes(serviceContext);
  }
  groupPersistence.update(group);
  layoutSetLocalService.addLayoutSet(groupId,true);
  layoutSetLocalService.addLayoutSet(groupId,false);
  resourceLocalService.addResources(group.getCompanyId(),0,0,Group.class.getName(),group.getGroupId(),false,false,false);
  if ((classNameId == groupClassNameId) && !user.isDefaultUser()) {
    Role role=roleLocalService.getRole(group.getCompanyId(),RoleConstants.SITE_OWNER);
    userGroupRoleLocalService.addUserGroupRoles(userId,groupId,new long[]{role.getRoleId()});
    userLocalService.addGroupUsers(group.getGroupId(),new long[]{userId});
    if (serviceContext != null) {
      updateAsset(userId,group,serviceContext.getAssetCategoryIds(),serviceContext.getAssetTagNames());
    }
  }
  addPortletDefaultData(group);
  return group;
}
