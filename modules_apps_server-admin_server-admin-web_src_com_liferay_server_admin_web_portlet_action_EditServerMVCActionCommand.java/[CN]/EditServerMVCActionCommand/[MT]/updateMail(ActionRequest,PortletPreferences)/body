{
  String advancedProperties=ParamUtil.getString(actionRequest,"advancedProperties");
  String pop3Host=ParamUtil.getString(actionRequest,"pop3Host");
  String pop3Password=ParamUtil.getString(actionRequest,"pop3Password");
  int pop3Port=ParamUtil.getInteger(actionRequest,"pop3Port");
  boolean pop3Secure=ParamUtil.getBoolean(actionRequest,"pop3Secure");
  String pop3User=ParamUtil.getString(actionRequest,"pop3User");
  String smtpHost=ParamUtil.getString(actionRequest,"smtpHost");
  String smtpPassword=ParamUtil.getString(actionRequest,"smtpPassword");
  int smtpPort=ParamUtil.getInteger(actionRequest,"smtpPort");
  boolean smtpSecure=ParamUtil.getBoolean(actionRequest,"smtpSecure");
  String smtpUser=ParamUtil.getString(actionRequest,"smtpUser");
  String storeProtocol=Account.PROTOCOL_POP;
  if (pop3Secure) {
    storeProtocol=Account.PROTOCOL_POPS;
  }
  String transportProtocol=Account.PROTOCOL_SMTP;
  if (smtpSecure) {
    transportProtocol=Account.PROTOCOL_SMTPS;
  }
  portletPreferences.setValue(PropsKeys.MAIL_SESSION_MAIL,"true");
  portletPreferences.setValue(PropsKeys.MAIL_SESSION_MAIL_ADVANCED_PROPERTIES,advancedProperties);
  portletPreferences.setValue(PropsKeys.MAIL_SESSION_MAIL_POP3_HOST,pop3Host);
  if (!pop3Password.equals(Portal.TEMP_OBFUSCATION_VALUE)) {
    portletPreferences.setValue(PropsKeys.MAIL_SESSION_MAIL_POP3_PASSWORD,pop3Password);
  }
  portletPreferences.setValue(PropsKeys.MAIL_SESSION_MAIL_POP3_PORT,String.valueOf(pop3Port));
  portletPreferences.setValue(PropsKeys.MAIL_SESSION_MAIL_POP3_USER,pop3User);
  portletPreferences.setValue(PropsKeys.MAIL_SESSION_MAIL_SMTP_HOST,smtpHost);
  if (!smtpPassword.equals(Portal.TEMP_OBFUSCATION_VALUE)) {
    portletPreferences.setValue(PropsKeys.MAIL_SESSION_MAIL_SMTP_PASSWORD,smtpPassword);
  }
  portletPreferences.setValue(PropsKeys.MAIL_SESSION_MAIL_SMTP_PORT,String.valueOf(smtpPort));
  portletPreferences.setValue(PropsKeys.MAIL_SESSION_MAIL_SMTP_USER,smtpUser);
  portletPreferences.setValue(PropsKeys.MAIL_SESSION_MAIL_STORE_PROTOCOL,storeProtocol);
  portletPreferences.setValue(PropsKeys.MAIL_SESSION_MAIL_TRANSPORT_PROTOCOL,transportProtocol);
  portletPreferences.store();
  MailServiceUtil.clearSession();
}
