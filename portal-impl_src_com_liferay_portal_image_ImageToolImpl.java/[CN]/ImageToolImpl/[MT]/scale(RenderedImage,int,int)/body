{
  int imageHeight=renderedImage.getHeight();
  int imageWidth=renderedImage.getWidth();
  if (maxHeight == 0) {
    maxHeight=imageHeight;
  }
  if (maxWidth == 0) {
    maxWidth=imageWidth;
  }
  if ((imageHeight <= maxHeight) && (imageWidth <= maxWidth)) {
    return renderedImage;
  }
  double factor=Math.min((double)maxHeight / imageHeight,(double)maxWidth / imageWidth);
  int scaledHeight=Math.max(1,(int)(factor * imageHeight));
  int scaledWidth=Math.max(1,(int)(factor * imageWidth));
  BufferedImage originalBufferedImage=getBufferedImage(renderedImage);
  int type=originalBufferedImage.getType();
  if (type == 0) {
    type=BufferedImage.TYPE_INT_ARGB;
  }
  BufferedImage scaledBufferedImage=null;
  if ((type == BufferedImage.TYPE_BYTE_BINARY) || (type == BufferedImage.TYPE_BYTE_INDEXED)) {
    IndexColorModel originalIndexColorModel=(IndexColorModel)originalBufferedImage.getColorModel();
    BufferedImage tempBufferedImage=new BufferedImage(1,1,type,originalIndexColorModel);
    int bits=originalIndexColorModel.getPixelSize();
    int size=originalIndexColorModel.getMapSize();
    byte[] reds=new byte[size];
    originalIndexColorModel.getReds(reds);
    byte[] greens=new byte[size];
    originalIndexColorModel.getGreens(greens);
    byte[] blues=new byte[size];
    originalIndexColorModel.getBlues(blues);
    WritableRaster tempWritableRaster=tempBufferedImage.getRaster();
    int pixel=tempWritableRaster.getSample(0,0,0);
    IndexColorModel scaledIndexColorModel=new IndexColorModel(bits,size,reds,greens,blues,pixel);
    scaledBufferedImage=new BufferedImage(scaledWidth,scaledHeight,type,scaledIndexColorModel);
  }
 else {
    scaledBufferedImage=new BufferedImage(scaledWidth,scaledHeight,type);
  }
  Graphics scaledGraphics=scaledBufferedImage.getGraphics();
  java.awt.Image scaledImage=originalBufferedImage.getScaledInstance(scaledWidth,scaledHeight,java.awt.Image.SCALE_SMOOTH);
  scaledGraphics.drawImage(scaledImage,0,0,null);
  return scaledBufferedImage;
}
