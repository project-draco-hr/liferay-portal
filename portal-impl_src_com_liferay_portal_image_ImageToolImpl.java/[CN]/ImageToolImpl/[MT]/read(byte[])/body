{
  String formatName=null;
  ImageInputStream imageInputStream=null;
  Queue<ImageReader> imageReaders=new LinkedList<>();
  RenderedImage renderedImage=null;
  try {
    imageInputStream=ImageIO.createImageInputStream(new ByteArrayInputStream(bytes));
    Iterator<ImageReader> iterator=ImageIO.getImageReaders(imageInputStream);
    while ((renderedImage == null) && iterator.hasNext()) {
      ImageReader imageReader=iterator.next();
      imageReaders.offer(imageReader);
      try {
        imageReader.setInput(imageInputStream);
        int height=imageReader.getHeight(0);
        int width=imageReader.getWidth(0);
        if ((height > PropsValues.IMAGE_TOOL_IMAGE_MAX_HEIGHT) || (width > PropsValues.IMAGE_TOOL_IMAGE_MAX_WIDTH)) {
          StringBundler sb=new StringBundler(9);
          sb.append("Image is ");
          sb.append(height);
          sb.append("px height and ");
          sb.append(width);
          sb.append("px width, larger than max height ");
          sb.append(PropsValues.IMAGE_TOOL_IMAGE_MAX_HEIGHT);
          sb.append("px and max width ");
          sb.append(PropsValues.IMAGE_TOOL_IMAGE_MAX_WIDTH);
          sb.append("px");
          throw new ImageResolutionException(sb.toString());
        }
        renderedImage=imageReader.read(0);
      }
 catch (      IOException ioe) {
        continue;
      }
      formatName=StringUtil.toLowerCase(imageReader.getFormatName());
    }
    if (renderedImage == null) {
      throw new IOException("Unsupported image type");
    }
  }
  finally {
    while (!imageReaders.isEmpty()) {
      ImageReader imageReader=imageReaders.poll();
      imageReader.dispose();
    }
    if (imageInputStream != null) {
      imageInputStream.close();
    }
  }
  String type=TYPE_JPEG;
  if (formatName.contains(TYPE_BMP)) {
    type=TYPE_BMP;
  }
 else   if (formatName.contains(TYPE_GIF)) {
    type=TYPE_GIF;
  }
 else   if (formatName.contains("jpeg") || StringUtil.equalsIgnoreCase(type,"jpeg")) {
    type=TYPE_JPEG;
  }
 else   if (formatName.contains(TYPE_PNG)) {
    type=TYPE_PNG;
  }
 else   if (formatName.contains(TYPE_TIFF)) {
    type=TYPE_TIFF;
  }
 else {
    throw new IllegalArgumentException(type + " is not supported");
  }
  return new ImageBag(renderedImage,type);
}
