{
  String formatName=null;
  ImageInputStream imageInputStream=null;
  Queue<ImageReader> imageReaders=new LinkedList<ImageReader>();
  RenderedImage renderedImage=null;
  try {
    imageInputStream=ImageIO.createImageInputStream(new ByteArrayInputStream(bytes));
    Iterator<ImageReader> iterator=ImageIO.getImageReaders(imageInputStream);
    boolean firstImageReader=true;
    while (iterator.hasNext()) {
      ImageReader imageReader=iterator.next();
      imageReaders.offer(imageReader);
      if (firstImageReader) {
        imageReader.setInput(imageInputStream);
        renderedImage=imageReader.read(0);
        formatName=imageReader.getFormatName();
        firstImageReader=false;
      }
    }
  }
  finally {
    while (!imageReaders.isEmpty()) {
      ImageReader imageReader=imageReaders.poll();
      imageReader.dispose();
    }
    if (imageInputStream != null) {
      imageInputStream.close();
    }
  }
  formatName=StringUtil.toLowerCase(formatName);
  String type=TYPE_JPEG;
  if (formatName.contains(TYPE_BMP)) {
    type=TYPE_BMP;
  }
 else   if (formatName.contains(TYPE_GIF)) {
    type=TYPE_GIF;
  }
 else   if (formatName.contains("jpeg") || type.equals("jpeg")) {
    type=TYPE_JPEG;
  }
 else   if (formatName.contains(TYPE_PNG)) {
    type=TYPE_PNG;
  }
 else   if (formatName.contains(TYPE_TIFF)) {
    type=TYPE_TIFF;
  }
 else {
    throw new IllegalArgumentException(type + " is not supported");
  }
  return new ImageBag(renderedImage,type);
}
