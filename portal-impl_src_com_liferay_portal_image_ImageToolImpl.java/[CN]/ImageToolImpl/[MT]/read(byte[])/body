{
  BufferedImage bufferedImage=null;
  String formatName=null;
  InputStream inputStream=new ByteArrayInputStream(bytes);
  ImageInputStream imageInputStream=null;
  try {
    imageInputStream=ImageIO.createImageInputStream(inputStream);
    Iterator<ImageReader> iterator=ImageIO.getImageReaders(imageInputStream);
    if (iterator.hasNext()) {
      ImageReader imageReader=iterator.next();
      imageReader.setInput(imageInputStream);
      bufferedImage=imageReader.read(0);
      formatName=imageReader.getFormatName();
    }
  }
  finally {
    if (imageInputStream != null) {
      imageInputStream.close();
    }
  }
  formatName=StringUtil.toLowerCase(formatName);
  String type=TYPE_JPEG;
  if (formatName.contains(TYPE_BMP)) {
    type=TYPE_BMP;
  }
 else   if (formatName.contains(TYPE_GIF)) {
    type=TYPE_GIF;
  }
 else   if (formatName.contains("jpeg") || type.equals("jpeg")) {
    type=TYPE_JPEG;
  }
 else   if (formatName.contains(TYPE_PNG)) {
    type=TYPE_PNG;
  }
 else   if (formatName.contains(TYPE_TIFF)) {
    type=TYPE_TIFF;
  }
 else {
    throw new IllegalArgumentException(type + " is not supported");
  }
  return new ImageBag(bufferedImage,type);
}
