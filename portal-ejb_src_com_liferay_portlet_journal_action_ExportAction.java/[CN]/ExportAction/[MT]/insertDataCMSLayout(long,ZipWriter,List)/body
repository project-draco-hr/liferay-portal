{
  StringMaker sm=new StringMaker();
  List layouts=LayoutLocalServiceUtil.getLayouts(LayoutImpl.PUBLIC + siteGroupId);
  Collections.sort(layouts,new LayoutComparator(true));
  Iterator itr=layouts.iterator();
  while (itr.hasNext()) {
    Layout layout=(Layout)itr.next();
    sm.append("insert into Layout (");
    sm.append("layoutId, ownerId, companyId, parentLayoutId, name, ");
    sm.append("title, type_, typeSettings, hidden_, friendlyURL, ");
    sm.append("themeId, colorSchemeId, priority");
    sm.append(") values (");
    addColumn(sm,layout.getLayoutId());
    addColumn(sm,layout.getOwnerId());
    addColumn(sm,layout.getCompanyId());
    addColumn(sm,layout.getParentLayoutId());
    addColumn(sm,layout.getName());
    addColumn(sm,layout.getTitle());
    addColumn(sm,layout.getType());
    addColumn(sm,layout.getTypeSettings());
    addColumn(sm,layout.getHidden());
    addColumn(sm,layout.getFriendlyURL());
    addColumn(sm,layout.getThemeId());
    addColumn(sm,layout.getColorSchemeId());
    addColumn(sm,layout.getPriority());
    removeTrailingComma(sm);
    sm.append(");\n");
  }
  sm.append("\n");
  itr=layouts.iterator();
  while (itr.hasNext()) {
    Layout layout=(Layout)itr.next();
    LayoutTypePortlet layoutType=(LayoutTypePortlet)layout.getLayoutType();
    List portletIds=layoutType.getPortletIds();
    Collections.sort(portletIds);
    for (int i=0; i < portletIds.size(); i++) {
      String portletId=(String)portletIds.get(i);
      PortletPreferencesPK pk=new PortletPreferencesPK(portletId,layout.getLayoutId(),layout.getOwnerId());
      try {
        PortletPreferences portletPreferences=PortletPreferencesLocalServiceUtil.getPortletPreferences(pk);
        String prefsXml=portletPreferences.getPreferences();
        PortletPreferencesImpl prefs=(PortletPreferencesImpl)PortletPreferencesSerializer.fromDefaultXML(portletPreferences.getPreferences());
        String articleId=prefs.getValue("article-id",StringPool.BLANK);
        articleId=articleId.toUpperCase();
        if (Validator.isNotNull(articleId)) {
          prefs.setValue("article-id",articleId);
          prefsXml=PortletPreferencesSerializer.toXML(prefs);
          JournalContentSearch journalContentSearch=new JournalContentSearchImpl();
          journalContentSearch.setPortletId(portletId);
          journalContentSearch.setLayoutId(layout.getLayoutId());
          journalContentSearch.setOwnerId(layout.getOwnerId());
          journalContentSearch.setArticleId(articleId);
          journalContentSearch.setCompanyId(layout.getCompanyId());
          journalContentSearch.setGroupId(layout.getGroupId());
          journalContentSearches.add(journalContentSearch);
        }
        sm.append("insert into PortletPreferences (");
        sm.append("portletId, layoutId, ownerId, preferences");
        sm.append(") values (");
        addColumn(sm,portletId);
        addColumn(sm,portletPreferences.getLayoutId());
        addColumn(sm,portletPreferences.getOwnerId());
        addColumn(sm,prefsXml);
        removeTrailingComma(sm);
        sm.append(");\n");
      }
 catch (      NoSuchPortletPreferencesException nsppe) {
        _log.warn(nsppe.getMessage());
      }
    }
    sm.append("\n");
  }
  removeTrailingNewLine(sm);
  removeTrailingNewLine(sm);
  zipWriter.addEntry("portal-data-cms-layout.sql",sm);
}
