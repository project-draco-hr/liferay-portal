{
  Properties properties=PropsUtil.getProperties(_propertyPrefix,true);
  String jndiName=properties.getProperty("jndi.name");
  if (Validator.isNotNull(jndiName)) {
    try {
      Properties jndiEnvironmentProperties=PropsUtil.getProperties(PropsKeys.JNDI_ENVIRONMENT,true);
      Context initialContext=new InitialContext(jndiEnvironmentProperties);
      return (Session)JNDIUtil.lookup(initialContext,jndiName);
    }
 catch (    Exception e) {
      _log.error("Unable to lookup " + jndiName,e);
    }
  }
  Session session=Session.getInstance(properties);
  if (_log.isDebugEnabled()) {
    session.setDebug(true);
    SortedProperties sortedProperties=new SortedProperties(session.getProperties());
    _log.debug("Properties for prefix " + _propertyPrefix);
    sortedProperties.list(System.out);
  }
  return session;
}
