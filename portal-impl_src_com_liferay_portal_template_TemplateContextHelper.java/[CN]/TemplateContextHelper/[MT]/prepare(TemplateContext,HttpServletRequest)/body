{
  templateContext.put("request",request);
  PortletConfigImpl portletConfigImpl=(PortletConfigImpl)request.getAttribute(JavaConstants.JAVAX_PORTLET_CONFIG);
  if (portletConfigImpl != null) {
    templateContext.put("portletConfig",portletConfigImpl);
  }
  final PortletRequest portletRequest=(PortletRequest)request.getAttribute(JavaConstants.JAVAX_PORTLET_REQUEST);
  if (portletRequest != null) {
    if (portletRequest instanceof RenderRequest) {
      templateContext.put("renderRequest",portletRequest);
    }
  }
  final PortletResponse portletResponse=(PortletResponse)request.getAttribute(JavaConstants.JAVAX_PORTLET_RESPONSE);
  if (portletResponse != null) {
    if (portletResponse instanceof RenderResponse) {
      templateContext.put("renderResponse",portletResponse);
    }
  }
  if ((portletRequest != null) && (portletResponse != null)) {
    templateContext.put("xmlRequest",new Object(){
      @Override public String toString(){
        return PortletRequestUtil.toXML(portletRequest,portletResponse);
      }
    }
);
  }
  ThemeDisplay themeDisplay=(ThemeDisplay)request.getAttribute(WebKeys.THEME_DISPLAY);
  if (themeDisplay != null) {
    Layout layout=themeDisplay.getLayout();
    List<Layout> layouts=themeDisplay.getLayouts();
    templateContext.put("themeDisplay",themeDisplay);
    templateContext.put("company",themeDisplay.getCompany());
    templateContext.put("user",themeDisplay.getUser());
    templateContext.put("realUser",themeDisplay.getRealUser());
    templateContext.put("layout",layout);
    templateContext.put("layouts",layouts);
    templateContext.put("plid",String.valueOf(themeDisplay.getPlid()));
    templateContext.put("layoutTypePortlet",themeDisplay.getLayoutTypePortlet());
    templateContext.put("scopeGroupId",new Long(themeDisplay.getScopeGroupId()));
    templateContext.put("permissionChecker",themeDisplay.getPermissionChecker());
    templateContext.put("locale",themeDisplay.getLocale());
    templateContext.put("timeZone",themeDisplay.getTimeZone());
    templateContext.put("colorScheme",themeDisplay.getColorScheme());
    templateContext.put("portletDisplay",themeDisplay.getPortletDisplay());
    if (layout != null) {
      RequestVars requestVars=null;
      try {
        requestVars=new RequestVars(request,themeDisplay,layout.getAncestorPlid(),layout.getAncestorLayoutId());
      }
 catch (      Exception e) {
        throw new TemplateException(e);
      }
      List<NavItem> navItems=NavItem.fromLayouts(requestVars,layouts);
      templateContext.put("navItems",navItems);
    }
    templateContext.put("portletGroupId",new Long(themeDisplay.getScopeGroupId()));
  }
  Theme theme=(Theme)request.getAttribute(WebKeys.THEME);
  if ((theme == null) && (themeDisplay != null)) {
    theme=themeDisplay.getTheme();
  }
  if (theme != null) {
    templateContext.put("theme",theme);
  }
  prepareTiles(templateContext,request);
  templateContext.put("pageTitle",request.getAttribute(WebKeys.PAGE_TITLE));
  templateContext.put("pageSubtitle",request.getAttribute(WebKeys.PAGE_SUBTITLE));
}
