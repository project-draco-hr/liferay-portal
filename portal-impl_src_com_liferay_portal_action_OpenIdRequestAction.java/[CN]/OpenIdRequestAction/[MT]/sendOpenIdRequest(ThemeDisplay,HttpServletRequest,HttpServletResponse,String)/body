{
  if (!OpenIdUtil.isEnabled(themeDisplay.getCompanyId())) {
    return;
  }
  HttpSession ses=request.getSession();
  String returnURL=PortalUtil.getPortalURL(request) + themeDisplay.getPathMain() + "/portal/open_id_response";
  ConsumerManager manager=OpenIdUtil.getConsumerManager();
  List<DiscoveryInformation> discoveries=manager.discover(openId);
  DiscoveryInformation discovered=manager.associate(discoveries);
  ses.setAttribute(WebKeys.OPEN_ID_DISCO,discovered);
  AuthRequest authReq=manager.authenticate(discovered,returnURL);
  try {
    UserLocalServiceUtil.getUserByOpenId(openId);
  }
 catch (  NoSuchUserException nsue1) {
    String screenName=OpenIdUtil.getScreenName(openId);
    try {
      User user=UserLocalServiceUtil.getUserByScreenName(themeDisplay.getCompanyId(),screenName);
      UserLocalServiceUtil.updateOpenId(user.getUserId(),openId);
    }
 catch (    NoSuchUserException nsue2) {
      FetchRequest fetch=FetchRequest.createFetchRequest();
      fetch.addAttribute("email","http://schema.openid.net/contact/email",true);
      fetch.addAttribute("firstName","http://schema.openid.net/namePerson/first",true);
      fetch.addAttribute("lastName","http://schema.openid.net/namePerson/last",true);
      authReq.addExtension(fetch);
      SRegRequest sregReq=SRegRequest.createFetchRequest();
      sregReq.addAttribute("fullname",true);
      sregReq.addAttribute("email",true);
      authReq.addExtension(sregReq);
    }
  }
  response.sendRedirect(authReq.getDestinationUrl(true));
}
