{
  try {
    long companyId=PortalUtil.getCompanyId(request);
    User user=PortalUtil.getUser(request);
    if (user == null) {
      Company company=CompanyLocalServiceUtil.getCompany(companyId);
      user=company.getDefaultUser();
    }
    long userId=user.getUserId();
    PrincipalThreadLocal.setName(userId);
    PermissionChecker permissionChecker=PermissionCheckerFactoryUtil.create(user,true);
    PermissionThreadLocal.setPermissionChecker(permissionChecker);
    String path=HttpUtil.fixPath(request.getPathInfo());
    String fullPath=request.getServletPath() + StringPool.SLASH + path;
    String[] pathArray=StringUtil.split(path,StringPool.SLASH);
    if (pathArray.length == 0) {
      sendGroupListing(response,companyId,userId,fullPath);
    }
 else {
      sendDocumentLibraryListing(request,response,companyId,userId,fullPath,pathArray);
    }
  }
 catch (  Exception e) {
    PortalUtil.sendError(e,request,response);
  }
}
