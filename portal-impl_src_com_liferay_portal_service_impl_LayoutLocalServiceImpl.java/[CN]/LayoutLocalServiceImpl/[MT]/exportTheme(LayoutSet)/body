{
  ThemeLoader themeLoader=ThemeLoaderFactory.getDefaultThemeLoader();
  String fileStorage="";
  if (themeLoader != null) {
    fileStorage=themeLoader.getFileStorage().toString();
  }
  Theme theme=layoutSet.getTheme();
  ZipWriter zipWriter=new ZipWriter();
  String lookAndFeelXML=ContentUtil.get("com/liferay/portal/dependencies/liferay-look-and-feel.xml.tmpl");
  lookAndFeelXML=StringUtil.replace(lookAndFeelXML,new String[]{"[$TEMPLATE_EXTENSION$]","[$VIRTUAL_PATH$]"},new String[]{theme.getTemplateExtension(),theme.getVirtualPath()});
  zipWriter.addEntry("liferay-look-and-feel.xml",lookAndFeelXML);
  String servletContextName=theme.getServletContextName();
  ServletContext ctx=VelocityContextPool.get(servletContextName);
  if (ctx == null) {
    if (_log.isWarnEnabled()) {
      _log.warn("Servlet context not found for theme " + theme.getThemeId());
    }
    return null;
  }
  File cssPath;
  File imagesPath;
  File javaScriptPath;
  File templatesPath;
  if (theme.isFileStorageEnabled() && Validator.isNotNull(fileStorage)) {
    String themeName=theme.getName();
    cssPath=new File(fileStorage + "/" + themeName+ "/css");
    imagesPath=new File(fileStorage + "/" + themeName+ "/images");
    javaScriptPath=new File(fileStorage + "/" + themeName+ "/javascript");
    templatesPath=new File(fileStorage + "/" + themeName+ "/templates");
  }
 else {
    cssPath=new File(ctx.getRealPath(theme.getCssPath()));
    imagesPath=new File(ctx.getRealPath(theme.getImagesPath()));
    javaScriptPath=new File(ctx.getRealPath(theme.getJavaScriptPath()));
    templatesPath=new File(ctx.getRealPath(theme.getTemplatesPath()));
  }
  exportThemeFiles("css",cssPath,zipWriter);
  exportThemeFiles("images",imagesPath,zipWriter);
  exportThemeFiles("javascript",javaScriptPath,zipWriter);
  exportThemeFiles("templates",templatesPath,zipWriter);
  return zipWriter.finish();
}
