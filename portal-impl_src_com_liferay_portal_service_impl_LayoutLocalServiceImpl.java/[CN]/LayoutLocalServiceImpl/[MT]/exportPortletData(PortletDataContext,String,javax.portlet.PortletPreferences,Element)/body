{
  Portlet portlet=portletLocalService.getPortletById(context.getCompanyId(),portletId);
  if (portlet == null) {
    if (_log.isDebugEnabled()) {
      _log.debug("Do not export portlet data for " + portletId + " because the portlet does not exist");
    }
    return;
  }
  PortletDataHandler portletDataHandler=portlet.getPortletDataHandlerInstance();
  if (portletDataHandler == null) {
    return;
  }
  if (_log.isDebugEnabled()) {
    _log.debug("Exporting data for " + portletId);
  }
  Map parameterMap=context.getParameterMap();
  boolean exportData=MapUtil.getBoolean(parameterMap,PortletDataHandlerKeys.PORTLET_DATA + "." + portletId) || MapUtil.getBoolean(parameterMap,PortletDataHandlerKeys.PORTLET_DATA_ALL);
  if (!exportData) {
    if (_log.isDebugEnabled()) {
      _log.debug("Not exporting data for " + portletId + " because it wasn't selected by the user");
    }
    return;
  }
  String data=portletDataHandler.exportData(context,portletId,portletPreferences);
  if (data == null) {
    if (_log.isDebugEnabled()) {
      _log.debug("Not exporting data for " + portletId + " because null data was returned");
    }
    return;
  }
  Element el=parentEl.addElement("portlet-data");
  el.addAttribute("portlet-id",portletId);
  el.addCDATA(data);
}
