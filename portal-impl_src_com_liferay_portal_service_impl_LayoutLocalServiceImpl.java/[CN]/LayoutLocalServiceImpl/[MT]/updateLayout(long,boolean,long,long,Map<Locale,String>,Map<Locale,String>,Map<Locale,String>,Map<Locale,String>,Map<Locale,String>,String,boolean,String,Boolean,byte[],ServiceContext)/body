{
  parentLayoutId=getParentLayoutId(groupId,privateLayout,parentLayoutId);
  String name=nameMap.get(LocaleUtil.getDefault());
  friendlyURL=getFriendlyURL(groupId,privateLayout,layoutId,StringPool.BLANK,friendlyURL);
  validate(groupId,privateLayout,layoutId,parentLayoutId,name,type,hidden,friendlyURL);
  validateParentLayoutId(groupId,privateLayout,layoutId,parentLayoutId);
  Date now=new Date();
  Layout layout=layoutPersistence.findByG_P_L(groupId,privateLayout,layoutId);
  LayoutSet layoutSet=layoutSetLocalService.getLayoutSet(groupId,privateLayout);
  List<Locale> modifiedLocales=LocalizationUtil.getModifiedLocales(layout.getNameMap(),nameMap);
  if (parentLayoutId != layout.getParentLayoutId()) {
    int priority=getNextPriority(layoutSet,parentLayoutId,layout.getSourcePrototypeLayoutUuid(),-1);
    layout.setPriority(priority);
  }
  layout.setModifiedDate(serviceContext.getModifiedDate(now));
  layout.setParentLayoutId(parentLayoutId);
  layout.setNameMap(nameMap);
  layout.setTitleMap(titleMap);
  layout.setDescriptionMap(descriptionMap);
  layout.setKeywordsMap(keywordsMap);
  layout.setRobotsMap(robotsMap);
  layout.setType(type);
  layout.setHidden(hidden);
  layout.setFriendlyURL(friendlyURL);
  if (iconImage != null) {
    layout.setIconImage(iconImage.booleanValue());
    if (iconImage.booleanValue()) {
      long iconImageId=layout.getIconImageId();
      if (iconImageId <= 0) {
        iconImageId=counterLocalService.increment();
        layout.setIconImageId(iconImageId);
      }
    }
  }
  boolean layoutUpdateable=GetterUtil.getBoolean(serviceContext.getAttribute("layoutUpdateable"),true);
  UnicodeProperties typeSettingsProperties=layout.getTypeSettingsProperties();
  typeSettingsProperties.put("layoutUpdateable",String.valueOf(layoutUpdateable));
  layout.setTypeSettingsProperties(typeSettingsProperties);
  String layoutPrototypeUuid=ParamUtil.getString(serviceContext,"layoutPrototypeUuid");
  boolean layoutPrototypeLinkEnabled=ParamUtil.getBoolean(serviceContext,"layoutPrototypeLinkEnabled");
  if (Validator.isNotNull(layoutPrototypeUuid)) {
    layout.setLayoutPrototypeUuid(layoutPrototypeUuid);
    layout.setLayoutPrototypeLinkEnabled(layoutPrototypeLinkEnabled);
  }
  layoutPersistence.update(layout,false);
  if (iconImage != null) {
    if (!iconImage.booleanValue()) {
      imageLocalService.deleteImage(layout.getIconImageId());
    }
 else     if ((iconBytes != null) && (iconBytes.length > 0)) {
      imageLocalService.updateImage(layout.getIconImageId(),iconBytes);
    }
  }
  if (!modifiedLocales.isEmpty()) {
    updateScopedPortletNames(groupId,privateLayout,layoutId,nameMap,modifiedLocales);
  }
  ExpandoBridge expandoBridge=layout.getExpandoBridge();
  expandoBridge.setAttributes(serviceContext);
  return layout;
}
