{
  parentLayoutId=getParentLayoutId(groupId,privateLayout,parentLayoutId);
  String name=localeNamesMap.get(LocaleUtil.getDefault());
  friendlyURL=getFriendlyURL(groupId,privateLayout,layoutId,StringPool.BLANK,friendlyURL);
  validate(groupId,privateLayout,layoutId,parentLayoutId,name,type,hidden,friendlyURL);
  validateParentLayoutId(groupId,privateLayout,layoutId,parentLayoutId);
  Layout layout=layoutPersistence.findByG_P_L(groupId,privateLayout,layoutId);
  if (parentLayoutId != layout.getParentLayoutId()) {
    layout.setPriority(getNextPriority(groupId,privateLayout,parentLayoutId));
  }
  layout.setParentLayoutId(parentLayoutId);
  layout.setDescription(description);
  layout.setType(type);
  layout.setHidden(hidden);
  layout.setFriendlyURL(friendlyURL);
  setLocalizedAttributes(layout,localeNamesMap,localeTitlesMap);
  if (iconImage != null) {
    layout.setIconImage(iconImage.booleanValue());
    if (iconImage.booleanValue()) {
      long iconImageId=layout.getIconImageId();
      if (iconImageId <= 0) {
        iconImageId=counterLocalService.increment();
        layout.setIconImageId(iconImageId);
      }
    }
  }
  layoutPersistence.update(layout,false);
  if (iconImage != null) {
    if (!iconImage.booleanValue()) {
      imageLocalService.deleteImage(layout.getIconImageId());
    }
 else     if ((iconBytes != null) && (iconBytes.length > 0)) {
      imageLocalService.updateImage(layout.getIconImageId(),iconBytes);
    }
  }
  try {
    if (layout.getDlFolderId() > 0) {
      DLFolder folder=dlFolderLocalService.getFolder(layout.getDlFolderId());
      if (!name.equals(folder.getName())) {
        dlFolderLocalService.updateFolder(folder.getFolderId(),folder.getParentFolderId(),name,folder.getDescription());
      }
    }
  }
 catch (  DuplicateFolderNameException dfne) {
    if (_log.isDebugEnabled()) {
      _log.debug(dfne);
    }
  }
catch (  NoSuchFolderException nsfe) {
  }
  return layout;
}
