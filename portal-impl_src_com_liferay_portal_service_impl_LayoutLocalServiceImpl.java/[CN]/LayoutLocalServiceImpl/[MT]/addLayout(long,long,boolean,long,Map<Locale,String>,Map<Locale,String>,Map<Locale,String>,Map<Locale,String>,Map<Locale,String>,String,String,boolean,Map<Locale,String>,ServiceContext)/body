{
  User user=userPersistence.findByPrimaryKey(userId);
  long layoutId=getNextLayoutId(groupId,privateLayout);
  parentLayoutId=layoutLocalServiceHelper.getParentLayoutId(groupId,privateLayout,parentLayoutId);
  String name=nameMap.get(LocaleUtil.getSiteDefault());
  friendlyURLMap=layoutLocalServiceHelper.getFriendlyURLMap(groupId,privateLayout,layoutId,name,friendlyURLMap);
  String friendlyURL=friendlyURLMap.get(LocaleUtil.getSiteDefault());
  int priority=layoutLocalServiceHelper.getNextPriority(groupId,privateLayout,parentLayoutId,null,-1);
  layoutLocalServiceHelper.validate(groupId,privateLayout,layoutId,parentLayoutId,name,type,hidden,friendlyURLMap,serviceContext);
  Date now=new Date();
  long plid=counterLocalService.increment();
  Layout layout=layoutPersistence.create(plid);
  layout.setUuid(serviceContext.getUuid());
  layout.setGroupId(groupId);
  layout.setCompanyId(user.getCompanyId());
  layout.setUserId(user.getUserId());
  layout.setUserName(user.getFullName());
  layout.setCreateDate(serviceContext.getCreateDate(now));
  layout.setModifiedDate(serviceContext.getModifiedDate(now));
  layout.setPrivateLayout(privateLayout);
  layout.setLayoutId(layoutId);
  layout.setParentLayoutId(parentLayoutId);
  layout.setNameMap(nameMap);
  layout.setTitleMap(titleMap);
  layout.setDescriptionMap(descriptionMap);
  layout.setKeywordsMap(keywordsMap);
  layout.setRobotsMap(robotsMap);
  layout.setType(type);
  layout.setHidden(hidden);
  layout.setFriendlyURL(friendlyURL);
  layout.setPriority(priority);
  boolean layoutUpdateable=ParamUtil.getBoolean(serviceContext,Sites.LAYOUT_UPDATEABLE,true);
  UnicodeProperties typeSettingsProperties=new UnicodeProperties();
  typeSettingsProperties.fastLoad(typeSettings);
  if (!layoutUpdateable) {
    typeSettingsProperties.put(Sites.LAYOUT_UPDATEABLE,String.valueOf(layoutUpdateable));
  }
  if (privateLayout) {
    typeSettingsProperties.put("privateLayout",String.valueOf(privateLayout));
  }
  validateTypeSettingsProperties(typeSettingsProperties);
  layout.setTypeSettingsProperties(typeSettingsProperties);
  String layoutPrototypeUuid=ParamUtil.getString(serviceContext,"layoutPrototypeUuid");
  boolean layoutPrototypeLinkEnabled=ParamUtil.getBoolean(serviceContext,"layoutPrototypeLinkEnabled",PropsValues.LAYOUT_PROTOTYPE_LINK_ENABLED_DEFAULT);
  if (Validator.isNotNull(layoutPrototypeUuid)) {
    layout.setLayoutPrototypeUuid(layoutPrototypeUuid);
    layout.setLayoutPrototypeLinkEnabled(layoutPrototypeLinkEnabled);
  }
  if (type.equals(LayoutConstants.TYPE_PORTLET)) {
    LayoutTypePortlet layoutTypePortlet=(LayoutTypePortlet)layout.getLayoutType();
    if (Validator.isNull(layoutTypePortlet.getLayoutTemplateId())) {
      layoutTypePortlet.setLayoutTemplateId(0,PropsValues.LAYOUT_DEFAULT_TEMPLATE_ID,false);
    }
  }
  layout.setExpandoBridgeAttributes(serviceContext);
  layoutPersistence.update(layout);
  layoutFriendlyURLLocalService.updateLayoutFriendlyURLs(user.getUserId(),user.getCompanyId(),groupId,plid,privateLayout,friendlyURLMap,serviceContext);
  if (Validator.isNotNull(layoutPrototypeUuid) && !layoutPrototypeLinkEnabled) {
    LayoutPrototype layoutPrototype=layoutPrototypeLocalService.getLayoutPrototypeByUuidAndCompanyId(layoutPrototypeUuid,layout.getCompanyId());
    try {
      SitesUtil.applyLayoutPrototype(layoutPrototype,layout,layoutPrototypeLinkEnabled);
    }
 catch (    PortalException pe) {
      throw pe;
    }
catch (    SystemException se) {
      throw se;
    }
catch (    Exception e) {
      throw new SystemException(e);
    }
  }
  boolean addGroupPermissions=true;
  Group group=groupLocalService.getGroup(groupId);
  if (privateLayout && group.isUser()) {
    addGroupPermissions=false;
  }
  boolean addGuestPermissions=false;
  if (!privateLayout || type.equals(LayoutConstants.TYPE_CONTROL_PANEL) || group.isLayoutSetPrototype()) {
    addGuestPermissions=true;
  }
  resourceLocalService.addResources(user.getCompanyId(),groupId,user.getUserId(),Layout.class.getName(),layout.getPlid(),false,addGroupPermissions,addGuestPermissions);
  groupLocalService.updateSite(groupId,true);
  layoutSetLocalService.updatePageCount(groupId,privateLayout);
  LayoutSet layoutSet=layoutSetPersistence.findByG_P(groupId,privateLayout);
  layout.setLayoutSet(layoutSet);
  updateAsset(userId,layout,serviceContext.getAssetCategoryIds(),serviceContext.getAssetTagNames());
  return layout;
}
