{
  ThemeLoader themeLoader=ThemeLoaderFactory.getDefaultThemeLoader();
  if (themeLoader == null) {
    _log.error("No theme loaders are deployed");
    return null;
  }
  ZipReader zipReader=new ZipReader(new ByteArrayInputStream(themeZip));
  Map entries=zipReader.getEntries();
  String lookAndFeelXML=new String((byte[])entries.get("liferay-look-and-feel.xml"));
  Date now=new Date();
  String themeId=layoutSet.getGroupId() + "-" + Time.getShortTimestamp(now);
  String themeName=themeId;
  lookAndFeelXML=StringUtil.replace(lookAndFeelXML,new String[]{"[$GROUP_ID$]","[$THEME_ID$]","[$THEME_NAME$]"},new String[]{String.valueOf(layoutSet.getGroupId()),themeId,themeName});
  Iterator itr=entries.entrySet().iterator();
  while (itr.hasNext()) {
    Map.Entry entry=(Map.Entry)itr.next();
    String key=(String)entry.getKey();
    byte[] value=(byte[])entry.getValue();
    if (key.equals("liferay-look-and-feel.xml")) {
      value=lookAndFeelXML.getBytes();
    }
    FileUtil.write(themeLoader.getFileStorage() + "/" + themeId+ "/"+ key,value);
  }
  themeLoader.loadThemes();
  CommLink commLink=CommLink.getInstance();
  MethodWrapper methodWrapper=new MethodWrapper(ThemeLoaderFactory.class.getName(),"loadThemes");
  commLink.send(methodWrapper);
  themeId+=PortletImpl.WAR_SEPARATOR + themeLoader.getServletContextName();
  return PortalUtil.getJsSafePortletId(themeId);
}
