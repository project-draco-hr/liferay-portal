{
  PortletPreferences portletPreferences=null;
  long plid=PortletKeys.PREFS_OWNER_ID_DEFAULT;
  if (layout != null) {
    plid=layout.getPlid();
  }
  if ((ownerType == PortletKeys.PREFS_OWNER_TYPE_COMPANY) || (ownerType == PortletKeys.PREFS_OWNER_TYPE_GROUP) || (ownerType == PortletKeys.PREFS_OWNER_TYPE_ARCHIVED)) {
    plid=PortletKeys.PREFS_OWNER_ID_DEFAULT;
  }
  try {
    portletPreferences=portletPreferencesLocalService.getPortletPreferences(ownerId,ownerType,plid,portletId);
    LayoutTypePortlet layoutTypePortlet=null;
    if (layout != null) {
      layoutTypePortlet=(LayoutTypePortlet)layout.getLayoutType();
    }
    if ((layoutTypePortlet == null) || (layoutTypePortlet.hasPortletId(portletId))) {
      Element el=parentEl.addElement("portlet-preferences");
      el.addAttribute("owner-id",String.valueOf(ownerId));
      el.addAttribute("owner-type",String.valueOf(ownerType));
      el.addAttribute("default-user",String.valueOf(defaultUser));
      el.addAttribute("plid",String.valueOf(plid));
      el.addAttribute("portlet-id",portletId);
      if (ownerType == PortletKeys.PREFS_OWNER_TYPE_ARCHIVED) {
        PortletItem portletItem=portletItemLocalService.getPortletItem(ownerId);
        User user=userLocalService.getUserById(portletItem.getUserId());
        el.addAttribute("archive-user-uuid",user.getUuid());
        el.addAttribute("archive-name",portletItem.getName());
      }
      el.addElement("preferences").addCDATA(portletPreferences.getPreferences());
    }
  }
 catch (  NoSuchPortletPreferencesException nsppe) {
  }
}
