{
  User user=userPersistence.findByPrimaryKey(userId);
  long layoutId=getNextLayoutId(groupId,privateLayout);
  parentLayoutId=getParentLayoutId(groupId,privateLayout,parentLayoutId);
  String name=localeNamesMap.get(LocaleUtil.getDefault());
  friendlyURL=getFriendlyURL(groupId,privateLayout,layoutId,name,friendlyURL);
  int priority=getNextPriority(groupId,privateLayout,parentLayoutId);
  validate(groupId,privateLayout,layoutId,parentLayoutId,name,type,hidden,friendlyURL);
  long plid=counterLocalService.increment();
  Layout layout=layoutPersistence.create(plid);
  layout.setGroupId(groupId);
  layout.setCompanyId(user.getCompanyId());
  layout.setPrivateLayout(privateLayout);
  layout.setLayoutId(layoutId);
  layout.setParentLayoutId(parentLayoutId);
  layout.setDescription(description);
  layout.setType(type);
  layout.setHidden(hidden);
  layout.setFriendlyURL(friendlyURL);
  layout.setPriority(priority);
  layout.setDlFolderId(dlFolderId);
  setLocalizedAttributes(layout,localeNamesMap,localeTitlesMap);
  if (type.equals(LayoutConstants.TYPE_PORTLET)) {
    LayoutTypePortlet layoutTypePortlet=(LayoutTypePortlet)layout.getLayoutType();
    layoutTypePortlet.setLayoutTemplateId(0,PropsValues.LAYOUT_DEFAULT_TEMPLATE_ID,false);
  }
  layoutPersistence.update(layout,false);
  resourceLocalService.addResources(user.getCompanyId(),groupId,user.getUserId(),Layout.class.getName(),layout.getPlid(),false,true,true);
  layoutSetLocalService.updatePageCount(groupId,privateLayout);
  return layout;
}
