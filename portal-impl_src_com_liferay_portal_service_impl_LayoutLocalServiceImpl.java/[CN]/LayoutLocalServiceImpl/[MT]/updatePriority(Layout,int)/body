{
  if (layout.getPriority() == priority) {
    return layout;
  }
  Date now=new Date();
  boolean lessThan=false;
  if (layout.getPriority() < priority) {
    lessThan=true;
  }
  LayoutSet layoutSet=layoutSetPersistence.fetchByG_P(layout.getGroupId(),layout.isPrivateLayout());
  layout.setModifiedDate(now);
  layout.setPriority(getNextPriority(layoutSet,layout.getParentLayoutId(),layout.getSourcePrototypeLayoutUuid(),priority));
  layoutPersistence.update(layout,false);
  priority=0;
  List<Layout> layouts=layoutPersistence.findByG_P_P(layout.getGroupId(),layout.isPrivateLayout(),layout.getParentLayoutId());
  layouts=ListUtil.sort(layouts,new LayoutPriorityComparator(layout,lessThan));
  for (  Layout curLayout : layouts) {
    int curPriority=getNextPriority(layoutSet,layout.getParentLayoutId(),curLayout.getSourcePrototypeLayoutUuid(),priority++);
    curLayout.setModifiedDate(now);
    curLayout.setPriority(curPriority);
    layoutPersistence.update(curLayout,false);
    if (curLayout.equals(layout)) {
      layout=curLayout;
    }
  }
  return layout;
}
