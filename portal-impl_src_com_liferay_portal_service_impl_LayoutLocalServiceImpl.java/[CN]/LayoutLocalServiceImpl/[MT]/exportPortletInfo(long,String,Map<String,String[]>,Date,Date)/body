{
  boolean exportPortletSetup=MapUtil.getBoolean(parameterMap,PortletDataHandlerKeys.PORTLET_SETUP);
  boolean exportPortletArchivedSetups=MapUtil.getBoolean(parameterMap,PortletDataHandlerKeys.PORTLET_ARCHIVED_SETUPS);
  boolean exportPortletUserPreferences=MapUtil.getBoolean(parameterMap,PortletDataHandlerKeys.PORTLET_USER_PREFERENCES);
  StopWatch stopWatch=null;
  if (_log.isInfoEnabled()) {
    stopWatch=new StopWatch();
    stopWatch.start();
  }
  Layout layout=LayoutLocalServiceUtil.getLayout(plid);
  if (!layout.getType().equals(LayoutConstants.TYPE_PORTLET)) {
    throw new LayoutImportException("Layout type " + layout.getType() + " is not valid");
  }
  LayoutTypePortlet layoutTypePortlet=(LayoutTypePortlet)layout.getLayoutType();
  if (!layoutTypePortlet.hasPortletId(portletId)) {
    throw new LayoutImportException("The specified layout does not have portlet " + portletId);
  }
  long companyId=layout.getCompanyId();
  long defaultUserId=userLocalService.getDefaultUserId(companyId);
  ZipWriter zipWriter=new ZipWriter();
  PortletDataContext context=new PortletDataContextImpl(companyId,layout.getGroupId(),parameterMap,new HashSet(),startDate,endDate,zipWriter);
  context.setPlid(plid);
  Document doc=DocumentHelper.createDocument();
  Element root=doc.addElement("root");
  Element header=root.addElement("header");
  header.addAttribute("build-number",String.valueOf(ReleaseInfo.getBuildNumber()));
  header.addAttribute("export-date",Time.getRFC822());
  if (context.hasDateRange()) {
    header.addAttribute("start-date",String.valueOf(context.getStartDate()));
    header.addAttribute("end-date",String.valueOf(context.getEndDate()));
  }
  header.addAttribute("type","portlet");
  header.addAttribute("group-id",String.valueOf(layout.getGroupId()));
  header.addAttribute("private-layout",String.valueOf(layout.isPrivateLayout()));
  header.addAttribute("root-portlet-id",PortletConstants.getRootPortletId(portletId));
  PortletPreferences portletPreferences=portletPreferencesLocalService.getPortletPreferences(plid).get(0);
  javax.portlet.PortletPreferences jxPrefs=portletPreferencesLocalService.getPreferences(layout.getCompanyId(),portletPreferences.getOwnerId(),portletPreferences.getOwnerType(),plid,portletId);
  exportPortletData(context,portletId,jxPrefs,root);
  exportComments(context,root);
  exportRatings(context,root);
  exportTags(context,root);
  if (exportPortletSetup) {
    exportPortletPreferences(PortletKeys.PREFS_OWNER_ID_DEFAULT,PortletKeys.PREFS_OWNER_TYPE_LAYOUT,false,layout,portletId,root);
    exportPortletPreferences(layout.getGroupId(),PortletKeys.PREFS_OWNER_TYPE_GROUP,false,layout,portletId,root);
    exportPortletPreferences(layout.getCompanyId(),PortletKeys.PREFS_OWNER_TYPE_COMPANY,false,layout,portletId,root);
  }
  if (exportPortletArchivedSetups) {
    String rootPortletId=PortletConstants.getRootPortletId(portletId);
    List<PortletItem> portletItems=portletItemLocalService.getPortletItems(layout.getGroupId(),rootPortletId,PortletPreferences.class.getName());
    for (    PortletItem portletItem : portletItems) {
      long ownerId=portletItem.getPortletItemId();
      int ownerType=PortletKeys.PREFS_OWNER_TYPE_ARCHIVED;
      exportPortletPreferences(ownerId,ownerType,false,null,portletItem.getPortletId(),root);
    }
  }
  if (exportPortletUserPreferences) {
    exportPortletPreferences(defaultUserId,PortletKeys.PREFS_OWNER_TYPE_USER,true,layout,portletId,root);
  }
  if (_log.isInfoEnabled()) {
    _log.info("Exporting portlet info takes " + stopWatch.getTime() + " ms");
  }
  try {
    zipWriter.addEntry("portlet.xml",XMLFormatter.toString(doc));
    return zipWriter.finish();
  }
 catch (  IOException ioe) {
    throw new SystemException(ioe);
  }
}
