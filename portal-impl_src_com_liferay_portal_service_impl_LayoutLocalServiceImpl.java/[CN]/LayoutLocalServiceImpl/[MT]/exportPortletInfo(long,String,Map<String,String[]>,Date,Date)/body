{
  boolean exportPermissions=MapUtil.getBoolean(parameterMap,PortletDataHandlerKeys.PERMISSIONS);
  boolean exportUserPermissions=MapUtil.getBoolean(parameterMap,PortletDataHandlerKeys.USER_PERMISSIONS);
  boolean exportPortletData=true;
  boolean exportPortletSetup=MapUtil.getBoolean(parameterMap,PortletDataHandlerKeys.PORTLET_SETUP);
  boolean exportPortletArchivedSetups=MapUtil.getBoolean(parameterMap,PortletDataHandlerKeys.PORTLET_ARCHIVED_SETUPS);
  boolean exportPortletUserPreferences=MapUtil.getBoolean(parameterMap,PortletDataHandlerKeys.PORTLET_USER_PREFERENCES);
  if (_log.isDebugEnabled()) {
    _log.debug("Export permissions " + exportPermissions);
    _log.debug("Export user permissions " + exportUserPermissions);
    _log.debug("Export portlet data " + exportPortletData);
    _log.debug("Export portlet setup " + exportPortletSetup);
    _log.debug("Export portlet archived setups " + exportPortletArchivedSetups);
    _log.debug("Export portlet user preferences " + exportPortletUserPreferences);
  }
  StopWatch stopWatch=null;
  if (_log.isInfoEnabled()) {
    stopWatch=new StopWatch();
    stopWatch.start();
  }
  LayoutCache layoutCache=new LayoutCache();
  Layout layout=LayoutLocalServiceUtil.getLayout(plid);
  if (!layout.getType().equals(LayoutConstants.TYPE_PORTLET)) {
    throw new LayoutImportException("Layout type " + layout.getType() + " is not valid");
  }
  LayoutTypePortlet layoutTypePortlet=(LayoutTypePortlet)layout.getLayoutType();
  if (!layoutTypePortlet.hasPortletId(portletId)) {
    throw new LayoutImportException("The specified layout does not have portlet " + portletId);
  }
  long companyId=layout.getCompanyId();
  long defaultUserId=userLocalService.getDefaultUserId(companyId);
  ZipWriter zipWriter=new ZipWriter();
  PortletDataContext context=new PortletDataContextImpl(companyId,layout.getGroupId(),parameterMap,new HashSet(),startDate,endDate,zipWriter);
  context.setPlid(plid);
  Document doc=DocumentHelper.createDocument();
  Element root=doc.addElement("root");
  Element header=root.addElement("header");
  header.addAttribute("build-number",String.valueOf(ReleaseInfo.getBuildNumber()));
  header.addAttribute("export-date",Time.getRFC822());
  if (context.hasDateRange()) {
    header.addAttribute("start-date",String.valueOf(context.getStartDate()));
    header.addAttribute("end-date",String.valueOf(context.getEndDate()));
  }
  header.addAttribute("type","portlet");
  header.addAttribute("group-id",String.valueOf(layout.getGroupId()));
  header.addAttribute("private-layout",String.valueOf(layout.isPrivateLayout()));
  header.addAttribute("root-portlet-id",PortletConstants.getRootPortletId(portletId));
  exportPortlet(context,layoutCache,portletId,layout,root,defaultUserId,exportPortletData,exportPortletSetup,exportPortletArchivedSetups,exportPortletUserPreferences,exportPermissions,exportUserPermissions);
  exportComments(context,root);
  exportRatings(context,root);
  exportTags(context,root);
  if (_log.isInfoEnabled()) {
    _log.info("Exporting portlet took " + stopWatch.getTime() + " ms");
  }
  try {
    context.addZipEntry("/manifest.xml",XMLFormatter.toString(doc));
    return zipWriter.finish();
  }
 catch (  IOException ioe) {
    throw new SystemException(ioe);
  }
}
