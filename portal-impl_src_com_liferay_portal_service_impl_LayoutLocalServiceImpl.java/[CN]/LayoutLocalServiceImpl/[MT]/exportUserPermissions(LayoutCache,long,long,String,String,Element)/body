{
  Element userPermissionsEl=DocumentHelper.createElement("user-permissions");
  List users=layoutCache.getGroupUsers(groupId);
  StopWatch stopWatch=null;
  if (_log.isDebugEnabled()) {
    stopWatch=new StopWatch();
    stopWatch.start();
  }
  for (int i=0; i < users.size(); i++) {
    User user=(User)users.get(i);
    String emailAddress=user.getEmailAddress();
    Element userActionsEl=DocumentHelper.createElement("user-actions");
    List permissions=permissionLocalService.getUserPermissions(user.getUserId(),companyId,resourceName,ResourceImpl.SCOPE_INDIVIDUAL,resourcePrimKey);
    List actions=ResourceActionsUtil.getActions(permissions);
    for (int j=0; j < actions.size(); j++) {
      String action=(String)actions.get(j);
      Element actionKeyEl=userActionsEl.addElement("action-key");
      actionKeyEl.addText(action);
    }
    if (!userActionsEl.elements().isEmpty()) {
      userActionsEl.addAttribute("email-address",emailAddress);
      userPermissionsEl.add(userActionsEl);
    }
  }
  if (_log.isDebugEnabled()) {
    _log.debug("getUserPermissions for {" + resourceName + ", "+ resourcePrimKey+ "}, for "+ users.size()+ " users takes "+ stopWatch.getTime()+ " ms");
  }
  if (!userPermissionsEl.elements().isEmpty()) {
    parentEl.add(userPermissionsEl);
  }
}
