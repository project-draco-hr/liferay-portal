{
  BundleContext bundleContext=bundle.getBundleContext();
  if (serviceRegistrations._contextServiceRegistration != null) {
    ServiceReference<?> serviceReference=serviceRegistrations._contextServiceRegistration.getReference();
    return (BundlePortletApp)bundleContext.getService(serviceReference);
  }
  com.liferay.portal.model.Portlet portalPortletModel=_portletLocalService.getPortletById(CompanyConstants.SYSTEM,PortletKeys.PORTAL);
  String contextName=String.valueOf(bundle.getBundleId());
  String contextPath="/".concat(contextName);
  BundlePortletApp bundlePortletApp=new BundlePortletApp(bundle,portalPortletModel,contextName,contextPath,_httpServiceEndpoints.get(0));
  ServletContext servletContext=(ServletContext)ProxyUtil.newProxyInstance(classLoader,new Class<?>[]{ServletContext.class},new BundleServletContextInvocationHandler(_servletContext,bundlePortletApp,classLoader));
  bundlePortletApp.setServletContext(servletContext);
  Dictionary<String,Object> properties=new Hashtable<String,Object>();
  properties.put(HttpWhiteboardConstants.HTTP_WHITEBOARD_CONTEXT_NAME,contextName);
  properties.put(HttpWhiteboardConstants.HTTP_WHITEBOARD_CONTEXT_PATH,contextPath);
  ServiceRegistration<?> serviceRegistration=bundleContext.registerService(ServletContextHelper.class,bundlePortletApp,properties);
  serviceRegistrations._contextServiceRegistration=serviceRegistration;
  return bundlePortletApp;
}
