{
  BundleContext bundleContext=bundle.getBundleContext();
  if (serviceRegistrations._bundlePortletAppServiceRegistration != null) {
    ServiceReference<?> serviceReference=serviceRegistrations._bundlePortletAppServiceRegistration.getReference();
    return (BundlePortletApp)bundleContext.getService(serviceReference);
  }
  com.liferay.portal.model.Portlet portalPortletModel=_portletLocalService.getPortletById(CompanyConstants.SYSTEM,PortletKeys.PORTAL);
  String contextName=String.valueOf(bundle.getBundleId());
  String contextPath=StringPool.SLASH.concat(contextName);
  BundlePortletApp bundlePortletApp=new BundlePortletApp(bundle,portalPortletModel,contextName,contextPath,_httpServiceEndpoints.get(0));
  ServletContext servletContext=(ServletContext)ProxyUtil.newProxyInstance(classLoader,new Class<?>[]{ServletContext.class},new BundleServletContextInvocationHandler(_servletContext,bundlePortletApp,classLoader));
  bundlePortletApp.setServletContext(servletContext);
  try {
    serviceRegistrations._configuration=ConfigurationFactoryUtil.getConfiguration(classLoader,"portlet");
  }
 catch (  Exception e) {
  }
  readResourceActions(serviceRegistrations._configuration,bundlePortletApp.getServletContextName(),classLoader);
  Dictionary<String,Object> properties=new Hashtable<String,Object>();
  properties.put(HttpWhiteboardConstants.HTTP_WHITEBOARD_CONTEXT_NAME,contextName);
  properties.put(HttpWhiteboardConstants.HTTP_WHITEBOARD_CONTEXT_PATH,contextPath);
  ServiceRegistration<?> serviceRegistration=bundleContext.registerService(ServletContextHelper.class,bundlePortletApp,properties);
  serviceRegistrations._bundlePortletAppServiceRegistration=serviceRegistration;
  return bundlePortletApp;
}
