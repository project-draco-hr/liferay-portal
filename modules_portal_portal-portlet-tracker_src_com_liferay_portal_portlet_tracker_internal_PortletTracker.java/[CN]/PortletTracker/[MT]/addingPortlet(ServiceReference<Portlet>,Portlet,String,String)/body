{
  Bundle bundle=serviceReference.getBundle();
  BundleWiring bundleWiring=bundle.adapt(BundleWiring.class);
  ServiceRegistrations serviceRegistrations=getServiceRegistrations(bundle);
  serviceRegistrations._counter++;
  BundlePortletApp bundlePortletApp=createBundlePortletApp(bundle,bundleWiring.getClassLoader(),serviceRegistrations);
  com.liferay.portal.model.Portlet portletModel=buildPortletModel(bundlePortletApp,portletId);
  portletModel.setPortletName(portletName);
  String displayName=GetterUtil.getString(serviceReference.getProperty("javax.portlet.display-name"),portletName);
  warnPorletProperties(portletName,serviceReference);
  portletModel.setDisplayName(displayName);
  Class<?> portletClazz=portlet.getClass();
  portletModel.setPortletClass(portletClazz.getName());
  collectJxPortletFeatures(serviceReference,portletModel);
  collectLiferayFeatures(serviceReference,portletModel);
  PortletBagFactory portletBagFactory=new BundlePortletBagFactory(portlet);
  portletBagFactory.setClassLoader(bundleWiring.getClassLoader());
  portletBagFactory.setServletContext(bundlePortletApp.getServletContext());
  portletBagFactory.setWARFile(true);
  try {
    portletBagFactory.create(portletModel);
    checkWebResources(bundle,portletModel,serviceRegistrations);
    List<Company> companies=_companyLocalService.getCompanies();
    deployPortlet(serviceReference,portletModel,companies);
    checkResources(serviceReference,portletModel,companies);
    portletModel.setReady(true);
    if (_log.isInfoEnabled()) {
      _log.info("Added " + serviceReference);
    }
    return portletModel;
  }
 catch (  Exception e) {
    _log.error(e,e);
    BundleContext bundleContext=_componentContext.getBundleContext();
    bundleContext.ungetService(serviceReference);
    return null;
  }
}
