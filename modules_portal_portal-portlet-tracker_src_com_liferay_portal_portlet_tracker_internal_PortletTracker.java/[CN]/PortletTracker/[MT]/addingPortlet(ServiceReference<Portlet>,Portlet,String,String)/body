{
  com.liferay.portal.model.Portlet portletModel=buildPortletModel(portletId);
  portletModel.setPortletName(portletName);
  String displayName=GetterUtil.getString(serviceReference.getProperty("javax.portlet.display-name"),portletName);
  portletModel.setDisplayName(displayName);
  Class<?> portletClazz=portlet.getClass();
  portletModel.setPortletClass(portletClazz.getName());
  collectCacheScope(serviceReference,portletModel);
  collectExpirationCache(serviceReference,portletModel);
  collectInitParams(serviceReference,portletModel);
  collectPortletInfo(serviceReference,portletModel,displayName);
  collectPortletModes(serviceReference,portletModel);
  collectPortletPreferences(serviceReference,portletModel);
  collectSecurityRoleRefs(serviceReference,portletModel);
  collectWindowStates(serviceReference,portletModel);
  Bundle bundle=serviceReference.getBundle();
  PortletBagFactory portletBagFactory=new BundlePortletBagFactory(bundle,portlet);
  BundleWiring bundleWiring=bundle.adapt(BundleWiring.class);
  portletBagFactory.setClassLoader(bundleWiring.getClassLoader());
  portletBagFactory.setServletContext(_servletContext);
  portletBagFactory.setWARFile(true);
  portletBagFactory.create(portletModel);
  List<Company> companies=_companyLocalService.getCompanies();
  deployPortlet(serviceReference,portletModel,companies);
  checkResources(serviceReference,portletModel,companies);
  portletModel.setReady(true);
  if (_log.isInfoEnabled()) {
    _log.info("Added " + serviceReference);
  }
}
