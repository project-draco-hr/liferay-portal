{
  try {
    filterChain.doFilter(request,response);
  }
  finally {
    PortletRequest portletRequest=(PortletRequest)request.getAttribute(JavaConstants.JAVAX_PORTLET_REQUEST);
    if (portletRequest == null) {
      return;
    }
    RestrictPortletServletRequest restrictPortletServletRequest=new RestrictPortletServletRequest(PortalUtil.getHttpServletRequest(portletRequest));
    for (Enumeration<String> names=request.getAttributeNames(); names.hasMoreElements(); ) {
      String name=names.nextElement();
      if (!RestrictPortletServletRequest.isSharedRequestAttribute(name)) {
        continue;
      }
      restrictPortletServletRequest.setAttribute(name,request.getAttribute(name));
    }
    restrictPortletServletRequest.mergeSharedAttributes();
  }
}
