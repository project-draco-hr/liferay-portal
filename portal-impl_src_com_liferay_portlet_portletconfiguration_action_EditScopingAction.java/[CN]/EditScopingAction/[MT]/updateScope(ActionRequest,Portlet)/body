{
  ThemeDisplay themeDisplay=(ThemeDisplay)req.getAttribute(WebKeys.THEME_DISPLAY);
  Layout layout=themeDisplay.getLayout();
  PortletPreferences prefs=PortletPreferencesFactoryUtil.getLayoutPortletSetup(layout,portlet.getPortletId());
  long scopeLayoutId=ParamUtil.getLong(req,"lfr-scope-layout-id");
  if (scopeLayoutId > 0) {
    try {
      Layout scopeLayout=LayoutLocalServiceUtil.getLayout(layout.getGroupId(),layout.isPrivateLayout(),scopeLayoutId);
      if (!scopeLayout.hasScopeGroup()) {
        String name=layout.getName(LocaleUtil.getDefault());
        name=StringUtil.shorten(name,75,StringPool.BLANK);
        GroupLocalServiceUtil.addGroup(themeDisplay.getUserId(),Layout.class.getName(),scopeLayout.getPlid(),name,null,0,null,true);
      }
    }
 catch (    NoSuchLayoutException nsle) {
      scopeLayoutId=0;
    }
  }
  prefs.setValue("lfr-scope-layout-id",String.valueOf(scopeLayoutId));
  prefs.store();
}
