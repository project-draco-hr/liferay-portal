{
  HttpServletRequest request=PortalUtil.getHttpServletRequest(actionRequest);
  HttpServletResponse response=PortalUtil.getHttpServletResponse(actionResponse);
  HttpSession session=request.getSession();
  LiferayPortletResponse liferayPortletResponse=PortalUtil.getLiferayPortletResponse(actionResponse);
  String openId=ParamUtil.getString(actionRequest,"openId");
  PortletURL portletURL=liferayPortletResponse.createActionURL();
  portletURL.setParameter("saveLastPath",Boolean.FALSE.toString());
  portletURL.setParameter(Constants.CMD,Constants.READ);
  portletURL.setParameter("struts_action","/login/open_id");
  List<DiscoveryInformation> discoveries=_manager.discover(openId);
  DiscoveryInformation discovered=_manager.associate(discoveries);
  session.setAttribute(OpenIdWebKeys.OPEN_ID_DISCO,discovered);
  AuthRequest authRequest=_manager.authenticate(discovered,portletURL.toString(),themeDisplay.getPortalURL());
  if (UserLocalServiceUtil.fetchUserByOpenId(themeDisplay.getCompanyId(),openId) != null) {
    response.sendRedirect(authRequest.getDestinationUrl(true));
    return;
  }
  String screenName=getScreenName(openId);
  User user=UserLocalServiceUtil.fetchUserByScreenName(themeDisplay.getCompanyId(),screenName);
  if (user != null) {
    UserLocalServiceUtil.updateOpenId(user.getUserId(),openId);
    response.sendRedirect(authRequest.getDestinationUrl(true));
    return;
  }
  FetchRequest fetchRequest=FetchRequest.createFetchRequest();
  OpenIdProvider openIdProvider=_openIdProviderRegistry.getOpenIdProvider(discovered.getOPEndpoint());
  String[] openIdAXTypes=openIdProvider.getAxSchema();
  for (  String openIdAXType : openIdAXTypes) {
    openIdAXType=StringUtil.toUpperCase(openIdAXType.substring(0,1)).concat(openIdAXType.substring(1,openIdAXType.length()));
    fetchRequest.addAttribute(openIdAXType,BeanPropertiesUtil.getString(openIdProvider,openIdAXType),true);
  }
  authRequest.addExtension(fetchRequest);
  SRegRequest sRegRequest=SRegRequest.createFetchRequest();
  sRegRequest.addAttribute(_OPEN_ID_SREG_ATTR_EMAIL,true);
  sRegRequest.addAttribute(_OPEN_ID_SREG_ATTR_FULLNAME,true);
  authRequest.addExtension(sRegRequest);
  response.sendRedirect(authRequest.getDestinationUrl(true));
}
