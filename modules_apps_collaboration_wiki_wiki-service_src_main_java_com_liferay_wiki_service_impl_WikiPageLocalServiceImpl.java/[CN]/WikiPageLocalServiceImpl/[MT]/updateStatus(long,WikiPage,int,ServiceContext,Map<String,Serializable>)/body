{
  User user=userPersistence.findByPrimaryKey(userId);
  int oldStatus=page.getStatus();
  page.setStatus(status);
  page.setStatusByUserId(userId);
  page.setStatusByUserName(user.getFullName());
  page.setStatusDate(new Date());
  wikiPagePersistence.update(page);
  if (status == WorkflowConstants.STATUS_APPROVED) {
    String cmd=GetterUtil.getString(workflowContext.get(WorkflowConstants.CONTEXT_COMMAND));
    if (cmd.equals(Constants.RENAME)) {
      long resourcePrimKey=page.getResourcePrimKey();
      WikiPage oldPage=getPage(resourcePrimKey,true);
      page=doRenamePage(userId,page.getNodeId(),oldPage.getTitle(),page.getTitle(),serviceContext);
    }
 else     if (cmd.equals(Constants.CHANGE_PARENT)) {
      List<WikiPage> pageVersions=wikiPagePersistence.findByN_T(page.getNodeId(),page.getTitle());
      for (      WikiPage pageVersion : pageVersions) {
        pageVersion.setParentTitle(page.getParentTitle());
        wikiPagePersistence.update(pageVersion);
      }
    }
    if ((oldStatus != WorkflowConstants.STATUS_APPROVED) && (page.getVersion() != WikiPageConstants.VERSION_DEFAULT)) {
      AssetEntry draftAssetEntry=assetEntryLocalService.fetchEntry(WikiPage.class.getName(),page.getPrimaryKey());
      if (draftAssetEntry != null) {
        long[] assetCategoryIds=draftAssetEntry.getCategoryIds();
        String[] assetTagNames=draftAssetEntry.getTagNames();
        List<AssetLink> assetLinks=assetLinkLocalService.getDirectLinks(draftAssetEntry.getEntryId(),AssetLinkConstants.TYPE_RELATED,false);
        long[] assetLinkEntryIds=ListUtil.toLongArray(assetLinks,AssetLink.ENTRY_ID2_ACCESSOR);
        AssetEntry assetEntry=assetEntryLocalService.updateEntry(userId,page.getGroupId(),page.getCreateDate(),page.getModifiedDate(),WikiPage.class.getName(),page.getResourcePrimKey(),page.getUuid(),0,assetCategoryIds,assetTagNames,true,true,null,null,page.getCreateDate(),null,ContentTypes.TEXT_HTML,page.getTitle(),null,null,null,null,0,0,null);
        assetLinkLocalService.updateLinks(userId,assetEntry.getEntryId(),assetLinkEntryIds,AssetLinkConstants.TYPE_RELATED);
        SystemEventHierarchyEntryThreadLocal.push(WikiPage.class);
        try {
          assetEntryLocalService.deleteEntry(draftAssetEntry.getEntryId());
        }
  finally {
          SystemEventHierarchyEntryThreadLocal.pop(WikiPage.class);
        }
      }
    }
    assetEntryLocalService.updateVisible(WikiPage.class.getName(),page.getResourcePrimKey(),true);
    WikiGroupServiceOverriddenConfiguration wikiGroupServiceOverriddenConfiguration=configurationProvider.getConfiguration(WikiGroupServiceOverriddenConfiguration.class,new GroupServiceSettingsLocator(page.getGroupId(),WikiConstants.SERVICE_NAME));
    if ((oldStatus != WorkflowConstants.STATUS_IN_TRASH) && (!page.isMinorEdit() || wikiGroupServiceOverriddenConfiguration.pageMinorEditAddSocialActivity())) {
      JSONObject extraDataJSONObject=JSONFactoryUtil.createJSONObject();
      extraDataJSONObject.put("title",page.getTitle());
      extraDataJSONObject.put("version",page.getVersion());
      int type=WikiActivityKeys.UPDATE_PAGE;
      if (serviceContext.isCommandAdd()) {
        type=WikiActivityKeys.ADD_PAGE;
      }
      SocialActivityManagerUtil.addActivity(userId,page,type,extraDataJSONObject.toString(),0);
    }
    if (NotificationThreadLocal.isEnabled() && (!page.isMinorEdit() || wikiGroupServiceOverriddenConfiguration.pageMinorEditSendEmail())) {
      notifySubscribers(userId,page,(String)workflowContext.get(WorkflowConstants.CONTEXT_URL),serviceContext);
    }
    clearPageCache(page);
  }
  if (status == WorkflowConstants.STATUS_APPROVED) {
    page.setHead(true);
    List<WikiPage> pages=wikiPagePersistence.findByN_T_H(page.getNodeId(),page.getTitle(),true);
    for (    WikiPage curPage : pages) {
      if (!curPage.equals(page)) {
        curPage.setHead(false);
        wikiPagePersistence.update(curPage);
      }
    }
  }
 else   if (status != WorkflowConstants.STATUS_IN_TRASH) {
    page.setHead(false);
    List<WikiPage> pages=wikiPagePersistence.findByN_T_S(page.getNodeId(),page.getTitle(),WorkflowConstants.STATUS_APPROVED);
    for (    WikiPage curPage : pages) {
      if (!curPage.equals(page)) {
        curPage.setHead(true);
        wikiPagePersistence.update(curPage);
        break;
      }
    }
  }
  Indexer<WikiPage> indexer=IndexerRegistryUtil.nullSafeGetIndexer(WikiPage.class);
  indexer.reindex(page);
  return wikiPagePersistence.update(page);
}
