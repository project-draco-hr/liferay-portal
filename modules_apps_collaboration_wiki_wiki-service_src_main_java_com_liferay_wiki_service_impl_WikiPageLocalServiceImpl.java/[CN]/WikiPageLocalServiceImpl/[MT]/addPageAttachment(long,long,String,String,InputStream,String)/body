{
  WikiPage page=getPage(nodeId,title);
  Folder folder=page.addAttachmentsFolder();
  fileName=PortletFileRepositoryUtil.getUniqueFileName(page.getGroupId(),folder.getFolderId(),fileName);
  FileEntry fileEntry=PortletFileRepositoryUtil.addPortletFileEntry(page.getGroupId(),userId,WikiPage.class.getName(),page.getResourcePrimKey(),WikiPortletKeys.WIKI,folder.getFolderId(),inputStream,fileName,mimeType,true);
  if (userId == 0) {
    userId=page.getUserId();
  }
  JSONObject extraDataJSONObject=JSONFactoryUtil.createJSONObject();
  extraDataJSONObject.put("fileEntryId",fileEntry.getFileEntryId());
  extraDataJSONObject.put("fileEntryTitle",fileEntry.getTitle());
  extraDataJSONObject.put("title",page.getTitle());
  extraDataJSONObject.put("version",page.getVersion());
  SocialActivityManagerUtil.addActivity(userId,page,SocialActivityConstants.TYPE_ADD_ATTACHMENT,extraDataJSONObject.toString(),0);
  return fileEntry;
}
