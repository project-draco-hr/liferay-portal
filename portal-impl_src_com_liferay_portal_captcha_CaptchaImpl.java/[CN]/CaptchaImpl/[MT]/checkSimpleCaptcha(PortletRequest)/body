{
  if (!isEnabled(portletRequest)) {
    return;
  }
  PortletSession portletSession=portletRequest.getPortletSession();
  String captchaText=(String)portletSession.getAttribute(WebKeys.CAPTCHA_TEXT);
  if (captchaText == null) {
    if (_log.isErrorEnabled()) {
      _log.error("Captcha text is null. User " + portletRequest.getRemoteUser() + " may be trying to circumvent the captcha.");
    }
    throw new CaptchaTextException();
  }
  if (!captchaText.equals(ParamUtil.getString(portletRequest,"captchaText"))) {
    throw new CaptchaTextException();
  }
  if (_log.isDebugEnabled()) {
    _log.debug("Captcha text is valid");
  }
  portletSession.removeAttribute(WebKeys.CAPTCHA_TEXT);
  if ((PropsValues.CAPTCHA_MAX_CHALLENGES > 0) && (Validator.isNotNull(portletRequest.getRemoteUser()))) {
    Integer count=(Integer)portletSession.getAttribute(WebKeys.CAPTCHA_COUNT);
    if (count == null) {
      count=new Integer(1);
    }
 else {
      count=new Integer(count.intValue() + 1);
    }
    portletSession.setAttribute(WebKeys.CAPTCHA_COUNT,count);
  }
}
