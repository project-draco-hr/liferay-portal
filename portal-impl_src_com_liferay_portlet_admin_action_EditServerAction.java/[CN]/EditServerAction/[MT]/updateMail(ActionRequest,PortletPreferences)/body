{
  String auth=ParamUtil.getString(actionRequest,"auth","false");
  String host=ParamUtil.getString(actionRequest,"host",StringPool.BLANK);
  String password=ParamUtil.getString(actionRequest,"password",StringPool.BLANK);
  String port=ParamUtil.getString(actionRequest,"port",StringPool.BLANK);
  String username=ParamUtil.getString(actionRequest,"username",StringPool.BLANK);
  String require_ssl=ParamUtil.getString(actionRequest,"require_ssl","false");
  preferences.setValue(PropsKeys.MAIL_SESSION_MAIL_SMTP_AUTH,auth);
  preferences.setValue(PropsKeys.MAIL_SESSION_MAIL_SMTP_HOST,host);
  preferences.setValue(PropsKeys.MAIL_SESSION_MAIL_SMTP_PASSWORD,password);
  preferences.setValue(PropsKeys.MAIL_SESSION_MAIL_SMTP_PORT,port);
  preferences.setValue(PropsKeys.MAIL_SESSION_MAIL_SMTP_USER,username);
  preferences.setValue(PropsKeys.MAIL_SESSION_MAIL_SMTP_STARTTLS_ENABLE,require_ssl);
  preferences.store();
  Properties properties=PropsUtil.getProperties("mail.session.",true);
  if (require_ssl.equals("true")) {
    properties.setProperty("mail.transport.protocol",Account.PROTOCOL_SMTPS);
    properties.setProperty("mail.smtp.starttls.enable",require_ssl);
    properties.setProperty("mail.smtps.auth",auth);
    properties.setProperty("mail.smtps.host",host);
    properties.setProperty("mail.smtps.password",password);
    properties.setProperty("mail.smtps.port",port);
    properties.setProperty("mail.smtps.user",username);
  }
 else {
    properties.setProperty("mail.transport.protocol",Account.PROTOCOL_SMTP);
    properties.setProperty("mail.smtp.starttls.enable",require_ssl);
    properties.setProperty("mail.smtp.auth",auth);
    properties.setProperty("mail.smtp.host",host);
    properties.setProperty("mail.smtp.password",password);
    properties.setProperty("mail.smtp.port",port);
    properties.setProperty("mail.smtp.user",username);
  }
  Session session=Session.getInstance(properties);
  BeanLocator locator=PortalBeanLocatorUtil.getBeanLocator();
  InfrastructureUtil infrastructureUtil=(InfrastructureUtil)locator.locate(InfrastructureUtil.class.getName());
  infrastructureUtil.setMailSession(session);
}
