{
  boolean reCaptchaEnabled=ParamUtil.getBoolean(actionRequest,"reCaptchaEnabled");
  String reCaptchaPrivateKey=ParamUtil.getString(actionRequest,"reCaptchaPrivateKey");
  String reCaptchaPublicKey=ParamUtil.getString(actionRequest,"reCaptchaPublicKey");
  Captcha captcha=null;
  if (reCaptchaEnabled) {
    captcha=new ReCaptchaImpl();
  }
 else {
    captcha=new SimpleCaptchaImpl();
  }
  validateCaptcha(actionRequest);
  if (SessionErrors.isEmpty(actionRequest)) {
    portletPreferences.setValue(PropsKeys.CAPTCHA_ENGINE_IMPL,captcha.getClass().getName());
    portletPreferences.setValue(PropsKeys.CAPTCHA_ENGINE_RECAPTCHA_KEY_PRIVATE,reCaptchaPrivateKey);
    portletPreferences.setValue(PropsKeys.CAPTCHA_ENGINE_RECAPTCHA_KEY_PUBLIC,reCaptchaPublicKey);
    portletPreferences.store();
    CaptchaImpl captchaImpl=null;
    Captcha currentCaptcha=CaptchaUtil.getCaptcha();
    if (currentCaptcha instanceof DoPrivilegedBean) {
      DoPrivilegedBean doPrivilegedBean=(DoPrivilegedBean)currentCaptcha;
      captchaImpl=(CaptchaImpl)doPrivilegedBean.getActualBean();
    }
 else {
      captchaImpl=(CaptchaImpl)currentCaptcha;
    }
    captchaImpl.setCaptcha(captcha);
  }
}
