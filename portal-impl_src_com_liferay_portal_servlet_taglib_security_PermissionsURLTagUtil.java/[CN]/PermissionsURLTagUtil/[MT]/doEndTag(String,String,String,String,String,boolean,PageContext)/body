{
  try {
    HttpServletRequest req=(HttpServletRequest)pageContext.getRequest();
    ThemeDisplay themeDisplay=(ThemeDisplay)req.getAttribute(WebKeys.THEME_DISPLAY);
    PortletDisplay portletDisplay=themeDisplay.getPortletDisplay();
    Layout layout=themeDisplay.getLayout();
    if (Validator.isNull(redirect)) {
      redirect=PortalUtil.getCurrentURL(req);
    }
    PortletURL portletURL=new PortletURLImpl(req,PortletKeys.PORTLET_CONFIGURATION,layout.getPlid(),false);
    if (themeDisplay.isStatePopUp()) {
      portletURL.setWindowState(LiferayWindowState.POP_UP);
    }
 else {
      portletURL.setWindowState(WindowState.MAXIMIZED);
    }
    portletURL.setParameter("struts_action","/portlet_configuration/edit_permissions");
    portletURL.setParameter("redirect",redirect);
    if (!themeDisplay.isStateMaximized()) {
      portletURL.setParameter("returnToFullPageURL",redirect);
    }
    portletURL.setParameter("portletResource",portletDisplay.getId());
    portletURL.setParameter("modelResource",modelResource);
    portletURL.setParameter("modelResourceDescription",modelResourceDescription);
    portletURL.setParameter("resourcePrimKey",resourcePrimKey);
    String portletURLToString=portletURL.toString();
    if (Validator.isNotNull(var)) {
      pageContext.setAttribute(var,portletURLToString);
    }
 else     if (writeOutput) {
      pageContext.getOut().print(portletURLToString);
    }
    return portletURL.toString();
  }
 catch (  Exception e) {
    throw new JspException(e);
  }
}
