{
  if (query == null) {
    return _emptyWeightedTermArray;
  }
  Set<WeightedTerm> weightedTerms=new HashSet<WeightedTerm>();
  Set<Term> terms=new HashSet<Term>();
  LinkedList<Query> queries=new LinkedList<Query>();
  Query lastQuery=query;
  while (lastQuery != null) {
    if (lastQuery instanceof BooleanQuery) {
      BooleanQuery booleanQuery=(BooleanQuery)lastQuery;
      BooleanClause[] booleanClauses=booleanQuery.getClauses();
      for (      BooleanClause booleanClause : booleanClauses) {
        if (prohibited || (booleanClause.getOccur() != BooleanClause.Occur.MUST_NOT)) {
          Query booleanClauseQuery=booleanClause.getQuery();
          if (booleanClauseQuery != null) {
            queries.addFirst(booleanClauseQuery);
          }
        }
      }
      lastQuery=queries.poll();
    }
 else     if (lastQuery instanceof FilteredQuery) {
      FilteredQuery filteredQuery=(FilteredQuery)lastQuery;
      lastQuery=filteredQuery.getQuery();
      if (lastQuery == null) {
        lastQuery=queries.poll();
      }
    }
 else {
      Class<? extends Query> queryClass=lastQuery.getClass();
      if (!_queryClasses.contains(queryClass)) {
        try {
          lastQuery.extractTerms(terms);
          for (          Term term : terms) {
            if ((fieldName == null) || fieldName.equals(term.field())) {
              WeightedTerm weightedTerm=new WeightedTerm(query.getBoost(),term.text());
              weightedTerms.add(weightedTerm);
            }
          }
          terms.clear();
        }
 catch (        UnsupportedOperationException uoe) {
          _queryClasses.addIfAbsent(queryClass);
        }
      }
      lastQuery=queries.poll();
    }
  }
  return weightedTerms.toArray(new WeightedTerm[weightedTerms.size()]);
}
