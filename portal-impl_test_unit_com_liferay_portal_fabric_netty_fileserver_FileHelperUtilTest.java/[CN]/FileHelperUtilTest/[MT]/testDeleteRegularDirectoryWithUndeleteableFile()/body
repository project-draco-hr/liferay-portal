{
  final IOException ioException=new IOException("Unable to delete");
  Path regularDirectoryPath=Paths.get("RegularDirectory");
  final Path undeleteableFilePath=regularDirectoryPath.resolve("UndeleteableFile");
  createFile(undeleteableFilePath);
  try (SwappableSecurityManager swappableSecurityManager=new SwappableSecurityManager(){
    @Override public void checkDelete(    String file){
      if (file.equals(undeleteableFilePath.toString())) {
        ReflectionUtil.throwException(new DirectoryIteratorException(ioException));
      }
    }
  }
){
    swappableSecurityManager.install();
    FileHelperUtil.delete(true,regularDirectoryPath);
    FileHelperUtil.delete(regularDirectoryPath);
    Assert.fail();
  }
 catch (  Exception e) {
    if (JavaDetector.isJDK8()) {
      Assert.assertSame(ioException,e.getCause());
    }
 else {
      Assert.assertSame(ioException,e);
    }
  }
 finally {
    Files.delete(undeleteableFilePath);
    Files.delete(regularDirectoryPath);
  }
}
