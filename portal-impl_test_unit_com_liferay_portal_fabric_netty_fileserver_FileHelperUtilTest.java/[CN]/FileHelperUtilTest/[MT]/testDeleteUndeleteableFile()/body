{
  final IOException ioException=new IOException("Unable to delete");
  final Path undeleteableFilePath=Paths.get("UndeleteableFile");
  createFile(undeleteableFilePath);
  try (SwappableSecurityManager swappableSecurityManager=new SwappableSecurityManager(){
    @Override public void checkDelete(    String file){
      if (file.equals(undeleteableFilePath.toString())) {
        ReflectionUtil.throwException(ioException);
      }
    }
  }
){
    swappableSecurityManager.install();
    FileHelperUtil.delete(true,undeleteableFilePath);
    FileHelperUtil.delete(undeleteableFilePath);
    Assert.fail();
  }
 catch (  Exception e) {
    Assert.assertSame(ioException,e);
  }
 finally {
    Files.delete(undeleteableFilePath);
  }
}
