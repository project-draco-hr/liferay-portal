{
  Session session=MailEngine.getSession();
  String storeProtocol=GetterUtil.getString(session.getProperty("mail.store.protocol"));
  if (!storeProtocol.equals(Account.PROTOCOL_POPS)) {
    storeProtocol=Account.PROTOCOL_POP;
  }
  Store store=session.getStore(storeProtocol);
  String prefix="mail." + storeProtocol + ".";
  String host=session.getProperty(prefix + "host");
  String user=session.getProperty(prefix + "user");
  if (Validator.isNull(user)) {
    user=session.getProperty("mail.smtp.user");
  }
  String password=session.getProperty(prefix + "password");
  if (Validator.isNull(password)) {
    password=session.getProperty("mail.smtp.password");
  }
  store.connect(host,user,password);
  return store;
}
