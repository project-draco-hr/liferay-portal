{
  if (!_SESSION_ENABLE_PERSISTENT_COOKIES) {
    return;
  }
  String name=cookie.getName();
  String originalValue=cookie.getValue();
  String encodedValue=originalValue;
  if (isEncodedCookie(name)) {
    encodedValue=UnicodeFormatter.bytesToHex(originalValue.getBytes());
    if (_log.isDebugEnabled()) {
      _log.debug("Add encoded cookie " + name);
      _log.debug("Original value " + originalValue);
      _log.debug("Hex encoded value " + encodedValue);
    }
  }
  cookie.setSecure(secure);
  cookie.setValue(encodedValue);
  cookie.setVersion(0);
  Map<String,Cookie> cookieMap=_getCookieMap(request);
  if (cookieMap.isEmpty()) {
    cookieMap=new HashMap<>();
  }
  cookieMap.put(StringUtil.toUpperCase(name),cookie);
  request.setAttribute(CookieKeys.class.getName(),cookieMap);
  response.addCookie(cookie);
}
