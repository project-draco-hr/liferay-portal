{
  List<Address> clusterNodeAddresses=ClusterExecutorUtil.getClusterNodeAddresses();
  if (_log.isInfoEnabled()) {
    _log.info("Cluster node addresses " + clusterNodeAddresses);
  }
  if (clusterNodeAddresses.size() <= 1) {
    if (_log.isDebugEnabled()) {
      _log.debug("No cluster peer found, skip load cache from cluster.");
    }
    return;
  }
  EhcachePortalCacheManager<?,?> ehcachePortalCacheManager=(EhcachePortalCacheManager<?,?>)PortalBeanLocatorUtil.locate(_BEAN_NAME_MULTI_VM_PORTAL_CACHE_MANAGER);
  CacheManager cacheManager=ehcachePortalCacheManager.getEhcacheManager();
  List<String> allCacheNames=null;
  if (synchronizeCaches) {
    allCacheNames=Arrays.asList(cacheManager.getCacheNames());
  }
  List<String> toLoadCacheNames=new ArrayList<String>();
  for (  Ehcache ehcache : toLoadEhcaches) {
    toLoadCacheNames.add(ehcache.getName());
  }
  ClusterRequest clusterRequest=ClusterRequest.createMulticastRequest(new MethodHandler(_createServerSocketFromClusterMethodKey,allCacheNames,toLoadCacheNames),true);
  FutureClusterResponses futureClusterResponses=ClusterExecutorUtil.execute(clusterRequest);
  BlockingQueue<ClusterNodeResponse> clusterNodeResponses=futureClusterResponses.getPartialResults();
  ClusterNodeResponse clusterNodeResponse=null;
  try {
    clusterNodeResponse=clusterNodeResponses.poll(PropsValues.CLUSTER_LINK_NODE_BOOTUP_RESPONSE_TIMEOUT,TimeUnit.MILLISECONDS);
  }
 catch (  InterruptedException ie) {
    return;
  }
  if (clusterNodeResponse == null) {
    if (_log.isWarnEnabled()) {
      _log.warn("Load cache from cluster timeout, no peer responsed.");
    }
    return;
  }
  ObjectInputStream objectInputStream=null;
  Socket socket=null;
  try {
    SocketAddress remoteSocketAddress=(SocketAddress)clusterNodeResponse.getResult();
    if (remoteSocketAddress == null) {
      _log.error("Cluster peer " + clusterNodeResponse.getClusterNode() + " responsed null SocketAddress.");
      return;
    }
    socket=new Socket();
    socket.connect(remoteSocketAddress);
    socket.shutdownOutput();
    objectInputStream=new AnnotatedObjectInputStream(socket.getInputStream());
    Ehcache ehcache=null;
    while (true) {
      Object object=objectInputStream.readObject();
      if (object instanceof EhcacheElement) {
        EhcacheElement ehcacheElement=(EhcacheElement)object;
        Element element=ehcacheElement.toElement();
        ehcache.put(element,true);
      }
 else       if (object instanceof String) {
        if (_COMMAND_SOCKET_CLOSE.equals(object)) {
          break;
        }
        EhcacheStreamBootstrapCacheLoader.setSkip();
        try {
          ehcache=cacheManager.addCacheIfAbsent((String)object);
        }
  finally {
          EhcacheStreamBootstrapCacheLoader.resetSkip();
        }
      }
 else {
        throw new SystemException("Socket input stream returned invalid object " + object);
      }
    }
  }
  finally {
    if (objectInputStream != null) {
      objectInputStream.close();
    }
    if (socket != null) {
      socket.close();
    }
  }
}
