{
  ThemeDisplay themeDisplay=(ThemeDisplay)portletRequest.getAttribute(WebKeys.THEME_DISPLAY);
  WikiNode node=null;
  int nodesCount=WikiNodeLocalServiceUtil.getNodesCount(themeDisplay.getScopeGroupId());
  if (nodesCount == 0) {
    Layout layout=themeDisplay.getLayout();
    ServiceContext serviceContext=ServiceContextFactory.getInstance(WikiNode.class.getName(),portletRequest);
    serviceContext.setAddGroupPermissions(true);
    if (layout.isPublicLayout()) {
      serviceContext.setAddGuestPermissions(true);
    }
 else {
      serviceContext.setAddGuestPermissions(false);
    }
    node=WikiNodeLocalServiceUtil.addDefaultNode(themeDisplay.getUserId(),serviceContext);
  }
 else {
    node=WikiUtil.getFirstNode(portletRequest);
    if (node == null) {
      throw new PrincipalException();
    }
    return node;
  }
  portletRequest.setAttribute(WebKeys.WIKI_NODE,node);
  return node;
}
