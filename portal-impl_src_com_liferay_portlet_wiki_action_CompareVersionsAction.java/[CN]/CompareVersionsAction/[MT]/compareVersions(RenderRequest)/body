{
  long nodeId=ParamUtil.getLong(renderRequest,"nodeId");
  String title=ParamUtil.getString(renderRequest,"title");
  double sourceVersion=ParamUtil.getDouble(renderRequest,"sourceVersion");
  double targetVersion=ParamUtil.getDouble(renderRequest,"targetVersion");
  String type=ParamUtil.getString(renderRequest,"type","escape");
  WikiPage sourcePage=WikiPageServiceUtil.getPage(nodeId,title,sourceVersion);
  WikiPage targetPage=WikiPageServiceUtil.getPage(nodeId,title,targetVersion);
  String sourceContent=sourcePage.getContent();
  String targetContent=targetPage.getContent();
  sourceContent=WikiUtil.processContent(sourceContent);
  targetContent=WikiUtil.processContent(targetContent);
  if (type.equals("escape")) {
    sourceContent=HtmlUtil.escape(sourceContent);
    targetContent=HtmlUtil.escape(targetContent);
  }
 else   if (type.equals("strip")) {
    sourceContent=HtmlUtil.extractText(sourceContent);
    targetContent=HtmlUtil.extractText(targetContent);
  }
  List<DiffResult>[] diffResults=DiffUtil.diff(new StringReader(sourceContent),new StringReader(targetContent));
  renderRequest.setAttribute(WebKeys.SOURCE_NAME,title + StringPool.SPACE + sourceVersion);
  renderRequest.setAttribute(WebKeys.TARGET_NAME,title + StringPool.SPACE + targetVersion);
  renderRequest.setAttribute(WebKeys.DIFF_RESULTS,diffResults);
}
