{
  long nodeId=ParamUtil.getLong(req,"nodeId");
  String title=ParamUtil.getString(req,"title");
  double sourceVersion=ParamUtil.getDouble(req,"sourceVersion");
  double targetVersion=ParamUtil.getDouble(req,"targetVersion");
  String type=ParamUtil.getString(req,"type","escape");
  WikiPage sourcePage=WikiPageServiceUtil.getPage(nodeId,title,sourceVersion);
  WikiPage targetPage=WikiPageServiceUtil.getPage(nodeId,title,targetVersion);
  String sourceContent=sourcePage.getContent();
  String targetContent=targetPage.getContent();
  sourceContent=processContent(sourceContent);
  targetContent=processContent(targetContent);
  if (type.equals("escape")) {
    sourceContent=Html.escape(sourceContent);
    targetContent=Html.escape(targetContent);
  }
 else   if (type.equals("strip")) {
    sourceContent=Html.stripHtml(sourceContent);
    targetContent=Html.stripHtml(targetContent);
  }
  List[] diffResults=DiffUtil.diff(new StringReader(sourceContent),new StringReader(targetContent));
  req.setAttribute(WebKeys.SOURCE_NAME,title + StringPool.SPACE + sourceVersion);
  req.setAttribute(WebKeys.TARGET_NAME,title + StringPool.SPACE + targetVersion);
  req.setAttribute(WebKeys.DIFF_RESULTS,diffResults);
}
