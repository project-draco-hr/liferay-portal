{
  LiferayPortletRequest liferayPortletRequest=PortalUtil.getLiferayPortletRequest(portletRequest);
  LiferayPortletResponse liferayPortletResponse=PortalUtil.getLiferayPortletResponse(portletResponse);
  ThemeDisplay themeDisplay=(ThemeDisplay)liferayPortletRequest.getAttribute(WebKeys.THEME_DISPLAY);
  long nodeId=ParamUtil.getLong(liferayPortletRequest,"nodeId");
  String title=ParamUtil.getString(liferayPortletRequest,"title");
  double sourceVersion=ParamUtil.getDouble(liferayPortletRequest,"sourceVersion");
  double targetVersion=ParamUtil.getDouble(liferayPortletRequest,"targetVersion");
  WikiPage sourcePage=WikiPageServiceUtil.getPage(nodeId,title,sourceVersion);
  WikiPage targetPage=WikiPageServiceUtil.getPage(nodeId,title,targetVersion);
  PortletURL viewPageURL=liferayPortletResponse.createRenderURL();
  viewPageURL.setParameter("struts_action","/wiki/view");
  WikiNode sourceNode=sourcePage.getNode();
  viewPageURL.setParameter("nodeName",sourceNode.getName());
  PortletURL editPageURL=liferayPortletResponse.createRenderURL();
  editPageURL.setParameter("struts_action","/wiki/edit_page");
  editPageURL.setParameter("nodeId",String.valueOf(nodeId));
  editPageURL.setParameter("title",title);
  String attachmentURLPrefix=WikiUtil.getAttachmentURLPrefix(themeDisplay.getPathMain(),themeDisplay.getPlid(),nodeId,title);
  return WikiUtil.diffHtml(sourcePage,targetPage,viewPageURL,editPageURL,attachmentURLPrefix);
}
