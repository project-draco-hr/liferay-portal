{
  User user=userPersistence.findByPrimaryKey(userId);
  long groupId=serviceContext.getScopeGroupId();
  name=name.trim();
  Date now=new Date();
  if (hasVocabulary(groupId,name)) {
    throw new DuplicateVocabularyException("A vocabulary with the name " + name + " already exists");
  }
  long vocabularyId=counterLocalService.increment();
  TagsVocabulary vocabulary=tagsVocabularyPersistence.create(vocabularyId);
  vocabulary.setGroupId(groupId);
  vocabulary.setCompanyId(user.getCompanyId());
  vocabulary.setUserId(user.getUserId());
  vocabulary.setUserName(user.getFullName());
  vocabulary.setCreateDate(now);
  vocabulary.setModifiedDate(now);
  vocabulary.setName(name);
  vocabulary.setFolksonomy(folksonomy);
  tagsVocabularyPersistence.update(vocabulary,false);
  if ((serviceContext.getAddCommunityPermissions() != null) && (serviceContext.getAddGuestPermissions() != null)) {
    addVocabularyResources(vocabulary,serviceContext.getAddCommunityPermissions(),serviceContext.getAddGuestPermissions());
  }
 else {
    addVocabularyResources(vocabulary,serviceContext.getCommunityPermissions(),serviceContext.getGuestPermissions());
  }
  return vocabulary;
}
