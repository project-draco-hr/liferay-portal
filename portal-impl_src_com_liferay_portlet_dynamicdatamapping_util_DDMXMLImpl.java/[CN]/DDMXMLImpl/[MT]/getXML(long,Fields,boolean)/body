{
  Document document=null;
  Element rootElement=null;
  if (mergeFields && (ddmContentId > 0)) {
    DDMContent ddmContent=DDMContentLocalServiceUtil.getContent(ddmContentId);
    document=SAXReaderUtil.read(ddmContent.getXml());
    rootElement=document.getRootElement();
  }
 else {
    document=SAXReaderUtil.createDocument();
    rootElement=document.addElement("root");
  }
  Iterator<Field> itr=fields.iterator();
  while (itr.hasNext()) {
    Field field=itr.next();
    Object value=field.getValue();
    if (value instanceof Date) {
      Date valueDate=(Date)value;
      value=valueDate.getTime();
    }
    String valueString=String.valueOf(value);
    if (valueString != null) {
      valueString=valueString.trim();
    }
    Element dynamicElementElement=getElementByName(document,field.getName());
    if (dynamicElementElement == null) {
      appendField(rootElement,field.getName(),valueString);
    }
 else {
      updateField(dynamicElementElement,field.getName(),valueString);
    }
  }
  return document.formattedString();
}
