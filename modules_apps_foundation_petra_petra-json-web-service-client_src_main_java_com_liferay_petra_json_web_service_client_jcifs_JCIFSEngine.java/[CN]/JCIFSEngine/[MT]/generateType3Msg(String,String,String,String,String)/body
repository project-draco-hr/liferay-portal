{
  Type2Message type2Message=null;
  try {
    type2Message=new Type2Message(Base64.decode(challenge));
  }
 catch (  final IOException exception) {
    throw new NTLMEngineException("Invalid NTLM type 2 message",exception);
  }
  final int type2Flags=type2Message.getFlags();
  final int type3Flags=type2Flags & (0xffffffff ^ (NtlmFlags.NTLMSSP_TARGET_TYPE_DOMAIN | NtlmFlags.NTLMSSP_TARGET_TYPE_SERVER));
  if (domain == null) {
    domain=this._domain;
  }
  if (workstation == null) {
    workstation=this._workstation;
  }
  final Type3Message type3Message=new Type3Message(type2Message,password,domain,username,workstation,type3Flags);
  return Base64.encode(type3Message.toByteArray());
}
