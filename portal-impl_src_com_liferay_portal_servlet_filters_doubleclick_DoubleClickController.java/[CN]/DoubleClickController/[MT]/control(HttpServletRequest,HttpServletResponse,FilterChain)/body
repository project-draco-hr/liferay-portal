{
  boolean firstRequest=false;
  StringServletResponse stringResponse=null;
synchronized (this) {
    if (_stringResponse == null) {
      firstRequest=true;
      _stringResponse=new StringServletResponse(response);
      _throwable=null;
    }
    stringResponse=_stringResponse;
  }
  if (firstRequest) {
    try {
      filterChain.doFilter(request,_stringResponse);
    }
 catch (    Throwable t) {
      _throwable=t;
    }
 finally {
synchronized (this) {
        _stringResponse=null;
        notifyAll();
      }
    }
  }
 else {
synchronized (this) {
      while (_stringResponse != null) {
        try {
          wait();
        }
 catch (        InterruptedException ie) {
          Thread currentThread=Thread.currentThread();
          currentThread.interrupt();
        }
      }
    }
  }
  if (_throwable != null) {
    try {
      throw _throwable;
    }
 catch (    IOException ioe) {
      throw ioe;
    }
catch (    ServletException se) {
      throw se;
    }
catch (    RuntimeException re) {
      throw re;
    }
catch (    Error e) {
      throw e;
    }
catch (    Throwable t) {
      throw new RuntimeException(t);
    }
  }
  CacheResponseData cacheResponseData=new CacheResponseData(stringResponse);
  CacheResponseUtil.write(response,cacheResponseData);
}
