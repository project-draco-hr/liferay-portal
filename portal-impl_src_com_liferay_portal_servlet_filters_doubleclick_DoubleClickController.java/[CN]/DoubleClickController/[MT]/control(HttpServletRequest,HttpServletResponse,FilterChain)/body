{
  boolean firstRequest=false;
  CacheResponse cacheResponse=null;
synchronized (this) {
    if (_cacheResponse == null) {
      firstRequest=true;
      _cacheResponse=new CacheResponse(response,StringPool.UTF8);
      _throwable=null;
    }
    cacheResponse=_cacheResponse;
  }
  if (firstRequest) {
    try {
      filterChain.doFilter(request,_cacheResponse);
    }
 catch (    Throwable t) {
      _throwable=t;
    }
 finally {
synchronized (this) {
        _cacheResponse=null;
        notifyAll();
      }
    }
  }
 else {
synchronized (this) {
      while (_cacheResponse != null) {
        try {
          wait();
        }
 catch (        InterruptedException ie) {
          Thread currentThread=Thread.currentThread();
          currentThread.interrupt();
        }
      }
    }
  }
  if (_throwable != null) {
    try {
      throw _throwable;
    }
 catch (    IOException ioe) {
      throw ioe;
    }
catch (    ServletException se) {
      throw se;
    }
catch (    RuntimeException re) {
      throw re;
    }
catch (    Error e) {
      throw e;
    }
catch (    Throwable t) {
      throw new RuntimeException(t);
    }
  }
  CacheResponseData data=new CacheResponseData(cacheResponse.getData(),cacheResponse.getContentType(),cacheResponse.getHeaders());
  CacheResponseUtil.write(response,data);
}
