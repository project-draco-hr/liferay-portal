{
  AuthTokenUtil.check(request);
  HttpSession session=request.getSession();
  Ticket ticket=getValidTicket(request);
  long userId=0;
  if (ticket == null) {
    userId=PortalUtil.getUserId(request);
  }
 else {
    userId=ticket.getClassPK();
  }
  String password1=ParamUtil.getString(request,"password1");
  String password2=ParamUtil.getString(request,"password2");
  boolean passwordReset=false;
  UserLocalServiceUtil.updatePassword(userId,password1,password2,passwordReset);
  if (ticket != null) {
    TicketLocalServiceUtil.deleteTicket(ticket);
    User user=UserLocalServiceUtil.getUser(userId);
    Company company=CompanyLocalServiceUtil.getCompanyById(user.getCompanyId());
    String login=null;
    if (company.getAuthType().equals(CompanyConstants.AUTH_TYPE_ID)) {
      login=String.valueOf(user.getUserId());
    }
 else     if (company.getAuthType().equals(CompanyConstants.AUTH_TYPE_SN)) {
      login=user.getScreenName();
    }
 else {
      login=user.getEmailAddress();
    }
    LoginUtil.login(request,response,login,password1,false,null);
  }
 else {
    session.setAttribute(WebKeys.USER_PASSWORD,password1);
  }
}
