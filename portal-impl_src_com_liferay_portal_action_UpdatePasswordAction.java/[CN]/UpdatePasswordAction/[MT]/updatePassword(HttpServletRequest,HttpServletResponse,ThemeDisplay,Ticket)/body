{
  AuthTokenUtil.check(request);
  long userId=0;
  if (ticket != null) {
    userId=ticket.getClassPK();
  }
 else {
    userId=themeDisplay.getUserId();
  }
  String password1=ParamUtil.getString(request,"password1");
  String password2=ParamUtil.getString(request,"password2");
  boolean passwordReset=false;
  UserLocalServiceUtil.updatePassword(userId,password1,password2,passwordReset);
  if (ticket != null) {
    TicketLocalServiceUtil.deleteTicket(ticket);
    User user=UserLocalServiceUtil.getUser(userId);
    Company company=CompanyLocalServiceUtil.getCompanyById(user.getCompanyId());
    String login=null;
    String authType=company.getAuthType();
    if (authType.equals(CompanyConstants.AUTH_TYPE_EA)) {
      login=user.getEmailAddress();
    }
 else     if (authType.equals(CompanyConstants.AUTH_TYPE_SN)) {
      login=user.getScreenName();
    }
 else     if (authType.equals(CompanyConstants.AUTH_TYPE_ID)) {
      login=String.valueOf(userId);
    }
    LoginUtil.login(request,response,login,password1,false,null);
  }
 else {
    HttpSession session=request.getSession();
    session.setAttribute(WebKeys.USER_PASSWORD,password1);
  }
}
