{
  AuthTokenUtil.check(request);
  long userId=0;
  if (ticket != null) {
    userId=ticket.getClassPK();
  }
 else {
    userId=themeDisplay.getUserId();
  }
  HttpSession session=request.getSession();
  String password1=request.getParameter("password1");
  String password2=request.getParameter("password2");
  boolean passwordReset=false;
  boolean skipPasswordPolicyValidation=false;
  if (Validator.isNotNull(session.getAttribute(WebKeys.SETUP_WIZARD_PASSWORD_UPDATED))) {
    skipPasswordPolicyValidation=(Boolean)session.getAttribute(WebKeys.SETUP_WIZARD_PASSWORD_UPDATED);
  }
  UserLocalServiceUtil.updatePassword(userId,password1,password2,passwordReset,false,skipPasswordPolicyValidation);
  if (ticket != null) {
    TicketLocalServiceUtil.deleteTicket(ticket);
    User user=UserLocalServiceUtil.getUser(userId);
    Company company=CompanyLocalServiceUtil.getCompanyById(user.getCompanyId());
    String login=null;
    String authType=company.getAuthType();
    if (authType.equals(CompanyConstants.AUTH_TYPE_EA)) {
      login=user.getEmailAddress();
    }
 else     if (authType.equals(CompanyConstants.AUTH_TYPE_SN)) {
      login=user.getScreenName();
    }
 else     if (authType.equals(CompanyConstants.AUTH_TYPE_ID)) {
      login=String.valueOf(userId);
    }
    LoginUtil.login(request,response,login,password1,false,null);
  }
 else   if (PropsValues.SESSION_STORE_PASSWORD) {
    session.setAttribute(WebKeys.USER_PASSWORD,password1);
  }
}
