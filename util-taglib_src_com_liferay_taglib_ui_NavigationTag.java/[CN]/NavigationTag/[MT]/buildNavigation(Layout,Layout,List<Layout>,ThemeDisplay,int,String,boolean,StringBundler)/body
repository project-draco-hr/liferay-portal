{
  List<Layout> childLayouts=null;
  if (rootLayout != null) {
    childLayouts=rootLayout.getChildren(themeDisplay.getPermissionChecker());
  }
 else {
    childLayouts=LayoutLocalServiceUtil.getLayouts(selLayout.getGroupId(),selLayout.isPrivateLayout(),LayoutConstants.DEFAULT_PARENT_LAYOUT_ID);
  }
  if (childLayouts.isEmpty()) {
    return;
  }
  StringBundler tailSB=null;
  if (!nestedChildren) {
    tailSB=new StringBundler();
  }
  sb.append("<ul class=\"layouts level-");
  sb.append(layoutLevel);
  sb.append("\">");
  for (  Layout childLayout : childLayouts) {
    if (!childLayout.isHidden() && LayoutPermissionUtil.contains(themeDisplay.getPermissionChecker(),childLayout,ActionKeys.VIEW)) {
      boolean open=false;
      if (includedLayouts.equals("auto") && branchLayouts.contains(childLayout) && !childLayout.getChildren().isEmpty()) {
        open=true;
      }
      if (includedLayouts.equals("all")) {
        open=true;
      }
      String className=StringPool.BLANK;
      if (open) {
        className+="open ";
      }
      if (selLayout.getLayoutId() == childLayout.getLayoutId()) {
        className+="selected ";
      }
      sb.append("<li ");
      if (Validator.isNotNull(className)) {
        sb.append("class=\"");
        sb.append(className);
        sb.append("\" ");
      }
      sb.append("><a ");
      if (Validator.isNotNull(className)) {
        sb.append("class=\"");
        sb.append(className);
        sb.append("\" ");
      }
      sb.append("href=\"");
      sb.append(HtmlUtil.escapeHREF(PortalUtil.getLayoutURL(childLayout,themeDisplay)));
      sb.append("\" ");
      sb.append(PortalUtil.getLayoutTarget(childLayout));
      sb.append("> ");
      sb.append(HtmlUtil.escape(childLayout.getName(themeDisplay.getLocale())));
      sb.append("</a>");
      if (open) {
        StringBundler childLayoutSB=null;
        if (nestedChildren) {
          childLayoutSB=sb;
        }
 else {
          childLayoutSB=tailSB;
        }
        buildNavigation(childLayout,selLayout,branchLayouts,themeDisplay,layoutLevel + 1,includedLayouts,nestedChildren,childLayoutSB);
      }
      sb.append("</li>");
    }
  }
  sb.append("</ul>");
  if (!nestedChildren) {
    sb.append(tailSB);
  }
}
