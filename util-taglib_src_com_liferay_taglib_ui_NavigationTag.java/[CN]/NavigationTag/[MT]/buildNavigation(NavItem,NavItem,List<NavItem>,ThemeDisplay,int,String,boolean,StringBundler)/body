{
  List<NavItem> childNavItems=new ArrayList<>();
  if (rootNavItem != null) {
    childNavItems=rootNavItem.getChildren();
  }
 else {
    childNavItems=NavItem.fromLayouts(request,themeDisplay.getLayouts(),null);
  }
  if (childNavItems.isEmpty()) {
    return;
  }
  StringBundler tailSB=null;
  if (!nestedChildren) {
    tailSB=new StringBundler();
  }
  sb.append("<ul class=\"layouts level-");
  sb.append(layoutLevel);
  sb.append("\">");
  for (  NavItem childNavItem : childNavItems) {
    boolean open=false;
    if (includedLayouts.equals("auto") && branchNavItems.contains(childNavItem) && !childNavItem.getChildren().isEmpty()) {
      open=true;
    }
    if (includedLayouts.equals("all")) {
      open=true;
    }
    String className=StringPool.BLANK;
    if (open) {
      className+="open ";
    }
    if (selNavItem.equals(childNavItem)) {
      className+="selected ";
    }
    sb.append("<li ");
    if (Validator.isNotNull(className)) {
      sb.append("class=\"");
      sb.append(className);
      sb.append("\" ");
    }
    sb.append("><a ");
    if (Validator.isNotNull(className)) {
      sb.append("class=\"");
      sb.append(className);
      sb.append("\" ");
    }
    sb.append("href=\"");
    sb.append(HtmlUtil.escapeHREF(childNavItem.getRegularURL()));
    sb.append("\" ");
    sb.append(childNavItem.getTarget());
    sb.append("> ");
    sb.append(HtmlUtil.escape(childNavItem.getName()));
    sb.append("</a>");
    if (open) {
      StringBundler childLayoutSB=null;
      if (nestedChildren) {
        childLayoutSB=sb;
      }
 else {
        childLayoutSB=tailSB;
      }
      buildNavigation(childNavItem,selNavItem,branchNavItems,themeDisplay,layoutLevel + 1,includedLayouts,nestedChildren,childLayoutSB);
    }
    sb.append("</li>");
  }
  sb.append("</ul>");
  if (!nestedChildren) {
    sb.append(tailSB);
  }
}
