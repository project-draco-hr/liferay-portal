{
  Portlet portlet=(Portlet)request.getAttribute(WebKeys.SPI_AGENT_PORTLET);
  String portletSessionAttributesKey=WebKeys.PORTLET_SESSION_ATTRIBUTES.concat(portlet.getContextName());
  Map<String,Serializable> sessionAttributes=new HashMap<String,Serializable>();
  HttpSession session=request.getSession();
  Enumeration<String> enumeration=session.getAttributeNames();
  while (enumeration.hasMoreElements()) {
    String name=enumeration.nextElement();
    if (name.startsWith(WebKeys.PORTLET_SESSION_ATTRIBUTES) && !name.equals(portletSessionAttributesKey)) {
      continue;
    }
    Object value=session.getAttribute(name);
    if (value instanceof Serializable) {
      sessionAttributes.put(name,(Serializable)value);
    }
 else     if (_log.isWarnEnabled()) {
      _log.warn("Nonserializable session attribute name " + name + " with value "+ value);
    }
  }
  HttpSession portletSession=(HttpSession)request.getAttribute(WebKeys.PORTLET_SESSION);
  if (portletSession != null) {
    request.removeAttribute(WebKeys.PORTLET_SESSION);
    HashMap<String,Serializable> portletSessionAttributes=new HashMap<String,Serializable>();
    enumeration=portletSession.getAttributeNames();
    while (enumeration.hasMoreElements()) {
      String name=enumeration.nextElement();
      Object value=portletSession.getAttribute(name);
      if (value instanceof Serializable) {
        portletSessionAttributes.put(name,(Serializable)value);
      }
 else       if (_log.isWarnEnabled()) {
        _log.warn("Nonserializable session attribute name " + name + " with value "+ value);
      }
    }
    sessionAttributes.put(portletSessionAttributesKey,portletSessionAttributes);
  }
  return sessionAttributes;
}
