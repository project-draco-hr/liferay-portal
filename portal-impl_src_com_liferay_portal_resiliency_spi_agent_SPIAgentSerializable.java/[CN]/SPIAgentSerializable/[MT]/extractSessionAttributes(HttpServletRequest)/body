{
  HttpSession session=request.getSession();
  Portlet portlet=(Portlet)request.getAttribute(WebKeys.SPI_AGENT_PORTLET);
  String namespace=LiferayPortletSession.PORTLET_SCOPE_NAMESPACE.concat(portlet.getPortletId()).concat(LiferayPortletSession.LAYOUT_SEPARATOR);
  Map<String,Serializable> sessionAttributes=new HashMap<String,Serializable>();
  Enumeration<String> enumeration=session.getAttributeNames();
  while (enumeration.hasMoreElements()) {
    String name=enumeration.nextElement();
    if (name.startsWith(LiferayPortletSession.PORTLET_SCOPE_NAMESPACE) && !name.startsWith(namespace)) {
      continue;
    }
    Object value=session.getAttribute(name);
    if (value instanceof Serializable) {
      sessionAttributes.put(name,(Serializable)value);
    }
 else     if (_log.isWarnEnabled()) {
      _log.warn("Nonserializable session attribute name " + name + " with value "+ value);
    }
  }
  return sessionAttributes;
}
