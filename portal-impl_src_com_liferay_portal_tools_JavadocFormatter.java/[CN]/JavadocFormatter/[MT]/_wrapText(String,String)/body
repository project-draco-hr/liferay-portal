{
  int indentLength=_getIndentLength(indent);
  if (text.contains("<pre>")) {
    Pattern pattern=Pattern.compile("(?<=^|</pre>).+?(?=$|<pre>)",Pattern.DOTALL);
    Matcher matcher=pattern.matcher(text);
    StringBuffer sb=new StringBuffer();
    while (matcher.find()) {
      String wrapped=_formatInlines(matcher.group());
      wrapped=StringUtil.wrap(wrapped,80 - indentLength,"\n");
      matcher.appendReplacement(sb,wrapped);
    }
    matcher.appendTail(sb);
    sb.append("\n");
    text=sb.toString();
  }
 else {
    text=_formatInlines(text);
    text=StringUtil.wrap(text,80 - indentLength,"\n");
  }
  text=text.replaceAll("(?m)^",indent);
  text=text.replaceAll("(?m) +$",StringPool.BLANK);
  return text;
}
