{
  if ((_store == null) || !_store.isConnected()) {
    Session session=MailEngine.getSession();
    String storeProtocol=GetterUtil.getString(session.getProperty("mail.store.protocol"));
    if (!storeProtocol.equals(Account.PROTOCOL_POPS)) {
      storeProtocol=Account.PROTOCOL_POP;
    }
    _store=session.getStore(storeProtocol);
    String prefix="mail." + storeProtocol + ".";
    String host=session.getProperty(prefix + "host");
    String user=session.getProperty(prefix + "user");
    if (Validator.isNull(user)) {
      user=session.getProperty("mail.smtp.user");
    }
    String password=session.getProperty(prefix + "password");
    if (Validator.isNull(password)) {
      password=session.getProperty("mail.smtp.password");
    }
    _store.connect(host,user,password);
  }
}
