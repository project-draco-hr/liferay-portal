{
  Group group=_groupLocalService.getGroup(groupId);
  User user=_userLocalService.fetchUserByEmailAddress(group.getCompanyId(),emailAddress);
  if (user != null) {
    return user;
  }
  String emailAccountName=emailAddress.substring(0,emailAddress.indexOf(StringPool.AT));
  String[] fullNameArray=StringUtil.split(emailAccountName,StringPool.PERIOD);
  String firstName=StringUtil.randomString();
  String lastName=StringUtil.randomString();
  if (fullNameArray.length > 0) {
    firstName=StringUtil.upperCaseFirstLetter(fullNameArray[0]);
  }
  if (fullNameArray.length > 1) {
    lastName=StringUtil.upperCaseFirstLetter(fullNameArray[1]);
  }
  boolean autoPassword=true;
  String password1="test";
  String password2="test";
  long facebookId=0;
  String openId=StringPool.BLANK;
  Locale locale=LocaleUtil.SPAIN;
  String middleName=StringPool.BLANK;
  long prefixId=0;
  long suffixId=0;
  boolean male=true;
  int birthdayMonth=Calendar.OCTOBER;
  int birthdayDay=18;
  int birthdayYear=1985;
  String jobTitle="Test Engineer";
  long[] organizationIds=null;
  long[] roleIds=null;
  long[] userGroupIds=null;
  boolean sendMail=false;
  user=_userLocalService.addUser(UserConstants.USER_ID_DEFAULT,group.getCompanyId(),autoPassword,password1,password2,true,StringPool.BLANK,emailAddress,facebookId,openId,locale,firstName,middleName,lastName,prefixId,suffixId,male,birthdayMonth,birthdayDay,birthdayYear,jobTitle,new long[]{groupId},organizationIds,roleIds,userGroupIds,sendMail,new ServiceContext());
  Role role=_roleLocalService.getRole(group.getCompanyId(),RoleConstants.SITE_ADMINISTRATOR);
  _userLocalService.addRoleUser(role.getRoleId(),user);
  user=_userLocalService.getUser(user.getUserId());
  _users.add(user);
  return user;
}
