{
  Map<String,Object> variables=new HashMap<String,Object>();
  variables.put("counter",new SimpleCounter());
  Thread currentThread=Thread.currentThread();
  ClassLoader classLoader=currentThread.getContextClassLoader();
  try {
    currentThread.setContextClassLoader(PortalClassLoaderUtil.getClassLoader());
    template=VelocityUtil.evaluate(template,variables);
  }
  finally {
    currentThread.setContextClassLoader(classLoader);
  }
  UnsyncBufferedReader unsyncBufferedReader=new UnsyncBufferedReader(new UnsyncStringReader(template));
  StringBundler sb=new StringBundler();
  String line=null;
  while ((line=unsyncBufferedReader.readLine()) != null) {
    line=line.trim();
    sb.append(line);
    sb.append("\n");
  }
  unsyncBufferedReader.close();
  template=sb.toString();
  template=StringUtil.replace(template,"\n\n\n","\n\n");
  return template;
}
