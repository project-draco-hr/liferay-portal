{
  StringBundler sb=new StringBundler(17);
  if (themeDisplay != null) {
    if (absoluteURL) {
      sb.append(themeDisplay.getPortalURL());
    }
  }
  sb.append(PortalUtil.getPathContext());
  sb.append("/documents/");
  sb.append(fileEntry.getRepositoryId());
  sb.append(StringPool.SLASH);
  sb.append(fileEntry.getFolderId());
  sb.append(StringPool.SLASH);
  String filename=fileEntry.getFilename();
  if (fileEntry.isInTrash()) {
    filename=TrashUtil.getOriginalTitle(fileEntry.getFilename());
  }
  sb.append(HttpUtil.encodeURL(HtmlUtil.unescape(filename)));
  sb.append(StringPool.SLASH);
  sb.append(HttpUtil.encodeURL(fileEntry.getUuid()));
  if (appendVersion) {
    sb.append("?version=");
    sb.append(fileVersion.getVersion());
  }
  if (ImageProcessorUtil.isImageSupported(fileVersion)) {
    if (appendVersion) {
      sb.append("&t=");
    }
 else {
      sb.append("?t=");
    }
    Date modifiedDate=fileVersion.getModifiedDate();
    sb.append(modifiedDate.getTime());
  }
  sb.append(queryString);
  if (themeDisplay != null) {
    PortletDisplay portletDisplay=themeDisplay.getPortletDisplay();
    if (portletDisplay != null) {
      String portletId=portletDisplay.getId();
      if (portletId.equals(PortletKeys.TRASH)) {
        sb.append("&status=");
        sb.append(WorkflowConstants.STATUS_IN_TRASH);
      }
    }
  }
  String previewURL=sb.toString();
  if ((themeDisplay != null) && themeDisplay.isAddSessionIdToURL()) {
    return PortalUtil.getURLWithSessionId(previewURL,themeDisplay.getSessionId());
  }
  return previewURL;
}
