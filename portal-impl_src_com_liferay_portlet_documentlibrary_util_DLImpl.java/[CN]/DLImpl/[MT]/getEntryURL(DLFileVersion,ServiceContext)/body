{
  if (Validator.equals(serviceContext.getCommand(),Constants.ADD_WEBDAV) || Validator.equals(serviceContext.getCommand(),Constants.UPDATE_WEBDAV)) {
    return serviceContext.getPortalURL() + serviceContext.getCurrentURL();
  }
  String entryURL=GetterUtil.getString(serviceContext.getAttribute("entryURL"));
  if (Validator.isNotNull(entryURL)) {
    return entryURL;
  }
  HttpServletRequest request=serviceContext.getRequest();
  ThemeDisplay themeDisplay=serviceContext.getThemeDisplay();
  if ((request == null) || (themeDisplay == null)) {
    return StringPool.BLANK;
  }
  PortletURL portletURL=null;
  long plid=serviceContext.getPlid();
  long controlPanelPlid=PortalUtil.getControlPanelPlid(serviceContext.getCompanyId());
  String portletId=PortletProviderUtil.getPortletId(FileEntry.class.getName(),PortletProvider.Action.VIEW);
  for (  PortletLayoutFinder portletLayoutFinder : _serviceTrackerList) {
    try {
      PortletLayoutFinder.Result result=portletLayoutFinder.find(themeDisplay,themeDisplay.getSiteGroupId());
      portletId=result.getPortletId();
      plid=result.getPlid();
    }
 catch (    PortalException pe) {
    }
  }
  if ((plid == controlPanelPlid) || (plid == LayoutConstants.DEFAULT_PLID)) {
    portletURL=PortalUtil.getControlPanelPortletURL(request,portletId,PortletRequest.RENDER_PHASE);
  }
 else {
    portletURL=PortletURLFactoryUtil.create(request,portletId,plid,PortletRequest.RENDER_PHASE);
  }
  portletURL.setParameter("mvcRenderCommandName","/document_library/view_file_entry");
  portletURL.setParameter("fileEntryId",String.valueOf(dlFileVersion.getFileEntryId()));
  return portletURL.toString();
}
