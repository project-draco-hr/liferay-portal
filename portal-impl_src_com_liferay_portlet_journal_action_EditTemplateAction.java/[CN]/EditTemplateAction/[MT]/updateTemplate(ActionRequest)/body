{
  UploadPortletRequest uploadReq=PortalUtil.getUploadPortletRequest(req);
  String cmd=ParamUtil.getString(uploadReq,Constants.CMD);
  Layout layout=(Layout)uploadReq.getAttribute(WebKeys.LAYOUT);
  long groupId=ParamUtil.getLong(uploadReq,"groupId");
  String templateId=ParamUtil.getString(uploadReq,"templateId");
  boolean autoTemplateId=ParamUtil.getBoolean(uploadReq,"autoTemplateId");
  String structureId=ParamUtil.getString(uploadReq,"structureId");
  String name=ParamUtil.getString(uploadReq,"name");
  String description=ParamUtil.getString(uploadReq,"description");
  String xsl=ParamUtil.getString(uploadReq,"xsl");
  String xslContent=JS.decodeURIComponent(ParamUtil.getString(uploadReq,"xslContent"));
  boolean formatXsl=ParamUtil.getBoolean(uploadReq,"formatXsl");
  if (Validator.isNull(xsl)) {
    xsl=xslContent;
  }
  String langType=ParamUtil.getString(uploadReq,"langType",JournalTemplateImpl.LANG_TYPE_XSL);
  boolean smallImage=ParamUtil.getBoolean(uploadReq,"smallImage");
  String smallImageURL=ParamUtil.getString(uploadReq,"smallImageURL");
  File smallFile=uploadReq.getFile("smallFile");
  String[] communityPermissions=uploadReq.getParameterValues("communityPermissions");
  String[] guestPermissions=uploadReq.getParameterValues("guestPermissions");
  JournalTemplate template=null;
  if (cmd.equals(Constants.ADD)) {
    template=JournalTemplateServiceUtil.addTemplate(templateId,autoTemplateId,layout.getPlid(),structureId,name,description,xsl,formatXsl,langType,smallImage,smallImageURL,smallFile,communityPermissions,guestPermissions);
  }
 else {
    template=JournalTemplateServiceUtil.updateTemplate(groupId,templateId,structureId,name,description,xsl,formatXsl,langType,smallImage,smallImageURL,smallFile);
  }
  JournalUtil.addRecentTemplate(req,template);
}
