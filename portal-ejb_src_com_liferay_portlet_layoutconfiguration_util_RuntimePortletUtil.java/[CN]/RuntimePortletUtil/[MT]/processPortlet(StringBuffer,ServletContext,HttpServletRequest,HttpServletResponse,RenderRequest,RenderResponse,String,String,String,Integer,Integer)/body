{
  ThemeDisplay themeDisplay=(ThemeDisplay)req.getAttribute(WebKeys.THEME_DISPLAY);
  Portlet portlet=PortletServiceUtil.getPortletById(themeDisplay.getCompanyId(),portletId);
  if ((portlet != null) && portlet.isInstanceable()) {
    if (Validator.isNotNull(instanceId) && Validator.isPassword(instanceId) && (instanceId.length() == 4)) {
      portletId+=Portlet.INSTANCE_SEPARATOR + instanceId;
      portlet=PortletServiceUtil.getPortletById(themeDisplay.getCompanyId(),portletId);
    }
 else {
      _log.debug("Portlet " + portlet.getPortletId() + " is instanceable but does not have a "+ "valid instance id");
      portlet=null;
    }
  }
  if (portlet == null) {
    return;
  }
  PortletDisplay portletDisplay=themeDisplay.getPortletDisplay();
  PortletDisplay portletDisplayClone=(PortletDisplay)portletDisplay.clone();
  PortletConfig portletConfig=(PortletConfig)req.getAttribute(WebKeys.JAVAX_PORTLET_CONFIG);
  try {
    PortalUtil.renderPortlet(sb,ctx,req,res,portlet,columnId,columnPos,columnCount);
  }
  finally {
    portletDisplay.copyFrom(portletDisplayClone);
    try {
      PortletDisplayFactory.recycle(portletDisplayClone);
    }
 catch (    Exception e) {
      _log.error(e);
    }
    _defineObjects(req,portletConfig,renderRequest,renderResponse);
  }
}
