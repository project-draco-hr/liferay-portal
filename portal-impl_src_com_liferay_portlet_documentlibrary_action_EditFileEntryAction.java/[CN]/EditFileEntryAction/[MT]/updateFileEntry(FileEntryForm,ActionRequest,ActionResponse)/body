{
  UploadPortletRequest uploadReq=UploadRequestUtil.getUploadPortletRequest(req);
  String cmd=ParamUtil.getString(uploadReq,Constants.CMD);
  ThemeDisplay themeDisplay=(ThemeDisplay)req.getAttribute(WebKeys.THEME_DISPLAY);
  long folderId=ParamUtil.getLong(uploadReq,"folderId");
  long newFolderId=ParamUtil.getLong(uploadReq,"newFolderId");
  String name=ParamUtil.getString(uploadReq,"name");
  String sourceFileName=uploadReq.getFileName("file");
  String title=ParamUtil.getString(uploadReq,"title");
  String description=ParamUtil.getString(uploadReq,"description");
  String[] tagsEntries=StringUtil.split(ParamUtil.getString(uploadReq,"tagsEntries"));
  String extraSettings=PropertiesUtil.toString(fileEntryForm.getExtraSettingsProperties());
  File file=uploadReq.getFile("file");
  String[] communityPermissions=req.getParameterValues("communityPermissions");
  String[] guestPermissions=req.getParameterValues("guestPermissions");
  if (cmd.equals(Constants.ADD)) {
    DLFolderPermission.check(themeDisplay.getPermissionChecker(),folderId,ActionKeys.ADD_DOCUMENT);
    DLFileEntry entry=DLFileEntryLocalServiceUtil.addFileEntry(themeDisplay.getUserId(),folderId,sourceFileName,title,description,tagsEntries,extraSettings,file,communityPermissions,guestPermissions);
    AssetPublisherUtil.addAndStoreSelection(req,DLFileEntry.class.getName(),entry.getFileEntryId(),-1);
  }
 else {
    DLFileEntryPermission.check(themeDisplay.getPermissionChecker(),folderId,name,ActionKeys.UPDATE);
    DLFileEntryLocalServiceUtil.updateFileEntry(themeDisplay.getUserId(),folderId,newFolderId,name,sourceFileName,title,description,tagsEntries,extraSettings,file);
  }
  AssetPublisherUtil.addRecentFolderId(req,DLFileEntry.class.getName(),folderId);
}
