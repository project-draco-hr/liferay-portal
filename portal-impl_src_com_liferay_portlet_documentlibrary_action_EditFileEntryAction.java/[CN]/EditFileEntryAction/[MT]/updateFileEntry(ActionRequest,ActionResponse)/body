{
  UploadPortletRequest uploadRequest=PortalUtil.getUploadPortletRequest(actionRequest);
  String cmd=ParamUtil.getString(uploadRequest,Constants.CMD);
  ThemeDisplay themeDisplay=(ThemeDisplay)actionRequest.getAttribute(WebKeys.THEME_DISPLAY);
  long fileEntryId=ParamUtil.getLong(uploadRequest,"fileEntryId");
  long folderId=ParamUtil.getLong(uploadRequest,"folderId");
  String sourceFileName=uploadRequest.getFileName("file");
  String title=ParamUtil.getString(uploadRequest,"title");
  String description=ParamUtil.getString(uploadRequest,"description");
  String changeLog=ParamUtil.getString(uploadRequest,"changeLog");
  boolean majorVersion=ParamUtil.getBoolean(uploadRequest,"majorVersion");
  UnicodeProperties extraSettingsProperties=PropertiesParamUtil.getProperties(actionRequest,"extraSettingsProperties--");
  String extraSettings=extraSettingsProperties.toString();
  File file=uploadRequest.getFile("file");
  if (Validator.isNotNull(sourceFileName) && !file.exists()) {
    file.createNewFile();
  }
  ServiceContext serviceContext=ServiceContextFactory.getInstance(DLFileEntry.class.getName(),actionRequest);
  if (cmd.equals(Constants.ADD)) {
    String extension=FileUtil.getExtension(sourceFileName);
    if (Validator.isNotNull(title)) {
      if (!title.endsWith(StringPool.PERIOD + extension)) {
        title+=StringPool.PERIOD + extension;
      }
    }
 else {
      title=sourceFileName;
    }
    serviceContext.setAttribute("extension",extension);
    DLFileEntry fileEntry=DLAppServiceUtil.addFileEntry(themeDisplay.getScopeGroupId(),folderId,title,description,changeLog,extraSettings,file,serviceContext);
    AssetPublisherUtil.addAndStoreSelection(actionRequest,DLFileEntry.class.getName(),fileEntry.getFileEntryId(),-1);
  }
 else {
    if (Validator.isNull(sourceFileName)) {
      sourceFileName=title;
    }
    String extension=FileUtil.getExtension(sourceFileName);
    serviceContext.setAttribute("extension",extension);
    DLAppServiceUtil.updateFileEntry(fileEntryId,sourceFileName,title,description,changeLog,majorVersion,extraSettings,file,serviceContext);
  }
  AssetPublisherUtil.addRecentFolderId(actionRequest,DLFileEntry.class.getName(),folderId);
}
