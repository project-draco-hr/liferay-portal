{
  UploadPortletRequest uploadPortletRequest=PortalUtil.getUploadPortletRequest(actionRequest);
  ThemeDisplay themeDisplay=(ThemeDisplay)actionRequest.getAttribute(WebKeys.THEME_DISPLAY);
  String cmd=ParamUtil.getString(uploadPortletRequest,Constants.CMD);
  long fileEntryId=ParamUtil.getLong(uploadPortletRequest,"fileEntryId");
  long repositoryId=ParamUtil.getLong(uploadPortletRequest,"repositoryId");
  long folderId=ParamUtil.getLong(uploadPortletRequest,"folderId");
  String sourceFileName=uploadPortletRequest.getFileName("file");
  String title=ParamUtil.getString(uploadPortletRequest,"title");
  String description=ParamUtil.getString(uploadPortletRequest,"description");
  String changeLog=ParamUtil.getString(uploadPortletRequest,"changeLog");
  boolean majorVersion=ParamUtil.getBoolean(uploadPortletRequest,"majorVersion");
  if (folderId > 0) {
    Folder folder=DLAppServiceUtil.getFolder(folderId);
    if (folder.getGroupId() != themeDisplay.getScopeGroupId()) {
      throw new NoSuchFolderException();
    }
  }
  InputStream inputStream=null;
  try {
    String contentType=uploadPortletRequest.getContentType("file");
    long size=uploadPortletRequest.getSize("file");
    if ((cmd.equals(Constants.ADD) || cmd.equals(Constants.ADD_DYNAMIC)) && (size == 0)) {
      contentType=MimeTypesUtil.getContentType(title);
    }
    if (cmd.equals(Constants.ADD) || cmd.equals(Constants.ADD_DYNAMIC) || (size > 0)) {
      String portletName=portletConfig.getPortletName();
      if (portletName.equals(PortletKeys.MEDIA_GALLERY_DISPLAY)) {
        String portletResource=ParamUtil.getString(actionRequest,"portletResource");
        PortletPreferences portletPreferences=null;
        if (Validator.isNotNull(portletResource)) {
          portletPreferences=PortletPreferencesFactoryUtil.getPortletSetup(actionRequest,portletResource);
        }
 else {
          portletPreferences=actionRequest.getPreferences();
        }
        String[] mimeTypes=DLUtil.getMediaGalleryMimeTypes(portletPreferences,actionRequest);
        if (Arrays.binarySearch(mimeTypes,contentType) < 0) {
          throw new FileMimeTypeException(contentType);
        }
      }
    }
    inputStream=uploadPortletRequest.getFileAsStream("file");
    ServiceContext serviceContext=ServiceContextFactory.getInstance(DLFileEntry.class.getName(),uploadPortletRequest);
    serviceContext.setAttribute("defaultLanguageId",themeDisplay.getLanguageId());
    FileEntry fileEntry=null;
    if (cmd.equals(Constants.ADD) || cmd.equals(Constants.ADD_DYNAMIC)) {
      fileEntry=DLAppServiceUtil.addFileEntry(repositoryId,folderId,sourceFileName,contentType,title,description,changeLog,inputStream,size,serviceContext);
      AssetPublisherUtil.addAndStoreSelection(actionRequest,DLFileEntry.class.getName(),fileEntry.getFileEntryId(),-1);
      if (cmd.equals(Constants.ADD_DYNAMIC)) {
        JSONObject jsonObject=JSONFactoryUtil.createJSONObject();
        jsonObject.put("fileEntryId",fileEntry.getFileEntryId());
        writeJSON(actionRequest,actionResponse,jsonObject);
      }
    }
 else     if (cmd.equals(Constants.UPDATE_AND_CHECKIN)) {
      fileEntry=DLAppServiceUtil.updateFileEntryAndCheckIn(fileEntryId,sourceFileName,contentType,title,description,changeLog,majorVersion,inputStream,size,serviceContext);
    }
 else {
      fileEntry=DLAppServiceUtil.updateFileEntry(fileEntryId,sourceFileName,contentType,title,description,changeLog,majorVersion,inputStream,size,serviceContext);
    }
    AssetPublisherUtil.addRecentFolderId(actionRequest,DLFileEntry.class.getName(),folderId);
    return fileEntry;
  }
 catch (  Exception e) {
    UploadException uploadException=(UploadException)actionRequest.getAttribute(WebKeys.UPLOAD_EXCEPTION);
    if ((uploadException != null) && uploadException.isExceededSizeLimit()) {
      throw new FileSizeException(uploadException.getCause());
    }
    throw e;
  }
 finally {
    StreamUtil.cleanUp(inputStream);
  }
}
