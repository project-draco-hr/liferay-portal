{
  User user=userPersistence.findByPrimaryKey(userId);
  parentFolderId=getParentFolderId(groupId,parentFolderId);
  Date now=new Date();
  validateFolder(groupId,parentFolderId,name);
  long folderId=counterLocalService.increment();
  DLFolder folder=dlFolderPersistence.create(folderId);
  folder.setUuid(serviceContext.getUuid());
  folder.setGroupId(groupId);
  folder.setCompanyId(user.getCompanyId());
  folder.setUserId(user.getUserId());
  folder.setCreateDate(serviceContext.getCreateDate(now));
  folder.setModifiedDate(serviceContext.getModifiedDate(now));
  folder.setParentFolderId(parentFolderId);
  folder.setName(name);
  folder.setDescription(description);
  folder.setExpandoBridgeAttributes(serviceContext);
  dlFolderPersistence.update(folder,false);
  if (serviceContext.getAddCommunityPermissions() || serviceContext.getAddGuestPermissions()) {
    addFolderResources(folder,serviceContext.getAddCommunityPermissions(),serviceContext.getAddGuestPermissions());
  }
 else {
    addFolderResources(folder,serviceContext.getCommunityPermissions(),serviceContext.getGuestPermissions());
  }
  if (parentFolderId != DLFolderConstants.DEFAULT_PARENT_FOLDER_ID) {
    DLFolder parentFolder=dlFolderPersistence.findByPrimaryKey(parentFolderId);
    parentFolder.setLastPostDate(now);
    dlFolderPersistence.update(parentFolder,false);
  }
  dlAppHelperLocalService.addFolder(new LiferayFolder(folder),serviceContext);
  return folder;
}
