{
  DLFileEntry fileEntry=dlFileEntryPersistence.findByG_F_N(groupId,folderId,name);
  if (Validator.isNotNull(version)) {
    try {
      dlLocalService.deleteFile(fileEntry.getCompanyId(),PortletKeys.DOCUMENT_LIBRARY,fileEntry.getRepositoryId(),fileEntry.getName(),version);
    }
 catch (    Exception e) {
      if (_log.isWarnEnabled()) {
        _log.warn(e,e);
      }
    }
    long fileVersionsCount=dlFileVersionPersistence.countByG_F_N(groupId,folderId,name);
    dlFileVersionPersistence.removeByG_F_N_V(groupId,folderId,name,version);
    if (fileVersionsCount == 1) {
      dlFileEntryPersistence.remove(fileEntry);
    }
 else {
      if (version.equals(fileEntry.getVersion())) {
        try {
          DLFileVersion fileVersion=getLatestFileVersion(groupId,folderId,name);
          fileEntry.setVersion(fileVersion.getVersion());
          fileEntry.setSize(fileVersion.getSize());
        }
 catch (        NoSuchFileVersionException nsfve) {
        }
      }
      dlFileEntryPersistence.update(fileEntry,false);
    }
  }
 else {
    deleteFileEntry(fileEntry);
  }
}
