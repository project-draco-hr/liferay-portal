{
  StagedModelDataHandlerUtil.exportStagedModel(portletDataContext,layout);
  if (layout.isSupportsEmbeddedPortlets()) {
    if (layout.isTypePortlet()) {
      for (      Portlet portlet : portlets) {
        if (portlet.isScopeable() && layout.hasScopeGroup()) {
          String key=PortletPermissionUtil.getPrimaryKey(layout.getPlid(),portlet.getPortletId());
          portletIds.put(key,new Object[]{portlet.getPortletId(),layout.getPlid(),layout.getScopeGroup().getGroupId(),StringPool.BLANK,layout.getUuid()});
        }
      }
    }
    LayoutTypePortlet layoutTypePortlet=(LayoutTypePortlet)layout.getLayoutType();
    for (    Portlet portlet : layoutTypePortlet.getAllPortlets()) {
      String portletId=portlet.getPortletId();
      javax.portlet.PortletPreferences jxPreferences=PortletPreferencesFactoryUtil.getLayoutPortletSetup(layout,portletId);
      String scopeType=GetterUtil.getString(jxPreferences.getValue("lfrScopeType",null));
      String scopeLayoutUuid=GetterUtil.getString(jxPreferences.getValue("lfrScopeLayoutUuid",null));
      long scopeGroupId=portletDataContext.getScopeGroupId();
      if (Validator.isNotNull(scopeType)) {
        Group scopeGroup=null;
        if (scopeType.equals("company")) {
          scopeGroup=GroupLocalServiceUtil.getCompanyGroup(layout.getCompanyId());
        }
 else         if (scopeType.equals("layout")) {
          Layout scopeLayout=null;
          scopeLayout=LayoutLocalServiceUtil.fetchLayoutByUuidAndGroupId(scopeLayoutUuid,portletDataContext.getGroupId(),portletDataContext.isPrivateLayout());
          if (scopeLayout == null) {
            continue;
          }
          scopeGroup=scopeLayout.getScopeGroup();
        }
 else {
          throw new IllegalArgumentException("Scope type " + scopeType + " is invalid");
        }
        if (scopeGroup != null) {
          scopeGroupId=scopeGroup.getGroupId();
        }
      }
      String key=PortletPermissionUtil.getPrimaryKey(layout.getPlid(),portletId);
      portletIds.put(key,new Object[]{portletId,layout.getPlid(),scopeGroupId,scopeType,scopeLayoutUuid});
    }
  }
}
