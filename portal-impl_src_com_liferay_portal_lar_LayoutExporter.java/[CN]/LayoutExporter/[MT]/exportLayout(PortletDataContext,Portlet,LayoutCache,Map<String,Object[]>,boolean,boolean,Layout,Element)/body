{
  String path=context.getLayoutPath(layout.getLayoutId()) + "/layout.xml";
  if (!context.isPathNotProcessed(path)) {
    return;
  }
  Element layoutElement=layoutsElement.addElement("layout");
  layoutElement.addAttribute("layout-id",String.valueOf(layout.getLayoutId()));
  boolean deleteLayout=MapUtil.getBoolean(context.getParameterMap(),"delete_" + layout.getPlid());
  if (deleteLayout) {
    layoutElement.addAttribute("delete",String.valueOf(true));
    return;
  }
  context.setPlid(layout.getPlid());
  if (layout.isIconImage()) {
    Image image=ImageLocalServiceUtil.getImage(layout.getIconImageId());
    if (image != null) {
      String iconPath=getLayoutIconPath(context,layout,image);
      layoutElement.addElement("icon-image-path").addText(iconPath);
      context.addZipEntry(iconPath,image.getTextObj());
    }
  }
  _portletExporter.exportPortletData(context,layoutConfigurationPortlet,layout,null,layoutElement);
  if (exportPermissions) {
    _permissionExporter.exportLayoutPermissions(context,layoutCache,context.getCompanyId(),context.getScopeGroupId(),layout,layoutElement,exportUserPermissions);
  }
  if (layout.isTypePortlet()) {
    LayoutTypePortlet layoutTypePortlet=(LayoutTypePortlet)layout.getLayoutType();
    for (    String portletId : layoutTypePortlet.getPortletIds()) {
      javax.portlet.PortletPreferences jxPreferences=PortletPreferencesFactoryUtil.getLayoutPortletSetup(layout,portletId);
      String scopeLayoutUuid=GetterUtil.getString(jxPreferences.getValue("lfr-scope-layout-uuid",null));
      long scopeGroupId=context.getScopeGroupId();
      if (Validator.isNotNull(scopeLayoutUuid)) {
        Layout scopeLayout=LayoutLocalServiceUtil.getLayoutByUuidAndGroupId(scopeLayoutUuid,scopeGroupId);
        Group scopeGroup=scopeLayout.getScopeGroup();
        if (scopeGroup != null) {
          scopeGroupId=scopeGroup.getGroupId();
        }
      }
      String key=PortletPermissionUtil.getPrimaryKey(layout.getPlid(),portletId);
      portletIds.put(key,new Object[]{portletId,layout.getPlid(),scopeGroupId,scopeLayoutUuid});
    }
  }
 else   if (layout.isTypeLinkToLayout()) {
    UnicodeProperties typeSettingsProperties=layout.getTypeSettingsProperties();
    long linkToLayoutId=GetterUtil.getLong(typeSettingsProperties.getProperty("linkToLayoutId",StringPool.BLANK));
    Layout linkedToLayout=LayoutUtil.findByG_P_L(context.getScopeGroupId(),layout.isPrivateLayout(),linkToLayoutId);
    exportLayout(context,layoutConfigurationPortlet,layoutCache,portletIds,exportPermissions,exportUserPermissions,linkedToLayout,layoutsElement);
  }
  fixTypeSettings(layout);
  layoutElement.addAttribute("path",path);
  context.addZipEntry(path,layout);
}
