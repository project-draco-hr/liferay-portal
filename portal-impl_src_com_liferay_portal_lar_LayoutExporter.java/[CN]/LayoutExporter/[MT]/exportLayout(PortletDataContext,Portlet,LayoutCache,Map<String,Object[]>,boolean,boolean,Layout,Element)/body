{
  String path=context.getLayoutPath(layout.getLayoutId()) + "/layout.xml";
  if (!context.isPathNotProcessed(path)) {
    return;
  }
  if (LayoutStagingUtil.isBranchingLayout(layout)) {
    LayoutRevision layoutRevision=LayoutStagingUtil.getLayoutRevision(layout);
    if (!layoutRevision.isHead()) {
      return;
    }
  }
  Element layoutElement=layoutsElement.addElement("layout");
  layoutElement.addAttribute("layout-uuid",layout.getUuid());
  layoutElement.addAttribute("layout-id",String.valueOf(layout.getLayoutId()));
  long parentLayoutId=layout.getParentLayoutId();
  if (parentLayoutId != LayoutConstants.DEFAULT_PARENT_LAYOUT_ID) {
    Layout parentLayout=LayoutLocalServiceUtil.getLayout(layout.getGroupId(),layout.isPrivateLayout(),parentLayoutId);
    if (parentLayout != null) {
      layoutElement.addAttribute("parent-layout-uuid",parentLayout.getUuid());
    }
  }
  boolean deleteLayout=MapUtil.getBoolean(context.getParameterMap(),"delete_" + layout.getPlid());
  if (deleteLayout) {
    layoutElement.addAttribute("delete",String.valueOf(true));
    return;
  }
  context.setPlid(layout.getPlid());
  if (layout.isIconImage()) {
    Image image=ImageLocalServiceUtil.getImage(layout.getIconImageId());
    if (image != null) {
      String iconPath=getLayoutIconPath(context,layout,image);
      layoutElement.addElement("icon-image-path").addText(iconPath);
      context.addZipEntry(iconPath,image.getTextObj());
    }
  }
  _portletExporter.exportPortletData(context,layoutConfigurationPortlet,layout,null,layoutElement);
  if (exportPermissions) {
    _permissionExporter.exportLayoutPermissions(context,layoutCache,context.getCompanyId(),context.getScopeGroupId(),layout,layoutElement,exportUserPermissions);
  }
  if (layout.isTypePortlet()) {
    LayoutTypePortlet layoutTypePortlet=(LayoutTypePortlet)layout.getLayoutType();
    for (    String portletId : layoutTypePortlet.getPortletIds()) {
      javax.portlet.PortletPreferences jxPreferences=PortletPreferencesFactoryUtil.getLayoutPortletSetup(layout,portletId);
      String scopeType=GetterUtil.getString(jxPreferences.getValue("lfr-scope-type",null));
      String scopeLayoutUuid=GetterUtil.getString(jxPreferences.getValue("lfr-scope-layout-uuid",null));
      long scopeGroupId=context.getScopeGroupId();
      if (Validator.isNotNull(scopeType)) {
        Group scopeGroup=null;
        if (scopeType.equals("company")) {
          scopeGroup=GroupLocalServiceUtil.getCompanyGroup(layout.getCompanyId());
        }
 else         if (scopeType.equals("layout")) {
          Layout scopeLayout=null;
          try {
            scopeLayout=LayoutLocalServiceUtil.getLayoutByUuidAndGroupId(scopeLayoutUuid,context.getGroupId());
          }
 catch (          NoSuchLayoutException nsle) {
            if (_log.isWarnEnabled()) {
              _log.warn(nsle.getMessage());
            }
            continue;
          }
          scopeGroup=scopeLayout.getScopeGroup();
        }
 else {
          throw new IllegalArgumentException("Scope type " + scopeType + " is invalid");
        }
        if (scopeGroup != null) {
          scopeGroupId=scopeGroup.getGroupId();
        }
      }
      String key=PortletPermissionUtil.getPrimaryKey(layout.getPlid(),portletId);
      portletIds.put(key,new Object[]{portletId,layout.getPlid(),scopeGroupId,scopeType,scopeLayoutUuid});
    }
  }
 else   if (layout.isTypeLinkToLayout()) {
    UnicodeProperties typeSettingsProperties=layout.getTypeSettingsProperties();
    long linkToLayoutId=GetterUtil.getLong(typeSettingsProperties.getProperty("linkToLayoutId",StringPool.BLANK));
    if (linkToLayoutId > 0) {
      try {
        Layout linkedToLayout=LayoutLocalServiceUtil.getLayout(context.getScopeGroupId(),layout.isPrivateLayout(),linkToLayoutId);
        exportLayout(context,layoutConfigurationPortlet,layoutCache,portletIds,exportPermissions,exportUserPermissions,linkedToLayout,layoutsElement);
      }
 catch (      NoSuchLayoutException nsle) {
      }
    }
  }
  fixTypeSettings(layout);
  layoutElement.addAttribute("path",path);
  context.addZipEntry(path,layoutElement,layout);
}
