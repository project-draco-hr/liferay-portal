{
  List<Portlet> portlets=new ArrayList<Portlet>();
  Set<String> rootPortletIds=new HashSet<String>();
  for (  Layout layout : layouts) {
    if (!layout.isTypePortlet()) {
      continue;
    }
    LayoutTypePortlet layoutTypePortlet=(LayoutTypePortlet)layout.getLayoutType();
    for (    String portletId : layoutTypePortlet.getPortletIds()) {
      Portlet portlet=PortletLocalServiceUtil.getPortletById(layout.getCompanyId(),portletId);
      if ((portlet == null) || rootPortletIds.contains(portlet.getRootPortletId())) {
        continue;
      }
      PortletDataHandler portletDataHandler=portlet.getPortletDataHandlerInstance();
      if (portletDataHandler == null) {
        continue;
      }
      PortletDataHandlerControl[] portletDataHandlerControls=portletDataHandler.getExportConfigurationControls(layout.getCompanyId(),layout.getGroupId(),portlet,layout.getPrivateLayout());
      if (ArrayUtil.isNotEmpty(portletDataHandlerControls)) {
        rootPortletIds.add(portlet.getRootPortletId());
        portlets.add(portlet);
      }
    }
  }
  return portlets;
}
