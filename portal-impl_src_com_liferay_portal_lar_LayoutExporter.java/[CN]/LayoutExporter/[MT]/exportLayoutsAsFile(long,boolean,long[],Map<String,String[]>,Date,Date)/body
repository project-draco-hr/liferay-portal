{
  boolean exportCategories=MapUtil.getBoolean(parameterMap,PortletDataHandlerKeys.CATEGORIES);
  boolean exportIgnoreLastPublishDate=MapUtil.getBoolean(parameterMap,PortletDataHandlerKeys.IGNORE_LAST_PUBLISH_DATE);
  boolean exportPermissions=MapUtil.getBoolean(parameterMap,PortletDataHandlerKeys.PERMISSIONS);
  boolean exportUserPermissions=MapUtil.getBoolean(parameterMap,PortletDataHandlerKeys.USER_PERMISSIONS);
  boolean exportPortletArchivedSetups=MapUtil.getBoolean(parameterMap,PortletDataHandlerKeys.PORTLET_ARCHIVED_SETUPS);
  boolean exportPortletUserPreferences=MapUtil.getBoolean(parameterMap,PortletDataHandlerKeys.PORTLET_USER_PREFERENCES);
  boolean exportTheme=MapUtil.getBoolean(parameterMap,PortletDataHandlerKeys.THEME);
  if (_log.isDebugEnabled()) {
    _log.debug("Export categories " + exportCategories);
    _log.debug("Export permissions " + exportPermissions);
    _log.debug("Export user permissions " + exportUserPermissions);
    _log.debug("Export portlet archived setups " + exportPortletArchivedSetups);
    _log.debug("Export portlet user preferences " + exportPortletUserPreferences);
    _log.debug("Export theme " + exportTheme);
  }
  long lastPublishDate=System.currentTimeMillis();
  if (endDate != null) {
    lastPublishDate=endDate.getTime();
  }
  if (exportIgnoreLastPublishDate) {
    endDate=null;
    startDate=null;
  }
  StopWatch stopWatch=null;
  if (_log.isInfoEnabled()) {
    stopWatch=new StopWatch();
    stopWatch.start();
  }
  LayoutCache layoutCache=new LayoutCache();
  LayoutSet layoutSet=LayoutSetLocalServiceUtil.getLayoutSet(groupId,privateLayout);
  long companyId=layoutSet.getCompanyId();
  long defaultUserId=UserLocalServiceUtil.getDefaultUserId(companyId);
  ZipWriter zipWriter=ZipWriterFactoryUtil.getZipWriter();
  PortletDataContext context=new PortletDataContextImpl(companyId,groupId,parameterMap,new HashSet<String>(),startDate,endDate,zipWriter);
  context.setPortetDataContextListener(new PortletDataContextListenerImpl(context));
  Document document=SAXReaderUtil.createDocument();
  Element rootElement=document.addElement("root");
  Element headerElement=rootElement.addElement("header");
  headerElement.addAttribute("build-number",String.valueOf(ReleaseInfo.getBuildNumber()));
  headerElement.addAttribute("export-date",Time.getRFC822());
  if (context.hasDateRange()) {
    headerElement.addAttribute("start-date",String.valueOf(context.getStartDate()));
    headerElement.addAttribute("end-date",String.valueOf(context.getEndDate()));
  }
  headerElement.addAttribute("type","layout-set");
  headerElement.addAttribute("group-id",String.valueOf(groupId));
  headerElement.addAttribute("private-layout",String.valueOf(privateLayout));
  headerElement.addAttribute("theme-id",layoutSet.getThemeId());
  headerElement.addAttribute("color-scheme-id",layoutSet.getColorSchemeId());
  Portlet layoutConfigurationPortlet=PortletLocalServiceUtil.getPortletById(context.getCompanyId(),PortletKeys.LAYOUT_CONFIGURATION);
  Map<String,Object[]> portletIds=new LinkedHashMap<String,Object[]>();
  List<Layout> layouts=null;
  if ((layoutIds == null) || (layoutIds.length == 0)) {
    layouts=LayoutLocalServiceUtil.getLayouts(groupId,privateLayout);
  }
 else {
    layouts=LayoutLocalServiceUtil.getLayouts(groupId,privateLayout,layoutIds);
  }
  Layout firstLayout=layouts.get(0);
  Group group=GroupLocalServiceUtil.getGroup(context.getGroupId());
  if (group.isStagingGroup()) {
    group=group.getLiveGroup();
  }
  List<Portlet> portlets=getAlwaysExportablePortlets(companyId);
  for (  Portlet portlet : portlets) {
    String portletId=portlet.getRootPortletId();
    if (!group.isStagedPortlet(portletId)) {
      continue;
    }
    if (portlet.isScopeable() && firstLayout.hasScopeGroup()) {
      String key=PortletPermissionUtil.getPrimaryKey(firstLayout.getPlid(),portletId);
      portletIds.put(key,new Object[]{portletId,firstLayout.getPlid(),firstLayout.getScopeGroup().getGroupId(),firstLayout.getUuid()});
    }
 else {
      String key=PortletPermissionUtil.getPrimaryKey(0,portletId);
      if (portletIds.get(key) == null) {
        portletIds.put(key,new Object[]{portletId,firstLayout.getPlid(),groupId,StringPool.BLANK});
      }
    }
  }
  Element layoutsElement=rootElement.addElement("layouts");
  for (  Layout layout : layouts) {
    exportLayout(context,layoutConfigurationPortlet,layoutCache,portletIds,exportPermissions,exportUserPermissions,layout,layoutsElement);
  }
  if (PropsValues.PERMISSIONS_USER_CHECK_ALGORITHM < 5) {
    Element rolesElement=rootElement.addElement("roles");
    if (exportPermissions) {
      _permissionExporter.exportLayoutRoles(layoutCache,companyId,groupId,rolesElement);
    }
  }
  long previousScopeGroupId=context.getScopeGroupId();
  Element portletsElement=rootElement.addElement("portlets");
  for (  Map.Entry<String,Object[]> portletIdsEntry : portletIds.entrySet()) {
    String portletId=(String)portletIdsEntry.getValue()[0];
    long plid=(Long)portletIdsEntry.getValue()[1];
    long scopeGroupId=(Long)portletIdsEntry.getValue()[2];
    String scopeLayoutUuid=(String)portletIdsEntry.getValue()[3];
    Layout layout=LayoutUtil.findByPrimaryKey(plid);
    context.setPlid(layout.getPlid());
    context.setOldPlid(layout.getPlid());
    context.setScopeGroupId(scopeGroupId);
    context.setScopeLayoutUuid(scopeLayoutUuid);
    boolean[] exportPortletControls=getExportPortletControls(companyId,portletId,context,parameterMap);
    _portletExporter.exportPortlet(context,layoutCache,portletId,layout,portletsElement,defaultUserId,exportPermissions,exportPortletArchivedSetups,exportPortletControls[0],exportPortletControls[1],exportPortletUserPreferences,exportUserPermissions);
  }
  context.setScopeGroupId(previousScopeGroupId);
  if (exportCategories) {
    exportCategories(context);
  }
  _portletExporter.exportComments(context,rootElement);
  _portletExporter.exportLocks(context,rootElement);
  if (exportPermissions) {
    _permissionExporter.exportPortletDataPermissions(context);
  }
  _portletExporter.exportRatings(context,rootElement);
  _portletExporter.exportTags(context,rootElement);
  if (exportTheme) {
    exportTheme(layoutSet,zipWriter);
  }
  if (_log.isInfoEnabled()) {
    if (stopWatch != null) {
      _log.info("Exporting layouts takes " + stopWatch.getTime() + " ms");
    }
 else {
      _log.info("Exporting layouts is finished");
    }
  }
  context.addZipEntry("/manifest.xml",document.formattedString());
  try {
    return zipWriter.getFile();
  }
  finally {
    updateLastPublishDate(layoutSet,lastPublishDate);
  }
}
