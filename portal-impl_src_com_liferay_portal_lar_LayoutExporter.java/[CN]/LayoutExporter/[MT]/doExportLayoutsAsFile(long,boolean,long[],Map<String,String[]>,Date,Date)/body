{
  boolean exportCategories=MapUtil.getBoolean(parameterMap,PortletDataHandlerKeys.CATEGORIES);
  boolean exportIgnoreLastPublishDate=MapUtil.getBoolean(parameterMap,PortletDataHandlerKeys.IGNORE_LAST_PUBLISH_DATE);
  boolean exportPermissions=MapUtil.getBoolean(parameterMap,PortletDataHandlerKeys.PERMISSIONS);
  boolean exportPortletDataAll=MapUtil.getBoolean(parameterMap,PortletDataHandlerKeys.PORTLET_DATA_ALL);
  boolean exportLogo=MapUtil.getBoolean(parameterMap,PortletDataHandlerKeys.LOGO);
  boolean exportLayoutSetSettings=MapUtil.getBoolean(parameterMap,PortletDataHandlerKeys.LAYOUT_SET_SETTINGS);
  boolean updateLastPublishDate=MapUtil.getBoolean(parameterMap,PortletDataHandlerKeys.UPDATE_LAST_PUBLISH_DATE);
  if (_log.isDebugEnabled()) {
    _log.debug("Export permissions " + exportPermissions);
  }
  LayoutSet layoutSet=LayoutSetLocalServiceUtil.getLayoutSet(groupId,privateLayout);
  long companyId=layoutSet.getCompanyId();
  long defaultUserId=UserLocalServiceUtil.getDefaultUserId(companyId);
  ServiceContext serviceContext=ServiceContextThreadLocal.getServiceContext();
  if (serviceContext == null) {
    serviceContext=new ServiceContext();
    serviceContext.setCompanyId(companyId);
    serviceContext.setSignedIn(false);
    serviceContext.setUserId(defaultUserId);
    ServiceContextThreadLocal.pushServiceContext(serviceContext);
  }
  serviceContext.setAttribute("exporting",Boolean.TRUE);
  long layoutSetBranchId=MapUtil.getLong(parameterMap,"layoutSetBranchId");
  serviceContext.setAttribute("layoutSetBranchId",layoutSetBranchId);
  long lastPublishDate=System.currentTimeMillis();
  if (endDate != null) {
    lastPublishDate=endDate.getTime();
  }
  if (exportIgnoreLastPublishDate) {
    endDate=null;
    startDate=null;
  }
  StopWatch stopWatch=null;
  if (_log.isInfoEnabled()) {
    stopWatch=new StopWatch();
    stopWatch.start();
  }
  LayoutCache layoutCache=new LayoutCache();
  ZipWriter zipWriter=ZipWriterFactoryUtil.getZipWriter();
  PortletDataContext portletDataContext=PortletDataContextFactoryUtil.createExportPortletDataContext(companyId,groupId,parameterMap,startDate,endDate,zipWriter);
  portletDataContext.setPortetDataContextListener(new PortletDataContextListenerImpl(portletDataContext));
  Document document=SAXReaderUtil.createDocument();
  Element rootElement=document.addElement("root");
  portletDataContext.setExportDataRootElement(rootElement);
  Element headerElement=rootElement.addElement("header");
  headerElement.addAttribute("available-locales",StringUtil.merge(LanguageUtil.getAvailableLocales(portletDataContext.getScopeGroupId())));
  headerElement.addAttribute("build-number",String.valueOf(ReleaseInfo.getBuildNumber()));
  headerElement.addAttribute("export-date",Time.getRFC822());
  if (portletDataContext.hasDateRange()) {
    headerElement.addAttribute("start-date",String.valueOf(portletDataContext.getStartDate()));
    headerElement.addAttribute("end-date",String.valueOf(portletDataContext.getEndDate()));
  }
  headerElement.addAttribute("company-id",String.valueOf(portletDataContext.getCompanyId()));
  headerElement.addAttribute("company-group-id",String.valueOf(portletDataContext.getCompanyGroupId()));
  headerElement.addAttribute("group-id",String.valueOf(groupId));
  headerElement.addAttribute("user-personal-site-group-id",String.valueOf(portletDataContext.getUserPersonalSiteGroupId()));
  headerElement.addAttribute("private-layout",String.valueOf(privateLayout));
  Group group=layoutSet.getGroup();
  String type="layout-set";
  if (group.isLayoutPrototype()) {
    type="layout-prototype";
    LayoutPrototype layoutPrototype=LayoutPrototypeLocalServiceUtil.getLayoutPrototype(group.getClassPK());
    headerElement.addAttribute("type-uuid",layoutPrototype.getUuid());
  }
 else   if (group.isLayoutSetPrototype()) {
    type="layout-set-prototype";
    LayoutSetPrototype layoutSetPrototype=LayoutSetPrototypeLocalServiceUtil.getLayoutSetPrototype(group.getClassPK());
    headerElement.addAttribute("type-uuid",layoutSetPrototype.getUuid());
  }
  headerElement.addAttribute("type",type);
  LayoutSetBranch layoutSetBranch=LayoutSetBranchLocalServiceUtil.fetchLayoutSetBranch(layoutSetBranchId);
  if (exportLogo) {
    Image image=null;
    if (layoutSetBranch != null) {
      image=ImageLocalServiceUtil.getImage(layoutSetBranch.getLogoId());
    }
 else {
      image=ImageLocalServiceUtil.getImage(layoutSet.getLogoId());
    }
    if ((image != null) && (image.getTextObj() != null)) {
      String logoPath=ExportImportPathUtil.getRootPath(portletDataContext);
      logoPath+="/logo";
      headerElement.addAttribute("logo-path",logoPath);
      portletDataContext.addZipEntry(logoPath,image.getTextObj());
    }
  }
  if (layoutSetBranch != null) {
    _themeExporter.exportTheme(portletDataContext,layoutSetBranch);
  }
 else {
    _themeExporter.exportTheme(portletDataContext,layoutSet);
  }
  if (exportLayoutSetSettings) {
    Element settingsElement=headerElement.addElement("settings");
    if (layoutSetBranch != null) {
      settingsElement.addCDATA(layoutSetBranch.getSettings());
    }
 else {
      settingsElement.addCDATA(layoutSet.getSettings());
    }
  }
  Map<String,Object[]> portletIds=new LinkedHashMap<String,Object[]>();
  List<Layout> layouts=LayoutLocalServiceUtil.getLayouts(groupId,privateLayout);
  List<Portlet> portlets=getDataSiteLevelPortlets(companyId);
  long plid=LayoutConstants.DEFAULT_PLID;
  if (!layouts.isEmpty()) {
    Layout firstLayout=layouts.get(0);
    plid=firstLayout.getPlid();
  }
  if (group.isStagingGroup()) {
    group=group.getLiveGroup();
  }
  for (  Portlet portlet : portlets) {
    String portletId=portlet.getRootPortletId();
    if (!group.isStagedPortlet(portletId)) {
      continue;
    }
    String key=PortletPermissionUtil.getPrimaryKey(0,portletId);
    if (portletIds.get(key) == null) {
      portletIds.put(key,new Object[]{portletId,plid,groupId,StringPool.BLANK,StringPool.BLANK});
    }
  }
  Element missingReferencesElement=rootElement.addElement("missing-references");
  portletDataContext.setMissingReferencesElement(missingReferencesElement);
  portletDataContext.addDeletionSystemEventStagedModelTypes(new StagedModelType(Layout.class));
  Element layoutsElement=portletDataContext.getExportDataGroupElement(Layout.class);
  String layoutSetPrototypeUuid=layoutSet.getLayoutSetPrototypeUuid();
  if (Validator.isNotNull(layoutSetPrototypeUuid)) {
    LayoutSetPrototype layoutSetPrototype=LayoutSetPrototypeLocalServiceUtil.getLayoutSetPrototypeByUuidAndCompanyId(layoutSetPrototypeUuid,companyId);
    layoutsElement.addAttribute("layout-set-prototype-uuid",layoutSetPrototypeUuid);
    layoutsElement.addAttribute("layout-set-prototype-name",layoutSetPrototype.getName(LocaleUtil.getDefault()));
  }
  for (  Layout layout : layouts) {
    exportLayout(portletDataContext,portlets,layoutIds,portletIds,layout,zipWriter);
  }
  long previousScopeGroupId=portletDataContext.getScopeGroupId();
  Element portletsElement=rootElement.addElement("portlets");
  for (  Map.Entry<String,Object[]> portletIdsEntry : portletIds.entrySet()) {
    Object[] portletObjects=portletIdsEntry.getValue();
    String portletId=null;
    plid=LayoutConstants.DEFAULT_PLID;
    long scopeGroupId=0;
    String scopeType=StringPool.BLANK;
    String scopeLayoutUuid=null;
    if (portletObjects.length == 4) {
      portletId=(String)portletIdsEntry.getValue()[0];
      plid=(Long)portletIdsEntry.getValue()[1];
      scopeGroupId=(Long)portletIdsEntry.getValue()[2];
      scopeLayoutUuid=(String)portletIdsEntry.getValue()[3];
    }
 else {
      portletId=(String)portletIdsEntry.getValue()[0];
      plid=(Long)portletIdsEntry.getValue()[1];
      scopeGroupId=(Long)portletIdsEntry.getValue()[2];
      scopeType=(String)portletIdsEntry.getValue()[3];
      scopeLayoutUuid=(String)portletIdsEntry.getValue()[4];
    }
    Layout layout=LayoutLocalServiceUtil.fetchLayout(plid);
    if (layout == null) {
      layout=new LayoutImpl();
      layout.setGroupId(groupId);
      layout.setCompanyId(companyId);
    }
    portletDataContext.setPlid(plid);
    portletDataContext.setOldPlid(plid);
    portletDataContext.setScopeGroupId(scopeGroupId);
    portletDataContext.setScopeType(scopeType);
    portletDataContext.setScopeLayoutUuid(scopeLayoutUuid);
    boolean[] exportPortletControls=getExportPortletControls(companyId,portletId,parameterMap,type);
    _portletExporter.exportPortlet(portletDataContext,layoutCache,portletId,layout,portletsElement,defaultUserId,exportPermissions,exportPortletControls[0],exportPortletControls[1],exportPortletControls[2],exportPortletControls[3]);
  }
  portletDataContext.setScopeGroupId(previousScopeGroupId);
  exportAssetCategories(portletDataContext,exportPortletDataAll,exportCategories,group.isCompany());
  _portletExporter.exportAssetLinks(portletDataContext);
  _portletExporter.exportAssetTags(portletDataContext);
  _portletExporter.exportComments(portletDataContext);
  _portletExporter.exportExpandoTables(portletDataContext);
  _portletExporter.exportLocks(portletDataContext);
  _deletionSystemEventExporter.exportDeletionSystemEvents(portletDataContext);
  if (exportPermissions) {
    _permissionExporter.exportPortletDataPermissions(portletDataContext);
  }
  _portletExporter.exportRatingsEntries(portletDataContext,rootElement);
  ExportImportHelperUtil.writeManifestSummary(document,portletDataContext.getManifestSummary());
  if (_log.isInfoEnabled()) {
    if (stopWatch != null) {
      _log.info("Exporting layouts takes " + stopWatch.getTime() + " ms");
    }
 else {
      _log.info("Exporting layouts is finished");
    }
  }
  portletDataContext.addZipEntry("/manifest.xml",document.formattedString());
  try {
    return zipWriter.getFile();
  }
  finally {
    if (updateLastPublishDate) {
      updateLastPublishDate(layoutSet,lastPublishDate);
    }
  }
}
