{
  boolean exportCategories=MapUtil.getBoolean(parameterMap,PortletDataHandlerKeys.CATEGORIES);
  boolean exportIgnoreLastPublishDate=MapUtil.getBoolean(parameterMap,PortletDataHandlerKeys.IGNORE_LAST_PUBLISH_DATE);
  boolean exportPermissions=MapUtil.getBoolean(parameterMap,PortletDataHandlerKeys.PERMISSIONS);
  boolean exportPortletArchivedSetups=MapUtil.getBoolean(parameterMap,PortletDataHandlerKeys.PORTLET_ARCHIVED_SETUPS);
  boolean exportPortletUserPreferences=MapUtil.getBoolean(parameterMap,PortletDataHandlerKeys.PORTLET_USER_PREFERENCES);
  boolean exportTheme=MapUtil.getBoolean(parameterMap,PortletDataHandlerKeys.THEME);
  boolean exportThemeSettings=MapUtil.getBoolean(parameterMap,PortletDataHandlerKeys.THEME_REFERENCE);
  boolean exportLogo=MapUtil.getBoolean(parameterMap,PortletDataHandlerKeys.LOGO);
  boolean exportLayoutSetSettings=MapUtil.getBoolean(parameterMap,PortletDataHandlerKeys.LAYOUT_SET_SETTINGS);
  boolean updateLastPublishDate=MapUtil.getBoolean(parameterMap,PortletDataHandlerKeys.UPDATE_LAST_PUBLISH_DATE);
  if (_log.isDebugEnabled()) {
    _log.debug("Export categories " + exportCategories);
    _log.debug("Export permissions " + exportPermissions);
    _log.debug("Export portlet archived setups " + exportPortletArchivedSetups);
    _log.debug("Export portlet user preferences " + exportPortletUserPreferences);
    _log.debug("Export theme " + exportTheme);
  }
  LayoutSet layoutSet=LayoutSetLocalServiceUtil.getLayoutSet(groupId,privateLayout);
  long companyId=layoutSet.getCompanyId();
  long defaultUserId=UserLocalServiceUtil.getDefaultUserId(companyId);
  ServiceContext serviceContext=ServiceContextThreadLocal.getServiceContext();
  if (serviceContext == null) {
    serviceContext=new ServiceContext();
    serviceContext.setCompanyId(companyId);
    serviceContext.setSignedIn(false);
    serviceContext.setUserId(defaultUserId);
    ServiceContextThreadLocal.pushServiceContext(serviceContext);
  }
  serviceContext.setAttribute("exporting",Boolean.TRUE);
  long layoutSetBranchId=MapUtil.getLong(parameterMap,"layoutSetBranchId");
  serviceContext.setAttribute("layoutSetBranchId",layoutSetBranchId);
  long lastPublishDate=System.currentTimeMillis();
  if (endDate != null) {
    lastPublishDate=endDate.getTime();
  }
  if (exportIgnoreLastPublishDate) {
    endDate=null;
    startDate=null;
  }
  StopWatch stopWatch=null;
  if (_log.isInfoEnabled()) {
    stopWatch=new StopWatch();
    stopWatch.start();
  }
  LayoutCache layoutCache=new LayoutCache();
  ZipWriter zipWriter=ZipWriterFactoryUtil.getZipWriter();
  PortletDataContext portletDataContext=new PortletDataContextImpl(companyId,groupId,parameterMap,new HashSet<String>(),startDate,endDate,zipWriter);
  portletDataContext.setPortetDataContextListener(new PortletDataContextListenerImpl(portletDataContext));
  Document document=SAXReaderUtil.createDocument();
  Element rootElement=document.addElement("root");
  Element headerElement=rootElement.addElement("header");
  headerElement.addAttribute("available-locales",StringUtil.merge(LanguageUtil.getAvailableLocales()));
  headerElement.addAttribute("build-number",String.valueOf(ReleaseInfo.getBuildNumber()));
  headerElement.addAttribute("export-date",Time.getRFC822());
  if (portletDataContext.hasDateRange()) {
    headerElement.addAttribute("start-date",String.valueOf(portletDataContext.getStartDate()));
    headerElement.addAttribute("end-date",String.valueOf(portletDataContext.getEndDate()));
  }
  headerElement.addAttribute("group-id",String.valueOf(groupId));
  headerElement.addAttribute("private-layout",String.valueOf(privateLayout));
  Group group=layoutSet.getGroup();
  String type="layout-set";
  if (group.isLayoutPrototype()) {
    type="layout-prototype";
    LayoutPrototype layoutPrototype=LayoutPrototypeLocalServiceUtil.getLayoutPrototype(group.getClassPK());
    headerElement.addAttribute("type-uuid",layoutPrototype.getUuid());
  }
 else   if (group.isLayoutSetPrototype()) {
    type="layout-set-prototype";
    LayoutSetPrototype layoutSetPrototype=LayoutSetPrototypeLocalServiceUtil.getLayoutSetPrototype(group.getClassPK());
    headerElement.addAttribute("type-uuid",layoutSetPrototype.getUuid());
  }
  headerElement.addAttribute("type",type);
  if (exportTheme || exportThemeSettings) {
    headerElement.addAttribute("theme-id",layoutSet.getThemeId());
    headerElement.addAttribute("color-scheme-id",layoutSet.getColorSchemeId());
  }
  if (exportLogo) {
    Image image=ImageLocalServiceUtil.getImage(layoutSet.getLogoId());
    if ((image != null) && (image.getTextObj() != null)) {
      String logoPath=getLayoutSetLogoPath(portletDataContext);
      headerElement.addAttribute("logo-path",logoPath);
      portletDataContext.addZipEntry(logoPath,image.getTextObj());
    }
  }
  if (exportLayoutSetSettings) {
    Element settingsElement=headerElement.addElement("settings");
    settingsElement.addCDATA(layoutSet.getSettings());
  }
  Element cssElement=headerElement.addElement("css");
  cssElement.addCDATA(layoutSet.getCss());
  Portlet layoutConfigurationPortlet=PortletLocalServiceUtil.getPortletById(portletDataContext.getCompanyId(),PortletKeys.LAYOUT_CONFIGURATION);
  Map<String,Object[]> portletIds=new LinkedHashMap<String,Object[]>();
  List<Layout> layouts=null;
  if ((layoutIds == null) || (layoutIds.length == 0)) {
    layouts=LayoutLocalServiceUtil.getLayouts(groupId,privateLayout);
  }
 else {
    layouts=LayoutLocalServiceUtil.getLayouts(groupId,privateLayout,layoutIds);
  }
  List<Portlet> portlets=getAlwaysExportablePortlets(companyId);
  long plid=LayoutConstants.DEFAULT_PLID;
  if (!layouts.isEmpty()) {
    Layout firstLayout=layouts.get(0);
    plid=firstLayout.getPlid();
  }
  if (group.isStagingGroup()) {
    group=group.getLiveGroup();
  }
  for (  Portlet portlet : portlets) {
    String portletId=portlet.getRootPortletId();
    if (!group.isStagedPortlet(portletId)) {
      continue;
    }
    String key=PortletPermissionUtil.getPrimaryKey(0,portletId);
    if (portletIds.get(key) == null) {
      portletIds.put(key,new Object[]{portletId,plid,groupId,StringPool.BLANK,StringPool.BLANK});
    }
  }
  Element layoutsElement=rootElement.addElement("layouts");
  String layoutSetPrototypeUuid=layoutSet.getLayoutSetPrototypeUuid();
  if (Validator.isNotNull(layoutSetPrototypeUuid)) {
    LayoutSetPrototype layoutSetPrototype=LayoutSetPrototypeLocalServiceUtil.getLayoutSetPrototypeByUuidAndCompanyId(layoutSetPrototypeUuid,companyId);
    layoutsElement.addAttribute("layout-set-prototype-uuid",layoutSetPrototypeUuid);
    layoutsElement.addAttribute("layout-set-prototype-name",layoutSetPrototype.getName(LocaleUtil.getDefault()));
  }
  for (  Layout layout : layouts) {
    exportLayout(portletDataContext,layoutConfigurationPortlet,layoutCache,portlets,portletIds,exportPermissions,layout,layoutsElement);
  }
  long previousScopeGroupId=portletDataContext.getScopeGroupId();
  Element portletsElement=rootElement.addElement("portlets");
  for (  Map.Entry<String,Object[]> portletIdsEntry : portletIds.entrySet()) {
    Object[] portletObjects=portletIdsEntry.getValue();
    String portletId=null;
    plid=LayoutConstants.DEFAULT_PLID;
    long scopeGroupId=0;
    String scopeType=StringPool.BLANK;
    String scopeLayoutUuid=null;
    if (portletObjects.length == 4) {
      portletId=(String)portletIdsEntry.getValue()[0];
      plid=(Long)portletIdsEntry.getValue()[1];
      scopeGroupId=(Long)portletIdsEntry.getValue()[2];
      scopeLayoutUuid=(String)portletIdsEntry.getValue()[3];
    }
 else {
      portletId=(String)portletIdsEntry.getValue()[0];
      plid=(Long)portletIdsEntry.getValue()[1];
      scopeGroupId=(Long)portletIdsEntry.getValue()[2];
      scopeType=(String)portletIdsEntry.getValue()[3];
      scopeLayoutUuid=(String)portletIdsEntry.getValue()[4];
    }
    Layout layout=LayoutLocalServiceUtil.fetchLayout(plid);
    if (layout == null) {
      if (!group.isCompany() && (plid <= LayoutConstants.DEFAULT_PLID)) {
        continue;
      }
      if (_log.isWarnEnabled()) {
        _log.warn("Assuming global scope because no layout was found");
      }
      layout=new LayoutImpl();
      layout.setGroupId(groupId);
      layout.setCompanyId(companyId);
    }
    portletDataContext.setPlid(plid);
    portletDataContext.setOldPlid(plid);
    portletDataContext.setScopeGroupId(scopeGroupId);
    portletDataContext.setScopeType(scopeType);
    portletDataContext.setScopeLayoutUuid(scopeLayoutUuid);
    boolean[] exportPortletControls=getExportPortletControls(companyId,portletId,portletDataContext,parameterMap,group.isLayoutPrototype());
    _portletExporter.exportPortlet(portletDataContext,layoutCache,portletId,layout,portletsElement,defaultUserId,exportPermissions,exportPortletArchivedSetups,exportPortletControls[0],exportPortletControls[1],exportPortletUserPreferences);
  }
  portletDataContext.setScopeGroupId(previousScopeGroupId);
  if (exportCategories || group.isCompany()) {
    exportAssetCategories(portletDataContext);
  }
  _portletExporter.exportAssetLinks(portletDataContext);
  _portletExporter.exportAssetTags(portletDataContext);
  _portletExporter.exportComments(portletDataContext);
  _portletExporter.exportExpandoTables(portletDataContext);
  _portletExporter.exportLocks(portletDataContext);
  if (exportPermissions) {
    _permissionExporter.exportPortletDataPermissions(portletDataContext);
  }
  _portletExporter.exportRatingsEntries(portletDataContext,rootElement);
  if (exportTheme && !portletDataContext.isPerformDirectBinaryImport()) {
    exportTheme(layoutSet,zipWriter);
  }
  if (_log.isInfoEnabled()) {
    if (stopWatch != null) {
      _log.info("Exporting layouts takes " + stopWatch.getTime() + " ms");
    }
 else {
      _log.info("Exporting layouts is finished");
    }
  }
  portletDataContext.addZipEntry("/manifest.xml",document.formattedString());
  try {
    return zipWriter.getFile();
  }
  finally {
    if (updateLastPublishDate) {
      updateLastPublishDate(layoutSet,lastPublishDate);
    }
  }
}
