{
  boolean exportCategories=MapUtil.getBoolean(parameterMap,PortletDataHandlerKeys.CATEGORIES);
  boolean exportIgnoreLastPublishDate=MapUtil.getBoolean(parameterMap,PortletDataHandlerKeys.IGNORE_LAST_PUBLISH_DATE);
  boolean exportPermissions=MapUtil.getBoolean(parameterMap,PortletDataHandlerKeys.PERMISSIONS);
  boolean exportUserPermissions=MapUtil.getBoolean(parameterMap,PortletDataHandlerKeys.USER_PERMISSIONS);
  boolean exportPortletArchivedSetups=MapUtil.getBoolean(parameterMap,PortletDataHandlerKeys.PORTLET_ARCHIVED_SETUPS);
  boolean exportPortletUserPreferences=MapUtil.getBoolean(parameterMap,PortletDataHandlerKeys.PORTLET_USER_PREFERENCES);
  boolean exportTheme=MapUtil.getBoolean(parameterMap,PortletDataHandlerKeys.THEME);
  boolean exportThemeSettings=MapUtil.getBoolean(parameterMap,PortletDataHandlerKeys.THEME_REFERENCE);
  boolean layoutSetPrototypeInherited=MapUtil.getBoolean(parameterMap,PortletDataHandlerKeys.LAYOUT_SET_PROTOTYPE_LINK_ENABLED);
  boolean publishToRemote=MapUtil.getBoolean(parameterMap,PortletDataHandlerKeys.PUBLISH_TO_REMOTE);
  boolean updateLastPublishDate=MapUtil.getBoolean(parameterMap,PortletDataHandlerKeys.UPDATE_LAST_PUBLISH_DATE);
  if (_log.isDebugEnabled()) {
    _log.debug("Export categories " + exportCategories);
    _log.debug("Export permissions " + exportPermissions);
    _log.debug("Export user permissions " + exportUserPermissions);
    _log.debug("Export portlet archived setups " + exportPortletArchivedSetups);
    _log.debug("Export portlet user preferences " + exportPortletUserPreferences);
    _log.debug("Export theme " + exportTheme);
  }
  ServiceContext serviceContext=ServiceContextThreadLocal.getServiceContext();
  serviceContext.setAttribute("exporting",Boolean.TRUE);
  long layoutSetBranchId=MapUtil.getLong(parameterMap,"layoutSetBranchId");
  serviceContext.setAttribute("layoutSetBranchId",layoutSetBranchId);
  long lastPublishDate=System.currentTimeMillis();
  if (endDate != null) {
    lastPublishDate=endDate.getTime();
  }
  if (exportIgnoreLastPublishDate) {
    endDate=null;
    startDate=null;
  }
  StopWatch stopWatch=null;
  if (_log.isInfoEnabled()) {
    stopWatch=new StopWatch();
    stopWatch.start();
  }
  LayoutCache layoutCache=new LayoutCache();
  LayoutSet layoutSet=LayoutSetLocalServiceUtil.getLayoutSet(groupId,privateLayout);
  long companyId=layoutSet.getCompanyId();
  long defaultUserId=UserLocalServiceUtil.getDefaultUserId(companyId);
  ZipWriter zipWriter=ZipWriterFactoryUtil.getZipWriter();
  PortletDataContext portletDataContext=new PortletDataContextImpl(companyId,groupId,parameterMap,new HashSet<String>(),startDate,endDate,zipWriter);
  portletDataContext.setPortetDataContextListener(new PortletDataContextListenerImpl(portletDataContext));
  Document document=SAXReaderUtil.createDocument();
  Element rootElement=document.addElement("root");
  Element headerElement=rootElement.addElement("header");
  headerElement.addAttribute("build-number",String.valueOf(ReleaseInfo.getBuildNumber()));
  headerElement.addAttribute("export-date",Time.getRFC822());
  if (portletDataContext.hasDateRange()) {
    headerElement.addAttribute("start-date",String.valueOf(portletDataContext.getStartDate()));
    headerElement.addAttribute("end-date",String.valueOf(portletDataContext.getEndDate()));
  }
  headerElement.addAttribute("type","layout-set");
  headerElement.addAttribute("group-id",String.valueOf(groupId));
  headerElement.addAttribute("private-layout",String.valueOf(privateLayout));
  Group group=layoutSet.getGroup();
  if (layoutSetPrototypeInherited && group.isLayoutSetPrototype()) {
    LayoutSetPrototype layoutSetPrototype=LayoutSetPrototypeLocalServiceUtil.getLayoutSetPrototype(group.getClassPK());
    String layoutSetPrototypeUuid=layoutSetPrototype.getUuid();
    headerElement.addAttribute("layout-set-prototype-uuid",layoutSetPrototypeUuid);
    if (publishToRemote) {
      String path=getLayoutSetPrototype(portletDataContext,layoutSetPrototypeUuid);
      File layoutSetPrototypeFile=SitesUtil.exportLayoutSetPrototype(layoutSetPrototype,serviceContext);
      try {
        portletDataContext.addZipEntry(path.concat(".lar"),new FileInputStream(layoutSetPrototypeFile));
        portletDataContext.addZipEntry(path.concat(".xml"),layoutSetPrototype);
      }
  finally {
        layoutSetPrototypeFile.delete();
      }
    }
  }
  if (exportTheme || exportThemeSettings) {
    headerElement.addAttribute("theme-id",layoutSet.getThemeId());
    headerElement.addAttribute("color-scheme-id",layoutSet.getColorSchemeId());
  }
  Element cssElement=headerElement.addElement("css");
  cssElement.addCDATA(layoutSet.getCss());
  Portlet layoutConfigurationPortlet=PortletLocalServiceUtil.getPortletById(portletDataContext.getCompanyId(),PortletKeys.LAYOUT_CONFIGURATION);
  Map<String,Object[]> portletIds=new LinkedHashMap<String,Object[]>();
  List<Layout> layouts=null;
  if ((layoutIds == null) || (layoutIds.length == 0)) {
    layouts=LayoutLocalServiceUtil.getLayouts(groupId,privateLayout);
  }
 else {
    layouts=LayoutLocalServiceUtil.getLayouts(groupId,privateLayout,layoutIds);
  }
  List<Portlet> portlets=getAlwaysExportablePortlets(companyId);
  if (!layouts.isEmpty()) {
    Layout firstLayout=layouts.get(0);
    if (group.isStagingGroup()) {
      group=group.getLiveGroup();
    }
    for (    Portlet portlet : portlets) {
      String portletId=portlet.getRootPortletId();
      if (!group.isStagedPortlet(portletId)) {
        continue;
      }
      String key=PortletPermissionUtil.getPrimaryKey(0,portletId);
      if (portletIds.get(key) == null) {
        portletIds.put(key,new Object[]{portletId,firstLayout.getPlid(),groupId,StringPool.BLANK,StringPool.BLANK});
      }
    }
  }
  Element layoutsElement=rootElement.addElement("layouts");
  for (  Layout layout : layouts) {
    exportLayout(portletDataContext,layoutConfigurationPortlet,layoutCache,portlets,portletIds,exportPermissions,exportUserPermissions,layout,layoutsElement);
  }
  if (PropsValues.PERMISSIONS_USER_CHECK_ALGORITHM < 5) {
    Element rolesElement=rootElement.addElement("roles");
    if (exportPermissions) {
      _permissionExporter.exportLayoutRoles(layoutCache,companyId,groupId,rolesElement);
    }
  }
  long previousScopeGroupId=portletDataContext.getScopeGroupId();
  Element portletsElement=rootElement.addElement("portlets");
  for (  Map.Entry<String,Object[]> portletIdsEntry : portletIds.entrySet()) {
    Object[] portletObjects=portletIdsEntry.getValue();
    String portletId=null;
    long plid=0;
    long scopeGroupId=0;
    String scopeType=StringPool.BLANK;
    String scopeLayoutUuid=null;
    if (portletObjects.length == 4) {
      portletId=(String)portletIdsEntry.getValue()[0];
      plid=(Long)portletIdsEntry.getValue()[1];
      scopeGroupId=(Long)portletIdsEntry.getValue()[2];
      scopeLayoutUuid=(String)portletIdsEntry.getValue()[3];
    }
 else {
      portletId=(String)portletIdsEntry.getValue()[0];
      plid=(Long)portletIdsEntry.getValue()[1];
      scopeGroupId=(Long)portletIdsEntry.getValue()[2];
      scopeType=(String)portletIdsEntry.getValue()[3];
      scopeLayoutUuid=(String)portletIdsEntry.getValue()[4];
    }
    Layout layout=LayoutLocalServiceUtil.getLayout(plid);
    portletDataContext.setPlid(layout.getPlid());
    portletDataContext.setOldPlid(layout.getPlid());
    portletDataContext.setScopeGroupId(scopeGroupId);
    portletDataContext.setScopeType(scopeType);
    portletDataContext.setScopeLayoutUuid(scopeLayoutUuid);
    boolean[] exportPortletControls=getExportPortletControls(companyId,portletId,portletDataContext,parameterMap);
    _portletExporter.exportPortlet(portletDataContext,layoutCache,portletId,layout,portletsElement,defaultUserId,exportPermissions,exportPortletArchivedSetups,exportPortletControls[0],exportPortletControls[1],exportPortletUserPreferences,exportUserPermissions);
  }
  portletDataContext.setScopeGroupId(previousScopeGroupId);
  if (exportCategories) {
    exportAssetCategories(portletDataContext);
  }
  _portletExporter.exportAssetLinks(portletDataContext);
  _portletExporter.exportAssetTags(portletDataContext);
  _portletExporter.exportComments(portletDataContext);
  _portletExporter.exportExpandoTables(portletDataContext);
  _portletExporter.exportLocks(portletDataContext);
  if (exportPermissions) {
    _permissionExporter.exportPortletDataPermissions(portletDataContext);
  }
  _portletExporter.exportRatingsEntries(portletDataContext,rootElement);
  if (exportTheme && !portletDataContext.isPerformDirectBinaryImport()) {
    exportTheme(layoutSet,zipWriter);
  }
  if (_log.isInfoEnabled()) {
    if (stopWatch != null) {
      _log.info("Exporting layouts takes " + stopWatch.getTime() + " ms");
    }
 else {
      _log.info("Exporting layouts is finished");
    }
  }
  portletDataContext.addZipEntry("/manifest.xml",document.formattedString());
  try {
    return zipWriter.getFile();
  }
  finally {
    if (updateLastPublishDate) {
      updateLastPublishDate(layoutSet,lastPublishDate);
    }
  }
}
