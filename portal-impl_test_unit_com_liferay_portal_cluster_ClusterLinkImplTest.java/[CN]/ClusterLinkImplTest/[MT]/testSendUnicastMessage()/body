{
  TransportationConfigurationAdvice.setChannelCount(1);
  BaseReceiverAdvice.reset(1);
  ClusterLinkImpl clusterLinkImpl1=null;
  ClusterLinkImpl clusterLinkImpl2=null;
  try {
    clusterLinkImpl1=getClusterLinkImpl();
    clusterLinkImpl2=getClusterLinkImpl();
    List<JChannel> jChannels1=getJChannels(clusterLinkImpl1);
    List<JChannel> jChannels2=getJChannels(clusterLinkImpl2);
    JChannel jChannel1=jChannels1.get(0);
    JChannel jChannel2=jChannels2.get(0);
    Receiver receiver1=jChannel1.getReceiver();
    Receiver receiver2=jChannel2.getReceiver();
    Message message=createMessage();
    clusterLinkImpl1.sendUnicastMessage(new AddressImpl(jChannels2.get(0).getAddress()),message,Priority.LEVEL1);
    org.jgroups.Address sourceAddress=jChannel1.getAddress();
    BaseReceiverAdvice.awaitMessageReceived();
    Message receivedMessage1=(Message)BaseReceiverAdvice.getJgroupsMessagePayload(receiver1,sourceAddress);
    Message receivedMessage2=(Message)BaseReceiverAdvice.getJgroupsMessagePayload(receiver2,sourceAddress);
    Assert.assertNull(receivedMessage1);
    Assert.assertEquals(message.getPayload(),receivedMessage2.getPayload());
  }
  finally {
    if (clusterLinkImpl1 != null) {
      clusterLinkImpl1.destroy();
    }
    if (clusterLinkImpl2 != null) {
      clusterLinkImpl2.destroy();
    }
  }
}
