{
  Assert.assertNotNull(properties);
  BundleContext bundleContext=getBundleContext();
  properties.put("javax.portlet.name",portletName);
  serviceRegistration=bundleContext.registerService(new String[]{Object.class.getName(),javax.portlet.Portlet.class.getName()},portlet,properties);
  serviceRegistrations.add(serviceRegistration);
  if (addToPage) {
    LayoutTestUtil.addPortletToLayout(TestPropsValues.getUserId(),layout,portletName,"column-1",new HashMap<String,String[]>());
  }
}
