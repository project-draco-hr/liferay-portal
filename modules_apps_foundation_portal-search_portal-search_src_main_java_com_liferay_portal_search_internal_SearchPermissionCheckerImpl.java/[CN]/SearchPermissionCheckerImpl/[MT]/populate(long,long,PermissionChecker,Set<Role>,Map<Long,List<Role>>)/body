{
  UserBag userBag=permissionChecker.getUserBag();
  if (permissionChecker.isSignedIn()) {
    roles.addAll(userBag.getRoles());
    roles.add(_roleLocalService.getRole(companyId,RoleConstants.GUEST));
  }
 else {
    Group guestGroup=_groupLocalService.getGroup(companyId,GroupConstants.GUEST);
    roles.addAll(_roleLocalService.getUserRelatedRoles(userId,Collections.singletonList(guestGroup)));
  }
  int termsCount=roles.size();
  int permissionTermsLimit=_searchPermissionCheckerConfiguration.permissionTermsLimit();
  if (termsCount > permissionTermsLimit) {
    if (_log.isDebugEnabled()) {
      _log.debug("Skipping pre-search permission checking due to too many " + "roles: " + termsCount + " > "+ permissionTermsLimit);
    }
    return false;
  }
  Role organizationUserRole=_roleLocalService.getRole(companyId,RoleConstants.ORGANIZATION_USER);
  Role siteMemberRole=_roleLocalService.getRole(companyId,RoleConstants.SITE_MEMBER);
  Collection<Group> groups=userBag.getGroups();
  termsCount+=groups.size();
  if (termsCount > permissionTermsLimit) {
    if (_log.isDebugEnabled()) {
      _log.debug("Skipping pre-search permission checking due to too many " + "roles and groups: " + termsCount + " > "+ permissionTermsLimit);
    }
    return false;
  }
  for (  Group group : groups) {
    long[] roleIds=permissionChecker.getRoleIds(userId,group.getGroupId());
    List<Role> groupRoles=_roleLocalService.getRoles(roleIds);
    roles.addAll(groupRoles);
    Iterator<Role> iterator=groupRoles.iterator();
    while (iterator.hasNext()) {
      Role groupRole=iterator.next();
      if ((groupRole.getType() != RoleConstants.TYPE_ORGANIZATION) && (groupRole.getType() != RoleConstants.TYPE_SITE)) {
        iterator.remove();
      }
    }
    if (group.isOrganization() && !groupRoles.contains(organizationUserRole)) {
      groupRoles.add(organizationUserRole);
    }
    if (group.isSite() && !groupRoles.contains(siteMemberRole)) {
      groupRoles.add(siteMemberRole);
    }
    usersGroupIdsToRoles.put(group.getGroupId(),groupRoles);
    termsCount+=groupRoles.size();
    if (termsCount > permissionTermsLimit) {
      if (_log.isDebugEnabled()) {
        _log.debug("Skipping pre-search permission checking due to too " + "many roles, groups, and groupRoles: " + termsCount + " > "+ permissionTermsLimit);
      }
      return false;
    }
  }
  return true;
}
