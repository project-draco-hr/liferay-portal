{
  Action renderPortletAction=(Action)InstancePool.get(RenderPortletAction.class.getName());
  long companyId=PortalUtil.getCompanyId(request);
  Portlet portlet=PortletLocalServiceUtil.getPortletById(companyId,portletId);
  DynamicServletRequest dynamicRequest=null;
  if (portlet.isPrivateRequestAttributes()) {
    String portletNamespace=PortalUtil.getPortletNamespace(portlet.getPortletId());
    dynamicRequest=new NamespaceServletRequest(request,portletNamespace,portletNamespace);
  }
 else {
    dynamicRequest=new DynamicServletRequest(request);
  }
  dynamicRequest.setParameter("p_p_id",portletId);
  String dataType=ParamUtil.getString(request,"dataType");
  if (dataType.equals("json")) {
    JSONObject jsonObj=JSONFactoryUtil.createJSONObject();
    if (portlet.isAjaxable()) {
      StringServletResponse stringResponse=new StringServletResponse(response);
      renderPortletAction.execute(mapping,form,dynamicRequest,stringResponse);
      jsonObj.put("refresh","false");
      jsonObj.put("portletHTML",stringResponse.getString());
    }
 else {
      jsonObj.put("refresh","true");
    }
    ServletResponseUtil.write(response,jsonObj.toString());
  }
 else {
    renderPortletAction.execute(mapping,form,dynamicRequest,response);
  }
}
