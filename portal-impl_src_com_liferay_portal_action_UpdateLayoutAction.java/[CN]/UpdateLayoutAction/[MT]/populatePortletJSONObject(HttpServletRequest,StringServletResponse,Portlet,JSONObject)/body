{
  ThemeDisplay themeDisplay=(ThemeDisplay)request.getAttribute(WebKeys.THEME_DISPLAY);
  LayoutTypePortlet layoutTypePortlet=themeDisplay.getLayoutTypePortlet();
  jsonObject.put("refresh",false);
  jsonObject.put("portletHTML",stringResponse.getString().trim());
  Set<String> footerCssSet=new LinkedHashSet<String>();
  Set<String> footerJavaScriptSet=new LinkedHashSet<String>();
  Set<String> headerCssSet=new LinkedHashSet<String>();
  Set<String> headerJavaScriptSet=new LinkedHashSet<String>();
  boolean portletOnLayout=false;
  String rootPortletId=getRootPortletId(portlet);
  String portletId=portlet.getPortletId();
  for (  Portlet layoutPortlet : layoutTypePortlet.getAllPortlets()) {
    String layoutPortletRootPortletId=getRootPortletId(layoutPortlet);
    if (rootPortletId.equals(layoutPortletRootPortletId) && !portletId.equals(layoutPortlet.getPortletId())) {
      portletOnLayout=true;
      break;
    }
  }
  PortletApp portletApp=portlet.getPortletApp();
  if (!portletOnLayout) {
    Portlet rootPortlet=portlet.getRootPortlet();
    for (    String footerPortalCss : portlet.getFooterPortalCss()) {
      if (!HttpUtil.hasProtocol(footerPortalCss)) {
        footerPortalCss=portletApp.getContextPath() + footerPortalCss;
        footerPortalCss=PortalUtil.getStaticResourceURL(request,footerPortalCss,rootPortlet.getTimestamp());
      }
      footerCssSet.add(footerPortalCss);
    }
    for (    String footerPortalJavaScript : portlet.getFooterPortalJavaScript()) {
      if (!HttpUtil.hasProtocol(footerPortalJavaScript)) {
        footerPortalJavaScript=portletApp.getContextPath() + footerPortalJavaScript;
        footerPortalJavaScript=PortalUtil.getStaticResourceURL(request,footerPortalJavaScript,rootPortlet.getTimestamp());
      }
      footerJavaScriptSet.add(footerPortalJavaScript);
    }
    for (    String footerPortletCss : portlet.getFooterPortletCss()) {
      if (!HttpUtil.hasProtocol(footerPortletCss)) {
        footerPortletCss=portletApp.getContextPath() + footerPortletCss;
        footerPortletCss=PortalUtil.getStaticResourceURL(request,footerPortletCss,rootPortlet.getTimestamp());
      }
      footerCssSet.add(footerPortletCss);
    }
    for (    String footerPortletJavaScript : portlet.getFooterPortletJavaScript()) {
      if (!HttpUtil.hasProtocol(footerPortletJavaScript)) {
        footerPortletJavaScript=portletApp.getContextPath() + footerPortletJavaScript;
        footerPortletJavaScript=PortalUtil.getStaticResourceURL(request,footerPortletJavaScript,rootPortlet.getTimestamp());
      }
      footerJavaScriptSet.add(footerPortletJavaScript);
    }
    for (    String headerPortalCss : portlet.getHeaderPortalCss()) {
      if (!HttpUtil.hasProtocol(headerPortalCss)) {
        headerPortalCss=portletApp.getContextPath() + headerPortalCss;
        headerPortalCss=PortalUtil.getStaticResourceURL(request,headerPortalCss,rootPortlet.getTimestamp());
      }
      headerCssSet.add(headerPortalCss);
    }
    for (    String headerPortalJavaScript : portlet.getHeaderPortalJavaScript()) {
      if (!HttpUtil.hasProtocol(headerPortalJavaScript)) {
        headerPortalJavaScript=portletApp.getContextPath() + headerPortalJavaScript;
        headerPortalJavaScript=PortalUtil.getStaticResourceURL(request,headerPortalJavaScript,rootPortlet.getTimestamp());
      }
      headerJavaScriptSet.add(headerPortalJavaScript);
    }
    for (    String headerPortletCss : portlet.getHeaderPortletCss()) {
      if (!HttpUtil.hasProtocol(headerPortletCss)) {
        headerPortletCss=portletApp.getContextPath() + headerPortletCss;
        headerPortletCss=PortalUtil.getStaticResourceURL(request,headerPortletCss,rootPortlet.getTimestamp());
      }
      headerCssSet.add(headerPortletCss);
    }
    for (    String headerPortletJavaScript : portlet.getHeaderPortletJavaScript()) {
      if (!HttpUtil.hasProtocol(headerPortletJavaScript)) {
        headerPortletJavaScript=portletApp.getContextPath() + headerPortletJavaScript;
        headerPortletJavaScript=PortalUtil.getStaticResourceURL(request,headerPortletJavaScript,rootPortlet.getTimestamp());
      }
      headerJavaScriptSet.add(headerPortletJavaScript);
    }
  }
  String footerCssPaths=JSONFactoryUtil.serialize(footerCssSet.toArray(new String[footerCssSet.size()]));
  jsonObject.put("footerCssPaths",JSONFactoryUtil.createJSONArray(footerCssPaths));
  String footerJavaScriptPaths=JSONFactoryUtil.serialize(footerJavaScriptSet.toArray(new String[footerJavaScriptSet.size()]));
  jsonObject.put("footerJavaScriptPaths",JSONFactoryUtil.createJSONArray(footerJavaScriptPaths));
  String headerCssPaths=JSONFactoryUtil.serialize(headerCssSet.toArray(new String[headerCssSet.size()]));
  jsonObject.put("headerCssPaths",JSONFactoryUtil.createJSONArray(headerCssPaths));
  String headerJavaScriptPaths=JSONFactoryUtil.serialize(headerJavaScriptSet.toArray(new String[headerJavaScriptSet.size()]));
  jsonObject.put("headerJavaScriptPaths",JSONFactoryUtil.createJSONArray(headerJavaScriptPaths));
}
