{
  ThemeDisplay themeDisplay=(ThemeDisplay)request.getAttribute(WebKeys.THEME_DISPLAY);
  LayoutTypePortlet layoutTypePortlet=themeDisplay.getLayoutTypePortlet();
  jsonObject.put("refresh",false);
  jsonObject.put("portletHTML",stringResponse.getString().trim());
  Set<String> footerCssSet=new LinkedHashSet<String>();
  Set<String> footerJavaScriptSet=new LinkedHashSet<String>();
  Set<String> headerCssSet=new LinkedHashSet<String>();
  Set<String> headerJavaScriptSet=new LinkedHashSet<String>();
  boolean portletOnLayout=false;
  for (  Portlet layoutPortlet : layoutTypePortlet.getAllPortlets()) {
    String rootPortletId=portlet.getRootPortletId();
    String layoutRootPortletId=layoutPortlet.getRootPortletId();
    if (rootPortletId.equals(layoutRootPortletId)) {
      portletOnLayout=true;
      break;
    }
  }
  long timestamp=portlet.getTimestamp();
  String portalContextPath=PortalUtil.getPathContext();
  String portletContextPath=portlet.getStaticResourcePath();
  addResourcePaths(request,portalContextPath,portlet.getFooterPortalCss(),timestamp,portletOnLayout,footerCssSet);
  addResourcePaths(request,portalContextPath,portlet.getFooterPortalJavaScript(),timestamp,portletOnLayout,footerJavaScriptSet);
  addResourcePaths(request,portletContextPath,portlet.getFooterPortletCss(),timestamp,portletOnLayout,footerCssSet);
  addResourcePaths(request,portletContextPath,portlet.getFooterPortletJavaScript(),timestamp,portletOnLayout,footerJavaScriptSet);
  addResourcePaths(request,portalContextPath,portlet.getHeaderPortalCss(),timestamp,portletOnLayout,headerCssSet);
  addResourcePaths(request,portalContextPath,portlet.getHeaderPortalJavaScript(),timestamp,portletOnLayout,headerJavaScriptSet);
  addResourcePaths(request,portletContextPath,portlet.getHeaderPortletCss(),timestamp,portletOnLayout,headerCssSet);
  addResourcePaths(request,portletContextPath,portlet.getHeaderPortletJavaScript(),timestamp,portletOnLayout,headerJavaScriptSet);
  String footerCssPaths=JSONFactoryUtil.serialize(footerCssSet.toArray(new String[footerCssSet.size()]));
  jsonObject.put("footerCssPaths",JSONFactoryUtil.createJSONArray(footerCssPaths));
  String footerJavaScriptPaths=JSONFactoryUtil.serialize(footerJavaScriptSet.toArray(new String[footerJavaScriptSet.size()]));
  jsonObject.put("footerJavaScriptPaths",JSONFactoryUtil.createJSONArray(footerJavaScriptPaths));
  String headerCssPaths=JSONFactoryUtil.serialize(headerCssSet.toArray(new String[headerCssSet.size()]));
  jsonObject.put("headerCssPaths",JSONFactoryUtil.createJSONArray(headerCssPaths));
  String headerJavaScriptPaths=JSONFactoryUtil.serialize(headerJavaScriptSet.toArray(new String[headerJavaScriptSet.size()]));
  jsonObject.put("headerJavaScriptPaths",JSONFactoryUtil.createJSONArray(headerJavaScriptPaths));
}
