{
  ThemeDisplay themeDisplay=(ThemeDisplay)req.getAttribute(WebKeys.THEME_DISPLAY);
  long userId=themeDisplay.getUserId();
  Layout layout=themeDisplay.getLayout();
  LayoutTypePortlet layoutTypePortlet=themeDisplay.getLayoutTypePortlet();
  PermissionChecker permissionChecker=themeDisplay.getPermissionChecker();
  String cmd=ParamUtil.getString(req,Constants.CMD);
  String portletId=ParamUtil.getString(req,"p_p_id");
  boolean updateLayout=true;
  boolean deletePortlet=false;
  if (cmd.equals(Constants.ADD)) {
    portletId=layoutTypePortlet.addPortletId(userId,portletId);
    String columnId=ParamUtil.getString(req,"p_p_col_id");
    int columnPos=ParamUtil.getInteger(req,"p_p_col_pos");
    if (Validator.isNotNull(columnId)) {
      layoutTypePortlet.movePortletId(userId,portletId,columnId,columnPos);
    }
  }
 else   if (cmd.equals(Constants.DELETE)) {
    if (layoutTypePortlet.hasPortletId(portletId)) {
      deletePortlet=true;
      layoutTypePortlet.removePortletId(portletId);
    }
  }
 else   if (cmd.equals("drag")) {
    if (LayoutPermissionUtil.contains(permissionChecker,layout.getGroupId(),layout.isPrivateLayout(),layout.getLayoutId(),ActionKeys.UPDATE)) {
      String height=ParamUtil.getString(req,"height");
      String width=ParamUtil.getString(req,"width");
      String top=ParamUtil.getString(req,"top");
      String left=ParamUtil.getString(req,"left");
      PortletPreferences prefs=PortletPreferencesFactoryUtil.getLayoutPortletSetup(layout,portletId);
      StringMaker sm=new StringMaker();
      sm.append("height=" + height + "\n");
      sm.append("width=" + width + "\n");
      sm.append("top=" + top + "\n");
      sm.append("left=" + left + "\n");
      prefs.setValue("portlet-freeform-styles",sm.toString());
      prefs.store();
    }
  }
 else   if (cmd.equals("minimize")) {
    boolean restore=ParamUtil.getBoolean(req,"p_p_restore");
    if (restore) {
      layoutTypePortlet.removeStateMinPortletId(portletId);
    }
 else {
      layoutTypePortlet.addStateMinPortletId(portletId);
    }
    updateLayout=false;
  }
 else   if (cmd.equals("move")) {
    String columnId=ParamUtil.getString(req,"p_p_col_id");
    int columnPos=ParamUtil.getInteger(req,"p_p_col_pos");
    layoutTypePortlet.movePortletId(userId,portletId,columnId,columnPos);
  }
 else   if (cmd.equals("template")) {
    String layoutTemplateId=ParamUtil.getString(req,"layoutTemplateId");
    layoutTypePortlet.setLayoutTemplateId(userId,layoutTemplateId);
  }
  if (updateLayout) {
    layoutTypePortlet.resetStates();
    LayoutServiceUtil.updateLayout(layout.getGroupId(),layout.isPrivateLayout(),layout.getLayoutId(),layout.getTypeSettings());
    if (deletePortlet) {
      String rootPortletId=PortletConstants.getRootPortletId(portletId);
      ResourceLocalServiceUtil.deleteResource(layout.getCompanyId(),rootPortletId,ResourceConstants.SCOPE_INDIVIDUAL,PortletPermissionUtil.getPrimaryKey(layout.getPlid(),portletId));
    }
  }
 else {
    LayoutClone layoutClone=LayoutCloneFactory.getInstance();
    if (layoutClone != null) {
      layoutClone.update(req,layout.getPlid(),layout.getTypeSettings());
    }
  }
  if (ParamUtil.getBoolean(req,"refresh")) {
    return mapping.findForward(ActionConstants.COMMON_REFERER);
  }
 else {
    if (cmd.equals(Constants.ADD) && (portletId != null)) {
      Action renderPortletAction=(Action)InstancePool.get(RenderPortletAction.class.getName());
      long companyId=PortalUtil.getCompanyId(req);
      Portlet portlet=PortletLocalServiceUtil.getPortletById(companyId,portletId);
      DynamicServletRequest dynamicReq=null;
      if (portlet.isPrivateRequestAttributes()) {
        String portletNamespace=PortalUtil.getPortletNamespace(portlet.getPortletId());
        dynamicReq=new NamespaceServletRequest(req,portletNamespace,portletNamespace);
      }
 else {
        dynamicReq=new DynamicServletRequest(req);
      }
      dynamicReq.setParameter("p_p_id",portletId);
      renderPortletAction.execute(mapping,form,dynamicReq,res);
    }
    return null;
  }
}
