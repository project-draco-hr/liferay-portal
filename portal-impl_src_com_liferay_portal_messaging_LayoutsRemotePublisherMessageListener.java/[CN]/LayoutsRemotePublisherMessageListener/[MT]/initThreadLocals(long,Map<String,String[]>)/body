{
  User user=UserLocalServiceUtil.getUserById(userId);
  CompanyThreadLocal.setCompanyId(user.getCompanyId());
  PermissionChecker permissionChecker=PermissionCheckerFactoryUtil.create(user);
  PermissionThreadLocal.setPermissionChecker(permissionChecker);
  PrincipalThreadLocal.setName(user.getUserId());
  ServiceContext serviceContext=new ServiceContext();
  serviceContext.setCompanyId(user.getCompanyId());
  serviceContext.setPathMain(PortalUtil.getPathMain());
  serviceContext.setSignedIn(!user.isDefaultUser());
  serviceContext.setUserId(user.getUserId());
  Map<String,Serializable> attributes=new HashMap<String,Serializable>();
  for (  Map.Entry<String,String[]> entry : parameterMap.entrySet()) {
    String param=entry.getKey();
    String[] values=entry.getValue();
    if ((values != null) && (values.length > 0)) {
      if (values.length == 1) {
        attributes.put(param,values[0]);
      }
 else {
        attributes.put(param,values);
      }
    }
  }
  serviceContext.setAttributes(attributes);
  ServiceContextThreadLocal.pushServiceContext(serviceContext);
}
