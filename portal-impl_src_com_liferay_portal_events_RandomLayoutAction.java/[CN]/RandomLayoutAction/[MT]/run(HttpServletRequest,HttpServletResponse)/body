{
  try {
    PropsUtil.set(PropsKeys.LAST_MODIFIED_CHECK,"false");
    ThemeDisplay themeDisplay=(ThemeDisplay)request.getAttribute(WebKeys.THEME_DISPLAY);
    if (!themeDisplay.isSignedIn()) {
      return;
    }
    String requestURI=GetterUtil.getString(request.getRequestURI());
    if (!requestURI.endsWith("/portal/layout")) {
      return;
    }
    Layout layout=themeDisplay.getLayout();
    if (layout == null) {
      return;
    }
    Group generalGuestGroup=GroupLocalServiceUtil.getGroup(themeDisplay.getCompanyId(),GroupConstants.GUEST);
    List<Layout> layouts=LayoutLocalServiceUtil.getLayouts(generalGuestGroup.getGroupId(),false);
    if (layouts.size() > 0) {
      Layout randomLayout=layouts.get(Randomizer.getInstance().nextInt(layouts.size()));
      themeDisplay.setLayout(randomLayout);
      themeDisplay.setLayoutTypePortlet((LayoutTypePortlet)randomLayout.getLayoutType());
      request.setAttribute(WebKeys.LAYOUT,randomLayout);
    }
  }
 catch (  Exception e) {
    _log.error(e,e);
    throw new ActionException(e);
  }
}
