{
  User user=userPersistence.findByPrimaryKey(userId);
  long classNameId=PortalUtil.getClassNameId(className);
  Date now=new Date();
  long subscriptionId=counterLocalService.increment();
  Subscription subscription=null;
  try {
    subscription=subscriptionPersistence.findByC_U_C_C(user.getCompanyId(),userId,classNameId,classPK);
  }
 catch (  NoSuchSubscriptionException nssb) {
    subscription=subscriptionPersistence.create(subscriptionId);
    subscription.setCompanyId(user.getCompanyId());
    subscription.setUserId(user.getUserId());
    subscription.setUserName(user.getFullName());
    subscription.setCreateDate(now);
    subscription.setModifiedDate(now);
    subscription.setClassNameId(classNameId);
    subscription.setClassPK(classPK);
    subscription.setFrequency(frequency);
    subscriptionPersistence.update(subscription,false);
  }
 finally {
    return subscription;
  }
}
