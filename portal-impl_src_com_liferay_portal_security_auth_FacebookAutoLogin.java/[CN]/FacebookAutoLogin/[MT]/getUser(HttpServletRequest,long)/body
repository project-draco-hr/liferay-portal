{
  HttpSession session=request.getSession();
  String emailAddress=(String)session.getAttribute(WebKeys.FACEBOOK_USER_EMAIL_ADDRESS);
  if (Validator.isNotNull(emailAddress)) {
    session.removeAttribute(WebKeys.FACEBOOK_USER_EMAIL_ADDRESS);
    return UserLocalServiceUtil.getUserByEmailAddress(companyId,emailAddress);
  }
 else {
    long facebookId=GetterUtil.getLong((String)session.getAttribute(WebKeys.FACEBOOK_USER_ID));
    return UserLocalServiceUtil.getUserByFacebookId(companyId,facebookId);
  }
}
