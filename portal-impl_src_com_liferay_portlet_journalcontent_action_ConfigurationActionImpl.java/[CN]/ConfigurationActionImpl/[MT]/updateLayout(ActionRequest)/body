{
  ThemeDisplay themeDisplay=(ThemeDisplay)actionRequest.getAttribute(WebKeys.THEME_DISPLAY);
  String articleId=getParameter(actionRequest,"articleId").toUpperCase();
  if (Validator.isNotNull(articleId)) {
    Layout layout=themeDisplay.getLayout();
    LayoutTypePortlet layoutTypePortlet=themeDisplay.getLayoutTypePortlet();
    String portletResource=ParamUtil.getString(actionRequest,"portletResource");
    String portletIds=StringPool.BLANK;
    JournalArticle journalArticle;
    Group companyGroup=GroupLocalServiceUtil.getCompanyGroup(themeDisplay.getCompanyId());
    try {
      journalArticle=JournalArticleLocalServiceUtil.getDisplayArticle(themeDisplay.getScopeGroupId(),articleId);
    }
 catch (    NoSuchArticleException nsae) {
      journalArticle=JournalArticleLocalServiceUtil.getDisplayArticle(companyGroup.getGroupId(),articleId);
    }
    portletIds=PortletLogic.getRuntimePortletIds(journalArticle.getContent());
    if (Validator.isNotNull(journalArticle.getTemplateId())) {
      JournalTemplate journalTemplate;
      try {
        journalTemplate=JournalTemplateLocalServiceUtil.getTemplate(themeDisplay.getScopeGroupId(),journalArticle.getTemplateId());
      }
 catch (      NoSuchTemplateException nste) {
        journalTemplate=JournalTemplateLocalServiceUtil.getTemplate(companyGroup.getGroupId(),journalArticle.getTemplateId());
      }
      portletIds=StringUtil.add(portletIds,PortletLogic.getRuntimePortletIds(journalTemplate.getXsl()));
    }
    layoutTypePortlet.setPortletIds(LayoutTypePortletConstants.RUNTIME_PORTLET_NAMESPACE + portletResource,portletIds);
    LayoutLocalServiceUtil.updateLayout(layout.getGroupId(),layout.isPrivateLayout(),layout.getLayoutId(),layout.getTypeSettings());
  }
}
