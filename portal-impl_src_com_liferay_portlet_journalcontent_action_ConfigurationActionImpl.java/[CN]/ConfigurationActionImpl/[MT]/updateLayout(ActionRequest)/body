{
  ThemeDisplay themeDisplay=(ThemeDisplay)actionRequest.getAttribute(WebKeys.THEME_DISPLAY);
  String articleId=getParameter(actionRequest,"articleId").toUpperCase();
  if (Validator.isNull(articleId)) {
    return;
  }
  LayoutTypePortlet layoutTypePortlet=themeDisplay.getLayoutTypePortlet();
  String portletResource=ParamUtil.getString(actionRequest,"portletResource");
  JournalArticle journalArticle=null;
  Group companyGroup=GroupLocalServiceUtil.getCompanyGroup(themeDisplay.getCompanyId());
  try {
    journalArticle=JournalArticleLocalServiceUtil.getDisplayArticle(themeDisplay.getScopeGroupId(),articleId);
  }
 catch (  NoSuchArticleException nsae) {
    journalArticle=JournalArticleLocalServiceUtil.getDisplayArticle(companyGroup.getGroupId(),articleId);
  }
  String portletIds=PortletLogic.getRuntimePortletIds(journalArticle.getContent());
  if (Validator.isNotNull(journalArticle.getTemplateId())) {
    JournalTemplate journalTemplate;
    try {
      journalTemplate=JournalTemplateLocalServiceUtil.getTemplate(themeDisplay.getScopeGroupId(),journalArticle.getTemplateId());
    }
 catch (    NoSuchTemplateException nste) {
      journalTemplate=JournalTemplateLocalServiceUtil.getTemplate(companyGroup.getGroupId(),journalArticle.getTemplateId());
    }
    portletIds=StringUtil.add(portletIds,PortletLogic.getRuntimePortletIds(journalTemplate.getXsl()));
  }
  layoutTypePortlet.setPortletIds(LayoutTypePortletConstants.RUNTIME_PORTLET_NAMESPACE + portletResource,portletIds);
  Layout layout=themeDisplay.getLayout();
  LayoutLocalServiceUtil.updateLayout(layout.getGroupId(),layout.isPrivateLayout(),layout.getLayoutId(),layout.getTypeSettings());
}
