{
  InputStream deltaInputStream=null;
  FileEntry fileEntry=dlAppLocalService.getFileEntry(fileEntryId);
  InputStream sourceInputStream=null;
  File sourceFile=FileUtil.createTempFile();
  FileInputStream sourceFileInputStream=null;
  FileChannel sourceFileChannel=null;
  File checksumsFile=FileUtil.createTempFile();
  OutputStream checksumsOutputStream=null;
  WritableByteChannel checksumsWritableByteChannel=null;
  try {
    sourceInputStream=fileEntry.getContentStream(sourceVersion);
    FileUtil.write(sourceFile,sourceInputStream);
    sourceFileInputStream=new FileInputStream(sourceFile);
    sourceFileChannel=sourceFileInputStream.getChannel();
    checksumsOutputStream=new FileOutputStream(checksumsFile);
    checksumsWritableByteChannel=Channels.newChannel(checksumsOutputStream);
    ByteChannelWriter checksumsByteChannelWriter=new ByteChannelWriter(checksumsWritableByteChannel);
    DeltaUtil.checksums(sourceFileChannel,checksumsByteChannelWriter);
    checksumsByteChannelWriter.finish();
  }
 catch (  Exception e) {
    throw new PortalException(e);
  }
 finally {
    StreamUtil.cleanUp(sourceFileInputStream);
    StreamUtil.cleanUp(sourceFileChannel);
    StreamUtil.cleanUp(checksumsOutputStream);
    StreamUtil.cleanUp(checksumsWritableByteChannel);
    FileUtil.delete(sourceFile);
  }
  InputStream destinationInputStream=null;
  ReadableByteChannel destinationReadableByteChannel=null;
  InputStream checksumsInputStream=null;
  ReadableByteChannel checksumsReadableByteChannel=null;
  OutputStream deltaOutputStream=null;
  WritableByteChannel deltaOutputStreamWritableByteChannel=null;
  try {
    destinationInputStream=fileEntry.getContentStream(destinationVersion);
    destinationReadableByteChannel=Channels.newChannel(destinationInputStream);
    checksumsInputStream=new FileInputStream(checksumsFile);
    checksumsReadableByteChannel=Channels.newChannel(checksumsInputStream);
    ByteChannelReader checksumsByteChannelReader=new ByteChannelReader(checksumsReadableByteChannel);
    File deltaFile=FileUtil.createTempFile();
    deltaOutputStream=new FileOutputStream(deltaFile);
    deltaOutputStreamWritableByteChannel=Channels.newChannel(deltaOutputStream);
    ByteChannelWriter deltaByteChannelWriter=new ByteChannelWriter(deltaOutputStreamWritableByteChannel);
    DeltaUtil.delta(destinationReadableByteChannel,checksumsByteChannelReader,deltaByteChannelWriter);
    deltaByteChannelWriter.finish();
    deltaInputStream=new FileInputStream(deltaFile);
  }
 catch (  Exception e) {
    throw new PortalException(e);
  }
 finally {
    StreamUtil.cleanUp(destinationInputStream);
    StreamUtil.cleanUp(destinationReadableByteChannel);
    StreamUtil.cleanUp(checksumsInputStream);
    StreamUtil.cleanUp(checksumsReadableByteChannel);
    StreamUtil.cleanUp(deltaOutputStream);
    StreamUtil.cleanUp(deltaOutputStreamWritableByteChannel);
    FileUtil.delete(checksumsFile);
  }
  return deltaInputStream;
}
