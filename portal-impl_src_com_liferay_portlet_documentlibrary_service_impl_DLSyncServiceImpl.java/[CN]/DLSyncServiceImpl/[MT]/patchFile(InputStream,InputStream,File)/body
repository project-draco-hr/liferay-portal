{
  FileOutputStream patchedFileOutputStream=null;
  File originalTempFile=null;
  FileInputStream originalFileInputStream=null;
  ReadableByteChannel deltaChannel=null;
  try {
    patchedFileOutputStream=new FileOutputStream(patchedFile);
    originalTempFile=FileUtil.createTempFile();
    FileUtil.write(originalTempFile,originalInputStream);
    originalFileInputStream=new FileInputStream(originalTempFile);
    deltaChannel=Channels.newChannel(deltaInputStream);
    ByteChannelReader deltaReader=new ByteChannelReader(deltaChannel);
    LDiff.patch(originalFileInputStream.getChannel(),Channels.newChannel(patchedFileOutputStream),deltaReader);
  }
 catch (  Exception e) {
    throw new PortalException(e);
  }
 finally {
    StreamUtil.cleanUp(patchedFileOutputStream);
    StreamUtil.cleanUp(originalFileInputStream);
    StreamUtil.cleanUp(deltaChannel);
    FileUtil.delete(originalTempFile);
  }
}
