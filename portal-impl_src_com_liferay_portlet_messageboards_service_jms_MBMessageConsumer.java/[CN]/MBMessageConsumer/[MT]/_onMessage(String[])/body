{
  long companyId=GetterUtil.getLong(array[0]);
  long userId=GetterUtil.getLong(array[1]);
  String[] categoryIds=StringUtil.split(array[2]);
  String threadId=array[3];
  String fromName=array[4];
  String fromAddress=array[5];
  String subject=array[6];
  String body=array[7];
  String replyToAddress=array[8];
  String messageId=array[9];
  String inReplyTo=array[10];
  Set sent=CollectionFactory.getHashSet();
  if (_log.isInfoEnabled()) {
    _log.info("Sending notification for message " + messageId + " (thread: "+ threadId+ ", categories + "+ array[2]+ ")");
  }
  List subscriptions=SubscriptionLocalServiceUtil.getSubscriptions(companyId,MBThread.class.getName(),GetterUtil.getLong(threadId));
  _sendEmail(userId,fromName,fromAddress,subject,body,subscriptions,sent,replyToAddress,messageId,inReplyTo);
  for (int i=0; i < categoryIds.length; i++) {
    subscriptions=SubscriptionLocalServiceUtil.getSubscriptions(companyId,MBCategory.class.getName(),GetterUtil.getLong(categoryIds[i]));
    _sendEmail(userId,fromName,fromAddress,subject,body,subscriptions,sent,replyToAddress,messageId,inReplyTo);
  }
  if (_log.isDebugEnabled()) {
    _log.debug("Notifications sent to the following subscribers of message " + messageId + " (thread: "+ threadId+ ", categories + "+ array[2]+ ") :"+ sent);
  }
}
