{
  long companyId=GetterUtil.getLong(array[0]);
  long userId=GetterUtil.getLong(array[1]);
  String[] categoryIds=StringUtil.split(array[2]);
  String threadId=array[3];
  String fromName=array[4];
  String fromAddress=array[5];
  String subject=array[6];
  String body=array[7];
  String replyToAddress=array[8];
  String mailId=array[9];
  String inReplyTo=array[10];
  boolean htmlFormat=GetterUtil.getBoolean(array[11]);
  Set sent=CollectionFactory.getHashSet();
  if (_log.isInfoEnabled()) {
    _log.info("Sending notifications for {mailId=" + mailId + ", threadId="+ threadId+ ", categoryIds="+ array[2]+ "}");
  }
  List subscriptions=SubscriptionLocalServiceUtil.getSubscriptions(companyId,MBThread.class.getName(),GetterUtil.getLong(threadId));
  _sendEmail(userId,fromName,fromAddress,subject,body,subscriptions,sent,replyToAddress,mailId,inReplyTo,htmlFormat);
  for (int i=0; i < categoryIds.length; i++) {
    subscriptions=SubscriptionLocalServiceUtil.getSubscriptions(companyId,MBCategory.class.getName(),GetterUtil.getLong(categoryIds[i]));
    _sendEmail(userId,fromName,fromAddress,subject,body,subscriptions,sent,replyToAddress,mailId,inReplyTo,htmlFormat);
  }
  if (_log.isInfoEnabled()) {
    _log.info("Finished sending notifications");
  }
}
