{
  try {
    ThemeDisplay themeDisplay=(ThemeDisplay)request.getAttribute(WebKeys.THEME_DISPLAY);
    Theme theme=themeDisplay.getTheme();
    ColorScheme colorScheme=themeDisplay.getColorScheme();
    if (theme != null) {
      if (_log.isInfoEnabled()) {
        _log.info("Theme already set, skipping");
      }
      return;
    }
    Layout layout=themeDisplay.getLayout();
    long companyId=themeDisplay.getCompanyId();
    boolean wapTheme=BrowserSnifferUtil.isWap(request);
    String contextPath=PortalUtil.getPathContext();
    if (layout != null) {
      if (wapTheme) {
        theme=layout.getWapTheme();
        colorScheme=layout.getWapColorScheme();
      }
 else {
        theme=layout.getTheme();
        colorScheme=layout.getColorScheme();
      }
    }
 else {
      String themeId=null;
      String colorSchemeId=null;
      if (wapTheme) {
        themeId=ThemeImpl.getDefaultWapThemeId(companyId);
        colorSchemeId=ColorSchemeImpl.getDefaultWapColorSchemeId();
      }
 else {
        themeId=ThemeImpl.getDefaultRegularThemeId(companyId);
        colorSchemeId=ColorSchemeImpl.getDefaultRegularColorSchemeId();
      }
      theme=ThemeLocalServiceUtil.getTheme(companyId,themeId,wapTheme);
      colorScheme=ThemeLocalServiceUtil.getColorScheme(companyId,theme.getThemeId(),colorSchemeId,wapTheme);
    }
    request.setAttribute(WebKeys.THEME,theme);
    request.setAttribute(WebKeys.COLOR_SCHEME,colorScheme);
    themeDisplay.setLookAndFeel(contextPath,theme,colorScheme);
  }
 catch (  Exception e) {
    throw new ActionException(e);
  }
}
