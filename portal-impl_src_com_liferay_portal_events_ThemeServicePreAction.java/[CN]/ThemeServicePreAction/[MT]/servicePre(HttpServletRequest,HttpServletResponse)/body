{
  ThemeDisplay themeDisplay=(ThemeDisplay)request.getAttribute(WebKeys.THEME_DISPLAY);
  Theme theme=themeDisplay.getTheme();
  ColorScheme colorScheme=themeDisplay.getColorScheme();
  if (theme != null) {
    if (_log.isInfoEnabled()) {
      _log.info("Theme is already set");
    }
    return;
  }
  Layout layout=themeDisplay.getLayout();
  if (layout != null) {
    theme=layout.getTheme();
    colorScheme=layout.getColorScheme();
  }
 else {
    String themeId=ThemeFactoryUtil.getDefaultRegularThemeId(themeDisplay.getCompanyId());
    String colorSchemeId=ColorSchemeFactoryUtil.getDefaultRegularColorSchemeId();
    theme=ThemeLocalServiceUtil.getTheme(themeDisplay.getCompanyId(),themeId);
    colorScheme=ThemeLocalServiceUtil.getColorScheme(themeDisplay.getCompanyId(),theme.getThemeId(),colorSchemeId);
  }
  request.setAttribute(WebKeys.COLOR_SCHEME,colorScheme);
  request.setAttribute(WebKeys.THEME,theme);
  themeDisplay.setLookAndFeel(theme,colorScheme);
}
