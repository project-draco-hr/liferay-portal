{
  ThemeDisplay themeDisplay=(ThemeDisplay)request.getAttribute(WebKeys.THEME_DISPLAY);
  Theme theme=themeDisplay.getTheme();
  ColorScheme colorScheme=themeDisplay.getColorScheme();
  if (theme != null) {
    if (_log.isInfoEnabled()) {
      _log.info("Theme is already set");
    }
    return;
  }
  Layout layout=themeDisplay.getLayout();
  boolean wapTheme=BrowserSnifferUtil.isWap(request);
  if (layout != null) {
    if (wapTheme) {
      theme=layout.getWapTheme();
      colorScheme=layout.getWapColorScheme();
    }
 else {
      theme=layout.getTheme();
      colorScheme=layout.getColorScheme();
    }
  }
 else {
    String themeId=null;
    String colorSchemeId=null;
    if (wapTheme) {
      themeId=ThemeImpl.getDefaultWapThemeId(themeDisplay.getCompanyId());
      colorSchemeId=ColorScheme.DEFAULT_WAP_COLOR_SCHEME_ID;
    }
 else {
      themeId=ThemeImpl.getDefaultRegularThemeId(themeDisplay.getCompanyId());
      colorSchemeId=ColorScheme.DEFAULT_REGULAR_COLOR_SCHEME_ID;
    }
    theme=ThemeLocalServiceUtil.getTheme(themeDisplay.getCompanyId(),themeId,wapTheme);
    colorScheme=ThemeLocalServiceUtil.getColorScheme(themeDisplay.getCompanyId(),theme.getThemeId(),colorSchemeId,wapTheme);
  }
  request.setAttribute(WebKeys.THEME,theme);
  request.setAttribute(WebKeys.COLOR_SCHEME,colorScheme);
  themeDisplay.setLookAndFeel(theme,colorScheme);
}
