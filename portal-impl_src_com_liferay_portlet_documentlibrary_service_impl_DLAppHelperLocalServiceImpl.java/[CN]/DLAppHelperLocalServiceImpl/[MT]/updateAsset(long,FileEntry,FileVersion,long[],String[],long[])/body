{
  AssetEntry assetEntry=null;
  boolean visible=false;
  boolean addDraftAssetEntry=false;
  if (fileEntry instanceof LiferayFileEntry) {
    DLFileVersion dlFileVersion=(DLFileVersion)fileVersion.getModel();
    if (dlFileVersion.isApproved()) {
      visible=true;
    }
 else {
      String version=dlFileVersion.getVersion();
      if (!version.equals(DLFileEntryConstants.VERSION_DEFAULT)) {
        addDraftAssetEntry=true;
      }
    }
  }
 else {
    visible=true;
  }
  long fileEntryTypeId=getFileEntryTypeId(fileEntry);
  if (addDraftAssetEntry) {
    if (assetCategoryIds == null) {
      assetCategoryIds=assetCategoryLocalService.getCategoryIds(DLFileEntryConstants.getClassName(),fileEntry.getFileEntryId());
    }
    if (assetTagNames == null) {
      assetTagNames=assetTagLocalService.getTagNames(DLFileEntryConstants.getClassName(),fileEntry.getFileEntryId());
    }
    if (assetLinkEntryIds == null) {
      AssetEntry previousAssetEntry=assetEntryLocalService.getEntry(DLFileEntryConstants.getClassName(),fileEntry.getFileEntryId());
      List<AssetLink> assetLinks=assetLinkLocalService.getDirectLinks(previousAssetEntry.getEntryId(),AssetLinkConstants.TYPE_RELATED);
      assetLinkEntryIds=ListUtil.toLongArray(assetLinks,AssetLink.ENTRY_ID2_ACCESSOR);
    }
    assetEntry=assetEntryLocalService.updateEntry(userId,fileEntry.getGroupId(),fileEntry.getCreateDate(),fileEntry.getModifiedDate(),DLFileEntryConstants.getClassName(),fileVersion.getFileVersionId(),fileEntry.getUuid(),fileEntryTypeId,assetCategoryIds,assetTagNames,true,false,null,null,null,fileEntry.getMimeType(),fileEntry.getTitle(),fileEntry.getDescription(),null,null,null,0,0,null);
  }
 else {
    assetEntry=assetEntryLocalService.updateEntry(userId,fileEntry.getGroupId(),fileEntry.getCreateDate(),fileEntry.getModifiedDate(),DLFileEntryConstants.getClassName(),fileEntry.getFileEntryId(),fileEntry.getUuid(),fileEntryTypeId,assetCategoryIds,assetTagNames,true,visible,null,null,null,fileEntry.getMimeType(),fileEntry.getTitle(),fileEntry.getDescription(),null,null,null,0,0,null);
    List<DLFileShortcut> dlFileShortcuts=dlFileShortcutPersistence.findByToFileEntryId(fileEntry.getFileEntryId());
    for (    DLFileShortcut dlFileShortcut : dlFileShortcuts) {
      assetEntryLocalService.updateEntry(userId,dlFileShortcut.getGroupId(),dlFileShortcut.getCreateDate(),dlFileShortcut.getModifiedDate(),DLFileShortcutConstants.getClassName(),dlFileShortcut.getFileShortcutId(),dlFileShortcut.getUuid(),fileEntryTypeId,assetCategoryIds,assetTagNames,true,true,null,null,null,fileEntry.getMimeType(),fileEntry.getTitle(),fileEntry.getDescription(),null,null,null,0,0,null);
    }
  }
  assetLinkLocalService.updateLinks(userId,assetEntry.getEntryId(),assetLinkEntryIds,AssetLinkConstants.TYPE_RELATED);
  return assetEntry;
}
