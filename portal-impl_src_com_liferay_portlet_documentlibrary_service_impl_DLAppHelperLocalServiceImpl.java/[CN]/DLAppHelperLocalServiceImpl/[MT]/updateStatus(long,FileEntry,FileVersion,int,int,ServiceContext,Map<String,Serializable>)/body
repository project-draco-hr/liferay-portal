{
  if (!DLAppHelperThreadLocal.isEnabled()) {
    return;
  }
  if (newStatus == WorkflowConstants.STATUS_APPROVED) {
    String latestFileVersionVersion=latestFileVersion.getVersion();
    if (latestFileVersionVersion.equals(fileEntry.getVersion())) {
      if (!latestFileVersionVersion.equals(DLFileEntryConstants.VERSION_DEFAULT)) {
        AssetEntry draftAssetEntry=assetEntryLocalService.fetchEntry(DLFileEntryConstants.getClassName(),latestFileVersion.getPrimaryKey());
        if (draftAssetEntry != null) {
          long fileEntryTypeId=getFileEntryTypeId(fileEntry);
          long[] assetCategoryIds=draftAssetEntry.getCategoryIds();
          String[] assetTagNames=draftAssetEntry.getTagNames();
          List<AssetLink> assetLinks=assetLinkLocalService.getDirectLinks(draftAssetEntry.getEntryId(),AssetLinkConstants.TYPE_RELATED);
          long[] assetLinkEntryIds=ListUtil.toLongArray(assetLinks,AssetLink.ENTRY_ID2_ACCESSOR);
          AssetEntry assetEntry=assetEntryLocalService.updateEntry(userId,fileEntry.getGroupId(),fileEntry.getCreateDate(),fileEntry.getModifiedDate(),DLFileEntryConstants.getClassName(),fileEntry.getFileEntryId(),fileEntry.getUuid(),fileEntryTypeId,assetCategoryIds,assetTagNames,true,null,null,null,draftAssetEntry.getMimeType(),fileEntry.getTitle(),fileEntry.getDescription(),null,null,null,0,0,null,false);
          assetLinkLocalService.updateLinks(userId,assetEntry.getEntryId(),assetLinkEntryIds,AssetLinkConstants.TYPE_RELATED);
          assetEntryLocalService.deleteEntry(draftAssetEntry);
        }
      }
      assetEntryLocalService.updateVisible(DLFileEntryConstants.getClassName(),fileEntry.getFileEntryId(),true);
    }
    String event=(String)workflowContext.get("event");
    if (Validator.isNotNull(event)) {
      triggerRepositoryEvent(fileEntry.getRepositoryId(),RepositoryEventTypeUtil.toSyncEvent(event),FileEntry.class,fileEntry);
    }
    if ((oldStatus != WorkflowConstants.STATUS_IN_TRASH) && !fileEntry.isInTrash()) {
      Date activityCreateDate=latestFileVersion.getModifiedDate();
      int activityType=DLActivityKeys.UPDATE_FILE_ENTRY;
      if (event.equals(DLSyncConstants.EVENT_ADD)) {
        activityCreateDate=latestFileVersion.getCreateDate();
        activityType=DLActivityKeys.ADD_FILE_ENTRY;
      }
      JSONObject extraDataJSONObject=JSONFactoryUtil.createJSONObject();
      extraDataJSONObject.put("title",fileEntry.getTitle());
      socialActivityLocalService.addUniqueActivity(latestFileVersion.getStatusByUserId(),fileEntry.getGroupId(),activityCreateDate,DLFileEntryConstants.getClassName(),fileEntry.getFileEntryId(),activityType,extraDataJSONObject.toString(),0);
      notifySubscribers(latestFileVersion,(String)workflowContext.get(WorkflowConstants.CONTEXT_URL),serviceContext);
    }
  }
 else {
    boolean visible=false;
    if (newStatus != WorkflowConstants.STATUS_IN_TRASH) {
      List<DLFileVersion> approvedFileVersions=dlFileVersionPersistence.findByF_S(fileEntry.getFileEntryId(),WorkflowConstants.STATUS_APPROVED);
      if (!approvedFileVersions.isEmpty()) {
        visible=true;
      }
    }
    assetEntryLocalService.updateVisible(DLFileEntryConstants.getClassName(),fileEntry.getFileEntryId(),visible);
  }
}
