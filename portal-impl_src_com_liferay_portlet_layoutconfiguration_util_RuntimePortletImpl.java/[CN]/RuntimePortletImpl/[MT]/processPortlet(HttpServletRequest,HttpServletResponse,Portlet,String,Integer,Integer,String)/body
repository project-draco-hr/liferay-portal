{
  if ((portlet != null) && portlet.isInstanceable() && !portlet.isAddDefaultResource()) {
    String instanceId=portlet.getInstanceId();
    if (!Validator.isPassword(instanceId)) {
      if (_log.isDebugEnabled()) {
        _log.debug("Portlet " + portlet.getPortletId() + " is instanceable but does not have a "+ "valid instance id");
      }
      portlet=null;
    }
  }
  if (portlet == null) {
    return;
  }
  ThemeDisplay themeDisplay=(ThemeDisplay)request.getAttribute(WebKeys.THEME_DISPLAY);
  PortletDisplay portletDisplay=themeDisplay.getPortletDisplay();
  PortletDisplay portletDisplayClone=PortletDisplayFactory.create();
  portletDisplay.copyTo(portletDisplayClone);
  PortletConfig portletConfig=(PortletConfig)request.getAttribute(JavaConstants.JAVAX_PORTLET_CONFIG);
  PortletRequest portletRequest=(PortletRequest)request.getAttribute(JavaConstants.JAVAX_PORTLET_REQUEST);
  if (!(portletRequest instanceof RenderRequest)) {
    portletRequest=null;
  }
  PortletResponse portletResponse=(PortletResponse)request.getAttribute(JavaConstants.JAVAX_PORTLET_RESPONSE);
  if (!(portletResponse instanceof RenderResponse)) {
    portletResponse=null;
  }
  String lifecycle=(String)request.getAttribute(PortletRequest.LIFECYCLE_PHASE);
  columnId=GetterUtil.getString(columnId);
  if (columnPos == null) {
    columnPos=Integer.valueOf(0);
  }
  if (columnCount == null) {
    columnCount=Integer.valueOf(0);
  }
  request.setAttribute(WebKeys.RENDER_PORTLET,portlet);
  request.setAttribute(WebKeys.RENDER_PORTLET_COLUMN_ID,columnId);
  request.setAttribute(WebKeys.RENDER_PORTLET_COLUMN_POS,columnPos);
  request.setAttribute(WebKeys.RENDER_PORTLET_COLUMN_COUNT,columnCount);
  if (path == null) {
    path="/html/portal/render_portlet.jsp";
  }
  RequestDispatcher requestDispatcher=DirectRequestDispatcherUtil.getRequestDispatcher(request,path);
  StringServletResponse stringServletResponse=null;
  boolean writeOutput=false;
  if (response instanceof StringServletResponse) {
    stringServletResponse=(StringServletResponse)response;
  }
 else {
    writeOutput=true;
    stringServletResponse=new StringServletResponse(response);
  }
  try {
    requestDispatcher.include(request,stringServletResponse);
    Boolean portletConfiguratorVisibility=(Boolean)request.getAttribute(WebKeys.PORTLET_CONFIGURATOR_VISIBILITY);
    if (portletConfiguratorVisibility != null) {
      request.removeAttribute(WebKeys.PORTLET_CONFIGURATOR_VISIBILITY);
      Layout layout=themeDisplay.getLayout();
      if (!layout.isTypeControlPanel() && !LayoutPermissionUtil.contains(themeDisplay.getPermissionChecker(),layout,ActionKeys.UPDATE) && !PortletPermissionUtil.contains(themeDisplay.getPermissionChecker(),themeDisplay.getPlid(),portlet.getPortletId(),ActionKeys.CONFIGURATION)) {
        response.setStatus(HttpServletResponse.SC_BAD_REQUEST);
        stringServletResponse.setString(StringPool.BLANK);
        return;
      }
    }
    if (writeOutput) {
      response.setContentType(ContentTypes.TEXT_HTML_UTF8);
      stringServletResponse.writeTo(response.getWriter());
    }
  }
  finally {
    portletDisplay.copyFrom(portletDisplayClone);
    portletDisplayClone.recycle();
    if (portletConfig != null) {
      request.setAttribute(JavaConstants.JAVAX_PORTLET_CONFIG,portletConfig);
    }
    if (portletRequest != null) {
      request.setAttribute(JavaConstants.JAVAX_PORTLET_REQUEST,portletRequest);
    }
    if (portletResponse != null) {
      request.setAttribute(JavaConstants.JAVAX_PORTLET_RESPONSE,portletResponse);
    }
    if (lifecycle != null) {
      request.setAttribute(PortletRequest.LIFECYCLE_PHASE,lifecycle);
    }
  }
}
