{
  if (category.isDiscussion()) {
    return;
  }
  PortletPreferences preferences=ServiceContextUtil.getPortletPreferences(serviceContext);
  if (preferences == null) {
    long ownerId=category.getGroupId();
    int ownerType=PortletKeys.PREFS_OWNER_TYPE_GROUP;
    long plid=PortletKeys.PREFS_PLID_SHARED;
    String portletId=PortletKeys.MESSAGE_BOARDS;
    String defaultPreferences=null;
    preferences=portletPreferencesLocalService.getPreferences(category.getCompanyId(),ownerId,ownerType,plid,portletId,defaultPreferences);
  }
  if (!update && MBUtil.getEmailMessageAddedEnabled(preferences)) {
  }
 else   if (update && MBUtil.getEmailMessageUpdatedEnabled(preferences)) {
  }
 else {
    return;
  }
  Company company=companyPersistence.findByPrimaryKey(message.getCompanyId());
  Group group=groupPersistence.findByPrimaryKey(category.getGroupId());
  User user=userPersistence.findByPrimaryKey(message.getUserId());
  String emailAddress=user.getEmailAddress();
  String fullName=user.getFullName();
  if (message.isAnonymous()) {
    emailAddress=StringPool.BLANK;
    fullName=LanguageUtil.get(ServiceContextUtil.getLocale(serviceContext),"anonymous");
  }
  List<Long> categoryIds=new ArrayList<Long>();
  categoryIds.add(category.getCategoryId());
  categoryIds.addAll(category.getAncestorCategoryIds());
  String messageURL=StringPool.BLANK;
  String portalURL=serviceContext.getPortalURL();
  String layoutURL=serviceContext.getLayoutURL();
  if (Validator.isNotNull(portalURL) && Validator.isNotNull(layoutURL)) {
    messageURL=portalURL + layoutURL + "/-/message_boards/message/"+ message.getMessageId();
  }
  String portletName=PortalUtil.getPortletTitle(PortletKeys.MESSAGE_BOARDS,user);
  String fromName=MBUtil.getEmailFromName(preferences);
  String fromAddress=MBUtil.getEmailFromAddress(preferences);
  String mailingListAddress=StringPool.BLANK;
  if (PropsValues.POP_SERVER_NOTIFICATIONS_ENABLED) {
    mailingListAddress=MBUtil.getMailingListAddress(message.getCategoryId(),message.getMessageId(),company.getMx(),fromAddress);
  }
  String replyToAddress=mailingListAddress;
  String mailId=MBUtil.getMailId(company.getMx(),message.getCategoryId(),message.getMessageId());
  fromName=StringUtil.replace(fromName,new String[]{"[$COMPANY_ID$]","[$COMPANY_MX$]","[$COMPANY_NAME$]","[$COMMUNITY_NAME$]","[$MAILING_LIST_ADDRESS$]","[$MESSAGE_USER_ADDRESS$]","[$MESSAGE_USER_NAME$]","[$PORTLET_NAME$]"},new String[]{String.valueOf(company.getCompanyId()),company.getMx(),company.getName(),group.getName(),mailingListAddress,emailAddress,fullName,portletName});
  fromAddress=StringUtil.replace(fromAddress,new String[]{"[$COMPANY_ID$]","[$COMPANY_MX$]","[$COMPANY_NAME$]","[$COMMUNITY_NAME$]","[$MAILING_LIST_ADDRESS$]","[$MESSAGE_USER_ADDRESS$]","[$MESSAGE_USER_NAME$]","[$PORTLET_NAME$]"},new String[]{String.valueOf(company.getCompanyId()),company.getMx(),company.getName(),group.getName(),mailingListAddress,emailAddress,fullName,portletName});
  String subjectPrefix=null;
  String body=null;
  String signature=null;
  boolean htmlFormat=MBUtil.getEmailHtmlFormat(preferences);
  if (update) {
    subjectPrefix=MBUtil.getEmailMessageUpdatedSubjectPrefix(preferences);
    body=MBUtil.getEmailMessageUpdatedBody(preferences);
    signature=MBUtil.getEmailMessageUpdatedSignature(preferences);
  }
 else {
    subjectPrefix=MBUtil.getEmailMessageAddedSubjectPrefix(preferences);
    body=MBUtil.getEmailMessageAddedBody(preferences);
    signature=MBUtil.getEmailMessageAddedSignature(preferences);
  }
  if (Validator.isNotNull(signature)) {
    body+="\n--\n" + signature;
  }
  subjectPrefix=StringUtil.replace(subjectPrefix,new String[]{"[$CATEGORY_NAME$]","[$COMPANY_ID$]","[$COMPANY_MX$]","[$COMPANY_NAME$]","[$COMMUNITY_NAME$]","[$FROM_ADDRESS$]","[$FROM_NAME$]","[$MAILING_LIST_ADDRESS$]","[$MESSAGE_BODY$]","[$MESSAGE_ID$]","[$MESSAGE_SUBJECT$]","[$MESSAGE_USER_ADDRESS$]","[$MESSAGE_USER_NAME$]","[$PORTAL_URL$]","[$PORTLET_NAME$]"},new String[]{category.getName(),String.valueOf(company.getCompanyId()),company.getMx(),company.getName(),group.getName(),fromAddress,fromName,mailingListAddress,message.getBody(),String.valueOf(message.getMessageId()),message.getSubject(),emailAddress,fullName,company.getVirtualHost(),portletName});
  body=StringUtil.replace(body,new String[]{"[$CATEGORY_NAME$]","[$COMPANY_ID$]","[$COMPANY_MX$]","[$COMPANY_NAME$]","[$COMMUNITY_NAME$]","[$FROM_ADDRESS$]","[$FROM_NAME$]","[$MAILING_LIST_ADDRESS$]","[$MESSAGE_BODY$]","[$MESSAGE_ID$]","[$MESSAGE_SUBJECT$]","[$MESSAGE_URL$]","[$MESSAGE_USER_ADDRESS$]","[$MESSAGE_USER_NAME$]","[$PORTAL_URL$]","[$PORTLET_NAME$]"},new String[]{category.getName(),String.valueOf(company.getCompanyId()),company.getMx(),company.getName(),group.getName(),fromAddress,fromName,mailingListAddress,message.getBody(),String.valueOf(message.getMessageId()),message.getSubject(),messageURL,emailAddress,fullName,company.getVirtualHost(),portletName});
  String subject=message.getSubject();
  if (subject.indexOf(subjectPrefix) == -1) {
    subject=subjectPrefix.trim() + " " + subject.trim();
  }
  String inReplyTo=null;
  if (message.getParentMessageId() != MBMessageImpl.DEFAULT_PARENT_MESSAGE_ID) {
    inReplyTo=MBUtil.getMailId(company.getMx(),message.getCategoryId(),message.getParentMessageId());
  }
  com.liferay.portal.kernel.messaging.Message messagingObj=new com.liferay.portal.kernel.messaging.Message();
  messagingObj.put("companyId",message.getCompanyId());
  messagingObj.put("userId",message.getUserId());
  messagingObj.put("categoryIds",StringUtil.merge(categoryIds));
  messagingObj.put("threadId",message.getThreadId());
  messagingObj.put("fromName",fromName);
  messagingObj.put("fromAddress",fromAddress);
  messagingObj.put("subject",subject);
  messagingObj.put("body",body);
  messagingObj.put("replyToAddress",replyToAddress);
  messagingObj.put("mailId",mailId);
  messagingObj.put("inReplyTo",inReplyTo);
  messagingObj.put("htmlFormat",htmlFormat);
  messagingObj.put("sourceMailingList",MailingListThreadLocal.isSourceMailingList());
  MessageBusUtil.sendMessage(DestinationNames.MESSAGE_BOARDS,messagingObj);
}
