{
  long categoryId=MBCategoryConstants.DISCUSSION_CATEGORY_ID;
  long classNameId=PortalUtil.getClassNameId(className);
  if (Validator.isNull(subject)) {
    subject="N/A";
  }
  List<ObjectValuePair<String,byte[]>> files=new ArrayList<ObjectValuePair<String,byte[]>>();
  boolean anonymous=false;
  double priority=0.0;
  boolean allowPingbacks=false;
  serviceContext.setAddCommunityPermissions(true);
  serviceContext.setAddGuestPermissions(true);
  serviceContext.setAttribute("className",className);
  serviceContext.setAttribute("classPK",String.valueOf(classPK));
  MBMessage message=addMessage(userId,userName,groupId,categoryId,threadId,parentMessageId,subject,body,files,anonymous,priority,allowPingbacks,serviceContext);
  message.setClassNameId(classNameId);
  message.setClassPK(classPK);
  mbMessagePersistence.update(message,false);
  if (parentMessageId == MBMessageConstants.DEFAULT_PARENT_MESSAGE_ID) {
    MBDiscussion discussion=mbDiscussionPersistence.fetchByC_C(classNameId,classPK);
    if (discussion == null) {
      discussion=mbDiscussionLocalService.addDiscussion(classNameId,classPK,message.getThreadId());
    }
  }
  return message;
}
