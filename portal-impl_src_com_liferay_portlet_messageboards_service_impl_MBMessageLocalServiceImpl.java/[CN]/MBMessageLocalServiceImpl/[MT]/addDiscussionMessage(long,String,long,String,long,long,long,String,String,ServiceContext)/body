{
  validateDiscussionMaxComments(className,classPK);
  long categoryId=MBCategoryConstants.DISCUSSION_CATEGORY_ID;
  if (Validator.isNull(subject)) {
    if (Validator.isNotNull(body)) {
      int pos=Math.min(body.length(),50);
      subject=body.substring(0,pos) + "...";
    }
 else {
      throw new MessageBodyException();
    }
  }
  List<ObjectValuePair<String,InputStream>> inputStreamOVPs=Collections.emptyList();
  boolean anonymous=false;
  Date now=new Date();
  double priority=0.0;
  boolean allowPingbacks=false;
  serviceContext.setAddGroupPermissions(true);
  serviceContext.setAddGuestPermissions(true);
  serviceContext.setAttribute("className",className);
  serviceContext.setAttribute("classPK",String.valueOf(classPK));
  serviceContext.setCreateDate(now);
  serviceContext.setModifiedDate(now);
  MBMessage message=addMessage(userId,userName,groupId,categoryId,threadId,parentMessageId,subject,body,PropsValues.DISCUSSION_COMMENTS_FORMAT,inputStreamOVPs,anonymous,priority,allowPingbacks,serviceContext);
  if (parentMessageId == MBMessageConstants.DEFAULT_PARENT_MESSAGE_ID) {
    long classNameId=classNameLocalService.getClassNameId(className);
    MBDiscussion discussion=mbDiscussionPersistence.fetchByC_C(classNameId,classPK);
    if (discussion == null) {
      mbDiscussionLocalService.addDiscussion(userId,groupId,classNameId,classPK,message.getThreadId(),serviceContext);
    }
  }
  return message;
}
