{
  MBMessage message=getMessage(messageId);
  int oldStatus=message.getStatus();
  User user=userPersistence.findByPrimaryKey(userId);
  Date now=new Date();
  message.setStatus(status);
  message.setStatusByUserId(userId);
  message.setStatusByUserName(user.getFullName());
  message.setStatusDate(serviceContext.getModifiedDate(now));
  mbMessagePersistence.update(message,false);
  MBThread thread=mbThreadPersistence.findByPrimaryKey(message.getThreadId());
  MBCategory category=null;
  if ((thread.getCategoryId() != MBCategoryConstants.DEFAULT_PARENT_CATEGORY_ID) && (thread.getCategoryId() != MBCategoryConstants.DISCUSSION_CATEGORY_ID)) {
    category=mbCategoryPersistence.findByPrimaryKey(thread.getCategoryId());
  }
  if ((thread.getRootMessageId() == message.getMessageId()) && (oldStatus != status)) {
    thread.setStatus(status);
    thread.setStatusByUserId(userId);
    thread.setStatusByUserName(user.getFullName());
    thread.setStatusDate(serviceContext.getModifiedDate(now));
  }
  Indexer indexer=IndexerRegistryUtil.nullSafeGetIndexer(MBMessage.class);
  if (status == WorkflowConstants.STATUS_APPROVED) {
    if (oldStatus != WorkflowConstants.STATUS_APPROVED) {
      if ((category != null) && (thread.getRootMessageId() == message.getMessageId())) {
        category.setThreadCount(category.getThreadCount() + 1);
        mbCategoryPersistence.update(category,false);
      }
      thread.setMessageCount(thread.getMessageCount() + 1);
      if (message.isAnonymous()) {
        thread.setLastPostByUserId(0);
      }
 else {
        thread.setLastPostByUserId(message.getUserId());
      }
      thread.setLastPostDate(serviceContext.getModifiedDate(now));
      if (category != null) {
        category.setMessageCount(category.getMessageCount() + 1);
        category.setLastPostDate(serviceContext.getModifiedDate(now));
        mbCategoryPersistence.update(category,false);
      }
      if (serviceContext.isAssetEntryVisible() && ((message.getClassNameId() == 0) || (message.getParentMessageId() != 0))) {
        Date publishDate=null;
        AssetEntry assetEntry=assetEntryLocalService.fetchEntry(message.getWorkflowClassName(),message.getMessageId());
        if ((assetEntry != null) && (assetEntry.getPublishDate() != null)) {
          publishDate=assetEntry.getPublishDate();
        }
 else {
          publishDate=now;
          serviceContext.setCommand(Constants.ADD);
        }
        assetEntryLocalService.updateEntry(message.getWorkflowClassName(),message.getMessageId(),publishDate,true);
      }
      if (serviceContext.isCommandAdd()) {
        JSONObject extraDataJSONObject=JSONFactoryUtil.createJSONObject();
        extraDataJSONObject.put("title",message.getSubject());
        if (!message.isDiscussion()) {
          if (!message.isAnonymous() && !user.isDefaultUser()) {
            long receiverUserId=0;
            MBMessage parentMessage=mbMessagePersistence.fetchByPrimaryKey(message.getParentMessageId());
            if (parentMessage != null) {
              receiverUserId=parentMessage.getUserId();
            }
            socialActivityLocalService.addActivity(userId,message.getGroupId(),MBMessage.class.getName(),message.getMessageId(),MBActivityKeys.ADD_MESSAGE,extraDataJSONObject.toString(),receiverUserId);
            if ((parentMessage != null) && (receiverUserId != userId)) {
              socialActivityLocalService.addActivity(userId,parentMessage.getGroupId(),MBMessage.class.getName(),parentMessage.getMessageId(),MBActivityKeys.REPLY_MESSAGE,extraDataJSONObject.toString(),0);
            }
          }
        }
 else {
          String className=(String)serviceContext.getAttribute("className");
          long classPK=ParamUtil.getLong(serviceContext,"classPK");
          long parentMessageId=message.getParentMessageId();
          if (parentMessageId != MBMessageConstants.DEFAULT_PARENT_MESSAGE_ID) {
            AssetEntry assetEntry=assetEntryLocalService.fetchEntry(className,classPK);
            if (assetEntry != null) {
              extraDataJSONObject.put("messageId",message.getMessageId());
              socialActivityLocalService.addActivity(userId,assetEntry.getGroupId(),className,classPK,SocialActivityConstants.TYPE_ADD_COMMENT,extraDataJSONObject.toString(),assetEntry.getUserId());
            }
          }
        }
      }
    }
    notifySubscribers(message,serviceContext);
    if (!message.isDiscussion()) {
      indexer.reindex(message);
    }
    pingPingback(message,serviceContext);
  }
 else   if ((oldStatus == WorkflowConstants.STATUS_APPROVED) && (status != WorkflowConstants.STATUS_APPROVED)) {
    if ((category != null) && (thread.getRootMessageId() == message.getMessageId())) {
      category.setThreadCount(category.getThreadCount() - 1);
      mbCategoryPersistence.update(category,false);
    }
    thread.setMessageCount(thread.getMessageCount() - 1);
    if (category != null) {
      category.setMessageCount(category.getMessageCount() - 1);
      mbCategoryPersistence.update(category,false);
    }
    assetEntryLocalService.updateVisible(message.getWorkflowClassName(),message.getMessageId(),false);
    if (!message.isDiscussion()) {
      indexer.delete(message);
    }
  }
  if (status != oldStatus) {
    mbThreadPersistence.update(thread,false);
  }
  if (!message.isDiscussion()) {
    mbStatsUserLocalService.updateStatsUser(message.getGroupId(),userId,serviceContext.getModifiedDate(now));
  }
  return message;
}
