{
  long companyId=message.getCompanyId();
  if (!PrefsPropsUtil.getBoolean(companyId,PropsKeys.DISCUSSION_EMAIL_COMMENTS_ADDED_ENABLED)) {
    return;
  }
  String contentURL=(String)serviceContext.getAttribute("redirect");
  User user=userPersistence.findByPrimaryKey(userId);
  String fromName=PrefsPropsUtil.getString(companyId,PropsKeys.ADMIN_EMAIL_FROM_NAME);
  String fromAddress=PrefsPropsUtil.getString(companyId,PropsKeys.ADMIN_EMAIL_FROM_ADDRESS);
  String subject=PrefsPropsUtil.getContent(companyId,PropsKeys.DISCUSSION_EMAIL_SUBJECT);
  String body=PrefsPropsUtil.getContent(companyId,PropsKeys.DISCUSSION_EMAIL_BODY);
  subject=StringUtil.replace(subject,new String[]{"[$COMMENTS_BODY$]","[$COMMENTS_USER_ADDRESS$]","[$COMMENTS_USER_NAME$]","[$CONTENT_URL$]","[$FROM_ADDRESS$]","[$FROM_NAME$]"},new String[]{message.getBody(),user.getEmailAddress(),user.getFullName(),contentURL,fromAddress,fromName});
  body=StringUtil.replace(body,new String[]{"[$COMMENTS_BODY$]","[$COMMENTS_USER_ADDRESS$]","[$COMMENTS_USER_NAME$]","[$ASSET_URL$]","[$FROM_ADDRESS$]","[$FROM_NAME$]"},new String[]{message.getBody(),user.getEmailAddress(),user.getFullName(),contentURL,fromAddress,fromName});
  Set<Long> sent=new HashSet<Long>();
  String className=(String)serviceContext.getAttribute("className");
  long classPK=GetterUtil.getLong((String)serviceContext.getAttribute("classPK"));
  List<Subscription> subscriptions=subscriptionLocalService.getSubscriptions(companyId,className,classPK);
  for (  Subscription subscription : subscriptions) {
    long subscriptionUserId=subscription.getUserId();
    if (subscriptionUserId == userId) {
      continue;
    }
    if (sent.contains(subscriptionUserId)) {
      if (_log.isDebugEnabled()) {
        _log.debug("Do not send a duplicate email to user " + subscriptionUserId);
      }
      continue;
    }
 else {
      if (_log.isDebugEnabled()) {
        _log.debug("Add user " + subscriptionUserId + " to the list of users who have received an email");
      }
      sent.add(subscriptionUserId);
    }
    User subscriptionUser=null;
    try {
      subscriptionUser=userLocalService.getUserById(subscriptionUserId);
    }
 catch (    NoSuchUserException nsue) {
      continue;
    }
    if (!subscriptionUser.isActive()) {
      continue;
    }
    InternetAddress from=new InternetAddress(fromAddress,fromName);
    InternetAddress to=new InternetAddress(subscriptionUser.getEmailAddress(),subscriptionUser.getFullName());
    String curSubject=StringUtil.replace(subject,new String[]{"[$TO_ADDRESS$]","[$TO_NAME$]"},new String[]{subscriptionUser.getFullName(),subscriptionUser.getEmailAddress()});
    String curBody=StringUtil.replace(body,new String[]{"[$TO_ADDRESS$]","[$TO_NAME$]"},new String[]{subscriptionUser.getFullName(),subscriptionUser.getEmailAddress()});
    MailMessage mailMessage=new MailMessage(from,to,curSubject,curBody,true);
    mailService.sendEmail(mailMessage);
  }
}
