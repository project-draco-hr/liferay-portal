{
  String layoutFullURL=serviceContext.getLayoutFullURL();
  if (!message.isApproved() || Validator.isNull(layoutFullURL)) {
    return;
  }
  if (message.isDiscussion()) {
    try {
      notifyDiscussionSubscribers(message,serviceContext);
    }
 catch (    Exception e) {
      _log.error(e,e);
    }
    return;
  }
  PortletPreferences preferences=ServiceContextUtil.getPortletPreferences(serviceContext);
  if (preferences == null) {
    long ownerId=message.getGroupId();
    int ownerType=PortletKeys.PREFS_OWNER_TYPE_GROUP;
    long plid=PortletKeys.PREFS_PLID_SHARED;
    String portletId=PortletKeys.MESSAGE_BOARDS;
    String defaultPreferences=null;
    preferences=portletPreferencesLocalService.getPreferences(message.getCompanyId(),ownerId,ownerType,plid,portletId,defaultPreferences);
  }
  boolean update=GetterUtil.getBoolean((String)serviceContext.getAttribute("update"));
  if (!update && MBUtil.getEmailMessageAddedEnabled(preferences)) {
  }
 else   if (update && MBUtil.getEmailMessageUpdatedEnabled(preferences)) {
  }
 else {
    return;
  }
  Company company=companyPersistence.findByPrimaryKey(message.getCompanyId());
  Group group=groupPersistence.findByPrimaryKey(message.getGroupId());
  String emailAddress=PortalUtil.getUserEmailAddress(message.getUserId());
  String fullName=PortalUtil.getUserName(message.getUserId(),message.getUserName());
  if (message.isAnonymous()) {
    emailAddress=StringPool.BLANK;
    fullName=LanguageUtil.get(ServiceContextUtil.getLocale(serviceContext),"anonymous");
  }
  MBCategory category=message.getCategory();
  String categoryName=category.getName();
  if (category.getCategoryId() == MBCategoryConstants.DEFAULT_PARENT_CATEGORY_ID) {
    categoryName=LanguageUtil.get(ServiceContextUtil.getLocale(serviceContext),"message-boards-home");
    categoryName+=" - " + group.getDescriptiveName();
  }
  List<Long> categoryIds=new ArrayList<Long>();
  categoryIds.add(message.getCategoryId());
  if ((message.getCategoryId() != MBCategoryConstants.DEFAULT_PARENT_CATEGORY_ID) && (message.getCategoryId() != MBCategoryConstants.DISCUSSION_CATEGORY_ID)) {
    categoryIds.addAll(category.getAncestorCategoryIds());
  }
  String messageURL=layoutFullURL + Portal.FRIENDLY_URL_SEPARATOR + "message_boards/view_message/"+ message.getMessageId();
  String fromName=MBUtil.getEmailFromName(preferences,message.getCompanyId());
  String fromAddress=MBUtil.getEmailFromAddress(preferences,message.getCompanyId());
  String mailingListAddress=StringPool.BLANK;
  if (PropsValues.POP_SERVER_NOTIFICATIONS_ENABLED) {
    mailingListAddress=MBUtil.getMailingListAddress(message.getGroupId(),message.getCategoryId(),message.getMessageId(),company.getMx(),fromAddress);
  }
  String subjectPrefix=null;
  String body=null;
  String signature=null;
  if (update) {
    subjectPrefix=MBUtil.getEmailMessageUpdatedSubjectPrefix(preferences);
    body=MBUtil.getEmailMessageUpdatedBody(preferences);
    signature=MBUtil.getEmailMessageUpdatedSignature(preferences);
  }
 else {
    subjectPrefix=MBUtil.getEmailMessageAddedSubjectPrefix(preferences);
    body=MBUtil.getEmailMessageAddedBody(preferences);
    signature=MBUtil.getEmailMessageAddedSignature(preferences);
  }
  String subject=message.getSubject();
  if (subject.indexOf(subjectPrefix) == -1) {
    subject=subjectPrefix.trim() + " " + subject.trim();
  }
  if (Validator.isNotNull(signature)) {
    body+="\n--\n" + signature;
  }
  String inReplyTo=null;
  if (message.getParentMessageId() != MBMessageConstants.DEFAULT_PARENT_MESSAGE_ID) {
    inReplyTo=PortalUtil.getMailId(company.getMx(),MBUtil.MESSAGE_POP_PORTLET_PREFIX,message.getCategoryId(),message.getParentMessageId());
  }
  SubscriptionSender subscriptionSenderPrototype=new MBSubscriptionSender();
  subscriptionSenderPrototype.setBody(body);
  subscriptionSenderPrototype.setBulk(true);
  subscriptionSenderPrototype.setCompanyId(message.getCompanyId());
  subscriptionSenderPrototype.setContextAttributes("[$CATEGORY_NAME$]",categoryName,"[$MAILING_LIST_ADDRESS$]",mailingListAddress,"[$MESSAGE_BODY$]",message.getBody(),"[$MESSAGE_ID$]",message.getMessageId(),"[$MESSAGE_SUBJECT$]",message.getSubject(),"[$MESSAGE_URL$]",messageURL,"[$MESSAGE_USER_ADDRESS$]",emailAddress,"[$MESSAGE_USER_NAME$]",fullName);
  subscriptionSenderPrototype.setFrom(fromAddress,fromName);
  subscriptionSenderPrototype.setHtmlFormat(MBUtil.getEmailHtmlFormat(preferences));
  subscriptionSenderPrototype.setInReplyTo(inReplyTo);
  subscriptionSenderPrototype.setMailId(MBUtil.MESSAGE_POP_PORTLET_PREFIX,message.getCategoryId(),message.getMessageId());
  subscriptionSenderPrototype.setPortletId(PortletKeys.MESSAGE_BOARDS);
  subscriptionSenderPrototype.setReplyToAddress(mailingListAddress);
  subscriptionSenderPrototype.setScopeGroupId(message.getGroupId());
  subscriptionSenderPrototype.setServiceContext(serviceContext);
  subscriptionSenderPrototype.setSubject(subject);
  subscriptionSenderPrototype.setUserId(message.getUserId());
  SubscriptionSender subscriptionSender=(SubscriptionSender)SerializableUtil.clone(subscriptionSenderPrototype);
  for (  long categoryId : categoryIds) {
    if (categoryId == MBCategoryConstants.DEFAULT_PARENT_CATEGORY_ID) {
      categoryId=message.getGroupId();
    }
    subscriptionSender.addPersistedSubscribers(MBCategory.class.getName(),categoryId);
  }
  subscriptionSender.addPersistedSubscribers(MBThread.class.getName(),message.getThreadId());
  subscriptionSender.flushNotificationsAsync();
  if (!MailingListThreadLocal.isSourceMailingList()) {
    for (    long categoryId : categoryIds) {
      MBSubscriptionSender sourceMailingListSubscriptionSender=(MBSubscriptionSender)SerializableUtil.clone(subscriptionSenderPrototype);
      sourceMailingListSubscriptionSender.setBulk(false);
      sourceMailingListSubscriptionSender.addMailingListSubscriber(message.getGroupId(),categoryId);
      sourceMailingListSubscriptionSender.flushNotificationsAsync();
    }
  }
}
