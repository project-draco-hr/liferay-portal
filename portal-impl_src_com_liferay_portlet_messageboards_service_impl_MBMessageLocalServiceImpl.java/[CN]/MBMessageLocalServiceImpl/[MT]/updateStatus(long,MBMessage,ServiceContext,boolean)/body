{
  int oldStatus=message.getStatus();
  User user=userPersistence.findByPrimaryKey(userId);
  Date now=new Date();
  message.setStatus(serviceContext.getStatus());
  message.setStatusByUserId(userId);
  message.setStatusByUserName(user.getFullName());
  message.setStatusDate(now);
  mbMessagePersistence.update(message,false);
  MBThread thread=mbThreadPersistence.findByPrimaryKey(message.getThreadId());
  if ((thread.getRootMessageId() == message.getMessageId()) && (oldStatus != serviceContext.getStatus())) {
    thread.setStatus(serviceContext.getStatus());
    thread.setStatusByUserId(userId);
    thread.setStatusByUserName(user.getFullName());
    thread.setStatusDate(now);
  }
  if ((serviceContext.getStatus() == StatusConstants.APPROVED) && (oldStatus != StatusConstants.APPROVED)) {
    thread.setMessageCount(thread.getMessageCount() + 1);
    if (message.isAnonymous()) {
      thread.setLastPostByUserId(0);
    }
 else {
      thread.setLastPostByUserId(message.getUserId());
    }
    thread.setLastPostDate(now);
  }
  if ((serviceContext.getStatus() != StatusConstants.APPROVED) && (oldStatus == StatusConstants.APPROVED)) {
    thread.setMessageCount(thread.getMessageCount() - 1);
  }
  if (serviceContext.getStatus() != oldStatus) {
    mbThreadPersistence.update(thread,false);
  }
  MBCategory systemCategory=mbCategoryLocalService.getSystemCategory();
  boolean isSystemCategory=(systemCategory.getCategoryId() == message.getCategoryId());
  if (!isSystemCategory) {
    MBCategory category=mbCategoryPersistence.findByPrimaryKey(thread.getCategoryId());
    if ((serviceContext.getStatus() == StatusConstants.APPROVED) && (oldStatus != StatusConstants.APPROVED)) {
      category.setMessageCount(category.getMessageCount() + 1);
      category.setLastPostDate(now);
      mbCategoryPersistence.update(category,false);
    }
    if ((serviceContext.getStatus() != StatusConstants.APPROVED) && (oldStatus == StatusConstants.APPROVED)) {
      category.setMessageCount(category.getMessageCount() - 1);
      mbCategoryPersistence.update(category,false);
    }
  }
  if ((serviceContext.getStatus() == StatusConstants.APPROVED) && (oldStatus != StatusConstants.APPROVED)) {
    assetEntryLocalService.updateVisible(MBMessage.class.getName(),message.getMessageId(),true);
    if (reIndex) {
      reIndex(message);
    }
  }
  if ((serviceContext.getStatus() != StatusConstants.APPROVED) && (oldStatus == StatusConstants.APPROVED)) {
    assetEntryLocalService.updateVisible(MBMessage.class.getName(),message.getMessageId(),false);
  }
  if (!message.isDiscussion() && (serviceContext.getStatus() == StatusConstants.APPROVED) && (oldStatus != StatusConstants.APPROVED)) {
    mbStatsUserLocalService.updateStatsUser(message.getGroupId(),userId,now);
  }
  if (!message.isDiscussion() && !message.isAnonymous() && !user.isDefaultUser()&& (serviceContext.getStatus() == StatusConstants.APPROVED)&& (oldStatus != StatusConstants.APPROVED)) {
    int activityType=MBActivityKeys.ADD_MESSAGE;
    long receiverUserId=0;
    MBMessage parentMessage=mbMessagePersistence.findByPrimaryKey(message.getParentMessageId());
    if (parentMessage != null) {
      activityType=MBActivityKeys.REPLY_MESSAGE;
      receiverUserId=parentMessage.getUserId();
    }
    socialActivityLocalService.addActivity(userId,message.getGroupId(),MBMessage.class.getName(),message.getMessageId(),activityType,StringPool.BLANK,receiverUserId);
  }
  return message;
}
