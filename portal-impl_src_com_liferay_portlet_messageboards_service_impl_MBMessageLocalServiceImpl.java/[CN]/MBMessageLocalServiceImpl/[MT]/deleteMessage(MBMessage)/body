{
  Indexer indexer=IndexerRegistryUtil.getIndexer(MBMessage.class);
  indexer.delete(message);
  if (message.isAttachments()) {
    long companyId=message.getCompanyId();
    String portletId=CompanyConstants.SYSTEM_STRING;
    long repositoryId=CompanyConstants.SYSTEM;
    String dirName=message.getAttachmentsDir();
    try {
      dlService.deleteDirectory(companyId,portletId,repositoryId,dirName);
    }
 catch (    NoSuchDirectoryException nsde) {
      if (_log.isDebugEnabled()) {
        _log.debug(nsde.getMessage());
      }
    }
  }
  int count=mbMessagePersistence.countByThreadId(message.getThreadId());
  if (message.isRoot()) {
    mbMessageFlagLocalService.deleteQuestionAndAnswerFlags(message.getThreadId());
  }
  if (count == 1) {
    long companyId=message.getCompanyId();
    String portletId=CompanyConstants.SYSTEM_STRING;
    long repositoryId=CompanyConstants.SYSTEM;
    String dirName=message.getThreadAttachmentsDir();
    try {
      dlService.deleteDirectory(companyId,portletId,repositoryId,dirName);
    }
 catch (    NoSuchDirectoryException nsde) {
      if (_log.isDebugEnabled()) {
        _log.debug(nsde.getMessage());
      }
    }
    subscriptionLocalService.deleteSubscriptions(message.getCompanyId(),MBThread.class.getName(),message.getThreadId());
    mbThreadPersistence.remove(message.getThreadId());
    if (!message.isDiscussion()) {
      MBCategory category=mbCategoryPersistence.findByPrimaryKey(message.getCategoryId());
      category.setThreadCount(category.getThreadCount() - 1);
      category.setMessageCount(category.getMessageCount() - 1);
      mbCategoryPersistence.update(category,false);
    }
  }
 else   if (count > 1) {
    MBThread thread=mbThreadPersistence.findByPrimaryKey(message.getThreadId());
    if (thread.getRootMessageId() == message.getMessageId()) {
      List<MBMessage> childrenMessages=mbMessagePersistence.findByT_P(message.getThreadId(),message.getMessageId());
      if (childrenMessages.size() > 1) {
        throw new RequiredMessageException(String.valueOf(message.getMessageId()));
      }
 else       if (childrenMessages.size() == 1) {
        MBMessage childMessage=childrenMessages.get(0);
        childMessage.setParentMessageId(MBMessageConstants.DEFAULT_PARENT_MESSAGE_ID);
        mbMessagePersistence.update(childMessage,false);
        thread.setRootMessageId(childMessage.getMessageId());
        mbThreadPersistence.update(thread,false);
      }
    }
 else {
      List<MBMessage> childrenMessages=mbMessagePersistence.findByT_P(message.getThreadId(),message.getMessageId());
      if (childrenMessages.size() > 0) {
        Iterator<MBMessage> itr=childrenMessages.iterator();
        while (itr.hasNext()) {
          MBMessage childMessage=itr.next();
          childMessage.setParentMessageId(message.getParentMessageId());
          mbMessagePersistence.update(childMessage,false);
        }
      }
    }
    thread.setMessageCount(count - 1);
    mbThreadPersistence.update(thread,false);
    if (!message.isDiscussion()) {
      MBCategory category=mbCategoryPersistence.findByPrimaryKey(message.getCategoryId());
      category.setMessageCount(category.getMessageCount() - 1);
      mbCategoryPersistence.update(category,false);
    }
  }
  assetEntryLocalService.deleteEntry(MBMessage.class.getName(),message.getMessageId());
  expandoValueLocalService.deleteValues(MBMessage.class.getName(),message.getMessageId());
  socialActivityLocalService.deleteActivities(MBMessage.class.getName(),message.getMessageId());
  ratingsStatsLocalService.deleteStats(MBMessage.class.getName(),message.getMessageId());
  if (!message.isDiscussion()) {
    mbStatsUserLocalService.updateStatsUser(message.getGroupId(),message.getUserId());
  }
  mbMessageFlagPersistence.removeByMessageId(message.getMessageId());
  if (!message.isDiscussion()) {
    resourceLocalService.deleteResource(message.getCompanyId(),MBMessage.class.getName(),ResourceConstants.SCOPE_INDIVIDUAL,message.getMessageId());
  }
  mbMessagePersistence.remove(message);
}
