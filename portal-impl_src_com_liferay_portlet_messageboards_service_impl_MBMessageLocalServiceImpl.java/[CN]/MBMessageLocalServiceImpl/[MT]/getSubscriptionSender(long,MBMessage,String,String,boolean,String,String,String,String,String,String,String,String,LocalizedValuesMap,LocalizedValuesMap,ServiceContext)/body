{
  MBSubscriptionSender subscriptionSender=new MBSubscriptionSender(MBPermission.RESOURCE_NAME);
  subscriptionSender.setBulk(PropsValues.MESSAGE_BOARDS_EMAIL_BULK);
  subscriptionSender.setClassName(message.getModelClassName());
  subscriptionSender.setClassPK(message.getMessageId());
  subscriptionSender.setCompanyId(message.getCompanyId());
  subscriptionSender.setContextAttribute("[$MESSAGE_BODY$]",messageBody,false);
  subscriptionSender.setContextAttributes("[$CATEGORY_NAME$]",categoryName,"[$MAILING_LIST_ADDRESS$]",replyToAddress,"[$MESSAGE_ID$]",message.getMessageId(),"[$MESSAGE_SUBJECT$]",entryTitle,"[$MESSAGE_URL$]",messageURL,"[$MESSAGE_USER_ADDRESS$]",emailAddress,"[$MESSAGE_USER_NAME$]",fullName);
  subscriptionSender.setCurrentUserId(userId);
  subscriptionSender.setEntryTitle(entryTitle);
  subscriptionSender.setEntryURL(messageURL);
  subscriptionSender.setFrom(fromAddress,fromName);
  subscriptionSender.setHtmlFormat(htmlFormat);
  subscriptionSender.setInReplyTo(inReplyTo);
  if (bodyLocalizedValuesMap != null) {
    subscriptionSender.setLocalizedBodyMap(LocalizationUtil.getMap(bodyLocalizedValuesMap));
  }
  if (subjectLocalizedValuesMap != null) {
    subscriptionSender.setLocalizedSubjectMap(LocalizationUtil.getMap(subjectLocalizedValuesMap));
  }
  Date modifiedDate=message.getModifiedDate();
  subscriptionSender.setMailId(MBUtil.MESSAGE_POP_PORTLET_PREFIX,message.getCategoryId(),message.getMessageId(),modifiedDate.getTime());
  int notificationType=UserNotificationDefinition.NOTIFICATION_TYPE_ADD_ENTRY;
  if (serviceContext.isCommandUpdate()) {
    notificationType=UserNotificationDefinition.NOTIFICATION_TYPE_UPDATE_ENTRY;
  }
  subscriptionSender.setNotificationType(notificationType);
  String portletId=PortletProviderUtil.getPortletId(MBMessage.class.getName(),PortletProvider.Action.VIEW);
  subscriptionSender.setPortletId(portletId);
  subscriptionSender.setReplyToAddress(replyToAddress);
  subscriptionSender.setScopeGroupId(message.getGroupId());
  subscriptionSender.setServiceContext(serviceContext);
  subscriptionSender.setUniqueMailId(false);
  return subscriptionSender;
}
