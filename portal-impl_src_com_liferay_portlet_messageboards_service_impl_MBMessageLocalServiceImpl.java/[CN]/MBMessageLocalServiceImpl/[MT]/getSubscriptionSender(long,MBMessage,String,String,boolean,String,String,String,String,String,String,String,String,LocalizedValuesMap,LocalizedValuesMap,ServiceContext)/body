{
  MBSubscriptionSender subscriptionSenderPrototype=new MBSubscriptionSender(MBPermission.RESOURCE_NAME);
  subscriptionSenderPrototype.setBulk(PropsValues.MESSAGE_BOARDS_EMAIL_BULK);
  subscriptionSenderPrototype.setClassName(message.getModelClassName());
  subscriptionSenderPrototype.setClassPK(message.getMessageId());
  subscriptionSenderPrototype.setCompanyId(message.getCompanyId());
  subscriptionSenderPrototype.setContextAttribute("[$MESSAGE_BODY$]",messageBody,false);
  subscriptionSenderPrototype.setContextAttributes("[$CATEGORY_NAME$]",categoryName,"[$MAILING_LIST_ADDRESS$]",replyToAddress,"[$MESSAGE_ID$]",message.getMessageId(),"[$MESSAGE_SUBJECT$]",entryTitle,"[$MESSAGE_URL$]",messageURL,"[$MESSAGE_USER_ADDRESS$]",emailAddress,"[$MESSAGE_USER_NAME$]",fullName);
  subscriptionSenderPrototype.setCurrentUserId(userId);
  subscriptionSenderPrototype.setEntryTitle(entryTitle);
  subscriptionSenderPrototype.setEntryURL(messageURL);
  subscriptionSenderPrototype.setFrom(fromAddress,fromName);
  subscriptionSenderPrototype.setHtmlFormat(htmlFormat);
  subscriptionSenderPrototype.setInReplyTo(inReplyTo);
  if (bodyLocalizedValuesMap != null) {
    subscriptionSenderPrototype.setLocalizedBodyMap(LocalizationUtil.getMap(bodyLocalizedValuesMap));
  }
  if (subjectLocalizedValuesMap != null) {
    subscriptionSenderPrototype.setLocalizedSubjectMap(LocalizationUtil.getMap(subjectLocalizedValuesMap));
  }
  Date modifiedDate=message.getModifiedDate();
  subscriptionSenderPrototype.setMailId(MBUtil.MESSAGE_POP_PORTLET_PREFIX,message.getCategoryId(),message.getMessageId(),modifiedDate.getTime());
  int notificationType=UserNotificationDefinition.NOTIFICATION_TYPE_ADD_ENTRY;
  if (serviceContext.isCommandUpdate()) {
    notificationType=UserNotificationDefinition.NOTIFICATION_TYPE_UPDATE_ENTRY;
  }
  subscriptionSenderPrototype.setNotificationType(notificationType);
  subscriptionSenderPrototype.setPortletId(PortletKeys.MESSAGE_BOARDS);
  subscriptionSenderPrototype.setReplyToAddress(replyToAddress);
  subscriptionSenderPrototype.setScopeGroupId(message.getGroupId());
  subscriptionSenderPrototype.setServiceContext(serviceContext);
  subscriptionSenderPrototype.setUniqueMailId(false);
  return subscriptionSenderPrototype;
}
