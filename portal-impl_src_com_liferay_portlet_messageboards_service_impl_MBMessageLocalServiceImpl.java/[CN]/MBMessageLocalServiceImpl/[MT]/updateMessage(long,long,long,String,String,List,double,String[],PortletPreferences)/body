{
  MBMessage message=MBMessageUtil.findByPrimaryKey(messageId);
  MBCategory category=getCategory(message,categoryId);
  long oldCategoryId=message.getCategoryId();
  subject=ModelHintsUtil.trimString(MBMessage.class.getName(),"subject",subject);
  Date now=new Date();
  validate(subject,body);
  if (files.size() > 0) {
    long companyId=message.getCompanyId();
    String portletId=CompanyImpl.SYSTEM_STRING;
    long groupId=GroupImpl.DEFAULT_PARENT_GROUP_ID;
    long repositoryId=CompanyImpl.SYSTEM;
    String dirName=message.getAttachmentsDir();
    try {
      try {
        DLServiceUtil.deleteDirectory(companyId,portletId,repositoryId,dirName);
      }
 catch (      NoSuchDirectoryException nsde) {
      }
      DLServiceUtil.addDirectory(companyId,repositoryId,dirName);
      for (int i=0; i < files.size(); i++) {
        ObjectValuePair ovp=(ObjectValuePair)files.get(i);
        String fileName=(String)ovp.getKey();
        byte[] byteArray=(byte[])ovp.getValue();
        try {
          DLServiceUtil.addFile(companyId,portletId,groupId,repositoryId,dirName + "/" + fileName,StringPool.BLANK,byteArray);
        }
 catch (        DuplicateFileException dfe) {
        }
      }
    }
 catch (    RemoteException re) {
      throw new SystemException(re);
    }
  }
  message.setModifiedDate(now);
  message.setSubject(subject);
  message.setBody(body);
  message.setAttachments((files.size() > 0 ? true : false));
  MBMessageUtil.update(message);
  notifySubscribers(category,message,prefs,true);
  MBThread thread=MBThreadUtil.findByPrimaryKey(message.getThreadId());
  if (priority != MBThreadImpl.PRIORITY_NOT_GIVEN) {
    thread.setPriority(priority);
  }
  MBThreadUtil.update(thread);
  category.setLastPostDate(now);
  MBCategoryUtil.update(category);
  if (oldCategoryId != category.getCategoryId()) {
    Iterator itr=MBMessageUtil.findByC_T(oldCategoryId,thread.getThreadId()).iterator();
    while (itr.hasNext()) {
      MBMessage curMessage=(MBMessage)itr.next();
      curMessage.setCategoryId(category.getCategoryId());
      MBMessageUtil.update(curMessage);
      try {
        if (!category.isDiscussion()) {
          Indexer.updateMessage(curMessage.getCompanyId(),category.getGroupId(),curMessage.getUserName(),category.getCategoryId(),curMessage.getThreadId(),curMessage.getMessageId(),curMessage.getSubject(),curMessage.getBody());
        }
      }
 catch (      IOException ioe) {
        _log.error("Indexing " + messageId,ioe);
      }
    }
    thread.setCategoryId(category.getCategoryId());
    MBThreadUtil.update(thread);
  }
  updateTagsAsset(userId,message,tagsEntries);
  try {
    if (!category.isDiscussion()) {
      Indexer.updateMessage(message.getCompanyId(),category.getGroupId(),message.getUserName(),category.getCategoryId(),message.getThreadId(),messageId,subject,body);
    }
  }
 catch (  IOException ioe) {
    _log.error("Indexing " + messageId,ioe);
  }
  return message;
}
