{
  ThemeDisplay themeDisplay=null;
  MBMessage message=addDiscussionMessage(userId,userName,groupId,className,classPK,threadId,parentMessageId,subject,body,themeDisplay);
  if (parentMessageId == MBMessageImpl.DEFAULT_PARENT_MESSAGE_ID) {
    MBDiscussion discussion;
    try {
      long classNameId=PortalUtil.getClassNameId(className);
      discussion=mbDiscussionPersistence.findByC_C(classNameId,classPK);
    }
 catch (    NoSuchDiscussionException nsde) {
      long discussionId=counterLocalService.increment();
      discussion=mbDiscussionPersistence.create(discussionId);
      discussion.setClassNameId(PortalUtil.getClassNameId(className));
      discussion.setClassPK(classPK);
    }
    discussion.setThreadId(message.getThreadId());
    mbDiscussionPersistence.update(discussion,false);
  }
  return message;
}
