{
  if (!PrefsPropsUtil.getBoolean(message.getCompanyId(),PropsKeys.DISCUSSION_EMAIL_COMMENTS_ADDED_ENABLED)) {
    return;
  }
  Company company=companyPersistence.findByPrimaryKey(message.getCompanyId());
  User user=userPersistence.findByPrimaryKey(message.getUserId());
  String contentURL=(String)serviceContext.getAttribute("redirect");
  String fromName=PrefsPropsUtil.getString(message.getCompanyId(),PropsKeys.ADMIN_EMAIL_FROM_NAME);
  String fromAddress=PrefsPropsUtil.getString(message.getCompanyId(),PropsKeys.ADMIN_EMAIL_FROM_ADDRESS);
  String subject=PrefsPropsUtil.getContent(message.getCompanyId(),PropsKeys.DISCUSSION_EMAIL_SUBJECT);
  String body=PrefsPropsUtil.getContent(message.getCompanyId(),PropsKeys.DISCUSSION_EMAIL_BODY);
  subject=StringUtil.replace(subject,new String[]{"[$COMMENTS_BODY$]","[$COMMENTS_USER_ADDRESS$]","[$COMMENTS_USER_NAME$]","[$CONTENT_URL$]","[$FROM_ADDRESS$]","[$FROM_NAME$]"},new String[]{message.getBody(),user.getEmailAddress(),user.getFullName(),contentURL,fromAddress,fromName});
  body=StringUtil.replace(body,new String[]{"[$COMMENTS_BODY$]","[$COMMENTS_USER_ADDRESS$]","[$COMMENTS_USER_NAME$]","[$CONTENT_URL$]","[$FROM_ADDRESS$]","[$FROM_NAME$]"},new String[]{message.getBody(),user.getEmailAddress(),user.getFullName(),contentURL,fromAddress,fromName});
  SubscriptionSender subscriptionSender=new SubscriptionSender();
  subscriptionSender.setBody(body);
  subscriptionSender.setCompanyId(message.getCompanyId());
  subscriptionSender.setFrom(fromAddress,fromName);
  subscriptionSender.setGroupId(message.getGroupId());
  subscriptionSender.setMailId(company,"mb_discussion",message.getCategoryId(),message.getMessageId());
  subscriptionSender.setSubject(subject);
  subscriptionSender.setUserId(message.getUserId());
  String className=(String)serviceContext.getAttribute("className");
  long classPK=GetterUtil.getLong((String)serviceContext.getAttribute("classPK"));
  subscriptionSender.addPersistedSubscribers(className,classPK);
  subscriptionSender.flushNotificationsAsync();
}
