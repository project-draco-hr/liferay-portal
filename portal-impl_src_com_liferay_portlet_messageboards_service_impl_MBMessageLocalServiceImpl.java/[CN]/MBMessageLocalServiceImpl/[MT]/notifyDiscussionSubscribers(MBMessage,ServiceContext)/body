{
  if (!PrefsPropsUtil.getBoolean(message.getCompanyId(),PropsKeys.DISCUSSION_EMAIL_COMMENTS_ADDED_ENABLED)) {
    return;
  }
  String contentURL=(String)serviceContext.getAttribute("redirect");
  String userAddress=StringPool.BLANK;
  String userName=(String)serviceContext.getAttribute("pingbackUserName");
  if (Validator.isNull(userName)) {
    userAddress=PortalUtil.getUserEmailAddress(message.getUserId());
    userName=PortalUtil.getUserName(message.getUserId(),StringPool.BLANK);
  }
  String fromName=PrefsPropsUtil.getString(message.getCompanyId(),PropsKeys.ADMIN_EMAIL_FROM_NAME);
  String fromAddress=PrefsPropsUtil.getString(message.getCompanyId(),PropsKeys.ADMIN_EMAIL_FROM_ADDRESS);
  String subject=PrefsPropsUtil.getContent(message.getCompanyId(),PropsKeys.DISCUSSION_EMAIL_SUBJECT);
  String body=PrefsPropsUtil.getContent(message.getCompanyId(),PropsKeys.DISCUSSION_EMAIL_BODY);
  long groupId=message.getGroupId();
  Group group=GroupLocalServiceUtil.getGroup(groupId);
  if (group.isLayout()) {
    groupId=group.getParentGroupId();
  }
  SubscriptionSender subscriptionSender=new SubscriptionSender();
  subscriptionSender.setBody(body);
  subscriptionSender.setCompanyId(message.getCompanyId());
  subscriptionSender.setContextAttributes("[$COMMENTS_BODY$]",message.getBody(true),"[$COMMENTS_USER_ADDRESS$]",userAddress,"[$COMMENTS_USER_NAME$]",userName,"[$CONTENT_URL$]",contentURL);
  subscriptionSender.setFrom(fromAddress,fromName);
  subscriptionSender.setGroupId(groupId);
  subscriptionSender.setScopeGroupId(message.getGroupId());
  subscriptionSender.setHtmlFormat(true);
  subscriptionSender.setMailId("mb_discussion",message.getCategoryId(),message.getMessageId());
  subscriptionSender.setSubject(subject);
  subscriptionSender.setUserId(message.getUserId());
  String className=(String)serviceContext.getAttribute("className");
  long classPK=GetterUtil.getLong((String)serviceContext.getAttribute("classPK"));
  subscriptionSender.addPersistedSubscribers(className,classPK);
  subscriptionSender.flushNotificationsAsync();
}
