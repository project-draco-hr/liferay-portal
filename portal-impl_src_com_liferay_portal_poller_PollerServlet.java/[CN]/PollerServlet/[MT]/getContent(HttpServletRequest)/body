{
  String pollerRequest=getPollerRequest(request);
  if (Validator.isNull(pollerRequest)) {
    return null;
  }
  Map<String,Object>[] pollerRequestChunks=(Map<String,Object>[])JSONFactoryUtil.deserialize(pollerRequest);
  PollerHeader pollerHeader=getPollerHeader(pollerRequestChunks);
  if (pollerHeader == null) {
    return null;
  }
  boolean doReceive=isDoReceive(request);
  JSONArray pollerResponseChunksJSON=null;
  Set<String> portletIdsWithChunks=null;
  if (doReceive) {
    pollerResponseChunksJSON=JSONFactoryUtil.createJSONArray();
    portletIdsWithChunks=new HashSet<String>();
    boolean suspendPolling=false;
    if (pollerHeader.isStartPolling()) {
      BrowserTrackerLocalServiceUtil.updateBrowserTracker(pollerHeader.getUserId(),pollerHeader.getBrowserKey());
    }
 else {
      BrowserTracker browserTracker=BrowserTrackerLocalServiceUtil.getBrowserTracker(pollerHeader.getUserId(),pollerHeader.getBrowserKey());
      if (browserTracker.getBrowserKey() != pollerHeader.getBrowserKey()) {
        suspendPolling=true;
      }
    }
    JSONObject pollerResponseChunkJSON=JSONFactoryUtil.createJSONObject();
    pollerResponseChunkJSON.put("userId",pollerHeader.getUserId());
    pollerResponseChunkJSON.put("initialRequest",pollerHeader.isInitialRequest());
    pollerResponseChunkJSON.put("suspendPolling",suspendPolling);
    pollerResponseChunksJSON.put(pollerResponseChunkJSON);
  }
  for (int i=1; i < pollerRequestChunks.length; i++) {
    Map<String,Object> pollerRequestChunk=pollerRequestChunks[i];
    String portletId=(String)pollerRequestChunk.get("portletId");
    Map<String,String> parameterMap=getData(pollerRequestChunk);
    String chunkId=(String)pollerRequestChunk.get("chunkId");
    try {
      process(doReceive,pollerResponseChunksJSON,portletIdsWithChunks,pollerHeader,portletId,parameterMap,chunkId);
    }
 catch (    Exception e) {
      _log.error(e,e);
    }
  }
  if (!doReceive) {
    return StringPool.BLANK;
  }
  for (  String portletId : pollerHeader.getPortletIds()) {
    if (portletIdsWithChunks.contains(portletId)) {
      continue;
    }
    try {
      process(doReceive,pollerResponseChunksJSON,portletIdsWithChunks,pollerHeader,portletId,new HashMap<String,String>(),null);
    }
 catch (    Exception e) {
      _log.error(e,e);
    }
  }
  return pollerResponseChunksJSON.toString();
}
