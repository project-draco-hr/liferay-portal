{
  long companyId=PortalUtil.getCompanyId(request);
  long groupId=getGroupId(request);
  DataSample dataSample=null;
  if (_monitorPortalRequest) {
    dataSample=_dataSampleFactory.createPortalRequestDataSample(companyId,groupId,request.getRemoteUser(),request.getRequestURI(),GetterUtil.getString(request.getRequestURL()));
    DataSampleThreadLocal.initialize();
  }
  try {
    if (dataSample != null) {
      dataSample.prepare();
    }
    processFilter(MonitoringFilter.class,request,response,filterChain);
    if (dataSample != null) {
      dataSample.capture(RequestStatus.SUCCESS);
    }
  }
 catch (  Exception e) {
    if (dataSample != null) {
      dataSample.capture(RequestStatus.ERROR);
    }
    if (e instanceof IOException) {
      throw (IOException)e;
    }
 else     if (e instanceof ServletException) {
      throw (ServletException)e;
    }
 else {
      throw new ServletException("Unable to execute request",e);
    }
  }
 finally {
    if (dataSample != null) {
      DataSampleThreadLocal.addDataSample(dataSample);
    }
    MessageBusUtil.sendMessage(DestinationNames.MONITORING,DataSampleThreadLocal.getDataSamples());
  }
}
