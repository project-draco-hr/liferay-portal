{
  long companyId=PortalUtil.getCompanyId(request);
  long groupId=getGroupId(request);
  PortalRequestDataSample portalRequestDataSample=null;
  incrementProcessFilterCount();
  if (_monitorPortalRequest) {
    portalRequestDataSample=(PortalRequestDataSample)_dataSampleFactory.createPortalRequestDataSample(companyId,groupId,request.getHeader(HttpHeaders.REFERER),request.getRemoteAddr(),request.getRemoteUser(),request.getRequestURI(),GetterUtil.getString(request.getRequestURL()),request.getHeader(HttpHeaders.USER_AGENT));
    DataSampleThreadLocal.initialize();
  }
  try {
    if (portalRequestDataSample != null) {
      portalRequestDataSample.prepare();
    }
    processFilter(MonitoringFilter.class.getName(),request,response,filterChain);
    if (portalRequestDataSample != null) {
      portalRequestDataSample.capture(RequestStatus.SUCCESS);
      portalRequestDataSample.setGroupId(getGroupId(request));
      portalRequestDataSample.setStatusCode(response.getStatus());
    }
  }
 catch (  Exception e) {
    if (portalRequestDataSample != null) {
      portalRequestDataSample.capture(RequestStatus.ERROR);
    }
    if (e instanceof IOException) {
      throw (IOException)e;
    }
 else     if (e instanceof ServletException) {
      throw (ServletException)e;
    }
 else {
      throw new ServletException("Unable to execute request",e);
    }
  }
 finally {
    if (portalRequestDataSample != null) {
      DataSampleThreadLocal.addDataSample(portalRequestDataSample);
    }
    if (decrementProcessFilterCount() == 0) {
      MessageBusUtil.sendMessage(DestinationNames.MONITORING,DataSampleThreadLocal.getDataSamples());
      _processFilterCount.remove();
    }
  }
}
