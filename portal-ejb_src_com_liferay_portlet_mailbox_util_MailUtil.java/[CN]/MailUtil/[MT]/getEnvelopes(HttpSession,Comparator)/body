{
  SortedSet envelopes=new TreeSet(comp);
  Message[] msgs=_getCurrentFolder(ses).getMessages();
  FetchProfile fp=new FetchProfile();
  fp.add(FetchProfile.Item.ENVELOPE);
  fp.add(FetchProfile.Item.FLAGS);
  _getCurrentFolder(ses).fetch(msgs,fp);
  for (int ii=msgs.length - 1; ii >= 0; ii--) {
    if (msgs[ii].isExpunged()) {
      continue;
    }
    MailEnvelope me=new MailEnvelope();
    if (MAIL_SENT_NAME.equals(_getCurrentFolder(ses).getName()) || MAIL_DRAFTS_NAME.equals(_getCurrentFolder(ses).getName())) {
      Address[] recipients=msgs[ii].getAllRecipients();
      StringBuffer email=new StringBuffer();
      for (int j=0; j < recipients.length; j++) {
        InternetAddress ia=(InternetAddress)recipients[j];
        email.append(GetterUtil.get(ia.getPersonal(),ia.getAddress()));
        if (j < recipients.length - 1) {
          email.append(", ");
        }
      }
      me.setRecipient(email.toString());
    }
 else {
      Address[] from=msgs[ii].getFrom();
      if (from.length > 0) {
        InternetAddress ia=(InternetAddress)from[0];
        me.setRecipient(GetterUtil.get(ia.getPersonal(),ia.getAddress()));
      }
    }
    me.setDate(msgs[ii].getSentDate());
    me.setSubject(msgs[ii].getSubject());
    me.setMsgUID(_getCurrentFolder(ses).getUID(msgs[ii]));
    me.setRecent(msgs[ii].isSet(Flag.RECENT));
    me.setFlagged(msgs[ii].isSet(Flag.FLAGGED));
    me.setAnswered(msgs[ii].isSet(Flag.ANSWERED));
    envelopes.add(me);
  }
  return envelopes;
}
