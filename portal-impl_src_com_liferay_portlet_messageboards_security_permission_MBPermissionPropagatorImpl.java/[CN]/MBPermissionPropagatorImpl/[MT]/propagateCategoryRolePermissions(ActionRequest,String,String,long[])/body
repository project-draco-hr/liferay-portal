{
  long categoryId=GetterUtil.getLong(primKey);
  MBCategory category=MBCategoryLocalServiceUtil.getCategory(categoryId);
  List<Object> categoriesAndThreads=MBCategoryLocalServiceUtil.getCategoriesAndThreads(category.getGroupId(),categoryId);
  for (  Object categoryOrThread : categoriesAndThreads) {
    if (categoryOrThread instanceof MBThread) {
      MBThread thread=(MBThread)categoryOrThread;
      List<MBMessage> messages=MBMessageLocalServiceUtil.getThreadMessages(thread.getThreadId(),WorkflowConstants.STATUS_ANY);
      for (      MBMessage message : messages) {
        propagateMessageRolePermissions(actionRequest,className,categoryId,message.getMessageId(),roleIds);
      }
    }
 else {
      category=(MBCategory)categoryOrThread;
      List<Long> categoryIds=new ArrayList<Long>();
      categoryIds.add(category.getCategoryId());
      categoryIds=MBCategoryLocalServiceUtil.getSubcategoryIds(categoryIds,category.getGroupId(),category.getCategoryId());
      for (      long addCategoryId : categoryIds) {
        propagateCategoryRolePermissions(actionRequest,className,categoryId,addCategoryId,roleIds);
        List<MBMessage> messages=MBMessageLocalServiceUtil.getCategoryMessages(category.getGroupId(),addCategoryId,WorkflowConstants.STATUS_ANY,QueryUtil.ALL_POS,QueryUtil.ALL_POS);
        for (        MBMessage message : messages) {
          propagateMessageRolePermissions(actionRequest,className,categoryId,message.getMessageId(),roleIds);
        }
      }
    }
  }
}
