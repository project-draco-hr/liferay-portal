{
  final long categoryId=GetterUtil.getLong(primKey);
  MBCategory category=MBCategoryLocalServiceUtil.getCategory(categoryId);
  List<Object> categoriesAndThreads=MBCategoryLocalServiceUtil.getCategoriesAndThreads(category.getGroupId(),categoryId);
  for (  Object categoryOrThread : categoriesAndThreads) {
    if (categoryOrThread instanceof MBThread) {
      MBThread thread=(MBThread)categoryOrThread;
      List<MBMessage> messages=MBMessageLocalServiceUtil.getThreadMessages(thread.getThreadId(),WorkflowConstants.STATUS_ANY);
      for (      MBMessage message : messages) {
        propagateMessageRolePermissions(actionRequest,className,categoryId,message.getMessageId(),roleIds);
      }
    }
 else {
      category=(MBCategory)categoryOrThread;
      List<Long> categoryIds=new ArrayList<Long>();
      categoryIds.add(category.getCategoryId());
      categoryIds=MBCategoryLocalServiceUtil.getSubcategoryIds(categoryIds,category.getGroupId(),category.getCategoryId());
      for (      final long addCategoryId : categoryIds) {
        propagateCategoryRolePermissions(actionRequest,className,categoryId,addCategoryId,roleIds);
        ActionableDynamicQuery actionableDynamicQuery=new MBMessageActionableDynamicQuery(){
          @Override protected void addCriteria(          DynamicQuery dynamicQuery){
            Property categoryIdProperty=PropertyFactoryUtil.forName("categoryId");
            dynamicQuery.add(categoryIdProperty.eq(addCategoryId));
          }
          @Override protected void performAction(          Object object) throws PortalException, SystemException {
            MBMessage message=(MBMessage)object;
            propagateMessageRolePermissions(actionRequest,className,categoryId,message.getMessageId(),roleIds);
          }
        }
;
        actionableDynamicQuery.setGroupId(category.getGroupId());
        actionableDynamicQuery.performActions();
      }
    }
  }
}
