{
  long companyId=PortalInstances.getCompanyId(request);
  if (LDAPSettingsUtil.isNtlmEnabled(companyId)) {
    HttpSession session=request.getSession(false);
    String authorization=GetterUtil.getString(request.getHeader(HttpHeaders.AUTHORIZATION));
    if (authorization.startsWith("NTLM")) {
      byte[] src=Base64.decode(authorization.substring(5));
      if (src[8] == 1) {
        byte[] challengeMessage=_ntlmManager.negotiate(src);
        authorization=Base64.encode(challengeMessage);
        response.setHeader(HttpHeaders.WWW_AUTHENTICATE,"NTLM " + authorization);
        response.setStatus(HttpServletResponse.SC_UNAUTHORIZED);
        response.setContentLength(0);
        response.flushBuffer();
        String remoteAddr=request.getRemoteAddr();
        _serverChallengesMap.put(remoteAddr,_ntlmManager.getServerChallenge());
        return;
      }
 else {
        byte[] serverChallenge=_serverChallengesMap.get(request.getRemoteAddr());
        _ntlmManager.setServerChallenge(serverChallenge);
        NtlmUserAccount account=_ntlmManager.authenticate(src);
        if (account == null) {
          return;
        }
        if (_log.isDebugEnabled()) {
          _log.debug("NTLM remote user " + account.getUserName());
        }
        _serverChallengesMap.remove(request.getRemoteAddr());
        request.setAttribute(WebKeys.NTLM_REMOTE_USER,account.getUserName());
        if (session != null) {
          session.setAttribute("NtlmUserAccount",account);
        }
      }
    }
    String path=request.getPathInfo();
    if ((path != null) && path.endsWith("/login")) {
      NtlmUserAccount account=null;
      if (session != null) {
        account=(NtlmUserAccount)session.getAttribute("NtlmUserAccount");
      }
      if (account == null) {
        response.setHeader(HttpHeaders.WWW_AUTHENTICATE,"NTLM");
        response.setStatus(HttpServletResponse.SC_UNAUTHORIZED);
        response.setContentLength(0);
        response.flushBuffer();
        return;
      }
    }
  }
  processFilter(NtlmPostFilter.class,request,response,filterChain);
}
