{
  long companyId=PortalInstances.getCompanyId(request);
  if (LDAPSettingsUtil.isNtlmEnabled(companyId)) {
    HttpSession session=request.getSession(false);
    String authorization=GetterUtil.getString(request.getHeader(HttpHeaders.AUTHORIZATION));
    NtlmManager ntlmManager=getNtlmManager(companyId);
    if (authorization.startsWith("NTLM")) {
      byte[] src=Base64.decode(authorization.substring(5));
      if (src[8] == 1) {
        byte[] serverChallenge=new byte[8];
        _secureRandom.nextBytes(serverChallenge);
        byte[] challengeMessage=ntlmManager.negotiate(src,serverChallenge);
        authorization=Base64.encode(challengeMessage);
        response.setHeader(HttpHeaders.WWW_AUTHENTICATE,"NTLM " + authorization);
        response.setStatus(HttpServletResponse.SC_UNAUTHORIZED);
        response.setContentLength(0);
        response.flushBuffer();
        _serverChallenges.put(request.getRemoteAddr(),serverChallenge);
        return;
      }
 else {
        byte[] serverChallenge=_serverChallenges.get(request.getRemoteAddr());
        NtlmUserAccount ntlmUserAccount=ntlmManager.authenticate(src,serverChallenge);
        if (ntlmUserAccount == null) {
          return;
        }
        if (_log.isDebugEnabled()) {
          _log.debug("NTLM remote user " + ntlmUserAccount.getUserName());
        }
        _serverChallenges.remove(request.getRemoteAddr());
        request.setAttribute(WebKeys.NTLM_REMOTE_USER,ntlmUserAccount.getUserName());
        if (session != null) {
          session.setAttribute(WebKeys.NTLM_USER_ACCOUNT,ntlmUserAccount);
        }
      }
    }
    String path=request.getPathInfo();
    if ((path != null) && path.endsWith("/login")) {
      NtlmUserAccount ntlmUserAccount=null;
      if (session != null) {
        ntlmUserAccount=(NtlmUserAccount)session.getAttribute(WebKeys.NTLM_USER_ACCOUNT);
      }
      if (ntlmUserAccount == null) {
        response.setHeader(HttpHeaders.WWW_AUTHENTICATE,"NTLM");
        response.setStatus(HttpServletResponse.SC_UNAUTHORIZED);
        response.setContentLength(0);
        response.flushBuffer();
        return;
      }
    }
  }
  processFilter(NtlmPostFilter.class,request,response,filterChain);
}
