{
  NtlmPasswordAuthentication ntlm=null;
  HttpSession session=request.getSession(false);
  String authorization=GetterUtil.getString(request.getHeader(HttpHeaders.AUTHORIZATION));
  if (_log.isDebugEnabled()) {
    _log.debug("Authorization header " + authorization);
  }
  if (authorization.startsWith("NTLM ")) {
    String domainController=_filterConfig.getInitParameter("jcifs.http.domainController");
    UniAddress uniAddress=UniAddress.getByName(domainController,true);
    if (_log.isDebugEnabled()) {
      _log.debug("Address " + uniAddress);
    }
    byte[] challenge=SmbSession.getChallenge(uniAddress);
    ntlm=NtlmSsp.authenticate(request,response,challenge);
    session.setAttribute("NtlmHttpAuth",ntlm);
  }
 else {
    if (session != null) {
      ntlm=(NtlmPasswordAuthentication)session.getAttribute("NtlmHttpAuth");
    }
    if (ntlm == null) {
      response.setHeader(HttpHeaders.WWW_AUTHENTICATE,"NTLM");
      response.setStatus(HttpServletResponse.SC_UNAUTHORIZED);
      response.setContentLength(0);
      response.flushBuffer();
      return null;
    }
  }
  if (_log.isDebugEnabled()) {
    _log.debug("Password authentication " + ntlm);
  }
  return ntlm;
}
