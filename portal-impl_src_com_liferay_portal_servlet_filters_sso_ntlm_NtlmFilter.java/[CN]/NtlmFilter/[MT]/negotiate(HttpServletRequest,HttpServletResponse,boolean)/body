{
  NtlmPasswordAuthentication ntlm=null;
  HttpSession ses=req.getSession(false);
  String authorizationHeader=req.getHeader("Authorization");
  if (_log.isDebugEnabled()) {
    _log.debug("Authorization header " + authorizationHeader);
  }
  if ((authorizationHeader != null) && ((authorizationHeader.startsWith("NTLM ")))) {
    String domainController=Config.getProperty("jcifs.http.domainController");
    UniAddress uniAddress=UniAddress.getByName(domainController,true);
    if (_log.isDebugEnabled()) {
      _log.debug("Address " + uniAddress);
    }
    byte[] challenge=SmbSession.getChallenge(uniAddress);
    ntlm=NtlmSsp.authenticate(req,resp,challenge);
    ses.setAttribute("NtlmHttpAuth",ntlm);
  }
 else {
    if (ses != null) {
      ntlm=(NtlmPasswordAuthentication)ses.getAttribute("NtlmHttpAuth");
    }
    if (ntlm == null) {
      resp.setHeader("WWW-Authenticate","NTLM");
      resp.setStatus(HttpServletResponse.SC_UNAUTHORIZED);
      resp.setContentLength(0);
      resp.flushBuffer();
      return null;
    }
  }
  if (_log.isDebugEnabled()) {
    _log.debug("Password authentication " + ntlm);
  }
  return ntlm;
}
