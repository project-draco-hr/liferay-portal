{
  UploadPortletRequest uploadPortletRequest=PortalUtil.getUploadPortletRequest(actionRequest);
  long nodeId=ParamUtil.getLong(actionRequest,"nodeId");
  String title=ParamUtil.getString(actionRequest,"title");
  int numOfFiles=ParamUtil.getInteger(actionRequest,"numOfFiles");
  List<ObjectValuePair<String,InputStream>> inputStreamOVPs=new ArrayList<>();
  try {
    if (numOfFiles == 0) {
      String fileName=uploadPortletRequest.getFileName("file");
      InputStream inputStream=uploadPortletRequest.getFileAsStream("file");
      if (inputStream != null) {
        ObjectValuePair<String,InputStream> inputStreamOVP=new ObjectValuePair<>(fileName,inputStream);
        inputStreamOVPs.add(inputStreamOVP);
      }
    }
 else {
      for (int i=1; i <= numOfFiles; i++) {
        String fileName=uploadPortletRequest.getFileName("file" + i);
        InputStream inputStream=uploadPortletRequest.getFileAsStream("file" + i);
        if (inputStream == null) {
          continue;
        }
        ObjectValuePair<String,InputStream> inputStreamOVP=new ObjectValuePair<>(fileName,inputStream);
        inputStreamOVPs.add(inputStreamOVP);
      }
    }
    _wikiPageService.addPageAttachments(nodeId,title,inputStreamOVPs);
  }
  finally {
    for (    ObjectValuePair<String,InputStream> inputStreamOVP : inputStreamOVPs) {
      InputStream inputStream=inputStreamOVP.getValue();
      StreamUtil.cleanUp(inputStream);
    }
  }
}
