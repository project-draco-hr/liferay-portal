{
  int keysCount=(key.contains(KEY1) ? 1 : 0) + (key.contains(KEY2) ? 1 : 0) + (key.contains(KEY3) ? 1 : 0);
  if (keysCount > length) {
    if (_log.isWarnEnabled()) {
      _log.warn("A password using all keys with length = " + length + " could not be created, using length = "+ keysCount+ " instead");
    }
    length=keysCount;
  }
  StringBuilder sb=new StringBuilder(length);
  for (int i=0; i < length; i++) {
    sb.append(key.charAt((int)(Math.random() * key.length())));
  }
  String password=sb.toString();
  if (!useAllKeys) {
    return password;
  }
  boolean invalidPassword=false;
  if (key.contains(KEY1)) {
    if (Validator.isNull(StringUtil.extractDigits(password))) {
      invalidPassword=true;
    }
  }
  if (key.contains(KEY2)) {
    if (password.equals(password.toLowerCase())) {
      invalidPassword=true;
    }
  }
  if (key.contains(KEY3)) {
    if (password.equals(password.toUpperCase())) {
      invalidPassword=true;
    }
  }
  if (invalidPassword) {
    return _getPassword(key,length,useAllKeys);
  }
  return password;
}
