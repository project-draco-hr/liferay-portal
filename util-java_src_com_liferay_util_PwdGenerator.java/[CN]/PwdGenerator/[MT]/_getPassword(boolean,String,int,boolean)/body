{
  int keysCount=0;
  if (key.contains(KEY1)) {
    keysCount++;
  }
  if (key.contains(KEY2)) {
    keysCount++;
  }
  if (key.contains(KEY3)) {
    keysCount++;
  }
  if (keysCount > length) {
    if (_log.isWarnEnabled()) {
      _log.warn("Length is too short");
    }
    length=keysCount;
  }
  StringBuilder sb=new StringBuilder(length);
  for (int i=0; i < length; i++) {
    sb.append(key.charAt((int)(_random(secure) * key.length())));
  }
  String password=sb.toString();
  if (!useAllKeys) {
    return password;
  }
  boolean invalidPassword=false;
  if (key.contains(KEY1)) {
    if (Validator.isNull(StringUtil.extractDigits(password))) {
      invalidPassword=true;
    }
  }
  if (key.contains(KEY2)) {
    if (password.equals(password.toLowerCase())) {
      invalidPassword=true;
    }
  }
  if (key.contains(KEY3)) {
    if (password.equals(password.toUpperCase())) {
      invalidPassword=true;
    }
  }
  if (invalidPassword) {
    return _getPassword(secure,key,length,useAllKeys);
  }
  return password;
}
