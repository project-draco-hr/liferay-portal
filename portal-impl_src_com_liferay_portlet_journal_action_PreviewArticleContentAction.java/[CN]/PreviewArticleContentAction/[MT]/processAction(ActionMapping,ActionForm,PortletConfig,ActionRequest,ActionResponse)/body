{
  try {
    String cmd=ParamUtil.getString(actionRequest,Constants.CMD);
    ThemeDisplay themeDisplay=(ThemeDisplay)actionRequest.getAttribute(WebKeys.THEME_DISPLAY);
    long groupId=ParamUtil.getLong(actionRequest,"groupId");
    String articleId=ParamUtil.getString(actionRequest,"articleId");
    double version=ParamUtil.getDouble(actionRequest,"version",JournalArticleConstants.VERSION_DEFAULT);
    String languageId=LanguageUtil.getLanguageId(actionRequest);
    String output=null;
    if (cmd.equals(Constants.PREVIEW)) {
      String title=ParamUtil.getString(actionRequest,"title");
      String description=ParamUtil.getString(actionRequest,"description");
      String type=ParamUtil.getString(actionRequest,"type");
      String structureId=ParamUtil.getString(actionRequest,"structureId");
      String templateId=ParamUtil.getString(actionRequest,"templateId");
      Date now=new Date();
      Date createDate=now;
      Date modifiedDate=now;
      Date displayDate=now;
      User user=PortalUtil.getUser(actionRequest);
      String content=ParamUtil.getString(actionRequest,"articleContent");
      if (Validator.isNotNull(structureId)) {
        ServiceContext serviceContext=ServiceContextFactory.getInstance(JournalArticle.class.getName(),actionRequest);
        Object[] contentAndImages=ActionUtil.getContentAndImages(groupId,structureId,themeDisplay.getLocale(),serviceContext);
        content=(String)contentAndImages[0];
        Map<String,String> tokens=JournalUtil.getTokens(groupId,themeDisplay);
        tokens.put("article_resource_pk","-1");
        JournalArticle article=new JournalArticleImpl();
        article.setGroupId(groupId);
        article.setCompanyId(user.getCompanyId());
        article.setUserId(user.getUserId());
        article.setUserName(user.getFullName());
        article.setCreateDate(createDate);
        article.setModifiedDate(modifiedDate);
        article.setArticleId(articleId);
        article.setVersion(version);
        article.setTitle(title);
        article.setDescription(description);
        article.setContent(content);
        article.setType(type);
        article.setStructureId(structureId);
        article.setTemplateId(templateId);
        article.setDisplayDate(displayDate);
        output=JournalArticleLocalServiceUtil.getArticleContent(article,templateId,null,languageId,themeDisplay);
      }
 else {
        output=content;
      }
    }
 else     if (cmd.equals(Constants.VIEW)) {
      JournalArticle article=JournalArticleServiceUtil.getArticle(groupId,articleId,version);
      output=JournalArticleLocalServiceUtil.getArticleContent(article,article.getTemplateId(),null,languageId,themeDisplay);
    }
 else {
      output=JournalArticleServiceUtil.getArticleContent(groupId,articleId,version,languageId,themeDisplay);
    }
    actionRequest.setAttribute(WebKeys.JOURNAL_ARTICLE_CONTENT,output);
    if (output.startsWith("<?xml ")) {
      setForward(actionRequest,"portlet.journal.raw_article_content");
    }
 else {
      setForward(actionRequest,"portlet.journal.view_article_content");
    }
  }
 catch (  Exception e) {
    SessionErrors.add(actionRequest,e.getClass());
    setForward(actionRequest,"portlet.journal.error");
  }
}
