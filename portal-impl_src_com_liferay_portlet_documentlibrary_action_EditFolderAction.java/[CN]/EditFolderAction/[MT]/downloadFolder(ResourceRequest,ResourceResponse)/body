{
  ThemeDisplay themeDisplay=(ThemeDisplay)resourceRequest.getAttribute(WebKeys.THEME_DISPLAY);
  long folderId=ParamUtil.getLong(resourceRequest,"folderId");
  long repositoryId=ParamUtil.getLong(resourceRequest,"repositoryId");
  File file=null;
  InputStream inputStream=null;
  try {
    ZipWriter zipWriter=ZipWriterFactoryUtil.getZipWriter();
    zipFolder(folderId,repositoryId,StringPool.SLASH,zipWriter);
    HttpServletRequest request=PortalUtil.getHttpServletRequest(resourceRequest);
    HttpServletResponse response=PortalUtil.getHttpServletResponse(resourceResponse);
    String zipFileName=LanguageUtil.get(themeDisplay.getLocale(),"documents-and-media");
    if (folderId != DLFolderConstants.DEFAULT_PARENT_FOLDER_ID) {
      Folder folder=DLAppServiceUtil.getFolder(folderId);
      zipFileName=folder.getName();
    }
    file=zipWriter.getFile();
    inputStream=new FileInputStream(file);
    ServletResponseUtil.sendFile(request,response,zipFileName,inputStream,ContentTypes.APPLICATION_ZIP);
  }
  finally {
    StreamUtil.cleanUp(inputStream);
    if (file != null) {
      file.delete();
    }
  }
}
