{
  try {
    PortalInstances.getCompanyId(request);
    String remoteUser=request.getRemoteUser();
    if (_log.isDebugEnabled()) {
      _log.debug("Remote user " + remoteUser);
    }
    if (remoteUser != null) {
      PrincipalThreadLocal.setName(remoteUser);
      long userId=GetterUtil.getLong(remoteUser);
      User user=UserLocalServiceUtil.getUserById(userId);
      PermissionChecker permissionChecker=PermissionCheckerFactoryUtil.create(user);
      PermissionThreadLocal.setPermissionChecker(permissionChecker);
    }
    if (_pluginClassLoader == null) {
      super.service(request,response);
    }
 else {
      Thread currentThread=Thread.currentThread();
      ClassLoader contextClassLoader=currentThread.getContextClassLoader();
      try {
        currentThread.setContextClassLoader(_pluginClassLoader);
        super.service(request,response);
      }
  finally {
        currentThread.setContextClassLoader(contextClassLoader);
      }
    }
  }
 catch (  IOException ioe) {
    throw ioe;
  }
catch (  ServletException se) {
    throw se;
  }
catch (  Exception e) {
    throw new ServletException(e);
  }
}
