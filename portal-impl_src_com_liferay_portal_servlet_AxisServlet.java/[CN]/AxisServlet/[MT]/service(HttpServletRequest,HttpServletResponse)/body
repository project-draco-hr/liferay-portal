{
  PermissionCheckerImpl permissionChecker=null;
  try {
    String remoteUser=req.getRemoteUser();
    if (_log.isDebugEnabled()) {
      _log.debug("Remote user " + remoteUser);
    }
    if (remoteUser != null) {
      PrincipalThreadLocal.setName(remoteUser);
      long userId=GetterUtil.getLong(remoteUser);
      User user=UserLocalServiceUtil.getUserById(userId);
      permissionChecker=PermissionCheckerFactory.create(user,true);
      PermissionThreadLocal.setPermissionChecker(permissionChecker);
    }
    StringServletResponse stringServletRes=new StringServletResponse(res);
    super.service(req,stringServletRes);
    String xml=stringServletRes.getString();
    xml=fixXml(xml);
    res.setContentType(ContentTypes.TEXT_XML_UTF8);
    ServletResponseUtil.write(new UncommittedServletResponse(res),xml.getBytes(StringPool.UTF8));
  }
 catch (  Exception e) {
    _log.error(e,e);
  }
 finally {
    try {
      PermissionCheckerFactory.recycle(permissionChecker);
    }
 catch (    Exception e) {
    }
  }
}
