{
  try {
    PortalInstances.getCompanyId(request);
    String remoteUser=request.getRemoteUser();
    if (_log.isDebugEnabled()) {
      _log.debug("Remote user " + remoteUser);
    }
    if (remoteUser != null) {
      PrincipalThreadLocal.setName(remoteUser);
      long userId=GetterUtil.getLong(remoteUser);
      User user=UserLocalServiceUtil.getUserById(userId);
      PermissionChecker permissionChecker=PermissionCheckerFactoryUtil.create(user,true);
      PermissionThreadLocal.setPermissionChecker(permissionChecker);
    }
    StringServletResponse stringResponse=new StringServletResponse(response);
    super.service(request,stringResponse);
    String contentType=stringResponse.getContentType();
    response.setContentType(contentType);
    String content=stringResponse.getString();
    if (contentType.contains(ContentTypes.TEXT_XML)) {
      content=fixXml(content);
    }
    ServletResponseUtil.write(new UncommittedServletResponse(response),content.getBytes(StringPool.UTF8));
  }
 catch (  Exception e) {
    _log.error(e,e);
  }
 finally {
    CompanyThreadLocal.setCompanyId(0);
    PrincipalThreadLocal.setName(null);
    PermissionThreadLocal.setPermissionChecker(null);
  }
}
