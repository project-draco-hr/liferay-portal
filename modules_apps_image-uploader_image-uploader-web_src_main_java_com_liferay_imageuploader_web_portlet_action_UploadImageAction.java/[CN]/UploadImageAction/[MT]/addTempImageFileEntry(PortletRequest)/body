{
  UploadPortletRequest uploadPortletRequest=PortalUtil.getUploadPortletRequest(portletRequest);
  ThemeDisplay themeDisplay=(ThemeDisplay)portletRequest.getAttribute(WebKeys.THEME_DISPLAY);
  String contentType=uploadPortletRequest.getContentType("fileName");
  String fileName=uploadPortletRequest.getFileName("fileName");
  File file=uploadPortletRequest.getFile("fileName");
  String mimeType=MimeTypesUtil.getContentType(file,fileName);
  if (!StringUtil.equalsIgnoreCase(ContentTypes.APPLICATION_OCTET_STREAM,mimeType)) {
    contentType=mimeType;
  }
  if (!MimeTypesUtil.isWebImage(contentType)) {
    throw new ImageTypeException();
  }
  try {
    TempFileEntryUtil.deleteTempFileEntry(themeDisplay.getScopeGroupId(),themeDisplay.getUserId(),getTempImageFolderName(),fileName);
  }
 catch (  Exception e) {
  }
  return TempFileEntryUtil.addTempFileEntry(themeDisplay.getScopeGroupId(),themeDisplay.getUserId(),getTempImageFolderName(),fileName,file,contentType);
}
