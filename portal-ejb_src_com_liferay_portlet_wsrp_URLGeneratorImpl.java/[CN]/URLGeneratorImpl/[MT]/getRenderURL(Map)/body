{
  PortletURL url=_renderResponse.createRenderURL();
  if (params != null) {
    Iterator iter=params.keySet().iterator();
    String paramName="";
    String paramValue="";
    while (iter.hasNext()) {
      paramName=(String)iter.next();
      if (paramName.equalsIgnoreCase(Constants.WINDOW_STATE)) {
        if ((paramValue=(String)params.get(paramName)) != null) {
          setWindowState(url,paramValue);
        }
      }
 else       if (paramName.equalsIgnoreCase(Constants.PORTLET_MODE)) {
        if ((paramValue=(String)params.get(paramName)) != null) {
          setPortletMode(url,paramValue);
        }
      }
 else {
        if (!paramName.equalsIgnoreCase(Constants.URL_TYPE) && (paramValue=(String)params.get(paramName)) != null) {
          url.setParameter(paramName,paramValue);
        }
      }
    }
  }
  if (_consumerParameters != null) {
    Iterator iter2=_consumerParameters.keySet().iterator();
    String name=null;
    String value=null;
    while (iter2.hasNext()) {
      if ((value=(String)_consumerParameters.get(name)) != null) {
        url.setParameter(name,value);
      }
    }
  }
  url.setParameter(WSRPProxyPortlet.REMOTE_INVOCATION,"true");
  return url.toString();
}
