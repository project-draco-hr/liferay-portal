{
  if (_lockLocalService.isLocked(MarketplaceStorePortlet.class.getName(),StringPool.BLANK)) {
    throw new DuplicateLockException(null);
  }
  Lock lock=_lockLocalService.lock(MarketplaceStorePortlet.class.getName(),StringPool.BLANK,StringPool.BLANK);
  try {
    String[] appPackageIds=ParamUtil.getParameterValues(actionRequest,"appPackageIds");
    JSONObject jsonObject=JSONFactoryUtil.createJSONObject();
    jsonObject.put("cmd","updatedApps");
    jsonObject.put("message","success");
    JSONArray jsonArray=JSONFactoryUtil.createJSONArray();
    for (    String appPackage : appPackageIds) {
      File file=null;
      try {
        int appPackageId=Integer.valueOf(appPackage);
        if (appPackageId > 0) {
          file=FileUtil.createTempFile();
          downloadApp(actionRequest,actionResponse,appPackageId,false,file);
          App app=_appService.updateApp(file);
          _appService.installApp(app.getRemoteAppId());
          jsonArray.put(getAppJSONObject(app));
        }
      }
  finally {
        if (file != null) {
          file.delete();
        }
      }
    }
    writeJSON(actionRequest,actionResponse,jsonObject);
  }
  finally {
    _lockLocalService.unlock(lock.getClassName(),lock.getKey());
  }
}
