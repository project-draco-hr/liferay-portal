{
  User user=UserUtil.findByPrimaryKey(userId);
  long groupId=PortalUtil.getPortletGroupId(plid);
  parentFolderId=getParentFolderId(groupId,parentFolderId);
  Date now=new Date();
  validate(name);
  String folderId=String.valueOf(CounterLocalServiceUtil.increment(DLFolder.class.getName()));
  DLFolder folder=DLFolderUtil.create(folderId);
  folder.setGroupId(groupId);
  folder.setCompanyId(user.getCompanyId());
  folder.setUserId(user.getUserId());
  folder.setCreateDate(now);
  folder.setModifiedDate(now);
  folder.setParentFolderId(parentFolderId);
  folder.setName(name);
  folder.setDescription(description);
  DLFolderUtil.update(folder);
  if ((addCommunityPermissions != null) && (addGuestPermissions != null)) {
    addFolderResources(folder,addCommunityPermissions.booleanValue(),addGuestPermissions.booleanValue());
  }
 else {
    addFolderResources(folder,communityPermissions,guestPermissions);
  }
  boolean layoutsSyncEnabled=GetterUtil.getBoolean(PropsUtil.get(PropsUtil.DL_LAYOUTS_SYNC_ENABLED));
  if (layoutsSyncEnabled && !parentFolderId.equals(DLFolderImpl.DEFAULT_PARENT_FOLDER_ID)) {
    DLFolder parentFolder=DLFolderUtil.findByPrimaryKey(parentFolderId);
    String parentFolderName=parentFolder.getName();
    String layoutsSyncPrivateFolder=GetterUtil.getString(PropsUtil.get(PropsUtil.DL_LAYOUTS_SYNC_PRIVATE_FOLDER));
    String layoutsSyncPublicFolder=GetterUtil.getString(PropsUtil.get(PropsUtil.DL_LAYOUTS_SYNC_PUBLIC_FOLDER));
    if (parentFolderName.equals(layoutsSyncPrivateFolder) || parentFolderName.equals(layoutsSyncPublicFolder)) {
      boolean privateLayout=true;
      if (parentFolderName.equals(layoutsSyncPublicFolder)) {
        privateLayout=false;
      }
      String parentLayoutId=LayoutImpl.DEFAULT_PARENT_LAYOUT_ID;
      String title=StringPool.BLANK;
      String type=LayoutImpl.TYPE_PORTLET;
      boolean hidden=false;
      String friendlyURL=StringPool.BLANK;
      LayoutLocalServiceUtil.addLayout(groupId,userId,privateLayout,parentLayoutId,name,title,type,hidden,friendlyURL);
    }
  }
  return folder;
}
