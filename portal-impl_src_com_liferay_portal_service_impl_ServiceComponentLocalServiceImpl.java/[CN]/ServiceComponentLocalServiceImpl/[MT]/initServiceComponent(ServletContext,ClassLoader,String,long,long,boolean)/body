{
  try {
    ModelHintsUtil.read(classLoader,"META-INF/portlet-model-hints.xml");
  }
 catch (  Exception e) {
    throw new SystemException(e);
  }
  try {
    ModelHintsUtil.read(classLoader,"META-INF/portlet-model-hints-ext.xml");
  }
 catch (  Exception e) {
    throw new SystemException(e);
  }
  ServiceComponent serviceComponent=null;
  ServiceComponent previousServiceComponent=null;
  List<ServiceComponent> serviceComponents=serviceComponentPersistence.findByBuildNamespace(buildNamespace,0,1);
  if (serviceComponents.size() == 0) {
    long serviceComponentId=counterLocalService.increment();
    serviceComponent=serviceComponentPersistence.create(serviceComponentId);
    serviceComponent.setBuildNamespace(buildNamespace);
    serviceComponent.setBuildNumber(buildNumber);
    serviceComponent.setBuildDate(buildDate);
  }
 else {
    serviceComponent=serviceComponents.get(0);
    if (serviceComponent.getBuildNumber() < buildNumber) {
      previousServiceComponent=serviceComponent;
      long serviceComponentId=counterLocalService.increment();
      serviceComponent=serviceComponentPersistence.create(serviceComponentId);
      serviceComponent.setBuildNamespace(buildNamespace);
      serviceComponent.setBuildNumber(buildNumber);
      serviceComponent.setBuildDate(buildDate);
    }
 else     if (serviceComponent.getBuildNumber() > buildNumber) {
      throw new OldServiceComponentException("Build namespace " + buildNamespace + " has build number "+ serviceComponent.getBuildNumber()+ " which is newer than "+ buildNumber);
    }
 else {
      return serviceComponent;
    }
  }
  try {
    Document document=SAXReaderUtil.createDocument(StringPool.UTF8);
    Element dataElement=document.addElement("data");
    String tablesSQL=HttpUtil.URLtoString(servletContext.getResource("/WEB-INF/sql/tables.sql"));
    dataElement.addElement("tables-sql").addCDATA(tablesSQL);
    String sequencesSQL=HttpUtil.URLtoString(servletContext.getResource("/WEB-INF/sql/sequences.sql"));
    dataElement.addElement("sequences-sql").addCDATA(sequencesSQL);
    String indexesSQL=HttpUtil.URLtoString(servletContext.getResource("/WEB-INF/sql/indexes.sql"));
    dataElement.addElement("indexes-sql").addCDATA(indexesSQL);
    String dataXML=document.formattedString();
    serviceComponent.setData(dataXML);
    serviceComponentPersistence.update(serviceComponent,false);
    serviceComponentLocalService.upgradeDB(classLoader,buildNamespace,buildNumber,buildAutoUpgrade,previousServiceComponent,tablesSQL,sequencesSQL,indexesSQL);
    removeOldServiceComponents(buildNamespace);
    return serviceComponent;
  }
 catch (  Exception e) {
    throw new SystemException(e);
  }
}
