{
  User user=userPersistence.findByPrimaryKey(userId);
  listKey=listKey.trim().toUpperCase();
  if (autoListKey) {
    listKey=String.valueOf(counterLocalService.increment());
  }
  Date now=new Date();
  validate(groupId,structureId,listKey,autoListKey,nameMap);
  long listId=counterLocalService.increment();
  DDMList list=ddmListPersistence.create(listId);
  list.setUuid(serviceContext.getUuid());
  list.setGroupId(groupId);
  list.setCompanyId(user.getCompanyId());
  list.setUserId(user.getUserId());
  list.setUserName(user.getFullName());
  list.setCreateDate(serviceContext.getCreateDate(now));
  list.setModifiedDate(serviceContext.getModifiedDate(now));
  list.setStructureId(structureId);
  list.setListKey(listKey);
  list.setNameMap(nameMap);
  list.setDescription(description);
  ddmListPersistence.update(list,false);
  if (serviceContext.getAddCommunityPermissions() || serviceContext.getAddGuestPermissions()) {
    addListResources(list,serviceContext.getAddCommunityPermissions(),serviceContext.getAddGuestPermissions());
  }
 else {
    addListResources(list,serviceContext.getCommunityPermissions(),serviceContext.getGuestPermissions());
  }
  return list;
}
