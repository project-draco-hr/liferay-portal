{
  Portal portal=getPortal();
  UploadPortletRequest uploadPortletRequest=portal.getUploadPortletRequest(actionRequest);
  checkExceededSizeLimit(actionRequest);
  ThemeDisplay themeDisplay=(ThemeDisplay)actionRequest.getAttribute(WebKeys.THEME_DISPLAY);
  long resourcePrimKey=ParamUtil.getLong(actionRequest,"resourcePrimKey");
  String sourceFileName=uploadPortletRequest.getFileName("file");
  InputStream inputStream=null;
  try {
    KBArticleService kbArticleService=getKBArticleService();
    inputStream=uploadPortletRequest.getFileAsStream("file");
    String mimeType=uploadPortletRequest.getContentType("file");
    kbArticleService.addTempAttachment(themeDisplay.getScopeGroupId(),resourcePrimKey,sourceFileName,KnowledgeBaseConstants.TEMP_FOLDER_NAME,inputStream,mimeType);
  }
  finally {
    StreamUtil.cleanUp(inputStream);
  }
}
