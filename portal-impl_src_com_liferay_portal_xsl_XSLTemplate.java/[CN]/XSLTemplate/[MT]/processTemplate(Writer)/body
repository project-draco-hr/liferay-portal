{
  Locale locale=LocaleUtil.fromLanguageId(_xslTemplateResource.getLanguageId());
  XSLErrorListener xslErrorListener=new XSLErrorListener(locale);
  URIResolver uriResolver=new URIResolver(_xslTemplateResource.getTokens(),_xslTemplateResource.getLanguageId());
  TransformerFactory transformerFactory=TransformerFactory.newInstance();
  transformerFactory.setErrorListener(xslErrorListener);
  transformerFactory.setURIResolver(uriResolver);
  StreamSource xmlSource=new StreamSource(_xslTemplateResource.getXMLReader());
  Transformer transformer=_getTransformer(transformerFactory,_xslTemplateResource);
  if (_errorTemplateResource == null) {
    try {
      transformer.transform(xmlSource,new StreamResult(writer));
      return true;
    }
 catch (    Exception e) {
      throw new TemplateException("Unable to process XSL template " + _xslTemplateResource.getTemplateId(),e);
    }
  }
  try {
    UnsyncStringWriter unsyncStringWriter=new UnsyncStringWriter();
    transformer.setParameter(WRITER,unsyncStringWriter);
    transformer.transform(xmlSource,new StreamResult(unsyncStringWriter));
    StringBundler sb=unsyncStringWriter.getStringBundler();
    sb.writeTo(writer);
    return true;
  }
 catch (  Exception e1) {
    Transformer errorTransformer=_getTransformer(transformerFactory,_errorTemplateResource);
    errorTransformer.setParameter(WRITER,writer);
    errorTransformer.setParameter("exception",xslErrorListener.getMessageAndLocation());
    if (_errorTemplateResource instanceof StringTemplateResource) {
      StringTemplateResource stringTemplateResource=(StringTemplateResource)_errorTemplateResource;
      errorTransformer.setParameter("script",stringTemplateResource.getContent());
    }
    if (xslErrorListener.getLocation() != null) {
      errorTransformer.setParameter("column",new Integer(xslErrorListener.getColumnNumber()));
      errorTransformer.setParameter("line",new Integer(xslErrorListener.getLineNumber()));
    }
    try {
      errorTransformer.transform(xmlSource,new StreamResult(writer));
    }
 catch (    Exception e2) {
      throw new TemplateException("Unable to process XSL template " + _errorTemplateResource.getTemplateId(),e2);
    }
    return false;
  }
}
