{
  long userId=portletDataContext.getUserId(page.getUserUuid());
  String nodePath=ExportImportPathUtil.getModelPath(portletDataContext,WikiNode.class.getName(),page.getNodeId());
  WikiNode node=(WikiNode)portletDataContext.getZipEntryAsObject(nodePath);
  StagedModelDataHandlerUtil.importStagedModel(portletDataContext,node);
  Element pageElement=portletDataContext.getImportDataStagedModelElement(page);
  String content=ExportImportHelperUtil.replaceImportContentReferences(portletDataContext,pageElement,page.getContent(),portletDataContext.getBooleanParameter(WikiPortletDataHandler.NAMESPACE,"embedded-assets"));
  page.setContent(content);
  ServiceContext serviceContext=portletDataContext.createServiceContext(page,WikiPortletDataHandler.NAMESPACE);
  Map<Long,Long> nodeIds=(Map<Long,Long>)portletDataContext.getNewPrimaryKeysMap(WikiNode.class);
  long nodeId=MapUtil.getLong(nodeIds,page.getNodeId(),page.getNodeId());
  WikiPage importedPage=null;
  WikiPage existingPage=WikiPageUtil.fetchByUUID_G(page.getUuid(),portletDataContext.getScopeGroupId());
  if (existingPage == null) {
    try {
      existingPage=WikiPageLocalServiceUtil.getPage(nodeId,page.getTitle());
    }
 catch (    NoSuchPageException nspe) {
    }
  }
  if (existingPage == null) {
    serviceContext.setUuid(page.getUuid());
    importedPage=WikiPageLocalServiceUtil.addPage(userId,nodeId,page.getTitle(),page.getVersion(),page.getContent(),page.getSummary(),page.isMinorEdit(),page.getFormat(),page.getHead(),page.getParentTitle(),page.getRedirectTitle(),serviceContext);
  }
 else {
    importedPage=WikiPageLocalServiceUtil.updatePage(userId,nodeId,existingPage.getTitle(),0,page.getContent(),page.getSummary(),page.isMinorEdit(),page.getFormat(),page.getParentTitle(),page.getRedirectTitle(),serviceContext);
  }
  if (page.isHead()) {
    List<Element> attachmentElements=portletDataContext.getReferenceDataElements(pageElement,FileEntry.class,PortletDataContext.REFERENCE_TYPE_WEAK);
    for (    Element attachmentElement : attachmentElements) {
      String path=attachmentElement.attributeValue("path");
      String binPath=attachmentElement.attributeValue("bin-path");
      FileEntry fileEntry=(FileEntry)portletDataContext.getZipEntryAsObject(path);
      InputStream inputStream=null;
      String mimeType=null;
      try {
        inputStream=portletDataContext.getZipEntryAsInputStream(binPath);
        mimeType=MimeTypesUtil.getContentType(inputStream,fileEntry.getTitle());
      }
  finally {
        StreamUtil.cleanUp(inputStream);
      }
      try {
        inputStream=portletDataContext.getZipEntryAsInputStream(binPath);
        WikiPageLocalServiceUtil.addPageAttachment(userId,importedPage.getNodeId(),importedPage.getTitle(),fileEntry.getTitle(),inputStream,mimeType);
      }
  finally {
        StreamUtil.cleanUp(inputStream);
      }
    }
  }
  portletDataContext.importClassedModel(page,importedPage,WikiPortletDataHandler.NAMESPACE);
}
