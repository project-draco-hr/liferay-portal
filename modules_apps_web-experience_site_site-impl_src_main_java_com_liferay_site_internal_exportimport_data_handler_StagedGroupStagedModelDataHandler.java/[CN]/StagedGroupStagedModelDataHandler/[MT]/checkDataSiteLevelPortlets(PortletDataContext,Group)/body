{
  List<Portlet> dataSiteLevelPortlets=ExportImportHelperUtil.getDataSiteLevelPortlets(portletDataContext.getCompanyId());
  Group liveGroup=group;
  if (liveGroup.isStagingGroup()) {
    liveGroup=liveGroup.getLiveGroup();
  }
  Set<String> portletIds=new HashSet<>();
  Element rootElement=portletDataContext.getExportDataRootElement();
  Element headerElement=rootElement.element("header");
  String type=headerElement.attributeValue("type");
  for (  Portlet portlet : dataSiteLevelPortlets) {
    String portletId=portlet.getRootPortletId();
    if (ExportImportThreadLocal.isStagingInProcess() && !liveGroup.isStagedPortlet(portletId)) {
      continue;
    }
    if (BackgroundTaskThreadLocal.hasBackgroundTask()) {
      Map<String,Boolean> exportPortletControlsMap=ExportImportHelperUtil.getExportPortletControlsMap(portletDataContext.getCompanyId(),portletId,portletDataContext.getParameterMap(),type);
      if (exportPortletControlsMap.get(PortletDataHandlerKeys.PORTLET_DATA)) {
        PortletDataHandler portletDataHandler=portlet.getPortletDataHandlerInstance();
        portletDataHandler.prepareManifestSummary(portletDataContext);
      }
    }
    portletIds.add(portletId);
  }
  return portletIds;
}
