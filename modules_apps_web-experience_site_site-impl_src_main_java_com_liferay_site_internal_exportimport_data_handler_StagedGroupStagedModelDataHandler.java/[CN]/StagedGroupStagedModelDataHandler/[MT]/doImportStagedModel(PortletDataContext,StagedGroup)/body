{
  Element rootElement=portletDataContext.getImportDataRootElement();
  Element sitePortletsElement=rootElement.element("site-portlets");
  List<Element> sitePortletElements=sitePortletsElement.elements();
  if (BackgroundTaskThreadLocal.hasBackgroundTask()) {
    List<String> portletIds=new ArrayList<>();
    for (    Element portletElement : sitePortletElements) {
      String portletId=portletElement.attributeValue("portlet-id");
      Portlet portlet=_portletLocalService.getPortletById(portletDataContext.getCompanyId(),portletId);
      if (!portlet.isActive() || portlet.isUndeployedPortlet()) {
        continue;
      }
      portletIds.add(portletId);
    }
    PortletDataHandlerStatusMessageSenderUtil.sendStatusMessage("layout",ArrayUtil.toStringArray(portletIds),portletDataContext.getManifestSummary());
  }
  if (_log.isDebugEnabled() && !sitePortletElements.isEmpty()) {
    _log.debug("Importing portlets");
  }
  importSitePortlets(portletDataContext,sitePortletElements);
  Element siteServicesElement=rootElement.element("site-services");
  List<Element> siteServiceElements=siteServicesElement.elements("service");
  if (_log.isDebugEnabled() && !siteServiceElements.isEmpty()) {
    _log.debug("Importing services");
  }
  importSiteServices(portletDataContext,siteServiceElements);
  portletDataContext.setImportDataRootElement(rootElement);
  Element layoutSetElement=portletDataContext.getImportDataGroupElement(StagedLayoutSet.class);
  for (  Element groupElement : layoutSetElement.elements()) {
    StagedModelDataHandlerUtil.importStagedModel(portletDataContext,groupElement);
  }
}
