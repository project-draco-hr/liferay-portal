{
  try {
    ThemeDisplay themeDisplay=(ThemeDisplay)req.getAttribute(WebKeys.THEME_DISPLAY);
    int start=(startPage * itemsPerPage) - itemsPerPage;
    int end=startPage * itemsPerPage;
    Hits results=getHits(themeDisplay.getCompanyId(),keywords,start,end);
    int total=results.getLength();
    Object[] values=addSearchResults(keywords,startPage,itemsPerPage,total,start,getTitle(keywords),getSearchPath(),themeDisplay);
    org.dom4j.Document doc=(org.dom4j.Document)values[0];
    Element root=(Element)values[1];
    for (int i=0; i < results.getDocs().length; i++) {
      Document result=results.doc(i);
      String portletId=result.get(Field.PORTLET_ID);
      Portlet portlet=PortletLocalServiceUtil.getPortletById(themeDisplay.getCompanyId(),portletId);
      long groupId=GetterUtil.getLong(result.get(Field.GROUP_ID));
      PortletURL portletURL=getPortletURL(req,portletId,groupId);
      Indexer indexer=(Indexer)InstancePool.get(portlet.getIndexerClass());
      DocumentSummary docSummary=indexer.getDocumentSummary(result,portletURL);
      String title=docSummary.getTitle();
      String url=getURL(themeDisplay,groupId,result,portletURL);
      Date modifedDate=DateTools.stringToDate(result.get(Field.MODIFIED));
      String content=docSummary.getContent();
      Field tagField=(Field)result.getFields().get(Field.TAGS_ENTRIES);
      String[] tags=tagField.getValues();
      double rating=0.0;
      try {
        String entryClassname=result.get(Field.ENTRY_CLASS_NAME);
        String entryId=result.get(Field.ENTRY_ID);
        if (entryClassname != null && entryId != null) {
          RatingsStats stats=RatingsStatsLocalServiceUtil.getStats(entryClassname,GetterUtil.getLong(entryId));
          rating=stats.getAverageScore();
        }
      }
 catch (      Exception e) {
        rating=0;
      }
      double score=results.score(i);
      addSearchResult(root,title,url,modifedDate,content,tags,score,rating);
    }
    if (_log.isDebugEnabled()) {
      _log.debug("Return\n" + doc.asXML());
    }
    return doc.asXML();
  }
 catch (  Exception e) {
    throw new SearchException(e);
  }
}
