{
  List<String> serviceAccessControlProfileNames=ServiceAccessPolicyThreadLocal.getActiveServiceAccessPolicyNames();
  SACPConfiguration sacpConfiguration=null;
  try {
    sacpConfiguration=_settingsFactory.getSettings(SACPConfiguration.class,new CompanyServiceSettingsLocator(CompanyThreadLocal.getCompanyId(),SAPConstants.SERVICE_NAME));
  }
 catch (  SettingsException se) {
    throw new SecurityException("Unable to determine default service access control profile",se);
  }
  if (sacpConfiguration.requireDefaultSACPEntry() || (serviceAccessControlProfileNames == null)) {
    if (serviceAccessControlProfileNames == null) {
      serviceAccessControlProfileNames=new ArrayList<>();
      ServiceAccessPolicyThreadLocal.setActiveServiceAccessPolicyNames(serviceAccessControlProfileNames);
    }
    boolean passwordBasedAuthentication=false;
    AccessControlContext accessControlContext=AccessControlUtil.getAccessControlContext();
    if (accessControlContext != null) {
      AuthVerifierResult authVerifierResult=accessControlContext.getAuthVerifierResult();
      if (authVerifierResult != null) {
        passwordBasedAuthentication=authVerifierResult.isPasswordBasedAuthentication();
      }
    }
    if (passwordBasedAuthentication) {
      serviceAccessControlProfileNames.add(sacpConfiguration.defaultUserSACPEntryName());
    }
 else {
      serviceAccessControlProfileNames.add(sacpConfiguration.defaultApplicationSACPEntryName());
    }
  }
  long companyId=CompanyThreadLocal.getCompanyId();
  Set<String> allowedServiceSignatures=new HashSet<>();
  for (  String name : serviceAccessControlProfileNames) {
    try {
      SACPEntry sacpEntry=_sacpEntryLocalService.getSACPEntry(companyId,name);
      allowedServiceSignatures.addAll(sacpEntry.getAllowedServiceSignaturesList());
    }
 catch (    PortalException pe) {
      throw new SecurityException(pe);
    }
  }
  if (allowedServiceSignatures.contains(StringPool.STAR)) {
    return;
  }
  Class<?> clazz=method.getDeclaringClass();
  String className=clazz.getName();
  if (allowedServiceSignatures.contains(className)) {
    return;
  }
  String methodName=method.getName();
  String classNameAndMethodName=className.concat(StringPool.POUND).concat(methodName);
  if (allowedServiceSignatures.contains(classNameAndMethodName)) {
    return;
  }
  for (  String allowedService : allowedServiceSignatures) {
    if (matches(className,methodName,allowedService)) {
      return;
    }
  }
  throw new SecurityException("Access denied to " + classNameAndMethodName);
}
