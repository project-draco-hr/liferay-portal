{
  int pos=recipient.indexOf(StringPool.AT);
  String target=recipient.substring(MBUtil.SMTP_PORTLET_PREFIX.length(),pos);
  String[] parts=StringUtil.split(target,".");
  long parentMessageId=0;
  if (parts.length == 2) {
    parentMessageId=GetterUtil.getLong(parts[1]);
  }
  if (parentMessageId > 0) {
    return parentMessageId;
  }
  String parentHeader=null;
  String[] references=message.getHeader("References");
  if ((references != null) && (references.length > 0)) {
    parentHeader=references[0].substring(references[0].lastIndexOf("<"));
  }
  if (parentHeader == null) {
    String[] inReplyToHeaders=message.getHeader("In-Reply-To");
    if ((inReplyToHeaders != null) && (inReplyToHeaders.length > 0)) {
      parentHeader=inReplyToHeaders[0];
    }
  }
  if (parentHeader != null) {
    if (_log.isDebugEnabled()) {
      _log.debug("Parent header " + parentHeader);
    }
    if (parentMessageId == -1) {
      parentMessageId=MBUtil.getMessageId(parentHeader);
    }
    if (_log.isDebugEnabled()) {
      _log.debug("Previous message id " + parentMessageId);
    }
  }
  return parentMessageId;
}
