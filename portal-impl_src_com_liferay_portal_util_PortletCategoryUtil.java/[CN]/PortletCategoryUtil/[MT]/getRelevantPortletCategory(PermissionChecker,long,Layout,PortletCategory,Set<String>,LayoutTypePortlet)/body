{
  PortletCategory relevantPortletCategory=new PortletCategory(portletCategory.getName(),portletCategory.getPortletIds());
  for (  PortletCategory curPortletCategory : portletCategory.getCategories()) {
    Set<String> portletIds=new HashSet<String>();
    if (curPortletCategory.isHidden()) {
      continue;
    }
    for (    String portletId : curPortletCategory.getPortletIds()) {
      Portlet portlet=PortletLocalServiceUtil.getPortletById(companyId,portletId);
      if (portlet != null) {
        if (portlet.isSystem()) {
        }
 else         if (!portlet.isActive() || portlet.isUndeployedPortlet()) {
        }
 else         if (layout.isTypePanel() && panelSelectedPortletIds.contains(portlet.getRootPortletId())) {
          portletIds.add(portlet.getPortletId());
        }
 else         if (layout.isTypePanel() && !panelSelectedPortletIds.contains(portlet.getRootPortletId())) {
        }
 else         if (!PortletPermissionUtil.contains(permissionChecker,layout,portlet,ActionKeys.ADD_TO_PAGE)) {
        }
 else         if (!portlet.isInstanceable() && layoutTypePortlet.hasPortletId(portlet.getPortletId())) {
          portletIds.add(portlet.getPortletId());
        }
 else {
          portletIds.add(portlet.getPortletId());
        }
      }
    }
    PortletCategory curRelevantPortletCategory=getRelevantPortletCategory(permissionChecker,companyId,layout,curPortletCategory,panelSelectedPortletIds,layoutTypePortlet);
    curRelevantPortletCategory.setPortletIds(portletIds);
    if (!curRelevantPortletCategory.getCategories().isEmpty() || !portletIds.isEmpty()) {
      relevantPortletCategory.addCategory(curRelevantPortletCategory);
    }
  }
  return relevantPortletCategory;
}
