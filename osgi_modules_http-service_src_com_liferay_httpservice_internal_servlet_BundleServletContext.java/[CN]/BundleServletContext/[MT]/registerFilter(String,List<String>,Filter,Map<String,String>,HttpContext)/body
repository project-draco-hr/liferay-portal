{
  validateFilter(filterName,filter,urlPatterns,httpContext);
  Thread currentThread=Thread.currentThread();
  ClassLoader contextClassLoader=currentThread.getContextClassLoader();
  try {
    currentThread.setContextClassLoader(getClassLoader());
    FilterConfig filterConfig=new BundleFilterConfig(this,filterName,initParameters,httpContext);
    filter.init(filterConfig);
    _filtersByFilterNames.put(filterName,filter);
    if (_log.isInfoEnabled()) {
      _log.info("Registered filter " + filterName);
    }
    for (    String urlPattern : urlPatterns) {
      _filtersByURLPatterns.put(urlPattern,filter);
      if (_log.isInfoEnabled()) {
        _log.info("Mapped filter " + filterName + " to "+ getContextPath()+ urlPattern);
      }
    }
    int serviceRanking=GetterUtil.getInteger(initParameters.remove("service.ranking"));
    if ((serviceRanking <= 0) && !_filtersByServiceOrder.isEmpty()) {
      serviceRanking=_filtersByServiceOrder.lastKey() + 1;
    }
    _filtersByServiceOrder.put(serviceRanking,filterName);
  }
  finally {
    currentThread.setContextClassLoader(contextClassLoader);
  }
}
