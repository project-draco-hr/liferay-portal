{
  validate(filterMapping,filter,httpContext);
  Thread currentThread=Thread.currentThread();
  ClassLoader contextClassLoader=currentThread.getContextClassLoader();
  int serviceRanking=GetterUtil.getInteger(initParameters.remove(HttpServicePropsKeys.SERVICE_RANKING));
  try {
    currentThread.setContextClassLoader(getClassLoader());
    FilterConfig filterConfig=new BundleFilterConfig(this,filterMapping,initParameters,httpContext);
    filter.init(filterConfig);
    _filtersMap.put(filterMapping,filter);
    if ((serviceRanking <= 0) && !_filterTreeMap.isEmpty()) {
      serviceRanking=_filterTreeMap.lastKey() + 1;
    }
    _filterTreeMap.put(serviceRanking,new Object[]{filterMapping,filter});
  }
  finally {
    currentThread.setContextClassLoader(contextClassLoader);
  }
}
