{
  SyncContext syncContext=JSONUtil.readValue(response,SyncContext.class);
  SyncAccount syncAccount=SyncAccountService.fetchSyncAccount(getSyncAccountId());
  SyncUser remoteSyncUser=syncContext.getSyncUser();
  if (remoteSyncUser == null) {
    throw new HttpResponseException(HttpStatus.SC_UNAUTHORIZED,"Authenticated access required");
  }
  SyncUser localSyncUser=SyncUserService.fetchSyncUser(syncAccount.getSyncAccountId());
  if ((localSyncUser.getUserId() > 0) && (localSyncUser.getUserId() != remoteSyncUser.getUserId())) {
    syncAccount.setState(SyncAccount.STATE_DISCONNECTED);
    syncAccount.setUiEvent(SyncAccount.UI_EVENT_AUTHENTICATION_EXCEPTION);
    SyncAccountService.update(syncAccount);
    return syncContext;
  }
  if (!syncAccount.isOAuthEnabled()) {
    String login=syncAccount.getLogin();
    if (login == null) {
      login="";
    }
    String authType=syncContext.getAuthType();
    if (authType.equals(SyncContext.AUTH_TYPE_EMAIL_ADDRESS)) {
      if (!login.equals(remoteSyncUser.getEmailAddress())) {
        syncAccount.setLogin(remoteSyncUser.getEmailAddress());
      }
    }
 else     if (authType.equals(SyncContext.AUTH_TYPE_SCREEN_NAME)) {
      if (!login.equals(remoteSyncUser.getScreenName())) {
        syncAccount.setLogin(remoteSyncUser.getScreenName());
      }
    }
 else     if (authType.equals(SyncContext.AUTH_TYPE_USER_ID)) {
      if (!login.equals(String.valueOf(remoteSyncUser.getUserId()))) {
        syncAccount.setLogin(String.valueOf(remoteSyncUser.getUserId()));
      }
    }
  }
  remoteSyncUser.setSyncAccountId(localSyncUser.getSyncAccountId());
  remoteSyncUser.setSyncUserId(localSyncUser.getSyncUserId());
  SyncUserService.update(remoteSyncUser);
  Map<String,String> portletPreferencesMap=syncContext.getPortletPreferencesMap();
  int authenticationRetryInterval=GetterUtil.getInteger(portletPreferencesMap.get(SyncContext.PREFERENCE_KEY_AUTHENTICATION_RETRY_INTERVAL),60);
  syncAccount.setAuthenticationRetryInterval(authenticationRetryInterval);
  int batchFileMaxSize=GetterUtil.getInteger(portletPreferencesMap.get(SyncContext.PREFERENCE_KEY_BATCH_FILE_MAX_SIZE));
  syncAccount.setBatchFileMaxSize(batchFileMaxSize);
  int maxConnections=GetterUtil.getInteger(portletPreferencesMap.get(SyncContext.PREFERENCE_KEY_MAX_CONNECTIONS),1);
  syncAccount.setMaxConnections(maxConnections);
  syncAccount.setPluginVersion(syncContext.getPluginVersion());
  int pollInterval=GetterUtil.getInteger(portletPreferencesMap.get(SyncContext.PREFERENCE_KEY_POLL_INTERVAL),5);
  syncAccount.setPollInterval(pollInterval);
  syncAccount.setSocialOfficeInstalled(syncContext.isSocialOfficeInstalled());
  SyncAccountService.update(syncAccount);
  return syncContext;
}
