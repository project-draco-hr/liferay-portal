{
  long companyId=PortalUtil.getCompanyId(request);
  PortalRequestDataSample portalRequestDataSample=null;
  if (_monitoringPortalRequest) {
    String requestURLString=StringPool.BLANK;
    if (request.getRequestURL() != null) {
      requestURLString=request.getRequestURL().toString();
    }
    portalRequestDataSample=new PortalRequestDataSample(companyId,request.getRemoteUser(),request.getRequestURI(),requestURLString);
  }
  try {
    if (portalRequestDataSample != null) {
      portalRequestDataSample.prepare();
    }
    processFilter(MonitoringFilter.class,request,response,filterChain);
    if (portalRequestDataSample != null) {
      portalRequestDataSample.capture(RequestStatus.SUCCESS);
    }
  }
 catch (  Exception e) {
    if (portalRequestDataSample != null) {
      portalRequestDataSample.capture(RequestStatus.ERROR);
    }
    if (e instanceof IOException) {
      throw (IOException)e;
    }
 else     if (e instanceof ServletException) {
      throw (ServletException)e;
    }
 else {
      throw new ServletException("Unable to execute request",e);
    }
  }
 finally {
    if (portalRequestDataSample != null) {
      DataSampleThreadLocal.addDataSample(portalRequestDataSample);
    }
    MessageBusUtil.sendMessage(DestinationNames.MONITORING,DataSampleThreadLocal.getDataSamples());
  }
}
