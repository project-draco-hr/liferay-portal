{
  String content=null;
  if (page < 1) {
    page=1;
  }
  int numberOfPages=1;
  boolean paginate=false;
  boolean pageFlow=false;
  boolean cacheable=true;
  if (Validator.isNull(xmlRequest)) {
    xmlRequest="<request />";
  }
  Map<String,String> tokens=JournalUtil.getTokens(article.getGroupId(),themeDisplay,xmlRequest);
  if ((themeDisplay == null) && xmlRequest.equals("<request />")) {
    tokens.put("company_id",String.valueOf(article.getCompanyId()));
    Group companyGroup=groupLocalService.getCompanyGroup(article.getCompanyId());
    tokens.put("article_group_id",String.valueOf(article.getGroupId()));
    tokens.put("company_group_id",String.valueOf(companyGroup.getGroupId()));
    tokens.put("group_id",String.valueOf(article.getGroupId()));
  }
  tokens.put("article_resource_pk",String.valueOf(article.getResourcePrimKey()));
  String defaultDDMTemplateKey=article.getTemplateId();
  if (article.isTemplateDriven()) {
    if (Validator.isNull(ddmTemplateKey)) {
      ddmTemplateKey=defaultDDMTemplateKey;
    }
    tokens.put("structure_id",article.getStructureId());
    tokens.put("template_id",ddmTemplateKey);
  }
  String xml=article.getContent();
  try {
    Document document=null;
    Element rootElement=null;
    if (article.isTemplateDriven()) {
      document=SAXReaderUtil.read(xml);
      rootElement=document.getRootElement();
      Document requestDocument=SAXReaderUtil.read(xmlRequest);
      List<Element> pages=rootElement.elements("page");
      if (!pages.isEmpty()) {
        pageFlow=true;
        String targetPage=requestDocument.valueOf("/request/parameters/parameter[name='targetPage']/" + "value");
        Element pageElement=null;
        if (Validator.isNotNull(targetPage)) {
          targetPage=HtmlUtil.escapeXPathAttribute(targetPage);
          XPath xPathSelector=SAXReaderUtil.createXPath("/root/page[@id = " + targetPage + "]");
          pageElement=(Element)xPathSelector.selectSingleNode(document);
        }
        if (pageElement != null) {
          document=SAXReaderUtil.createDocument(pageElement);
          rootElement=document.getRootElement();
          numberOfPages=pages.size();
        }
 else {
          if (page > pages.size()) {
            page=1;
          }
          pageElement=pages.get(page - 1);
          document=SAXReaderUtil.createDocument(pageElement);
          rootElement=document.getRootElement();
          numberOfPages=pages.size();
          paginate=true;
        }
      }
      rootElement.add(requestDocument.getRootElement().createCopy());
      JournalUtil.addAllReservedEls(rootElement,tokens,article,languageId,themeDisplay);
      xml=DDMXMLUtil.formatXML(document);
    }
  }
 catch (  DocumentException de) {
    throw new SystemException(de);
  }
  try {
    if (_log.isDebugEnabled()) {
      _log.debug("Transforming " + article.getArticleId() + " "+ article.getVersion()+ " "+ languageId);
    }
    String script=null;
    String langType=null;
    if (article.isTemplateDriven()) {
      DDMTemplate ddmTemplate=null;
      try {
        ddmTemplate=ddmTemplatePersistence.findByG_C_T(PortalUtil.getSiteGroupId(article.getGroupId()),PortalUtil.getClassNameId(DDMStructure.class),ddmTemplateKey);
      }
 catch (      NoSuchTemplateException nste1) {
        try {
          Group companyGroup=groupLocalService.getCompanyGroup(article.getCompanyId());
          ddmTemplate=ddmTemplatePersistence.findByG_C_T(companyGroup.getGroupId(),PortalUtil.getClassNameId(DDMStructure.class),ddmTemplateKey);
          tokens.put("company_group_id",String.valueOf(companyGroup.getGroupId()));
        }
 catch (        NoSuchTemplateException nste2) {
          if (!defaultDDMTemplateKey.equals(ddmTemplateKey)) {
            ddmTemplate=ddmTemplatePersistence.findByG_C_T(PortalUtil.getSiteGroupId(article.getGroupId()),PortalUtil.getClassNameId(DDMStructure.class),defaultDDMTemplateKey);
          }
 else {
            throw nste1;
          }
        }
      }
      script=ddmTemplate.getScript();
      langType=ddmTemplate.getLanguage();
      cacheable=ddmTemplate.isCacheable();
    }
    content=JournalUtil.transform(themeDisplay,tokens,viewMode,languageId,xml,script,langType);
    if (!pageFlow) {
      String[] pieces=StringUtil.split(content,PropsValues.JOURNAL_ARTICLE_TOKEN_PAGE_BREAK);
      if (pieces.length > 1) {
        if (page > pieces.length) {
          page=1;
        }
        content=pieces[page - 1];
        numberOfPages=pieces.length;
        paginate=true;
      }
    }
  }
 catch (  Exception e) {
    throw new SystemException(e);
  }
  return new JournalArticleDisplayImpl(article.getCompanyId(),article.getId(),article.getResourcePrimKey(),article.getGroupId(),article.getUserId(),article.getArticleId(),article.getVersion(),article.getTitle(languageId),article.getUrlTitle(),article.getDescription(languageId),article.getAvailableLanguageIds(),content,article.getType(),article.getStructureId(),ddmTemplateKey,article.isSmallImage(),article.getSmallImageId(),article.getSmallImageURL(),numberOfPages,page,paginate,cacheable);
}
