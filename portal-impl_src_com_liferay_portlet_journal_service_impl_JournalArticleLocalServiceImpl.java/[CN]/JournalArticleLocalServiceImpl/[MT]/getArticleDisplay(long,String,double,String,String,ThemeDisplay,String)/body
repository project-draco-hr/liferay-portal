{
  String content=null;
  Date now=new Date();
  JournalArticle article=JournalArticleUtil.findByG_A_V(groupId,articleId,version);
  if (article.isExpired()) {
    Date expirationDate=article.getExpirationDate();
    if ((expirationDate != null) && expirationDate.before(now)) {
      return null;
    }
  }
  if (article.getDisplayDate().after(now)) {
    return null;
  }
  Map tokens=JournalUtil.getTokens(groupId,themeDisplay);
  String xml=article.getContent();
  try {
    Document doc=null;
    Element root=null;
    if (article.isTemplateDriven()) {
      SAXReader reader=new SAXReader();
      doc=reader.read(new StringReader(xml));
      root=doc.getRootElement();
      if (Validator.isNotNull(xmlRequest)) {
        try {
          Document request=reader.read(new StringReader(xmlRequest));
          root.add(request.getRootElement().createCopy());
        }
 catch (        Exception e) {
        }
      }
      JournalUtil.addAllReservedEls(root,tokens,article);
      xml=JournalUtil.formatXML(doc);
    }
  }
 catch (  DocumentException de) {
    throw new SystemException(de);
  }
catch (  IOException ioe) {
    throw new SystemException(ioe);
  }
  try {
    if (_log.isDebugEnabled()) {
      _log.debug("Transforming " + articleId + " "+ version+ " "+ languageId);
    }
    String script=null;
    String langType=null;
    if (article.isTemplateDriven()) {
      String defaultTemplateId=article.getTemplateId();
      if (Validator.isNull(templateId)) {
        templateId=defaultTemplateId;
      }
      JournalTemplate template=null;
      try {
        template=JournalTemplateUtil.findByG_T(groupId,templateId);
      }
 catch (      NoSuchTemplateException nste) {
        if (!defaultTemplateId.equals(templateId)) {
          template=JournalTemplateUtil.findByG_T(groupId,defaultTemplateId);
        }
 else {
          throw nste;
        }
      }
      script=template.getXsl();
      langType=template.getLangType();
    }
    content=JournalUtil.transform(tokens,languageId,xml,script,langType);
  }
 catch (  Exception e) {
    throw new SystemException(e);
  }
  return new JournalArticleDisplayImpl(article.getId(),article.getResourcePrimKey(),article.getGroupId(),article.getUserId(),article.getArticleId(),article.getVersion(),article.getTitle(),article.getDescription(),article.getAvailableLocales(),content,article.getType(),article.getStructureId(),templateId);
}
