{
  validateContent(content);
  JournalArticle oldArticle=getLatestArticle(groupId,articleId,WorkflowConstants.STATUS_ANY);
  double oldVersion=oldArticle.getVersion();
  if ((version > 0) && (version != oldVersion)) {
    throw new ArticleVersionException();
  }
  JournalArticle article=null;
  User user=userService.getUserById(oldArticle.getUserId());
  if (!oldArticle.isDraft()) {
    double newVersion=MathUtil.format(oldVersion + 0.1,1,1);
    long id=counterLocalService.increment();
    article=journalArticlePersistence.create(id);
    article.setResourcePrimKey(oldArticle.getResourcePrimKey());
    article.setGroupId(oldArticle.getGroupId());
    article.setCompanyId(oldArticle.getCompanyId());
    article.setUserId(oldArticle.getUserId());
    article.setUserName(user.getFullName());
    article.setCreateDate(new Date());
    article.setModifiedDate(new Date());
    article.setClassNameId(oldArticle.getClassNameId());
    article.setClassPK(oldArticle.getClassPK());
    article.setArticleId(articleId);
    article.setVersion(newVersion);
    article.setTitleMap(oldArticle.getTitleMap());
    article.setUrlTitle(getUniqueUrlTitle(article.getId(),groupId,articleId,title));
    article.setDescriptionMap(oldArticle.getDescriptionMap());
    article.setType(oldArticle.getType());
    article.setStructureId(oldArticle.getStructureId());
    article.setTemplateId(oldArticle.getTemplateId());
    article.setLayoutUuid(oldArticle.getLayoutUuid());
    article.setDisplayDate(oldArticle.getDisplayDate());
    article.setExpirationDate(oldArticle.getExpirationDate());
    article.setReviewDate(oldArticle.getReviewDate());
    article.setIndexable(oldArticle.getIndexable());
    article.setSmallImage(oldArticle.getSmallImage());
    article.setSmallImageId(oldArticle.getSmallImageId());
    if (article.getSmallImageId() == 0) {
      article.setSmallImageId(counterLocalService.increment());
    }
    article.setSmallImageURL(oldArticle.getSmallImageURL());
    article.setStatus(WorkflowConstants.STATUS_DRAFT);
    article.setStatusDate(new Date());
  }
 else {
    article=oldArticle;
  }
  Map<Locale,String> titleMap=article.getTitleMap();
  titleMap.put(locale,title);
  article.setTitleMap(titleMap);
  Map<Locale,String> descriptionMap=article.getDescriptionMap();
  descriptionMap.put(locale,description);
  article.setDescriptionMap(descriptionMap);
  content=format(user,groupId,articleId,version,!oldArticle.isDraft(),content,oldArticle.getStructureId(),images);
  article.setContent(content);
  journalArticlePersistence.update(article,false);
  return article;
}
