{
  validateContent(content);
  JournalArticle oldArticle=getLatestArticle(groupId,articleId,WorkflowConstants.STATUS_ANY);
  double oldVersion=oldArticle.getVersion();
  if ((version > 0) && (version != oldVersion)) {
    throw new ArticleVersionException();
  }
  boolean incrementVersion=false;
  if (oldArticle.isApproved() || oldArticle.isExpired()) {
    incrementVersion=true;
  }
  if (serviceContext != null) {
    serviceContext.validateModifiedDate(oldArticle,ArticleVersionException.class);
  }
  JournalArticle article=null;
  User user=userPersistence.fetchByC_U(oldArticle.getCompanyId(),oldArticle.getUserId());
  if (user == null) {
    user=userPersistence.fetchByC_DU(oldArticle.getCompanyId(),true);
  }
  Locale defaultLocale=getArticleDefaultLocale(content);
  if (incrementVersion) {
    double newVersion=MathUtil.format(oldVersion + 0.1,1,1);
    long id=counterLocalService.increment();
    article=journalArticlePersistence.create(id);
    article.setResourcePrimKey(oldArticle.getResourcePrimKey());
    article.setGroupId(oldArticle.getGroupId());
    article.setCompanyId(oldArticle.getCompanyId());
    article.setUserId(oldArticle.getUserId());
    article.setUserName(user.getFullName());
    article.setCreateDate(oldArticle.getCreateDate());
    article.setModifiedDate(new Date());
    article.setClassNameId(oldArticle.getClassNameId());
    article.setClassPK(oldArticle.getClassPK());
    article.setArticleId(articleId);
    article.setVersion(newVersion);
    article.setTitleMap(oldArticle.getTitleMap(),defaultLocale);
    article.setUrlTitle(getUniqueUrlTitle(id,groupId,articleId,title,oldArticle.getUrlTitle(),serviceContext));
    article.setDescriptionMap(oldArticle.getDescriptionMap());
    article.setDDMStructureKey(oldArticle.getDDMStructureKey());
    article.setDDMTemplateKey(oldArticle.getDDMTemplateKey());
    article.setLayoutUuid(oldArticle.getLayoutUuid());
    article.setDisplayDate(oldArticle.getDisplayDate());
    article.setExpirationDate(oldArticle.getExpirationDate());
    article.setReviewDate(oldArticle.getReviewDate());
    article.setIndexable(oldArticle.getIndexable());
    article.setSmallImage(oldArticle.getSmallImage());
    article.setSmallImageId(oldArticle.getSmallImageId());
    if (article.getSmallImageId() == 0) {
      article.setSmallImageId(counterLocalService.increment());
    }
    article.setSmallImageURL(oldArticle.getSmallImageURL());
    article.setStatus(WorkflowConstants.STATUS_DRAFT);
    article.setStatusDate(new Date());
    article.setExpandoBridgeAttributes(oldArticle);
    updateDDMLinks(groupId,id,oldArticle.getDDMStructureKey(),oldArticle.getDDMTemplateKey(),true);
  }
 else {
    article=oldArticle;
  }
  Map<Locale,String> titleMap=article.getTitleMap();
  titleMap.put(locale,title);
  article.setTitleMap(titleMap,defaultLocale);
  Map<Locale,String> descriptionMap=article.getDescriptionMap();
  descriptionMap.put(locale,description);
  article.setDescriptionMap(descriptionMap);
  content=format(user,groupId,articleId,article.getVersion(),!oldArticle.isDraft(),content,images);
  article.setContent(content);
  journalArticlePersistence.update(article);
  return article;
}
