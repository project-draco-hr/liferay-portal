{
  String layoutFullURL=serviceContext.getLayoutFullURL();
  if (!article.isApproved() || Validator.isNull(layoutFullURL)) {
    return;
  }
  String articleTitle=article.getTitle(serviceContext.getLanguageId());
  String articleURL=PortalUtil.getControlPanelFullURL(serviceContext.getScopeGroupId(),PortletKeys.JOURNAL,null);
  if (Validator.isNull(articleURL)) {
    return;
  }
  PortletPreferences preferences=ServiceContextUtil.getPortletPreferences(serviceContext);
  if (preferences == null) {
    long ownerId=article.getGroupId();
    int ownerType=PortletKeys.PREFS_OWNER_TYPE_GROUP;
    long plid=PortletKeys.PREFS_PLID_SHARED;
    String portletId=PortletKeys.JOURNAL;
    String defaultPreferences=null;
    preferences=portletPreferencesLocalService.getPreferences(article.getCompanyId(),ownerId,ownerType,plid,portletId,defaultPreferences);
  }
  if ((article.getVersion() == 1.0) && JournalUtil.getEmailArticleAddedEnabled(preferences)) {
  }
 else   if ((article.getVersion() != 1.0) && JournalUtil.getEmailArticleUpdatedEnabled(preferences)) {
  }
 else {
    return;
  }
  String fromName=JournalUtil.getEmailFromName(preferences,article.getCompanyId());
  String fromAddress=JournalUtil.getEmailFromAddress(preferences,article.getCompanyId());
  String subject=null;
  String body=null;
  if (article.getVersion() == 1.0) {
    subject=JournalUtil.getEmailArticleAddedSubject(preferences);
    body=JournalUtil.getEmailArticleAddedBody(preferences);
  }
 else {
    subject=JournalUtil.getEmailArticleUpdatedSubject(preferences);
    body=JournalUtil.getEmailArticleUpdatedBody(preferences);
  }
  SubscriptionSender subscriptionSender=new SubscriptionSender();
  subscriptionSender.setBody(body);
  subscriptionSender.setClassName(article.getModelClassName());
  subscriptionSender.setClassPK(article.getId());
  subscriptionSender.setCompanyId(article.getCompanyId());
  subscriptionSender.setContextAttributes("[$ARTICLE_ID$]",article.getArticleId(),"[$ARTICLE_TITLE$]",articleTitle,"[$ARTICLE_URL$]",articleURL,"[$ARTICLE_VERSION$]",article.getVersion());
  subscriptionSender.setContextUserPrefix("ARTICLE");
  subscriptionSender.setEntryTitle(articleTitle);
  subscriptionSender.setEntryURL(articleURL);
  subscriptionSender.setFrom(fromAddress,fromName);
  subscriptionSender.setHtmlFormat(true);
  subscriptionSender.setMailId("journal_article",article.getId());
  int notificationType=UserNotificationDefinition.NOTIFICATION_TYPE_ADD_ENTRY;
  if (serviceContext.isCommandUpdate()) {
    notificationType=UserNotificationDefinition.NOTIFICATION_TYPE_UPDATE_ENTRY;
  }
  subscriptionSender.setNotificationType(notificationType);
  subscriptionSender.setPortletId(PortletKeys.JOURNAL);
  subscriptionSender.setReplyToAddress(fromAddress);
  subscriptionSender.setScopeGroupId(article.getGroupId());
  subscriptionSender.setServiceContext(serviceContext);
  subscriptionSender.setSubject(subject);
  subscriptionSender.setUserId(article.getUserId());
  JournalFolder folder=article.getFolder();
  subscriptionSender.addPersistedSubscribers(JournalFolder.class.getName(),article.getGroupId());
  if (folder != null) {
    subscriptionSender.addPersistedSubscribers(JournalFolder.class.getName(),folder.getFolderId());
    for (    Long ancestorFolderId : folder.getAncestorFolderIds()) {
      subscriptionSender.addPersistedSubscribers(JournalFolder.class.getName(),ancestorFolderId);
    }
  }
  long structureClassPK=0;
  if (article.isTemplateDriven()) {
    DDMStructure structure=ddmStructureLocalService.getStructure(article.getGroupId(),classNameLocalService.getClassNameId(JournalArticle.class),article.getStructureId(),true);
    structureClassPK=structure.getStructureId();
  }
  subscriptionSender.addPersistedSubscribers(JournalUtil.getSubscriptionClassName(structureClassPK),JournalUtil.getSubscriptionClassPK(article.getGroupId(),structureClassPK));
  subscriptionSender.addPersistedSubscribers(JournalArticle.class.getName(),article.getResourcePrimKey());
  subscriptionSender.flushNotificationsAsync();
}
