{
  UploadPortletRequest uploadPortletRequest=PortalUtil.getUploadPortletRequest(actionRequest);
  ThemeDisplay themeDisplay=(ThemeDisplay)actionRequest.getAttribute(WebKeys.THEME_DISPLAY);
  long folderId=ParamUtil.getLong(uploadPortletRequest,"folderId");
  String sourceFileName=uploadPortletRequest.getFileName("file");
  StringBundler sb=new StringBundler(5);
  sb.append(FileUtil.stripExtension(sourceFileName));
  sb.append(DL.TEMP_RANDOM_SUFFIX);
  sb.append(StringUtil.randomString());
  String extension=FileUtil.getExtension(sourceFileName);
  if (Validator.isNotNull(extension)) {
    sb.append(StringPool.PERIOD);
    sb.append(extension);
  }
  InputStream inputStream=null;
  try {
    inputStream=uploadPortletRequest.getFileAsStream("file");
    String contentType=uploadPortletRequest.getContentType("file");
    FileEntry fileEntry=_dlAppService.addTempFileEntry(themeDisplay.getScopeGroupId(),folderId,TEMP_FOLDER_NAME,sb.toString(),inputStream,contentType);
    JSONObject jsonObject=JSONFactoryUtil.createJSONObject();
    jsonObject.put("groupId",fileEntry.getGroupId());
    jsonObject.put("name",fileEntry.getTitle());
    jsonObject.put("title",sourceFileName);
    jsonObject.put("uuid",fileEntry.getUuid());
    JSONPortletResponseUtil.writeJSON(actionRequest,actionResponse,jsonObject);
  }
 catch (  Exception e) {
    UploadException uploadException=(UploadException)actionRequest.getAttribute(WebKeys.UPLOAD_EXCEPTION);
    if ((uploadException != null) && (uploadException.getCause() instanceof FileUploadBase.IOFileUploadException)) {
    }
 else     if ((uploadException != null) && uploadException.isExceededSizeLimit()) {
      throw new FileSizeException(uploadException.getCause());
    }
 else {
      throw e;
    }
  }
 finally {
    StreamUtil.cleanUp(inputStream);
  }
}
