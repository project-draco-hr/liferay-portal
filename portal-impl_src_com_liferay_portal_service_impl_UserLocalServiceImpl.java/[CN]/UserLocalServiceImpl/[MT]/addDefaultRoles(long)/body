{
  User user=userPersistence.findByPrimaryKey(userId);
  Set<Long> roleIdSet=new HashSet<>();
  String[] defaultRoleNames=PrefsPropsUtil.getStringArray(user.getCompanyId(),PropsKeys.ADMIN_DEFAULT_ROLE_NAMES,StringPool.NEW_LINE,PropsValues.ADMIN_DEFAULT_ROLE_NAMES);
  for (  String defaultRoleName : defaultRoleNames) {
    try {
      Role role=rolePersistence.findByC_N(user.getCompanyId(),defaultRoleName);
      if (!userPersistence.containsRole(userId,role.getRoleId())) {
        roleIdSet.add(role.getRoleId());
      }
    }
 catch (    NoSuchRoleException nsre) {
    }
  }
  long[] roleIds=ArrayUtil.toLongArray(roleIdSet);
  roleIds=UsersAdminUtil.addRequiredRoles(user,roleIds);
  Set<Long> regularRoleIdSet=new HashSet<>();
  Set<Long> groupRoleIdSet=new HashSet<>();
  for (  long roleId : roleIds) {
    Role role=roleLocalService.getRole(roleId);
    if (role.getType() == RoleConstants.TYPE_REGULAR) {
      regularRoleIdSet.add(roleId);
    }
 else {
      groupRoleIdSet.add(roleId);
    }
  }
  long[] regularRoleIds=ArrayUtil.toLongArray(regularRoleIdSet);
  userPersistence.addRoles(userId,regularRoleIds);
  List<UserGroupRole> previousUserGroupRoles=userGroupRolePersistence.findByUserId(userId);
  Set<UserGroupRole> userGroupRoles=new LinkedHashSet<>();
  long[] groupIds=user.getGroupIds();
  for (  long groupRoleId : groupRoleIdSet) {
    for (    long groupId : groupIds) {
      UserGroupRolePK userGroupRolePK=new UserGroupRolePK(userId,groupId,groupRoleId);
      UserGroupRole userGroupRole=userGroupRolePersistence.create(userGroupRolePK);
      userGroupRoles.add(userGroupRole);
    }
  }
  List<UserGroupRole> userGroupRolesList=new ArrayList<>(userGroupRoles);
  updateUserGroupRoles(user,groupIds,null,userGroupRolesList,previousUserGroupRoles);
}
