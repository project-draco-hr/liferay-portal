{
  emailAddress1=emailAddress1.trim().toLowerCase();
  emailAddress2=emailAddress2.trim().toLowerCase();
  if (!emailAddress1.equals(emailAddress2)) {
    throw new UserEmailAddressException();
  }
  User user=userPersistence.findByPrimaryKey(userId);
  validateEmailAddress(user.getCompanyId(),emailAddress1);
  validateEmailAddress(user.getCompanyId(),emailAddress2);
  if (!user.getEmailAddress().equalsIgnoreCase(emailAddress1)) {
    if (userPersistence.fetchByC_EA(user.getCompanyId(),emailAddress1) != null) {
      throw new DuplicateUserEmailAddressException();
    }
  }
  setEmailAddress(user,password,user.getFirstName(),user.getMiddleName(),user.getLastName(),emailAddress1);
  user.setDisplayDummyEmailAddress(true);
  userPersistence.update(user,false);
  return user;
}
