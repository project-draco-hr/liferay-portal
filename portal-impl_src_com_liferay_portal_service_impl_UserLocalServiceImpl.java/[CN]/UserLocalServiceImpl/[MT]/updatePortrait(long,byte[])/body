{
  User user=userPersistence.findByPrimaryKey(userId);
  long imageMaxSize=PrefsPropsUtil.getLong(PropsKeys.USERS_IMAGE_MAX_SIZE);
  if ((imageMaxSize > 0) && ((bytes == null) || (bytes.length > imageMaxSize))) {
    throw new UserPortraitException();
  }
  long portraitId=user.getPortraitId();
  if (portraitId <= 0) {
    portraitId=counterLocalService.increment();
    user.setPortraitId(portraitId);
    userPersistence.update(user,false);
  }
  imageLocalService.updateImage(portraitId,bytes);
}
