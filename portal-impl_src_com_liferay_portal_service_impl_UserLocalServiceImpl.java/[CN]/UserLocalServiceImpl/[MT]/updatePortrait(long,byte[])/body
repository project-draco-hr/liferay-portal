{
  User user=userPersistence.findByPrimaryKey(userId);
  long imageMaxSize=PrefsPropsUtil.getLong(PropsKeys.USERS_IMAGE_MAX_SIZE);
  if ((imageMaxSize > 0) && ((bytes == null) || (bytes.length > imageMaxSize))) {
    throw new UserPortraitSizeException();
  }
  long portraitId=user.getPortraitId();
  if (portraitId <= 0) {
    portraitId=counterLocalService.increment();
    user.setPortraitId(portraitId);
  }
  try {
    ImageBag imageBag=ImageProcessorUtil.read(bytes);
    RenderedImage renderedImage=imageBag.getRenderedImage();
    if (renderedImage == null) {
      throw new UserPortraitTypeException();
    }
    renderedImage=ImageProcessorUtil.scale(renderedImage,PropsValues.USERS_IMAGE_MAX_HEIGHT,PropsValues.USERS_IMAGE_MAX_WIDTH);
    String contentType=imageBag.getType();
    imageLocalService.updateImage(portraitId,ImageProcessorUtil.getBytes(renderedImage,contentType));
  }
 catch (  IOException ioe) {
    throw new ImageSizeException(ioe);
  }
  userPersistence.update(user,false);
  return user;
}
