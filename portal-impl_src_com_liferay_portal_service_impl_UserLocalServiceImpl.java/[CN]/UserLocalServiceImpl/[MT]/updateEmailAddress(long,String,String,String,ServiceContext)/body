{
  emailAddress1=StringUtil.toLowerCase(emailAddress1.trim());
  emailAddress2=StringUtil.toLowerCase(emailAddress2.trim());
  User user=userPersistence.findByPrimaryKey(userId);
  validateEmailAddress(user,emailAddress1,emailAddress2);
  Company company=companyPersistence.findByPrimaryKey(user.getCompanyId());
  if (company.isStrangersVerify() && !StringUtil.equalsIgnoreCase(emailAddress1,user.getEmailAddress())) {
    sendEmailAddressVerification(user,emailAddress1,serviceContext);
  }
 else {
    setEmailAddress(user,password,user.getFirstName(),user.getMiddleName(),user.getLastName(),emailAddress1);
    userPersistence.update(user);
    Contact contact=user.getContact();
    contact.setEmailAddress(user.getEmailAddress());
    contactPersistence.update(contact);
  }
  return user;
}
