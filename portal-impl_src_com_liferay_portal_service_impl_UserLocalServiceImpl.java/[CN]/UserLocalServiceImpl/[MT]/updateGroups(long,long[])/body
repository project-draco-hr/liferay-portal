{
  List<Group> oldGroups=userPersistence.getGroups(userId);
  List<Long> oldGroupIds=new ArrayList<Long>(oldGroups.size());
  for (int i=0; i < oldGroups.size(); i++) {
    Group oldGroup=oldGroups.get(i);
    long oldGroupId=oldGroup.getGroupId();
    oldGroupIds.add(oldGroupId);
    if (!ArrayUtil.contains(newGroupIds,oldGroupId)) {
      unsetGroupUsers(oldGroupId,new long[]{userId});
    }
  }
  for (int i=0; i < newGroupIds.length; i++) {
    long newGroupId=newGroupIds[i];
    if (!oldGroupIds.contains(newGroupId)) {
      addGroupUsers(newGroupId,new long[]{userId});
    }
  }
  PermissionCacheUtil.clearCache();
}
