{
  if (newGroupIds == null) {
    return;
  }
  List<Group> oldGroups=userPersistence.getGroups(userId);
  List<Long> oldGroupIds=new ArrayList<Long>(oldGroups.size());
  for (  Group oldGroup : oldGroups) {
    long oldGroupId=oldGroup.getGroupId();
    oldGroupIds.add(oldGroupId);
    if (!ArrayUtil.contains(newGroupIds,oldGroupId)) {
      unsetGroupUsers(oldGroupId,new long[]{userId});
    }
  }
  for (  long newGroupId : newGroupIds) {
    if (!oldGroupIds.contains(newGroupId)) {
      addGroupUsers(newGroupId,new long[]{userId});
    }
  }
  try {
    UserIndexer.updateUsers(new long[]{userId});
  }
 catch (  SearchException se) {
    _log.error("Indexing " + userId,se);
  }
  PermissionCacheUtil.clearCache();
}
