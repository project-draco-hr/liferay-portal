{
  Ticket ticket=ticketLocalService.getTicket(ticketKey);
  if (ticket.isExpired() || (ticket.getType() != TicketConstants.TYPE_EMAIL_ADDRESS)) {
    throw new NoSuchTicketException();
  }
  User user=userPersistence.findByPrimaryKey(ticket.getClassPK());
  String emailAddress=ticket.getExtraInfo();
  emailAddress=emailAddress.toLowerCase().trim();
  if (!emailAddress.equals(user.getEmailAddress())) {
    if (userPersistence.fetchByC_EA(user.getCompanyId(),emailAddress) != null) {
      throw new DuplicateUserEmailAddressException();
    }
    setEmailAddress(user,StringPool.BLANK,user.getFirstName(),user.getMiddleName(),user.getLastName(),emailAddress);
    Contact contact=user.getContact();
    contact.setEmailAddress(user.getEmailAddress());
    contactPersistence.update(contact);
  }
  user.setEmailAddressVerified(true);
  userPersistence.update(user);
  ticketLocalService.deleteTicket(ticket);
}
