{
  Ticket ticket=ticketLocalService.getTicket(key);
  if (ticket.isExpired() && (ticket.getType() == UserConstants.TICKET_TYPE_EMAIL_ADDRESS)) {
    throw new NoSuchTicketException();
  }
  User user=userPersistence.findByPrimaryKey(ticket.getClassPK());
  String emailAddress=ticket.getExtraInfo().toLowerCase().trim();
  if (!user.getEmailAddress().equalsIgnoreCase(emailAddress)) {
    if (userPersistence.fetchByC_EA(user.getCompanyId(),emailAddress) != null) {
      throw new DuplicateUserEmailAddressException();
    }
    setEmailAddress(user,StringPool.BLANK,user.getFirstName(),user.getMiddleName(),user.getLastName(),emailAddress);
  }
  user.setEmailAddressVerified(true);
  userPersistence.update(user,false);
  ticketLocalService.deleteTicket(ticket);
}
