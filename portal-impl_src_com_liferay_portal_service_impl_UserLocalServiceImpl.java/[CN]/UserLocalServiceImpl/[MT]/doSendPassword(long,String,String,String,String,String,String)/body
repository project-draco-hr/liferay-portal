{
  if (!PrefsPropsUtil.getBoolean(companyId,PropsKeys.COMPANY_SECURITY_SEND_PASSWORD) || !PrefsPropsUtil.getBoolean(companyId,PropsKeys.ADMIN_EMAIL_PASSWORD_SENT_ENABLED)) {
    return;
  }
  emailAddress=emailAddress.trim().toLowerCase();
  if (!Validator.isEmailAddress(emailAddress)) {
    throw new UserEmailAddressException();
  }
  Company company=companyPersistence.findByPrimaryKey(companyId);
  User user=userPersistence.findByC_EA(companyId,emailAddress);
  PasswordPolicy passwordPolicy=user.getPasswordPolicy();
  String newPassword=null;
  if (!PwdEncryptor.PASSWORDS_ENCRYPTION_ALGORITHM.equals(PwdEncryptor.TYPE_NONE)) {
    newPassword=PwdToolkitUtil.generate();
    boolean passwordReset=false;
    if (passwordPolicy.getChangeable() && passwordPolicy.getChangeRequired()) {
      passwordReset=true;
    }
    user.setPassword(PwdEncryptor.encrypt(newPassword));
    user.setPasswordUnencrypted(newPassword);
    user.setPasswordEncrypted(true);
    user.setPasswordReset(passwordReset);
    userPersistence.update(user,false);
  }
 else {
    newPassword=user.getPassword();
  }
  String fromName=PrefsPropsUtil.getString(companyId,PropsKeys.ADMIN_EMAIL_FROM_NAME);
  String fromAddress=PrefsPropsUtil.getString(companyId,PropsKeys.ADMIN_EMAIL_FROM_ADDRESS);
  String toName=user.getFullName();
  String toAddress=user.getEmailAddress();
  if (Validator.isNull(subject)) {
    subject=PrefsPropsUtil.getContent(companyId,PropsKeys.ADMIN_EMAIL_PASSWORD_SENT_SUBJECT);
  }
  if (Validator.isNull(body)) {
    body=PrefsPropsUtil.getContent(companyId,PropsKeys.ADMIN_EMAIL_PASSWORD_SENT_BODY);
  }
  subject=StringUtil.replace(subject,new String[]{"[$FROM_ADDRESS$]","[$FROM_NAME$]","[$PORTAL_URL$]","[$REMOTE_ADDRESS$]","[$REMOTE_HOST$]","[$TO_ADDRESS$]","[$TO_NAME$]","[$USER_AGENT$]","[$USER_ID$]","[$USER_PASSWORD$]","[$USER_SCREENNAME$]"},new String[]{fromAddress,fromName,company.getVirtualHost(),remoteAddr,remoteHost,toAddress,toName,HtmlUtil.escape(userAgent),String.valueOf(user.getUserId()),newPassword,user.getScreenName()});
  body=StringUtil.replace(body,new String[]{"[$FROM_ADDRESS$]","[$FROM_NAME$]","[$PORTAL_URL$]","[$REMOTE_ADDRESS$]","[$REMOTE_HOST$]","[$TO_ADDRESS$]","[$TO_NAME$]","[$USER_AGENT$]","[$USER_ID$]","[$USER_PASSWORD$]","[$USER_SCREENNAME$]"},new String[]{fromAddress,fromName,company.getVirtualHost(),remoteAddr,remoteHost,toAddress,toName,HtmlUtil.escape(userAgent),String.valueOf(user.getUserId()),newPassword,user.getScreenName()});
  InternetAddress from=new InternetAddress(fromAddress,fromName);
  InternetAddress to=new InternetAddress(toAddress,toName);
  MailMessage message=new MailMessage(from,to,subject,body,true);
  mailService.sendEmail(message);
}
