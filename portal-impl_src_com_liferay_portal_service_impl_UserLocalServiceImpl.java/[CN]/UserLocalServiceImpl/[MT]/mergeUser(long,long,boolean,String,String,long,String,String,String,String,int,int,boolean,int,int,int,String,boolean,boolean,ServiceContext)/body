{
  User defaultUser=getDefaultUser(companyId);
  User user=getUserByEmailAddress(companyId,emailAddress);
  if (user.getStatus() != WorkflowConstants.STATUS_INCOMPLETE) {
    throw new PortalException("Incorrect user status");
  }
  if (updateInformation) {
    Date birthday=PortalUtil.getDate(birthdayMonth,birthdayDay,birthdayYear,new ContactBirthdayException());
    user.setScreenName(screenName);
    user.setFacebookId(facebookId);
    user.setOpenId(openId);
    user.setFirstName(firstName);
    user.setMiddleName(middleName);
    user.setLastName(lastName);
    user.setJobTitle(jobTitle);
    Contact contact=user.getContact();
    contact.setFirstName(firstName);
    contact.setMiddleName(middleName);
    contact.setLastName(lastName);
    contact.setPrefixId(prefixId);
    contact.setSuffixId(suffixId);
    contact.setMale(male);
    contact.setBirthday(birthday);
    contact.setJobTitle(jobTitle);
    contactPersistence.update(contact,false,serviceContext);
  }
  user.setStatus(WorkflowConstants.STATUS_DRAFT);
  userPersistence.update(user,false,serviceContext);
  serviceContext.setAttribute("autoPassword",autoPassword);
  serviceContext.setAttribute("sendEmail",sendEmail);
  long userId=user.getUserId();
  long workflowUserId=creatorUserId;
  if (workflowUserId == userId) {
    workflowUserId=defaultUser.getUserId();
  }
  WorkflowHandlerRegistryUtil.startWorkflowInstance(companyId,defaultUser.getUserId(),User.class.getName(),userId,user,serviceContext);
  return getUserByEmailAddress(companyId,emailAddress);
}
