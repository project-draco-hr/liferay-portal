{
  Company company=companyPersistence.findByPrimaryKey(companyId);
  if (!company.isSendPassword() && !company.isSendPasswordResetLink()) {
    throw new SendPasswordException.MustBeEnabled(company);
  }
  emailAddress=StringUtil.toLowerCase(emailAddress.trim());
  if (Validator.isNull(emailAddress)) {
    throw new UserEmailAddressException.MustNotBeNull();
  }
  User user=userPersistence.findByC_EA(companyId,emailAddress);
  PasswordPolicy passwordPolicy=user.getPasswordPolicy();
  String newPassword=StringPool.BLANK;
  String passwordResetURL=StringPool.BLANK;
  if (company.isSendPasswordResetLink()) {
    Date expirationDate=null;
    if ((passwordPolicy != null) && (passwordPolicy.getResetTicketMaxAge() > 0)) {
      expirationDate=new Date(System.currentTimeMillis() + (passwordPolicy.getResetTicketMaxAge() * 1000));
    }
    Ticket ticket=ticketLocalService.addTicket(companyId,User.class.getName(),user.getUserId(),TicketConstants.TYPE_PASSWORD,null,expirationDate,serviceContext);
    passwordResetURL=serviceContext.getPortalURL() + serviceContext.getPathMain() + "/portal/update_password?p_l_id="+ serviceContext.getPlid()+ "&ticketKey="+ ticket.getKey();
  }
 else {
    if (!PasswordEncryptorUtil.PASSWORDS_ENCRYPTION_ALGORITHM.equals(PasswordEncryptorUtil.TYPE_NONE)) {
      if (LDAPSettingsUtil.isPasswordPolicyEnabled(user.getCompanyId())) {
        if (_log.isWarnEnabled()) {
          StringBundler sb=new StringBundler(5);
          sb.append("When LDAP password policy is enabled, ");
          sb.append("it is possible that portal generated ");
          sb.append("passwords will not match the LDAP policy.");
          sb.append("Using RegExpToolkit to generate new ");
          sb.append("password.");
          _log.warn(sb.toString());
        }
        RegExpToolkit regExpToolkit=new RegExpToolkit();
        newPassword=regExpToolkit.generate(null);
      }
 else {
        newPassword=PwdToolkitUtil.generate(passwordPolicy);
      }
      boolean passwordReset=false;
      if (passwordPolicy.getChangeable() && passwordPolicy.getChangeRequired()) {
        passwordReset=true;
      }
      user.setPassword(PasswordEncryptorUtil.encrypt(newPassword));
      user.setPasswordUnencrypted(newPassword);
      user.setPasswordEncrypted(true);
      user.setPasswordReset(passwordReset);
      user.setPasswordModified(true);
      user.setPasswordModifiedDate(new Date());
      userPersistence.update(user);
      user.setPasswordModified(false);
    }
 else {
      newPassword=user.getPassword();
    }
  }
  if (Validator.isNull(fromName)) {
    fromName=PrefsPropsUtil.getString(companyId,PropsKeys.ADMIN_EMAIL_FROM_NAME);
  }
  if (Validator.isNull(fromAddress)) {
    fromAddress=PrefsPropsUtil.getString(companyId,PropsKeys.ADMIN_EMAIL_FROM_ADDRESS);
  }
  String toName=user.getFullName();
  String toAddress=user.getEmailAddress();
  PortletPreferences companyPortletPreferences=PrefsPropsUtil.getPreferences(company.getCompanyId(),true);
  Map<Locale,String> localizedSubjectMap=null;
  Map<Locale,String> localizedBodyMap=null;
  String prefix=null;
  String subjectProperty=null;
  String bodyProperty=null;
  if (company.isSendPasswordResetLink()) {
    prefix="adminEmailPasswordReset";
    subjectProperty=PropsKeys.ADMIN_EMAIL_PASSWORD_RESET_SUBJECT;
    bodyProperty=PropsKeys.ADMIN_EMAIL_PASSWORD_RESET_BODY;
  }
 else {
    prefix="adminEmailPasswordSent";
    subjectProperty=PropsKeys.ADMIN_EMAIL_PASSWORD_SENT_SUBJECT;
    bodyProperty=PropsKeys.ADMIN_EMAIL_PASSWORD_SENT_BODY;
  }
  if (Validator.isNull(subject)) {
    localizedSubjectMap=LocalizationUtil.getLocalizationMap(companyPortletPreferences,prefix + "Subject",subjectProperty);
  }
  if (Validator.isNull(body)) {
    localizedBodyMap=LocalizationUtil.getLocalizationMap(companyPortletPreferences,prefix + "Body",bodyProperty);
  }
  SubscriptionSender subscriptionSender=new SubscriptionSender();
  subscriptionSender.setCompanyId(companyId);
  subscriptionSender.setContextAttributes("[$PASSWORD_RESET_URL$]",passwordResetURL,"[$REMOTE_ADDRESS$]",serviceContext.getRemoteAddr(),"[$REMOTE_HOST$]",serviceContext.getRemoteHost(),"[$USER_ID$]",user.getUserId(),"[$USER_PASSWORD$]",newPassword,"[$USER_SCREENNAME$]",user.getScreenName());
  subscriptionSender.setFrom(fromAddress,fromName);
  subscriptionSender.setHtmlFormat(true);
  subscriptionSender.setLocalizedBodyMap(localizedBodyMap);
  subscriptionSender.setLocalizedSubjectMap(localizedSubjectMap);
  subscriptionSender.setMailId("user",user.getUserId(),System.currentTimeMillis(),PwdGenerator.getPassword());
  subscriptionSender.setServiceContext(serviceContext);
  subscriptionSender.setUserId(user.getUserId());
  subscriptionSender.addRuntimeSubscribers(toAddress,toName);
  subscriptionSender.flushNotificationsAsync();
  return company.isSendPassword();
}
