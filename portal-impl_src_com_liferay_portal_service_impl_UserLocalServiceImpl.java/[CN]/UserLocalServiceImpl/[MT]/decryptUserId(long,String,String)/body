{
  Company company=companyPersistence.findByPrimaryKey(companyId);
  try {
    name=Encryptor.decrypt(company.getKeyObj(),name);
  }
 catch (  EncryptorException ee) {
    throw new SystemException(ee);
  }
  long userId=GetterUtil.getLong(name);
  User user=userPersistence.findByPrimaryKey(userId);
  try {
    password=Encryptor.decrypt(company.getKeyObj(),password);
  }
 catch (  EncryptorException ee) {
    throw new SystemException(ee);
  }
  String userPassword=user.getPassword();
  String encPassword=PasswordEncryptorUtil.encrypt(password,userPassword);
  if (userPassword.equals(encPassword)) {
    if (isPasswordExpired(user)) {
      user.setPasswordReset(true);
      userPersistence.update(user);
    }
    return new KeyValuePair(name,password);
  }
 else {
    throw new PrincipalException.MustBeAuthenticated(userId);
  }
}
