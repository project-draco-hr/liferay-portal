{
  if (LDAPSettingsUtil.isPasswordPolicyEnabled(user.getCompanyId())) {
    return;
  }
  PasswordPolicy passwordPolicy=user.getPasswordPolicy();
  if (isPasswordExpired(user)) {
    int graceLoginCount=user.getGraceLoginCount();
    if (graceLoginCount < passwordPolicy.getGraceLimit()) {
      user.setGraceLoginCount(++graceLoginCount);
      userPersistence.update(user,false);
    }
 else {
      throw new PasswordExpiredException();
    }
  }
  if (isPasswordExpiringSoon(user)) {
    user.setPasswordReset(true);
    userPersistence.update(user,false);
  }
  if (passwordPolicy.isChangeable() && passwordPolicy.isChangeRequired()) {
    if (user.getLastLoginDate() == null) {
      boolean passwordReset=false;
      if (passwordPolicy.isChangeable() && passwordPolicy.isChangeRequired()) {
        passwordReset=true;
      }
      user.setPasswordReset(passwordReset);
      userPersistence.update(user,false);
    }
  }
}
