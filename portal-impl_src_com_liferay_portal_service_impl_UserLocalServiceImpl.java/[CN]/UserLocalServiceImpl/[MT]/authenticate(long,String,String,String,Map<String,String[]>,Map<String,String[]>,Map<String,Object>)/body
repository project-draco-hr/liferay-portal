{
  if (PropsValues.AUTH_LOGIN_DISABLED) {
    return Authenticator.FAILURE;
  }
  login=login.trim().toLowerCase();
  long userId=GetterUtil.getLong(login);
  if (authType.equals(CompanyConstants.AUTH_TYPE_EA)) {
    if (Validator.isNull(login)) {
      throw new UserEmailAddressException();
    }
  }
 else   if (authType.equals(CompanyConstants.AUTH_TYPE_SN)) {
    if (Validator.isNull(login)) {
      throw new UserScreenNameException();
    }
  }
 else   if (authType.equals(CompanyConstants.AUTH_TYPE_ID)) {
    if (Validator.isNull(login)) {
      throw new UserIdException();
    }
  }
  if (Validator.isNull(password)) {
    throw new UserPasswordException(UserPasswordException.PASSWORD_INVALID);
  }
  int authResult=Authenticator.FAILURE;
  if (authType.equals(CompanyConstants.AUTH_TYPE_EA)) {
    authResult=AuthPipeline.authenticateByEmailAddress(PropsKeys.AUTH_PIPELINE_PRE,companyId,login,password,headerMap,parameterMap);
  }
 else   if (authType.equals(CompanyConstants.AUTH_TYPE_SN)) {
    authResult=AuthPipeline.authenticateByScreenName(PropsKeys.AUTH_PIPELINE_PRE,companyId,login,password,headerMap,parameterMap);
  }
 else   if (authType.equals(CompanyConstants.AUTH_TYPE_ID)) {
    authResult=AuthPipeline.authenticateByUserId(PropsKeys.AUTH_PIPELINE_PRE,companyId,userId,password,headerMap,parameterMap);
  }
  User user=null;
  try {
    if (authType.equals(CompanyConstants.AUTH_TYPE_EA)) {
      user=userPersistence.findByC_EA(companyId,login);
    }
 else     if (authType.equals(CompanyConstants.AUTH_TYPE_SN)) {
      user=userPersistence.findByC_SN(companyId,login);
    }
 else     if (authType.equals(CompanyConstants.AUTH_TYPE_ID)) {
      user=userPersistence.findByC_U(companyId,GetterUtil.getLong(login));
    }
  }
 catch (  NoSuchUserException nsue) {
    return Authenticator.DNE;
  }
  if (user.isDefaultUser()) {
    if (_log.isInfoEnabled()) {
      _log.info("Authentication is disabled for the default user");
    }
    return Authenticator.DNE;
  }
 else   if (!user.isActive()) {
    if (_log.isInfoEnabled()) {
      _log.info("Authentication is disabled for inactive user " + user.getUserId());
    }
    return Authenticator.FAILURE;
  }
  if (!user.isPasswordEncrypted()) {
    user.setPassword(PwdEncryptor.encrypt(user.getPassword()));
    user.setPasswordEncrypted(true);
    userPersistence.update(user);
  }
  checkLockout(user);
  checkPasswordExpired(user);
  if ((authResult == Authenticator.SUCCESS) && PropsValues.AUTH_PIPELINE_ENABLE_LIFERAY_CHECK) {
    boolean authenticated=PwdAuthenticator.authenticate(login,password,user.getPassword());
    if (authenticated) {
      authResult=Authenticator.SUCCESS;
    }
 else {
      authResult=Authenticator.FAILURE;
    }
  }
  if (authResult == Authenticator.SUCCESS) {
    if (authType.equals(CompanyConstants.AUTH_TYPE_EA)) {
      authResult=AuthPipeline.authenticateByEmailAddress(PropsKeys.AUTH_PIPELINE_POST,companyId,login,password,headerMap,parameterMap);
    }
 else     if (authType.equals(CompanyConstants.AUTH_TYPE_SN)) {
      authResult=AuthPipeline.authenticateByScreenName(PropsKeys.AUTH_PIPELINE_POST,companyId,login,password,headerMap,parameterMap);
    }
 else     if (authType.equals(CompanyConstants.AUTH_TYPE_ID)) {
      authResult=AuthPipeline.authenticateByUserId(PropsKeys.AUTH_PIPELINE_POST,companyId,userId,password,headerMap,parameterMap);
    }
  }
  if (authResult == Authenticator.SUCCESS) {
    if (resultsMap != null) {
      resultsMap.put("userId",user.getUserId());
    }
    boolean updateDigest=true;
    if (PropsValues.AUTH_PIPELINE_ENABLE_LIFERAY_CHECK) {
      if (Validator.isNotNull(user.getDigest())) {
        updateDigest=false;
      }
    }
    if (updateDigest) {
      String digest=user.getDigest(password);
      user.setDigest(digest);
      userPersistence.update(user);
    }
  }
  if (authResult == Authenticator.FAILURE) {
    try {
      if (authType.equals(CompanyConstants.AUTH_TYPE_EA)) {
        AuthPipeline.onFailureByEmailAddress(PropsKeys.AUTH_FAILURE,companyId,login,headerMap,parameterMap);
      }
 else       if (authType.equals(CompanyConstants.AUTH_TYPE_SN)) {
        AuthPipeline.onFailureByScreenName(PropsKeys.AUTH_FAILURE,companyId,login,headerMap,parameterMap);
      }
 else       if (authType.equals(CompanyConstants.AUTH_TYPE_ID)) {
        AuthPipeline.onFailureByUserId(PropsKeys.AUTH_FAILURE,companyId,userId,headerMap,parameterMap);
      }
      try {
        user=userPersistence.findByPrimaryKey(user.getUserId());
      }
 catch (      NoSuchUserException nsue) {
        return Authenticator.DNE;
      }
      if (!LDAPSettingsUtil.isPasswordPolicyEnabled(user.getCompanyId())) {
        PasswordPolicy passwordPolicy=user.getPasswordPolicy();
        user=userPersistence.fetchByPrimaryKey(user.getUserId());
        int failedLoginAttempts=user.getFailedLoginAttempts();
        int maxFailures=passwordPolicy.getMaxFailure();
        if ((failedLoginAttempts >= maxFailures) && (maxFailures != 0)) {
          if (authType.equals(CompanyConstants.AUTH_TYPE_EA)) {
            AuthPipeline.onMaxFailuresByEmailAddress(PropsKeys.AUTH_MAX_FAILURES,companyId,login,headerMap,parameterMap);
          }
 else           if (authType.equals(CompanyConstants.AUTH_TYPE_SN)) {
            AuthPipeline.onMaxFailuresByScreenName(PropsKeys.AUTH_MAX_FAILURES,companyId,login,headerMap,parameterMap);
          }
 else           if (authType.equals(CompanyConstants.AUTH_TYPE_ID)) {
            AuthPipeline.onMaxFailuresByUserId(PropsKeys.AUTH_MAX_FAILURES,companyId,userId,headerMap,parameterMap);
          }
        }
      }
    }
 catch (    Exception e) {
      _log.error(e,e);
    }
  }
  return authResult;
}
