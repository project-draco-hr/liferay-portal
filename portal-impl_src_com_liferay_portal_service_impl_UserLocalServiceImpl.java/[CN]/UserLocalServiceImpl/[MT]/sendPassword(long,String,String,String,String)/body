{
  if (!PrefsPropsUtil.getBoolean(companyId,PropsUtil.COMPANY_SECURITY_SEND_PASSWORD) || !PrefsPropsUtil.getBoolean(companyId,PropsUtil.ADMIN_EMAIL_PASSWORD_SENT_ENABLED)) {
    return;
  }
  emailAddress=emailAddress.trim().toLowerCase();
  if (!Validator.isEmailAddress(emailAddress)) {
    throw new UserEmailAddressException();
  }
  Company company=companyPersistence.findByPrimaryKey(companyId);
  User user=userPersistence.findByC_EA(companyId,emailAddress);
  PasswordPolicy passwordPolicy=user.getPasswordPolicy();
  String newPassword=PwdToolkitUtil.generate();
  if (!PwdEncryptor.PASSWORDS_ENCRYPTION_ALGORITHM.equals(PwdEncryptor.TYPE_NONE)) {
    user.setPassword(PwdEncryptor.encrypt(newPassword));
    user.setPasswordUnencrypted(newPassword);
    user.setPasswordEncrypted(true);
    user.setPasswordReset(passwordPolicy.getChangeable() && passwordPolicy.getChangeRequired());
    userPersistence.update(user);
  }
  try {
    String fromName=PrefsPropsUtil.getString(companyId,PropsUtil.ADMIN_EMAIL_FROM_NAME);
    String fromAddress=PrefsPropsUtil.getString(companyId,PropsUtil.ADMIN_EMAIL_FROM_ADDRESS);
    String toName=user.getFullName();
    String toAddress=user.getEmailAddress();
    String subject=PrefsPropsUtil.getContent(companyId,PropsUtil.ADMIN_EMAIL_PASSWORD_SENT_SUBJECT);
    String body=PrefsPropsUtil.getContent(companyId,PropsUtil.ADMIN_EMAIL_PASSWORD_SENT_BODY);
    subject=StringUtil.replace(subject,new String[]{"[$FROM_ADDRESS$]","[$FROM_NAME$]","[$PORTAL_URL$]","[$REMOTE_ADDRESS$]","[$REMOTE_HOST$]","[$TO_ADDRESS$]","[$TO_NAME$]","[$USER_AGENT$]","[$USER_ID$]","[$USER_PASSWORD$]"},new String[]{fromAddress,fromName,company.getVirtualHost(),remoteAddr,remoteHost,toAddress,toName,userAgent,String.valueOf(user.getUserId()),newPassword});
    body=StringUtil.replace(body,new String[]{"[$FROM_ADDRESS$]","[$FROM_NAME$]","[$PORTAL_URL$]","[$REMOTE_ADDRESS$]","[$REMOTE_HOST$]","[$TO_ADDRESS$]","[$TO_NAME$]","[$USER_AGENT$]","[$USER_ID$]","[$USER_PASSWORD$]"},new String[]{fromAddress,fromName,company.getVirtualHost(),remoteAddr,remoteHost,toAddress,toName,userAgent,String.valueOf(user.getUserId()),newPassword});
    InternetAddress from=new InternetAddress(fromAddress,fromName);
    InternetAddress to=new InternetAddress(toAddress,toName);
    MailMessage message=new MailMessage(from,to,subject,body,true);
    mailService.sendEmail(message);
  }
 catch (  IOException ioe) {
    throw new SystemException(ioe);
  }
}
