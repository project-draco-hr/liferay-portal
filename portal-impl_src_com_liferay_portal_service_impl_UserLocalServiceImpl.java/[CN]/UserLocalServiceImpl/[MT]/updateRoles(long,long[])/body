{
  List<Role> oldRoles=userPersistence.getRoles(userId);
  List<Long> oldRoleIds=new ArrayList<Long>(oldRoles.size());
  for (int i=0; i < oldRoles.size(); i++) {
    Role oldRole=oldRoles.get(i);
    long oldRoleId=oldRole.getRoleId();
    oldRoleIds.add(oldRoleId);
    if (!ArrayUtil.contains(newRoleIds,oldRoleId)) {
      unsetRoleUsers(oldRoleId,new long[]{userId});
    }
  }
  for (int i=0; i < newRoleIds.length; i++) {
    long newRoleId=newRoleIds[i];
    if (!oldRoleIds.contains(newRoleId)) {
      addRoleUsers(newRoleId,new long[]{userId});
    }
  }
  PermissionCacheUtil.clearCache();
}
