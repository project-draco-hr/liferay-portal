{
  boolean autoPassword=GetterUtil.getBoolean(serviceContext.getAttribute("autoPassword"));
  String password=null;
  if (autoPassword) {
    PasswordPolicy passwordPolicy=passwordPolicyLocalService.getPasswordPolicy(user.getCompanyId(),user.getOrganizationIds());
    password=PwdToolkitUtil.generate(passwordPolicy);
    user.setPassword(PwdEncryptor.encrypt(password));
    user.setPasswordEncrypted(true);
    user.setPasswordUnencrypted(password);
    userPersistence.update(user,false);
  }
  if (user.hasCompanyMx()) {
    String mailPassword=password;
    if (Validator.isNull(mailPassword)) {
      mailPassword=user.getPasswordUnencrypted();
    }
    mailService.addUser(user.getCompanyId(),user.getUserId(),mailPassword,user.getFirstName(),user.getMiddleName(),user.getLastName(),user.getEmailAddress());
  }
  boolean sendEmail=GetterUtil.getBoolean(serviceContext.getAttribute("sendEmail"));
  if (sendEmail) {
    try {
      sendEmail(user,password);
    }
 catch (    IOException ioe) {
      throw new SystemException(ioe);
    }
  }
}
