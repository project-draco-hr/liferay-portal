{
  boolean isPasswordExpiringSoon=false;
  PasswordPolicy passwordPolicy=user.getPasswordPolicy();
  if (passwordPolicy.isExpireable()) {
    Date now=new Date();
    if (user.getPasswordModifiedDate() == null) {
      user.setPasswordModifiedDate(now);
      userLocalService.updateUser(user,false);
    }
    long timeModified=user.getPasswordModifiedDate().getTime();
    long passwordExpiresOn=(passwordPolicy.getMaxAge() * 1000) + timeModified;
    long timeStartWarning=passwordExpiresOn - (passwordPolicy.getWarningTime() * 1000);
    if (now.getTime() > timeStartWarning) {
      if (isPasswordExpired(user)) {
        if (!user.isPasswordReset()) {
          isPasswordExpiringSoon=true;
        }
      }
 else {
        isPasswordExpiringSoon=true;
      }
    }
  }
  return isPasswordExpiringSoon;
}
