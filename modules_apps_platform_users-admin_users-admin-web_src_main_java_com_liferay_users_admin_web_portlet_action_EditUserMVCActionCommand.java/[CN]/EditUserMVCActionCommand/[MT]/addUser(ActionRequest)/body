{
  ThemeDisplay themeDisplay=(ThemeDisplay)actionRequest.getAttribute(WebKeys.THEME_DISPLAY);
  boolean autoPassword=ParamUtil.getBoolean(actionRequest,"autoPassword",true);
  String password1=actionRequest.getParameter("password1");
  String password2=actionRequest.getParameter("password2");
  String reminderQueryQuestion=ParamUtil.getString(actionRequest,"reminderQueryQuestion");
  if (reminderQueryQuestion.equals(UsersAdmin.CUSTOM_QUESTION)) {
    reminderQueryQuestion=ParamUtil.getString(actionRequest,"reminderQueryCustomQuestion");
  }
  String reminderQueryAnswer=ParamUtil.getString(actionRequest,"reminderQueryAnswer");
  boolean autoScreenName=ParamUtil.getBoolean(actionRequest,"autoScreenName");
  String screenName=ParamUtil.getString(actionRequest,"screenName");
  String emailAddress=ParamUtil.getString(actionRequest,"emailAddress");
  long facebookId=0;
  String openId=ParamUtil.getString(actionRequest,"openId");
  String languageId=ParamUtil.getString(actionRequest,"languageId");
  String timeZoneId=ParamUtil.getString(actionRequest,"timeZoneId");
  String greeting=ParamUtil.getString(actionRequest,"greeting");
  String firstName=ParamUtil.getString(actionRequest,"firstName");
  String middleName=ParamUtil.getString(actionRequest,"middleName");
  String lastName=ParamUtil.getString(actionRequest,"lastName");
  long prefixId=ParamUtil.getInteger(actionRequest,"prefixId");
  long suffixId=ParamUtil.getInteger(actionRequest,"suffixId");
  boolean male=ParamUtil.getBoolean(actionRequest,"male",true);
  int birthdayMonth=ParamUtil.getInteger(actionRequest,"birthdayMonth");
  int birthdayDay=ParamUtil.getInteger(actionRequest,"birthdayDay");
  int birthdayYear=ParamUtil.getInteger(actionRequest,"birthdayYear");
  String comments=ParamUtil.getString(actionRequest,"comments");
  String smsSn=ParamUtil.getString(actionRequest,"smsSn");
  String facebookSn=ParamUtil.getString(actionRequest,"facebookSn");
  String jabberSn=ParamUtil.getString(actionRequest,"jabberSn");
  String skypeSn=ParamUtil.getString(actionRequest,"skypeSn");
  String twitterSn=ParamUtil.getString(actionRequest,"twitterSn");
  String jobTitle=ParamUtil.getString(actionRequest,"jobTitle");
  long[] groupIds=UsersAdminUtil.getGroupIds(actionRequest);
  long[] organizationIds=UsersAdminUtil.getOrganizationIds(actionRequest);
  long[] roleIds=UsersAdminUtil.getRoleIds(actionRequest);
  List<UserGroupRole> userGroupRoles=UsersAdminUtil.getUserGroupRoles(actionRequest);
  long[] userGroupIds=UsersAdminUtil.getUserGroupIds(actionRequest);
  List<Address> addresses=UsersAdminUtil.getAddresses(actionRequest);
  List<EmailAddress> emailAddresses=UsersAdminUtil.getEmailAddresses(actionRequest);
  List<Phone> phones=UsersAdminUtil.getPhones(actionRequest);
  List<Website> websites=UsersAdminUtil.getWebsites(actionRequest);
  List<AnnouncementsDelivery> announcementsDeliveries=getAnnouncementsDeliveries(actionRequest);
  boolean sendEmail=true;
  ServiceContext serviceContext=ServiceContextFactory.getInstance(User.class.getName(),actionRequest);
  User user=_userService.addUser(themeDisplay.getCompanyId(),autoPassword,password1,password2,autoScreenName,screenName,emailAddress,facebookId,openId,LocaleUtil.fromLanguageId(languageId),firstName,middleName,lastName,prefixId,suffixId,male,birthdayMonth,birthdayDay,birthdayYear,jobTitle,groupIds,organizationIds,roleIds,userGroupIds,addresses,emailAddresses,phones,websites,announcementsDeliveries,sendEmail,serviceContext);
  if (!userGroupRoles.isEmpty()) {
    for (    UserGroupRole userGroupRole : userGroupRoles) {
      userGroupRole.setUserId(user.getUserId());
    }
    user=_userService.updateUser(user.getUserId(),StringPool.BLANK,StringPool.BLANK,StringPool.BLANK,false,reminderQueryQuestion,reminderQueryAnswer,user.getScreenName(),user.getEmailAddress(),facebookId,openId,true,null,languageId,timeZoneId,greeting,comments,firstName,middleName,lastName,prefixId,suffixId,male,birthdayMonth,birthdayDay,birthdayYear,smsSn,facebookSn,jabberSn,skypeSn,twitterSn,jobTitle,groupIds,organizationIds,roleIds,userGroupRoles,userGroupIds,addresses,emailAddresses,phones,websites,announcementsDeliveries,serviceContext);
  }
  long publicLayoutSetPrototypeId=ParamUtil.getLong(actionRequest,"publicLayoutSetPrototypeId");
  long privateLayoutSetPrototypeId=ParamUtil.getLong(actionRequest,"privateLayoutSetPrototypeId");
  boolean publicLayoutSetPrototypeLinkEnabled=ParamUtil.getBoolean(actionRequest,"publicLayoutSetPrototypeLinkEnabled");
  boolean privateLayoutSetPrototypeLinkEnabled=ParamUtil.getBoolean(actionRequest,"privateLayoutSetPrototypeLinkEnabled");
  SitesUtil.updateLayoutSetPrototypesLinks(user.getGroup(),publicLayoutSetPrototypeId,privateLayoutSetPrototypeId,publicLayoutSetPrototypeLinkEnabled,privateLayoutSetPrototypeLinkEnabled);
  return user;
}
