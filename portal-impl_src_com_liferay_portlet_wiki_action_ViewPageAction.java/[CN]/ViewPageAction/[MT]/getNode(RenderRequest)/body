{
  ActionUtil.getNode(req);
  WikiNode node=(WikiNode)req.getAttribute(WebKeys.WIKI_NODE);
  if (node != null) {
    return;
  }
  ThemeDisplay themeDisplay=(ThemeDisplay)req.getAttribute(WebKeys.THEME_DISPLAY);
  List nodes=WikiNodeLocalServiceUtil.getNodes(themeDisplay.getLayout().getGroupId());
  if (nodes.size() == 0) {
    String nodeName=PropsUtil.get(PropsUtil.WIKI_INITIAL_NODE_NAME);
    node=WikiNodeLocalServiceUtil.addNode(themeDisplay.getUserId(),themeDisplay.getPlid(),nodeName,StringPool.BLANK,true,true);
  }
 else {
    PermissionChecker permissionChecker=themeDisplay.getPermissionChecker();
    for (int i=0; i < nodes.size(); i++) {
      WikiNode curNode=(WikiNode)nodes.get(i);
      if (WikiNodePermission.contains(permissionChecker,curNode.getNodeId(),ActionKeys.VIEW)) {
        node=curNode;
        break;
      }
    }
    if (node == null) {
      throw new PrincipalException();
    }
  }
  req.setAttribute(WebKeys.WIKI_NODE,node);
}
