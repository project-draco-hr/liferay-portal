{
  WikiNode node=(WikiNode)req.getAttribute(WebKeys.WIKI_NODE);
  ThemeDisplay themeDisplay=(ThemeDisplay)req.getAttribute(WebKeys.THEME_DISPLAY);
  if (node == null) {
    List nodes=WikiNodeLocalServiceUtil.getNodes(themeDisplay.getLayout().getGroupId());
    if (nodes.size() == 0) {
      String nodeName=PropsUtil.get(PropsUtil.WIKI_INITIAL_NODE_NAME);
      node=WikiNodeLocalServiceUtil.addNode(themeDisplay.getUserId(),themeDisplay.getPlid(),nodeName,StringPool.BLANK,true,true);
    }
 else {
      PermissionChecker permissionChecker=themeDisplay.getPermissionChecker();
      for (int i=0; i < nodes.size(); i++) {
        WikiNode node2=(WikiNode)nodes.get(i);
        if (WikiNodePermission.contains(permissionChecker,node2.getNodeId(),ActionKeys.VIEW)) {
          node=node2;
          break;
        }
      }
      if (node == null) {
        throw new PrincipalException();
      }
    }
    req.setAttribute(WebKeys.WIKI_NODE,node);
  }
}
