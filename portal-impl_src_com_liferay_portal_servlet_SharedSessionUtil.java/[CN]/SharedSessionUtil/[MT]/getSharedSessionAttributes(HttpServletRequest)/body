{
  HttpSession session=request.getSession();
  if (ServletSpecificationDetector.is2_5Plus()) {
    Enumeration<String> enumeration=session.getAttributeNames();
    Map<String,Object> map=new HashMap<String,Object>();
    while (enumeration.hasMoreElements()) {
      String attrName=enumeration.nextElement();
      Object attrValue=session.getAttribute(attrName);
      if (attrValue != null) {
        for (        String sharedName : PropsValues.SHARED_SESSION_ATTRIBUTES) {
          if (attrName.startsWith(sharedName)) {
            map.put(attrName,attrValue);
            if (_log.isDebugEnabled()) {
              _log.debug("Sharing " + attrName);
            }
            break;
          }
        }
      }
    }
    return map;
  }
 else {
    SharedSessionAttributeCache cache=SharedSessionAttributeCache.getInstance(session);
    Map<String,Object> values=cache.getValues();
    if (_log.isDebugEnabled()) {
      _log.debug("Shared session attributes " + values);
    }
    return values;
  }
}
