{
  HttpSession session=request.getSession();
  if (ServletVersionDetector.is2_5()) {
    Map<String,Object> attributes=new HashMap<String,Object>();
    Enumeration<String> enu=session.getAttributeNames();
    while (enu.hasMoreElements()) {
      String name=enu.nextElement();
      Object value=session.getAttribute(name);
      if (value == null) {
        continue;
      }
      for (      String sharedName : PropsValues.SHARED_SESSION_ATTRIBUTES) {
        if (!name.startsWith(sharedName)) {
          continue;
        }
        boolean bypassSharing=false;
        for (        String shareException : PropsValues.SHARED_SESSION_ATTRIBUTES_EXCLUSIONS) {
          if (shareException.equals(name)) {
            bypassSharing=true;
            break;
          }
        }
        if (bypassSharing) {
          continue;
        }
        if (_log.isDebugEnabled()) {
          _log.debug("Sharing " + name);
        }
        attributes.put(name,value);
        break;
      }
    }
    return attributes;
  }
 else {
    SharedSessionAttributeCache sharedSessionAttributeCache=SharedSessionAttributeCache.getInstance(session);
    Map<String,Object> values=sharedSessionAttributeCache.getValues();
    if (_log.isDebugEnabled()) {
      _log.debug("Shared session attributes " + values);
    }
    return values;
  }
}
