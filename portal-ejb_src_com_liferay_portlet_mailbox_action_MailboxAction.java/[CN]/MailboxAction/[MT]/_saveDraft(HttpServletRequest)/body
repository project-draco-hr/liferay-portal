{
  User user=PortalUtil.getUser(req);
  Address from=new InternetAddress(user.getEmailAddress(),user.getFullName());
  String tos=ParamUtil.getString(req,"tos");
  String ccs=ParamUtil.getString(req,"ccs");
  String bccs=ParamUtil.getString(req,"bccs");
  String subject=ParamUtil.getString(req,"subject");
  String body=ParamUtil.getString(req,"body");
  long messageId=ParamUtil.getLong(req,"messageId",-1L);
  Map attachments=ActionUtil.getAttachments(PortalUtil.getUploadPortletRequest((ActionRequestImpl)req));
  HttpSession ses=((ActionRequestImpl)req).getHttpServletRequest().getSession();
  long newMessageId=ActionUtil.completeMessage(from,tos,ccs,bccs,subject,body,attachments,ses,false,messageId);
  JSONObject jsonObj=new JSONObject();
  jsonObj.put("id",newMessageId);
  return jsonObj.toString();
}
