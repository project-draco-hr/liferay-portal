{
  JSONObject jsonObj=new JSONObject();
  String folderId=ParamUtil.getString(req,"folderId");
  String sortBy=ParamUtil.getString(req,"sortBy");
  boolean asc=ParamUtil.getBoolean(req,"asc");
  SortedSet set;
  MailUtil.setCurrentFolder(req.getSession(),folderId);
  if ("name".equals(sortBy)) {
    set=MailUtil.getEnvelopes(req.getSession(),new RecipientComparator(asc));
  }
 else   if ("subject".equals(sortBy)) {
    set=MailUtil.getEnvelopes(req.getSession(),new SubjectComparator(asc));
  }
 else {
    set=MailUtil.getEnvelopes(req.getSession(),new DateComparator(asc));
  }
  User user=PortalUtil.getUser(req);
  Locale locale=user.getLocale();
  TimeZone tz=user.getTimeZone();
  DateFormat dtf=DateFormats.getDateTime(locale,tz);
  DateFormat tf=DateFormats.getTime(locale,tz);
  DateFormat df=DateFormats.getDate(locale,tz);
  Date today=new Date();
  Calendar cal=Calendar.getInstance(tz,locale);
  cal.setTime(today);
  cal.add(Calendar.DATE,-1);
  Date yesterday=cal.getTime();
  String td=df.format(today);
  String yd=df.format(yesterday);
  JSONArray meArray=new JSONArray();
  for (Iterator itr=set.iterator(); itr.hasNext(); ) {
    MailEnvelope me=(MailEnvelope)itr.next();
    JSONObject jMe=new JSONObject();
    String formattedDate=null;
    String day=df.format(me.getDate());
    if (td.equals(day)) {
      formattedDate=LanguageUtil.get(user,"today") + StringPool.COMMA + StringPool.SPACE+ tf.format(me.getDate());
    }
 else     if (yd.equals(day)) {
      formattedDate=LanguageUtil.get(user,"yesterday") + StringPool.COMMA + StringPool.SPACE+ tf.format(me.getDate());
    }
 else {
      formattedDate=dtf.format(me.getDate());
    }
    jMe.put("date",formattedDate);
    jMe.put("id",me.getMsgUID());
    jMe.put("email",me.getRecipient());
    jMe.put("subject",me.getSubject());
    jMe.put("recent",me.isRecent());
    meArray.put(jMe);
  }
  jsonObj.put("headers",meArray);
  return jsonObj.toString();
}
