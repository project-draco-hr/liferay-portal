{
  WikiEngine engine=_engines.get(format);
  if (engine != null) {
    return engine;
  }
synchronized (_engines) {
    engine=_engines.get(format);
    if (engine != null) {
      return engine;
    }
    try {
      String engineClassName=PropsUtil.get(WikiPropsKeys.FORMATS_ENGINE,new Filter(format));
      if (engineClassName == null) {
        throw new WikiFormatException(format);
      }
      Class<?> clazz=getClass();
      engine=(WikiEngine)InstanceFactory.newInstance(clazz.getClassLoader(),engineClassName);
      engine.setInterWikiConfiguration(_readConfigurationFile(WikiPropsKeys.FORMATS_CONFIGURATION_INTERWIKI,format));
      engine.setMainConfiguration(_readConfigurationFile(WikiPropsKeys.FORMATS_CONFIGURATION_MAIN,format));
      _engines.put(format,engine);
      return engine;
    }
 catch (    Exception e) {
      throw new WikiFormatException(e);
    }
  }
}
