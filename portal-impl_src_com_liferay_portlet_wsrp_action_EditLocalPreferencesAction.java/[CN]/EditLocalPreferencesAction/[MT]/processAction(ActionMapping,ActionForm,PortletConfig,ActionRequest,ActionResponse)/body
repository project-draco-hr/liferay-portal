{
  PortletPreferences prefs=req.getPreferences();
  String wsrpServiceUrl=ParamUtil.getString(req,"wsrp_service_url");
  String markupEndpoint=ParamUtil.getString(req,"markup_endpoint");
  String serviceDescriptionEndpoint=ParamUtil.getString(req,"service_description_endpoint");
  String registrationEndpoint=ParamUtil.getString(req,"registration_endpoint");
  String portletManagementEndpoint=ParamUtil.getString(req,"portlet_management_endpoint");
  String portletHandle=ParamUtil.getString(req,"portlet_handle");
  prefs.setValue("wsrp-service-url",wsrpServiceUrl);
  prefs.setValue("markup-endpoint",markupEndpoint);
  prefs.setValue("service-description-endpoint",serviceDescriptionEndpoint);
  prefs.setValue("registration-endpoint",registrationEndpoint);
  prefs.setValue("portlet-management-endpoint",portletManagementEndpoint);
  String oldPortletHandle=prefs.getValue("portlet-handle","");
  if (!portletHandle.equals(oldPortletHandle)) {
    prefs.reset("parent-handle");
  }
  prefs.setValue("portlet-handle",portletHandle);
  PortletSession ses=req.getPortletSession();
  ses.setAttribute(WebKeys.WSRP_NEW_SESSION,"true");
  ses.setAttribute(WebKeys.WSRP_REGISTER_PRODUCER,"true");
  prefs.store();
  SessionMessages.add(req,config.getPortletName() + ".doEdit");
  setForward(req,"portlet.wsrp.edit");
}
