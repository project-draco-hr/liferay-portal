{
  String protocol=url.getProtocol();
  if (protocol.equals("reference")) {
    String file=url.getFile();
    url=new URL(file);
    protocol=url.getProtocol();
  }
  if (protocol.equals("file")) {
    return url.toURI();
  }
 else   if (protocol.equals("jar")) {
    String file=url.getFile();
    return new URI(StringUtil.extractFirst(file,"!/"));
  }
  throw new URISyntaxException(url.toString(),"Unknown protocol " + protocol);
}
