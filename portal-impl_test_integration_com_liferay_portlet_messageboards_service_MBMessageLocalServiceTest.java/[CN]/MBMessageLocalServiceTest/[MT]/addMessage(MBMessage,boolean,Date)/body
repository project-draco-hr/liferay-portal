{
  ServiceContext serviceContext=ServiceContextTestUtil.getServiceContext(_group.getGroupId(),TestPropsValues.getUserId());
  serviceContext.setCreateDate(date);
  serviceContext.setModifiedDate(date);
  ServiceContextThreadLocal.pushServiceContext(serviceContext);
  long categoryId=MBCategoryConstants.DEFAULT_PARENT_CATEGORY_ID;
  long parentMessageId=MBMessageConstants.DEFAULT_PARENT_MESSAGE_ID;
  long threadId=0;
  if (parentMessage != null) {
    categoryId=parentMessage.getCategoryId();
    parentMessageId=parentMessage.getMessageId();
    threadId=parentMessage.getThreadId();
  }
  List<ObjectValuePair<String,InputStream>> inputStreamOVPs=Collections.emptyList();
  if (addAttachments) {
    inputStreamOVPs=MBTestUtil.getInputStreamOVPs("attachment.txt",getClass(),StringPool.BLANK);
  }
  return MBMessageLocalServiceUtil.addMessage(TestPropsValues.getUserId(),RandomTestUtil.randomString(),_group.getGroupId(),categoryId,threadId,parentMessageId,RandomTestUtil.randomString(),RandomTestUtil.randomString(),MBMessageConstants.DEFAULT_FORMAT,inputStreamOVPs,false,0.0,false,serviceContext);
}
