{
  PortletPreferencesIds portletPreferencesIds=PortletPreferencesFactoryUtil.getPortletPreferencesIds(themeDisplay.getCompanyId(),themeDisplay.getSiteGroupId(),themeDisplay.getPlid(),portlet.getPortletId(),settingsScope);
  if (PortletPreferencesLocalServiceUtil.getPortletPreferencesCount(portletPreferencesIds.getOwnerId(),portletPreferencesIds.getOwnerType(),portletPreferencesIds.getPlid(),portlet,true) > 0) {
    return PortletPreferencesLocalServiceUtil.getPreferences(themeDisplay.getCompanyId(),portletPreferencesIds.getOwnerId(),portletPreferencesIds.getOwnerType(),portletPreferencesIds.getPlid(),portlet.getPortletId());
  }
  if (Validator.isNotNull(defaultPreferences)) {
    return PortletPreferencesFactoryUtil.fromDefaultXML(defaultPreferences);
  }
  return null;
}
