{
  if (pageContext != null) {
    response=new PipingServletResponse(response,pageContext.getOut());
  }
  String portletId=portletName;
  try {
    request.setAttribute(WebKeys.RENDER_PORTLET_RESOURCE,Boolean.TRUE);
    if (Validator.isNotNull(defaultPreferences)) {
      PortletPreferencesFactoryUtil.getPortletSetup(request,portletId,defaultPreferences);
    }
    request=DynamicServletRequest.addQueryString(request,queryString);
    ThemeDisplay themeDisplay=(ThemeDisplay)request.getAttribute(WebKeys.THEME_DISPLAY);
    Portlet portlet=PortletLocalServiceUtil.getPortletById(themeDisplay.getCompanyId(),portletId);
    PortletContainerUtil.render(request,response,portlet);
    Set<String> runtimePortletIds=(Set<String>)request.getAttribute(WebKeys.RUNTIME_PORTLET_IDS);
    if (runtimePortletIds == null) {
      runtimePortletIds=new HashSet<String>();
    }
    runtimePortletIds.add(portletName);
    request.setAttribute(WebKeys.RUNTIME_PORTLET_IDS,runtimePortletIds);
  }
  finally {
    request.removeAttribute(WebKeys.RENDER_PORTLET_RESOURCE);
  }
}
