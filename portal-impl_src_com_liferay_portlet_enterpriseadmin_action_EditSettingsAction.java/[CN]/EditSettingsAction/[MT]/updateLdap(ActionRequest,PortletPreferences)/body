{
  boolean enabled=ParamUtil.getBoolean(req,"enabled");
  boolean required=ParamUtil.getBoolean(req,"required");
  String baseProviderURL=ParamUtil.getString(req,"baseProviderURL");
  String baseDN=ParamUtil.getString(req,"baseDN");
  String principal=ParamUtil.getString(req,"principal");
  String credentials=ParamUtil.getString(req,"credentials");
  String searchFilter=ParamUtil.getString(req,"searchFilter");
  String passwordEncryptionAlgorithm=ParamUtil.getString(req,"passwordEncryptionAlgorithm");
  String userMappings=ParamUtil.getString(req,"userMappings");
  boolean importEnabled=ParamUtil.getBoolean(req,"importEnabled");
  boolean importOnStartup=ParamUtil.getBoolean(req,"importOnStartup");
  long importInterval=ParamUtil.getLong(req,"importInterval");
  String importUserSearchFilter=ParamUtil.getString(req,"importUserSearchFilter");
  String importGroupSearchFilter=ParamUtil.getString(req,"importGroupSearchFilter");
  boolean exportEnabled=ParamUtil.getBoolean(req,"exportEnabled");
  String usersDn=ParamUtil.getString(req,"usersDn");
  String userDefaultObjectClasses=ParamUtil.getString(req,"userDefaultObjectClasses");
  boolean passwordPolicyEnabled=ParamUtil.getBoolean(req,"passwordPolicyEnabled");
  try {
    if (enabled) {
      Properties env=new Properties();
      env.put(Context.INITIAL_CONTEXT_FACTORY,PrefsPropsUtil.getString(PropsUtil.LDAP_FACTORY_INITIAL));
      env.put(Context.PROVIDER_URL,LDAPUtil.getFullProviderURL(baseProviderURL,baseDN));
      env.put(Context.SECURITY_PRINCIPAL,principal);
      env.put(Context.SECURITY_CREDENTIALS,credentials);
      if (_log.isDebugEnabled()) {
        StringWriter sw=new StringWriter();
        env.list(new PrintWriter(sw));
        _log.debug(sw.getBuffer().toString());
      }
      new InitialLdapContext(env,null);
    }
  }
 catch (  Exception e) {
    SessionErrors.add(req,"ldapAuthentication");
    return;
  }
  prefs.setValue(PropsUtil.LDAP_AUTH_ENABLED,String.valueOf(enabled));
  prefs.setValue(PropsUtil.LDAP_AUTH_REQUIRED,String.valueOf(required));
  prefs.setValue(PropsUtil.LDAP_BASE_PROVIDER_URL,baseProviderURL);
  prefs.setValue(PropsUtil.LDAP_BASE_DN,baseDN);
  prefs.setValue(PropsUtil.LDAP_SECURITY_PRINCIPAL,principal);
  prefs.setValue(PropsUtil.LDAP_SECURITY_CREDENTIALS,credentials);
  prefs.setValue(PropsUtil.LDAP_AUTH_SEARCH_FILTER,searchFilter);
  prefs.setValue(PropsUtil.LDAP_AUTH_PASSWORD_ENCRYPTION_ALGORITHM,passwordEncryptionAlgorithm);
  prefs.setValue(PropsUtil.LDAP_USER_MAPPINGS,userMappings);
  prefs.setValue(PropsUtil.LDAP_IMPORT_ENABLED,String.valueOf(importEnabled));
  prefs.setValue(PropsUtil.LDAP_IMPORT_ON_STARTUP,String.valueOf(importOnStartup));
  prefs.setValue(PropsUtil.LDAP_IMPORT_INTERVAL,String.valueOf(importInterval));
  prefs.setValue(PropsUtil.LDAP_IMPORT_USER_SEARCH_FILTER,importUserSearchFilter);
  prefs.setValue(PropsUtil.LDAP_IMPORT_GROUP_SEARCH_FILTER,importGroupSearchFilter);
  prefs.setValue(PropsUtil.LDAP_EXPORT_ENABLED,String.valueOf(exportEnabled));
  prefs.setValue(PropsUtil.LDAP_USERS_DN,usersDn);
  prefs.setValue(PropsUtil.LDAP_USER_DEFAULT_OBJECT_CLASSES,userDefaultObjectClasses);
  prefs.setValue(PropsUtil.LDAP_PASSWORD_POLICY_ENABLED,String.valueOf(passwordPolicyEnabled));
  prefs.store();
}
