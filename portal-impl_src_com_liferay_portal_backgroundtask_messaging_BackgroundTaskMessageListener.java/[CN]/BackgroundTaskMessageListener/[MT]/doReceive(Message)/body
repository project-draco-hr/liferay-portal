{
  long backgroundTaskId=(Long)message.get("backgroundTaskId");
  BackgroundTaskThreadLocal.setBackgroundTaskId(backgroundTaskId);
  ServiceContext serviceContext=new ServiceContext();
  BackgroundTask backgroundTask=BackgroundTaskLocalServiceUtil.amendBackgroundTask(backgroundTaskId,null,BackgroundTaskConstants.STATUS_IN_PROGRESS,serviceContext);
  if (backgroundTask == null) {
    return;
  }
  BackgroundTaskExecutor backgroundTaskExecutor=null;
  BackgroundTaskStatusMessageListener backgroundTaskStatusMessageListener=null;
  int status=backgroundTask.getStatus();
  String statusMessage=null;
  try {
    ClassLoader classLoader=ClassLoaderUtil.getPortalClassLoader();
    String servletContextNames=backgroundTask.getServletContextNames();
    if (Validator.isNotNull(servletContextNames)) {
      classLoader=ClassLoaderUtil.getAggregatePluginsClassLoader(StringUtil.split(servletContextNames),false);
    }
    backgroundTaskExecutor=(BackgroundTaskExecutor)InstanceFactory.newInstance(classLoader,backgroundTask.getTaskExecutorClassName());
    backgroundTaskExecutor=wrapBackgroundTaskExecutor(backgroundTaskExecutor,classLoader);
    BackgroundTaskStatusRegistryUtil.registerBackgroundTaskStatus(backgroundTaskId);
    BackgroundTaskStatusMessageTranslator backgroundTaskStatusMessageTranslator=backgroundTaskExecutor.getBackgroundTaskStatusMessageTranslator();
    if (backgroundTaskStatusMessageTranslator != null) {
      backgroundTaskStatusMessageListener=new BackgroundTaskStatusMessageListener(backgroundTaskId,backgroundTaskStatusMessageTranslator);
      MessageBusUtil.registerMessageListener(DestinationNames.BACKGROUND_TASK_STATUS,backgroundTaskStatusMessageListener);
    }
    BackgroundTaskResult backgroundTaskResult=backgroundTaskExecutor.execute(backgroundTask);
    status=backgroundTaskResult.getStatus();
    statusMessage=backgroundTaskResult.getStatusMessage();
  }
 catch (  DuplicateLockException e) {
    status=BackgroundTaskConstants.STATUS_QUEUED;
  }
catch (  Exception e) {
    status=BackgroundTaskConstants.STATUS_FAILED;
    if (backgroundTaskExecutor != null) {
      statusMessage=backgroundTaskExecutor.handleException(backgroundTask,e);
    }
    if (_log.isInfoEnabled()) {
      if (statusMessage != null) {
        statusMessage.concat(StackTraceUtil.getStackTrace(e));
      }
 else {
        statusMessage=StackTraceUtil.getStackTrace(e);
      }
    }
    _log.error("Unable to execute background task",e);
  }
 finally {
    BackgroundTaskLocalServiceUtil.amendBackgroundTask(backgroundTaskId,null,status,statusMessage,serviceContext);
    BackgroundTaskStatusRegistryUtil.unregisterBackgroundTaskStatus(backgroundTaskId);
    if (backgroundTaskStatusMessageListener != null) {
      MessageBusUtil.unregisterMessageListener(DestinationNames.BACKGROUND_TASK_STATUS,backgroundTaskStatusMessageListener);
    }
    Message responseMessage=new Message();
    responseMessage.put("backgroundTaskId",backgroundTask.getBackgroundTaskId());
    responseMessage.put("name",backgroundTask.getName());
    responseMessage.put("status",status);
    responseMessage.put("taskExecutorClassName",backgroundTask.getTaskExecutorClassName());
    MessageBusUtil.sendMessage(DestinationNames.BACKGROUND_TASK_STATUS,responseMessage);
  }
}
