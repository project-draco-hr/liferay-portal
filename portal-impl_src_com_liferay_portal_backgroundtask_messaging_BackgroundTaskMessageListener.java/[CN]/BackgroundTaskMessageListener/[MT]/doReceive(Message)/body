{
  long backgroundTaskId=(Long)message.get("backgroundTaskId");
  ServiceContext serviceContext=new ServiceContext();
  BackgroundTaskLocalServiceUtil.updateBackgroundTask(backgroundTaskId,null,BackgroundTaskConstants.STATUS_IN_PROGRESS,serviceContext);
  BackgroundTask backgroundTask=BackgroundTaskLocalServiceUtil.getBackgroundTask(backgroundTaskId);
  BackgroundTaskExecutor backgroundTaskExecutor=null;
  int status=backgroundTask.getStatus();
  String statusMessage=null;
  try {
    ClassLoader classLoader=ClassLoaderUtil.getPortalClassLoader();
    String servletContextNames=backgroundTask.getServletContextNames();
    if (Validator.isNotNull(servletContextNames)) {
      classLoader=ClassLoaderUtil.getAggregatePluginsClassLoader(StringUtil.split(servletContextNames),false);
    }
    backgroundTaskExecutor=(BackgroundTaskExecutor)InstanceFactory.newInstance(classLoader,backgroundTask.getTaskExecutorClassName());
    backgroundTaskExecutor=wrapBackgroundTaskExecutor(backgroundTaskExecutor,classLoader);
    BackgroundTaskStatusRegistryUtil.registerBackgroundTaskStatus(backgroundTaskId);
    BackgroundTaskResult backgroundTaskResult=backgroundTaskExecutor.execute(backgroundTask);
    status=backgroundTaskResult.getStatus();
    statusMessage=backgroundTaskResult.getStatusMessage();
  }
 catch (  DuplicateLockException e) {
    status=BackgroundTaskConstants.STATUS_QUEUED;
  }
catch (  Exception e) {
    status=BackgroundTaskConstants.STATUS_FAILED;
    statusMessage=backgroundTaskExecutor.handleException(backgroundTask,e);
    if (_log.isInfoEnabled()) {
      statusMessage.concat(StackTraceUtil.getStackTrace(e));
    }
    if (_log.isDebugEnabled()) {
      _log.debug("Unable to execute background task",e);
    }
  }
 finally {
    BackgroundTaskLocalServiceUtil.updateBackgroundTask(backgroundTaskId,null,status,statusMessage,serviceContext);
    BackgroundTaskStatusRegistryUtil.unregisterBackgroundTaskStatus(backgroundTaskId);
    Message responseMessage=new Message();
    responseMessage.put("backgroundTaskId",backgroundTask.getBackgroundTaskId());
    responseMessage.put("name",backgroundTask.getName());
    responseMessage.put("status",status);
    responseMessage.put("taskExecutorClassName",backgroundTask.getTaskExecutorClassName());
    MessageBusUtil.sendMessage(DestinationNames.BACKGROUND_TASK_STATUS,responseMessage);
  }
}
