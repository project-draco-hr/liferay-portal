{
  BufferedImage bufferedImage=getBufferedImage(renderedImage);
  SampleModel sampleModel=bufferedImage.getSampleModel();
  int type=sampleModel.getDataType();
  if ((bufferedImage.getType() != BufferedImage.TYPE_BYTE_BINARY) || (type < DataBuffer.TYPE_BYTE) || (type > DataBuffer.TYPE_INT)|| (sampleModel.getNumBands() != 1)|| (sampleModel.getSampleSize(0) != 1)) {
    BufferedImage binaryImage=new BufferedImage(bufferedImage.getWidth(),bufferedImage.getHeight(),BufferedImage.TYPE_BYTE_BINARY);
    binaryImage.getGraphics().drawImage(bufferedImage,0,0,null);
    renderedImage=binaryImage;
  }
  if (!ImageIO.write(renderedImage,"wbmp",out)) {
    out.write(0);
    out.write(0);
    out.write(_toMultiByte(bufferedImage.getWidth()));
    out.write(_toMultiByte(bufferedImage.getHeight()));
    DataBuffer dataBuffer=bufferedImage.getData().getDataBuffer();
    int size=dataBuffer.getSize();
    for (int i=0; i < size; i++) {
      out.write((byte)dataBuffer.getElem(i));
    }
  }
}
