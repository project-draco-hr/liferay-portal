{
  boolean newEntry=false;
  long classNameId=classNameLocalService.getClassNameId(className);
  double oldScore=0;
  validate(score);
  RatingsEntry entry=ratingsEntryPersistence.fetchByU_C_C(userId,classNameId,classPK);
  if (entry != null) {
    oldScore=entry.getScore();
    entry.setScore(score);
    ratingsEntryPersistence.update(entry);
    RatingsStats stats=ratingsStatsLocalService.getStats(className,classPK);
    stats.setTotalScore(stats.getTotalScore() - oldScore + score);
    stats.setAverageScore(stats.getTotalScore() / stats.getTotalEntries());
    ratingsStatsPersistence.update(stats);
  }
 else {
    newEntry=true;
    User user=userPersistence.findByPrimaryKey(userId);
    long entryId=counterLocalService.increment();
    entry=ratingsEntryPersistence.create(entryId);
    entry.setCompanyId(user.getCompanyId());
    entry.setUserId(user.getUserId());
    entry.setUserName(user.getFullName());
    entry.setClassNameId(classNameId);
    entry.setClassPK(classPK);
    entry.setScore(score);
    ratingsEntryPersistence.update(entry);
    RatingsStats stats=ratingsStatsLocalService.getStats(className,classPK);
    stats.setTotalEntries(stats.getTotalEntries() + 1);
    stats.setTotalScore(stats.getTotalScore() + score);
    stats.setAverageScore(stats.getTotalScore() / stats.getTotalEntries());
    ratingsStatsPersistence.update(stats);
  }
  if (className.equals(BlogsEntry.class.getName())) {
    BlogsEntry blogsEntry=blogsEntryPersistence.findByPrimaryKey(classPK);
    BlogsStatsUser blogsStatsUser=blogsStatsUserLocalService.getStatsUser(blogsEntry.getGroupId(),blogsEntry.getUserId());
    int ratingsTotalEntries=blogsStatsUser.getRatingsTotalEntries();
    double ratingsTotalScore=blogsStatsUser.getRatingsTotalScore();
    double ratingsAverageScore=blogsStatsUser.getRatingsAverageScore();
    if (newEntry) {
      ratingsTotalEntries++;
      ratingsTotalScore+=score;
    }
 else {
      ratingsTotalScore=ratingsTotalScore - oldScore + score;
    }
    ratingsAverageScore=ratingsTotalScore / ratingsTotalEntries;
    blogsStatsUser.setRatingsTotalEntries(ratingsTotalEntries);
    blogsStatsUser.setRatingsTotalScore(ratingsTotalScore);
    blogsStatsUser.setRatingsAverageScore(ratingsAverageScore);
    blogsStatsUserPersistence.update(blogsStatsUser);
  }
  AssetEntry assetEntry=assetEntryLocalService.fetchEntry(className,classPK);
  if (assetEntry != null) {
    JSONObject extraDataJSONObject=JSONFactoryUtil.createJSONObject();
    extraDataJSONObject.put("title",assetEntry.getTitle());
    socialActivityLocalService.addActivity(userId,assetEntry.getGroupId(),className,classPK,SocialActivityConstants.TYPE_ADD_VOTE,extraDataJSONObject.toString(),0);
  }
  return entry;
}
