{
  long classNameId=classNameLocalService.getClassNameId(className);
  double oldScore=0;
  validate(score);
  RatingsEntry entry=ratingsEntryPersistence.fetchByU_C_C(userId,classNameId,classPK);
  if (entry != null) {
    oldScore=entry.getScore();
    entry.setScore(score);
    ratingsEntryPersistence.update(entry);
    RatingsStats stats=ratingsStatsLocalService.getStats(className,classPK);
    stats.setTotalScore(stats.getTotalScore() - oldScore + score);
    stats.setAverageScore(stats.getTotalScore() / stats.getTotalEntries());
    ratingsStatsPersistence.update(stats);
    reindex(stats);
  }
 else {
    User user=userPersistence.findByPrimaryKey(userId);
    long entryId=counterLocalService.increment();
    entry=ratingsEntryPersistence.create(entryId);
    entry.setCompanyId(user.getCompanyId());
    entry.setUserId(user.getUserId());
    entry.setUserName(user.getFullName());
    entry.setClassNameId(classNameId);
    entry.setClassPK(classPK);
    entry.setScore(score);
    ratingsEntryPersistence.update(entry);
    RatingsStats stats=ratingsStatsLocalService.getStats(className,classPK);
    stats.setTotalEntries(stats.getTotalEntries() + 1);
    stats.setTotalScore(stats.getTotalScore() + score);
    stats.setAverageScore(stats.getTotalScore() / stats.getTotalEntries());
    ratingsStatsPersistence.update(stats);
    reindex(stats);
  }
  AssetEntry assetEntry=assetEntryLocalService.fetchEntry(className,classPK);
  if (assetEntry != null) {
    JSONObject extraDataJSONObject=JSONFactoryUtil.createJSONObject();
    extraDataJSONObject.put("title",assetEntry.getTitle());
    SocialActivityManagerUtil.addActivity(userId,assetEntry,SocialActivityConstants.TYPE_ADD_VOTE,extraDataJSONObject.toString(),0);
  }
  return entry;
}
