{
  long classNameId=PortalUtil.getClassNameId(className);
  Date now=new Date();
  RatingsEntry entry=null;
  try {
    entry=RatingsEntryUtil.findByU_C_C(userId,classNameId,classPK);
    double oldScore=entry.getScore();
    entry.setModifiedDate(now);
    entry.setScore(score);
    RatingsEntryUtil.update(entry);
    RatingsStats stats=RatingsStatsLocalServiceUtil.getStats(className,classPK);
    stats.setTotalScore(stats.getTotalScore() - oldScore + score);
    stats.setAverageScore(stats.getTotalScore() / stats.getTotalEntries());
    RatingsStatsUtil.update(stats);
  }
 catch (  NoSuchEntryException nsee) {
    User user=UserUtil.findByPrimaryKey(userId);
    long entryId=CounterLocalServiceUtil.increment();
    entry=RatingsEntryUtil.create(entryId);
    entry.setCompanyId(user.getCompanyId());
    entry.setUserId(user.getUserId());
    entry.setUserName(user.getFullName());
    entry.setCreateDate(now);
    entry.setModifiedDate(now);
    entry.setClassNameId(classNameId);
    entry.setClassPK(classPK);
    entry.setScore(score);
    RatingsEntryUtil.update(entry);
    RatingsStats stats=RatingsStatsLocalServiceUtil.getStats(className,classPK);
    stats.setTotalEntries(stats.getTotalEntries() + 1);
    stats.setTotalScore(stats.getTotalScore() + score);
    stats.setAverageScore(stats.getTotalScore() / stats.getTotalEntries());
    RatingsStatsUtil.update(stats);
  }
  return entry;
}
