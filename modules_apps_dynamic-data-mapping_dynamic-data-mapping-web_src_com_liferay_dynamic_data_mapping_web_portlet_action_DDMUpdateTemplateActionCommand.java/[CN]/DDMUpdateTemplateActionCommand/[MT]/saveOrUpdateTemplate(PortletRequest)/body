{
  UploadPortletRequest uploadPortletRequest=PortalUtil.getUploadPortletRequest(portletRequest);
  long templateId=ParamUtil.getLong(uploadPortletRequest,DDMConstants.TEMPLATE_ID);
  long groupId=ParamUtil.getLong(uploadPortletRequest,DDMConstants.GROUP_ID);
  long classNameId=ParamUtil.getLong(uploadPortletRequest,DDMConstants.CLASS_NAME_ID);
  long classPK=ParamUtil.getLong(uploadPortletRequest,DDMConstants.CLASS_PK);
  long resourceClassNameId=ParamUtil.getLong(uploadPortletRequest,DDMConstants.RESOURCE_CLASS_NAME_ID);
  String templateKey=ParamUtil.getString(uploadPortletRequest,DDMConstants.TEMPLATE_KEY);
  Map<Locale,String> nameMap=LocalizationUtil.getLocalizationMap(uploadPortletRequest,DDMConstants.NAME);
  Map<Locale,String> descriptionMap=LocalizationUtil.getLocalizationMap(uploadPortletRequest,DDMConstants.DESCRIPTION);
  String type=ParamUtil.getString(uploadPortletRequest,DDMConstants.TYPE);
  String mode=ParamUtil.getString(uploadPortletRequest,DDMConstants.MODE);
  String language=ParamUtil.getString(uploadPortletRequest,DDMConstants.LANGUAGE,TemplateConstants.LANG_TYPE_VM);
  String script=getScript(uploadPortletRequest);
  boolean cacheable=ParamUtil.getBoolean(uploadPortletRequest,DDMConstants.CACHEABLE);
  boolean smallImage=ParamUtil.getBoolean(uploadPortletRequest,DDMConstants.SMALL_IMAGE);
  String smallImageURL=ParamUtil.getString(uploadPortletRequest,DDMConstants.SMALL_IMAGE_URL);
  File smallImageFile=uploadPortletRequest.getFile(DDMConstants.SMALL_IMAGE_FILE);
  ServiceContext serviceContext=ServiceContextFactory.getInstance(DDMTemplate.class.getName(),uploadPortletRequest);
  DDMTemplate template=null;
  if (templateId <= 0) {
    template=DDMTemplateServiceUtil.addTemplate(groupId,classNameId,classPK,resourceClassNameId,templateKey,nameMap,descriptionMap,type,mode,language,script,cacheable,smallImage,smallImageURL,smallImageFile,serviceContext);
  }
 else {
    template=DDMTemplateServiceUtil.updateTemplate(templateId,classPK,nameMap,descriptionMap,type,mode,language,script,cacheable,smallImage,smallImageURL,smallImageFile,serviceContext);
  }
  PortletPreferences portletPreferences=getStrictPortletSetup(portletRequest);
  if (portletPreferences != null) {
    if (type.equals(DDMTemplateConstants.TEMPLATE_TYPE_DISPLAY)) {
      portletPreferences.setValue(DDMConstants.DISPLAY_DDM_TEMPLATE_ID,String.valueOf(template.getTemplateId()));
    }
 else {
      portletPreferences.setValue(DDMConstants.FORM_DDM_TEMPLATE_ID,String.valueOf(template.getTemplateId()));
    }
    portletPreferences.store();
  }
  return template;
}
