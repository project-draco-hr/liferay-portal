{
  if (SearchEngineUtil.isIndexReadOnly()) {
    return;
  }
  if (_log.isInfoEnabled()) {
    _log.info("Reindexing Lucene started");
  }
  if (delay < 0) {
    delay=0;
  }
  try {
    if (delay > 0) {
      Thread.sleep(Time.SECOND * delay);
    }
  }
 catch (  InterruptedException ie) {
  }
  StopWatch stopWatch=new StopWatch();
  stopWatch.start();
  try {
    SearchEngineUtil.removeCompany(_companyId);
    SearchEngineUtil.initialize(_companyId);
    List<Portlet> portlets=PortletLocalServiceUtil.getPortlets(_companyId);
    portlets=ListUtil.sort(portlets,new PortletLuceneComparator());
    for (    Portlet portlet : portlets) {
      if (!portlet.isActive()) {
        continue;
      }
      List<Indexer> indexers=portlet.getIndexerInstances();
      if (indexers == null) {
        continue;
      }
      Set<String> searchEngineIds=new HashSet<String>();
      for (      Indexer indexer : indexers) {
        String searchEngineId=indexer.getSearchEngineId();
        if (searchEngineIds.add(searchEngineId)) {
          SearchEngineUtil.deletePortletDocuments(searchEngineId,_companyId,portlet.getPortletId(),true);
        }
        reindex(indexer);
      }
    }
    if (_log.isInfoEnabled()) {
      _log.info("Reindexing Lucene completed in " + (stopWatch.getTime() / Time.SECOND) + " seconds");
    }
  }
 catch (  Exception e) {
    _log.error("Error encountered while reindexing",e);
    if (_log.isInfoEnabled()) {
      _log.info("Reindexing Lucene failed");
    }
  }
  _finished=true;
}
