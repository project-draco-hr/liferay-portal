{
  User user=userPersistence.findByPrimaryKey(userId);
  recordSetKey=recordSetKey.trim().toUpperCase();
  if (autoRecordSetKey) {
    recordSetKey=String.valueOf(counterLocalService.increment());
  }
  Date now=new Date();
  validate(groupId,ddmStructureId,recordSetKey,autoRecordSetKey,nameMap);
  long recordSetId=counterLocalService.increment();
  DDLRecordSet recordSet=ddlRecordSetPersistence.create(recordSetId);
  recordSet.setUuid(serviceContext.getUuid());
  recordSet.setGroupId(groupId);
  recordSet.setCompanyId(user.getCompanyId());
  recordSet.setUserId(user.getUserId());
  recordSet.setUserName(user.getFullName());
  recordSet.setCreateDate(serviceContext.getCreateDate(now));
  recordSet.setModifiedDate(serviceContext.getModifiedDate(now));
  recordSet.setDDMStructureId(ddmStructureId);
  recordSet.setRecordSetKey(recordSetKey);
  recordSet.setNameMap(nameMap);
  recordSet.setDescription(description);
  recordSet.setMinDisplayRows(minDisplayRows);
  ddlRecordSetPersistence.update(recordSet,false);
  if (serviceContext.getAddGroupPermissions() || serviceContext.getAddGuestPermissions()) {
    addRecordSetResources(recordSet,serviceContext.getAddGroupPermissions(),serviceContext.getAddGuestPermissions());
  }
 else {
    addRecordSetResources(recordSet,serviceContext.getGroupPermissions(),serviceContext.getGuestPermissions());
  }
  long classNameId=PortalUtil.getClassNameId(DDLRecordSet.class);
  ddmStructureLinkLocalService.addStructureLink(classNameId,recordSetId,ddmStructureId,serviceContext);
  return recordSet;
}
