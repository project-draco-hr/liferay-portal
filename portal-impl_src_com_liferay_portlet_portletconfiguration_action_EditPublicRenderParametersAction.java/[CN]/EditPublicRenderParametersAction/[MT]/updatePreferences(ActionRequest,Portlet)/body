{
  ThemeDisplay themeDisplay=(ThemeDisplay)actionRequest.getAttribute(WebKeys.THEME_DISPLAY);
  Layout layout=themeDisplay.getLayout();
  PortletPreferences preferences=PortletPreferencesFactoryUtil.getLayoutPortletSetup(layout,portlet.getPortletId());
  Enumeration<String> preferenceNames=preferences.getNames();
  while (preferenceNames.hasMoreElements()) {
    String name=preferenceNames.nextElement();
    if (name.startsWith(_IGNORE_PREFIX) || name.startsWith(_MAPPING_PREFIX)) {
      preferences.reset(name);
    }
  }
  for (  PublicRenderParameter publicRenderParameter : portlet.getPublicRenderParameters()) {
    String ignoreKey=_IGNORE_PREFIX + PortletQNameUtil.getPublicRenderParameterName(publicRenderParameter.getQName());
    boolean ignoreValue=ParamUtil.getBoolean(actionRequest,ignoreKey);
    if (ignoreValue) {
      preferences.setValue(ignoreKey,String.valueOf(Boolean.TRUE));
    }
 else {
      String mappingKey=_MAPPING_PREFIX + PortletQNameUtil.getPublicRenderParameterName(publicRenderParameter.getQName());
      String mappingValue=ParamUtil.getString(actionRequest,mappingKey);
      if (Validator.isNotNull(mappingValue)) {
        preferences.setValue(mappingKey,mappingValue);
      }
    }
  }
  if (SessionErrors.isEmpty(actionRequest)) {
    preferences.store();
  }
}
