{
  ThemeDisplay themeDisplay=(ThemeDisplay)actionRequest.getAttribute(WebKeys.THEME_DISPLAY);
  Layout layout=themeDisplay.getLayout();
  PortletPreferences preferences=PortletPreferencesFactoryUtil.getLayoutPortletSetup(layout,portlet.getPortletId());
  Enumeration<String> enu=preferences.getNames();
  while (enu.hasMoreElements()) {
    String name=enu.nextElement();
    if (name.startsWith(_IGNORE_PREFIX) || name.startsWith(_MAPPING_PREFIX)) {
      preferences.reset(name);
    }
  }
  for (  PublicRenderParameter publicRenderParameter : portlet.getPublicRenderParameters()) {
    String ignoreName=_IGNORE_PREFIX + publicRenderParameter.getIdentifier();
    if (Validator.isNotNull(ParamUtil.getString(actionRequest,ignoreName))) {
      preferences.setValue(ignoreName,StringPool.TRUE);
    }
 else {
      String mappingName=_MAPPING_PREFIX + publicRenderParameter.getIdentifier();
      String mappingValue=ParamUtil.getString(actionRequest,mappingName);
      if (Validator.isNotNull(mappingValue)) {
        String mappingKey=_MAPPING_PREFIX + mappingValue;
        if (Validator.isNull(preferences.getValue(mappingKey,null))) {
          preferences.setValue(mappingKey,publicRenderParameter.getIdentifier());
        }
 else {
          SessionErrors.add(actionRequest,"duplicateMapping");
          break;
        }
      }
    }
  }
  if (SessionErrors.isEmpty(actionRequest)) {
    preferences.store();
  }
}
