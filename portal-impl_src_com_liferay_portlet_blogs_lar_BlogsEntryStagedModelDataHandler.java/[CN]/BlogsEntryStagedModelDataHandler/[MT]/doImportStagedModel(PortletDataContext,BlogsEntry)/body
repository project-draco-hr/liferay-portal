{
  long userId=portletDataContext.getUserId(entry.getUserUuid());
  Element entryElement=portletDataContext.getImportDataStagedModelElement(entry);
  String content=ExportImportHelperUtil.replaceImportContentReferences(portletDataContext,entry,entry.getContent());
  entry.setContent(content);
  Calendar displayDateCal=CalendarFactoryUtil.getCalendar();
  displayDateCal.setTime(entry.getDisplayDate());
  int displayDateMonth=displayDateCal.get(Calendar.MONTH);
  int displayDateDay=displayDateCal.get(Calendar.DATE);
  int displayDateYear=displayDateCal.get(Calendar.YEAR);
  int displayDateHour=displayDateCal.get(Calendar.HOUR);
  int displayDateMinute=displayDateCal.get(Calendar.MINUTE);
  if (displayDateCal.get(Calendar.AM_PM) == Calendar.PM) {
    displayDateHour+=12;
  }
  boolean allowPingbacks=entry.isAllowPingbacks();
  boolean allowTrackbacks=entry.isAllowTrackbacks();
  String[] trackbacks=StringUtil.split(entry.getTrackbacks());
  long smallImageFileEntryId=0;
  String smallImageFileName=null;
  InputStream smallImageInputStream=null;
  ServiceContext serviceContext=portletDataContext.createServiceContext(entry);
  try {
    if (entry.isSmallImage()) {
      String smallImagePath=entryElement.attributeValue("small-image-path");
      if (Validator.isNotNull(entry.getSmallImageURL())) {
        String smallImageURL=ExportImportHelperUtil.replaceImportContentReferences(portletDataContext,entry,entry.getSmallImageURL());
        entry.setSmallImageURL(smallImageURL);
      }
 else       if (Validator.isNotNull(smallImagePath)) {
        smallImageFileName=entry.getSmallImageId() + StringPool.PERIOD + entry.getSmallImageType();
        smallImageInputStream=portletDataContext.getZipEntryAsInputStream(smallImagePath);
        FileEntry smallImageFileEntry=TempFileUtil.addTempFile(serviceContext.getScopeGroupId(),userId,smallImageFileName,BlogsEntry.class.getName(),smallImageInputStream,MimeTypesUtil.getContentType(smallImageFileName));
        smallImageFileEntryId=smallImageFileEntry.getFileEntryId();
      }
    }
    if (smallImageFileEntryId == 0) {
      List<Element> attachmentElements=portletDataContext.getReferenceDataElements(entry,DLFileEntry.class,PortletDataContext.REFERENCE_TYPE_WEAK);
      for (      Element attachmentElement : attachmentElements) {
        InputStream inputStream=_getSmallImageInputStream(portletDataContext,attachmentElement);
        if (inputStream != null) {
          String path=attachmentElement.attributeValue("path");
          FileEntry fileEntry=(FileEntry)portletDataContext.getZipEntryAsObject(path);
          FileEntry smallImageFileEntry=TempFileUtil.addTempFile(serviceContext.getScopeGroupId(),userId,fileEntry.getTitle(),BlogsEntry.class.getName(),inputStream,fileEntry.getMimeType());
          if (fileEntry != null) {
            smallImageFileEntryId=smallImageFileEntry.getFileEntryId();
          }
        }
      }
    }
    BlogsEntry importedEntry=null;
    ImageSelector smallImage=null;
    if (!entry.isSmallImage()) {
      smallImage=new ImageSelector(0);
    }
 else {
      smallImage=new ImageSelector(smallImageFileEntryId,entry.getSmallImageURL());
    }
    if (portletDataContext.isDataStrategyMirror()) {
      serviceContext.setAttribute("urlTitle",entry.getUrlTitle());
      BlogsEntry existingEntry=fetchStagedModelByUuidAndGroupId(entry.getUuid(),portletDataContext.getScopeGroupId());
      if (existingEntry == null) {
        serviceContext.setUuid(entry.getUuid());
        importedEntry=BlogsEntryLocalServiceUtil.addEntry(userId,entry.getTitle(),entry.getSubtitle(),entry.getDescription(),entry.getContent(),displayDateMonth,displayDateDay,displayDateYear,displayDateHour,displayDateMinute,allowPingbacks,allowTrackbacks,trackbacks,smallImage,serviceContext);
      }
 else {
        importedEntry=BlogsEntryLocalServiceUtil.updateEntry(userId,existingEntry.getEntryId(),entry.getTitle(),entry.getSubtitle(),entry.getDescription(),entry.getContent(),displayDateMonth,displayDateDay,displayDateYear,displayDateHour,displayDateMinute,allowPingbacks,allowTrackbacks,trackbacks,smallImage,serviceContext);
      }
    }
 else {
      importedEntry=BlogsEntryLocalServiceUtil.addEntry(userId,entry.getTitle(),entry.getSubtitle(),entry.getDescription(),entry.getContent(),displayDateMonth,displayDateDay,displayDateYear,displayDateHour,displayDateMinute,allowPingbacks,allowTrackbacks,trackbacks,smallImage,serviceContext);
    }
    portletDataContext.importClassedModel(entry,importedEntry);
  }
  finally {
    StreamUtil.cleanUp(smallImageInputStream);
  }
}
