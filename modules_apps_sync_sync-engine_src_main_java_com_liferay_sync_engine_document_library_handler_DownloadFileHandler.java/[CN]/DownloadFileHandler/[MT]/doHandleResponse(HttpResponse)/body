{
  Header errorHeader=httpResponse.getFirstHeader("Sync-Error");
  if (errorHeader != null) {
    handleSiteDeactivatedException();
  }
  long syncAccountId=getSyncAccountId();
  final Session session=SessionManager.getSession(syncAccountId);
  Header tokenHeader=httpResponse.getFirstHeader("Sync-JWT");
  if (tokenHeader != null) {
    session.addHeader("Sync-JWT",tokenHeader.getValue());
  }
  InputStream inputStream=null;
  SyncFile syncFile=getLocalSyncFile();
  if ((syncFile == null) || isUnsynced(syncFile)) {
    return;
  }
  Path filePath=Paths.get(syncFile.getFilePathName());
  try {
    HttpEntity httpEntity=httpResponse.getEntity();
    inputStream=new CountingInputStream(httpEntity.getContent()){
      @Override protected synchronized void afterRead(      int n){
        session.incrementDownloadedBytes(n);
        super.afterRead(n);
      }
    }
;
    inputStream=new RateLimitedInputStream(inputStream,syncAccountId);
    if (httpResponse.getFirstHeader("Accept-Ranges") != null) {
      copyFile(syncFile,filePath,inputStream,true);
    }
 else {
      copyFile(syncFile,filePath,inputStream,false);
    }
  }
  finally {
    StreamUtil.cleanUp(inputStream);
  }
}
