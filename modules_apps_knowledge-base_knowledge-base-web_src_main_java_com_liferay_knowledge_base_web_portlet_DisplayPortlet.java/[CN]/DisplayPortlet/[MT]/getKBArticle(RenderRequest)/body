{
  String mvcPath=ParamUtil.getString(renderRequest,"mvcPath");
  if (mvcPath.endsWith("/edit_article.jsp") || mvcPath.endsWith("/history.jsp") || mvcPath.endsWith("/print_article.jsp")) {
    long resourcePrimKey=ParamUtil.getLong(renderRequest,"resourcePrimKey");
    if (resourcePrimKey == 0) {
      return new KBArticleSelection(null,false);
    }
    KBArticle latestKBArticle=KBArticleLocalServiceUtil.getLatestKBArticle(resourcePrimKey,WorkflowConstants.STATUS_ANY);
    return new KBArticleSelection(latestKBArticle,true);
  }
  PortletPreferences portletPreferences=renderRequest.getPreferences();
  long kbFolderClassNameId=ClassNameLocalServiceUtil.getClassNameId(KBFolderConstants.getClassName());
  long parentResourcePrimKey=GetterUtil.getLong(portletPreferences.getValue("resourcePrimKey",null));
  long parentResourceClassNameId=GetterUtil.getLong(portletPreferences.getValue("resourceClassNameId",null),kbFolderClassNameId);
  KBArticleSelector kbArticleSelector=KBArticleSelectorFactoryUtil.getKBArticleSelector(parentResourceClassNameId);
  String urlTitle=ParamUtil.getString(renderRequest,"urlTitle");
  String preferredKBFolderURLTitle=getPreferredKBFolderUrlTitle(renderRequest,portletPreferences);
  if (Validator.isNotNull(urlTitle)) {
    String kbFolderUrlTitle=ParamUtil.getString(renderRequest,"kbFolderUrlTitle");
    return kbArticleSelector.findByUrlTitle(PortalUtil.getScopeGroupId(renderRequest),preferredKBFolderURLTitle,parentResourcePrimKey,kbFolderUrlTitle,urlTitle);
  }
  long resourcePrimKey=ParamUtil.getLong(renderRequest,"resourcePrimKey",KBArticleConstants.DEFAULT_PARENT_RESOURCE_PRIM_KEY);
  return kbArticleSelector.findByResourcePrimKey(PortalUtil.getScopeGroupId(renderRequest),preferredKBFolderURLTitle,parentResourcePrimKey,resourcePrimKey);
}
