{
  String tempFileId=DLUtil.getTempFileId(fileVersion.getFileEntryId(),fileVersion.getVersion());
  File thumbnailFile=getThumbnailTempFile(tempFileId);
  int previewFilesCount=0;
  try (PDDocument pdDocument=PDDocument.load(file)){
    previewFilesCount=pdDocument.getNumberOfPages();
  }
   File[] previewFiles=new File[previewFilesCount];
  for (int i=0; i < previewFilesCount; i++) {
    previewFiles[i]=getPreviewTempFile(tempFileId,i);
  }
  boolean generatePreview=_isGeneratePreview(fileVersion);
  boolean generateThumbnail=_isGenerateThumbnail(fileVersion);
  StopWatch stopWatch=new StopWatch();
  stopWatch.start();
  if (PropsValues.DL_FILE_ENTRY_PREVIEW_FORK_PROCESS_ENABLED) {
    ProcessCallable<String> processCallable=new LiferayPDFBoxProcessCallable(ServerDetector.getServerId(),PropsUtil.get(PropsKeys.LIFERAY_HOME),Log4JUtil.getCustomLogSettings(),file,thumbnailFile,previewFiles,getThumbnailType(fileVersion),getPreviewType(fileVersion),PropsValues.DL_FILE_ENTRY_PREVIEW_DOCUMENT_DPI,PropsValues.DL_FILE_ENTRY_PREVIEW_DOCUMENT_MAX_HEIGHT,PropsValues.DL_FILE_ENTRY_PREVIEW_DOCUMENT_MAX_WIDTH,generatePreview,generateThumbnail);
    ProcessChannel<String> processChannel=ProcessExecutorUtil.execute(ClassPathUtil.getPortalProcessConfig(),processCallable);
    Future<String> future=processChannel.getProcessNoticeableFuture();
    String processIdentity=String.valueOf(fileVersion.getFileVersionId());
    long pdfBoxTimeout=PropsValues.DL_FILE_ENTRY_PREVIEW_GENERATION_TIMEOUT_PDFBOX;
    if (_log.isDebugEnabled()) {
      if (generateThumbnail && generatePreview) {
        _log.debug("Waiting for " + pdfBoxTimeout + " seconds to generate "+ file.getPath()+ " thumbnail and preview");
      }
 else {
        if (generateThumbnail) {
          _log.debug("Waiting for " + pdfBoxTimeout + " seconds to generate "+ file.getPath()+ " thumbnail");
        }
        if (generatePreview) {
          _log.debug("Waiting for " + pdfBoxTimeout + " seconds to generate "+ file.getPath()+ " preview");
        }
      }
    }
    try {
      future.get(pdfBoxTimeout,TimeUnit.SECONDS);
      futures.put(processIdentity,future);
    }
 catch (    TimeoutException te) {
      String errorMessage=null;
      if (generateThumbnail && generatePreview) {
        errorMessage="Timeout when generating thumbnail and preview for " + file.getPath();
      }
 else {
        if (generateThumbnail) {
          errorMessage="Timeout when generating thumbnail for " + file.getPath();
        }
        if (generatePreview) {
          errorMessage="Timeout when generating preview for " + file.getPath();
        }
      }
      if (future.cancel(true)) {
        errorMessage+=" resulted in a cancelled timeout for " + future;
      }
      _log.error(errorMessage);
      throw te;
    }
catch (    Exception e) {
      _log.error(e,e);
      throw e;
    }
  }
 else {
    LiferayPDFBoxConverter liferayConverter=new LiferayPDFBoxConverter(file,thumbnailFile,previewFiles,getPreviewType(fileVersion),getThumbnailType(fileVersion),PropsValues.DL_FILE_ENTRY_PREVIEW_DOCUMENT_DPI,PropsValues.DL_FILE_ENTRY_PREVIEW_DOCUMENT_MAX_HEIGHT,PropsValues.DL_FILE_ENTRY_PREVIEW_DOCUMENT_MAX_WIDTH,generatePreview,generateThumbnail);
    liferayConverter.generateImagesPB();
  }
  if (generateThumbnail) {
    try {
      storeThumbnailImages(fileVersion,thumbnailFile);
    }
  finally {
      FileUtil.delete(thumbnailFile);
    }
  }
  if (generatePreview) {
    int index=0;
    for (    File previewFile : previewFiles) {
      try {
        addFileToStore(fileVersion.getCompanyId(),PREVIEW_PATH,getPreviewFilePath(fileVersion,index + 1),previewFile);
      }
  finally {
        FileUtil.delete(previewFile);
      }
      index++;
    }
  }
  if (_log.isInfoEnabled()) {
    if (generateThumbnail && generatePreview) {
      _log.info("PDFBox generated a thumbnail " + "and " + getPreviewFileCount(fileVersion) + " preview pages for "+ fileVersion.getFileVersionId()+ " in "+ stopWatch.getTime()+ " ms");
    }
 else {
      if (generateThumbnail) {
        _log.info("PDFBox generated a thumbnail for " + fileVersion.getFileVersionId() + " in "+ stopWatch.getTime()+ " ms");
      }
      if (generatePreview) {
        _log.info("PDFBox generated " + getPreviewFileCount(fileVersion) + " preview pages for "+ fileVersion.getFileVersionId()+ " in "+ stopWatch.getTime()+ " ms");
      }
    }
  }
}
