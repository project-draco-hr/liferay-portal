{
  String distributedSerializable="DISTRIBUTED_SERIALIZABLE";
  DistributedRegistry.registerDistributed(distributedSerializable,Direction.DUPLEX,MatchType.EXACT);
  final String distributedNonserializable="DISTRIBUTED_NONSERIALIZABLE";
  DistributedRegistry.registerDistributed(distributedNonserializable,Direction.DUPLEX,MatchType.EXACT);
  MockHttpServletRequest mockHttpServletRequest=new MockHttpServletRequest();
  mockHttpServletRequest.setAttribute(distributedSerializable,distributedSerializable);
  mockHttpServletRequest.setAttribute(distributedNonserializable,new Object(){
    @Override public String toString(){
      return distributedNonserializable;
    }
  }
);
  String nondistributed="NONDISTRIBUTED";
  mockHttpServletRequest.setAttribute(nondistributed,nondistributed);
  try (CaptureHandler captureHandler=JDKLoggerTestUtil.configureJDKLogger(SPIAgentSerializable.class.getName(),Level.OFF)){
    List<LogRecord> logRecords=captureHandler.getLogRecords();
    Map<String,Serializable> distributedRequestAttributes=SPIAgentSerializable.extractDistributedRequestAttributes(mockHttpServletRequest,Direction.DUPLEX);
    Assert.assertTrue(logRecords.isEmpty());
    Assert.assertEquals(1,distributedRequestAttributes.size());
    Assert.assertEquals(distributedSerializable,distributedRequestAttributes.get(distributedSerializable));
    logRecords=captureHandler.resetLogLevel(Level.WARNING);
    distributedRequestAttributes=SPIAgentSerializable.extractDistributedRequestAttributes(mockHttpServletRequest,Direction.DUPLEX);
    Assert.assertEquals(1,logRecords.size());
    LogRecord logRecord=logRecords.get(0);
    Assert.assertEquals("Nonserializable distributed request attribute name " + distributedNonserializable + " with value "+ distributedNonserializable,logRecord.getMessage());
    Assert.assertEquals(1,distributedRequestAttributes.size());
    Assert.assertEquals(distributedSerializable,distributedRequestAttributes.get(distributedSerializable));
    logRecords=captureHandler.resetLogLevel(Level.FINE);
    distributedRequestAttributes=SPIAgentSerializable.extractDistributedRequestAttributes(mockHttpServletRequest,Direction.DUPLEX);
    Assert.assertEquals(2,logRecords.size());
    logRecord=logRecords.get(0);
    Assert.assertEquals("Nonserializable distributed request attribute name " + distributedNonserializable + " with value "+ distributedNonserializable,logRecord.getMessage());
    logRecord=logRecords.get(1);
    Assert.assertEquals("Nondistributed request attribute name " + nondistributed + " with direction DUPLEX and value "+ nondistributed,logRecord.getMessage());
    Assert.assertEquals(1,distributedRequestAttributes.size());
    Assert.assertEquals(distributedSerializable,distributedRequestAttributes.get(distributedSerializable));
  }
 }
