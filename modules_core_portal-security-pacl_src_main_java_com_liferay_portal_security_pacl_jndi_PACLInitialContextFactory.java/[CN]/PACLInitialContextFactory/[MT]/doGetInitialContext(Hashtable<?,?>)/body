{
  InitialContextFactory initialContextFactory=null;
  if (_initialContextFactoryBuilder != null) {
    if (_log.isDebugEnabled()) {
      _log.debug("Use " + _initialContextFactoryBuilder.getClass() + " to instantiate initial context factory");
    }
    initialContextFactory=_initialContextFactoryBuilder.createInitialContextFactory(environment);
  }
 else {
    if (environment == null) {
      environment=_environment;
    }
    String initialContextFactoryClassName=null;
    if (environment != null) {
      initialContextFactoryClassName=(String)environment.get(Context.INITIAL_CONTEXT_FACTORY);
      if (_log.isDebugEnabled()) {
        _log.debug("Environment initial context factory " + initialContextFactoryClassName);
      }
    }
    if (initialContextFactoryClassName == null) {
      initialContextFactoryClassName=System.getProperty(Context.INITIAL_CONTEXT_FACTORY);
      if (_log.isDebugEnabled()) {
        _log.debug("System initial context factory " + initialContextFactoryClassName);
      }
    }
    if (_log.isDebugEnabled()) {
      _log.debug("Instantiating " + initialContextFactoryClassName);
    }
    initialContextFactory=(InitialContextFactory)InstanceFactory.newInstance(initialContextFactoryClassName);
  }
  Context context=initialContextFactory.getInitialContext(environment);
  Class<? extends Context> clazz=context.getClass();
  Class<?>[] interfaces=clazz.getInterfaces();
  boolean ldapContext=false;
  for (  Class<?> interfaceClass : interfaces) {
    String interfaceClassName=interfaceClass.getName();
    if (interfaceClassName.equals(LdapContext.class.getName())) {
      ldapContext=true;
    }
  }
  if ((context instanceof LdapContext) || ldapContext) {
    return context;
  }
  context=new SchemeAwareContextWrapper(context);
  PACLPolicy paclPolicy=PACLUtil.getPACLPolicy();
  if (paclPolicy == null) {
    return context;
  }
  context=DoPrivilegedFactory.wrap(context);
  paclPolicy=DoPrivilegedFactory.wrap(paclPolicy);
  return new PACLContext(context,paclPolicy);
}
