{
  if (properties == null) {
    properties=new HashMapDictionary<>();
  }
  Map<Long,Configuration> configurations=_configurations.get(companyId);
  if (configurations == null) {
    configurations=new HashMap<>();
    _configurations.put(companyId,configurations);
  }
  Map<Long,Configuration> defaultConfigurations=_configurations.get(0L);
  if (defaultConfigurations == null) {
    Class<?> metatype=getMetatype();
    throw new IllegalArgumentException("No default configuration for " + metatype.getName());
  }
  try {
    Configuration configuration=configurations.get(ldapServerId);
    if (configuration == null) {
      Configuration defaultConfiguration=defaultConfigurations.get(0L);
      configuration=_configurationAdmin.createFactoryConfiguration(defaultConfiguration.getFactoryPid());
    }
    properties.put(LDAPConstants.COMPANY_ID,companyId);
    properties.put(LDAPConstants.LDAP_SERVER_ID,ldapServerId);
    configuration.update(properties);
  }
 catch (  IOException ioe) {
    throw new SystemException("Unable to update configuration",ioe);
  }
}
