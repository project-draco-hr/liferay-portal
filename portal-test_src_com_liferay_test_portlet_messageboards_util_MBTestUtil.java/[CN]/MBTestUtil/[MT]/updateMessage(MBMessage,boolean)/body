{
  boolean workflowEnabled=WorkflowThreadLocal.isEnabled();
  try {
    WorkflowThreadLocal.setEnabled(true);
    ServiceContext serviceContext=ServiceTestUtil.getServiceContext(message.getGroupId());
    serviceContext.setCommand(Constants.UPDATE);
    serviceContext.setLayoutFullURL("http://localhost");
    serviceContext.setWorkflowAction(WorkflowConstants.ACTION_SAVE_DRAFT);
    message=MBMessageLocalServiceUtil.updateMessage(TestPropsValues.getUserId(),message.getMessageId(),ServiceTestUtil.randomString(),ServiceTestUtil.randomString(50),Collections.<ObjectValuePair<String,InputStream>>emptyList(),Collections.<String>emptyList(),message.getPriority(),message.isAllowPingbacks(),serviceContext);
    if (approved) {
      message=updateStatus(message,serviceContext);
    }
    return message;
  }
  finally {
    WorkflowThreadLocal.setEnabled(workflowEnabled);
  }
}
