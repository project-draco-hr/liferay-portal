{
  boolean workflowEnabled=WorkflowThreadLocal.isEnabled();
  try {
    WorkflowThreadLocal.setEnabled(true);
    ServiceContext serviceContext=ServiceContextTestUtil.getServiceContext(message.getGroupId(),userId);
    serviceContext.setCommand(Constants.UPDATE);
    serviceContext.setLayoutFullURL("http://localhost");
    serviceContext.setWorkflowAction(WorkflowConstants.ACTION_SAVE_DRAFT);
    message=MBMessageLocalServiceUtil.updateMessage(userId,message.getMessageId(),subject,body,Collections.<ObjectValuePair<String,InputStream>>emptyList(),Collections.<String>emptyList(),message.getPriority(),message.isAllowPingbacks(),serviceContext);
    if (approved) {
      message=updateStatus(userId,message,serviceContext);
    }
    return message;
  }
  finally {
    WorkflowThreadLocal.setEnabled(workflowEnabled);
  }
}
