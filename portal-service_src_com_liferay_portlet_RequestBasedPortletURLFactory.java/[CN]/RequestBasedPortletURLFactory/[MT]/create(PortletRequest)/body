{
  PortletResponse portletResponse=(PortletResponse)portletRequest.getAttribute(JavaConstants.JAVAX_PORTLET_RESPONSE);
  if (portletResponse == null) {
    return create(PortalUtil.getHttpServletRequest(portletRequest));
  }
  return new LiferayPortletResponseRequestBasedPortletURLFactory(PortalUtil.getLiferayPortletResponse(portletResponse));
}
