{
  if (_log.isDebugEnabled()) {
    _log.debug("Path " + path);
    _log.debug("Context path " + _contextPath);
    _log.debug("Servlet mapping " + _servletMapping);
  }
  String encodedURL=path;
  if (path.startsWith("//") || path.startsWith(_contextPath + _servletMapping)) {
    path=StringUtil.replace(path,"//","/");
    path=StringUtil.replace(path,"&amp;","&");
    try {
      _portletURL.setWindowState(_windowState);
    }
 catch (    WindowStateException wse) {
    }
    try {
      _portletURL.setPortletMode(_portletMode);
    }
 catch (    PortletModeException pme) {
    }
    _portletURL.setParameters(new HashMap());
    _portletURL.setAction(false);
    String strutsAction=path;
    String queryString=StringPool.BLANK;
    int pos=strutsAction.indexOf("?");
    if (pos != -1) {
      strutsAction=path.substring(0,pos);
      queryString=path.substring(pos + 1,path.length());
    }
    if (Validator.isNotNull(_contextPath)) {
      strutsAction=strutsAction.substring(_contextPath.length(),strutsAction.length());
    }
    if ((_servletMapping != null) && (_servletMapping.length() > 0) && (strutsAction.startsWith(_servletMapping))) {
      strutsAction=strutsAction.substring(_servletMapping.length() - 1,strutsAction.length());
    }
    _portletURL.setParameter("struts_action",strutsAction);
    setParameters(_portletURL,queryString);
    encodedURL=_portletURL.toString();
    _log.debug("Encoded portlet URL " + encodedURL);
  }
  return encodedURL;
}
