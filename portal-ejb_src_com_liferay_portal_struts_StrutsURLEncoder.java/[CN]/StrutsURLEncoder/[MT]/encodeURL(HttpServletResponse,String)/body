{
  if (_log.isDebugEnabled()) {
    _log.debug("Path " + path);
    _log.debug("Context path " + _contextPath);
    _log.debug("Servlet mapping " + _servletMapping);
  }
  String encodedURL=path;
  if (path.startsWith("//") || path.startsWith(_contextPath) || path.startsWith(_servletMapping)) {
    path=StringUtil.replace(path,"&amp;","&");
    try {
      _portletURL.setWindowState(_windowState);
    }
 catch (    WindowStateException wse) {
    }
    try {
      _portletURL.setPortletMode(_portletMode);
    }
 catch (    PortletModeException pme) {
    }
    _portletURL.setParameters(new HashMap());
    _portletURL.setAction(false);
    String strutsAction=path;
    String queryString=StringPool.BLANK;
    int pos=strutsAction.indexOf(StringPool.QUESTION);
    if (pos != -1) {
      strutsAction=path.substring(0,pos);
      queryString=path.substring(pos + 1,path.length());
    }
    if (strutsAction.startsWith("c/")) {
      strutsAction=strutsAction.substring(1);
    }
 else     if (strutsAction.startsWith("/c/")) {
      strutsAction=strutsAction.substring(2);
    }
    if (Validator.isNotNull(_contextPath)) {
      strutsAction=strutsAction.substring(_contextPath.length(),strutsAction.length());
    }
    if (strutsAction.startsWith(_servletMapping)) {
      strutsAction=strutsAction.substring(_servletMapping.length(),strutsAction.length());
    }
    if (!strutsAction.startsWith(StringPool.SLASH)) {
      strutsAction=StringPool.SLASH + strutsAction;
    }
    if (_log.isDebugEnabled()) {
      _log.debug("Struts action " + strutsAction);
    }
    _portletURL.setParameter("struts_action",strutsAction);
    setParameters(_portletURL,queryString);
    encodedURL=_portletURL.toString();
    if (_log.isDebugEnabled()) {
      _log.debug("Encoded portlet URL " + encodedURL);
    }
  }
  return encodedURL;
}
