{
  PermissionChecker permissionChecker=null;
  int status=HttpServletResponse.SC_PRECONDITION_FAILED;
  try {
    if (isIgnoredResource(request)) {
      status=HttpServletResponse.SC_NOT_FOUND;
      return;
    }
    WebDAVStorage storage=getStorage(request);
    if (storage.getRootPath() == null) {
      storage.setRootPath(getRootPath(request));
    }
    String remoteUser=request.getRemoteUser();
    if (remoteUser != null) {
      PrincipalThreadLocal.setName(remoteUser);
      long userId=GetterUtil.getLong(remoteUser);
      User user=UserLocalServiceUtil.getUserById(userId);
      permissionChecker=PermissionCheckerFactory.create(user,true);
      PermissionThreadLocal.setPermissionChecker(permissionChecker);
    }
    Method method=MethodFactory.create(request);
    WebDAVRequest webDavRequest=new WebDAVRequest(storage,request,response,permissionChecker);
    if (_log.isInfoEnabled()) {
      _log.info(request.getMethod() + " " + request.getRequestURI());
    }
    if (_log.isDebugEnabled()) {
      _log.debug("|User Agent:  " + request.getHeader("User-Agent"));
      _log.debug("|Remote user: " + remoteUser);
      _log.debug("|Depth:       " + request.getHeader("Depth"));
      _log.debug("|Destination: " + request.getHeader("Destination"));
      _log.debug("|If:          " + request.getHeader("If"));
      _log.debug("|Overwrite:   " + request.getHeader("Overwrite"));
      _log.debug("|Timeout:     " + request.getHeader("Timeout"));
    }
    status=method.process(webDavRequest);
  }
 catch (  Exception e) {
    _log.error(e,e);
  }
 finally {
    if (status > 0) {
      response.setStatus(status);
      if (_log.isInfoEnabled()) {
        _log.info("Status code " + status);
      }
    }
    try {
      PermissionCheckerFactory.recycle(permissionChecker);
    }
 catch (    Exception e) {
    }
  }
}
