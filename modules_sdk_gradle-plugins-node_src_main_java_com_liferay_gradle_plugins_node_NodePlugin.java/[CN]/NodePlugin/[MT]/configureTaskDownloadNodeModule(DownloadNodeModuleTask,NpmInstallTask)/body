{
  downloadNodeModuleTask.onlyIf(new Spec<Task>(){
    @Override public boolean isSatisfiedBy(    Task task){
      DownloadNodeModuleTask downloadNodeModuleTask=(DownloadNodeModuleTask)task;
      File moduleDir=downloadNodeModuleTask.getModuleDir();
      File moduleParentDir=moduleDir.getParentFile();
      if (!moduleParentDir.equals(npmInstallTask.getNodeModulesDir())) {
        return true;
      }
      File packageJsonFile=npmInstallTask.getPackageJsonFile();
      if (!packageJsonFile.exists()) {
        return true;
      }
      String moduleName=downloadNodeModuleTask.getModuleName();
      JsonSlurper jsonSlurper=new JsonSlurper();
      Map<String,Object> packageJson=(Map<String,Object>)jsonSlurper.parse(packageJsonFile);
      Map<String,Object> dependenciesJson=(Map<String,Object>)packageJson.get("dependencies");
      if ((dependenciesJson != null) && dependenciesJson.containsKey(moduleName)) {
        return false;
      }
      dependenciesJson=(Map<String,Object>)packageJson.get("devDependencies");
      if ((dependenciesJson != null) && dependenciesJson.containsKey(moduleName)) {
        return false;
      }
      return true;
    }
  }
);
}
