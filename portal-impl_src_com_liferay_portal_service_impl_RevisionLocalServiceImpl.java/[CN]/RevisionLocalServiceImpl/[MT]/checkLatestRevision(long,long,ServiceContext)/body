{
  Revision revision=null;
  List<Revision> revisions=Collections.EMPTY_LIST;
  Branch branch=branchPersistence.findByPrimaryKey(branchId);
  long revisionId=ParamUtil.getLong(serviceContext,"revisionId");
  if (revisionId > 0) {
    revision=revisionPersistence.findByPrimaryKey(revisionId);
  }
  if (revision == null) {
    revisions=revisionPersistence.findByB_P(branchId,plid,0,1);
    if (!revisions.isEmpty()) {
      revision=revisions.get(0);
    }
  }
  if (revision == null) {
    Layout layout=layoutPersistence.findByPrimaryKey(plid);
    revision=revisionLocalService.addRevision(branch.getBranchId(),plid,layout.getGroupId(),layout.getName(),layout.getTitle(),layout.getDescription(),layout.getTypeSettings(),layout.getIconImage(),layout.getIconImageId(),layout.getThemeId(),layout.getColorSchemeId(),layout.getWapThemeId(),layout.getWapColorSchemeId(),layout.getCss(),false,serviceContext);
    if (!branch.isMaster()) {
      branch=branchLocalService.getMasterBranch(branch.getGroupId());
      revisions=revisionPersistence.findByB_P(branch.getBranchId(),plid,0,1);
      if (revisions.isEmpty()) {
        revisionLocalService.addRevision(branch.getBranchId(),plid,layout.getGroupId(),layout.getName(),layout.getTitle(),layout.getDescription(),layout.getTypeSettings(),layout.getIconImage(),layout.getIconImageId(),layout.getThemeId(),layout.getColorSchemeId(),layout.getWapThemeId(),layout.getWapColorSchemeId(),layout.getCss(),false,serviceContext);
      }
    }
  }
  return revision;
}
