{
  Map<String,Object> context=_getContext();
  context.put("entities",_ejbList);
  String content=_processTemplate(_tplHbmXml,context);
  int lastImportStart=content.lastIndexOf("<import class=");
  int lastImportEnd=content.indexOf("/>",lastImportStart) + 3;
  String imports=content.substring(0,lastImportEnd);
  content=content.substring(lastImportEnd + 1);
  File xmlFile=new File(_hbmFileName);
  if (!xmlFile.exists()) {
    String xml="<?xml version=\"1.0\"?>\n" + "<!DOCTYPE hibernate-mapping PUBLIC \"-//Hibernate/Hibernate Mapping DTD 3.0//EN\" \"http://hibernate.sourceforge.net/hibernate-mapping-3.0.dtd\">\n" + "\n"+ "<hibernate-mapping default-lazy=\"false\" auto-import=\"false\">\n"+ "</hibernate-mapping>";
    _write(xmlFile,xml);
  }
  String oldContent=_read(xmlFile);
  String newContent=_fixHbmXml(oldContent);
  int firstImport=newContent.indexOf("<import class=\"" + _packagePath + ".model.");
  int lastImport=newContent.lastIndexOf("<import class=\"" + _packagePath + ".model.");
  if (firstImport == -1) {
    firstImport=newContent.indexOf("<import class=\"" + _apiPackagePath + ".model.");
    lastImport=newContent.lastIndexOf("<import class=\"" + _apiPackagePath + ".model.");
  }
  if (firstImport == -1) {
    int x=newContent.indexOf("<class");
    if (x != -1) {
      newContent=newContent.substring(0,x) + imports + newContent.substring(x);
    }
 else {
      content=imports + content;
    }
  }
 else {
    firstImport=newContent.indexOf("<import",firstImport) - 1;
    lastImport=newContent.indexOf("/>",lastImport) + 3;
    newContent=newContent.substring(0,firstImport) + imports + newContent.substring(lastImport);
  }
  int firstClass=-1;
  int firstClass1=newContent.indexOf("<class dynamic-update=\"true\" name=\"" + _packagePath + ".model.");
  int firstClass2=newContent.indexOf("<class name=\"" + _packagePath + ".model.");
  if ((firstClass1 != -1) && (firstClass2 != -1)) {
    if (firstClass2 < firstClass1) {
      firstClass=firstClass2;
    }
 else {
      firstClass=firstClass1;
    }
  }
 else   if (firstClass1 != -1) {
    firstClass=firstClass1;
  }
 else   if (firstClass2 != -1) {
    firstClass=firstClass2;
  }
  int lastClass=-1;
  int lastClass1=newContent.lastIndexOf("<class dynamic-update=\"true\" name=\"" + _packagePath + ".model.");
  int lastClass2=newContent.lastIndexOf("<class name=\"" + _packagePath + ".model.");
  if ((lastClass1 != -1) && (lastClass2 != -1)) {
    if (lastClass2 > lastClass1) {
      lastClass=lastClass2;
    }
 else {
      lastClass=lastClass1;
    }
  }
 else   if (lastClass1 != -1) {
    lastClass=lastClass1;
  }
 else   if (lastClass2 != -1) {
    lastClass=lastClass2;
  }
  if (firstClass == -1) {
    int x=newContent.indexOf("</hibernate-mapping>");
    if (x != -1) {
      newContent=newContent.substring(0,x) + content + newContent.substring(x);
    }
  }
 else {
    firstClass=newContent.lastIndexOf("<class",firstClass) - 1;
    lastClass=newContent.indexOf("</class>",lastClass) + 9;
    newContent=newContent.substring(0,firstClass) + content + newContent.substring(lastClass);
  }
  ToolsUtil.writeFileRaw(xmlFile,_formatXml(newContent),_modifiedFileNames);
}
