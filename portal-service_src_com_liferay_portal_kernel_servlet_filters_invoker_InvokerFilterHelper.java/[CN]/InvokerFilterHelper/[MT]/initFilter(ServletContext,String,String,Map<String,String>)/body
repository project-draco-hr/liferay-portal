{
  ClassLoader contextClassLoader=(ClassLoader)servletContext.getAttribute(PortletServlet.PORTLET_CLASS_LOADER);
  if (contextClassLoader == null) {
    Thread currentThread=Thread.currentThread();
    contextClassLoader=currentThread.getContextClassLoader();
  }
  FilterConfig filterConfig=new InvokerFilterConfig(servletContext,filterName,initParameterMap);
  Filter filter=null;
  try {
    filter=(Filter)InstanceFactory.newInstance(contextClassLoader,filterClassName);
    filter.init(filterConfig);
  }
 catch (  Exception e) {
    _log.error("Unable to initialize filter " + filterClassName,e);
    return;
  }
  boolean filterEnabled=true;
  if (filter instanceof LiferayFilter) {
    LiferayFilter liferayFilter=(LiferayFilter)filter;
    filterEnabled=liferayFilter.isFilterEnabled();
  }
  if (filterEnabled) {
    _filterConfigs.put(filterName,filterConfig);
    _filters.put(filterName,filter);
  }
 else {
    if (filter instanceof PortalLifecycle) {
      PortalLifecycle portalLifecycle=(PortalLifecycle)filter;
      PortalLifecycleUtil.removeDestroy(portalLifecycle);
    }
    if (_log.isDebugEnabled()) {
      _log.debug("Removing disabled filter " + filter.getClass());
    }
  }
}
