{
  ClassLoader contextClassLoader=(ClassLoader)servletContext.getAttribute(PortletServlet.PORTLET_CLASS_LOADER);
  if (contextClassLoader == null) {
    Thread currentThread=Thread.currentThread();
    contextClassLoader=currentThread.getContextClassLoader();
  }
  Filter filter=(Filter)InstanceFactory.newInstance(contextClassLoader,filterClassName);
  FilterConfig filterConfig=new InvokerFilterConfig(servletContext,filterName,initParameterMap);
  filter.init(filterConfig);
  boolean filterEnabled=true;
  if (filter instanceof LiferayFilter) {
    LiferayFilter liferayFilter=(LiferayFilter)filter;
    filterEnabled=liferayFilter.isFilterEnabled();
  }
  if (filterEnabled) {
    _filterConfigs.put(filterName,filterConfig);
    _filters.put(filterName,filter);
  }
 else {
    if (filter instanceof PortalLifecycle) {
      PortalLifecycle portalLifecycle=(PortalLifecycle)filter;
      PortalLifecycleUtil.removeDestroy(portalLifecycle);
    }
    if (_log.isDebugEnabled()) {
      _log.debug("Removing disabled filter " + filter.getClass());
    }
  }
}
