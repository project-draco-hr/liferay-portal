{
  Portlet portlet=_portletLocalService.getPortletById(portletDataContext.getCompanyId(),portletId);
  if (portlet == null) {
    if (_log.isDebugEnabled()) {
      _log.debug("Do not update portlet preferences for " + portletId + " because the portlet does not exist");
    }
    return;
  }
  PortletDataHandler portletDataHandler=portlet.getPortletDataHandlerInstance();
  if (importData || !MergeLayoutPrototypesThreadLocal.isInProgress()) {
    _portletPreferencesLocalService.updatePreferences(ownerId,ownerType,plid,portletId,xml);
    return;
  }
  String[] dataPortletPreferences=portletDataHandler.getDataPortletPreferences();
  javax.portlet.PortletPreferences portletPreferences=_portletPreferencesLocalService.getPreferences(portletDataContext.getCompanyId(),ownerId,ownerType,plid,portletId);
  javax.portlet.PortletPreferences jxPortletPreferences=PortletPreferencesFactoryUtil.fromXML(portletDataContext.getCompanyId(),ownerId,ownerType,plid,portletId,xml);
  Enumeration<String> enu=jxPortletPreferences.getNames();
  while (enu.hasMoreElements()) {
    String name=enu.nextElement();
    String scopeLayoutUuid=portletDataContext.getScopeLayoutUuid();
    String scopeType=portletDataContext.getScopeType();
    if (!ArrayUtil.contains(dataPortletPreferences,name) || (Validator.isNull(scopeLayoutUuid) && scopeType.equals("company"))) {
      String[] values=jxPortletPreferences.getValues(name,null);
      portletPreferences.setValues(name,values);
    }
  }
  _portletPreferencesLocalService.updatePreferences(ownerId,ownerType,plid,portletId,portletPreferences);
}
