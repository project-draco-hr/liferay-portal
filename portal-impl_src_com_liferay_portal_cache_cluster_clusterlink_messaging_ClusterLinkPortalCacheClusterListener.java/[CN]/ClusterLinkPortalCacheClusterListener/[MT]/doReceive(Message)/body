{
  byte[] data=(byte[])message.getPayload();
  Deserializer deserializer=new Deserializer(ByteBuffer.wrap(data));
  PortalCacheClusterEvent portalCacheClusterEvent=(PortalCacheClusterEvent)deserializer.readObject();
  if (portalCacheClusterEvent == null) {
    if (_log.isWarnEnabled()) {
      _log.warn("Payload is null");
    }
    return;
  }
  String cacheName=portalCacheClusterEvent.getCacheName();
  Ehcache ehcache=_portalCacheManager.getEhcache(cacheName);
  if ((ehcache == null) && (_hibernateCacheManager != null)) {
    ehcache=_hibernateCacheManager.getEhcache(cacheName);
  }
  if (ehcache != null) {
    PortalCacheClusterEventType portalCacheClusterEventType=portalCacheClusterEvent.getEventType();
    boolean replicate=ClusterReplicationThreadLocal.isReplicate();
    ClusterReplicationThreadLocal.setReplicate(false);
    try {
      if (portalCacheClusterEventType.equals(PortalCacheClusterEventType.REMOVE_ALL)) {
        ehcache.removeAll();
      }
 else       if (portalCacheClusterEventType.equals(PortalCacheClusterEventType.PUT) || portalCacheClusterEventType.equals(PortalCacheClusterEventType.UPDATE)) {
        Serializable elementKey=portalCacheClusterEvent.getElementKey();
        Serializable elementValue=portalCacheClusterEvent.getElementValue();
        if (elementValue == null) {
          ehcache.remove(elementKey);
        }
 else {
          Element element=new Element(elementKey,elementValue);
          int timeToLive=portalCacheClusterEvent.getTimeToLive();
          if (timeToLive != PortalCache.DEFAULT_TIME_TO_LIVE) {
            element.setTimeToLive(timeToLive);
          }
          ehcache.put(element);
        }
      }
 else {
        ehcache.remove(portalCacheClusterEvent.getElementKey());
      }
    }
  finally {
      ClusterReplicationThreadLocal.setReplicate(replicate);
    }
  }
}
