{
  if (_apnsService == null) {
    ApnsServiceBuilder appleServiceBuilder=APNS.newService();
    String certificatePath=getCertificatePath();
    if (Validator.isNull(certificatePath)) {
      throw new PushNotificationsException("The property \"apple.certificate.path\" is not set in " + "portlet.properties");
    }
    InputStream is=null;
    try {
      is=new FileInputStream(certificatePath);
    }
 catch (    FileNotFoundException fnfe) {
      Class<?> clazz=getClass();
      ClassLoader classLoader=clazz.getClassLoader();
      is=classLoader.getResourceAsStream(certificatePath);
    }
    if (is == null) {
      throw new PushNotificationsException("Apple certificate does not exist at " + certificatePath);
    }
    String certificatePassword=getCertificatePassword();
    if (Validator.isNull(certificatePassword)) {
      throw new PushNotificationsException("The property \"apple.certificate.password\" is not set " + "in portlet.properties");
    }
    appleServiceBuilder.withCert(is,certificatePassword);
    appleServiceBuilder.withDelegate(new AppleDelegate());
    if (isSandbox()) {
      appleServiceBuilder.withSandboxDestination();
    }
 else {
      appleServiceBuilder.withProductionDestination();
    }
    _apnsService=appleServiceBuilder.build();
  }
  return _apnsService;
}
