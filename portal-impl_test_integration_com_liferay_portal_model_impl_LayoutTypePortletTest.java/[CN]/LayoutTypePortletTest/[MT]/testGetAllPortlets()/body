{
  Layout layout=_layoutTypePortlet.getLayout();
  _user=UserTestUtil.addUser(layout.getGroupId());
  List<Portlet> initialPortlets=_layoutTypePortlet.getAllPortlets();
  int initialPortletsSize=initialPortlets.size();
  final String portletId=_layoutTypePortlet.addPortletId(_user.getUserId(),PortletKeys.TEST);
  List<Portlet> portlets=_layoutTypePortlet.getAllPortlets();
  Assert.assertEquals(initialPortletsSize + 1,portlets.size());
  final long companyId=TestPropsValues.getCompanyId();
  PortletLocalService portletLocalService=PortletLocalServiceUtil.getService();
  ReflectionTestUtil.setFieldValue(PortletLocalServiceUtil.class,"_service",new PortletLocalServiceImpl(){
    @Override public Portlet getPortletById(    long localCompanyId,    String localPortletId){
      Portlet portlet=super.getPortletById(localCompanyId,localPortletId);
      if ((companyId == localCompanyId) && portletId.equals(localPortletId)) {
        portlet=(Portlet)portlet.clone();
        portlet.setUndeployedPortlet(true);
      }
      return portlet;
    }
  }
);
  try {
    portlets=_layoutTypePortlet.getAllPortlets();
    Assert.assertEquals(initialPortletsSize + 1,portlets.size());
  }
  finally {
    ReflectionTestUtil.setFieldValue(PortletLocalServiceUtil.class,"_service",portletLocalService);
  }
}
