{
  ThemeDisplay themeDisplay=(ThemeDisplay)renderRequest.getAttribute(WebKeys.THEME_DISPLAY);
  Portlet portlet=(Portlet)renderRequest.getAttribute(WebKeys.RENDER_PORTLET);
  PortletPreferences preferences=PortletPreferencesFactoryUtil.getPortletSetup(renderRequest,portlet.getPortletId());
  String layoutTemplateId=preferences.getValue("layout-template-id",PropsValues.NESTED_PORTLETS_LAYOUT_TEMPLATE_DEFAULT);
  String content=StringPool.BLANK;
  String velocityTemplateId=StringPool.BLANK;
  if (Validator.isNotNull(layoutTemplateId)) {
    Theme theme=themeDisplay.getTheme();
    LayoutTemplate layoutTemplate=LayoutTemplateLocalServiceUtil.getLayoutTemplate(layoutTemplateId,false,theme.getThemeId());
    content=renameTemplateColumnsAndIds(layoutTemplate.getContent(),portlet);
    velocityTemplateId=theme.getThemeId() + "_CUSTOM_" + layoutTemplateId;
  }
  renderRequest.setAttribute(WebKeys.LAYOUT_TEMPLATE_CONTENT,content);
  renderRequest.setAttribute(WebKeys.VELOCITY_TEMPLATE_ID,velocityTemplateId);
  return mapping.findForward("portlet.nested_portlets.view");
}
