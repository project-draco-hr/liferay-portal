{
  Portlet portlet=(Portlet)req.getAttribute(WebKeys.RENDER_PORTLET);
  ThemeDisplay themeDisplay=(ThemeDisplay)req.getAttribute(WebKeys.THEME_DISPLAY);
  Theme theme=themeDisplay.getTheme();
  PortletPreferences prefs=PortletPreferencesFactoryUtil.getPortletSetup(req,portlet.getPortletId(),true,true);
  String defaultLayoutTemplateId=PropsUtil.get(PropsUtil.NESTED_PORTLETS_LAYOUT_TEMPLATE_DEFAULT);
  String layoutTemplateId=prefs.getValue("layout-template-id",defaultLayoutTemplateId);
  String content=StringPool.BLANK;
  if (Validator.isNotNull(layoutTemplateId)) {
    LayoutTemplate template=LayoutTemplateLocalUtil.getLayoutTemplate(layoutTemplateId,false,theme.getThemeId());
    content=renameTemplateColumnsAndIds(template.getContent(),portlet);
    themeDisplay.getLayoutTypePortlet().addNestedLayoutTemplate(template,portlet.getPortletId());
  }
  req.setAttribute("layout-content",content);
  return mapping.findForward("portlet.nested_portlets.view");
}
