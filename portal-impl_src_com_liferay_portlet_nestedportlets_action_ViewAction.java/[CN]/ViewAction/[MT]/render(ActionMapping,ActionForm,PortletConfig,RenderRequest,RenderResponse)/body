{
  ThemeDisplay themeDisplay=(ThemeDisplay)renderRequest.getAttribute(WebKeys.THEME_DISPLAY);
  Portlet portlet=(Portlet)renderRequest.getAttribute(WebKeys.RENDER_PORTLET);
  PortletPreferences preferences=PortletPreferencesFactoryUtil.getPortletSetup(renderRequest,portlet.getPortletId());
  String layoutTemplateId=preferences.getValue("layout-template-id",PropsValues.NESTED_PORTLETS_LAYOUT_TEMPLATE_DEFAULT);
  String velocityTemplateId=StringPool.BLANK;
  String velocityTemplateContent=StringPool.BLANK;
  Map<String,String> columnIds=new HashMap<String,String>();
  if (Validator.isNotNull(layoutTemplateId)) {
    Theme theme=themeDisplay.getTheme();
    LayoutTemplate layoutTemplate=LayoutTemplateLocalServiceUtil.getLayoutTemplate(layoutTemplateId,false,theme.getThemeId());
    String content=layoutTemplate.getContent();
    Matcher processColumnMatcher=_processColumnPattern.matcher(content);
    while (processColumnMatcher.find()) {
      String columnId=processColumnMatcher.group(2);
      if (Validator.isNotNull(columnId)) {
        columnIds.put(columnId,portlet.getPortletId() + StringPool.UNDERLINE + columnId);
      }
    }
    processColumnMatcher.reset();
    content=processColumnMatcher.replaceAll("$1\\${$2}$3");
    velocityTemplateId=theme.getThemeId() + LayoutTemplateConstants.CUSTOM_SEPARATOR + layoutTemplateId;
    Matcher columnIdMatcher=_columnIdPattern.matcher(content);
    velocityTemplateContent=columnIdMatcher.replaceAll("$1" + portlet.getPortletId() + "$2$3");
  }
  renderRequest.setAttribute(WebKeys.NESTED_PORTLET_VELOCITY_TEMPLATE_ID,velocityTemplateId);
  renderRequest.setAttribute(WebKeys.NESTED_PORTLET_VELOCITY_TEMPLATE_CONTENT,velocityTemplateContent);
  Map<String,Object> vmVariables=(Map<String,Object>)renderRequest.getAttribute(WebKeys.VM_VARIABLES);
  if (vmVariables != null) {
    vmVariables.putAll(columnIds);
  }
 else {
    renderRequest.setAttribute(WebKeys.VM_VARIABLES,columnIds);
  }
  return mapping.findForward("portlet.nested_portlets.view");
}
