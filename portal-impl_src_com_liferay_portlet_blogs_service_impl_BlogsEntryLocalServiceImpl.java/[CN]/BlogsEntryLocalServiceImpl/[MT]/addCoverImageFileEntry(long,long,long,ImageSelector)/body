{
  FileEntry fileEntry=PortletFileRepositoryUtil.getPortletFileEntry(imageSelector.getImageId());
  BlogsEntryAttachmentFileEntryHelper blogsEntryAttachmentFileEntryHelper=new BlogsEntryAttachmentFileEntryHelper();
  if (fileEntry.isRepositoryCapabilityProvided(TemporaryFileEntriesCapability.class)) {
    Folder folder=addAttachmentsFolder(userId,groupId);
    blogsEntryAttachmentFileEntryHelper.addBlogsEntryAttachmentFileEntry(groupId,userId,entryId,folder.getFolderId(),fileEntry.getTitle(),fileEntry.getMimeType(),fileEntry.getContentStream());
  }
  File file=null;
  try {
    byte[] bytes=imageSelector.getCroppedImageBytes();
    if (bytes == null) {
      return 0;
    }
    file=FileUtil.createTempFile(bytes);
    String title=imageSelector.getTitle();
    if (Validator.isNull(title)) {
      title=StringUtil.randomString() + "_tempCroppedImage_" + entryId;
    }
    Folder folder=addCoverImageFolder(userId,groupId);
    FileEntry coverImageFileEntry=blogsEntryAttachmentFileEntryHelper.addBlogsEntryAttachmentFileEntry(groupId,userId,entryId,folder.getFolderId(),title,imageSelector.getMimeType(),file);
    return coverImageFileEntry.getFileEntryId();
  }
 catch (  IOException ioe) {
    throw new EntryCoverImageCropException();
  }
 finally {
    FileUtil.delete(file);
  }
}
