{
  FileEntry fileEntry=PortletFileRepositoryUtil.getPortletFileEntry(imageSelector.getImageId());
  addOriginalImageFileEntry(userId,groupId,entryId,fileEntry);
  File file=null;
  try {
    byte[] bytes=imageSelector.getCroppedImageBytes();
    if (bytes == null) {
      throw new EntryCoverImageCropException();
    }
    file=FileUtil.createTempFile(bytes);
    Folder folder=addCoverImageFolder(userId,groupId);
    return addProcessedImageFileEntry(userId,groupId,entryId,folder.getFolderId(),imageSelector,file);
  }
 catch (  IOException ioe) {
    throw new EntryCoverImageCropException();
  }
 finally {
    FileUtil.delete(file);
  }
}
