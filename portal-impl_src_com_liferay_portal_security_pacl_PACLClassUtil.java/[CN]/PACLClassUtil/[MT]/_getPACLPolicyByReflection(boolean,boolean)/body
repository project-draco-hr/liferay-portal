{
  PACLPolicy paclPolicy=null;
  boolean initialPortalClassLoaderPhase=true;
  for (int i=1; ; i++) {
    Class<?> callerClass=Reflection.getCallerClass(i);
    if (callerClass == null) {
      break;
    }
    if (debug) {
      _log.debug("Frame " + i + " has caller class "+ callerClass.getName());
    }
    if (Proxy.isProxyClass(callerClass)) {
      if (debug) {
        _log.debug("Skipping frame because it is proxy class");
      }
      continue;
    }
    ClassLoader callerClassLoader=_getCallerClassLoader(callerClass);
    if (callerClassLoader == null) {
      continue;
    }
    if (!initialPortalClassLoaderPhase && (callerClassLoader == _portalClassLoader)) {
      PACLPolicy defaultPACLPolicy=PACLPolicyManager.getDefaultPACLPolicy();
      if (paclPolicy == null) {
        if (debug) {
          _log.debug("Possibly return default PACL policy " + defaultPACLPolicy);
        }
        paclPolicy=defaultPACLPolicy;
      }
      if (!deep) {
        break;
      }
      continue;
    }
    if (initialPortalClassLoaderPhase && (callerClassLoader != _portalClassLoader)) {
      initialPortalClassLoaderPhase=false;
    }
    if ((callerClassLoader == _commonClassLoader) || (callerClassLoader == _portalClassLoader) || (callerClassLoader == _systemClassLoader)) {
      continue;
    }
    if (debug) {
      _log.debug("Lookup PACL policy for caller class loader " + callerClassLoader);
    }
    PACLPolicy callerPACLPolicy=PACLPolicyManager.getPACLPolicy(callerClassLoader);
    if (callerPACLPolicy != null) {
      paclPolicy=callerPACLPolicy;
      if (debug) {
        _log.debug("Possibly return PACL policy " + paclPolicy);
      }
      if (!deep) {
        break;
      }
    }
  }
  if (debug) {
    _log.debug("Returning PACL policy " + paclPolicy);
  }
  return paclPolicy;
}
