{
  if (getServiceACProfile(companyId,name) != null) {
    throw new DuplicateNameException();
  }
  User user=userLocalService.getUserById(userId);
  Date now=new Date();
  long serviceACProfileId=counterLocalService.increment();
  ServiceACProfile serviceACProfile=serviceACProfilePersistence.create(serviceACProfileId);
  serviceACProfile.setAllowedServices(allowedServices);
  serviceACProfile.setCompanyId(companyId);
  serviceACProfile.setCreateDate(now);
  serviceACProfile.setModifiedDate(now);
  serviceACProfile.setName(name);
  serviceACProfile.setTitleMap(titleMap);
  serviceACProfile.setUserId(userId);
  serviceACProfile.setUserName(user.getFullName());
  serviceACProfile.setUserUuid(user.getUuid());
  serviceACProfile=serviceACProfilePersistence.update(serviceACProfile,serviceContext);
  if (serviceContext.isAddGroupPermissions() || serviceContext.isAddGuestPermissions()) {
    addServiceACProfileResources(serviceACProfile,serviceContext.isAddGroupPermissions(),serviceContext.isAddGuestPermissions());
  }
 else {
    addServiceACProfileResources(serviceACProfile,serviceContext.getGroupPermissions(),serviceContext.getGuestPermissions());
  }
  return serviceACProfile;
}
