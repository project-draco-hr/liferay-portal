{
  LinkedHashMap<String,Object> groupParams=new LinkedHashMap<String,Object>();
  groupParams.put("inheritance",Boolean.FALSE);
  groupParams.put("site",Boolean.TRUE);
  groupParams.put("usersGroups",user.getUserId());
  List<Group> groups=groupLocalService.search(user.getCompanyId(),groupParams,QueryUtil.ALL_POS,QueryUtil.ALL_POS);
  for (  Group group : groups) {
    Set<Role> mandatoryGroupRoles=MembershipPolicyUtil.getMandatoryRoles(group,user);
    for (    Role role : mandatoryGroupRoles) {
      if (!hasUserGroupRole(user.getUserId(),group.getGroupId(),role.getRoleId(),false)) {
        addUserGroupRoles(user.getUserId(),group.getGroupId(),new long[]{role.getRoleId()});
      }
    }
    List<Role> userGroupRoles=roleLocalService.getUserGroupRoles(user.getUserId(),group.getGroupId());
    for (    Role role : userGroupRoles) {
      if (!MembershipPolicyUtil.isMembershipAllowed(role,user,group)) {
        deleteUserGroupRoles(user.getUserId(),group.getGroupId(),new long[]{role.getRoleId()});
      }
    }
  }
  List<Organization> organizations=organizationLocalService.getUserOrganizations(user.getUserId());
  for (  Organization organization : organizations) {
    Set<Role> mandatoryOrganizationRoles=MembershipPolicyUtil.getMandatoryRoles(organization,user);
    for (    Role role : mandatoryOrganizationRoles) {
      if (!hasUserGroupRole(user.getUserId(),organization.getGroupId(),role.getRoleId(),false)) {
        addUserGroupRoles(user.getUserId(),organization.getGroupId(),new long[]{role.getRoleId()});
      }
    }
    List<Role> userOrganizationRoles=roleLocalService.getUserGroupRoles(user.getUserId(),organization.getGroupId());
    for (    Role role : userOrganizationRoles) {
      if (!MembershipPolicyUtil.isMembershipAllowed(role,user,organization)) {
        deleteUserGroupRoles(user.getUserId(),organization.getGroupId(),new long[]{role.getRoleId()});
      }
    }
  }
}
