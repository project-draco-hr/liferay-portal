{
  LinkedHashMap<String,Object> groupParams=new LinkedHashMap<String,Object>();
  groupParams.put("inheritance",Boolean.FALSE);
  groupParams.put("site",Boolean.TRUE);
  groupParams.put("usersGroups",user.getUserId());
  List<Group> groups=groupLocalService.search(user.getCompanyId(),groupParams,QueryUtil.ALL_POS,QueryUtil.ALL_POS);
  for (  Group group : groups) {
    Set<Role> mandatoryRoles=MembershipPolicyUtil.getMandatoryRoles(group,user);
    for (    Role role : mandatoryRoles) {
      if (!hasUserGroupRole(user.getUserId(),group.getGroupId(),role.getRoleId(),false)) {
        addUserGroupRoles(user.getUserId(),group.getGroupId(),new long[]{role.getRoleId()});
      }
    }
    List<Role> roles=roleLocalService.getUserGroupRoles(user.getUserId(),group.getGroupId());
    for (    Role role : roles) {
      if (!MembershipPolicyUtil.isMembershipAllowed(group,role,user)) {
        deleteUserGroupRoles(user.getUserId(),group.getGroupId(),new long[]{role.getRoleId()});
      }
    }
  }
  List<Organization> organizations=organizationLocalService.getUserOrganizations(user.getUserId());
  for (  Organization organization : organizations) {
    Set<Role> mandatoryRoles=MembershipPolicyUtil.getMandatoryRoles(organization,user);
    for (    Role role : mandatoryRoles) {
      if (!hasUserGroupRole(user.getUserId(),organization.getGroupId(),role.getRoleId(),false)) {
        addUserGroupRoles(user.getUserId(),organization.getGroupId(),new long[]{role.getRoleId()});
      }
    }
    List<Role> roles=roleLocalService.getUserGroupRoles(user.getUserId(),organization.getGroupId());
    for (    Role role : roles) {
      if (!MembershipPolicyUtil.isMembershipAllowed(organization,role,user)) {
        deleteUserGroupRoles(user.getUserId(),organization.getGroupId(),new long[]{role.getRoleId()});
      }
    }
  }
}
