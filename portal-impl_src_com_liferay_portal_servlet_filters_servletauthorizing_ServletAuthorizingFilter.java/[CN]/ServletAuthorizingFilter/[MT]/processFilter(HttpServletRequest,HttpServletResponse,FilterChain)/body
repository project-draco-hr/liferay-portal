{
  HttpSession session=request.getSession();
  PortalInstances.getCompanyId(request);
  long userId=PortalUtil.getUserId(request);
  String remoteUser=request.getRemoteUser();
  if (!PropsValues.PORTAL_JAAS_ENABLE) {
    String jRemoteUser=(String)session.getAttribute("j_remoteuser");
    if (jRemoteUser != null) {
      remoteUser=jRemoteUser;
      session.removeAttribute("j_remoteuser");
    }
  }
  if ((userId > 0) && (remoteUser == null)) {
    remoteUser=String.valueOf(userId);
  }
  request=new ProtectedServletRequest(request,remoteUser);
  if ((userId > 0) || (remoteUser != null)) {
    String name=String.valueOf(userId);
    if (remoteUser != null) {
      name=remoteUser;
    }
    PrincipalThreadLocal.setName(name);
    userId=GetterUtil.getLong(name);
    try {
      User user=UserLocalServiceUtil.getUserById(userId);
      PermissionChecker permissionChecker=PermissionCheckerFactoryUtil.create(user);
      PermissionThreadLocal.setPermissionChecker(permissionChecker);
      session.setAttribute(WebKeys.USER_ID,Long.valueOf(userId));
      session.setAttribute(Globals.LOCALE_KEY,user.getLocale());
    }
 catch (    Exception e) {
      _log.error(e,e);
    }
  }
  processFilter(ServletAuthorizingFilter.class,request,response,filterChain);
}
