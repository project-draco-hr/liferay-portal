{
  T connection=null;
  HttpSession httpSession=PortalSessionThreadLocal.getHttpSession();
  if (httpSession != null) {
    TransientValue<T> transientValue=(TransientValue<T>)httpSession.getAttribute(_sessionKey);
    if (transientValue != null) {
      connection=transientValue.getValue();
    }
  }
 else {
    connection=_connectionThreadLocal.get();
  }
  if (connection != null) {
    return connection;
  }
  connection=_connectionBuilder.buildConnection();
  if (httpSession != null) {
    TransientValue<T> transientValue=new TransientValue<>(connection);
    httpSession.setAttribute(_sessionKey,transientValue);
  }
  _connectionThreadLocal.set(connection);
  return connection;
}
