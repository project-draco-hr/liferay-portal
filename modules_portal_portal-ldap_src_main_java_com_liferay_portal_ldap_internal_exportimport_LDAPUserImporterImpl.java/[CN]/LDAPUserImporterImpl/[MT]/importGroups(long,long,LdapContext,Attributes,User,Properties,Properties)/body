{
  String groupMappingsUser=groupMappings.getProperty("user");
  Set<Long> newUserGroupIds=new LinkedHashSet<>();
  LDAPServerConfiguration ldapServerConfiguration=_ldapServerConfigurationProvider.getConfiguration(companyId,ldapServerId);
  if (Validator.isNotNull(groupMappingsUser) && ldapServerConfiguration.groupSearchFilterEnabled()) {
    String baseDN=ldapServerConfiguration.baseDN();
    StringBundler sb=new StringBundler(9);
    sb.append(StringPool.OPEN_PARENTHESIS);
    sb.append(StringPool.AMPERSAND);
    String groupSearchFilter=ldapServerConfiguration.groupSearchFilter();
    LDAPUtil.validateFilter(groupSearchFilter,"LDAPServerConfiguration.groupSearchFilter");
    sb.append(groupSearchFilter);
    sb.append(StringPool.OPEN_PARENTHESIS);
    sb.append(groupMappingsUser);
    sb.append(StringPool.EQUAL);
    Binding binding=_portalLDAP.getUser(ldapServerId,companyId,user.getScreenName(),user.getEmailAddress());
    String fullUserDN=_portalLDAP.getNameInNamespace(ldapServerId,companyId,binding);
    sb.append(escapeValue(fullUserDN));
    sb.append(StringPool.CLOSE_PARENTHESIS);
    sb.append(StringPool.CLOSE_PARENTHESIS);
    byte[] cookie=new byte[0];
    while (cookie != null) {
      List<SearchResult> searchResults=new ArrayList<>();
      String groupMappingsGroupName=GetterUtil.getString(groupMappings.getProperty("groupName"));
      groupMappingsGroupName=StringUtil.toLowerCase(groupMappingsGroupName);
      cookie=_portalLDAP.searchLDAP(companyId,ldapContext,cookie,0,baseDN,sb.toString(),new String[]{groupMappingsGroupName},searchResults);
      for (      SearchResult searchResult : searchResults) {
        String fullGroupDN=_portalLDAP.getNameInNamespace(ldapServerId,companyId,searchResult);
        newUserGroupIds=importGroup(ldapServerId,companyId,ldapContext,fullGroupDN,user,groupMappings,newUserGroupIds);
      }
    }
  }
 else {
    String userMappingsGroup=userMappings.getProperty("group");
    if (Validator.isNull(userMappingsGroup)) {
      if (_log.isInfoEnabled()) {
        _log.info("No groups were imported because a user mapping for " + "Group was not found.");
      }
      return;
    }
    Attribute userGroupAttribute=attributes.get(userMappingsGroup);
    if (userGroupAttribute == null) {
      return;
    }
    for (int i=0; i < userGroupAttribute.size(); i++) {
      String fullGroupDN=(String)userGroupAttribute.get(i);
      newUserGroupIds=importGroup(ldapServerId,companyId,ldapContext,fullGroupDN,user,groupMappings,newUserGroupIds);
    }
  }
  addUserGroupsNotAddedByLDAPImport(user.getUserId(),newUserGroupIds);
  Set<Long> oldUserGroupIds=new LinkedHashSet<>();
  List<UserGroup> oldUserGroups=_userGroupLocalService.getUserUserGroups(user.getUserId());
  for (  UserGroup oldUserGroup : oldUserGroups) {
    oldUserGroupIds.add(oldUserGroup.getUserGroupId());
  }
  if (!oldUserGroupIds.equals(newUserGroupIds)) {
    long[] userGroupIds=ArrayUtil.toLongArray(newUserGroupIds);
    _userGroupLocalService.setUserUserGroups(user.getUserId(),userGroupIds);
  }
}
