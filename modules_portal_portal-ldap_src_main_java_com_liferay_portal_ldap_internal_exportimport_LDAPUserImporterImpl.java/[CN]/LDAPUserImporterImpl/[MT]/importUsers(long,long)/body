{
  if (!_ldapSettings.isImportEnabled(companyId)) {
    return;
  }
  LdapContext ldapContext=_portalLDAP.getContext(ldapServerId,companyId);
  if (ldapContext == null) {
    return;
  }
  _lastImportTime=System.currentTimeMillis();
  LDAPImportConfiguration ldapImportConfiguration=_ldapImportConfigurationProvider.getConfiguration(companyId);
  String[] userIgnoreAttributes=ldapImportConfiguration.userIgnoreAttributes();
  Set<String> ldapUserIgnoreAttributes=new HashSet<>(Arrays.asList(userIgnoreAttributes));
  try {
    Properties userMappings=_ldapSettings.getUserMappings(ldapServerId,companyId);
    Properties userExpandoMappings=_ldapSettings.getUserExpandoMappings(ldapServerId,companyId);
    Properties contactMappings=_ldapSettings.getContactMappings(ldapServerId,companyId);
    Properties contactExpandoMappings=_ldapSettings.getContactExpandoMappings(ldapServerId,companyId);
    Properties groupMappings=_ldapSettings.getGroupMappings(ldapServerId,companyId);
    String importMethod=ldapImportConfiguration.importMethod();
    if (importMethod.equals(_IMPORT_BY_GROUP)) {
      importFromLDAPByGroup(ldapServerId,companyId,ldapContext,userMappings,userExpandoMappings,contactMappings,contactExpandoMappings,groupMappings,ldapUserIgnoreAttributes);
    }
 else     if (importMethod.equals(_IMPORT_BY_USER)) {
      importFromLDAPByUser(ldapServerId,companyId,ldapContext,userMappings,userExpandoMappings,contactMappings,contactExpandoMappings,groupMappings,ldapUserIgnoreAttributes);
    }
  }
 catch (  Exception e) {
    _log.error("Unable to import LDAP users and groups",e);
  }
 finally {
    ldapContext.close();
  }
}
