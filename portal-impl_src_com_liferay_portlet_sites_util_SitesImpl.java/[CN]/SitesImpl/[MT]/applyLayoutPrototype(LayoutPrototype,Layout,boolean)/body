{
  Layout layoutPrototypeLayout=layoutPrototype.getLayout();
  ServiceContext serviceContext=ServiceContextThreadLocal.getServiceContext();
  serviceContext.setAttribute("layoutPrototypeLinkEnabled",linkEnabled);
  serviceContext.setAttribute("layoutPrototypeUuid",layoutPrototype.getUuid());
  LayoutTypePortlet targetLayoutType=(LayoutTypePortlet)targetLayout.getLayoutType();
  List<String> targetLayoutPortletIds=targetLayoutType.getPortletIds();
  Locale siteDefaultLocale=LocaleThreadLocal.getSiteDefaultLocale();
  try {
    Locale targetSiteDefaultLocale=PortalUtil.getSiteDefaultLocale(targetLayout.getGroupId());
    LocaleThreadLocal.setSiteDefaultLocale(targetSiteDefaultLocale);
    targetLayout=LayoutLocalServiceUtil.updateLayout(targetLayout.getGroupId(),targetLayout.isPrivateLayout(),targetLayout.getLayoutId(),targetLayout.getParentLayoutId(),targetLayout.getNameMap(),targetLayout.getTitleMap(),targetLayout.getDescriptionMap(),targetLayout.getKeywordsMap(),targetLayout.getRobotsMap(),layoutPrototypeLayout.getType(),targetLayout.getHidden(),targetLayout.getFriendlyURLMap(),targetLayout.getIconImage(),null,serviceContext);
  }
  finally {
    LocaleThreadLocal.setSiteDefaultLocale(siteDefaultLocale);
  }
  targetLayout=LayoutLocalServiceUtil.updateLayout(targetLayout.getGroupId(),targetLayout.isPrivateLayout(),targetLayout.getLayoutId(),layoutPrototypeLayout.getTypeSettings());
  copyPortletPermissions(targetLayout,layoutPrototypeLayout);
  copyPortletSetups(layoutPrototypeLayout,targetLayout);
  copyLookAndFeel(targetLayout,layoutPrototypeLayout);
  deleteUnreferencedPortlets(targetLayoutPortletIds,targetLayout,layoutPrototypeLayout);
  targetLayout=LayoutLocalServiceUtil.getLayout(targetLayout.getPlid());
  UnicodeProperties typeSettingsProperties=targetLayout.getTypeSettingsProperties();
  typeSettingsProperties.setProperty(LAST_MERGE_TIME,String.valueOf(targetLayout.getModifiedDate().getTime()));
  LayoutLocalServiceUtil.updateLayout(targetLayout);
  UnicodeProperties prototypeTypeSettingsProperties=layoutPrototypeLayout.getTypeSettingsProperties();
  prototypeTypeSettingsProperties.setProperty(MERGE_FAIL_COUNT,"0");
  LayoutLocalServiceUtil.updateLayout(layoutPrototypeLayout);
}
