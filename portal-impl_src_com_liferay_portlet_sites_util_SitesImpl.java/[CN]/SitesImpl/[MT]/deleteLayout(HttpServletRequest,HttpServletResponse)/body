{
  ThemeDisplay themeDisplay=(ThemeDisplay)request.getAttribute(WebKeys.THEME_DISPLAY);
  PermissionChecker permissionChecker=themeDisplay.getPermissionChecker();
  long selPlid=ParamUtil.getLong(request,"selPlid");
  long groupId=ParamUtil.getLong(request,"groupId");
  boolean privateLayout=ParamUtil.getBoolean(request,"privateLayout");
  long layoutId=ParamUtil.getLong(request,"layoutId");
  Layout layout=null;
  if (selPlid <= 0) {
    layout=LayoutLocalServiceUtil.getLayout(groupId,privateLayout,layoutId);
  }
 else {
    layout=LayoutLocalServiceUtil.getLayout(selPlid);
    groupId=layout.getGroupId();
    privateLayout=layout.isPrivateLayout();
    layoutId=layout.getLayoutId();
  }
  Group group=layout.getGroup();
  String oldFriendlyURL=layout.getFriendlyURL(themeDisplay.getLocale());
  if (group.isStagingGroup() && !GroupPermissionUtil.contains(permissionChecker,group,ActionKeys.MANAGE_STAGING) && !GroupPermissionUtil.contains(permissionChecker,group,ActionKeys.PUBLISH_STAGING)) {
    throw new PrincipalException.MustHavePermission(permissionChecker,Group.class.getName(),group.getGroupId(),ActionKeys.MANAGE_STAGING,ActionKeys.PUBLISH_STAGING);
  }
  if (LayoutPermissionUtil.contains(permissionChecker,layout,ActionKeys.DELETE)) {
    LayoutType layoutType=layout.getLayoutType();
    EventsProcessorUtil.process(PropsKeys.LAYOUT_CONFIGURATION_ACTION_DELETE,layoutType.getConfigurationActionDelete(),request,response);
  }
  if (group.isGuest() && !layout.isPrivateLayout() && layout.isRootLayout()&& (LayoutLocalServiceUtil.getLayoutsCount(group,false,LayoutConstants.DEFAULT_PARENT_LAYOUT_ID) == 1)) {
    throw new RequiredLayoutException(RequiredLayoutException.AT_LEAST_ONE);
  }
  ServiceContext serviceContext=ServiceContextFactory.getInstance(request);
  LayoutServiceUtil.deleteLayout(groupId,privateLayout,layoutId,serviceContext);
  long newPlid=LayoutConstants.DEFAULT_PLID;
  if (selPlid == themeDisplay.getRefererPlid()) {
    if (layout.getParentLayoutId() != LayoutConstants.DEFAULT_PARENT_LAYOUT_ID) {
      Layout parentLayout=LayoutLocalServiceUtil.fetchLayout(layout.getGroupId(),layout.isPrivateLayout(),layout.getParentLayoutId());
      if (parentLayout != null) {
        newPlid=parentLayout.getPlid();
      }
    }
    if (newPlid <= 0) {
      Layout firstLayout=LayoutLocalServiceUtil.fetchFirstLayout(layout.getGroupId(),layout.isPrivateLayout(),LayoutConstants.DEFAULT_PARENT_LAYOUT_ID);
      if ((firstLayout != null) && (firstLayout.getPlid() != selPlid)) {
        newPlid=firstLayout.getPlid();
      }
      if (newPlid <= 0) {
        Layout firstLayoutOtherLayoutSet=LayoutLocalServiceUtil.fetchFirstLayout(layout.getGroupId(),!layout.isPrivateLayout(),LayoutConstants.DEFAULT_PARENT_LAYOUT_ID);
        if ((firstLayoutOtherLayoutSet != null) && (firstLayoutOtherLayoutSet.getPlid() != selPlid)) {
          newPlid=firstLayoutOtherLayoutSet.getPlid();
        }
      }
    }
  }
  return new Object[]{group,oldFriendlyURL,newPlid};
}
