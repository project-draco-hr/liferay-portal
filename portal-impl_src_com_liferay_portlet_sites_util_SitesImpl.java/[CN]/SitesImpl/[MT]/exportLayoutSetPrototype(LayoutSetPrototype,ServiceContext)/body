{
  User user=UserLocalServiceUtil.fetchUser(serviceContext.getUserId());
  if (user == null) {
    BackgroundTask backgroundTask=BackgroundTaskLocalServiceUtil.fetchBackgroundTask(BackgroundTaskThreadLocal.getBackgroundTaskId());
    if (backgroundTask != null) {
      user=UserLocalServiceUtil.getUser(backgroundTask.getUserId());
    }
  }
  if (user == null) {
    user=UserLocalServiceUtil.getUser(GetterUtil.getLong(PrincipalThreadLocal.getName()));
  }
  LayoutSet layoutSet=layoutSetPrototype.getLayoutSet();
  List<Layout> layoutSetPrototypeLayouts=LayoutLocalServiceUtil.getLayouts(layoutSet.getGroupId(),layoutSet.isPrivateLayout());
  Map<String,String[]> parameterMap=getLayoutSetPrototypeParameters(serviceContext);
  Map<String,Serializable> settingsMap=ExportImportConfigurationSettingsMapFactory.buildSettingsMap(user.getUserId(),layoutSet.getGroupId(),layoutSet.isPrivateLayout(),ExportImportHelperUtil.getLayoutIds(layoutSetPrototypeLayouts),parameterMap,user.getLocale(),user.getTimeZone());
  ExportImportConfiguration exportImportConfiguration=ExportImportConfigurationLocalServiceUtil.addExportImportConfiguration(user.getUserId(),layoutSet.getGroupId(),StringPool.BLANK,StringPool.BLANK,ExportImportConfigurationConstants.TYPE_EXPORT_LAYOUT,settingsMap,WorkflowConstants.STATUS_DRAFT,new ServiceContext());
  return ExportImportLocalServiceUtil.exportLayoutsAsFile(exportImportConfiguration);
}
