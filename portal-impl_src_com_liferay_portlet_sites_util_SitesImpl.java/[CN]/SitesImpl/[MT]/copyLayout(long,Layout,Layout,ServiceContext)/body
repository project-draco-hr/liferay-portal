{
  User user=UserLocalServiceUtil.getUser(userId);
  Map<String,String[]> parameterMap=getLayoutSetPrototypeParameters(serviceContext);
  parameterMap.put(PortletDataHandlerKeys.DELETE_MISSING_LAYOUTS,new String[]{Boolean.FALSE.toString()});
  Map<String,Serializable> exportLayoutSettingsMap=ExportImportConfigurationSettingsMapFactory.buildExportLayoutSettingsMap(user,sourceLayout.getGroupId(),sourceLayout.isPrivateLayout(),new long[]{sourceLayout.getLayoutId()},parameterMap);
  ExportImportConfiguration exportConfiguration=ExportImportConfigurationLocalServiceUtil.addDraftExportImportConfiguration(user.getUserId(),ExportImportConfigurationConstants.TYPE_EXPORT_LAYOUT,exportLayoutSettingsMap);
  File file=ExportImportLocalServiceUtil.exportLayoutsAsFile(exportConfiguration);
  try {
    Map<String,Serializable> importLayoutSettingsMap=ExportImportConfigurationSettingsMapFactory.buildImportLayoutSettingsMap(userId,targetLayout.getGroupId(),targetLayout.isPrivateLayout(),null,parameterMap,user.getLocale(),user.getTimeZone());
    ExportImportConfiguration importConfiguration=ExportImportConfigurationLocalServiceUtil.addDraftExportImportConfiguration(userId,ExportImportConfigurationConstants.TYPE_IMPORT_LAYOUT,importLayoutSettingsMap);
    ExportImportLocalServiceUtil.importLayouts(importConfiguration,file);
  }
  finally {
    file.delete();
  }
}
