{
  if (scope == ResourceConstants.SCOPE_COMPANY) {
    unsetRolePermissions(roleId,companyId,name,ResourceConstants.SCOPE_GROUP,actionId);
  }
 else   if (scope == ResourceConstants.SCOPE_GROUP) {
    unsetRolePermissions(roleId,companyId,name,ResourceConstants.SCOPE_COMPANY,actionId);
  }
 else   if (scope == ResourceConstants.SCOPE_INDIVIDUAL) {
    throw new NoSuchPermissionException();
  }
  Resource resource=resourceLocalService.addResource(companyId,name,scope,primKey);
  long resourceId=resource.getResourceId();
  Permission permission=permissionPersistence.fetchByA_R(actionId,resourceId);
  if (permission == null) {
    long permissionId=counterLocalService.increment(Permission.class.getName());
    permission=permissionPersistence.create(permissionId);
    permission.setCompanyId(companyId);
    permission.setActionId(actionId);
    permission.setResourceId(resourceId);
    permissionPersistence.update(permission,false);
  }
  rolePersistence.addPermission(roleId,permission);
  PermissionCacheUtil.clearCache();
  SearchEngineUtil.updatePermissionFields(resourceId);
}
