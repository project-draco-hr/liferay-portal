{
  if (images.size() < 1) {
    return null;
  }
  if (spritePropertiesRootPath.endsWith(StringPool.SLASH) || spritePropertiesRootPath.endsWith(StringPool.BACK_SLASH)) {
    spritePropertiesRootPath=spritePropertiesRootPath.substring(0,spritePropertiesRootPath.length() - 1);
  }
  Collections.sort(images);
  String spriteRootDirName=PropsValues.SPRITE_ROOT_DIR;
  if (Validator.isNull(spriteRootDirName)) {
    File image=images.get(0);
    spriteRootDirName=String.valueOf(image.getParentFile());
  }
  File spritePropertiesFile=new File(spriteRootDirName + StringPool.SLASH + spritePropertiesFileName);
  boolean build=false;
  long lastModified=0;
  if (spritePropertiesFile.exists()) {
    lastModified=spritePropertiesFile.lastModified();
    for (    File image : images) {
      if (image.lastModified() > lastModified) {
        build=true;
        break;
      }
    }
  }
 else {
    build=true;
  }
  if (!build) {
    String spritePropertiesString=FileUtil.read(spritePropertiesFile);
    if (Validator.isNull(spritePropertiesString)) {
      return null;
    }
 else {
      return PropertiesUtil.load(spritePropertiesString);
    }
  }
  List<RenderedImage> renderedImages=new ArrayList<RenderedImage>();
  Properties spriteProperties=new SortedProperties();
  float x=0;
  float y=0;
  for (  File file : images) {
    if (file.length() > maxSize) {
      continue;
    }
    try {
      ImageBag imageBag=ImageProcessorUtil.read(file);
      RenderedImage renderedImage=imageBag.getRenderedImage();
      int height=renderedImage.getHeight();
      int width=renderedImage.getWidth();
      if ((height <= maxHeight) && (width <= maxWidth)) {
        renderedImage=convert(renderedImage);
        renderedImage=TranslateDescriptor.create(renderedImage,x,y,null,null);
        renderedImages.add(renderedImage);
        String key=StringUtil.replace(file.toString(),CharPool.BACK_SLASH,CharPool.SLASH);
        key=key.substring(spritePropertiesRootPath.toString().length());
        String value=(int)y + "," + height+ ","+ width;
        spriteProperties.setProperty(key,value);
        y+=renderedImage.getHeight();
      }
    }
 catch (    Exception e) {
      if (_log.isWarnEnabled()) {
        _log.warn("Unable to process " + file);
      }
      if (_log.isDebugEnabled()) {
        _log.debug(e,e);
      }
    }
  }
  if (renderedImages.size() <= 1) {
    renderedImages.clear();
    spriteProperties.clear();
  }
 else {
    RenderedImage renderedImage=MosaicDescriptor.create(renderedImages.toArray(new RenderedImage[renderedImages.size()]),MosaicDescriptor.MOSAIC_TYPE_OVERLAY,null,null,null,null,null);
    File spriteFile=new File(spriteRootDirName + StringPool.SLASH + spriteFileName);
    ImageIO.write(renderedImage,"png",spriteFile);
    if (lastModified > 0) {
      spriteFile.setLastModified(lastModified);
    }
    ImageWorker imageWorker=new ImageWorker(renderedImage);
    imageWorker.forceIndexColorModelForGIF(true);
    renderedImage=imageWorker.getPlanarImage();
    spriteFile=new File(spriteRootDirName + StringPool.SLASH + StringUtil.replace(spriteFileName,".png",".gif"));
    FileOutputStream fos=new FileOutputStream(spriteFile);
    try {
      ImageProcessorUtil.encodeGIF(renderedImage,fos);
    }
  finally {
      fos.close();
    }
    if (lastModified > 0) {
      spriteFile.setLastModified(lastModified);
    }
  }
  FileUtil.write(spritePropertiesFile,PropertiesUtil.toString(spriteProperties));
  if (lastModified > 0) {
    spritePropertiesFile.setLastModified(lastModified);
  }
  return spriteProperties;
}
