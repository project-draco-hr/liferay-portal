{
  ActionableDynamicQuery actionableDynamicQuery=DLFileVersionLocalServiceUtil.getActionableDynamicQuery();
  actionableDynamicQuery.setAddCriteriaMethod(new ActionableDynamicQuery.AddCriteriaMethod(){
    @Override public void addCriteria(    DynamicQuery dynamicQuery){
      Criterion originalMimeTypeCriterion=RestrictionsFactoryUtil.eq("mimeType",originalMimeTypes[0]);
      for (int i=1; i < originalMimeTypes.length; i++) {
        originalMimeTypeCriterion=RestrictionsFactoryUtil.or(originalMimeTypeCriterion,RestrictionsFactoryUtil.eq("mimeType",originalMimeTypes[i]));
      }
      dynamicQuery.add(originalMimeTypeCriterion);
    }
  }
);
  if (_log.isDebugEnabled()) {
    long count=actionableDynamicQuery.performCount();
    _log.debug("Processing " + count + " documents for mime types: "+ StringUtil.merge(originalMimeTypes,StringPool.COMMA));
  }
  actionableDynamicQuery.setPerformActionMethod(new ActionableDynamicQuery.PerformActionMethod(){
    @Override public void performAction(    Object object){
      DLFileVersion dlFileVersion=(DLFileVersion)object;
      InputStream inputStream=null;
      try {
        inputStream=DLFileEntryLocalServiceUtil.getFileAsStream(dlFileVersion.getFileEntryId(),dlFileVersion.getVersion(),false);
      }
 catch (      Exception e) {
        if (_log.isWarnEnabled()) {
          DLFileEntry dlFileEntry=DLFileEntryLocalServiceUtil.fetchDLFileEntry(dlFileVersion.getFileEntryId());
          if (dlFileEntry == null) {
            _log.warn("Unable to find file entry associated " + "with file version " + dlFileVersion.getFileVersionId(),e);
          }
 else {
            StringBundler sb=new StringBundler(4);
            sb.append("Unable to find file version ");
            sb.append(dlFileVersion.getVersion());
            sb.append(" for file entry ");
            sb.append(dlFileEntry.getName());
            _log.warn(sb.toString(),e);
          }
        }
        return;
      }
      String title=DLUtil.getTitleWithExtension(dlFileVersion.getTitle(),dlFileVersion.getExtension());
      String mimeType=getMimeType(inputStream,title);
      String originalMimeType=dlFileVersion.getMimeType();
      if (mimeType.equals(originalMimeType)) {
        return;
      }
      dlFileVersion.setMimeType(mimeType);
      DLFileVersionLocalServiceUtil.updateDLFileVersion(dlFileVersion);
      try {
        DLFileEntry dlFileEntry=dlFileVersion.getFileEntry();
        if (dlFileEntry.getVersion().equals(dlFileVersion.getVersion())) {
          dlFileEntry.setMimeType(mimeType);
          DLFileEntryLocalServiceUtil.updateDLFileEntry(dlFileEntry);
        }
      }
 catch (      PortalException e) {
        if (_log.isWarnEnabled()) {
          _log.warn("Unable to find file entry " + dlFileVersion.getFileEntryId(),e);
        }
      }
    }
  }
);
  actionableDynamicQuery.performActions();
}
