{
  boolean isThemePreview=_isThemePreview(request);
  if (isThemePreview) {
    request.setAttribute(_STRIP,false);
    StringServletResponse stringServerRes=new StringServletResponse(response);
    processFilter(ThemePreviewFilter.class,request,stringServerRes,filterChain);
    String s=stringServerRes.getString();
    ThemeDisplay themeDisplay=(ThemeDisplay)request.getAttribute(WebKeys.THEME_DISPLAY);
    Pattern cssPattern=Pattern.compile(themeDisplay.getPathThemeCss());
    Matcher cssMatcher=cssPattern.matcher(s);
    String cssOutput=cssMatcher.replaceAll(_CSS);
    Pattern imagePattern=Pattern.compile(themeDisplay.getPathThemeImages());
    Matcher imageMatcher=imagePattern.matcher(cssOutput);
    String imageOutput=imageMatcher.replaceAll(_IMAGES);
    ServletResponseUtil.write(response,imageOutput);
  }
 else {
    processFilter(ThemePreviewFilter.class,request,response,filterChain);
  }
}
