{
  try {
    JournalArticleDisplay articleDisplay=JournalContentUtil.getDisplay(groupId,articleId,null,languageId,themeDisplay);
    int pages=articleDisplay.getNumberOfPages();
    StringBundler sb=new StringBundler(pages + 12);
    sb.append("<html>");
    sb.append("<head>");
    sb.append("<meta content=\"");
    sb.append(ContentTypes.TEXT_HTML_UTF8);
    sb.append("\" http-equiv=\"content-type\" />");
    sb.append("<base href=\"");
    sb.append(themeDisplay.getPortalURL());
    sb.append("\" />");
    sb.append("</head>");
    sb.append("<body>");
    sb.append(articleDisplay.getContent());
    for (int i=2; i <= pages; i++) {
      articleDisplay=JournalContentUtil.getDisplay(groupId,articleId,"export",languageId,themeDisplay,i);
      sb.append(articleDisplay.getContent());
    }
    sb.append("</body>");
    sb.append("</html>");
    InputStream is=new UnsyncByteArrayInputStream(sb.toString().getBytes(StringPool.UTF8));
    String title=articleDisplay.getTitle();
    String sourceExtension="html";
    String fileName=title.concat(StringPool.PERIOD).concat(sourceExtension);
    if (Validator.isNotNull(targetExtension) && ArrayUtil.contains(allowedExtensions,targetExtension)) {
      String id=DocumentConversionUtil.getTempFileId(articleDisplay.getId(),articleDisplay.getVersion());
      InputStream convertedIS=DocumentConversionUtil.convert(id,is,sourceExtension,targetExtension);
      if ((convertedIS != null) && (convertedIS != is)) {
        fileName=title.concat(StringPool.PERIOD).concat(targetExtension);
        is=convertedIS;
      }
    }
    String contentType=MimeTypesUtil.getContentType(fileName);
    ServletResponseUtil.sendFile(response,fileName,is,contentType);
  }
 catch (  Exception e) {
    _log.error(e,e);
  }
}
