{
  List<LayoutTreeNode> layoutTreeNodes=new ArrayList<LayoutTreeNode>();
  List<Layout> layoutAncestors=_getLayoutAncestors(request);
  List<Layout> layouts=_getLayouts(request,groupId,privateLayout,parentLayoutId,incomplete);
  for (  Layout layout : layouts) {
    LayoutTreeNode layoutTreeNode=new LayoutTreeNode(layout);
    boolean isLayoutExpandable=_isLayoutExpandable(request,layoutAncestors,expandedLayoutIds,layout);
    if (isLayoutExpandable) {
      List<LayoutTreeNode> children=new ArrayList<LayoutTreeNode>();
      if (layout instanceof VirtualLayout) {
        VirtualLayout virtualLayout=(VirtualLayout)layout;
        children=_getLayoutTreeNodes(request,virtualLayout.getSourceGroupId(),virtualLayout.isPrivateLayout(),virtualLayout.getLayoutId(),incomplete,expandedLayoutIds);
      }
 else {
        children=_getLayoutTreeNodes(request,groupId,layout.isPrivateLayout(),layout.getLayoutId(),incomplete,expandedLayoutIds);
      }
      layoutTreeNode.setChildren(children);
    }
    layoutTreeNodes.add(layoutTreeNode);
  }
  return layoutTreeNodes;
}
