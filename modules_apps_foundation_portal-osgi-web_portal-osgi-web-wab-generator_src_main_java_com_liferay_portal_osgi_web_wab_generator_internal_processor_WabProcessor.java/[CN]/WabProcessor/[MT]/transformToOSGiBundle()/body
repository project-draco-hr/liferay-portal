{
  Analyzer analyzer=new Analyzer();
  analyzer.setBase(_pluginDir);
  analyzer.setJar(_pluginDir);
  analyzer.setProperty("-jsp","*.jsp,*.jspf");
  analyzer.setProperty("-plugin","com.liferay.ant.bnd.jsp.JspAnalyzerPlugin");
  analyzer.setProperty("Web-ContextPath",getWebContextPath());
  Set<Object> plugins=analyzer.getPlugins();
  plugins.add(_dsAnnotations);
  plugins.add(_metatypePlugin);
  plugins.add(_metatypeAnnotations);
  Properties pluginPackageProperties=getPluginPackageProperties();
  processBundleVersion(analyzer);
  processBundleClasspath(analyzer,pluginPackageProperties);
  processBundleSymbolicName(analyzer);
  processExtraHeaders(analyzer);
  processPluginPackagePropertiesExportImportPackages(pluginPackageProperties);
  processBundleManifestVersion(analyzer);
  processLiferayPortletXML();
  processWebXML("WEB-INF/web.xml");
  processWebXML("WEB-INF/liferay-web.xml");
  processDeclarativeReferences();
  processExtraRequirements();
  processPackageNames(analyzer);
  processRequiredDeploymentContexts(analyzer);
  processExcludedJSPs(analyzer);
  analyzer.setProperties(pluginPackageProperties);
  try {
    writeManifest(analyzer.calcManifest());
    copyOSGI_INFToWab(analyzer);
  }
 catch (  Exception e) {
    throw new IOException("Unable to calculate the manifest",e);
  }
 finally {
    analyzer.close();
  }
}
