{
  MBTopic topic=MBTopicUtil.findByPrimaryKey(message.getTopicId());
  if (userId != null) {
    MBMessageFlagPK flagPK=new MBMessageFlagPK(message.getTopicId(),message.getMessageId(),userId);
    try {
      MBMessageFlagUtil.findByPrimaryKey(flagPK);
    }
 catch (    NoSuchMessageFlagException nsmfe) {
      MBMessageFlag messageFlag=MBMessageFlagUtil.create(flagPK);
      messageFlag.setFlag(MBMessageFlag.READ_FLAG);
      MBMessageFlagUtil.update(messageFlag);
    }
  }
  MBMessage parentMessage=null;
  if (message.isReply()) {
    parentMessage=MBMessageUtil.findByPrimaryKey(new MBMessagePK(message.getTopicId(),message.getParentMessageId()));
  }
  MBThread thread=MBThreadUtil.findByPrimaryKey(message.getThreadId());
  TreeWalker treeWalker=new TreeWalker(message);
  ThreadLastPostDateComparator comparator=new ThreadLastPostDateComparator(false);
  MBThread[] prevAndNextThreads=MBThreadUtil.findByTopicId_PrevAndNext(message.getThreadId(),message.getTopicId(),comparator);
  MBThread previousThread=prevAndNextThreads[0];
  MBThread nextThread=prevAndNextThreads[2];
  MBThread firstThread=null;
  try {
    firstThread=MBThreadUtil.findByTopicId_First(message.getTopicId(),comparator);
  }
 catch (  NoSuchThreadException nste) {
  }
  MBThread lastThread=null;
  try {
    lastThread=MBThreadUtil.findByTopicId_Last(message.getTopicId(),comparator);
  }
 catch (  NoSuchThreadException nste) {
  }
  return new MBMessageDisplay(topic,message,parentMessage,thread,treeWalker,previousThread,nextThread,firstThread,lastThread);
}
