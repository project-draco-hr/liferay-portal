{
  try {
    if (prefs == null) {
      return;
    }
 else     if (!update && MBUtil.getEmailMessageAddedEnabled(prefs)) {
    }
 else     if (update && MBUtil.getEmailMessageUpdatedEnabled(prefs)) {
    }
 else {
      return;
    }
    Company company=CompanyUtil.findByPrimaryKey(message.getCompanyId());
    User user=UserUtil.findByPrimaryKey(message.getUserId());
    List categoryIds=new ArrayList();
    MBCategoryLocalServiceUtil.getSubcategoryIds(categoryIds,category.getGroupId(),category.getCategoryId());
    categoryIds.add(category.getCategoryId());
    String portletName=PortalUtil.getPortletTitle(PortletKeys.MESSAGE_BOARDS,user);
    String fromName=MBUtil.getEmailFromName(prefs);
    String fromAddress=MBUtil.getEmailFromAddress(prefs);
    String subject=null;
    String body=null;
    if (update) {
      subject=MBUtil.getEmailMessageUpdatedSubject(prefs);
      body=MBUtil.getEmailMessageUpdatedBody(prefs);
    }
 else {
      subject=MBUtil.getEmailMessageAddedSubject(prefs);
      body=MBUtil.getEmailMessageAddedBody(prefs);
    }
    subject=StringUtil.replace(subject,new String[]{"[$FROM_ADDRESS$]","[$FROM_NAME$]","[$MESSAGE_BODY$]","[$MESSAGE_SUBJECT$]","[$MESSAGE_USER_NAME$]","[$PORTAL_URL$]","[$PORTLET_NAME$]"},new String[]{fromAddress,fromName,message.getBody(),message.getSubject(),user.getFullName(),company.getPortalURL(),portletName});
    body=StringUtil.replace(body,new String[]{"[$FROM_ADDRESS$]","[$FROM_NAME$]","[$MESSAGE_BODY$]","[$MESSAGE_SUBJECT$]","[$MESSAGE_USER_NAME$]","[$PORTAL_URL$]","[$PORTLET_NAME$]"},new String[]{fromAddress,fromName,message.getBody(),message.getSubject(),user.getFullName(),company.getPortalURL(),portletName});
    MBMessageProducer.produce(new String[]{message.getCompanyId(),message.getUserId(),StringUtil.merge(categoryIds),message.getThreadId(),fromName,fromAddress,subject,body});
  }
 catch (  IOException ioe) {
    throw new SystemException(ioe);
  }
}
