{
  try {
    if (prefs == null) {
      return;
    }
 else     if (!update && MBUtil.getEmailMessageAddedEnabled(prefs)) {
    }
 else     if (update && MBUtil.getEmailMessageUpdatedEnabled(prefs)) {
    }
 else {
      return;
    }
    Company company=CompanyUtil.findByPrimaryKey(message.getCompanyId());
    User user=UserUtil.findByPrimaryKey(message.getUserId());
    List categoryIds=new ArrayList();
    MBCategoryLocalServiceUtil.getSubcategoryIds(categoryIds,category.getGroupId(),category.getCategoryId());
    categoryIds.add(category.getCategoryId());
    String portletName=PortalUtil.getPortletTitle(PortletKeys.MESSAGE_BOARDS,user);
    String fromName=MBUtil.getEmailFromName(prefs);
    String fromAddress=MBUtil.getEmailFromAddress(prefs);
    String mailingListAddress=MBUtil.getMailingListAddress(message.getCategoryId(),company.getCompanyId());
    String replyToAddress=mailingListAddress;
    String messageId=MBUtil.getMailId(message.getMessageId(),company.getCompanyId());
    fromName=StringUtil.replace(fromName,new String[]{"[$COMPANY_ID$]","[$MAILING_LIST_ADDRESS$]","[$MESSAGE_USER_ADDRESS$]","[$MESSAGE_USER_NAME$]","[$PORTLET_NAME$]"},new String[]{company.getCompanyId(),mailingListAddress,user.getEmailAddress(),user.getFullName(),portletName});
    fromAddress=StringUtil.replace(fromAddress,new String[]{"[$COMPANY_ID$]","[$MAILING_LIST_ADDRESS$]","[$MESSAGE_USER_ADDRESS$]","[$MESSAGE_USER_NAME$]","[$PORTLET_NAME$]"},new String[]{company.getCompanyId(),mailingListAddress,user.getEmailAddress(),user.getFullName(),portletName});
    String subject=null;
    String body=null;
    String inReplyTo=null;
    if (update) {
      subject=MBUtil.getEmailMessageUpdatedSubject(prefs);
      body=MBUtil.getEmailMessageUpdatedBody(prefs);
      inReplyTo=MBUtil.getMailId(message.getParentMessageId(),company.getCompanyId());
    }
 else {
      subject=MBUtil.getEmailMessageAddedSubject(prefs);
      body=MBUtil.getEmailMessageAddedBody(prefs);
    }
    subject=StringUtil.replace(subject,new String[]{"[$CATEGORY_NAME$]","[$COMPANY_ID$]","[$FROM_ADDRESS$]","[$FROM_NAME$]","[$MAILING_LIST_ADDRESS$]","[$MESSAGE_BODY$]","[$MESSAGE_SUBJECT$]","[$MESSAGE_USER_ADDRESS$]","[$MESSAGE_USER_NAME$]","[$PORTAL_URL$]","[$PORTLET_NAME$]"},new String[]{category.getName(),company.getCompanyId(),fromAddress,fromName,mailingListAddress,message.getBody(),message.getSubject(),user.getEmailAddress(),user.getFullName(),company.getPortalURL(),portletName});
    body=StringUtil.replace(body,new String[]{"[$CATEGORY_NAME$]","[$COMPANY_ID$]","[$FROM_ADDRESS$]","[$FROM_NAME$]","[$MAILING_LIST_ADDRESS$]","[$MESSAGE_BODY$]","[$MESSAGE_SUBJECT$]","[$MESSAGE_USER_ADDRESS$]","[$MESSAGE_USER_NAME$]","[$PORTAL_URL$]","[$PORTLET_NAME$]"},new String[]{category.getName(),company.getCompanyId(),fromAddress,fromName,mailingListAddress,message.getBody(),message.getSubject(),user.getEmailAddress(),user.getFullName(),company.getPortalURL(),portletName});
    MBMessageProducer.produce(new String[]{message.getCompanyId(),message.getUserId(),StringUtil.merge(categoryIds),message.getThreadId(),fromName,fromAddress,subject,body,replyToAddress,messageId,inReplyTo});
  }
 catch (  IOException ioe) {
    throw new SystemException(ioe);
  }
}
