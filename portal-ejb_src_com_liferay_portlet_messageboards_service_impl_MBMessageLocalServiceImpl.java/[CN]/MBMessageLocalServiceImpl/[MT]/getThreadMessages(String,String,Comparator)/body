{
  List messages=MBMessageUtil.findByThreadId(threadId);
  if (userId != null) {
    Iterator itr=messages.iterator();
    while (itr.hasNext()) {
      MBMessage message=(MBMessage)itr.next();
      MBMessageFlagPK flagPK=new MBMessageFlagPK(message.getTopicId(),message.getMessageId(),userId);
      try {
        MBMessageFlagUtil.findByPrimaryKey(flagPK);
      }
 catch (      NoSuchMessageFlagException nsmfe) {
        MBMessageFlag messageFlag=MBMessageFlagUtil.create(flagPK);
        messageFlag.setFlag(MBMessageFlag.READ_FLAG);
        MBMessageFlagUtil.update(messageFlag);
      }
    }
  }
  Collections.sort(messages,comparator);
  return messages;
}
