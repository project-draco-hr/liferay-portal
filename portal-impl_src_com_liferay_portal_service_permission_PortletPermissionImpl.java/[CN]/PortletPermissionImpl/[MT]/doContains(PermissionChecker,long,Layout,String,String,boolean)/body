{
  String name=null;
  String primKey=null;
  if (layout == null) {
    name=portletId;
    primKey=portletId;
  }
 else {
    Group group=null;
    if ((groupId > 0) && layout.isTypeControlPanel() && Validator.equals(portletId,PortletKeys.SITES_ADMIN)) {
      group=GroupLocalServiceUtil.getGroup(groupId);
    }
 else {
      group=layout.getGroup();
      groupId=group.getGroupId();
    }
    name=PortletConstants.getRootPortletId(portletId);
    primKey=getPrimaryKey(layout.getPlid(),portletId);
    if (!actionId.equals(ActionKeys.VIEW) && (layout instanceof VirtualLayout)) {
      return hasCustomizePermission(permissionChecker,layout,portletId,actionId);
    }
    if (!group.isLayoutSetPrototype() && !SitesUtil.isLayoutUpdateable(layout) && actionId.equals(ActionKeys.CONFIGURATION)) {
      return false;
    }
    Boolean hasPermission=StagingPermissionUtil.hasPermission(permissionChecker,groupId,name,groupId,name,actionId);
    if (hasPermission != null) {
      return hasPermission.booleanValue();
    }
    if (strict) {
      return permissionChecker.hasPermission(groupId,name,primKey,actionId);
    }
    if (hasConfigurePermission(permissionChecker,layout,portletId,actionId) || hasCustomizePermission(permissionChecker,layout,portletId,actionId)) {
      return true;
    }
  }
  return permissionChecker.hasPermission(groupId,name,primKey,actionId);
}
