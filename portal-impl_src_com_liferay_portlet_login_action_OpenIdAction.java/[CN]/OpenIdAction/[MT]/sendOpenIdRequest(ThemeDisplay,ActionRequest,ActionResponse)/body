{
  HttpServletRequest request=PortalUtil.getHttpServletRequest(actionRequest);
  HttpServletResponse response=PortalUtil.getHttpServletResponse(actionResponse);
  HttpSession session=request.getSession();
  ActionResponseImpl actionResponseImpl=(ActionResponseImpl)actionResponse;
  String openId=ParamUtil.getString(actionRequest,"openId");
  PortletURL portletURL=actionResponseImpl.createActionURL();
  portletURL.setParameter("struts_action","/login/open_id");
  portletURL.setParameter(Constants.CMD,Constants.READ);
  portletURL.setParameter("saveLastPath","0");
  ConsumerManager manager=OpenIdUtil.getConsumerManager();
  List<DiscoveryInformation> discoveries=manager.discover(openId);
  DiscoveryInformation discovered=manager.associate(discoveries);
  session.setAttribute(WebKeys.OPEN_ID_DISCO,discovered);
  AuthRequest authRequest=manager.authenticate(discovered,portletURL.toString(),themeDisplay.getPortalURL());
  try {
    UserLocalServiceUtil.getUserByOpenId(themeDisplay.getCompanyId(),openId);
  }
 catch (  NoSuchUserException nsue) {
    String screenName=OpenIdUtil.getScreenName(openId);
    try {
      User user=UserLocalServiceUtil.getUserByScreenName(themeDisplay.getCompanyId(),screenName);
      UserLocalServiceUtil.updateOpenId(user.getUserId(),openId);
    }
 catch (    NoSuchUserException nsue2) {
      FetchRequest fetch=FetchRequest.createFetchRequest();
      URL endpoint=discovered.getOPEndpoint();
      String openIdProvider=getOpenIdProvider(endpoint);
      String[] openIdAXTypes=PropsUtil.getArray(PropsKeys.OPEN_ID_AX_SCHEMA,new Filter(openIdProvider));
      for (      String openIdAXType : openIdAXTypes) {
        fetch.addAttribute(openIdAXType,PropsUtil.get(_OPEN_ID_AX_TYPE.concat(openIdAXType),new Filter(openIdProvider)),true);
      }
      authRequest.addExtension(fetch);
      SRegRequest sregRequest=SRegRequest.createFetchRequest();
      sregRequest.addAttribute(_OPEN_ID_SREG_ATTR_FULLNAME,true);
      sregRequest.addAttribute(_OPEN_ID_SREG_ATTR_EMAIL,true);
      authRequest.addExtension(sregRequest);
    }
  }
  response.sendRedirect(authRequest.getDestinationUrl(true));
}
