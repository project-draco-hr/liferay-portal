{
  if (getRemoteUser() == null) {
    return null;
  }
  LinkedHashMap<String,String> userInfo=new LinkedHashMap<String,String>();
  PortletApp portletApp=_portlet.getPortletApp();
  try {
    User user=PortalUtil.getUser(_req);
    UserAttributes userAttributes=new UserAttributes(user);
    userInfo.put(UserAttributes.LIFERAY_COMPANY_ID,userAttributes.getValue(UserAttributes.LIFERAY_COMPANY_ID));
    userInfo.put(UserAttributes.LIFERAY_USER_ID,userAttributes.getValue(UserAttributes.LIFERAY_USER_ID));
    for (    String attrName : portletApp.getUserAttributes()) {
      String attrValue=userAttributes.getValue(attrName);
      if (attrValue != null) {
        userInfo.put(attrName,attrValue);
      }
    }
  }
 catch (  Exception e) {
    _log.error(e,e);
  }
  Map<String,String> unmodifiableUserInfo=Collections.unmodifiableMap((Map<String,String>)userInfo.clone());
  Map<String,CustomUserAttributes> cuaInstances=new HashMap<String,CustomUserAttributes>();
  for (  Map.Entry<String,String> entry : portletApp.getCustomUserAttributes().entrySet()) {
    String attrName=entry.getKey();
    String attrCustomClass=entry.getValue();
    CustomUserAttributes cua=cuaInstances.get(attrCustomClass);
    if (cua == null) {
      if (portletApp.isWARFile()) {
        PortletContextBag portletContextBag=PortletContextBagPool.get(portletApp.getServletContextName());
        cua=portletContextBag.getCustomUserAttributes().get(attrCustomClass);
        cua=(CustomUserAttributes)cua.clone();
      }
 else {
        try {
          cua=(CustomUserAttributes)Class.forName(attrCustomClass).newInstance();
        }
 catch (        Exception e) {
          _log.error(e,e);
        }
      }
      cuaInstances.put(attrCustomClass,cua);
    }
    if (cua != null) {
      String attrValue=cua.getValue(attrName,unmodifiableUserInfo);
      if (attrValue != null) {
        userInfo.put(attrName,attrValue);
      }
    }
  }
  return userInfo;
}
