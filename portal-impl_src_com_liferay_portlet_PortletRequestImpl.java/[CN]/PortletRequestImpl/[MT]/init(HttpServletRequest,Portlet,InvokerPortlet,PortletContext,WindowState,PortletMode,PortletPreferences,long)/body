{
  ThemeDisplay themeDisplay=(ThemeDisplay)request.getAttribute(WebKeys.THEME_DISPLAY);
  _portlet=portlet;
  _portletName=portlet.getPortletId();
  String portletNamespace=PortalUtil.getPortletNamespace(_portletName);
  Map<String,Object> sharedSessionAttributes=SharedSessionUtil.getSharedSessionAttributes(request);
  boolean portalSessionShared=false;
  PortletApp portletApp=portlet.getPortletApp();
  if (portletApp.isWARFile() && !portlet.isPrivateSessionAttributes()) {
    portalSessionShared=true;
  }
  request=new SharedSessionServletRequest(request,sharedSessionAttributes,portalSessionShared,PropsValues.SESSION_SHARED_ATTRIBUTES_REQUIRE_SERIALIZABLE);
  DynamicServletRequest dynamicRequest=null;
  if (portlet.isPrivateRequestAttributes()) {
    dynamicRequest=new NamespaceServletRequest(request,portletNamespace,portletNamespace,false);
  }
 else {
    dynamicRequest=new DynamicServletRequest(request,false);
  }
  Enumeration<String> enu=null;
  boolean portletFocus=false;
  String ppid=ParamUtil.getString(request,"p_p_id");
  if (_portletName.equals(ppid)) {
    if (themeDisplay.isLifecycleRender() || themeDisplay.isLifecycleResource()) {
      portletFocus=true;
    }
 else     if (themeDisplay.isLifecycleAction() && getLifecycle().equals(PortletRequest.ACTION_PHASE)) {
      portletFocus=true;
    }
  }
  Map<String,String[]> oldRenderParameters=RenderParametersPool.get(request,plid,_portletName);
  Map<String,String[]> newRenderParameters=null;
  if (portletFocus) {
    newRenderParameters=new HashMap<String,String[]>();
    if (getLifecycle().equals(PortletRequest.RENDER_PHASE) && !LiferayWindowState.isExclusive(request) && !LiferayWindowState.isPopUp(request)) {
      RenderParametersPool.put(request,plid,_portletName,newRenderParameters);
    }
    enu=request.getParameterNames();
  }
 else {
    if (!_portletName.equals(ppid)) {
      putPublicRenderParameters(request,preferences,plid,ppid,oldRenderParameters);
    }
    enu=Collections.enumeration(oldRenderParameters.keySet());
  }
  while (enu.hasMoreElements()) {
    String name=enu.nextElement();
    if (name.startsWith(portletNamespace) && !invokerPortlet.isFacesPortlet()) {
      String shortName=name.substring(portletNamespace.length());
      ObjectValuePair<String,String[]> ovp=getParameterValues(request,themeDisplay,portletFocus,oldRenderParameters,newRenderParameters,name);
      dynamicRequest.setParameterValues(shortName,ovp.getValue());
    }
 else {
      if (!PortalUtil.isReservedParameter(name) && Validator.isNotNull(name)) {
        ObjectValuePair<String,String[]> ovp=getParameterValues(request,themeDisplay,portletFocus,oldRenderParameters,newRenderParameters,name);
        dynamicRequest.setParameterValues(ovp.getKey(),ovp.getValue());
      }
    }
  }
  _request=dynamicRequest;
  _originalRequest=request;
  _wapTheme=BrowserSnifferUtil.isWap(_request);
  _portlet=portlet;
  _portalContext=new PortalContextImpl();
  _portletContext=portletContext;
  _windowState=windowState;
  _portletMode=portletMode;
  _preferences=preferences;
  _portalSessionId=_request.getRequestedSessionId();
  _session=new PortletSessionImpl(_request,_portletName,_portletContext,_portalSessionId,plid);
  long userId=PortalUtil.getUserId(request);
  String remoteUser=request.getRemoteUser();
  String userPrincipalStrategy=portlet.getUserPrincipalStrategy();
  if (userPrincipalStrategy.equals(PortletConstants.USER_PRINCIPAL_STRATEGY_SCREEN_NAME)) {
    try {
      User user=PortalUtil.getUser(request);
      _remoteUser=user.getScreenName();
      _remoteUserId=user.getUserId();
      _userPrincipal=new ProtectedPrincipal(_remoteUser);
    }
 catch (    Exception e) {
      _log.error(e);
    }
  }
 else {
    if ((userId > 0) && (remoteUser == null)) {
      _remoteUser=String.valueOf(userId);
      _remoteUserId=userId;
      _userPrincipal=new ProtectedPrincipal(_remoteUser);
    }
 else {
      _remoteUser=remoteUser;
      _remoteUserId=GetterUtil.getLong(remoteUser);
      _userPrincipal=request.getUserPrincipal();
    }
  }
  _locale=themeDisplay.getLocale();
  _plid=plid;
}
