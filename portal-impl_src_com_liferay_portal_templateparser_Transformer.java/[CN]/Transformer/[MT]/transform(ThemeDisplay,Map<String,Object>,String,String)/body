{
  if (Validator.isNull(langType)) {
    return null;
  }
  long companyId=0;
  long companyGroupId=0;
  long scopeGroupId=0;
  long siteGroupId=0;
  long classNameId=0;
  if (themeDisplay != null) {
    companyId=themeDisplay.getCompanyId();
    companyGroupId=themeDisplay.getCompanyGroupId();
    scopeGroupId=themeDisplay.getScopeGroupId();
    siteGroupId=themeDisplay.getSiteGroupId();
  }
  String templateId=String.valueOf(contextObjects.get("template_id"));
  templateId=getTemplateId(templateId,companyId,companyGroupId,scopeGroupId);
  Template template=getTemplate(templateId,script,langType);
  UnsyncStringWriter unsyncStringWriter=new UnsyncStringWriter();
  try {
    prepareTemplate(themeDisplay,template);
    if (contextObjects != null) {
      for (      String key : contextObjects.keySet()) {
        template.put(key,contextObjects.get(key));
      }
      classNameId=GetterUtil.getLong(contextObjects.get(TemplateConstants.TEMPLATE_CLASS_NAME_ID));
    }
    template.put("company",getCompany(themeDisplay,companyId));
    template.put("companyId",companyId);
    template.put("device",getDevice(themeDisplay));
    String templatesPath=getTemplatesPath(companyId,scopeGroupId,classNameId);
    template.put("permissionChecker",PermissionThreadLocal.getPermissionChecker());
    template.put("randomNamespace",StringUtil.randomId() + StringPool.UNDERLINE);
    template.put("scopeGroupId",scopeGroupId);
    template.put("siteGroupId",siteGroupId);
    template.put("templatesPath",templatesPath);
    template.put("groupId",scopeGroupId);
    template.put("journalTemplatesPath",templatesPath);
    mergeTemplate(template,unsyncStringWriter,false);
  }
 catch (  Exception e) {
    throw new TransformException("Unhandled exception",e);
  }
  return unsyncStringWriter.toString();
}
