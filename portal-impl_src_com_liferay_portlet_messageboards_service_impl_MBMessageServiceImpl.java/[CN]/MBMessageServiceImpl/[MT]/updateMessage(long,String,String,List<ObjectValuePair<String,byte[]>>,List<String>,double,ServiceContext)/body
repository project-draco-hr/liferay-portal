{
  MBMessage message=mbMessageLocalService.getMessage(messageId);
  MBMessagePermission.check(getPermissionChecker(),messageId,ActionKeys.UPDATE);
  if (lockLocalService.isLocked(MBThread.class.getName(),message.getThreadId())) {
    throw new LockedThreadException();
  }
  if (!MBCategoryPermission.contains(getPermissionChecker(),message.getGroupId(),message.getCategoryId(),ActionKeys.ADD_FILE)) {
    files.clear();
  }
  if (!MBCategoryPermission.contains(getPermissionChecker(),message.getGroupId(),message.getCategoryId(),ActionKeys.UPDATE_THREAD_PRIORITY)) {
    MBThread thread=mbThreadLocalService.getThread(message.getThreadId());
    priority=thread.getPriority();
  }
  return mbMessageLocalService.updateMessage(getUserId(),messageId,subject,body,files,existingFiles,priority,serviceContext);
}
