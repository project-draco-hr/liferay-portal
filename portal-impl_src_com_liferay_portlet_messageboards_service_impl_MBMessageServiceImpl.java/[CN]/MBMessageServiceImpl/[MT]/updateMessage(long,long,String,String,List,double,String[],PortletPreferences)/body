{
  MBMessagePermission.check(getPermissionChecker(),messageId,ActionKeys.UPDATE);
  if (!MBCategoryPermission.contains(getPermissionChecker(),categoryId,ActionKeys.ADD_FILE)) {
    files.clear();
  }
  if (!MBCategoryPermission.contains(getPermissionChecker(),categoryId,ActionKeys.UPDATE_THREAD_PRIORITY)) {
    MBMessage message=MBMessageLocalServiceUtil.getMessage(messageId);
    MBThread thread=MBThreadLocalServiceUtil.getThread(message.getThreadId());
    priority=thread.getPriority();
  }
  return MBMessageLocalServiceUtil.updateMessage(getUserId(),messageId,categoryId,subject,body,files,priority,tagsEntries,prefs);
}
