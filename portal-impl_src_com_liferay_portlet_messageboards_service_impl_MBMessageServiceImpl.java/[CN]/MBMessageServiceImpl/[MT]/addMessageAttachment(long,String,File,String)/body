{
  MBMessage message=mbMessageLocalService.getMBMessage(messageId);
  if (LockManagerUtil.isLocked(MBThread.class.getName(),message.getThreadId())) {
    StringBundler sb=new StringBundler(5);
    sb.append("Thread is locked for {className=");
    sb.append(MBThread.class.getName());
    sb.append(", threadId=");
    sb.append(message.getThreadId());
    sb.append(StringPool.CLOSE_CURLY_BRACE);
    throw new LockedThreadException(sb.toString());
  }
  MBCategoryPermission.contains(getPermissionChecker(),message.getGroupId(),message.getCategoryId(),ActionKeys.ADD_FILE);
  mbMessageLocalService.addMessageAttachment(getUserId(),messageId,fileName,file,mimeType);
}
