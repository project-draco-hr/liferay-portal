{
  ThemeDisplay themeDisplay=(ThemeDisplay)portletRequest.getAttribute(WebKeys.THEME_DISPLAY);
  WikiNode node=null;
  int nodesCount=WikiNodeLocalServiceUtil.getNodesCount(themeDisplay.getScopeGroupId());
  if (nodesCount == 0) {
    String nodeName=PropsUtil.get(PropsKeys.WIKI_INITIAL_NODE_NAME);
    Layout layout=themeDisplay.getLayout();
    ServiceContext serviceContext=ServiceContextFactory.getInstance(WikiNode.class.getName(),portletRequest);
    serviceContext.setAddCommunityPermissions(true);
    if (layout.isPublicLayout()) {
      serviceContext.setAddGuestPermissions(true);
    }
 else {
      serviceContext.setAddGuestPermissions(false);
    }
    node=WikiNodeLocalServiceUtil.addNode(themeDisplay.getUserId(),nodeName,StringPool.BLANK,serviceContext);
  }
 else {
    List<WikiNode> nodes=WikiUtil.getNodes(portletRequest);
    if (nodes.size() == 0) {
      throw new PrincipalException();
    }
    node=nodes.get(0);
  }
  portletRequest.setAttribute(WebKeys.WIKI_NODE,node);
  return node;
}
