{
  ThemeDisplay themeDisplay=(ThemeDisplay)renderRequest.getAttribute(WebKeys.THEME_DISPLAY);
  WikiNode node=null;
  int nodesCount=WikiNodeLocalServiceUtil.getNodesCount(themeDisplay.getScopeGroupId());
  if (nodesCount == 0) {
    String nodeName=PropsUtil.get(PropsKeys.WIKI_INITIAL_NODE_NAME);
    ServiceContext serviceContext=ServiceContextFactory.getInstance(WikiNode.class.getName(),renderRequest);
    serviceContext.setAddCommunityPermissions(true);
    serviceContext.setAddGuestPermissions(true);
    node=WikiNodeLocalServiceUtil.addNode(themeDisplay.getUserId(),nodeName,StringPool.BLANK,serviceContext);
  }
 else {
    List<WikiNode> nodes=WikiUtil.getNodes(renderRequest);
    if (nodes.size() == 0) {
      throw new PrincipalException();
    }
    node=nodes.get(0);
  }
  renderRequest.setAttribute(WebKeys.WIKI_NODE,node);
  return node;
}
