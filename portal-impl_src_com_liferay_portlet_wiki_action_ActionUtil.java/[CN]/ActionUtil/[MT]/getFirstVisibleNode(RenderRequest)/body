{
  ThemeDisplay themeDisplay=(ThemeDisplay)renderRequest.getAttribute(WebKeys.THEME_DISPLAY);
  WikiNode node=null;
  List<WikiNode> nodes=WikiUtil.getNodes(renderRequest);
  if (nodes.size() == 0) {
    String nodeName=PropsUtil.get(PropsKeys.WIKI_INITIAL_NODE_NAME);
    ServiceContext serviceContext=ServiceContextFactory.getInstance(WikiNode.class.getName(),renderRequest);
    serviceContext.setAddCommunityPermissions(true);
    serviceContext.setAddGuestPermissions(true);
    node=WikiNodeLocalServiceUtil.addNode(themeDisplay.getUserId(),nodeName,StringPool.BLANK,serviceContext);
  }
 else {
    PermissionChecker permissionChecker=themeDisplay.getPermissionChecker();
    for (    WikiNode curNode : nodes) {
      if (WikiNodePermission.contains(permissionChecker,curNode.getNodeId(),ActionKeys.VIEW)) {
        node=curNode;
        break;
      }
    }
    if (node == null) {
      throw new PrincipalException();
    }
  }
  renderRequest.setAttribute(WebKeys.WIKI_NODE,node);
  return node;
}
