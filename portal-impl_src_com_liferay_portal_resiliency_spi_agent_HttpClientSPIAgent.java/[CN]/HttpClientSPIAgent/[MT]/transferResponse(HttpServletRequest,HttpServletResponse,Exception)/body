{
  request.removeAttribute(WebKeys.SPI_AGENT_REQUEST);
  AgentResponse agentResponse=(AgentResponse)request.getAttribute(WebKeys.SPI_AGENT_RESPONSE);
  request.removeAttribute(WebKeys.SPI_AGENT_RESPONSE);
  if (exception != null) {
    agentResponse.setException(exception);
  }
 else {
    BufferCacheServletResponse bufferCacheServletResponse=(BufferCacheServletResponse)response;
    agentResponse.captureResponse(request,bufferCacheServletResponse);
  }
  HttpServletResponse originalResponse=(HttpServletResponse)request.getAttribute(WebKeys.SPI_AGENT_ORIGINAL_RESPONSE);
  request.removeAttribute(WebKeys.SPI_AGENT_ORIGINAL_RESPONSE);
  originalResponse.setContentLength(8);
  agentResponse.writeTo(registrationReference,originalResponse.getOutputStream());
}
