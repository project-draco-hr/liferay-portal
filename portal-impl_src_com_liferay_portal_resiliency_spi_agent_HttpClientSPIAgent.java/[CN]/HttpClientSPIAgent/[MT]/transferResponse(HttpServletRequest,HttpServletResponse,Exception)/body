{
  SPIAgentRequest spiAgentRequest=(SPIAgentRequest)request.getAttribute(WebKeys.SPI_AGENT_REQUEST);
  request.removeAttribute(WebKeys.SPI_AGENT_REQUEST);
  File requestBodyFile=spiAgentRequest.requestBodyFile;
  if (requestBodyFile != null) {
    if (!requestBodyFile.delete()) {
      requestBodyFile.deleteOnExit();
    }
  }
  SPIAgentResponse spiAgentResponse=(SPIAgentResponse)request.getAttribute(WebKeys.SPI_AGENT_RESPONSE);
  request.removeAttribute(WebKeys.SPI_AGENT_RESPONSE);
  if (exception != null) {
    spiAgentResponse.setException(exception);
  }
 else {
    BufferCacheServletResponse bufferCacheServletResponse=(BufferCacheServletResponse)response;
    spiAgentResponse.captureResponse(request,bufferCacheServletResponse);
  }
  HttpServletResponse originalResponse=(HttpServletResponse)request.getAttribute(WebKeys.SPI_AGENT_ORIGINAL_RESPONSE);
  request.removeAttribute(WebKeys.SPI_AGENT_ORIGINAL_RESPONSE);
  originalResponse.setContentLength(8);
  spiAgentResponse.writeTo(registrationReference,originalResponse.getOutputStream());
}
