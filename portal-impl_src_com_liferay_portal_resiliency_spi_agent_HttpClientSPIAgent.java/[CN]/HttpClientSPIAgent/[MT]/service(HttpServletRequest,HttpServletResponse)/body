{
  Socket socket=null;
  try {
    socket=borrowSocket();
    SPIAgentRequest spiAgentRequest=new SPIAgentRequest(request);
    OutputStream outputStream=socket.getOutputStream();
    outputStream.write(httpServletRequestContent);
    spiAgentRequest.writeTo(registrationReference,outputStream);
    InputStream inputStream=socket.getInputStream();
    DataInputStream dataInputStream=new DataInputStream(inputStream);
    boolean forceCloseSocket=consumeHttpResponseHead(dataInputStream);
    SPIAgentResponse spiAgentResponse=SPIAgentResponse.readFrom(dataInputStream);
    spiAgentResponse.populate(request,response);
    returnSocket(socket,forceCloseSocket);
    socket=null;
  }
 catch (  IOException ioe) {
    throw new PortalResiliencyException(ioe);
  }
 finally {
    if (socket != null) {
      try {
        socket.close();
      }
 catch (      IOException ioe) {
        if (_log.isWarnEnabled()) {
          _log.warn(ioe,ioe);
        }
      }
    }
  }
}
