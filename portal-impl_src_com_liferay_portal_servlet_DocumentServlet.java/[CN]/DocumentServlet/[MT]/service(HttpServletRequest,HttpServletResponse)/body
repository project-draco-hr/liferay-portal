{
  try {
    long companyId=PortalUtil.getCompanyId(request);
    User user=PortalUtil.getUser(request);
    if (user == null) {
      Company company=CompanyLocalServiceUtil.getCompany(companyId);
      user=company.getDefaultUser();
    }
    PermissionChecker permissionChecker=null;
    PrincipalThreadLocal.setName(user.getUserId());
    permissionChecker=PermissionCheckerFactoryUtil.create(user,true);
    PermissionThreadLocal.setPermissionChecker(permissionChecker);
    String path=request.getPathInfo();
    if (path.startsWith(StringPool.SLASH)) {
      path=path.substring(1);
    }
    if (path.endsWith(StringPool.SLASH)) {
      path=path.substring(0,path.length() - 1);
    }
    String[] pathArray=StringUtil.split(path,StringPool.SLASH);
    if ((pathArray.length > 0) && (pathArray.length <= 3)) {
      sendFile(request,response,permissionChecker,pathArray);
    }
 else {
      throw new NoSuchFileEntryException();
    }
  }
 catch (  NoSuchFileEntryException nsfee) {
    PortalUtil.sendError(HttpServletResponse.SC_NOT_FOUND,nsfee,request,response);
  }
catch (  Exception e) {
    PortalUtil.sendError(e,request,response);
  }
}
