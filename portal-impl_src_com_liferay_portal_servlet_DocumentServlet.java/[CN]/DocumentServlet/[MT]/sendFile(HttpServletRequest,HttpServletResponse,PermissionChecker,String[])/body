{
  long groupId=0;
  long folderId=0;
  String name=null;
  String fileName=null;
  DLFileEntry fileEntry=null;
  if (pathArray.length == 1) {
    long fileShortcutId=GetterUtil.getLong(pathArray[0]);
    DLFileShortcut fileShortcut=DLFileShortcutServiceUtil.getFileShortcut(fileShortcutId);
    groupId=fileShortcut.getGroupId();
    folderId=fileShortcut.getToFolderId();
    name=fileShortcut.getToName();
    fileEntry=DLFileEntryLocalServiceUtil.getFileEntry(groupId,folderId,name);
    fileName=fileEntry.getTitle();
  }
 else   if (pathArray.length == 2) {
    groupId=GetterUtil.getLong(pathArray[0]);
    fileEntry=DLFileEntryLocalServiceUtil.getFileEntryByUuidAndGroupId(pathArray[1],groupId);
    folderId=fileEntry.getFolderId();
    fileName=fileEntry.getTitle();
    name=fileEntry.getName();
  }
 else {
    groupId=GetterUtil.getLong(pathArray[0]);
    folderId=GetterUtil.getLong(pathArray[1]);
    fileName=HttpUtil.decodeURL(pathArray[2],true);
    fileEntry=DLFileEntryServiceUtil.getFileEntryByTitle(groupId,folderId,fileName);
    name=fileEntry.getName();
  }
  if (fileEntry == null) {
    throw new NoSuchFileEntryException();
  }
  DLFileEntryPermission.check(permissionChecker,fileEntry,ActionKeys.VIEW);
  double version=ParamUtil.getDouble(request,"version");
  String targetExtension=ParamUtil.getString(request,"targetExtension");
  if (version == 0) {
    if (fileEntry.getVersion() > 0) {
      version=fileEntry.getVersion();
    }
 else {
      throw new NoSuchFileEntryException();
    }
  }
  InputStream is=DLFileEntryLocalServiceUtil.getFileAsStream(permissionChecker.getCompanyId(),permissionChecker.getUserId(),groupId,folderId,name,version);
  boolean converted=false;
  if (Validator.isNotNull(targetExtension)) {
    String id=DocumentConversionUtil.getTempFileId(fileEntry.getFileEntryId(),version);
    String sourceExtension=FileUtil.getExtension(fileName);
    InputStream convertedIS=DocumentConversionUtil.convert(id,is,sourceExtension,targetExtension);
    if ((convertedIS != null) && (convertedIS != is)) {
      StringBuilder sb=new StringBuilder();
      sb.append(FileUtil.stripExtension(fileName));
      sb.append(StringPool.PERIOD);
      sb.append(targetExtension);
      fileName=sb.toString();
      is=convertedIS;
      converted=true;
    }
  }
  int contentLength=0;
  if (!converted) {
    if (version >= fileEntry.getVersion()) {
      contentLength=fileEntry.getSize();
    }
 else {
      DLFileVersion fileVersion=DLFileVersionLocalServiceUtil.getFileVersion(groupId,folderId,name,version);
      contentLength=fileVersion.getSize();
    }
  }
  String contentType=MimeTypesUtil.getContentType(fileName);
  ServletResponseUtil.sendFile(response,fileName,is,contentLength,contentType);
}
