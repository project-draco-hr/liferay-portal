{
  ThemeDisplay themeDisplay=(ThemeDisplay)req.getAttribute(WebKeys.THEME_DISPLAY);
  if (resetMaxState) {
    Layout layout=themeDisplay.getLayout();
    LayoutTypePortlet layoutTypePortlet=null;
    if (layout.equals(this)) {
      layoutTypePortlet=themeDisplay.getLayoutTypePortlet();
    }
 else {
      layoutTypePortlet=(LayoutTypePortlet)getLayoutType();
    }
    if (layoutTypePortlet.hasStateMax()) {
      String portletId=StringUtil.split(layoutTypePortlet.getStateMax())[0];
      PortletURLImpl portletURLImpl=new PortletURLImpl(req,portletId,getPlid(),true);
      try {
        portletURLImpl.setWindowState(WindowState.NORMAL);
        portletURLImpl.setPortletMode(PortletMode.VIEW);
      }
 catch (      PortletException pe) {
        throw new SystemException(pe);
      }
      portletURLImpl.setAnchor(false);
      if (resetRenderParameters) {
        portletURLImpl.setParameter("p_l_reset","1");
      }
      return portletURLImpl.toString();
    }
  }
  return PortalUtil.getLayoutURL(this,themeDisplay);
}
