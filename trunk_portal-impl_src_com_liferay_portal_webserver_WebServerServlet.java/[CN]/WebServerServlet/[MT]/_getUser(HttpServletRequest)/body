{
  HttpSession session=request.getSession();
  if (PortalSessionThreadLocal.getHttpSession() == null) {
    PortalSessionThreadLocal.setHttpSession(session);
  }
  User user=PortalUtil.getUser(request);
  if (user != null) {
    return user;
  }
  String userIdString=(String)session.getAttribute("j_username");
  String password=(String)session.getAttribute("j_password");
  if ((userIdString != null) && (password != null)) {
    long userId=GetterUtil.getLong(userIdString);
    user=UserLocalServiceUtil.getUser(userId);
  }
 else {
    long companyId=PortalUtil.getCompanyId(request);
    Company company=CompanyLocalServiceUtil.getCompany(companyId);
    user=company.getDefaultUser();
  }
  return user;
}
