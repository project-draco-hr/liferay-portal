{
  requestTestPortlet=new RequestTestPortlet(map){
    @Override public void serveResource(    ResourceRequest resourceRequest,    ResourceResponse resourceResponse) throws IOException {
      PortletURL portletURL=resourceResponse.createActionURL();
      String queryString=HttpUtil.getQueryString(portletURL.toString());
      Map<String,String[]> parameterMap=HttpUtil.getParameterMap(queryString);
      String p_auth=MapUtil.getString(parameterMap,"p_auth");
      PrintWriter writer=resourceResponse.getWriter();
      writer.write(p_auth);
    }
  }
;
  setUpPortlet(requestTestPortlet,properties,PortletKeys.TEST_PORTLET);
  HttpServletRequest request=getHttpServletRequest();
  PortletURL portletURL=new PortletURLImpl(request,PortletKeys.TEST_PORTLET,layout.getPlid(),PortletRequest.RESOURCE_PHASE);
  Map<String,List<String>> responseMap=request(portletURL.toString());
  String p_auth=responseMap.get("responseBody").get(0);
  List<String> cookies=responseMap.get("Set-Cookie");
  map.clear();
  portletURL=new PortletURLImpl(request,PortletKeys.TEST_PORTLET,layout.getPlid(),PortletRequest.ACTION_PHASE);
  String url=portletURL.toString();
  url=HttpUtil.removeParameter(url,"p_auth");
  Map<String,List<String>> headers=new HashMap<>();
  headers.put("Cookie",cookies);
  headers.put("X-CSRF-Token",Collections.singletonList(p_auth));
  responseMap=request(url,headers);
  Assert.assertEquals("200",responseMap.get("responseCode").get(0));
  Assert.assertTrue(map.containsKey("processAction"));
}
