{
  ServiceContext serviceContext=new ServiceContext();
  ThemeDisplay themeDisplay=(ThemeDisplay)portletRequest.getAttribute(WebKeys.THEME_DISPLAY);
  serviceContext.setCompanyId(themeDisplay.getCompanyId());
  serviceContext.setLanguageId(themeDisplay.getLanguageId());
  serviceContext.setLayoutURL(PortalUtil.getLayoutURL(themeDisplay));
  serviceContext.setPathMain(PortalUtil.getPathMain());
  serviceContext.setPlid(themeDisplay.getPlid());
  serviceContext.setPortalURL(PortalUtil.getPortalURL(portletRequest));
  serviceContext.setScopeGroupId(themeDisplay.getScopeGroupId());
  serviceContext.setUserDisplayURL(themeDisplay.getUser().getDisplayURL(themeDisplay));
  serviceContext.setUserId(themeDisplay.getUserId());
  Map<String,Serializable> attributes=PortalUtil.getExpandoBridgeAttributes(new ExpandoBridgeImpl(className,0),portletRequest);
  serviceContext.setExpandoBridgeAttributes(attributes);
  boolean addCommunityPermissions=ParamUtil.getBoolean(portletRequest,"addCommunityPermissions");
  boolean addGuestPermissions=ParamUtil.getBoolean(portletRequest,"addGuestPermissions");
  String[] communityPermissions=portletRequest.getParameterValues("communityPermissions");
  String[] guestPermissions=portletRequest.getParameterValues("guestPermissions");
  boolean inputPermissionsPublic=ParamUtil.getBoolean(portletRequest,"inputPermissionsPublic");
  boolean inputPermissionsShowConfigure=ParamUtil.getBoolean(portletRequest,"inputPermissionsShowConfigure");
  if (!inputPermissionsShowConfigure) {
    if (!inputPermissionsPublic) {
      guestPermissions=new String[0];
      addGuestPermissions=false;
    }
 else     if ((guestPermissions == null) || (guestPermissions.length == 0)) {
      guestPermissions=new String[]{ActionKeys.VIEW};
    }
  }
  serviceContext.setAddCommunityPermissions(addCommunityPermissions);
  serviceContext.setAddGuestPermissions(addGuestPermissions);
  serviceContext.setCommunityPermissions(communityPermissions);
  serviceContext.setGuestPermissions(guestPermissions);
  HttpServletRequest request=PortalUtil.getHttpServletRequest(portletRequest);
  String portletId=PortalUtil.getPortletId(portletRequest);
  PortletPreferencesIds portletPreferencesIds=PortletPreferencesFactoryUtil.getPortletPreferencesIds(request,portletId);
  serviceContext.setPortletPreferencesIds(portletPreferencesIds);
  String[] tagsCategories=PortalUtil.getTagsCategories(portletRequest);
  String[] tagsEntries=PortalUtil.getTagsEntries(portletRequest);
  serviceContext.setTagsCategories(tagsCategories);
  serviceContext.setTagsEntries(tagsEntries);
  return serviceContext;
}
