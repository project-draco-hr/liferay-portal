{
  ThemeDisplay themeDisplay=(ThemeDisplay)request.getAttribute(WebKeys.THEME_DISPLAY);
  long ownerId=themeDisplay.getUserId();
  int ownerType=PortletKeys.PREFS_OWNER_TYPE_USER;
  long plid=PortletKeys.PREFS_PLID_SHARED;
  String portletId=PortletKeys.LIFERAY_PORTAL;
  PortalPreferences portalPrefs=null;
  if (themeDisplay.isSignedIn()) {
    PortletPreferencesImpl preferencesImpl=(PortletPreferencesImpl)PortletPreferencesLocalServiceUtil.getPreferences(themeDisplay.getCompanyId(),ownerId,ownerType,plid,portletId);
    portalPrefs=new PortalPreferencesImpl(preferencesImpl,themeDisplay.isSignedIn());
  }
 else {
    HttpSession session=request.getSession();
    portalPrefs=(PortalPreferences)session.getAttribute(WebKeys.PORTAL_PREFERENCES);
    if (portalPrefs == null) {
      PortletPreferencesImpl preferencesImpl=(PortletPreferencesImpl)PortletPreferencesLocalServiceUtil.getPreferences(themeDisplay.getCompanyId(),ownerId,ownerType,plid,portletId);
      preferencesImpl=(PortletPreferencesImpl)preferencesImpl.clone();
      portalPrefs=new PortalPreferencesImpl(preferencesImpl,themeDisplay.isSignedIn());
      session.setAttribute(WebKeys.PORTAL_PREFERENCES,portalPrefs);
    }
  }
  return portalPrefs;
}
