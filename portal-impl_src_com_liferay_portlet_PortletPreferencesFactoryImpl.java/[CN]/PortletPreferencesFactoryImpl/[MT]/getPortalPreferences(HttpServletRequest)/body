{
  ThemeDisplay themeDisplay=(ThemeDisplay)request.getAttribute(WebKeys.THEME_DISPLAY);
  long ownerId=themeDisplay.getUserId();
  int ownerType=PortletKeys.PREFS_OWNER_TYPE_USER;
  long plid=PortletKeys.PREFS_PLID_SHARED;
  String portletId=PortletKeys.LIFERAY_PORTAL;
  PortalPreferences portalPreferences=null;
  if (themeDisplay.isSignedIn()) {
    PortletPreferencesImpl portletPreferencesImpl=(PortletPreferencesImpl)PortletPreferencesLocalServiceUtil.getPreferences(themeDisplay.getCompanyId(),ownerId,ownerType,plid,portletId);
    portalPreferences=new PortalPreferencesImpl(portletPreferencesImpl,themeDisplay.isSignedIn());
  }
 else {
    HttpSession session=request.getSession();
    portalPreferences=(PortalPreferences)session.getAttribute(WebKeys.PORTAL_PREFERENCES);
    if (portalPreferences == null) {
      PortletPreferencesImpl portletPreferencesImpl=(PortletPreferencesImpl)PortletPreferencesLocalServiceUtil.getPreferences(themeDisplay.getCompanyId(),ownerId,ownerType,plid,portletId);
      portletPreferencesImpl=(PortletPreferencesImpl)portletPreferencesImpl.clone();
      portalPreferences=new PortalPreferencesImpl(portletPreferencesImpl,themeDisplay.isSignedIn());
      session.setAttribute(WebKeys.PORTAL_PREFERENCES,portalPreferences);
    }
  }
  return portalPreferences;
}
