{
  long ownerId=userId;
  int ownerType=PortletKeys.PREFS_OWNER_TYPE_USER;
  long plid=PortletKeys.PREFS_PLID_SHARED;
  String portletId=PortletKeys.LIFERAY_PORTAL;
  PortalPreferences portalPreferences=null;
  if (signedIn) {
    PortletPreferencesImpl portletPreferencesImpl=(PortletPreferencesImpl)PortletPreferencesLocalServiceUtil.getPreferences(companyId,ownerId,ownerType,plid,portletId);
    portalPreferences=new PortalPreferencesImpl(portletPreferencesImpl,signedIn);
  }
 else {
    if (session != null) {
      portalPreferences=(PortalPreferences)session.getAttribute(WebKeys.PORTAL_PREFERENCES);
    }
    if (portalPreferences == null) {
      PortletPreferencesImpl portletPreferencesImpl=(PortletPreferencesImpl)PortletPreferencesLocalServiceUtil.getPreferences(companyId,ownerId,ownerType,plid,portletId);
      portletPreferencesImpl=(PortletPreferencesImpl)portletPreferencesImpl.clone();
      portalPreferences=new PortalPreferencesImpl(portletPreferencesImpl,signedIn);
      if (session != null) {
        session.setAttribute(WebKeys.PORTAL_PREFERENCES,portalPreferences);
      }
    }
  }
  return portalPreferences;
}
