{
  long ownerId=userId;
  int ownerType=PortletKeys.PREFS_OWNER_TYPE_USER;
  PortalPreferences portalPreferences=null;
  if (signedIn) {
    PortalPreferencesWrapper portalPreferencesWrapper=(PortalPreferencesWrapper)PortalPreferencesLocalServiceUtil.getPreferences(companyId,ownerId,ownerType);
    portalPreferences=portalPreferencesWrapper.getPortalPreferencesImpl();
  }
 else {
    if (session != null) {
      portalPreferences=(PortalPreferences)session.getAttribute(WebKeys.PORTAL_PREFERENCES);
    }
    if (portalPreferences == null) {
      PortalPreferencesWrapper portalPreferencesWrapper=(PortalPreferencesWrapper)PortalPreferencesLocalServiceUtil.getPreferences(companyId,ownerId,ownerType);
      PortalPreferencesImpl portalPreferencesImpl=portalPreferencesWrapper.getPortalPreferencesImpl();
      portalPreferences=(PortalPreferences)portalPreferencesImpl.clone();
      if (session != null) {
        session.setAttribute(WebKeys.PORTAL_PREFERENCES,portalPreferences);
      }
    }
  }
  portalPreferences.setSignedIn(signedIn);
  portalPreferences.setUserId(userId);
  return portalPreferences;
}
