{
  String originalPortletId=portletId;
  Portlet portlet=PortletLocalServiceUtil.getPortletById(companyId,portletId);
  boolean uniquePerLayout=false;
  boolean uniquePerGroup=false;
  if (portlet.isPreferencesCompanyWide()) {
    portletId=PortletConstants.getRootPortletId(portletId);
  }
 else {
    if (portlet.isPreferencesUniquePerLayout()) {
      uniquePerLayout=true;
      if (portlet.isPreferencesOwnedByGroup()) {
        uniquePerGroup=true;
      }
    }
 else {
      if (portlet.isPreferencesOwnedByGroup()) {
        uniquePerGroup=true;
        portletId=PortletConstants.getRootPortletId(portletId);
      }
    }
  }
  long ownerId=PortletKeys.PREFS_OWNER_ID_DEFAULT;
  int ownerType=PortletKeys.PREFS_OWNER_TYPE_LAYOUT;
  Group group=GroupLocalServiceUtil.fetchGroup(siteGroupId);
  if ((group != null) && group.isLayout()) {
    plid=group.getClassPK();
  }
  if (PortletConstants.hasUserId(originalPortletId)) {
    ownerId=PortletConstants.getUserId(originalPortletId);
    ownerType=PortletKeys.PREFS_OWNER_TYPE_USER;
  }
 else   if (!uniquePerLayout) {
    plid=PortletKeys.PREFS_PLID_SHARED;
    if (uniquePerGroup) {
      if (siteGroupId > LayoutConstants.DEFAULT_PLID) {
        ownerId=siteGroupId;
      }
 else {
        ownerId=layoutGroupId;
      }
      ownerType=PortletKeys.PREFS_OWNER_TYPE_GROUP;
    }
 else {
      ownerId=companyId;
      ownerType=PortletKeys.PREFS_OWNER_TYPE_COMPANY;
    }
  }
  if (strictMode) {
    return PortletPreferencesLocalServiceUtil.getStrictPreferences(companyId,ownerId,ownerType,plid,portletId);
  }
  return PortletPreferencesLocalServiceUtil.getPreferences(companyId,ownerId,ownerType,plid,portletId,defaultPreferences);
}
