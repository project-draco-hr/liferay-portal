{
  PortletRequest portletRequest=(PortletRequest)request.getAttribute(JavaConstants.JAVAX_PORTLET_REQUEST);
  if (portletRequest instanceof ConfigurationPortletRequest) {
    PortletRequestWrapper portletRequestWrapper=(PortletRequestWrapper)portletRequest;
    return portletRequestWrapper.getPreferences();
  }
  ThemeDisplay themeDisplay=(ThemeDisplay)request.getAttribute(WebKeys.THEME_DISPLAY);
  PortletDisplay portletDisplay=themeDisplay.getPortletDisplay();
  if ((portletDisplay != null) && (portletDisplay.getPortletSetup() != null)) {
    return portletDisplay.getPortletSetup();
  }
  long scopeGroupId=PortalUtil.getScopeGroupId(request,portletId,true);
  return getPortletSetup(scopeGroupId,themeDisplay.getLayout(),portletId,defaultPreferences);
}
