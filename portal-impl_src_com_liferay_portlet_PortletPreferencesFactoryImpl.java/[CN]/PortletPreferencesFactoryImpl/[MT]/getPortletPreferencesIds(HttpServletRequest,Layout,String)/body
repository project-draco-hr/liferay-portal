{
  ThemeDisplay themeDisplay=(ThemeDisplay)request.getAttribute(WebKeys.THEME_DISPLAY);
  Layout layout=themeDisplay.getLayout();
  LayoutTypePortlet layoutTypePortlet=themeDisplay.getLayoutTypePortlet();
  PermissionChecker permissionChecker=PermissionThreadLocal.getPermissionChecker();
  Portlet portlet=PortletLocalServiceUtil.getPortletById(themeDisplay.getCompanyId(),portletId);
  long ownerId=0;
  int ownerType=0;
  long plid=0;
  boolean modeEditGuest=false;
  String portletMode=ParamUtil.getString(request,"p_p_mode");
  if (portletMode.equals(LiferayPortletMode.EDIT_GUEST.toString()) || layoutTypePortlet.hasModeEditGuestPortletId(portletId)) {
    modeEditGuest=true;
  }
  if (modeEditGuest) {
    boolean hasUpdateLayoutPermission=LayoutPermissionUtil.contains(permissionChecker,layout,ActionKeys.UPDATE);
    if (!layout.isPrivateLayout() && hasUpdateLayoutPermission) {
    }
 else {
      throw new PrincipalException();
    }
  }
  if (portlet.isPreferencesCompanyWide()) {
    ownerId=themeDisplay.getCompanyId();
    ownerType=PortletKeys.PREFS_OWNER_TYPE_COMPANY;
    plid=PortletKeys.PREFS_PLID_SHARED;
    portletId=PortletConstants.getRootPortletId(portletId);
  }
 else {
    if (portlet.isPreferencesUniquePerLayout()) {
      ownerId=PortletKeys.PREFS_OWNER_ID_DEFAULT;
      ownerType=PortletKeys.PREFS_OWNER_TYPE_LAYOUT;
      plid=selLayout.getPlid();
      if (portlet.isPreferencesOwnedByGroup()) {
      }
 else {
        long userId=PortalUtil.getUserId(request);
        if ((userId <= 0) || modeEditGuest) {
          userId=UserLocalServiceUtil.getDefaultUserId(themeDisplay.getCompanyId());
        }
        ownerId=userId;
        ownerType=PortletKeys.PREFS_OWNER_TYPE_USER;
      }
    }
 else {
      plid=PortletKeys.PREFS_PLID_SHARED;
      if (portlet.isPreferencesOwnedByGroup()) {
        ownerId=selLayout.getGroupId();
        ownerType=PortletKeys.PREFS_OWNER_TYPE_GROUP;
        portletId=PortletConstants.getRootPortletId(portletId);
      }
 else {
        long userId=PortalUtil.getUserId(request);
        if ((userId <= 0) || modeEditGuest) {
          userId=UserLocalServiceUtil.getDefaultUserId(themeDisplay.getCompanyId());
        }
        ownerId=userId;
        ownerType=PortletKeys.PREFS_OWNER_TYPE_USER;
      }
    }
  }
  return new PortletPreferencesIds(themeDisplay.getCompanyId(),ownerId,ownerType,plid,portletId);
}
