{
  Portlet portlet=PortletLocalServiceUtil.getPortletById(layout.getCompanyId(),portletId);
  if (portlet.isPreferencesCompanyWide()) {
    uniquePerLayout=false;
    uniquePerGroup=false;
    portletId=PortletImpl.getRootPortletId(portletId);
  }
 else {
    if (portlet.isPreferencesUniquePerLayout()) {
      uniquePerLayout=true;
      if (portlet.isPreferencesOwnedByGroup()) {
        uniquePerGroup=true;
      }
 else {
        uniquePerGroup=false;
      }
    }
 else {
      uniquePerLayout=false;
      if (portlet.isPreferencesOwnedByGroup()) {
        uniquePerGroup=true;
        portletId=PortletImpl.getRootPortletId(portletId);
      }
 else {
        uniquePerGroup=false;
      }
    }
  }
  long ownerId=PortletKeys.PREFS_OWNER_ID_DEFAULT;
  int ownerType=PortletKeys.PREFS_OWNER_TYPE_LAYOUT;
  long plid=layout.getPlid();
  if (!uniquePerLayout) {
    plid=PortletKeys.PREFS_PLID_SHARED;
    if (uniquePerGroup) {
      ownerId=layout.getGroupId();
      ownerType=PortletKeys.PREFS_OWNER_TYPE_GROUP;
    }
 else {
      ownerId=layout.getCompanyId();
      ownerType=PortletKeys.PREFS_OWNER_TYPE_COMPANY;
    }
  }
  return PortletPreferencesLocalServiceUtil.getPreferences(layout.getCompanyId(),ownerId,ownerType,plid,portletId,defaultPreferences);
}
