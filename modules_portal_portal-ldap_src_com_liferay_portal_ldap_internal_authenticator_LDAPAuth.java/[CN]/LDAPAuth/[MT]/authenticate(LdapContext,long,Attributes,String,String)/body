{
  LDAPAuthResult ldapAuthResult=null;
  LDAPAuthConfiguration ldapAuthConfiguration=_ldapAuthConfigurationProvider.getConfiguration(companyId);
  String authMethod=ldapAuthConfiguration.method();
  SystemLDAPConfiguration systemLDAPConfiguration=_systemLDAPConfigurationProvider.getConfiguration(companyId);
  if (authMethod.equals(AUTH_METHOD_BIND)) {
    Hashtable<String,Object> env=(Hashtable<String,Object>)ctx.getEnvironment();
    env.put(Context.SECURITY_PRINCIPAL,userDN);
    env.put(Context.SECURITY_CREDENTIALS,password);
    env.put(Context.REFERRAL,systemLDAPConfiguration.referral());
    env.put("com.sun.jndi.ldap.connect.pool","false");
    ldapAuthResult=getFailedLDAPAuthResult(env);
    if (ldapAuthResult != null) {
      return ldapAuthResult;
    }
    ldapAuthResult=new LDAPAuthResult();
    InitialLdapContext initialLdapContext=null;
    try {
      initialLdapContext=new InitialLdapContext(env,null);
      Control[] responseControls=initialLdapContext.getResponseControls();
      ldapAuthResult.setAuthenticated(true);
      ldapAuthResult.setResponseControl(responseControls);
    }
 catch (    Exception e) {
      if (_log.isDebugEnabled()) {
        _log.debug("Failed to bind to the LDAP server with userDN " + userDN + " and password "+ password,e);
      }
      ldapAuthResult.setAuthenticated(false);
      ldapAuthResult.setErrorMessage(e.getMessage());
      setFailedLDAPAuthResult(env,ldapAuthResult);
    }
 finally {
      if (initialLdapContext != null) {
        initialLdapContext.close();
      }
    }
  }
 else   if (authMethod.equals(AUTH_METHOD_PASSWORD_COMPARE)) {
    ldapAuthResult=new LDAPAuthResult();
    Attribute userPassword=attributes.get("userPassword");
    if (userPassword != null) {
      String ldapPassword=new String((byte[])userPassword.get());
      String encryptedPassword=password;
      String algorithm=ldapAuthConfiguration.passwordEncryptionAlgorithm();
      if (Validator.isNotNull(algorithm)) {
        encryptedPassword=_passwordEncryptor.encrypt(algorithm,password,ldapPassword);
      }
      if (ldapPassword.equals(encryptedPassword)) {
        ldapAuthResult.setAuthenticated(true);
      }
 else {
        ldapAuthResult.setAuthenticated(false);
        if (_log.isDebugEnabled()) {
          _log.debug("Passwords do not match for userDN " + userDN);
        }
      }
    }
  }
  return ldapAuthResult;
}
