{
  if (fileName.equals(newFileName)) {
    throw new DuplicateFileException(companyId,repositoryId,newFileName);
  }
  Folder oldVersioningFolderEntry=getVersioningFolder(companyId,repositoryId,fileName,false);
  if (oldVersioningFolderEntry == null) {
    throw new NoSuchFileException(companyId,repositoryId,fileName);
  }
  if (hasFile(companyId,repositoryId,newFileName)) {
    throw new DuplicateFileException(companyId,repositoryId,newFileName);
  }
  Folder newVersioningFolderEntry=getVersioningFolder(companyId,repositoryId,newFileName,true);
  List<String> versionLabels=getVersionLabels(oldVersioningFolderEntry);
  for (  String versionLabel : versionLabels) {
    Document document=getDocument(oldVersioningFolderEntry,versionLabel);
    ContentStream contentStream=document.getContentStream();
    InputStream is=contentStream.getStream();
    createDocument(newVersioningFolderEntry,versionLabel,is);
  }
  oldVersioningFolderEntry.deleteTree(true,UnfileObject.DELETE,false);
}
