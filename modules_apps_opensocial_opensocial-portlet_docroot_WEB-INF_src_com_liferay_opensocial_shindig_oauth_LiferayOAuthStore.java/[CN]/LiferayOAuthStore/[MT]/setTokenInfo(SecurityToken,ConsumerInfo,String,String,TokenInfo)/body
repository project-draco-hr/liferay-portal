{
  long userId=GetterUtil.getLong(securityToken.getViewerId());
  User user=null;
  try {
    user=UserLocalServiceUtil.getUser(userId);
  }
 catch (  Exception e) {
    throw new GadgetException(GadgetException.Code.INTERNAL_SERVER_ERROR,e);
  }
  Gadget gadget=null;
  try {
    gadget=GadgetLocalServiceUtil.fetchGadget(user.getCompanyId(),securityToken.getAppUrl());
  }
 catch (  SystemException se) {
    throw new GadgetException(GadgetException.Code.INTERNAL_SERVER_ERROR,se);
  }
  String gadgetKey=StringPool.BLANK;
  if (gadget == null) {
    gadgetKey=GadgetConstants.toAdhocGadgetKey(securityToken.getModuleId());
  }
 else {
    gadgetKey=GadgetConstants.toPublishedGadgetKey(gadget.getGadgetId());
  }
  try {
    OAuthTokenLocalServiceUtil.addOAuthToken(userId,gadgetKey,serviceName,securityToken.getModuleId(),tokenInfo.getAccessToken(),tokenName,tokenInfo.getTokenSecret(),tokenInfo.getSessionHandle(),tokenInfo.getTokenExpireMillis());
  }
 catch (  Exception e) {
    throw new GadgetException(GadgetException.Code.INTERNAL_SERVER_ERROR,e);
  }
}
