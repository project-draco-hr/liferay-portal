{
  DDMTemplate template=DDMTemplateLocalServiceUtil.getTemplate(ddmTemplateId);
  String viewMode=ParamUtil.getString(renderRequest,"viewMode");
  String languageId=LanguageUtil.getLanguageId(renderRequest);
  String xmlRequest=PortletRequestUtil.toXML(renderRequest,renderResponse);
  if (Validator.isNull(xmlRequest)) {
    xmlRequest="<request />";
  }
  Map<String,String> tokens=JournalUtil.getTokens(recordSet.getGroupId(),themeDisplay,xmlRequest);
  String xml=StringPool.BLANK;
  Document doc=SAXReaderUtil.createDocument();
  Element root=doc.addElement("root");
  Document request=SAXReaderUtil.read(xmlRequest);
  root.add(request.getRootElement().createCopy());
  addAllReservedEls(root,tokens,recordSet);
  xml=DDMXMLUtil.formatXML(doc);
  String script=template.getScript();
  String langType=template.getLanguage();
  return _transformer.transform(themeDisplay,tokens,viewMode,languageId,xml,script,langType);
}
