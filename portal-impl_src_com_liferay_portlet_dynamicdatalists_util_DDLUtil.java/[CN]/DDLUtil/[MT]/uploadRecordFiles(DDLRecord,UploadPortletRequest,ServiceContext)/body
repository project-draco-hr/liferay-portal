{
  DDLRecordSet recordSet=record.getRecordSet();
  DDMStructure ddmStructure=recordSet.getDDMStructure();
  Fields fields=new Fields();
  InputStream inputStream=null;
  for (  String fieldName : ddmStructure.getFieldNames()) {
    String fieldDataType=ddmStructure.getFieldDataType(fieldName);
    if (fieldDataType.equals(FieldConstants.FILE_UPLOAD)) {
      String fileName=uploadPortletRequest.getFileName(fieldName);
      try {
        Field field=record.getField(fieldName);
        String fieldValue=StringPool.BLANK;
        if (field != null) {
          fieldValue=String.valueOf(field.getValue());
        }
        inputStream=uploadPortletRequest.getFileAsStream(fieldName,true);
        if (inputStream != null) {
          String filePath=uploadFieldFile(record,fieldName,inputStream);
          JSONObject recordFileJSONObject=JSONFactoryUtil.createJSONObject();
          recordFileJSONObject.put("name",fileName);
          recordFileJSONObject.put("path",filePath);
          recordFileJSONObject.put("recordId",record.getRecordId());
          fieldValue=recordFileJSONObject.toString();
        }
        field=new Field(ddmStructure.getStructureId(),fieldName,fieldValue);
        fields.put(field);
      }
  finally {
        StreamUtil.cleanUp(inputStream);
      }
    }
  }
  DDLRecordVersion recordVersion=record.getLatestRecordVersion();
  StorageEngineUtil.update(recordVersion.getDDMStorageId(),fields,true,serviceContext);
}
