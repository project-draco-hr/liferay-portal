{
  runSQL("delete from PortletPreferences where ownerId = '0' and " + "ownerType = " + PortletKeys.PREFS_OWNER_TYPE_COMPANY);
  ValueMapper companyIdMapper=AvailableMappersUtil.getCompanyIdMapper();
  Iterator<Object> itr=companyIdMapper.iterator();
  while (itr.hasNext()) {
    String webId=(String)itr.next();
    Long companyIdObj=(Long)companyIdMapper.getNewValue(webId);
    runSQL("delete from PortletPreferences where ownerId = '" + companyIdObj.longValue() + "' and ownerType = "+ PortletKeys.PREFS_OWNER_TYPE_COMPANY);
  }
  Object[][] preferencesColumns1={{"layoutId",new Integer(Types.VARCHAR)}};
  Object[][] preferencesColumns2=PortletPreferencesTable.TABLE_COLUMNS.clone();
  Object[][] preferencesColumns=ArrayUtil.append(preferencesColumns1,preferencesColumns2);
  PrefsOwnerIdUpgradeColumnImpl upgradeOwnerIdColumn=new PrefsOwnerIdUpgradeColumnImpl(AvailableMappersUtil.getCompanyIdMapper(),AvailableMappersUtil.getGroupIdMapper(),AvailableMappersUtil.getUserIdMapper());
  UpgradeColumn upgradeOwnerTypeColumn=new PrefsOwnerTypeUpgradeColumnImpl(upgradeOwnerIdColumn);
  UpgradeColumn upgradeLayoutIdColumn=new TempUpgradeColumnImpl("layoutId");
  UpgradeColumn upgradePlidColumn=new PrefsPlidUpgradeColumnImpl(upgradeOwnerIdColumn,upgradeLayoutIdColumn,AvailableMappersUtil.getLayoutPlidMapper());
  UpgradeColumn upgradePortletIdColumn=new TempUpgradeColumnImpl("portletId");
  UpgradeColumn upgradePreferencesColumn=new PrefsXMLUpgradeColumnImpl(upgradePortletIdColumn,AvailableMappersUtil.getGroupIdMapper(),AvailableMappersUtil.getPollsQuestionIdMapper(),AvailableMappersUtil.getWikiNodeIdMapper());
  UpgradeTable upgradeTable=UpgradeTableFactoryUtil.getUpgradeTable(PortletPreferencesTable.TABLE_NAME,preferencesColumns,new PKUpgradeColumnImpl("portletPreferencesId",false),upgradeOwnerIdColumn,upgradeOwnerTypeColumn,upgradeLayoutIdColumn,upgradePlidColumn,upgradePortletIdColumn,upgradePreferencesColumn);
  String createSQL=PortletPreferencesTable.TABLE_SQL_CREATE;
  createSQL=createSQL.substring(0,createSQL.length() - 1) + ",layoutId VARCHAR(75) null)";
  upgradeTable.setCreateSQL(createSQL);
  upgradeTable.updateTable();
  runSQL(_UPGRADE_SCHEMA);
}
