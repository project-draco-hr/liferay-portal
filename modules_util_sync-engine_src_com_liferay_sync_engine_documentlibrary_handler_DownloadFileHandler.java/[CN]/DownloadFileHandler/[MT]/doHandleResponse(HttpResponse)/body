{
  Header errorHeader=httpResponse.getFirstHeader("Sync-Error");
  if (errorHeader != null) {
    handleSiteDeactivatedException();
  }
  final Session session=SessionManager.getSession(getSyncAccountId());
  Header tokenHeader=httpResponse.getFirstHeader("Sync-JWT");
  if (tokenHeader != null) {
    session.setToken(tokenHeader.getValue());
  }
  InputStream inputStream=null;
  SyncFile syncFile=getLocalSyncFile();
  if (isUnsynced(syncFile)) {
    return;
  }
  Path filePath=Paths.get(syncFile.getFilePathName());
  try {
    HttpEntity httpEntity=httpResponse.getEntity();
    inputStream=new CountingInputStream(httpEntity.getContent()){
      @Override protected synchronized void afterRead(      int n){
        session.incrementDownloadedBytes(n);
        super.afterRead(n);
      }
    }
;
    if (httpResponse.getFirstHeader("Accept-Ranges") != null) {
      copyFile(syncFile,filePath,inputStream,true);
    }
 else {
      copyFile(syncFile,filePath,inputStream,false);
    }
  }
  finally {
    StreamUtil.cleanUp(inputStream);
  }
}
