{
  User user=getUser();
  SyncDevice syncDevice=syncDeviceLocalService.fetchSyncDeviceByUuidAndCompanyId(uuid,user.getCompanyId());
  if (syncDevice == null) {
    syncDevice=SyncDeviceThreadLocal.getSyncDevice();
    return syncDeviceLocalService.addSyncDevice(user.getUserId(),type,buildNumber,syncDevice.getHost(),featureSet);
  }
  if (syncDevice.getUserId() != user.getUserId()) {
    throw new PrincipalException();
  }
  return syncDeviceLocalService.updateSyncDevice(syncDevice.getSyncDeviceId(),type,buildNumber,featureSet,syncDevice.getHost(),syncDevice.getStatus());
}
