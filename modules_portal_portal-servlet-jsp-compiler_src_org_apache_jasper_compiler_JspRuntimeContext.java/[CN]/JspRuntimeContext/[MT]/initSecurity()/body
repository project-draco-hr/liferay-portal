{
  Policy policy=Policy.getPolicy();
  if (policy != null) {
    try {
      String docBase=context.getRealPath("/");
      if (docBase == null) {
        docBase=options.getScratchDir().toString();
      }
      String codeBase=docBase;
      if (!codeBase.endsWith(File.separator)) {
        codeBase=codeBase + File.separator;
      }
      File contextDir=new File(codeBase);
      URL url=contextDir.getCanonicalFile().toURL();
      codeSource=new CodeSource(url,(Certificate[])null);
      permissionCollection=policy.getPermissions(codeSource);
      if (!docBase.endsWith(File.separator)) {
        permissionCollection.add(new FilePermission(docBase,"read"));
        docBase=docBase + File.separator;
      }
 else {
        permissionCollection.add(new FilePermission(docBase.substring(0,docBase.length() - 1),"read"));
      }
      docBase=docBase + "-";
      permissionCollection.add(new FilePermission(docBase,"read"));
      String workDir=options.getScratchDir().toString();
      if (!workDir.endsWith(File.separator)) {
        permissionCollection.add(new FilePermission(workDir,"read"));
        workDir=workDir + File.separator;
      }
      workDir=workDir + "-";
      permissionCollection.add(new FilePermission(workDir,"read"));
      permissionCollection.add(new RuntimePermission("accessClassInPackage.org.apache.jasper.runtime"));
      if (parentClassLoader instanceof URLClassLoader) {
        URL[] urls=((URLClassLoader)parentClassLoader).getURLs();
        String jarUrl=null;
        String jndiUrl=null;
        for (int i=0; i < urls.length; i++) {
          if (jndiUrl == null && urls[i].toString().startsWith("jndi:")) {
            jndiUrl=urls[i].toString() + "-";
          }
          if (jarUrl == null && urls[i].toString().startsWith("jar:jndi:")) {
            jarUrl=urls[i].toString();
            jarUrl=jarUrl.substring(0,jarUrl.length() - 2);
            jarUrl=jarUrl.substring(0,jarUrl.lastIndexOf('/')) + "/-";
          }
        }
        if (jarUrl != null) {
          permissionCollection.add(new FilePermission(jarUrl,"read"));
          permissionCollection.add(new FilePermission(jarUrl.substring(4),"read"));
        }
        if (jndiUrl != null)         permissionCollection.add(new FilePermission(jndiUrl,"read"));
      }
    }
 catch (    Exception e) {
      context.log("Security Init for context failed",e);
    }
  }
}
