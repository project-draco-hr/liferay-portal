{
  BundleRevision bundleRevision=bundle.adapt(BundleRevision.class);
  for (  Capability capability : bundleRevision.getCapabilities(null)) {
    String namespace=capability.getNamespace();
    CapabilityBuilder cb=new CapabilityBuilder(namespace);
    cb.addAttributes(capability.getAttributes());
    cb.addDirectives(capability.getDirectives());
    Attrs attrs=cb.toAttrs();
    if (cb.isPackage()) {
      attrs.remove(Constants.BUNDLE_SYMBOLIC_NAME_ATTRIBUTE);
      attrs.remove(Constants.BUNDLE_VERSION_ATTRIBUTE);
      String packageName=attrs.remove(PackageNamespace.PACKAGE_NAMESPACE);
      if (packageName != null) {
        _packages.put(packageName,attrs);
      }
    }
 else     if (!_ignoredNamespaces.contains(namespace)) {
      Parameters parameters=new Parameters();
      if (namespace.equals(NativeNamespace.NATIVE_NAMESPACE)) {
        Set<String> keySet=new LinkedHashSet<>(attrs.keySet());
        for (        String key : keySet) {
          if (!key.startsWith(NativeNamespace.NATIVE_NAMESPACE)) {
            attrs.remove(key);
          }
        }
      }
      parameters.put(namespace,attrs);
      _provided.add(parameters);
    }
  }
}
