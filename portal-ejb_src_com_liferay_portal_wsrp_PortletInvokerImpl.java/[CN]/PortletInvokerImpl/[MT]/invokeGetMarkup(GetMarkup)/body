{
  String portletHandle=getMarkup.getPortletContext().getPortletHandle();
  MarkupResponse markupResponse=new MarkupResponse();
  MarkupContext markupContext=new MarkupContext();
  markupResponse.setMarkupContext(markupContext);
  try {
    MarkupParams markupParams=getMarkup.getMarkupParams();
    String wsrpWindowState=markupParams.getWindowState();
    WindowState windowState=WSRPUtil.fromWsrpWindowState(wsrpWindowState);
    String wsrpMode=markupParams.getMode();
    PortletMode mode=WSRPUtil.fromWsrpMode(wsrpMode);
    ServletContext ctx=WSRPUtil.getServletContext();
    String companyId=WSRPUtil.getCompanyId();
    Portlet portlet=PortletLocalServiceUtil.getPortletById(companyId,portletHandle);
    CachePortlet cachePortlet=PortletInstanceFactory.create(portlet,ctx);
    PortletConfig portletConfig=PortletConfigFactory.create(portlet,ctx);
    PortletContext portletCtx=portletConfig.getPortletContext();
    Locale reqLocale=LocaleHelper.getLocale(markupParams.getLocales()[0]);
    String reqMimeType=markupParams.getMimeTypes()[0];
    Map renderParameters=_getRenderParameters(markupParams);
    HttpServletRequest httpReq=new WSRPServletRequest(WSRPUtil.getHttpServletRequest(),reqLocale,reqMimeType,renderParameters);
    PortletPreferences prefs=PortletPreferencesLocalServiceUtil.getPreferences(companyId,PortletPreferencesFactory.getPortletPreferencesPK(httpReq,portlet.getPortletId()));
    User user=UserLocalServiceUtil.getDefaultUser(companyId);
    Layout layout=_getDefaultUserLayout(user.getActualCompanyId());
    RenderRequestImpl renderRequest=RenderRequestFactory.create(httpReq,portlet,cachePortlet,portletCtx,windowState,mode,prefs,layout.getPlid());
    WSRPServletResponse res=new WSRPServletResponse();
    RenderResponseImpl renderResponse=new WSRPRenderResponseImpl(getMarkup,_provider,(RenderRequestImpl)renderRequest,res,portlet.getPortletId(),companyId,layout.getPlid());
    renderResponse.setContentType("text/html");
    renderRequest.defineObjects(portletConfig,renderResponse);
    cachePortlet.render(renderRequest,renderResponse);
    markupContext.setMarkupString(res.getString());
    String contentType=renderResponse.getContentType();
    if (contentType == null) {
      contentType=Constants.TEXT_HTML;
    }
    markupContext.setMimeType(contentType);
    markupContext.setLocale(renderResponse.getLocale().getLanguage());
    markupContext.setPreferredTitle(renderResponse.getTitle());
    RenderRequestFactory.recycle(renderRequest);
  }
 catch (  Exception e) {
    e.printStackTrace();
  }
  return markupResponse;
}
