{
  if (checkDateRange && !portletDataContext.isWithinDateRange(fileEntry.getModifiedDate())) {
    return;
  }
  DLFileVersion fileVersion=fileEntry.getFileVersion();
  if (fileVersion.getStatus() != WorkflowConstants.STATUS_APPROVED) {
    return;
  }
  if (foldersElement != null) {
    exportParentFolder(portletDataContext,foldersElement,fileEntry.getFolderId());
  }
  String path=getFileEntryPath(portletDataContext,fileEntry);
  if (portletDataContext.isPathNotProcessed(path)) {
    Element fileEntryElement=fileEntriesElement.addElement("file-entry");
    fileEntryElement.addAttribute("path",path);
    String binPath=getFileEntryBinPath(portletDataContext,fileEntry);
    fileEntryElement.addAttribute("bin-path",binPath);
    fileEntry.setUserUuid(fileEntry.getUserUuid());
    portletDataContext.addLocks(DLFileEntry.class,DLUtil.getLockId(fileEntry.getGroupId(),fileEntry.getFolderId(),fileEntry.getName()));
    portletDataContext.addPermissions(DLFileEntry.class,fileEntry.getFileEntryId());
    if (portletDataContext.getBooleanParameter(_NAMESPACE,"categories")) {
      portletDataContext.addAssetCategories(DLFileEntry.class,fileEntry.getFileEntryId());
    }
    if (portletDataContext.getBooleanParameter(_NAMESPACE,"comments")) {
      portletDataContext.addComments(DLFileEntry.class,fileEntry.getFileEntryId());
    }
    if (portletDataContext.getBooleanParameter(_NAMESPACE,"ratings")) {
      portletDataContext.addRatingsEntries(DLFileEntry.class,fileEntry.getFileEntryId());
    }
    if (portletDataContext.getBooleanParameter(_NAMESPACE,"tags")) {
      portletDataContext.addAssetTags(DLFileEntry.class,fileEntry.getFileEntryId());
    }
    long repositoryId=getRepositoryId(fileEntry.getGroupId(),fileEntry.getFolderId());
    InputStream is=DLLocalServiceUtil.getFileAsStream(fileEntry.getCompanyId(),repositoryId,fileEntry.getName(),fileEntry.getVersion());
    if (is == null) {
      if (_log.isWarnEnabled()) {
        _log.warn("No file found for file entry " + fileEntry.getFileEntryId());
      }
      fileEntryElement.detach();
      return;
    }
    try {
      portletDataContext.addZipEntry(getFileEntryBinPath(portletDataContext,fileEntry),is);
    }
  finally {
      try {
        is.close();
      }
 catch (      IOException ioe) {
        _log.error(ioe,ioe);
      }
    }
    portletDataContext.addZipEntry(path,fileEntry);
    if (portletDataContext.getBooleanParameter(_NAMESPACE,"ranks")) {
      List<DLFileRank> fileRanks=DLFileRankUtil.findByF_N(fileEntry.getFolderId(),fileEntry.getName());
      for (      DLFileRank fileRank : fileRanks) {
        exportFileRank(portletDataContext,fileRanksElement,fileRank);
      }
    }
  }
}
