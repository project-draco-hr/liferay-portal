{
  ThemeDisplay themeDisplay=null;
  try {
    HttpSession ses=req.getSession();
    String command=req.getParameter("Command");
    String type=req.getParameter("Type");
    String currentFolder=req.getParameter("CurrentFolder");
    String newFolder=ParamUtil.getString(req,"NewFolderName");
    themeDisplay=ThemeDisplayFactory.create();
    req.setAttribute(WebKeys.THEME_DISPLAY,themeDisplay);
    Company company=PortalUtil.getCompany(req);
    User user=PortalUtil.getUser(req);
    String plid=ParamUtil.getString(req,"p_l_id");
    String groupId=PortalUtil.getPortletGroupId(plid);
    String mainPath=(String)ses.getAttribute(WebKeys.MAIN_PATH);
    String friendlyURLPrivatePath=(String)ses.getAttribute(WebKeys.FRIENDLY_URL_PRIVATE_PATH);
    String friendlyURLPublicPath=(String)ses.getAttribute(WebKeys.FRIENDLY_URL_PUBLIC_PATH);
    themeDisplay.setCompany(company);
    themeDisplay.setUser(user);
    themeDisplay.setPlid(plid);
    themeDisplay.setPortletGroupId(groupId);
    themeDisplay.setPathMain(mainPath);
    themeDisplay.setPathFriendlyURLPrivate(friendlyURLPrivatePath);
    themeDisplay.setPathFriendlyURLPublic(friendlyURLPublicPath);
    if (user != null) {
      PrincipalThreadLocal.setName(user.getUserId());
      PermissionChecker permissionChecker=PermissionCheckerFactory.create(user,true);
      PermissionThreadLocal.setPermissionChecker(permissionChecker);
    }
    CommandArgument arg=new CommandArgument(command,type,currentFolder,newFolder,themeDisplay,req);
    Command commandObj=CommandFactory.getCommand(command);
    commandObj.execute(arg,req,res);
  }
 catch (  Exception e) {
    _log.error(e);
  }
 finally {
    try {
      ThemeDisplayFactory.recycle(themeDisplay);
    }
 catch (    Exception e) {
    }
  }
}
