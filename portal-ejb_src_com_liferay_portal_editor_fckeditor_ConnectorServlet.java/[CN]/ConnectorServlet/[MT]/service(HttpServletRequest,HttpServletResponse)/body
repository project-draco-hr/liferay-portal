{
  ThemeDisplay themeDisplay=null;
  PermissionChecker permissionChecker=null;
  try {
    HttpSession ses=req.getSession();
    if (_log.isDebugEnabled()) {
      _log.debug("URL " + req.getRequestURL());
    }
    String command=req.getParameter("Command");
    String type=req.getParameter("Type");
    String currentFolder=req.getParameter("CurrentFolder");
    String newFolder=ParamUtil.getString(req,"NewFolderName");
    if (_log.isDebugEnabled()) {
      _log.debug("command " + command);
      _log.debug("type " + type);
      _log.debug("currentFolder " + currentFolder);
      _log.debug("newFolder " + newFolder);
    }
    themeDisplay=ThemeDisplayFactory.create();
    req.setAttribute(WebKeys.THEME_DISPLAY,themeDisplay);
    Company company=PortalUtil.getCompany(req);
    User user=PortalUtil.getUser(req);
    String plid=ParamUtil.getString(req,"p_l_id");
    String groupId=PortalUtil.getPortletGroupId(plid);
    String mainPath=(String)ses.getAttribute(WebKeys.MAIN_PATH);
    String friendlyURLPrivatePath=(String)ses.getAttribute(WebKeys.FRIENDLY_URL_PRIVATE_PATH);
    String friendlyURLPublicPath=(String)ses.getAttribute(WebKeys.FRIENDLY_URL_PUBLIC_PATH);
    if (_log.isDebugEnabled()) {
      _log.debug("company " + company);
      _log.debug("user " + user);
      _log.debug("plid " + plid);
      _log.debug("groupId " + groupId);
      _log.debug("mainPath " + mainPath);
      _log.debug("friendlyURLPrivatePath " + friendlyURLPrivatePath);
      _log.debug("friendlyURLPublicPath " + friendlyURLPublicPath);
    }
    themeDisplay.setCompany(company);
    themeDisplay.setUser(user);
    themeDisplay.setPlid(plid);
    themeDisplay.setPortletGroupId(groupId);
    themeDisplay.setPathMain(mainPath);
    themeDisplay.setPathFriendlyURLPrivate(friendlyURLPrivatePath);
    themeDisplay.setPathFriendlyURLPublic(friendlyURLPublicPath);
    if (user != null) {
      PrincipalThreadLocal.setName(user.getUserId());
      permissionChecker=PermissionCheckerFactory.create(user,true);
      PermissionThreadLocal.setPermissionChecker(permissionChecker);
    }
    CommandArgument arg=new CommandArgument(command,type,currentFolder,newFolder,themeDisplay,req);
    Command commandObj=CommandFactory.getCommand(command);
    commandObj.execute(arg,req,res);
  }
 catch (  Exception e) {
    _log.error(StackTraceUtil.getStackTrace(e));
  }
 finally {
    try {
      ThemeDisplayFactory.recycle(themeDisplay);
    }
 catch (    Exception e) {
    }
    try {
      PermissionCheckerFactory.recycle(permissionChecker);
    }
 catch (    Exception e) {
    }
  }
}
