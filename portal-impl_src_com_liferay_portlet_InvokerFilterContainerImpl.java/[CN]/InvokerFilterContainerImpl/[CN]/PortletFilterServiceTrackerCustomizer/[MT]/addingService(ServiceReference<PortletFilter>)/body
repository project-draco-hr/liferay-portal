{
  Registry registry=RegistryUtil.getRegistry();
  PortletFilter portletFilter=registry.getService(serviceReference);
  boolean preinitializedFilter=GetterUtil.getBoolean(serviceReference.getProperty("preinitialized.filter"));
  if (!preinitializedFilter) {
    String filterName=GetterUtil.getString(serviceReference.getProperty("service.id"),ClassUtil.getClassName(portletFilter));
    Map<String,String> params=new HashMap<>();
    for (    String key : serviceReference.getPropertyKeys()) {
      String value=GetterUtil.getString(serviceReference.getProperty(key));
      params.put(key,value);
    }
    FilterConfig filterConfig=new FilterConfigImpl(filterName,_portletContext,params);
    try {
      portletFilter.init(filterConfig);
    }
 catch (    PortletException pe) {
      _log.error(pe,pe);
      registry.ungetService(serviceReference);
      return null;
    }
  }
  if (portletFilter instanceof ActionFilter) {
    _actionFilters.add((ActionFilter)portletFilter);
  }
  if (portletFilter instanceof EventFilter) {
    _eventFilters.add((EventFilter)portletFilter);
  }
  if (portletFilter instanceof RenderFilter) {
    _renderFilters.add((RenderFilter)portletFilter);
  }
  if (portletFilter instanceof ResourceFilter) {
    _resourceFilters.add((ResourceFilter)portletFilter);
  }
  return portletFilter;
}
