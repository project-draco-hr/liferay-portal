{
  Registry registry=RegistryUtil.getRegistry();
  PortletFilter portletFilter=registry.getService(serviceReference);
  boolean preInitializedFilter=GetterUtil.getBoolean(serviceReference.getProperty(_PRE_INITIALIZED_FILTER));
  if (!preInitializedFilter) {
    String filterName=GetterUtil.getString(serviceReference.getProperty("service.id"),ClassUtil.getClassName(portletFilter));
    Map<String,String> params=new HashMap<String,String>();
    for (    String key : serviceReference.getPropertyKeys()) {
      String value=GetterUtil.getString(serviceReference.getProperty(key));
      params.put(key,value);
    }
    FilterConfig filterConfig=new FilterConfigImpl(filterName,_portletContext,params);
    try {
      portletFilter.init(filterConfig);
    }
 catch (    PortletException e) {
      _log.error(e,e);
      registry.ungetService(serviceReference);
      return null;
    }
  }
  if (portletFilter instanceof ActionFilter) {
    _actionFilters.add((ActionFilter)portletFilter);
  }
  if (portletFilter instanceof EventFilter) {
    _eventFilters.add((EventFilter)portletFilter);
  }
  if (portletFilter instanceof RenderFilter) {
    _renderFilters.add((RenderFilter)portletFilter);
  }
  if (portletFilter instanceof ResourceFilter) {
    _resourceFilters.add((ResourceFilter)portletFilter);
  }
  return portletFilter;
}
