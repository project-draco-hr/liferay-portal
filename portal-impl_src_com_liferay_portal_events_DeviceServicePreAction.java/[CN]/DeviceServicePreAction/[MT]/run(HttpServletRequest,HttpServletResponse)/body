{
  HttpSession session=request.getSession();
  ThemeDisplay themeDisplay=(ThemeDisplay)request.getAttribute(WebKeys.THEME_DISPLAY);
  Device device=(Device)session.getAttribute(WebKeys.DEVICE);
  if (device == null) {
    device=DeviceDetectionUtil.detectDevice(request);
    session.setAttribute(WebKeys.DEVICE,device);
  }
  themeDisplay.setDevice(device);
  if (UnknownDevice.getInstance().equals(device)) {
    return;
  }
  MDRRuleGroupInstance ruleGroupInstance=null;
  try {
    ruleGroupInstance=RuleGroupProcessorUtil.evaluateRuleGroups(themeDisplay);
    if (_log.isDebugEnabled()) {
      _log.debug("RuleGroup evaluation returned RuleGroupInstance: " + ruleGroupInstance.getRuleGroupInstanceId());
    }
  }
 catch (  SystemException e) {
    throw new ActionException("Error while retrieving rule group",e);
  }
  themeDisplay.setRuleGroupInstance(ruleGroupInstance);
  if (ruleGroupInstance != null) {
    try {
      List<MDRAction> actions=MDRActionLocalServiceUtil.getActions(ruleGroupInstance.getRuleGroupInstanceId());
      ActionHandlerManagerUtil.applyActions(actions,request,response);
    }
 catch (    Exception e) {
      throw new ActionException("Error while applying device profile",e);
    }
  }
}
