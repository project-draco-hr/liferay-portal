{
  HttpSession session=request.getSession();
  ThemeDisplay themeDisplay=(ThemeDisplay)request.getAttribute(WebKeys.THEME_DISPLAY);
  Device device=null;
  if (PropsValues.MOBILE_DEVICE_SESSION_CACHE_ENABLED) {
    TransientValue<Device> transientValue=(TransientValue<Device>)session.getAttribute(WebKeys.DEVICE);
    if (transientValue != null) {
      device=transientValue.getValue();
    }
  }
  if (device == null) {
    device=DeviceDetectionUtil.detectDevice(request);
    if (PropsValues.MOBILE_DEVICE_SESSION_CACHE_ENABLED) {
      session.setAttribute(WebKeys.DEVICE,new TransientValue<Device>(device));
    }
  }
  themeDisplay.setDevice(device);
  UnknownDevice unknownDevice=UnknownDevice.getInstance();
  if (device.equals(unknownDevice)) {
    return;
  }
  MDRRuleGroupInstance mdrRuleGroupInstance=null;
  try {
    mdrRuleGroupInstance=RuleGroupProcessorUtil.evaluateRuleGroups(themeDisplay);
    if (_log.isDebugEnabled()) {
      String logMessage="Rule group evaluation returned rule group instance ";
      if (mdrRuleGroupInstance != null) {
        logMessage+=mdrRuleGroupInstance.getRuleGroupInstanceId();
      }
 else {
        logMessage+="null";
      }
      _log.debug(logMessage);
    }
  }
 catch (  Exception e) {
    if (_log.isWarnEnabled()) {
      _log.warn("Unable to retrieve rule group",e);
    }
    return;
  }
  themeDisplay.setMDRRuleGroupInstance(mdrRuleGroupInstance);
  if (mdrRuleGroupInstance == null) {
    return;
  }
  try {
    List<MDRAction> mdrActions=MDRActionLocalServiceUtil.getActions(mdrRuleGroupInstance.getRuleGroupInstanceId());
    ActionHandlerManagerUtil.applyActions(mdrActions,request,response);
  }
 catch (  Exception e) {
    if (_log.isWarnEnabled()) {
      _log.warn("Unable to apply device profile",e);
    }
  }
}
