{
  if (redirectToLogin(req,res)) {
    return;
  }
  String cmd=req.getParameter(Constants.CMD);
  try {
    _editLatestOrder(req);
  }
 catch (  Exception e) {
    req.setAttribute(PageContext.EXCEPTION,e);
    setForward(req,Constants.COMMON_ERROR);
  }
  if (cmd != null && cmd.equals(Constants.SAVE)) {
    try {
      ActionUtil.updateCart(req,res);
      _updateLatestOrder(req);
      _saveLatestOrder(req);
      _forwardCheckout(req,res);
    }
 catch (    Exception e) {
      req.setAttribute(PageContext.EXCEPTION,e);
      setForward(req,Constants.COMMON_ERROR);
    }
  }
 else   if (cmd != null && cmd.equals(Constants.UPDATE)) {
    try {
      _updateLatestOrder(req);
      setForward(req,"portlet.shopping.checkout_second");
    }
 catch (    Exception e) {
      if (e != null && e instanceof BillingCityException || e instanceof BillingCountryException || e instanceof BillingEmailAddressException || e instanceof BillingFirstNameException || e instanceof BillingLastNameException || e instanceof BillingPhoneException || e instanceof BillingStateException || e instanceof BillingStreetException || e instanceof BillingZipException || e instanceof CCExpirationException || e instanceof CCNameException || e instanceof CCNumberException || e instanceof CCTypeException || e instanceof ShippingCityException || e instanceof ShippingCountryException || e instanceof ShippingEmailAddressException || e instanceof ShippingFirstNameException || e instanceof ShippingLastNameException || e instanceof ShippingPhoneException || e instanceof ShippingStateException || e instanceof ShippingStreetException || e instanceof ShippingZipException) {
        SessionErrors.add(req,e.getClass().getName());
        setForward(req,"portlet.shopping.checkout_first");
      }
 else       if (e != null && e instanceof PrincipalException) {
        setForward(req,"portlet.shopping.error");
      }
 else {
        req.setAttribute(PageContext.EXCEPTION,e);
        setForward(req,Constants.COMMON_ERROR);
      }
    }
  }
 else   if (cmd != null && cmd.equals(Constants.VIEW)) {
    setForward(req,"portlet.shopping.checkout_third");
  }
 else {
    setForward(req,"portlet.shopping.checkout_first");
  }
}
