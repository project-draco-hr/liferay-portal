{
  PortletSession ses=req.getPortletSession();
  PortletContext portletCtx=ses.getPortletContext();
  Company company=PortalUtil.getCompany(req);
  ShoppingCart cart=ShoppingCartServiceUtil.getCart(ses.getId(),company.getCompanyId());
  ShoppingOrder order=(ShoppingOrder)req.getAttribute(WebKeys.SHOPPING_ORDER);
  ShoppingConfig shoppingConfig=AdminConfigServiceUtil.getShoppingConfig(company.getCompanyId());
  String mainPath=(String)portletCtx.getAttribute(WebKeys.MAIN_PATH);
  String returnURL=ShoppingUtil.getPayPalReturnURL(((ActionResponseImpl)res).createActionURL(),order);
  String notifyURL=ShoppingUtil.getPayPalNotifyURL(company,mainPath);
  if (shoppingConfig.usePayPal()) {
    double total=ShoppingUtil.calculateTotal(cart.getItems(),order.getBillingState(),cart.getCoupon(),cart.getAltShipping(),cart.isInsure());
    String redirectURL=ShoppingUtil.getPayPalRedirectURL(shoppingConfig,order,total,returnURL,notifyURL);
    res.sendRedirect(redirectURL);
  }
 else {
    ShoppingOrderLocalServiceUtil.sendOrderEmail(order);
    res.sendRedirect(returnURL);
  }
}
