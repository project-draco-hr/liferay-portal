{
  long parentMBMessageId=MBMessageConstants.DEFAULT_PARENT_MESSAGE_ID;
  List<User> recipients=null;
  if (mbThreadId != 0) {
    List<MBMessage> mbMessages=MBMessageLocalServiceUtil.getThreadMessages(mbThreadId,WorkflowConstants.STATUS_ANY);
    MBMessage lastMBMessage=mbMessages.get(mbMessages.size() - 1);
    parentMBMessageId=lastMBMessage.getMessageId();
    subject=lastMBMessage.getSubject();
  }
 else {
    recipients=parseRecipients(userId,to);
    if (recipients.isEmpty()) {
      return null;
    }
  }
  return addPrivateMessage(userId,mbThreadId,parentMBMessageId,recipients,subject,body,inputStreamOVPs,themeDisplay);
}
