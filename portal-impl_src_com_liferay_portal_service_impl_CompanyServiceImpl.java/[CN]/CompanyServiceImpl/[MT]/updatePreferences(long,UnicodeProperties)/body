{
  if (!roleLocalService.hasUserRole(getUserId(),companyId,RoleConstants.ADMINISTRATOR,true)) {
    throw new PrincipalException();
  }
  if (properties.containsKey(PropsKeys.GOOGLE_APPS_PASSWORD)) {
    String defaultPassword=PrefsPropsUtil.getString(companyId,PropsKeys.GOOGLE_APPS_PASSWORD);
    fixPassword(companyId,properties,PropsKeys.GOOGLE_APPS_PASSWORD,PropsKeys.GOOGLE_APPS_PASSWORD + ".temp",defaultPassword);
  }
 else {
    String defaultPassword=PrefsPropsUtil.getString(companyId,PropsKeys.LDAP_SECURITY_CREDENTIALS);
    List<String> tempKeys=new ArrayList<String>();
    String prefix=PropsKeys.LDAP_SECURITY_CREDENTIALS + ".temp";
    for (    String key : properties.keySet()) {
      if (key.startsWith(prefix)) {
        tempKeys.add(key);
      }
    }
    for (    String tempKey : tempKeys) {
      String key=tempKey.replace(".temp","");
      fixPassword(companyId,properties,key,tempKey,defaultPassword);
    }
  }
  companyLocalService.updatePreferences(companyId,properties);
}
