{
  ServiceContext serviceContext=new ServiceContext();
  ThemeDisplay themeDisplay=(ThemeDisplay)request.getAttribute(WebKeys.THEME_DISPLAY);
  if (themeDisplay != null) {
    serviceContext.setCompanyId(themeDisplay.getCompanyId());
    serviceContext.setLanguageId(themeDisplay.getLanguageId());
    serviceContext.setLayoutFullURL(PortalUtil.getLayoutFullURL(themeDisplay));
    serviceContext.setLayoutURL(PortalUtil.getLayoutURL(themeDisplay));
    serviceContext.setPathMain(PortalUtil.getPathMain());
    serviceContext.setPlid(themeDisplay.getPlid());
    serviceContext.setPortalURL(PortalUtil.getPortalURL(request));
    serviceContext.setScopeGroupId(themeDisplay.getScopeGroupId());
    serviceContext.setSignedIn(themeDisplay.isSignedIn());
    User user=themeDisplay.getUser();
    serviceContext.setUserDisplayURL(user.getDisplayURL(themeDisplay));
    serviceContext.setUserId(user.getUserId());
  }
 else {
    long companyId=PortalUtil.getCompanyId(request);
    serviceContext.setCompanyId(companyId);
    serviceContext.setPathMain(PortalUtil.getPathMain());
    User user=PortalUtil.getUser(request);
    if (user != null) {
      serviceContext.setSignedIn(!user.isDefaultUser());
      serviceContext.setUserId(user.getUserId());
    }
 else {
      serviceContext.setSignedIn(false);
    }
  }
  Map<String,Serializable> attributes=new HashMap<String,Serializable>();
  Enumeration<String> enu=request.getParameterNames();
  while (enu.hasMoreElements()) {
    String param=enu.nextElement();
    String[] values=request.getParameterValues(param);
    if ((values != null) && (values.length > 0)) {
      if (values.length == 1) {
        attributes.put(param,values[0]);
      }
 else {
        attributes.put(param,values);
      }
    }
  }
  serviceContext.setAttributes(attributes);
  Map<String,String> headerMap=new HashMap<String,String>();
  enu=request.getHeaderNames();
  while (enu.hasMoreElements()) {
    String header=enu.nextElement();
    String value=request.getHeader(header);
    headerMap.put(header,value);
  }
  serviceContext.setHeaders(headerMap);
  serviceContext.setRemoteAddr(request.getRemoteAddr());
  serviceContext.setRemoteHost(request.getRemoteHost());
  return serviceContext;
}
