{
  Analyzer analyzer=new Analyzer();
  analyzer.setBase(_pluginDir);
  analyzer.setJar(_pluginDir);
  analyzer.setProperty("-jsp","*.jsp,*.jspf");
  analyzer.setProperty("-plugin","com.liferay.ant.bnd.jsp.JspAnalyzerPlugin");
  analyzer.setProperty("Web-ContextPath",getWebContextPath());
  Set<Object> plugins=analyzer.getPlugins();
  plugins.add(_dsAnnotations);
  plugins.add(_metatypePlugin);
  plugins.add(_metatypeAnnotations);
  Properties pluginPackageProperties=getPluginPackageProperties();
  processBundleVersion(analyzer);
  processBundleClasspath(analyzer,pluginPackageProperties);
  processBundleSymbolicName(analyzer);
  processExtraHeaders(analyzer);
  processPluginPackagePropertiesExportImportPackages(pluginPackageProperties);
  processBundleManifestVersion(analyzer);
  processLiferayPortletXML();
  processWebXML("WEB-INF/web.xml");
  processWebXML("WEB-INF/liferay-web.xml");
  processDeclarativeReferences();
  processExtraRequirements();
  processPackageNames(analyzer);
  processRequiredDeploymentContexts(analyzer);
  _processExcludedJSPs(analyzer);
  analyzer.setProperties(pluginPackageProperties);
  try {
    analyzer.calcManifest();
    Packages packages=analyzer.getImports();
    Set<Entry<PackageRef,Attrs>> packageRefsSet=packages.entrySet();
    Iterator<Entry<PackageRef,Attrs>> iterator=packageRefsSet.iterator();
    while (iterator.hasNext()) {
      Entry<PackageRef,Attrs> entry=iterator.next();
      PackageRef packageRef=entry.getKey();
      String fqn=packageRef.getFQN();
      if (fqn.startsWith("junit.")) {
        iterator.remove();
      }
    }
    writeManifest(analyzer.calcManifest());
    copyOSGI_INFToWab(analyzer);
  }
 catch (  Exception e) {
    throw new IOException("Unable to calculate the manifest",e);
  }
 finally {
    analyzer.close();
  }
}
