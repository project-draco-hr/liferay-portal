{
  if (_log.isDebugEnabled()) {
    _log.debug("Path " + path);
    _log.debug("Context path " + _contextPath);
    _log.debug("Servlet mapping " + _servletMapping);
  }
  String encodedURL=path;
  if (path.startsWith("//") || path.startsWith(_contextPath) || path.startsWith(_servletMapping)) {
    path=StringUtil.replace(path,"&amp;","&");
    _liferayPortletURL.setLifecycle(PortletRequest.RENDER_PHASE);
    _liferayPortletURL.setParameters(new HashMap<String,String[]>());
    try {
      _liferayPortletURL.setWindowState(_windowState);
    }
 catch (    WindowStateException wse) {
    }
    try {
      _liferayPortletURL.setPortletMode(_portletMode);
    }
 catch (    PortletModeException pme) {
    }
    String strutsAction=path;
    String queryString=StringPool.BLANK;
    int pos=strutsAction.indexOf(CharPool.QUESTION);
    if (pos != -1) {
      strutsAction=path.substring(0,pos);
      queryString=path.substring(pos + 1);
    }
    if (strutsAction.startsWith("c/")) {
      strutsAction=strutsAction.substring(1);
    }
 else     if (strutsAction.startsWith("/c/")) {
      strutsAction=strutsAction.substring(2);
    }
    if (Validator.isNotNull(_contextPath)) {
      strutsAction=strutsAction.substring(_contextPath.length());
    }
    if (strutsAction.startsWith(_servletMapping)) {
      strutsAction=strutsAction.substring(_servletMapping.length());
    }
    if (!strutsAction.startsWith(StringPool.SLASH)) {
      strutsAction=StringPool.SLASH + strutsAction;
    }
    if (_log.isDebugEnabled()) {
      _log.debug("Struts action " + strutsAction);
    }
    _liferayPortletURL.setParameter("struts_action",strutsAction);
    setParameters(_liferayPortletURL,queryString);
    encodedURL=_liferayPortletURL.toString();
    if (_log.isDebugEnabled()) {
      _log.debug("Encoded portlet URL " + encodedURL);
    }
  }
  return encodedURL;
}
