{
  try {
    PortletSession ses=req.getPortletSession();
    UploadPortletRequest uploadReq=PortalUtil.getUploadPortletRequest(req);
    Message msg=(Message)ses.getAttribute(WebKeys.MAIL_MESSAGE,PortletSession.APPLICATION_SCOPE);
    Multipart multipart=(Multipart)msg.getContent();
    String list=uploadReq.getParameter("attachments_list");
    List temp=new ArrayList();
    if (Validator.isNotNull(list)) {
      StringTokenizer st=new StringTokenizer(list,StringPool.COMMA);
      while (st.hasMoreTokens()) {
        String partId=st.nextToken();
        try {
          BodyPart bp=multipart.getBodyPart(Integer.parseInt(partId));
          if (bp != null) {
            temp.add(bp);
          }
        }
 catch (        NumberFormatException nfe) {
        }
      }
    }
    while (multipart.getCount() > 1) {
      multipart.removeBodyPart(1);
    }
    for (int i=0; i < temp.size(); i++) {
      multipart.addBodyPart((BodyPart)temp.get(i));
    }
    Enumeration enu=uploadReq.getParameterNames();
    while (enu.hasMoreElements()) {
      String fileParamName=(String)enu.nextElement();
      File file=uploadReq.getFile(fileParamName);
      byte[] bytes=FileUtil.getBytes(file);
      if ((bytes != null) && (bytes.length > 0)) {
        String contentType=uploadReq.getContentType(fileParamName);
        String fileName=uploadReq.getFileName(fileParamName);
        BodyPart part=new MimeBodyPart();
        part.setDataHandler(new DataHandler(new ByteArrayDataSource(bytes,contentType)));
        part.setDisposition(Part.ATTACHMENT);
        part.setFileName(fileName);
        multipart.addBodyPart(part);
      }
    }
    ActionUtil.getAttachments(req);
    res.sendRedirect(ParamUtil.getString(req,"redirect"));
  }
 catch (  Exception e) {
    req.setAttribute(PageContext.EXCEPTION,e);
    setForward(req,Constants.COMMON_ERROR);
  }
}
