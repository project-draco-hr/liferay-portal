{
  if (LuceneUtil.INDEX_READ_ONLY) {
    return;
  }
  boolean writerFound=false;
synchronized (this) {
    if (!_writerLookup.isEmpty()) {
      Iterator itr=_writerLookup.values().iterator();
      while (itr.hasNext()) {
        IndexWriterData writerData=(IndexWriterData)itr.next();
        if (writerData.getWriter() == writer) {
          writerFound=true;
          decrement(writerData);
          break;
        }
      }
    }
  }
  if (!writerFound) {
    try {
      _optimizeCount++;
      if ((_OPTIMIZE_INTERVAL == 0) || (_optimizeCount >= _OPTIMIZE_INTERVAL)) {
        writer.optimize();
        _optimizeCount=0;
      }
    }
  finally {
      writer.close();
    }
  }
}
