{
  ThemeDisplay themeDisplay=(ThemeDisplay)request.getAttribute(WebKeys.THEME_DISPLAY);
  Theme theme=themeDisplay.getTheme();
  PortletDisplay portletDisplay=themeDisplay.getPortletDisplay();
  RequestDispatcher requestDispatcher=DirectRequestDispatcherFactoryUtil.getRequestDispatcher(servletContext,portletPage);
  UnsyncStringWriter unsyncStringWriter=new UnsyncStringWriter();
  PipingServletResponse pipingServletResponse=new PipingServletResponse(response,unsyncStringWriter);
  requestDispatcher.include(request,pipingServletResponse);
  portletDisplay.setContent(unsyncStringWriter.getStringBundler());
  String content=null;
  String extension=theme.getTemplateExtension();
  if (extension.equals(ThemeHelper.TEMPLATE_EXTENSION_FTL)) {
    content=ThemeUtil.includeFTL(servletContext,request,pageContext,wrapPage,theme,false);
  }
 else   if (extension.equals(ThemeHelper.TEMPLATE_EXTENSION_VM)) {
    content=ThemeUtil.includeVM(servletContext,request,pageContext,wrapPage,theme,false);
  }
  return _CONTENT_WRAPPER_PRE.concat(content).concat(_CONTENT_WRAPPER_POST);
}
