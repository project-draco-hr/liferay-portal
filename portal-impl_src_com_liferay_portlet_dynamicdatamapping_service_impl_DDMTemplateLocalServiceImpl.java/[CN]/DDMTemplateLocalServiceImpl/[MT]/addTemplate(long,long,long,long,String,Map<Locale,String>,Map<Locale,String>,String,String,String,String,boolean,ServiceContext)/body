{
  User user=userPersistence.findByPrimaryKey(userId);
  Date now=new Date();
  if (Validator.isNull(templateKey)) {
    templateKey=String.valueOf(counterLocalService.increment());
  }
  validate(groupId,templateKey,nameMap,script);
  long templateId=counterLocalService.increment();
  DDMTemplate template=ddmTemplatePersistence.create(templateId);
  template.setUuid(serviceContext.getUuid());
  template.setGroupId(groupId);
  template.setCompanyId(user.getCompanyId());
  template.setUserId(user.getUserId());
  template.setUserName(user.getFullName());
  template.setCreateDate(serviceContext.getCreateDate(now));
  template.setModifiedDate(serviceContext.getModifiedDate(now));
  template.setClassNameId(classNameId);
  template.setClassPK(classPK);
  template.setTemplateKey(templateKey);
  template.setNameMap(nameMap);
  template.setDescriptionMap(descriptionMap);
  template.setType(type);
  template.setMode(mode);
  template.setLanguage(language);
  template.setScript(script);
  template.setCacheable(cacheable);
  ddmTemplatePersistence.update(template);
  if (serviceContext.isAddGroupPermissions() || serviceContext.isAddGuestPermissions()) {
    addTemplateResources(template,serviceContext.isAddGroupPermissions(),serviceContext.isAddGuestPermissions());
  }
 else {
    addTemplateResources(template,serviceContext.getGroupPermissions(),serviceContext.getGuestPermissions());
  }
  return template;
}
