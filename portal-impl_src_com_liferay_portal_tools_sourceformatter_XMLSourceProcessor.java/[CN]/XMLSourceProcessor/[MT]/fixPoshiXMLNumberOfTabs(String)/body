{
  int tabCount=0;
  Pattern pattern=Pattern.compile("\\n*([ \\t]*<).*");
  Matcher matcher=pattern.matcher(content);
  boolean ignoredCdataBlock=false;
  boolean ignoredCommentBlock=false;
  while (matcher.find()) {
    String statement=matcher.group();
    Pattern quoteWithSlashPattern=Pattern.compile("\"[^\"]*\\>[^\"]*\"");
    Matcher quoteWithSlashMatcher=quoteWithSlashPattern.matcher(statement);
    String fixedQuoteStatement=statement;
    if (quoteWithSlashMatcher.find()) {
      fixedQuoteStatement=StringUtil.replace(statement,quoteWithSlashMatcher.group(),"\"\"");
    }
    Pattern closingTagPattern=Pattern.compile("</[^>/]*>");
    Matcher closingTagMatcher=closingTagPattern.matcher(fixedQuoteStatement);
    Pattern openingTagPattern=Pattern.compile("<[^/][^>]*[^/]>");
    Matcher openingTagMatcher=openingTagPattern.matcher(fixedQuoteStatement);
    Pattern wholeTagPattern=Pattern.compile("<[^\\>^/]*\\/>");
    Matcher wholeTagMatcher=wholeTagPattern.matcher(fixedQuoteStatement);
    if (closingTagMatcher.find() && !openingTagMatcher.find() && !wholeTagMatcher.find()&& !statement.contains("<!--")&& !statement.contains("-->")&& !statement.contains("<![CDATA[")&& !statement.contains("]]>")) {
      tabCount--;
    }
    if (statement.contains("]]>")) {
      ignoredCdataBlock=false;
    }
 else     if (statement.contains("<![CDATA[")) {
      ignoredCdataBlock=true;
    }
    if (statement.contains("-->")) {
      ignoredCommentBlock=false;
    }
 else     if (statement.contains("<!--")) {
      ignoredCommentBlock=true;
    }
    if (!ignoredCommentBlock && !ignoredCdataBlock) {
      StringBundler sb=new StringBundler(tabCount + 1);
      for (int i=0; i < tabCount; i++) {
        sb.append(StringPool.TAB);
      }
      sb.append(StringPool.LESS_THAN);
      String newStatement=StringUtil.replace(statement,matcher.group(1),sb.toString());
      content=StringUtil.replaceFirst(content,statement,newStatement);
    }
    if (openingTagMatcher.find() && !closingTagMatcher.find() && !wholeTagMatcher.find()&& !statement.contains("<!--")&& !statement.contains("-->")&& !statement.contains("<![CDATA[")&& !statement.contains("]]>")) {
      tabCount++;
    }
  }
  return content;
}
