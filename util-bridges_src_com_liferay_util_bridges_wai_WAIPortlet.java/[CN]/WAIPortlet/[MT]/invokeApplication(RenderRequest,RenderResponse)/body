{
  HttpServletRequest httpReq=(HttpServletRequest)req.getAttribute(PortletServlet.PORTLET_SERVLET_REQUEST);
  HttpServletResponse httpRes=(HttpServletResponse)req.getAttribute(PortletServlet.PORTLET_SERVLET_RESPONSE);
  String portletName=getPortletConfig().getPortletName();
  String friendlyURL=(String)httpReq.getAttribute("FRIENDLY_URL");
  int pos=friendlyURL.indexOf(_MAPPING);
  StringBuilder contextPath=new StringBuilder();
  contextPath.append(friendlyURL.substring(0,pos + _MAPPING.length()));
  contextPath.append(StringPool.SLASH);
  contextPath.append(portletName);
  pos=friendlyURL.indexOf(portletName);
  String pathInfo=friendlyURL.substring(pos + portletName.length());
  Map<String,String[]> params=new HashMap<String,String[]>(httpReq.getParameterMap());
  params.remove(_APP_URL);
  String queryString=HttpUtil.parameterMapToString(params,false);
  String appUrl=ParamUtil.getString(req,_APP_URL,StringPool.SLASH);
  if (_connector.equals(CONNECTOR_IFRAME)) {
    httpReq.setAttribute(_APP_URL,req.getContextPath() + appUrl);
    String iframeExtraHeight=GetterUtil.getString(getPortletConfig().getInitParameter("wai.connector.iframe.height.extra"),"40");
    req.setAttribute("wai.connector.iframe.height.extra",iframeExtraHeight);
    forward(httpReq,httpRes,_JSP_IFRAME);
  }
 else   if (_connector.equals(CONNECTOR_INCLUDE)) {
    HttpServletRequest waiHttpReq=new WAIHttpServletRequest(httpReq,contextPath.toString(),pathInfo,queryString,params);
    RequestDispatcher rd=httpReq.getRequestDispatcher(appUrl);
    try {
      rd.forward(waiHttpReq,httpRes);
    }
 catch (    ServletException se) {
      throw new PortletException(se);
    }
  }
}
