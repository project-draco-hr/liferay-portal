{
  long groupId=GroupThreadLocal.getGroupId();
  if (groupId != 0) {
    setGroupId(groupId);
    return;
  }
  HttpServletRequest httpServletRequest=PortalUtil.getHttpServletRequest(portletRequest);
  ThemeDisplay themeDisplay=(ThemeDisplay)httpServletRequest.getAttribute(WebKeys.THEME_DISPLAY);
  if (themeDisplay != null) {
    groupId=themeDisplay.getScopeGroupId();
    setGroupId(groupId);
    return;
  }
  try {
    groupId=PortalUtil.getScopeGroupId(portletRequest);
    setGroupId(groupId);
  }
 catch (  PortalException pe) {
    if (_log.isDebugEnabled()) {
      _log.debug("Unable to obtain scope group id",pe);
    }
  }
}
