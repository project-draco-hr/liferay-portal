{
  String servletContextName=servletContext.getServletContextName();
  String globalLibDir=PortalUtil.getGlobalLibDir();
  String portalWebDir=PortalUtil.getPortalWebDir();
  String portalLibDir=PortalUtil.getPortalLibDir();
  String pluginWebDir=WebDirDetector.getRootDir(portletClassLoader);
  if (FileUtil.exists(portalWebDir + _EXT_DEPLOYMENT)) {
    String extServletContextName=FileUtil.read(portalWebDir + _EXT_DEPLOYMENT);
    if (!extServletContextName.equals(servletContextName)) {
      throw new HotDeployException("Not installing extension environment " + servletContextName + " because "+ extServletContextName+ " is already installed");
    }
  }
  copyJar(servletContext,globalLibDir,"ext-service");
  copyJar(servletContext,portalLibDir,"ext-impl");
  copyJar(servletContext,portalLibDir,"ext-util-bridges");
  copyJar(servletContext,portalLibDir,"ext-util-java");
  copyJar(servletContext,portalLibDir,"ext-util-taglib");
  CopyTask.copyDirectory(pluginWebDir + "WEB-INF/ext-web/docroot",portalWebDir,StringPool.BLANK,"**/WEB-INF/web.xml",true,false);
  String tmpDir=SystemProperties.get(SystemProperties.TMP_DIR) + StringPool.SLASH + Time.getTimestamp();
  WebXMLBuilder.main(new String[]{portalWebDir + "WEB-INF/web.xml",pluginWebDir + "WEB-INF/ext-web/docroot/WEB-INF/web.xml",tmpDir + "/web.xml"});
  File portalWebXml=new File(portalWebDir + "WEB-INF/web.xml");
  File tmpWebXml=new File(tmpDir + "/web.xml");
  tmpWebXml.setLastModified(portalWebXml.lastModified());
  CopyTask.copyFile(tmpWebXml,new File(portalWebDir + "WEB-INF"),true,true);
  FileUtil.deltree(tmpDir);
  FileUtil.write(portalWebDir + _EXT_DEPLOYMENT,servletContextName);
  FileUtil.write(pluginWebDir + _EXT_DEPLOYMENT,Time.getTimestamp());
}
