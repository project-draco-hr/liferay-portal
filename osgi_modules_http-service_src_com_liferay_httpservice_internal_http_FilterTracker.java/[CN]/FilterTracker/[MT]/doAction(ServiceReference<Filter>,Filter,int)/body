{
  String pattern=GetterUtil.getString(serviceReference.getProperty("pattern"));
  Map<String,String> initParameters=new HashMap<String,String>();
  if (action != ACTION_REMOVED) {
    for (    String key : serviceReference.getPropertyKeys()) {
      if (key.startsWith("init.")) {
        String value=GetterUtil.getString(serviceReference.getProperty(key));
        initParameters.put(key.substring(5),value);
      }
    }
    int serviceRanking=GetterUtil.getInteger(serviceReference.getProperty("service.ranking"));
    initParameters.put("service.ranking",String.valueOf(serviceRanking));
  }
  Bundle bundle=serviceReference.getBundle();
  try {
    BundleServletContext bundleServletContext=_httpSupport.getBundleServletContext(bundle);
    if (action != ACTION_ADDING) {
      bundleServletContext.unregisterFilter(pattern);
    }
    if (action != ACTION_REMOVED) {
      String contextId=GetterUtil.getString(serviceReference.getProperty("contextId"));
      HttpContext httpContext=_httpSupport.getHttpContext(contextId);
      if (httpContext == null) {
        httpContext=bundleServletContext.getHttpContext();
      }
      bundleServletContext.registerFilter(pattern,filter,initParameters,httpContext);
    }
  }
 catch (  Exception e) {
    _log.error(e);
  }
  return filter;
}
