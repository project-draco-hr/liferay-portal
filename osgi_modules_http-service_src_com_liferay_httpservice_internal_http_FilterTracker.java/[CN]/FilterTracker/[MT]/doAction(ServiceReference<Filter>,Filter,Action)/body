{
  String pattern=GetterUtil.getString(serviceReference.getProperty("pattern"));
  Map<String,String> initParameters=new Hashtable<String,String>();
  if (action != Action.REMOVED) {
    for (    String key : serviceReference.getPropertyKeys()) {
      if (key.startsWith(HttpServicePropsKeys.INIT_PREFIX)) {
        String value=GetterUtil.getString(serviceReference.getProperty(key));
        initParameters.put(key.substring(HttpServicePropsKeys.INIT_PREFIX.length()),value);
      }
    }
    int serviceRanking=GetterUtil.getInteger(serviceReference.getProperty(HttpServicePropsKeys.SERVICE_RANKING));
    initParameters.put(HttpServicePropsKeys.SERVICE_RANKING,String.valueOf(serviceRanking));
  }
  Bundle bundle=serviceReference.getBundle();
  try {
    BundleServletContext bundleServletContext=_httpSupport.getBundleServletContext(bundle);
    if (action != Action.ADDING) {
      bundleServletContext.unregisterFilter(pattern);
    }
    if (action != Action.REMOVED) {
      String contextId=GetterUtil.getString(serviceReference.getProperty(HttpServicePropsKeys.CONTEXT_ID));
      HttpContext httpContext=_httpSupport.getHttpContext(contextId);
      if (httpContext == null) {
        httpContext=bundleServletContext.getHttpContext();
      }
      bundleServletContext.registerFilter(pattern,filter,initParameters,httpContext);
    }
  }
 catch (  Exception e) {
    _log.error(e);
  }
  return filter;
}
