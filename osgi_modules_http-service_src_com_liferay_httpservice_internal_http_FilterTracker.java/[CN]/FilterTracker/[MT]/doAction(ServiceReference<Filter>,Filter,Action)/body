{
  String contextId=GetterUtil.getString(reference.getProperty(HttpServicePropsKeys.CONTEXT_ID));
  String pattern=GetterUtil.getString(reference.getProperty("pattern"));
  int serviceRanking=GetterUtil.getInteger(reference.getProperty(HttpServicePropsKeys.SERVICE_RANKING));
  Hashtable<String,String> initParameters=new Hashtable<String,String>();
  if (action != Action.REMOVED) {
    for (    String key : reference.getPropertyKeys()) {
      if (key.startsWith(HttpServicePropsKeys.INIT_PREFIX)) {
        String value=GetterUtil.getString(reference.getProperty(key));
        initParameters.put(key.substring(HttpServicePropsKeys.INIT_PREFIX.length()),value);
      }
    }
    initParameters.put(HttpServicePropsKeys.SERVICE_RANKING,String.valueOf(serviceRanking));
  }
  Bundle bundle=reference.getBundle();
  try {
    BundleServletContext servletContext=_httpSupport.getServletContext(bundle);
    if (action != Action.ADDING) {
      servletContext.unregisterFilter(pattern);
    }
    if (action != Action.REMOVED) {
      HttpContext httpContext=_httpSupport.getHttpContext(contextId);
      if (httpContext == null) {
        httpContext=servletContext.getHttpContext();
      }
      servletContext.registerFilter(pattern,filter,initParameters,httpContext);
    }
  }
 catch (  Exception e) {
    _log.error(e);
  }
  return filter;
}
