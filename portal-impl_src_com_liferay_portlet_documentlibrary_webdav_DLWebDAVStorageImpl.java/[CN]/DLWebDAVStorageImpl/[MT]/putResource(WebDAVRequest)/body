{
  File file=null;
  try {
    HttpServletRequest request=webDAVRequest.getHttpServletRequest();
    String[] pathArray=webDAVRequest.getPathArray();
    long companyId=webDAVRequest.getCompanyId();
    long groupId=webDAVRequest.getGroupId();
    long parentFolderId=getParentFolderId(companyId,pathArray);
    String title=WebDAVUtil.getResourceName(pathArray);
    String description=StringPool.BLANK;
    String changeLog=StringPool.BLANK;
    ServiceContext serviceContext=ServiceContextFactory.getInstance(request);
    serviceContext.setAddGroupPermissions(isAddGroupPermissions(groupId));
    serviceContext.setAddGuestPermissions(true);
    String extension=FileUtil.getExtension(title);
    file=FileUtil.createTempFile(extension);
    FileUtil.write(file,request.getInputStream());
    String contentType=getContentType(request,file,title,extension);
    try {
      FileEntry fileEntry=DLAppServiceUtil.getFileEntry(groupId,parentFolderId,title);
      if (!hasLock(fileEntry,webDAVRequest.getLockUuid()) && (fileEntry.getLock() != null)) {
        return WebDAVUtil.SC_LOCKED;
      }
      long fileEntryId=fileEntry.getFileEntryId();
      description=fileEntry.getDescription();
      populateServiceContext(serviceContext,fileEntry);
      serviceContext.setCommand(Constants.UPDATE_WEBDAV);
      DLAppServiceUtil.updateFileEntry(fileEntryId,title,contentType,title,description,changeLog,false,file,serviceContext);
    }
 catch (    NoSuchFileEntryException nsfee) {
      serviceContext.setCommand(Constants.ADD_WEBDAV);
      DLAppServiceUtil.addFileEntry(groupId,parentFolderId,title,contentType,title,description,changeLog,file,serviceContext);
    }
    if (_log.isInfoEnabled()) {
      _log.info("Added " + StringUtil.merge(pathArray,StringPool.SLASH));
    }
    return HttpServletResponse.SC_CREATED;
  }
 catch (  FileSizeException fse) {
    return HttpServletResponse.SC_REQUEST_ENTITY_TOO_LARGE;
  }
catch (  NoSuchFolderException nsfe) {
    return HttpServletResponse.SC_CONFLICT;
  }
catch (  PrincipalException pe) {
    return HttpServletResponse.SC_FORBIDDEN;
  }
catch (  PortalException pe) {
    if (_log.isWarnEnabled()) {
      _log.warn(pe,pe);
    }
    return HttpServletResponse.SC_CONFLICT;
  }
catch (  Exception e) {
    throw new WebDAVException(e);
  }
 finally {
    FileUtil.delete(file);
  }
}
