{
  UploadPortletRequest uploadPortletRequest=PortalUtil.getUploadPortletRequest(portletRequest);
  ThemeDisplay themeDisplay=(ThemeDisplay)portletRequest.getAttribute(WebKeys.THEME_DISPLAY);
  String contentType=uploadPortletRequest.getContentType("fileName");
  if (!MimeTypesUtil.isWebImage(contentType)) {
    throw new ImageTypeException();
  }
  String fileName=uploadPortletRequest.getFileName("fileName");
  try {
    TempFileEntryUtil.deleteTempFileEntry(themeDisplay.getScopeGroupId(),themeDisplay.getUserId(),getTempImageFolderName(),fileName);
  }
 catch (  Exception e) {
  }
  InputStream inputStream=null;
  try {
    inputStream=uploadPortletRequest.getFileAsStream("fileName");
    return TempFileEntryUtil.addTempFileEntry(themeDisplay.getScopeGroupId(),themeDisplay.getUserId(),fileName,getTempImageFolderName(),inputStream,contentType);
  }
  finally {
    StreamUtil.cleanUp(inputStream);
  }
}
