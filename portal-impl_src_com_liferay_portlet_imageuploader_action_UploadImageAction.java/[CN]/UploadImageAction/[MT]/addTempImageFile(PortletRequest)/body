{
  UploadPortletRequest uploadPortletRequest=PortalUtil.getUploadPortletRequest(portletRequest);
  ThemeDisplay themeDisplay=(ThemeDisplay)portletRequest.getAttribute(WebKeys.THEME_DISPLAY);
  String contentType=uploadPortletRequest.getContentType("fileName");
  if (!MimeTypesUtil.isWebImage(contentType)) {
    throw new ImageTypeException();
  }
  String sourceFileName=uploadPortletRequest.getFileName("fileName");
  sourceFileName=getTempImageFileName(portletRequest).concat(StringPool.UNDERLINE).concat(sourceFileName);
  try {
    TempFileUtil.deleteTempFile(themeDisplay.getScopeGroupId(),themeDisplay.getUserId(),sourceFileName,getTempImageFolderName());
  }
 catch (  Exception e) {
  }
  InputStream inputStream=null;
  try {
    inputStream=uploadPortletRequest.getFileAsStream("fileName");
    return TempFileUtil.addTempFile(themeDisplay.getScopeGroupId(),themeDisplay.getUserId(),sourceFileName,getTempImageFolderName(),inputStream,contentType);
  }
  finally {
    StreamUtil.cleanUp(inputStream);
  }
}
