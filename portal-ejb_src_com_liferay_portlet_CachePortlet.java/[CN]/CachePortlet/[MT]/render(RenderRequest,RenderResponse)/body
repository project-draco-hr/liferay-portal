{
  long start=0;
  if (_log.isDebugEnabled()) {
    start=System.currentTimeMillis();
  }
  String userId=req.getRemoteUser();
  if ((userId == null) || (_expCache == null) || (_expCache.intValue() == 0)) {
    _invoke(req,res,false);
  }
 else {
    RenderResponseImpl resImpl=(RenderResponseImpl)res;
    StringServletResponse stringServletRes=(StringServletResponse)resImpl.getHttpServletResponse();
    PortletSession ses=req.getPortletSession();
    long now=System.currentTimeMillis();
    Layout layout=(Layout)req.getAttribute(WebKeys.LAYOUT);
    Map sesResponses=getResponses(ses);
    String sesResponseId=layout.getLayoutId() + StringPool.UNDERLINE + _portletId;
    CachePortletResponse response=(CachePortletResponse)sesResponses.get(sesResponseId);
    if (response == null) {
      _invoke(req,res,false);
      response=new CachePortletResponse(resImpl.getTitle(),stringServletRes.getString(),now + Time.SECOND * _expCache.intValue());
      sesResponses.put(sesResponseId,response);
    }
 else     if ((response.getTime() < now) && (_expCache.intValue() > 0)) {
      _invoke(req,res,false);
      response.setTitle(resImpl.getTitle());
      response.setContent(stringServletRes.getString());
      response.setTime(now + Time.SECOND * _expCache.intValue());
    }
 else {
      resImpl.setTitle(response.getTitle());
      stringServletRes.getWriter().print(response.getContent());
    }
  }
  if (_log.isDebugEnabled()) {
    long end=System.currentTimeMillis();
    _log.debug("render for " + _portletId + " takes "+ (end - start)+ " ms");
  }
}
