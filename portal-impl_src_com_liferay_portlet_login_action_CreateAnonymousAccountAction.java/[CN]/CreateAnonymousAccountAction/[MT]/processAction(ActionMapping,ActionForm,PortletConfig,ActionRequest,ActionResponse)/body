{
  ThemeDisplay themeDisplay=(ThemeDisplay)actionRequest.getAttribute(WebKeys.THEME_DISPLAY);
  if (actionRequest.getRemoteUser() != null) {
    actionResponse.sendRedirect(themeDisplay.getPathMain());
    return;
  }
  String cmd=ParamUtil.getString(actionRequest,Constants.CMD);
  String emailAddress=ParamUtil.getString(actionRequest,"emailAddress");
  PortletURL portletURL=PortletURLFactoryUtil.create(actionRequest,PortletKeys.LOGIN,themeDisplay.getPlid(),PortletRequest.RENDER_PHASE);
  portletURL.setWindowState(LiferayWindowState.POP_UP);
  portletURL.setParameter("struts_action","/login/login_redirect");
  portletURL.setParameter("emailAddress",emailAddress);
  portletURL.setParameter("anonymousAccount",Boolean.TRUE.toString());
  JSONObject jsonObject=JSONFactoryUtil.createJSONObject();
  try {
    if (cmd.equals(Constants.ADD)) {
      addAnonymousUser(actionRequest,actionResponse);
      sendRedirect(actionRequest,actionResponse,portletURL.toString());
    }
 else     if (cmd.equals(Constants.UPDATE)) {
      jsonObject=updateIncompleteUser(actionRequest,actionResponse);
      writeJSON(actionRequest,actionResponse,jsonObject);
    }
  }
 catch (  Exception e) {
    if (cmd.equals(Constants.UPDATE)) {
      jsonObject.putException(e);
      writeJSON(actionRequest,actionResponse,jsonObject);
    }
    if (e instanceof DuplicateUserEmailAddressException) {
      User user=UserLocalServiceUtil.getUserByEmailAddress(themeDisplay.getCompanyId(),emailAddress);
      if (user.getStatus() != WorkflowConstants.STATUS_INCOMPLETE) {
        SessionErrors.add(actionRequest,e.getClass().getName());
      }
 else {
        sendRedirect(actionRequest,actionResponse,portletURL.toString());
      }
    }
 else     if (e instanceof CaptchaTextException || e instanceof CompanyMaxUsersException || e instanceof ContactFirstNameException|| e instanceof ContactFullNameException|| e instanceof ContactLastNameException|| e instanceof EmailAddressException|| e instanceof ReservedUserEmailAddressException|| e instanceof UserEmailAddressException) {
      SessionErrors.add(actionRequest,e.getClass().getName(),e);
    }
 else {
      _log.error("Unable to create anonymous account",e);
      PortalUtil.sendError(e,actionRequest,actionResponse);
    }
  }
}
