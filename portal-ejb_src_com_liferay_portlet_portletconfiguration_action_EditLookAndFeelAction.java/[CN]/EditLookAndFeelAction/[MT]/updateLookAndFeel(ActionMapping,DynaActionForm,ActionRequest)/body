{
  HttpServletRequest httpReq=PortalUtil.getHttpServletRequest(req);
  HttpSession httpSes=httpReq.getSession();
  String cmd=ParamUtil.getString(req,Constants.CMD);
  ThemeDisplay themeDisplay=(ThemeDisplay)req.getAttribute(WebKeys.THEME_DISPLAY);
  Layout layout=themeDisplay.getLayout();
  String portletResource=ParamUtil.getString(req,"portletResource");
  PortletPreferences portletSetup=PortletPreferencesFactory.getPortletSetup(req,portletResource,true,true);
  String languageId=ParamUtil.getString(req,"curLanguageId");
  String title=ParamUtil.getString(req,"title");
  boolean useCustomTitle=ParamUtil.getBoolean(req,"useCustomTitle");
  boolean showBorders=ParamUtil.getBoolean(req,"showBorders");
  if (cmd.equals(Constants.RESET)) {
    form.initialize(mapping);
    Enumeration enu=portletSetup.getNames();
    while (enu.hasMoreElements()) {
      String name=(String)enu.nextElement();
      if (name.startsWith("portlet-setup-title-")) {
        portletSetup.setValue(name,StringPool.BLANK);
      }
    }
    title=StringPool.BLANK;
    useCustomTitle=false;
    showBorders=true;
  }
  StringMaker sm=new StringMaker();
  Map styleMap=form.getMap();
  Iterator itr=styleMap.keySet().iterator();
  while (itr.hasNext()) {
    String key=(String)itr.next();
    if (!key.startsWith("list")) {
      String value=form.getString(key);
      if (Validator.isNotNull(value)) {
        sm.append(key);
        sm.append("=");
        sm.append(value);
        sm.append("\n");
      }
    }
  }
  portletSetup.setValue("portlet-setup-title-" + languageId,title);
  portletSetup.setValue("portlet-setup-use-custom-title",String.valueOf(useCustomTitle));
  portletSetup.setValue("portlet-setup-show-borders",String.valueOf(showBorders));
  portletSetup.setValue("portlet-setup-css",sm.toString());
  portletSetup.store();
  CachePortlet.clearResponse(httpSes,layout.getPrimaryKey(),portletResource);
}
