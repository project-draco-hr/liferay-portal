{
  UploadPortletRequest uploadRequest=PortalUtil.getUploadPortletRequest(actionRequest);
  ThemeDisplay themeDisplay=(ThemeDisplay)actionRequest.getAttribute(WebKeys.THEME_DISPLAY);
  long imageId=ParamUtil.getLong(uploadRequest,"imageId");
  long groupId=themeDisplay.getScopeGroupId();
  long folderId=ParamUtil.getLong(uploadRequest,"folderId");
  String name=ParamUtil.getString(uploadRequest,"name");
  String fileName=uploadRequest.getFileName("file");
  String description=ParamUtil.getString(uploadRequest,"description",fileName);
  File file=uploadRequest.getFile("file");
  String contentType=getContentType(uploadRequest,file);
  if (contentType.equals(ContentTypes.APPLICATION_OCTET_STREAM)) {
    String ext=GetterUtil.getString(FileUtil.getExtension(file.getName())).toLowerCase();
    if (Validator.isNotNull(ext)) {
      contentType=MimeTypesUtil.getContentType(ext);
    }
  }
  ServiceContext serviceContext=ServiceContextFactory.getInstance(IGImage.class.getName(),actionRequest);
  if (imageId <= 0) {
    if (Validator.isNull(name)) {
      name=fileName;
    }
    IGImage image=IGImageServiceUtil.addImage(groupId,folderId,name,description,file,contentType,serviceContext);
    AssetPublisherUtil.addAndStoreSelection(actionRequest,IGImage.class.getName(),image.getImageId(),-1);
  }
 else {
    if (Validator.isNull(fileName)) {
      file=null;
    }
    IGImageServiceUtil.updateImage(imageId,groupId,folderId,name,description,file,contentType,serviceContext);
  }
  AssetPublisherUtil.addRecentFolderId(actionRequest,IGImage.class.getName(),folderId);
}
