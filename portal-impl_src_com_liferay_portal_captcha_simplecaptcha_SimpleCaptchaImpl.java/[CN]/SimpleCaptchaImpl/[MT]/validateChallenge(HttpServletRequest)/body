{
  HttpSession session=request.getSession();
  String captchaText=(String)session.getAttribute(WebKeys.CAPTCHA_TEXT);
  if (request instanceof UploadPortletRequest) {
    UploadPortletRequest uploadPortletRequest=(UploadPortletRequest)request;
    PortletRequest portletRequest=uploadPortletRequest.getPortletRequest();
    PortletSession portletSession=portletRequest.getPortletSession();
    captchaText=(String)portletSession.getAttribute(WebKeys.CAPTCHA_TEXT);
  }
  if (captchaText == null) {
    _log.error("CAPTCHA text is null. User " + request.getRemoteUser() + " may be trying to circumvent the CAPTCHA.");
    throw new CaptchaTextException();
  }
  boolean valid=captchaText.equals(ParamUtil.getString(request,"captchaText"));
  if (valid) {
    if (request instanceof UploadPortletRequest) {
      UploadPortletRequest uploadPortletRequest=(UploadPortletRequest)request;
      PortletRequest portletRequest=uploadPortletRequest.getPortletRequest();
      PortletSession portletSession=portletRequest.getPortletSession();
      portletSession.removeAttribute(WebKeys.CAPTCHA_TEXT);
    }
 else {
      session.removeAttribute(WebKeys.CAPTCHA_TEXT);
    }
  }
  return valid;
}
