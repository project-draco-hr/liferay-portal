{
  Set<Reader> readers=new HashSet<Reader>();
  try {
    if (templateResource == null) {
      throw new Exception("Unable to find template resource with templateId " + templateResource.getTemplateId());
    }
    Reader reader=templateResource.getReader();
    if (reader == null) {
      throw new Exception("Unable to find template resource with templateId " + templateResource.getTemplateId());
    }
    readers.add(reader);
    freemarker.template.Template template=new freemarker.template.Template(templateResource.getTemplateId(),reader,_configuration,TemplateResource.DEFAUT_ENCODING);
    Environment environment=template.createProcessingEnvironment(_context,writer,null);
    _importLibrary(environment,readers);
    environment.process();
  }
  finally {
    for (    Reader reader : readers) {
      reader.close();
    }
  }
}
