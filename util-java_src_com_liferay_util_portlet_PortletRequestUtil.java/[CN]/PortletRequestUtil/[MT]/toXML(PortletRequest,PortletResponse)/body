{
  String xml=null;
  Document doc=DocumentHelper.createDocument();
  Element reqEl=doc.addElement("request");
  DocUtil.add(reqEl,"container-type","portlet");
  DocUtil.add(reqEl,"container-namespace",req.getContextPath());
  DocUtil.add(reqEl,"content-type",req.getResponseContentType());
  DocUtil.add(reqEl,"server-name",req.getServerName());
  DocUtil.add(reqEl,"server-port",req.getServerPort());
  DocUtil.add(reqEl,"secure",req.isSecure());
  DocUtil.add(reqEl,"auth-type",req.getAuthType());
  DocUtil.add(reqEl,"remote-user",req.getRemoteUser());
  DocUtil.add(reqEl,"context-path",req.getContextPath());
  DocUtil.add(reqEl,"locale",req.getLocale());
  DocUtil.add(reqEl,"portlet-mode",req.getPortletMode());
  DocUtil.add(reqEl,"portlet-session-id",req.getRequestedSessionId());
  DocUtil.add(reqEl,"scheme",req.getScheme());
  DocUtil.add(reqEl,"window-state",req.getWindowState());
  if (req instanceof RenderRequest) {
    DocUtil.add(reqEl,"action",Boolean.FALSE);
  }
 else   if (req instanceof ActionRequest) {
    DocUtil.add(reqEl,"action",Boolean.TRUE);
  }
  if (res instanceof RenderResponse) {
    _renderResponseToXML((RenderResponse)res,reqEl);
  }
  Element parametersEl=reqEl.addElement("parameters");
  Enumeration<String> enu=req.getParameterNames();
  while (enu.hasMoreElements()) {
    String name=enu.nextElement();
    Element parameterEl=parametersEl.addElement("parameter");
    DocUtil.add(parameterEl,"name",name);
    String[] values=req.getParameterValues(name);
    for (int i=0; i < values.length; i++) {
      DocUtil.add(parameterEl,"value",values[i]);
    }
  }
  Element attributesEl=reqEl.addElement("attributes");
  enu=req.getAttributeNames();
  while (enu.hasMoreElements()) {
    String name=enu.nextElement();
    if (!_isValidAttributeName(name)) {
      continue;
    }
    Object value=req.getAttribute(name);
    if (!_isValidAttributeValue(value)) {
      continue;
    }
    Element attributeEl=attributesEl.addElement("attribute");
    DocUtil.add(attributeEl,"name",name);
    DocUtil.add(attributeEl,"value",String.valueOf(value));
  }
  Element portletSessionEl=reqEl.addElement("portlet-session");
  attributesEl=portletSessionEl.addElement("portlet-attributes");
  PortletSession ses=req.getPortletSession();
  enu=ses.getAttributeNames(PortletSession.PORTLET_SCOPE);
  while (enu.hasMoreElements()) {
    String name=enu.nextElement();
    if (!_isValidAttributeName(name)) {
      continue;
    }
    Object value=ses.getAttribute(name,PortletSession.PORTLET_SCOPE);
    if (!_isValidAttributeValue(value)) {
      continue;
    }
    Element attributeEl=attributesEl.addElement("attribute");
    DocUtil.add(attributeEl,"name",name);
    DocUtil.add(attributeEl,"value",String.valueOf(value));
  }
  attributesEl=portletSessionEl.addElement("application-attributes");
  enu=ses.getAttributeNames(PortletSession.APPLICATION_SCOPE);
  while (enu.hasMoreElements()) {
    String name=enu.nextElement();
    if (!_isValidAttributeName(name)) {
      continue;
    }
    Object value=ses.getAttribute(name,PortletSession.APPLICATION_SCOPE);
    if (!_isValidAttributeValue(value)) {
      continue;
    }
    Element attributeEl=attributesEl.addElement("attribute");
    DocUtil.add(attributeEl,"name",name);
    DocUtil.add(attributeEl,"value",String.valueOf(value));
  }
  try {
    xml=XMLFormatter.toString(doc);
  }
 catch (  IOException ioe) {
  }
  return xml;
}
