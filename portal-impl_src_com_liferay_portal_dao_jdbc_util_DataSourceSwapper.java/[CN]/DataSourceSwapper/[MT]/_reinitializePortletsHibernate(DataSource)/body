{
  List<PortletSessionFactoryImpl> portletSessionFactoryImpls=SessionFactoryImpl.getPortletSessionFactories();
  for (  PortletSessionFactoryImpl portletSessionFactoryImpl : portletSessionFactoryImpls) {
    ClassLoader oldPortletClassLoader=PortletClassLoaderUtil.getClassLoader();
    ClassLoader portletClassLoader=portletSessionFactoryImpl.getSessionFactoryClassLoader();
    PortletClassLoaderUtil.setClassLoader(portletClassLoader);
    ClassLoader contextClassLoader=PACLClassLoaderUtil.getContextClassLoader();
    PACLClassLoaderUtil.setContextClassLoader(portletClassLoader);
    try {
      PortletHibernateConfiguration portletHibernateConfiguration=new PortletHibernateConfiguration();
      portletHibernateConfiguration.setDataSource(newDataSource);
      portletHibernateConfiguration.afterPropertiesSet();
      SessionFactoryImplementor sessionFactoryImplementor=(SessionFactoryImplementor)portletHibernateConfiguration.getObject();
      portletSessionFactoryImpl.setSessionFactoryImplementor(sessionFactoryImplementor);
    }
  finally {
      PortletClassLoaderUtil.setClassLoader(oldPortletClassLoader);
      PACLClassLoaderUtil.setContextClassLoader(contextClassLoader);
    }
  }
}
