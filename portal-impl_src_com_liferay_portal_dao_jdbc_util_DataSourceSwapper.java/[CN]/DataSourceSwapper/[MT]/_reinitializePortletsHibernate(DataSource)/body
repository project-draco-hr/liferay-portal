{
  List<PortletSessionFactoryImpl> portletSessionFactoryImpls=SessionFactoryImpl.getPortletSessionFactories();
  for (  PortletSessionFactoryImpl portletSessionFactoryImpl : portletSessionFactoryImpls) {
    ClassLoader oldPortletClassLoader=PortletClassLoaderUtil.getClassLoader();
    ClassLoader portletClassLoader=portletSessionFactoryImpl.getSessionFactoryClassLoader();
    Thread currentThread=Thread.currentThread();
    PortletClassLoaderUtil.setClassLoader(currentThread.getId(),portletClassLoader);
    ClassLoader oldContextClassLoader=currentThread.getContextClassLoader();
    currentThread.setContextClassLoader(portletClassLoader);
    try {
      PortletHibernateConfiguration portletHibernateConfiguration=new PortletHibernateConfiguration();
      portletHibernateConfiguration.setDataSource(newDataSource);
      portletHibernateConfiguration.afterPropertiesSet();
      SessionFactoryImplementor sessionFactoryImplementor=(SessionFactoryImplementor)portletHibernateConfiguration.getObject();
      portletSessionFactoryImpl.setSessionFactoryImplementor(sessionFactoryImplementor);
    }
  finally {
      PortletClassLoaderUtil.setClassLoader(currentThread.getId(),oldPortletClassLoader);
      currentThread.setContextClassLoader(oldContextClassLoader);
    }
  }
}
