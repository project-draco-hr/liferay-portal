{
  ThemeDisplay themeDisplay=(ThemeDisplay)actionRequest.getAttribute(WebKeys.THEME_DISPLAY);
  ShoppingCart cart=ShoppingUtil.getCart(actionRequest);
  ShoppingGroupServiceOverriddenConfiguration shoppingGroupServiceOverriddenConfiguration=ConfigurationProviderUtil.getConfiguration(ShoppingGroupServiceOverriddenConfiguration.class,new GroupServiceSettingsLocator(themeDisplay.getScopeGroupId(),ShoppingConstants.SERVICE_NAME));
  String returnURL=ShoppingUtil.getPayPalReturnURL(((ActionResponseImpl)actionResponse).createActionURL(),order);
  String notifyURL=ShoppingUtil.getPayPalNotifyURL(themeDisplay);
  if (shoppingGroupServiceOverriddenConfiguration.usePayPal()) {
    double total=ShoppingUtil.calculateTotal(cart.getItems(),order.getBillingState(),cart.getCoupon(),cart.getAltShipping(),cart.isInsure());
    String redirectURL=ShoppingUtil.getPayPalRedirectURL(shoppingGroupServiceOverriddenConfiguration,order,total,returnURL,notifyURL);
    actionResponse.sendRedirect(redirectURL);
  }
 else {
    ServiceContext serviceContext=ServiceContextFactory.getInstance(actionRequest);
    ShoppingOrderLocalServiceUtil.sendEmail(order,"confirmation",serviceContext);
    actionResponse.sendRedirect(returnURL);
  }
}
