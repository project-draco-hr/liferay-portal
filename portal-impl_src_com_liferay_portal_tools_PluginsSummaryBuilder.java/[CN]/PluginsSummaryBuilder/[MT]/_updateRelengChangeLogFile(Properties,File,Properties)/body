{
  StringBundler sb=new StringBundler();
  int changeLogVersion=0;
  int moduleIncrementalVersion=GetterUtil.getInteger(pluginPackageProperties.getProperty("module-incremental-version"));
  if (!relengChangeLogFile.exists()) {
    FileUtil.write(relengChangeLogFile,"TEMP=");
  }
  String relengChangeLogContent=FileUtil.read(relengChangeLogFile);
  List<String> relengChangeLogEntries=new ArrayList<String>();
  String[] relengChangeLogEntriesArray=StringUtil.split(relengChangeLogContent,"\n");
  for (int i=0; i < relengChangeLogEntriesArray.length; i++) {
    String relengChangeLogEntry=relengChangeLogEntriesArray[i];
    if (Validator.isNull(relengChangeLogEntry) || relengChangeLogEntry.startsWith("#")) {
      continue;
    }
    relengChangeLogEntries.add(relengChangeLogEntry);
    if (((i + 1) == relengChangeLogEntriesArray.length) && !relengChangeLogEntry.contains("HEAD=") && !relengChangeLogEntry.contains("TEMP=")&& !relengChangeLogEntry.contains(_latestHASH)&& !relengChangeLogEntries.isEmpty()) {
      int x=relengChangeLogEntry.indexOf("..");
      int y=relengChangeLogEntry.indexOf("=",x);
      String range=relengChangeLogEntry.substring(x + 2,y) + "^.." + _latestHASH;
      relengChangeLogEntries.add(range);
      continue;
    }
  }
  File webInfDir=relengChangeLogFile.getParentFile();
  File docrootDir=webInfDir.getParentFile();
  File pluginDir=docrootDir.getParentFile();
  for (int i=0; i < relengChangeLogEntries.size(); i++) {
    String relengChangeLogEntry=relengChangeLogEntries.get(i);
    String[] relengChangeLogEntryParts=StringUtil.split(relengChangeLogEntry,"=");
    String range=relengChangeLogEntryParts[0];
    if (range.equals("TEMP")) {
      changeLogVersion++;
      sb.append(_getChangeLogEntry(changeLogVersion,range,StringPool.BLANK));
      break;
    }
    Set<String> ticketIds=_extractTicketIds(pluginDir,range);
    if (range.endsWith("^.." + _latestHASH) && ticketIds.isEmpty() && (relengChangeLogEntries.size() > 1)) {
      continue;
    }
    if (ticketIds.isEmpty()) {
      System.out.println(pluginDir + " does not have changes for range " + range);
    }
    String[] dependentApps=StringUtil.split(relengProperties.getProperty("dependent-apps"));
    for (    String dependentApp : dependentApps) {
      dependentApp=dependentApp.trim();
      if (dependentApp.equals("resources-impoter-web")) {
        continue;
      }
      String dependentAppDirName=null;
      if (dependentApp.endsWith("-hook")) {
        dependentAppDirName="hooks";
      }
 else       if (dependentApp.endsWith("-layouttpl")) {
        dependentAppDirName="layouttpl";
      }
 else       if (dependentApp.endsWith("-portlet")) {
        dependentAppDirName="portlets";
      }
 else       if (dependentApp.endsWith("-theme")) {
        dependentAppDirName="themes";
      }
 else       if (dependentApp.endsWith("-web")) {
        dependentAppDirName="webs";
      }
      File dependentAppDir=new File(_pluginsDir,dependentAppDirName + "/" + dependentApp);
      if (!dependentAppDir.exists()) {
        throw new RuntimeException(dependentAppDir + " does not exist");
      }
      ticketIds.addAll(_extractTicketIds(dependentAppDir,range));
    }
    String ticketIdsString=StringUtil.merge(ticketIds.toArray(new String[ticketIds.size()])," ");
    changeLogVersion++;
    sb.append(_getChangeLogEntry(changeLogVersion,range,ticketIdsString));
  }
  File pluginPackagePropertiesFile=new File(webInfDir,"liferay-plugin-package.properties");
  String pluginPackagePropertiesContent=FileUtil.read(pluginPackagePropertiesFile);
  if (!pluginPackagePropertiesContent.contains("long-description")) {
    int x=pluginPackagePropertiesContent.indexOf("change-log=");
    pluginPackagePropertiesContent=pluginPackagePropertiesContent.substring(0,x) + "long-description=\n" + pluginPackagePropertiesContent.substring(x);
  }
  if (moduleIncrementalVersion != changeLogVersion) {
    pluginPackagePropertiesContent=StringUtil.replace(pluginPackagePropertiesContent,"module-incremental-version=" + moduleIncrementalVersion,"module-incremental-version=" + changeLogVersion);
  }
  FileUtil.write(pluginPackagePropertiesFile,pluginPackagePropertiesContent);
  FileUtil.write(relengChangeLogFile,sb.toString());
  File relengChangeLogHASHFile=new File(webInfDir,"liferay-releng.changelog.HASH");
  String checksum=FileUtil.getMD5Checksum(relengChangeLogFile);
  FileUtil.write(relengChangeLogHASHFile,checksum);
}
