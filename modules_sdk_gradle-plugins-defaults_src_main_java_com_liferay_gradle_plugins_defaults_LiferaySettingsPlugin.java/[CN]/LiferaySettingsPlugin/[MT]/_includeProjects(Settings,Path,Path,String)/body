{
  final Set<Path> excludedDirPaths=getDirPaths("build.exclude.dirs",rootDirPath);
  final Set<ProjectDirType> excludedProjectDirTypes=_getFlags("build.exclude.",ProjectDirType.class);
  final boolean portalBuild=Boolean.getBoolean("portal.build");
  final boolean portalPreBuild=Boolean.getBoolean("portal.pre.build");
  Files.walkFileTree(rootDirPath,new SimpleFileVisitor<Path>(){
    @Override public FileVisitResult preVisitDirectory(    Path dirPath,    BasicFileAttributes basicFileAttributes){
      if (dirPath.equals(rootDirPath)) {
        return FileVisitResult.CONTINUE;
      }
      if (excludedDirPaths.contains(dirPath)) {
        return FileVisitResult.SKIP_SUBTREE;
      }
      ProjectDirType projectDirType=_getProjectDirType(dirPath);
      if (projectDirType == ProjectDirType.UNKNOWN) {
        return FileVisitResult.CONTINUE;
      }
      if (excludedProjectDirTypes.contains(projectDirType)) {
        return FileVisitResult.SKIP_SUBTREE;
      }
      if (portalBuild && Files.notExists(dirPath.resolve(".lfrbuild-portal"))) {
        return FileVisitResult.SKIP_SUBTREE;
      }
      if (portalPreBuild && Files.notExists(dirPath.resolve(".lfrbuild-portal-pre"))) {
        return FileVisitResult.SKIP_SUBTREE;
      }
      _includeProject(settings,dirPath,projectPathRootDirPath,projectPathPrefix);
      return FileVisitResult.SKIP_SUBTREE;
    }
  }
);
}
