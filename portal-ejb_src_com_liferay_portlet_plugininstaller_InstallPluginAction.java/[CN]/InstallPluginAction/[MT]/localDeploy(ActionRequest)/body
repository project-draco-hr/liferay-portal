{
  UploadPortletRequest uploadReq=PortalUtil.getUploadPortletRequest(req);
  String fileName=null;
  String deploymentContext=ParamUtil.getString(req,"deploymentContext");
  if (Validator.isNotNull(deploymentContext)) {
    fileName=Constants.DEPLOY_TO_PREFIX + deploymentContext + ".war";
  }
 else {
    fileName=uploadReq.getFileName("file");
    deploymentContext=fileName.substring(0,fileName.length() - 4);
  }
  File file=uploadReq.getFile("file");
  PluginPackageUtil.registerInstallingPluginPackage(deploymentContext);
  try {
    byte[] bytes=FileUtil.getBytes(file);
    if ((bytes != null) && (bytes.length > 0)) {
      String source=file.toString();
      String deployDir=PrefsPropsUtil.getString(PropsUtil.AUTO_DEPLOY_DEPLOY_DIR);
      String destination=deployDir + StringPool.SLASH + fileName;
      FileUtil.copyFile(source,destination);
      SessionMessages.add(req,"pluginUploaded");
    }
 else {
      PluginPackageUtil.endPluginPackageInstallation(deploymentContext);
      SessionErrors.add(req,UploadException.class.getName());
    }
  }
 catch (  Exception e) {
    PluginPackageUtil.endPluginPackageInstallation(deploymentContext);
    throw e;
  }
}
