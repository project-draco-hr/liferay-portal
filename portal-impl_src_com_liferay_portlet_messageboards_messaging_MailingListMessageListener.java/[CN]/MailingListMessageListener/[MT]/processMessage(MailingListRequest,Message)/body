{
  if (MBUtil.hasMailIdHeader(mailMessage)) {
    return;
  }
  String from=null;
  Address[] addresses=mailMessage.getFrom();
  if ((addresses != null) && (addresses.length > 0)) {
    Address address=addresses[0];
    if (address instanceof InternetAddress) {
      from=((InternetAddress)address).getAddress();
    }
 else {
      from=address.toString();
    }
  }
  Company company=CompanyLocalServiceUtil.getCompany(mailingListRequest.getCompanyId());
  long groupId=mailingListRequest.getGroupId();
  long categoryId=mailingListRequest.getCategoryId();
  if (_log.isDebugEnabled()) {
    _log.debug("Category id " + categoryId);
  }
  boolean anonymous=false;
  User user=UserLocalServiceUtil.getUserById(company.getCompanyId(),mailingListRequest.getUserId());
  try {
    user=UserLocalServiceUtil.getUserByEmailAddress(company.getCompanyId(),from);
  }
 catch (  NoSuchUserException nsue) {
    anonymous=true;
  }
  long parentMessageId=MBUtil.getParentMessageId(mailMessage);
  if (_log.isDebugEnabled()) {
    _log.debug("Parent message id " + parentMessageId);
  }
  MBMessage parentMessage=null;
  try {
    if (parentMessageId > 0) {
      parentMessage=MBMessageLocalServiceUtil.getMessage(parentMessageId);
    }
  }
 catch (  NoSuchMessageException nsme) {
  }
  if (_log.isDebugEnabled()) {
    _log.debug("Parent message " + parentMessage);
  }
  MBMailMessage collector=new MBMailMessage();
  MBUtil.collectPartContent(mailMessage,collector);
  PermissionCheckerUtil.setThreadValues(user);
  MailingListThreadLocal.setSourceMailingList(true);
  String subject=MBUtil.getSubjectWithoutMessageId(mailMessage);
  ServiceContext serviceContext=new ServiceContext();
  serviceContext.setAddCommunityPermissions(true);
  serviceContext.setAddGuestPermissions(true);
  if (parentMessage == null) {
    MBMessageServiceUtil.addMessage(groupId,categoryId,subject,collector.getBody(),collector.getFiles(),anonymous,0.0,StatusConstants.APPROVED,serviceContext);
  }
 else {
    MBMessageServiceUtil.addMessage(groupId,categoryId,parentMessage.getThreadId(),parentMessage.getMessageId(),subject,collector.getBody(),collector.getFiles(),anonymous,0.0,StatusConstants.APPROVED,serviceContext);
  }
}
