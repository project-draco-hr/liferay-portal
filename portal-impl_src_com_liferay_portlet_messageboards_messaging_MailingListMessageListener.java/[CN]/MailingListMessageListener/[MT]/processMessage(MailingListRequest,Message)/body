{
  if (MBUtil.hasMailIdHeader(mailMessage)) {
    return;
  }
  String from=null;
  Address[] addresses=mailMessage.getFrom();
  if ((addresses != null) && (addresses.length > 0)) {
    Address address=addresses[0];
    if (address instanceof InternetAddress) {
      from=((InternetAddress)address).getAddress();
    }
 else {
      from=address.toString();
    }
  }
  Company company=CompanyLocalServiceUtil.getCompany(mailingListRequest.getCompanyId());
  long categoryId=mailingListRequest.getCategoryId();
  if (_log.isDebugEnabled()) {
    _log.debug("Category id " + categoryId);
  }
  boolean anonymous=false;
  User user=UserLocalServiceUtil.getUserById(company.getCompanyId(),mailingListRequest.getUserId());
  try {
    user=UserLocalServiceUtil.getUserByEmailAddress(company.getCompanyId(),from);
  }
 catch (  NoSuchUserException nsue) {
    anonymous=true;
  }
  MBMessage parentMessage=_parentMessageFinder.getParentMessage(categoryId,mailMessage);
  MBMailMessage collector=new MBMailMessage();
  MBUtil.collectPartContent(mailMessage,collector);
  PermissionCheckerUtil.setThreadValues(user);
  MailingListThreadLocal.setSourceMailingList(true);
  if (parentMessage == null) {
    MBMessageServiceUtil.addMessage(categoryId,mailMessage.getSubject(),collector.getBody(),collector.getFiles(),anonymous,0.0,null,true,true);
  }
 else {
    MBMessageServiceUtil.addMessage(categoryId,parentMessage.getThreadId(),parentMessage.getMessageId(),mailMessage.getSubject(),collector.getBody(),collector.getFiles(),anonymous,0.0,null,true,true);
  }
}
