{
  try {
    long groupId=ParamUtil.getLong(req,"groupId");
    String templateId=getTemplateId(req);
    ThemeDisplay themeDisplay=(ThemeDisplay)req.getAttribute(WebKeys.THEME_DISPLAY);
    Map tokens=JournalUtil.getTokens(groupId,themeDisplay);
    tokens.put("template_id",templateId);
    String languageId=LanguageUtil.getLanguageId(req);
    boolean transform=ParamUtil.get(req,"transform",true);
    JournalTemplate template=JournalTemplateLocalServiceUtil.getTemplate(groupId,templateId);
    String script=JournalUtil.getTemplateScript(template,tokens,languageId,transform);
    String extension=JournalTemplateImpl.LANG_TYPE_VM;
    if (template.getLangType() != null) {
      extension=template.getLangType();
    }
    byte[] byteArray=script.getBytes();
    String contentType=Constants.TEXT_PLAIN;
    if (Validator.equals(extension,JournalTemplateImpl.LANG_TYPE_CSS)) {
      contentType=Constants.TEXT_CSS;
    }
 else     if (Validator.equals(extension,JournalTemplateImpl.LANG_TYPE_XSL)) {
      contentType=Constants.TEXT_XML;
    }
    res.setContentLength(byteArray.length);
    res.setContentType(contentType + ";charset=UTF-8");
    ServletResponseUtil.write(res,byteArray);
    return null;
  }
 catch (  Exception e) {
    req.setAttribute(PageContext.EXCEPTION,e);
    return mapping.findForward(Constants.COMMON_ERROR);
  }
}
