{
  Framework framework=null;
  Path tempPath=Files.createTempDirectory(null);
  try {
    ServiceLoader<FrameworkFactory> serviceLoader=ServiceLoader.load(FrameworkFactory.class);
    FrameworkFactory frameworkFactory=serviceLoader.iterator().next();
    framework=frameworkFactory.newFramework(Collections.singletonMap(org.osgi.framework.Constants.FRAMEWORK_STORAGE,tempPath.toString()));
    framework.init();
    BundleContext bundleContext=framework.getBundleContext();
    Bundle systemBundle=bundleContext.getBundle(0);
    TargetPlatformIndexer targetPlatformIndexer=new TargetPlatformIndexer(systemBundle,dirNames);
    ByteArrayOutputStream byteArrayOutputStream=new ByteArrayOutputStream();
    targetPlatformIndexer.index(byteArrayOutputStream);
    URL url=BytesURLSupport.putData("liferay-target-platform",byteArrayOutputStream.toByteArray());
    return url.toURI();
  }
  finally {
    framework.stop();
    PathUtil.deltree(tempPath);
  }
}
