{
  if (portalCache instanceof LowLevelCache) {
    if (PropsValues.EHCACHE_CLUSTER_LINK_REPLICATION_ENABLED) {
      return new MVCCPortalCache<K,MVCCModel>((LowLevelCache<K,MVCCModel>)portalCache);
    }
 else {
      return new LockBasedMVCCEhcachePortalCache<K,MVCCModel>((LowLevelCache<K,MVCCModel>)portalCache);
    }
  }
  PortalCache<K,?> currentPortalCache=portalCache;
  while (currentPortalCache instanceof PortalCacheWrapper) {
    PortalCacheWrapper<K,MVCCModel> portalCacheWrapper=(PortalCacheWrapper<K,MVCCModel>)currentPortalCache;
    PortalCache<K,MVCCModel> nextPortalCache=portalCacheWrapper.getWrappedPortalCache();
    if (nextPortalCache instanceof LowLevelCache) {
      if (PropsValues.EHCACHE_CLUSTER_LINK_REPLICATION_ENABLED) {
        nextPortalCache=new MVCCPortalCache<K,MVCCModel>((LowLevelCache<K,MVCCModel>)nextPortalCache);
      }
 else {
        nextPortalCache=new LockBasedMVCCEhcachePortalCache<K,MVCCModel>((LowLevelCache<K,MVCCModel>)nextPortalCache);
      }
      portalCacheWrapper.setPortalCache(nextPortalCache);
      break;
    }
 else {
      currentPortalCache=nextPortalCache;
    }
  }
  return portalCache;
}
