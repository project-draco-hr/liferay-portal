{
  ThemeDisplay themeDisplay=(ThemeDisplay)actionRequest.getAttribute(WebKeys.THEME_DISPLAY);
  Layout layout=themeDisplay.getLayout();
  PortletPreferences preferences=PortletPreferencesFactoryUtil.getLayoutPortletSetup(layout,portlet.getPortletId());
  long scopeLayoutId=ParamUtil.getLong(actionRequest,"scopeLayoutId");
  if (scopeLayoutId > 0) {
    Layout scopeLayout=LayoutLocalServiceUtil.getLayout(layout.getGroupId(),layout.isPrivateLayout(),scopeLayoutId);
    if (!scopeLayout.hasScopeGroup()) {
      String name=String.valueOf(scopeLayout.getPlid());
      GroupLocalServiceUtil.addGroup(themeDisplay.getUserId(),Layout.class.getName(),scopeLayout.getPlid(),name,null,0,null,true);
    }
  }
  preferences.setValue("lfr-scope-layout-id",String.valueOf(scopeLayoutId));
  preferences.store();
}
