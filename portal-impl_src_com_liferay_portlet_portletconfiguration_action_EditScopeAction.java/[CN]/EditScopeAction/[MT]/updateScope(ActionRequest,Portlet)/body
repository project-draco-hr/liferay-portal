{
  ThemeDisplay themeDisplay=(ThemeDisplay)actionRequest.getAttribute(WebKeys.THEME_DISPLAY);
  Layout layout=themeDisplay.getLayout();
  PortletPreferences preferences=PortletPreferencesFactoryUtil.getLayoutPortletSetup(layout,portlet.getPortletId());
  String scopeType=ParamUtil.getString(actionRequest,"scopeType");
  preferences.setValue("lfrScopeType",scopeType);
  String scopeLayoutUuid=ParamUtil.getString(actionRequest,"scopeLayoutUuid");
  if (!scopeType.equals("layout")) {
    scopeLayoutUuid=StringPool.BLANK;
  }
  preferences.setValue("lfrScopeLayoutUuid",scopeLayoutUuid);
  String portletTitle=getPortletTitle(actionRequest,portlet,preferences);
  Tuple newScopeTuple=getNewScope(actionRequest);
  long newScopeGroupId=(Long)newScopeTuple.getObject(0);
  preferences.setValue("groupId",String.valueOf(newScopeGroupId));
  String oldScopeName=getOldScopeName(actionRequest,portlet);
  String newScopeName=(String)newScopeTuple.getObject(1);
  String newPortletTitle=PortalUtil.getNewPortletTitle(portletTitle,oldScopeName,newScopeName);
  if (!newPortletTitle.equals(portletTitle)) {
    preferences.setValue("portletSetupTitle" + themeDisplay.getLanguageId(),newPortletTitle);
    preferences.setValue("portletSetupUseCustomTitle",Boolean.TRUE.toString());
  }
  preferences.store();
}
