{
  ThemeDisplay themeDisplay=(ThemeDisplay)actionRequest.getAttribute(WebKeys.THEME_DISPLAY);
  Layout layout=themeDisplay.getLayout();
  PortletPreferences preferences=PortletPreferencesFactoryUtil.getLayoutPortletSetup(layout,portlet.getPortletId());
  String scopeLayoutUuid=ParamUtil.getString(actionRequest,"scopeLayoutUuid");
  String oldScopeLayoutUuid=GetterUtil.getString(preferences.getValue("lfr-scope-layout-uuid",null));
  String title=getPortletTitle(actionRequest,portlet,preferences);
  String newTitle=title;
  if (Validator.isNotNull(oldScopeLayoutUuid)) {
    try {
      Layout oldScopeLayout=LayoutLocalServiceUtil.getLayoutByUuidAndGroupId(oldScopeLayoutUuid,layout.getGroupId());
      StringBundler sb=new StringBundler(4);
      sb.append(StringPool.SPACE);
      sb.append(StringPool.OPEN_PARENTHESIS);
      sb.append(oldScopeLayout.getName(themeDisplay.getLocale()));
      sb.append(StringPool.CLOSE_PARENTHESIS);
      String suffix=sb.toString();
      if (newTitle.endsWith(suffix)) {
        newTitle=newTitle.substring(0,title.length() - suffix.length());
      }
    }
 catch (    NoSuchLayoutException nsle) {
    }
  }
  if (Validator.isNotNull(scopeLayoutUuid)) {
    Layout scopeLayout=LayoutLocalServiceUtil.getLayoutByUuidAndGroupId(scopeLayoutUuid,layout.getGroupId());
    if (!scopeLayout.hasScopeGroup()) {
      String name=String.valueOf(scopeLayout.getPlid());
      GroupLocalServiceUtil.addGroup(themeDisplay.getUserId(),Layout.class.getName(),scopeLayout.getPlid(),name,null,0,null,true,null);
    }
    StringBundler sb=new StringBundler(5);
    sb.append(newTitle);
    sb.append(StringPool.SPACE);
    sb.append(StringPool.OPEN_PARENTHESIS);
    sb.append(scopeLayout.getName(themeDisplay.getLocale()));
    sb.append(StringPool.CLOSE_PARENTHESIS);
    newTitle=sb.toString();
  }
  preferences.setValue("lfr-scope-layout-uuid",scopeLayoutUuid);
  if (!newTitle.equals(title)) {
    preferences.setValue("portlet-setup-title-" + themeDisplay.getLanguageId(),newTitle);
    preferences.setValue("portlet-setup-use-custom-title","true");
  }
  preferences.store();
}
