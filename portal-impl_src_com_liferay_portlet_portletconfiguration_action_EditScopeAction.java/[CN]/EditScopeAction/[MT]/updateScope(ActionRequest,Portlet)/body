{
  ThemeDisplay themeDisplay=(ThemeDisplay)actionRequest.getAttribute(WebKeys.THEME_DISPLAY);
  Layout layout=themeDisplay.getLayout();
  PortletPreferences preferences=PortletPreferencesFactoryUtil.getLayoutPortletSetup(layout,portlet.getPortletId());
  String scopeType=ParamUtil.getString(actionRequest,"scopeType");
  String oldScopeType=GetterUtil.getString(preferences.getValue("lfr-scope-type",null));
  String scopeLayoutUuid=StringPool.BLANK;
  String title=getPortletTitle(actionRequest,portlet,preferences);
  String newTitle=title;
  if (Validator.isNotNull(oldScopeType)) {
    String scopeName=null;
    if (oldScopeType.equals(GroupConstants.GLOBAL)) {
      scopeName=themeDisplay.translate("global");
    }
 else {
      String oldScopeLayoutUuid=GetterUtil.getString(preferences.getValue("lfr-scope-layout-uuid",null));
      try {
        Layout oldScopeLayout=LayoutLocalServiceUtil.getLayoutByUuidAndGroupId(oldScopeLayoutUuid,layout.getGroupId());
        scopeName=oldScopeLayout.getName(themeDisplay.getLocale());
      }
 catch (      NoSuchLayoutException nsle) {
      }
    }
    StringBundler sb=new StringBundler(4);
    sb.append(StringPool.SPACE);
    sb.append(StringPool.OPEN_PARENTHESIS);
    sb.append(scopeName);
    sb.append(StringPool.CLOSE_PARENTHESIS);
    String suffix=sb.toString();
    if (newTitle.endsWith(suffix)) {
      newTitle=newTitle.substring(0,title.length() - suffix.length());
    }
  }
  if (Validator.isNotNull(scopeType)) {
    String scopeName=null;
    if (scopeType.equals(GroupConstants.GLOBAL)) {
      scopeName=themeDisplay.translate("global");
    }
 else {
      scopeLayoutUuid=ParamUtil.getString(actionRequest,"scopeLayoutUuid");
      Layout scopeLayout=LayoutLocalServiceUtil.getLayoutByUuidAndGroupId(scopeLayoutUuid,layout.getGroupId());
      if (!scopeLayout.hasScopeGroup()) {
        String name=String.valueOf(scopeLayout.getPlid());
        GroupLocalServiceUtil.addGroup(themeDisplay.getUserId(),Layout.class.getName(),scopeLayout.getPlid(),name,null,0,null,true,null);
      }
      scopeName=scopeLayout.getName(themeDisplay.getLocale());
    }
    StringBundler sb=new StringBundler(5);
    sb.append(newTitle);
    sb.append(StringPool.SPACE);
    sb.append(StringPool.OPEN_PARENTHESIS);
    sb.append(scopeName);
    sb.append(StringPool.CLOSE_PARENTHESIS);
    newTitle=sb.toString();
  }
  preferences.setValue("lfr-scope-layout-uuid",scopeLayoutUuid);
  preferences.setValue("lfr-scope-type",scopeType);
  if (!newTitle.equals(title)) {
    preferences.setValue("portlet-setup-title-" + themeDisplay.getLanguageId(),newTitle);
    preferences.setValue("portlet-setup-use-custom-title","true");
  }
  preferences.store();
}
