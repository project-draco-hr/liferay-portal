{
  if (Validator.isNull(velocityTemplateContent)) {
    return;
  }
  HttpServletRequest request=(HttpServletRequest)pageContext.getRequest();
  HttpServletResponse response=(HttpServletResponse)pageContext.getResponse();
  TemplateProcessor processor=new TemplateProcessor(request,response,portletId);
  Template velocityTemplate=TemplateManagerUtil.getTemplate(TemplateManager.VELOCITY,velocityTemplateId,velocityTemplateContent,TemplateContextType.STANDARD);
  velocityTemplate.put("processor",processor);
  velocityTemplate.prepare(request);
  UnsyncStringWriter unsyncStringWriter=new UnsyncStringWriter();
  MethodHandler methodHandler=new MethodHandler(_initMethodKey,pageContext.getServletContext(),request,new PipingServletResponse(response,unsyncStringWriter),pageContext);
  Object velocityTaglib=methodHandler.invoke(true);
  velocityTemplate.put("taglibLiferay",velocityTaglib);
  velocityTemplate.put("theme",velocityTaglib);
  try {
    velocityTemplate.processTemplate(unsyncStringWriter);
  }
 catch (  Exception e) {
    _log.error(e,e);
    throw e;
  }
  String output=unsyncStringWriter.toString();
  Map<Portlet,Object[]> portletsMap=processor.getPortletsMap();
  Map<String,StringBundler> contentsMap=new HashMap<String,StringBundler>(portletsMap.size());
  for (  Map.Entry<Portlet,Object[]> entry : portletsMap.entrySet()) {
    Portlet portlet=entry.getKey();
    Object[] value=entry.getValue();
    String columnId=(String)value[0];
    Integer columnPos=(Integer)value[1];
    Integer columnCount=(Integer)value[2];
    UnsyncStringWriter portletUnsyncStringWriter=new UnsyncStringWriter();
    PipingServletResponse pipingServletResponse=new PipingServletResponse(response,portletUnsyncStringWriter);
    HttpServletRequest setupRequest=PortletContainerUtil.setupOptionalRenderParameters(request,null,columnId,columnPos,columnCount);
    PortletContainerUtil.render(setupRequest,pipingServletResponse,portlet);
    contentsMap.put(portlet.getPortletId(),portletUnsyncStringWriter.getStringBundler());
  }
  StringBundler sb=StringUtil.replaceWithStringBundler(output,"[$TEMPLATE_PORTLET_","$]",contentsMap);
  sb.writeTo(pageContext.getOut());
}
