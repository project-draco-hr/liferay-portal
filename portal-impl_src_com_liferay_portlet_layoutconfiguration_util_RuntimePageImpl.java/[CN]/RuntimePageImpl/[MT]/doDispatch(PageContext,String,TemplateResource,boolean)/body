{
  LayoutTemplate layoutTemplate=getLayoutTemplate(templateResource.getTemplateId());
  String pluginServletContextName=GetterUtil.getString(layoutTemplate.getServletContextName());
  ServletContext pluginServletContext=ServletContextPool.get(pluginServletContextName);
  ClassLoader pluginClassLoader=null;
  if (pluginServletContext != null) {
    pluginClassLoader=(ClassLoader)pluginServletContext.getAttribute(PluginContextListener.PLUGIN_CLASS_LOADER);
  }
  ClassLoader contextClassLoader=PACLClassLoaderUtil.getContextClassLoader();
  StringBundler sb=null;
  try {
    TemplateContextType templateContextType=TemplateContextType.STANDARD;
    if ((pluginClassLoader != null) && (pluginClassLoader != contextClassLoader)) {
      PACLClassLoaderUtil.setContextClassLoader(pluginClassLoader);
      templateContextType=TemplateContextType.CLASS_LOADER;
    }
    if (processTemplate) {
      sb=doProcessTemplate(pageContext,portletId,templateResource,templateContextType);
    }
 else {
      doProcessCustomizationSettings(pageContext,templateResource,templateContextType);
    }
  }
  finally {
    if ((pluginClassLoader != null) && (pluginClassLoader != contextClassLoader)) {
      PACLClassLoaderUtil.setContextClassLoader(contextClassLoader);
    }
  }
  return sb;
}
