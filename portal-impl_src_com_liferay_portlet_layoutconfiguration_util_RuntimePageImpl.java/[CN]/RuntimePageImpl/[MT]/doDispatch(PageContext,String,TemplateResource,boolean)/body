{
  ClassLoader pluginClassLoader=null;
  LayoutTemplate layoutTemplate=getLayoutTemplate(templateResource.getTemplateId());
  if (layoutTemplate != null) {
    String pluginServletContextName=GetterUtil.getString(layoutTemplate.getServletContextName());
    ServletContext pluginServletContext=ServletContextPool.get(pluginServletContextName);
    if (pluginServletContext != null) {
      pluginClassLoader=(ClassLoader)pluginServletContext.getAttribute(PluginContextListener.PLUGIN_CLASS_LOADER);
    }
  }
  ClassLoader contextClassLoader=PACLClassLoaderUtil.getContextClassLoader();
  try {
    TemplateContextType templateContextType=TemplateContextType.STANDARD;
    if ((pluginClassLoader != null) && (pluginClassLoader != contextClassLoader)) {
      PACLClassLoaderUtil.setContextClassLoader(pluginClassLoader);
      templateContextType=TemplateContextType.CLASS_LOADER;
    }
    if (processTemplate) {
      return doProcessTemplate(pageContext,portletId,templateResource,templateContextType);
    }
 else {
      doProcessCustomizationSettings(pageContext,templateResource,templateContextType);
      return null;
    }
  }
  finally {
    if ((pluginClassLoader != null) && (pluginClassLoader != contextClassLoader)) {
      PACLClassLoaderUtil.setContextClassLoader(contextClassLoader);
    }
  }
}
