{
  if (Validator.isNull(velocityTemplateContent)) {
    return;
  }
  LayoutTemplate layoutTemplate=getLayoutTemlpate(velocityTemplateId);
  String pluginServletContextName=GetterUtil.getString(layoutTemplate.getServletContextName());
  ServletContext pluginServletContext=ServletContextPool.get(pluginServletContextName);
  ClassLoader pluginClassLoader=(ClassLoader)pluginServletContext.getAttribute(PluginContextListener.PLUGIN_CLASS_LOADER);
  ClassLoader contextClassLoader=PACLClassLoaderUtil.getContextClassLoader();
  try {
    TemplateContextType templateContextType=TemplateContextType.STANDARD;
    if ((pluginClassLoader != null) && (pluginClassLoader != contextClassLoader)) {
      PACLClassLoaderUtil.setContextClassLoader(pluginClassLoader);
      templateContextType=TemplateContextType.CLASS_LOADER;
    }
    if (processTemplate) {
      doProcessTemplate(pageContext,portletId,velocityTemplateId,velocityTemplateContent,templateContextType);
    }
 else {
      doProcessCustomizationSettings(pageContext,velocityTemplateId,velocityTemplateContent,templateContextType);
    }
  }
  finally {
    if ((pluginClassLoader != null) && (pluginClassLoader != contextClassLoader)) {
      PACLClassLoaderUtil.setContextClassLoader(contextClassLoader);
    }
  }
}
