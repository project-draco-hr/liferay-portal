{
  Logger logger=npmInstallTask.getLogger();
  Project project=npmInstallTask.getProject();
  String digest=_getNodeModulesCacheDigest(npmInstallTask);
  File nodeModulesCacheDir=new File(npmInstallTask.getNodeModulesCacheDir(),digest);
  File nodeModulesDir=npmInstallTask.getNodeModulesDir();
  boolean nativeSync=npmInstallTask.isNodeModulesCacheNativeSync();
  boolean removeBinDirs=npmInstallTask.isNodeModulesCacheRemoveBinDirs();
  if (reset) {
    project.delete(nodeModulesCacheDir);
  }
  if (nodeModulesCacheDir.exists()) {
    if (logger.isLifecycleEnabled()) {
      logger.lifecycle("Restoring node_modules of {} from {}",project,nodeModulesCacheDir);
    }
    FileUtil.syncDir(project,nodeModulesCacheDir,nodeModulesDir,nativeSync);
    if (removeBinDirs) {
      FileUtil.removeDirs(project,nodeModulesDir,_NODE_MODULES_BIN_DIR_NAME);
    }
  }
 else {
    npmInstallTask._npmInstall(reset);
    if (removeBinDirs) {
      FileUtil.removeDirs(project,nodeModulesDir,_NODE_MODULES_BIN_DIR_NAME);
    }
    if (logger.isLifecycleEnabled()) {
      logger.lifecycle("Caching node_modules of {} in {}",project,nodeModulesCacheDir);
    }
    FileUtil.syncDir(project,nodeModulesDir,nodeModulesCacheDir,nativeSync);
  }
}
