{
  if (portletName == null) {
    portletName=_getPortletName(request);
  }
  LiferayPortletURL liferayPortletURL=_getLiferayPortletURL(request,plid,portletName,lifecycle);
  if (liferayPortletURL == null) {
    _log.error("Render response is null because this tag is not being " + "called within the context of a portlet");
    return DummyPortletURL.getInstance();
  }
  if (Validator.isNotNull(windowState)) {
    liferayPortletURL.setWindowState(WindowStateFactory.getWindowState(windowState));
  }
  if (Validator.isNotNull(portletMode)) {
    liferayPortletURL.setPortletMode(PortletModeFactory.getPortletMode(portletMode));
  }
  if (secure != null) {
    liferayPortletURL.setSecure(secure.booleanValue());
  }
 else {
    liferayPortletURL.setSecure(PortalUtil.isSecure(request));
  }
  if (copyCurrentRenderParameters != null) {
    liferayPortletURL.setCopyCurrentRenderParameters(copyCurrentRenderParameters.booleanValue());
  }
  if (escapeXml != null) {
    liferayPortletURL.setEscapeXml(escapeXml.booleanValue());
  }
  if (lifecycle.equals(PortletRequest.ACTION_PHASE) && Validator.isNotNull(name)) {
    liferayPortletURL.setParameter(ActionRequest.ACTION_NAME,name);
  }
  if (resourceID != null) {
    liferayPortletURL.setResourceID(resourceID);
  }
  if (cacheability != null) {
    liferayPortletURL.setCacheability(cacheability);
  }
  if (refererPlid > LayoutConstants.DEFAULT_PLID) {
    liferayPortletURL.setRefererPlid(refererPlid);
  }
  if (anchor != null) {
    liferayPortletURL.setAnchor(anchor.booleanValue());
  }
  if (encrypt != null) {
    liferayPortletURL.setEncrypt(encrypt.booleanValue());
  }
  if (doAsGroupId > 0) {
    liferayPortletURL.setDoAsGroupId(doAsGroupId);
  }
  if (doAsUserId > 0) {
    liferayPortletURL.setDoAsUserId(doAsUserId);
  }
  String settingsScope=null;
  if ((portletConfiguration != null) && portletConfiguration.booleanValue()) {
    String returnToFullPageURL=ParamUtil.getString(request,"returnToFullPageURL");
    String portletResource=ParamUtil.getString(request,"portletResource");
    String previewWidth=ParamUtil.getString(request,"previewWidth");
    settingsScope=ParamUtil.getString(request,"settingsScope",PortletPreferencesFactoryConstants.SETTINGS_SCOPE_PORTLET_INSTANCE);
    liferayPortletURL.setParameter("struts_action","/portlet_configuration/edit_configuration");
    liferayPortletURL.setParameter("returnToFullPageURL",returnToFullPageURL);
    liferayPortletURL.setParameter("portletResource",portletResource);
    liferayPortletURL.setParameter("previewWidth",previewWidth);
  }
  if (parameterMap != null) {
    MapUtil.merge(liferayPortletURL.getParameterMap(),parameterMap);
    liferayPortletURL.setParameters(parameterMap);
  }
  if ((settingsScope != null) && ((parameterMap == null) || (parameterMap.get("settingsScope") == null))) {
    liferayPortletURL.setParameter("settingsScope",settingsScope);
  }
  liferayPortletURL.setRemovedParameterNames(removedParameterNames);
  return liferayPortletURL;
}
