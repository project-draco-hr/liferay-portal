{
  HttpServletRequest request=(HttpServletRequest)pageContext.getRequest();
  if (portletName == null) {
    portletName=_getPortletName(request);
  }
  LiferayPortletURL portletURL=_getLiferayPortletURL(request,plid,portletName,lifecycle);
  if (portletURL == null) {
    _log.error("Render response is null because this tag is not being " + "called within the context of a portlet");
    return StringPool.BLANK;
  }
  if (Validator.isNotNull(windowState)) {
    portletURL.setWindowState(WindowStateFactory.getWindowState(windowState));
  }
  if (Validator.isNotNull(portletMode)) {
    portletURL.setPortletMode(PortletModeFactory.getPortletMode(portletMode));
  }
  if (secure != null) {
    portletURL.setSecure(secure.booleanValue());
  }
 else {
    portletURL.setSecure(request.isSecure());
  }
  if (copyCurrentRenderParameters != null) {
    portletURL.setCopyCurrentRenderParameters(copyCurrentRenderParameters.booleanValue());
  }
  if (escapeXml != null) {
    portletURL.setEscapeXml(escapeXml.booleanValue());
  }
  if (lifecycle.equals(PortletRequest.ACTION_PHASE) && Validator.isNotNull(name)) {
    portletURL.setParameter(ActionRequest.ACTION_NAME,name);
  }
  if (resourceID != null) {
    portletURL.setResourceID(resourceID);
  }
  if (cacheability != null) {
    portletURL.setCacheability(cacheability);
  }
  if (anchor != null) {
    portletURL.setAnchor(anchor.booleanValue());
  }
  if (encrypt != null) {
    portletURL.setEncrypt(encrypt.booleanValue());
  }
  if (doAsUserId > 0) {
    portletURL.setDoAsUserId(doAsUserId);
  }
  if ((portletConfiguration != null) && portletConfiguration.booleanValue()) {
    String returnToFullPageURL=ParamUtil.getString(request,"returnToFullPageURL");
    String portletResource=ParamUtil.getString(request,"portletResource");
    String previewWidth=ParamUtil.getString(request,"previewWidth");
    portletURL.setParameter("struts_action","/portlet_configuration/edit_configuration");
    portletURL.setParameter("returnToFullPageURL",returnToFullPageURL);
    portletURL.setParameter("portletResource",portletResource);
    portletURL.setParameter("previewWidth",previewWidth);
  }
  if (params != null) {
    MapUtil.merge(portletURL.getParameterMap(),params);
    portletURL.setParameters(params);
  }
  String portletURLToString=portletURL.toString();
  if (Validator.isNotNull(var)) {
    pageContext.setAttribute(var,portletURLToString);
  }
 else   if (Validator.isNotNull(varImpl)) {
    pageContext.setAttribute(varImpl,portletURL);
  }
 else   if (writeOutput) {
    pageContext.getOut().print(portletURLToString);
  }
  return portletURLToString;
}
