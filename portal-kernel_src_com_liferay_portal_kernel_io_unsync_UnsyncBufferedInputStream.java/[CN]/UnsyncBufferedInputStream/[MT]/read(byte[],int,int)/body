{
  if (in == null) {
    throw new IOException("Stream closed");
  }
  if (len <= 0) {
    return 0;
  }
  int readedNumber=0;
  while (true) {
    int inBufferAvailable=firstInvalidIndex - index;
    if (inBufferAvailable + readedNumber >= len) {
      int leftSize=len - readedNumber;
      System.arraycopy(buffer,index,b,readedNumber,leftSize);
      index+=leftSize;
      return len;
    }
    if (inBufferAvailable <= 0) {
      readUnderlyingInputStream();
      inBufferAvailable=firstInvalidIndex - index;
      if (inBufferAvailable <= 0) {
        return readedNumber;
      }
    }
 else {
      System.arraycopy(buffer,index,b,readedNumber,inBufferAvailable);
      index+=inBufferAvailable;
      readedNumber+=inBufferAvailable;
    }
  }
}
