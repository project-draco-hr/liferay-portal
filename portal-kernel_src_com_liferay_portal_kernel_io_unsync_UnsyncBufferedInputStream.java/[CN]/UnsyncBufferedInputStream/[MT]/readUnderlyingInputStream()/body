{
  if (in == null) {
    throw new IOException("Stream closed");
  }
  if (markIndex < 0) {
    index=firstInvalidIndex=0;
    int number=in.read(buffer);
    if (number > 0) {
      firstInvalidIndex=number;
    }
    return;
  }
  if (index >= buffer.length) {
    if (firstInvalidIndex - markIndex > marklimit) {
      markIndex=-1;
      index=0;
    }
 else     if (markIndex > _MAX_MARK_WASTE_SIZE) {
      int realDataSize=index - markIndex;
      System.arraycopy(buffer,markIndex,buffer,0,realDataSize);
      index=realDataSize;
      markIndex=0;
    }
 else {
      int newBufferSize=index << 1;
      if (newBufferSize - _MAX_MARK_WASTE_SIZE > marklimit) {
        newBufferSize=marklimit + _MAX_MARK_WASTE_SIZE;
      }
      byte[] newBuffer=new byte[newBufferSize];
      System.arraycopy(buffer,0,newBuffer,0,index);
      buffer=newBuffer;
    }
  }
  firstInvalidIndex=index;
  int number=in.read(buffer,index,buffer.length - index);
  if (number > 0) {
    firstInvalidIndex+=number;
  }
}
