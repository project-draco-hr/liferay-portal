{
  AccessControlUtil.initAccessControlContext(request,response);
  AuthVerifierResult.State state=AccessControlUtil.verifyRequest();
  AccessControlContext accessControlContext=AccessControlUtil.getAccessControlContext();
  AuthVerifierResult authVerifierResult=accessControlContext.getAuthVerifierResult();
  if (_log.isDebugEnabled()) {
    _log.debug("Auth verifier result " + authVerifierResult);
  }
  if (state == AuthVerifierResult.State.INVALID_CREDENTIALS) {
    if (_log.isDebugEnabled()) {
      _log.debug("Result state doesn't allow us to continue.");
    }
  }
 else   if (state == AuthVerifierResult.State.NOT_APPLICABLE) {
    _log.error("Internal exception, invalid state " + state);
  }
 else   if (state == AuthVerifierResult.State.SUCCESS) {
    long userId=authVerifierResult.getUserId();
    AccessControlUtil.initContextUser(userId);
    Map<String,Object> authSettings=accessControlContext.getSettings();
    String authType=GetterUtil.get(authSettings.get(AuthVerifierPipeline.AUTH_TYPE),StringPool.BLANK);
    if (Validator.isNull(authType)) {
      authType=null;
    }
    ProtectedServletRequest protectedServletRequest=new ProtectedServletRequest(request,String.valueOf(userId),authType);
    accessControlContext.setRequest(protectedServletRequest);
    processFilter(getClass(),protectedServletRequest,response,filterChain);
  }
 else {
    _log.error("Unimplemented state " + state);
  }
}
