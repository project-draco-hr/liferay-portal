{
  PortletSession portletSession=resourceRequest.getPortletSession();
  WSRPConsumerPortlet wsrpConsumerPortlet=getWSRPConsumerPortlet();
  WSRPConsumer wsrpConsumer=WSRPConsumerLocalServiceUtil.getWSRPConsumer(wsrpConsumerPortlet.getWsrpConsumerId());
  WSRPConsumerManager wsrpConsumerManager=WSRPConsumerManagerFactory.getWSRPConsumerManager(wsrpConsumer);
  PortletContext portletContext=new PortletContext();
  ResourceParams resourceParams=new ResourceParams();
  RuntimeContext runtimeContext=new RuntimeContext();
  UserContext userContext=new UserContext();
  initContexts(resourceRequest,resourceResponse,wsrpConsumer,wsrpConsumerPortlet,wsrpConsumerManager,portletContext,resourceParams,runtimeContext,userContext);
  GetResource getResource=new GetResource();
  PortletContext existingPortletContext=(PortletContext)portletSession.getAttribute(WebKeys.PORTLET_CONTEXT);
  if (existingPortletContext != null) {
    getResource.setPortletContext(existingPortletContext);
  }
 else {
    getResource.setPortletContext(portletContext);
  }
  getResource.setRegistrationContext(wsrpConsumer.getRegistrationContext());
  getResource.setResourceParams(resourceParams);
  getResource.setRuntimeContext(runtimeContext);
  getResource.setUserContext(userContext);
  ServiceHolder serviceHolder=getServiceHolder(resourceRequest,wsrpConsumerManager,wsrpConsumer);
  WSRP_v2_Markup_PortType markupService=serviceHolder.getMarkupService();
  oasis.names.tc.wsrp.v2.types.ResourceResponse wsrpResourceResponse=markupService.getResource(getResource);
  processResourceResponse(resourceRequest,resourceResponse,wsrpConsumerManager,serviceHolder,wsrpResourceResponse);
}
