{
  PortletSession portletSession=portletRequest.getPortletSession();
  WSRPConsumerPortlet wsrpConsumerPortlet=getWSRPConsumerPortlet();
  WSRPConsumer wsrpConsumer=WSRPConsumerLocalServiceUtil.getWSRPConsumer(wsrpConsumerPortlet.getWsrpConsumerId());
  WSRPConsumerManager wsrpConsumerManager=WSRPConsumerManagerFactory.getWSRPConsumerManager(wsrpConsumer);
  MarkupParams markupParams=new MarkupParams();
  PortletContext portletContext=new PortletContext();
  RuntimeContext runtimeContext=new RuntimeContext();
  UserContext userContext=new UserContext();
  initContexts(portletRequest,portletResponse,wsrpConsumer,wsrpConsumerPortlet,wsrpConsumerManager,markupParams,portletContext,runtimeContext,userContext);
  GetMarkup getMarkup=new GetMarkup();
  getMarkup.setMarkupParams(markupParams);
  PortletContext existingPortletContext=(PortletContext)portletSession.getAttribute(WebKeys.PORTLET_CONTEXT);
  if (existingPortletContext != null) {
    getMarkup.setPortletContext(existingPortletContext);
  }
 else {
    getMarkup.setPortletContext(portletContext);
  }
  getMarkup.setRegistrationContext(wsrpConsumer.getRegistrationContext());
  getMarkup.setRuntimeContext(runtimeContext);
  getMarkup.setUserContext(userContext);
  ServiceHolder serviceHolder=getServiceHolder(portletRequest,wsrpConsumerManager,wsrpConsumer);
  WSRP_v2_Markup_PortType markupService=serviceHolder.getMarkupService();
  MarkupResponse markupResponse=null;
  try {
    markupResponse=markupService.getMarkup(getMarkup);
  }
 catch (  InvalidCookieFault icf) {
    InitCookie initCookie=new InitCookie();
    markupService.initCookie(initCookie);
    markupResponse=markupService.getMarkup(getMarkup);
  }
  Stub stub=(Stub)markupService;
  stub._createCall();
  processMarkupResponse(portletRequest,portletResponse,serviceHolder,markupResponse);
  return markupResponse;
}
