{
  CounterHolder holder=register.getCounterHolder();
  long newValue=holder.addAndGet(size);
  if (newValue <= holder.getRangeMax()) {
    return newValue;
  }
  CompeteLatch latch=register.getCompeteLatch();
  if (!latch.compete()) {
    latch.await();
    return competeIncrement(register,size);
  }
  Connection connection=null;
  PreparedStatement ps=null;
  ResultSet rs=null;
  try {
    holder=register.getCounterHolder();
    newValue=holder.addAndGet(size);
    if (newValue > holder.getRangeMax()) {
      connection=getConnection();
      ps=connection.prepareStatement(_SQL_SELECT_ID_BY_NAME);
      ps.setString(1,register.getName());
      rs=ps.executeQuery();
      rs.next();
      long currentId=rs.getLong(1);
      newValue=currentId + 1;
      long rangeMax=currentId + register.getRangeSize();
      rs.close();
      ps.close();
      ps=connection.prepareStatement(_SQL_UPDATE_ID_BY_NAME);
      ps.setLong(1,rangeMax);
      ps.setString(2,register.getName());
      ps.executeUpdate();
      register.setCounterHolder(new CounterHolder(newValue,rangeMax));
    }
  }
 catch (  Exception e) {
    throw processException(e);
  }
 finally {
    DataAccess.cleanUp(connection,ps,rs);
    latch.done();
  }
  return newValue;
}
