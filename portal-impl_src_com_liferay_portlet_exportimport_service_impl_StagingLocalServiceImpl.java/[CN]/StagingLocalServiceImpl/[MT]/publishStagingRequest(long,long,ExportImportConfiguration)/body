{
  File file=null;
  Locale siteDefaultLocale=LocaleThreadLocal.getSiteDefaultLocale();
  try {
    ExportImportThreadLocal.setLayoutImportInProcess(true);
    ExportImportThreadLocal.setLayoutStagingInProcess(true);
    Folder folder=PortletFileRepositoryUtil.getPortletFolder(stagingRequestId);
    FileEntry stagingRequestFileEntry=getStagingRequestFileEntry(userId,stagingRequestId,folder);
    file=FileUtil.createTempFile("lar");
    FileUtil.write(file,stagingRequestFileEntry.getContentStream());
    Map<String,Serializable> settingsMap=exportImportConfiguration.getSettingsMap();
    settingsMap.put("userId",userId);
    long targetGroupId=MapUtil.getLong(settingsMap,"targetGroupId");
    LocaleThreadLocal.setSiteDefaultLocale(PortalUtil.getSiteDefaultLocale(targetGroupId));
    exportImportLocalService.importLayoutsDataDeletions(exportImportConfiguration,file);
    MissingReferences missingReferences=exportImportLocalService.validateImportLayoutsFile(exportImportConfiguration,file);
    exportImportLocalService.importLayouts(exportImportConfiguration,file);
    return missingReferences;
  }
 catch (  IOException ioe) {
    throw new SystemException(ioe);
  }
 finally {
    LocaleThreadLocal.setSiteDefaultLocale(siteDefaultLocale);
    ExportImportThreadLocal.setLayoutImportInProcess(false);
    ExportImportThreadLocal.setLayoutStagingInProcess(false);
  }
}
