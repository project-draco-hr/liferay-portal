{
  StagingUtil.validateRemote(stagingGroup.getGroupId(),remoteAddress,remotePort,remotePathContext,secureConnection,remoteGroupId);
  if (stagingGroup.hasStagingGroup()) {
    disableStaging(stagingGroup,serviceContext);
  }
  boolean stagedRemotely=stagingGroup.isStagedRemotely();
  boolean oldStagedRemotely=stagedRemotely;
  UnicodeProperties typeSettingsProperties=stagingGroup.getTypeSettingsProperties();
  String remoteURL=StagingUtil.buildRemoteURL(remoteAddress,remotePort,remotePathContext,secureConnection);
  if (stagedRemotely) {
    long oldRemoteGroupId=GetterUtil.getLong(typeSettingsProperties.getProperty("remoteGroupId"));
    String oldRemoteURL=StagingUtil.buildRemoteURL(typeSettingsProperties);
    if (!remoteURL.equals(oldRemoteURL) || (remoteGroupId != oldRemoteGroupId)) {
      disableRemoteStaging(oldRemoteURL,oldRemoteGroupId,false);
      stagedRemotely=false;
    }
  }
  if (!stagedRemotely) {
    enableRemoteStaging(remoteURL,remoteGroupId);
  }
  checkDefaultLayoutSetBranches(userId,stagingGroup,branchingPublic,branchingPrivate,true,serviceContext);
  typeSettingsProperties.setProperty("branchingPrivate",String.valueOf(branchingPrivate));
  typeSettingsProperties.setProperty("branchingPublic",String.valueOf(branchingPublic));
  typeSettingsProperties.setProperty("remoteAddress",remoteAddress);
  typeSettingsProperties.setProperty("remoteGroupId",String.valueOf(remoteGroupId));
  typeSettingsProperties.setProperty("remotePathContext",remotePathContext);
  typeSettingsProperties.setProperty("remotePort",String.valueOf(remotePort));
  typeSettingsProperties.setProperty("secureConnection",String.valueOf(secureConnection));
  if (!oldStagedRemotely) {
    typeSettingsProperties.setProperty("staged",Boolean.TRUE.toString());
    typeSettingsProperties.setProperty("stagedRemotely",Boolean.TRUE.toString());
    setCommonStagingOptions(typeSettingsProperties,serviceContext);
  }
  groupLocalService.updateGroup(stagingGroup.getGroupId(),typeSettingsProperties.toString());
  updateStagedPortlets(remoteURL,remoteGroupId,typeSettingsProperties);
}
