{
  ByteArrayMaker bam=new ByteArrayMaker();
  long companyId=GetterUtil.getLong((String)tokens.get("company_id"));
  Locale locale=LocaleUtil.fromLanguageId(languageId);
  JournalXslErrorListener errorListener=new JournalXslErrorListener(companyId,locale);
  try {
    StreamSource xmlSource=new StreamSource(new StringReader(xml));
    StreamSource scriptSource=new StreamSource(new StringReader(script));
    TransformerFactory transformerFactory=TransformerFactory.newInstance();
    transformerFactory.setURIResolver(new URIResolver(tokens,languageId));
    transformerFactory.setErrorListener(errorListener);
    Transformer transformer=transformerFactory.newTransformer(scriptSource);
    transformer.transform(xmlSource,new StreamResult(bam));
  }
 catch (  TransformerConfigurationException tce) {
    throw new TransformException(errorListener.getMessageAndLocation());
  }
catch (  TransformerException te) {
    throw new TransformException(errorListener.getMessageAndLocation());
  }
  return bam.toString("UTF-8");
}
