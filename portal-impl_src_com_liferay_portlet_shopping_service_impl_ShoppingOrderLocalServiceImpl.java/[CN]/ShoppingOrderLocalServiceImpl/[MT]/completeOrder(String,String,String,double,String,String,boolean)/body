{
  ShoppingOrder order=shoppingOrderPersistence.findByNumber(number);
  order.setModifiedDate(new Date());
  order.setPpTxnId(ppTxnId);
  order.setPpPaymentStatus(ppPaymentStatus);
  order.setPpPaymentGross(ppPaymentGross);
  order.setPpReceiverEmail(ppReceiverEmail);
  order.setPpPayerEmail(ppPayerEmail);
  shoppingOrderPersistence.update(order);
  if (updateInventory && ppPaymentStatus.equals(ShoppingOrderImpl.STATUS_COMPLETED)) {
    List orderItems=shoppingOrderItemLocalService.getOrderItems(order.getOrderId());
    for (int i=0; i < orderItems.size(); i++) {
      ShoppingOrderItem orderItem=(ShoppingOrderItem)orderItems.get(i);
      ShoppingItem item=shoppingItemLocalService.getItem(ShoppingUtil.getItemId(orderItem.getItemId()));
      if (!item.isFields()) {
        int quantity=item.getStockQuantity() - orderItem.getQuantity();
        item.setStockQuantity(quantity);
      }
 else {
        List itemFields=shoppingItemFieldLocalService.getItemFields(item.getItemId());
        ShoppingItemField[] itemFieldsArray=(ShoppingItemField[])itemFields.toArray(new ShoppingItemField[0]);
        String[] fieldsArray=ShoppingCartItemImpl.getFieldsArray(ShoppingUtil.getItemFields(orderItem.getItemId()));
        int rowPos=ShoppingUtil.getFieldsQuantitiesPos(item,itemFieldsArray,fieldsArray);
        String[] fieldsQuantities=item.getFieldsQuantitiesArray();
        try {
          int quantity=GetterUtil.getInteger(fieldsQuantities[rowPos]) - orderItem.getQuantity();
          fieldsQuantities[rowPos]=Integer.toString(quantity);
          item.setFieldsQuantitiesArray(fieldsQuantities);
        }
 catch (        Exception e) {
        }
      }
      shoppingItemPersistence.update(item);
    }
  }
  sendEmail(order,"confirmation");
}
