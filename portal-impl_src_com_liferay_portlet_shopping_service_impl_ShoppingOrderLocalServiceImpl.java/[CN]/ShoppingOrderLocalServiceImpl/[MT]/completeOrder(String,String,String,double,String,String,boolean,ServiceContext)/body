{
  ShoppingOrder order=shoppingOrderPersistence.findByNumber(number);
  order.setModifiedDate(new Date());
  order.setPpTxnId(ppTxnId);
  order.setPpPaymentStatus(ppPaymentStatus);
  order.setPpPaymentGross(ppPaymentGross);
  order.setPpReceiverEmail(ppReceiverEmail);
  order.setPpPayerEmail(ppPayerEmail);
  shoppingOrderPersistence.update(order,false);
  if (updateInventory && ppPaymentStatus.equals(ShoppingOrderConstants.STATUS_COMPLETED)) {
    List<ShoppingOrderItem> orderItems=shoppingOrderItemLocalService.getOrderItems(order.getOrderId());
    for (    ShoppingOrderItem orderItem : orderItems) {
      ShoppingItem item=shoppingItemLocalService.getItem(ShoppingUtil.getItemId(orderItem.getItemId()));
      if (!item.isFields()) {
        int quantity=item.getStockQuantity() - orderItem.getQuantity();
        item.setStockQuantity(quantity);
      }
 else {
        List<ShoppingItemField> itemFields=shoppingItemFieldLocalService.getItemFields(item.getItemId());
        ShoppingItemField[] itemFieldsArray=itemFields.toArray(new ShoppingItemField[itemFields.size()]);
        String[] fieldsArray=ShoppingCartItemImpl.getFieldsArray(ShoppingUtil.getItemFields(orderItem.getItemId()));
        int rowPos=ShoppingUtil.getFieldsQuantitiesPos(item,itemFieldsArray,fieldsArray);
        String[] fieldsQuantities=item.getFieldsQuantitiesArray();
        try {
          int quantity=GetterUtil.getInteger(fieldsQuantities[rowPos]) - orderItem.getQuantity();
          fieldsQuantities[rowPos]=String.valueOf(quantity);
          item.setFieldsQuantitiesArray(fieldsQuantities);
        }
 catch (        Exception e) {
        }
      }
      shoppingItemPersistence.update(item,false);
    }
  }
  sendEmail(order,"confirmation",serviceContext);
}
