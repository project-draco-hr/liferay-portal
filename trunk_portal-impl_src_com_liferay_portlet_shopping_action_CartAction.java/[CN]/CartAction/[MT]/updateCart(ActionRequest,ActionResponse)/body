{
  String cmd=ParamUtil.getString(actionRequest,Constants.CMD);
  ShoppingCart cart=ShoppingUtil.getCart(actionRequest);
  if (cmd.equals(Constants.ADD)) {
    long itemId=ParamUtil.getLong(actionRequest,"itemId");
    String fields=ParamUtil.getString(actionRequest,"fields");
    if (Validator.isNotNull(fields)) {
      fields="|" + fields;
    }
    ShoppingItem item=ShoppingItemLocalServiceUtil.getItem(itemId);
    if (item.getMinQuantity() > 0) {
      for (int i=0; i < item.getMinQuantity(); i++) {
        cart.addItemId(itemId,fields);
      }
    }
 else {
      cart.addItemId(itemId,fields);
    }
  }
 else {
    String itemIds=ParamUtil.getString(actionRequest,"itemIds");
    String couponCodes=ParamUtil.getString(actionRequest,"couponCodes");
    int altShipping=ParamUtil.getInteger(actionRequest,"altShipping");
    boolean insure=ParamUtil.getBoolean(actionRequest,"insure");
    cart.setItemIds(itemIds);
    cart.setCouponCodes(couponCodes);
    cart.setAltShipping(altShipping);
    cart.setInsure(insure);
  }
  ShoppingCartLocalServiceUtil.updateCart(cart.getUserId(),cart.getGroupId(),cart.getItemIds(),cart.getCouponCodes(),cart.getAltShipping(),cart.isInsure());
  if (cmd.equals(Constants.ADD) || cmd.equals(Constants.UPDATE)) {
    addSuccessMessage(actionRequest,actionResponse);
  }
}
