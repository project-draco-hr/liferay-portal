{
  try {
    ThemeDisplay themeDisplay=(ThemeDisplay)actionRequest.getAttribute(WebKeys.THEME_DISPLAY);
    long plid=ParamUtil.getLong(actionRequest,"plid");
    long groupId=ParamUtil.getLong(actionRequest,"groupId");
    String fileName=ParamUtil.getString(actionRequest,"exportFileName");
    boolean dateRange=ParamUtil.getBoolean(actionRequest,"dateRange");
    Date startDate=null;
    Date endDate=null;
    if (dateRange) {
      int startDateMonth=ParamUtil.getInteger(actionRequest,"startDateMonth");
      int startDateDay=ParamUtil.getInteger(actionRequest,"startDateDay");
      int startDateYear=ParamUtil.getInteger(actionRequest,"startDateYear");
      int startDateHour=ParamUtil.getInteger(actionRequest,"startDateHour");
      int startDateMinute=ParamUtil.getInteger(actionRequest,"startDateMinute");
      int startDateAmPm=ParamUtil.getInteger(actionRequest,"startDateAmPm");
      if (startDateAmPm == Calendar.PM) {
        startDateHour+=12;
      }
      startDate=PortalUtil.getDate(startDateMonth,startDateDay,startDateYear,startDateHour,startDateMinute,themeDisplay.getTimeZone(),new PortalException());
      int endDateMonth=ParamUtil.getInteger(actionRequest,"endDateMonth");
      int endDateDay=ParamUtil.getInteger(actionRequest,"endDateDay");
      int endDateYear=ParamUtil.getInteger(actionRequest,"endDateYear");
      int endDateHour=ParamUtil.getInteger(actionRequest,"endDateHour");
      int endDateMinute=ParamUtil.getInteger(actionRequest,"endDateMinute");
      int endDateAmPm=ParamUtil.getInteger(actionRequest,"endDateAmPm");
      if (endDateAmPm == Calendar.PM) {
        endDateHour+=12;
      }
      endDate=PortalUtil.getDate(endDateMonth,endDateDay,endDateYear,endDateHour,endDateMinute,themeDisplay.getTimeZone(),new PortalException());
    }
    FileCacheOutputStream fcos=LayoutServiceUtil.exportPortletInfoAsStream(plid,groupId,portlet.getPortletId(),actionRequest.getParameterMap(),startDate,endDate);
    HttpServletResponse response=PortalUtil.getHttpServletResponse(actionResponse);
    ServletResponseUtil.sendFile(response,fileName,fcos.getFileInputStream(),(int)fcos.getSize(),ContentTypes.APPLICATION_ZIP);
    setForward(actionRequest,ActionConstants.COMMON_NULL);
  }
 catch (  Exception e) {
    _log.error(e,e);
  }
}
