{
  Connection con=null;
  PreparedStatement ps=null;
  ResultSet rs=null;
  boolean isEmpty=true;
  String tempFilename="temp-db-" + _tableName + "-"+ System.currentTimeMillis();
  String selectSQL=getSelectSQL();
  BufferedWriter bw=new BufferedWriter(new FileWriter(tempFilename));
  try {
    con=HibernateUtil.getConnection();
    ps=con.prepareStatement(selectSQL);
    rs=ps.executeQuery();
    while (rs.next()) {
      bw.write(getExportedData(rs));
      isEmpty=false;
    }
    _log.info(_tableName + " table backed up to file " + tempFilename);
  }
  finally {
    DataAccess.cleanUp(con,ps,rs);
    bw.close();
  }
  if (!isEmpty) {
    Statement stmt=null;
    try {
      con=HibernateUtil.getConnection();
      stmt=con.createStatement();
      stmt.executeUpdate(getDeleteSQL());
    }
  finally {
      DataAccess.cleanUp(con,stmt);
    }
    String insertSQL=getInsertSQL();
    BufferedReader br=new BufferedReader(new FileReader(tempFilename));
    String line=null;
    try {
      con=HibernateUtil.getConnection();
      while ((line=br.readLine()) != null) {
        String[] values=StringUtil.split(line);
        if (values.length != _columns.length) {
          throw new UpgradeException("Columns differ between temp file and schema");
        }
        ps=con.prepareStatement(insertSQL);
        for (int i=0; i < values.length; i++) {
          setColumn(ps,i + 1,(Integer)_columns[i][1],values[i]);
        }
        ps.executeUpdate();
        ps.close();
      }
    }
  finally {
      DataAccess.cleanUp(con,ps);
      br.close();
    }
  }
  FileUtil.delete(tempFilename);
  _log.info(_tableName + " table repopulated with data");
}
