{
  Folder oldVersioningFolderEntry=getVersioningFolder(companyId,repositoryId,fileName,true);
  Folder newVersioningFolderEntry=getVersioningFolder(companyId,repositoryId,newFileName,true);
  List<Folder> folders=getFolders(oldVersioningFolderEntry);
  for (  Folder folder : folders) {
    String curFileName=folder.getName();
    Document document=getDocument(oldVersioningFolderEntry,curFileName);
    InputStream is=document.getContentStream().getStream();
    createDocument(newVersioningFolderEntry,curFileName,is);
  }
  oldVersioningFolderEntry.deleteTree(true,UnfileObject.DELETE,false);
  if (reindex) {
    Indexer indexer=IndexerRegistryUtil.getIndexer(FileModel.class);
    FileModel fileModel=new FileModel();
    fileModel.setCompanyId(companyId);
    fileModel.setFileName(fileName);
    fileModel.setPortletId(portletId);
    fileModel.setRepositoryId(repositoryId);
    indexer.delete(fileModel);
    fileModel.setFileName(newFileName);
    fileModel.setGroupId(groupId);
    indexer.reindex(fileModel);
  }
}
