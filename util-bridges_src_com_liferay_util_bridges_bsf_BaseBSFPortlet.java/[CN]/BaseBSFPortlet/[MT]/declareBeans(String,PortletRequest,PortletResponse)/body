{
  StringBuilder sb=new StringBuilder();
  sb.append(getGlobalScript());
  sb.append(code);
  String script=sb.toString();
  PortletConfig portletConfig=getPortletConfig();
  PortletContext portletContext=getPortletContext();
  PortletPreferences preferences=req.getPreferences();
  Map<String,String> userInfo=(Map<String,String>)req.getAttribute(PortletRequest.USER_INFO);
  bsfManager.declareBean("portletConfig",portletConfig,PortletConfig.class);
  bsfManager.declareBean("portletContext",portletContext,PortletContext.class);
  bsfManager.declareBean("preferences",preferences,PortletPreferences.class);
  bsfManager.declareBean("userInfo",userInfo,Map.class);
  if (req instanceof ActionRequest) {
    bsfManager.declareBean("actionRequest",req,ActionRequest.class);
  }
 else   if (req instanceof RenderRequest) {
    bsfManager.declareBean("renderRequest",req,RenderRequest.class);
  }
 else   if (req instanceof ResourceRequest) {
    bsfManager.declareBean("resourceRequest",req,ResourceRequest.class);
  }
  if (res instanceof ActionResponse) {
    bsfManager.declareBean("actionResponse",res,ActionResponse.class);
  }
 else   if (res instanceof RenderResponse) {
    bsfManager.declareBean("renderResponse",res,RenderResponse.class);
  }
 else   if (res instanceof ResourceResponse) {
    bsfManager.declareBean("resourceResponse",res,ResourceResponse.class);
  }
  bsfManager.exec(getScriptingEngineLanguage(),"(java)",1,1,script);
}
