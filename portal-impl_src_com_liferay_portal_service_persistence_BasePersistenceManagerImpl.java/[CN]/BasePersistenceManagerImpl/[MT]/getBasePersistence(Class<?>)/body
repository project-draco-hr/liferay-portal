{
  String modelClassName=entityClass.getName();
  String baseClassPath=extractBaseClassPath(modelClassName);
  String entityName=extractEntityName(modelClassName);
  String contextName=getContextName(baseClassPath,entityClass.getClassLoader());
  StringBuilder persistenceBeanIdBuilder=new StringBuilder();
  persistenceBeanIdBuilder.append(baseClassPath);
  persistenceBeanIdBuilder.append(".service.persistence.");
  persistenceBeanIdBuilder.append(entityName);
  persistenceBeanIdBuilder.append("Persistence.impl");
  String persistenceBeanId=persistenceBeanIdBuilder.toString();
  if (contextName == null) {
    return (BasePersistence)PortalBeanLocatorUtil.locate(persistenceBeanId);
  }
 else {
    return (BasePersistence)PortletBeanLocatorUtil.locate(contextName,persistenceBeanId);
  }
}
