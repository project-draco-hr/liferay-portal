{
  FreeMarkerContext freeMarkerContext=(FreeMarkerContext)templateContext;
  try {
    return FreeMarkerEngineUtil.mergeTemplate(getTemplateId(),getScript(),freeMarkerContext,unsyncStringWriter);
  }
 catch (  Exception e) {
    if (e instanceof ParseException || e instanceof TemplateException) {
      String errorTemplateId=getErrorTemplateId();
      String errorTemplateContent=getErrorTemplateContent();
      freeMarkerContext.put("exception",e.getMessage());
      freeMarkerContext.put("script",getScript());
      if (e instanceof ParseException) {
        ParseException pe=(ParseException)e;
        freeMarkerContext.put("column",pe.getColumnNumber());
        freeMarkerContext.put("line",pe.getLineNumber());
      }
      unsyncStringWriter.reset();
      return FreeMarkerEngineUtil.mergeTemplate(errorTemplateId,errorTemplateContent,freeMarkerContext,unsyncStringWriter);
    }
 else {
      throw e;
    }
  }
}
