{
  ActionRequestImpl reqImpl=(ActionRequestImpl)req;
  ActionResponseImpl resImpl=(ActionResponseImpl)res;
  HttpServletRequest httpReq=reqImpl.getHttpServletRequest();
  HttpServletResponse httpRes=resImpl.getHttpServletResponse();
  HttpSession httpSes=httpReq.getSession();
  ThemeDisplay themeDisplay=(ThemeDisplay)req.getAttribute(WebKeys.THEME_DISPLAY);
  Layout layout=themeDisplay.getLayout();
  String languageId=ParamUtil.getString(req,"languageId");
  Locale locale=LocaleUtil.fromLanguageId(languageId);
  List availableLocales=ListUtil.fromArray(LanguageUtil.getAvailableLocales());
  if (availableLocales.contains(locale)) {
    if (themeDisplay.isSignedIn()) {
      User user=themeDisplay.getUser();
      Contact contact=user.getContact();
      AdminUtil.updateUser(req,user.getUserId(),user.getScreenName(),user.getEmailAddress(),languageId,user.getTimeZoneId(),user.getGreeting(),user.getComments(),contact.getSmsSn(),contact.getAimSn(),contact.getIcqSn(),contact.getJabberSn(),contact.getMsnSn(),contact.getSkypeSn(),contact.getYmSn());
    }
    httpSes.setAttribute(Globals.LOCALE_KEY,locale);
    LanguageUtil.updateCookie(httpRes,locale);
  }
  res.sendRedirect(PortalUtil.getLayoutURL(layout,themeDisplay));
}
