{
  long resourcePrimKey=ParamUtil.getLong(request,"resourcePrimKey");
  String mvcPath=null;
  String rootPortletId=PortletConstants.getRootPortletId(portletId);
  if (rootPortletId.equals(PortletKeys.KNOWLEDGE_BASE_ARTICLE)) {
    mvcPath="/article/view_article.jsp";
  }
 else   if (rootPortletId.equals(PortletKeys.KNOWLEDGE_BASE_SECTION)) {
    mvcPath="/section/view_article.jsp";
  }
  PortletURL portletURL=PortletURLFactoryUtil.create(request,portletId,plid,PortletRequest.RENDER_PHASE);
  if (mvcPath != null) {
    portletURL.setParameter("mvcPath",mvcPath);
  }
  if ((kbArticle == null) || Validator.isNull(kbArticle.getUrlTitle())) {
    portletURL.setParameter("resourcePrimKey",String.valueOf(resourcePrimKey));
  }
 else {
    portletURL.setParameter("urlTitle",kbArticle.getUrlTitle());
    if (kbArticle.getKbFolderId() != KBFolderConstants.DEFAULT_PARENT_FOLDER_ID) {
      KBFolder kbFolder=KBFolderLocalServiceUtil.getKBFolder(kbArticle.getKbFolderId());
      portletURL.setParameter("kbFolderUrlTitle",String.valueOf(kbFolder.getUrlTitle()));
    }
  }
  portletURL.setPortletMode(PortletMode.VIEW);
  portletURL.setWindowState(LiferayWindowState.NORMAL);
  if (rootPortletId.equals(PortletKeys.KNOWLEDGE_BASE_SECTION)) {
    portletURL.setWindowState(LiferayWindowState.MAXIMIZED);
  }
  return portletURL;
}
