{
  if (!portletDataContext.isWithinDateRange(page.getModifiedDate())) {
    return;
  }
  String path=getPagePath(portletDataContext,page);
  page=(WikiPage)page.clone();
  Element pageElement=(Element)pagesElement.selectSingleNode("//page[@path='".concat(path).concat("']"));
  if (portletDataContext.isPathNotProcessed(path)) {
    if (pageElement == null) {
      pageElement=pagesElement.addElement("page");
    }
    String content=JournalPortletDataHandlerImpl.exportReferencedContent(portletDataContext,dlFileEntryTypesElement,dlFoldersElement,dlFileEntriesElement,dlFileRanksElement,dlRepositoriesElement,dlRepositoryEntriesElement,pageElement,page.getContent());
    page.setContent(content);
    String imagePath=getPageImagePath(portletDataContext,page);
    pageElement.addAttribute("image-path",imagePath);
    if (portletDataContext.getBooleanParameter(_NAMESPACE,"attachments") && page.isHead()) {
      List<DLFileEntry> attachmentsFiles=page.getAttachmentsFiles();
      for (int i=0; i < attachmentsFiles.size(); i++) {
        DLFileEntry attachment=attachmentsFiles.get(i);
        Element attachmentElement=pageElement.addElement("attachment");
        attachmentElement.addAttribute("name",attachment.getTitle());
        String binPath=getPageAttachementBinPath(portletDataContext,page,i);
        attachmentElement.addAttribute("bin-path",binPath);
        portletDataContext.addZipEntry(binPath,attachment.getContentStream());
      }
      page.setAttachmentsFolderId(page.getAttachmentsFolderId());
    }
    portletDataContext.addClassedModel(pageElement,path,page,_NAMESPACE);
  }
  exportNode(portletDataContext,nodesElement,page.getNodeId());
}
