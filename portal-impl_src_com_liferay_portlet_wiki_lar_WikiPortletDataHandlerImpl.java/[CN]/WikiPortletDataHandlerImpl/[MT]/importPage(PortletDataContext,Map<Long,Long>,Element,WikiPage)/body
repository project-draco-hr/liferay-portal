{
  long userId=context.getUserId(page.getUserUuid());
  long nodeId=MapUtil.getLong(nodePKs,page.getNodeId(),page.getNodeId());
  String[] tagsCategories=null;
  String[] tagsEntries=null;
  if (context.getBooleanParameter(_NAMESPACE,"categories")) {
    tagsCategories=context.getTagsCategories(WikiPage.class,page.getResourcePrimKey());
  }
  if (context.getBooleanParameter(_NAMESPACE,"tags")) {
    tagsEntries=context.getTagsEntries(WikiPage.class,page.getResourcePrimKey());
  }
  ServiceContext serviceContext=new ServiceContext();
  serviceContext.setTagsCategories(tagsCategories);
  serviceContext.setTagsEntries(tagsEntries);
  WikiPage existingPage=null;
  try {
    WikiNodeUtil.findByPrimaryKey(nodeId);
    if (context.getDataStrategy().equals(PortletDataHandlerKeys.DATA_STRATEGY_MIRROR)) {
      try {
        existingPage=WikiPageFinderUtil.findByUuid_G(page.getUuid(),context.getGroupId());
        existingPage=WikiPageLocalServiceUtil.updatePage(userId,nodeId,existingPage.getTitle(),0,page.getContent(),page.getSummary(),true,page.getFormat(),page.getParentTitle(),page.getRedirectTitle(),serviceContext);
      }
 catch (      NoSuchPageException nspe) {
        try {
          WikiPage wikiPage=WikiPageLocalServiceUtil.getPage(nodeId,page.getTitle());
          existingPage=WikiPageLocalServiceUtil.updatePage(userId,nodeId,page.getTitle(),wikiPage.getVersion(),page.getContent(),page.getSummary(),page.isMinorEdit(),page.getFormat(),page.getParentTitle(),page.getRedirectTitle(),serviceContext);
        }
 catch (        NoSuchPageException nspexception) {
          existingPage=WikiPageLocalServiceUtil.addPage(page.getUuid(),userId,nodeId,page.getTitle(),page.getVersion(),page.getContent(),page.getSummary(),true,page.getFormat(),page.getHead(),page.getParentTitle(),page.getRedirectTitle(),serviceContext);
        }
      }
    }
 else {
      existingPage=WikiPageLocalServiceUtil.addPage(null,userId,nodeId,page.getTitle(),page.getVersion(),page.getContent(),page.getSummary(),true,page.getFormat(),page.getHead(),page.getParentTitle(),page.getRedirectTitle(),serviceContext);
    }
    if (context.getBooleanParameter(_NAMESPACE,"attachments") && page.isHead()) {
      List<Element> attachmentEls=pageEl.elements("attachment");
      List<ObjectValuePair<String,byte[]>> files=new ArrayList<ObjectValuePair<String,byte[]>>();
      for (      Element attachmentEl : attachmentEls) {
        String name=attachmentEl.attributeValue("name");
        String binPath=attachmentEl.attributeValue("bin-path");
        byte[] bytes=context.getZipEntryAsByteArray(binPath);
        files.add(new ObjectValuePair<String,byte[]>(name,bytes));
      }
      if (files.size() > 0) {
        WikiPageLocalServiceUtil.addPageAttachments(nodeId,page.getTitle(),files);
      }
    }
    if (context.getBooleanParameter(_NAMESPACE,"comments")) {
      context.importComments(WikiPage.class,page.getResourcePrimKey(),existingPage.getResourcePrimKey(),context.getGroupId());
    }
    if (context.getBooleanParameter(_NAMESPACE,"ratings")) {
      context.importRatingsEntries(WikiPage.class,page.getResourcePrimKey(),existingPage.getResourcePrimKey());
    }
  }
 catch (  NoSuchNodeException nsne) {
    _log.error("Could not find the node for page " + page.getPageId());
  }
}
