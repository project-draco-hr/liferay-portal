{
  long userId=portletDataContext.getUserId(page.getUserUuid());
  Map<Long,Long> nodePKs=(Map<Long,Long>)portletDataContext.getNewPrimaryKeysMap(WikiNode.class);
  long nodeId=MapUtil.getLong(nodePKs,page.getNodeId(),page.getNodeId());
  String content=page.getContent();
  content=JournalPortletDataHandlerImpl.importDLFileEntries(portletDataContext,pageElement,content);
  content=JournalPortletDataHandlerImpl.importIGImages(portletDataContext,pageElement,content);
  Group group=GroupLocalServiceUtil.getGroup(portletDataContext.getScopeGroupId());
  content=StringUtil.replace(content,"@data_handler_group_friendly_url@",group.getFriendlyURL());
  content=JournalPortletDataHandlerImpl.importLinksToLayout(portletDataContext,content);
  page.setContent(content);
  long[] assetCategoryIds=null;
  String[] assetTagNames=null;
  if (portletDataContext.getBooleanParameter(_NAMESPACE,"categories") && page.isHead()) {
    assetCategoryIds=portletDataContext.getAssetCategoryIds(WikiPage.class,page.getResourcePrimKey());
  }
  if (portletDataContext.getBooleanParameter(_NAMESPACE,"tags") && page.isHead()) {
    assetTagNames=portletDataContext.getAssetTagNames(WikiPage.class,page.getResourcePrimKey());
  }
  ServiceContext serviceContext=new ServiceContext();
  serviceContext.setAddCommunityPermissions(true);
  serviceContext.setAddGuestPermissions(true);
  serviceContext.setAssetCategoryIds(assetCategoryIds);
  serviceContext.setAssetTagNames(assetTagNames);
  serviceContext.setCreateDate(page.getCreateDate());
  serviceContext.setModifiedDate(page.getModifiedDate());
  if (page.getStatus() != WorkflowConstants.STATUS_APPROVED) {
    serviceContext.setWorkflowAction(WorkflowConstants.ACTION_SAVE_DRAFT);
  }
  WikiPage importedPage=null;
  if (portletDataContext.isDataStrategyMirror()) {
    WikiPage existingPage=WikiPageUtil.fetchByUUID_G(page.getUuid(),portletDataContext.getScopeGroupId());
    if (existingPage == null) {
      try {
        existingPage=WikiPageLocalServiceUtil.getPage(nodeId,page.getTitle());
      }
 catch (      NoSuchPageException nspe) {
      }
    }
    if (existingPage == null) {
      serviceContext.setUuid(page.getUuid());
      importedPage=WikiPageLocalServiceUtil.addPage(userId,nodeId,page.getTitle(),page.getVersion(),page.getContent(),page.getSummary(),true,page.getFormat(),page.getHead(),page.getParentTitle(),page.getRedirectTitle(),serviceContext);
    }
 else {
      importedPage=WikiPageLocalServiceUtil.updatePage(userId,nodeId,existingPage.getTitle(),0,page.getContent(),page.getSummary(),true,page.getFormat(),page.getParentTitle(),page.getRedirectTitle(),serviceContext);
    }
  }
 else {
    importedPage=WikiPageLocalServiceUtil.addPage(userId,nodeId,page.getTitle(),page.getVersion(),page.getContent(),page.getSummary(),true,page.getFormat(),page.getHead(),page.getParentTitle(),page.getRedirectTitle(),serviceContext);
  }
  if (portletDataContext.getBooleanParameter(_NAMESPACE,"attachments") && page.isHead()) {
    for (    Element attachmentElement : pageElement.elements("attachment")) {
      String name=attachmentElement.attributeValue("name");
      String binPath=attachmentElement.attributeValue("bin-path");
      InputStream inputStream=portletDataContext.getZipEntryAsInputStream(binPath);
      WikiPageLocalServiceUtil.addPageAttachment(importedPage.getCompanyId(),importedPage.getAttachmentsDir(),importedPage.getModifiedDate(),name,inputStream);
    }
  }
  if (page.isHead()) {
    portletDataContext.importPermissions(WikiPage.class,page.getResourcePrimKey(),importedPage.getResourcePrimKey());
  }
  if (portletDataContext.getBooleanParameter(_NAMESPACE,"comments") && page.isHead()) {
    portletDataContext.importComments(WikiPage.class,page.getResourcePrimKey(),importedPage.getResourcePrimKey(),portletDataContext.getScopeGroupId());
  }
  if (portletDataContext.getBooleanParameter(_NAMESPACE,"ratings") && page.isHead()) {
    portletDataContext.importRatingsEntries(WikiPage.class,page.getResourcePrimKey(),importedPage.getResourcePrimKey());
  }
}
