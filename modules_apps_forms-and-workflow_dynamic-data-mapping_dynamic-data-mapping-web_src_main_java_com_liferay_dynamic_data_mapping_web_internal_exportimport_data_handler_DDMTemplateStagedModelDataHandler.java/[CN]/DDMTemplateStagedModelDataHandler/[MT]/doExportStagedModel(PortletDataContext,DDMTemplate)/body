{
  Element templateElement=portletDataContext.getExportDataElement(template);
  DDMStructure structure=_ddmStructureLocalService.fetchStructure(template.getClassPK());
  if (structure != null) {
    StagedModelDataHandlerUtil.exportReferenceStagedModel(portletDataContext,template,structure,PortletDataContext.REFERENCE_TYPE_STRONG);
  }
  if (template.isSmallImage()) {
    if (Validator.isNotNull(template.getSmallImageURL())) {
      String smallImageURL=_exportImportContentProcessorController.replaceExportContentReferences(portletDataContext,template,template.getSmallImageURL() + StringPool.SPACE,true,true);
      template.setSmallImageURL(smallImageURL);
    }
 else {
      Image smallImage=_imageLocalService.fetchImage(template.getSmallImageId());
      if ((smallImage != null) && (smallImage.getTextObj() != null)) {
        String smallImagePath=ExportImportPathUtil.getModelPath(template,smallImage.getImageId() + StringPool.PERIOD + template.getSmallImageType());
        templateElement.addAttribute("small-image-path",smallImagePath);
        template.setSmallImageType(smallImage.getType());
        portletDataContext.addZipEntry(smallImagePath,smallImage.getTextObj());
      }
 else {
        if (_log.isWarnEnabled()) {
          StringBundler sb=new StringBundler(4);
          sb.append("Unable to export small image ");
          sb.append(template.getSmallImageId());
          sb.append(" to template ");
          sb.append(template.getTemplateKey());
          _log.warn(sb.toString());
        }
        template.setSmallImage(false);
        template.setSmallImageId(0);
      }
    }
  }
  String script=_exportImportContentProcessorController.replaceExportContentReferences(portletDataContext,template,template.getScript(),portletDataContext.getBooleanParameter(DDMPortletDataHandler.NAMESPACE,"referenced-content"),true);
  template.setScript(script);
  long defaultUserId=_userLocalService.getDefaultUserId(template.getCompanyId());
  if (defaultUserId == template.getUserId()) {
    templateElement.addAttribute("preloaded","true");
  }
  if (template.getResourceClassNameId() > 0) {
    templateElement.addAttribute("resource-class-name",PortalUtil.getClassName(template.getResourceClassNameId()));
  }
  portletDataContext.addClassedModel(templateElement,ExportImportPathUtil.getModelPath(template),template);
}
