{
  OutputStream os=null;
  try {
    if (!mimeResponse.isCommitted()) {
      if (contentLength == 0) {
        contentLength=bytes.length;
      }
      if (mimeResponse instanceof ResourceResponse) {
        ResourceResponse resourceResponse=(ResourceResponse)mimeResponse;
        resourceResponse.setContentLength(contentLength);
      }
      os=new UnsyncBufferedOutputStream(mimeResponse.getPortletOutputStream());
      os.write(bytes,0,contentLength);
    }
  }
  finally {
    StreamUtil.cleanUp(os);
  }
}
