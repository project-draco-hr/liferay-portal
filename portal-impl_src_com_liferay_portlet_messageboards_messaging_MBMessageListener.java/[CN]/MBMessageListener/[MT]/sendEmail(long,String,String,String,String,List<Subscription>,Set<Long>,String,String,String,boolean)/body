{
  List<InternetAddress> addresses=new ArrayList<InternetAddress>();
  for (  Subscription subscription : subscriptions) {
    long subscribedUserId=subscription.getUserId();
    if (sent.contains(subscribedUserId)) {
      if (_log.isDebugEnabled()) {
        _log.debug("Do not send a duplicate email to user " + subscribedUserId);
      }
      continue;
    }
 else {
      if (_log.isDebugEnabled()) {
        _log.debug("Add user " + subscribedUserId + " to the list of users who have received an email");
      }
      sent.add(subscribedUserId);
    }
    User user=null;
    try {
      user=UserLocalServiceUtil.getUserById(subscription.getUserId());
    }
 catch (    NoSuchUserException nsue) {
      if (_log.isInfoEnabled()) {
        _log.info("Subscription " + subscription.getSubscriptionId() + " is stale and will be deleted");
      }
      SubscriptionLocalServiceUtil.deleteSubscription(subscription.getSubscriptionId());
      continue;
    }
    InternetAddress userAddress=new InternetAddress(user.getEmailAddress(),user.getFullName());
    addresses.add(userAddress);
  }
  try {
    InternetAddress[] bulkAddresses=addresses.toArray(new InternetAddress[addresses.size()]);
    if (bulkAddresses.length == 0) {
      return;
    }
    InternetAddress from=new InternetAddress(fromAddress,fromName);
    InternetAddress to=new InternetAddress(replyToAddress,replyToAddress);
    String curSubject=StringUtil.replace(subject,new String[]{"[$TO_ADDRESS$]","[$TO_NAME$]"},new String[]{replyToAddress,replyToAddress});
    String curBody=StringUtil.replace(body,new String[]{"[$TO_ADDRESS$]","[$TO_NAME$]"},new String[]{replyToAddress,replyToAddress});
    InternetAddress replyTo=new InternetAddress(replyToAddress,replyToAddress);
    if (htmlFormat) {
      try {
        curBody=BBCodeUtil.getHTML(curBody);
      }
 catch (      Exception e) {
        _log.error("Could not parse message " + mailId + " "+ e.getMessage());
      }
    }
    MailMessage message=new MailMessage(from,to,curSubject,curBody,htmlFormat);
    message.setBulkAddresses(bulkAddresses);
    message.setMessageId(mailId);
    message.setInReplyTo(inReplyTo);
    message.setReplyTo(new InternetAddress[]{replyTo});
    MailServiceUtil.sendEmail(message);
  }
 catch (  Exception e) {
    _log.error(e);
  }
}
