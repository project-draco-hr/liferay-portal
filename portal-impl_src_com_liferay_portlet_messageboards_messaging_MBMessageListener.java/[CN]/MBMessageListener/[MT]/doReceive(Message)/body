{
  long companyId=message.getLong("companyId");
  long userId=message.getLong("userId");
  long groupId=message.getLong("groupId");
  String categoryIds=message.getString("categoryIds");
  long threadId=message.getLong("threadId");
  String fromName=message.getString("fromName");
  String fromAddress=message.getString("fromAddress");
  String subject=message.getString("subject");
  String body=message.getString("body");
  String replyToAddress=message.getString("replyToAddress");
  String mailId=message.getString("mailId");
  String inReplyTo=message.getString("inReplyTo");
  boolean htmlFormat=message.getBoolean("htmlFormat");
  boolean sourceMailingList=message.getBoolean("sourceMailingList");
  if (sourceMailingList) {
    subject=getMailingListSubject(subject,mailId);
  }
  if (_log.isInfoEnabled()) {
    _log.info("Sending notifications for {mailId=" + mailId + ", threadId="+ threadId+ ", categoryIds="+ categoryIds+ "}");
  }
  SubscriptionSender subscriptionSender=new MBSubscriptionSender();
  subscriptionSender.setCompanyId(companyId);
  subscriptionSender.setUserId(userId);
  subscriptionSender.setGroupId(groupId);
  subscriptionSender.setFrom(fromName,fromAddress);
  subscriptionSender.setSubject(subject);
  subscriptionSender.setBody(body);
  subscriptionSender.setReplyToAddress(replyToAddress);
  subscriptionSender.setMailId(mailId);
  subscriptionSender.setInReplyTo(inReplyTo);
  subscriptionSender.setHtmlFormat(htmlFormat);
  subscriptionSender.setBulk(true);
  long[] categoryIdsArray=StringUtil.split(categoryIds,0L);
  for (  long categoryId : categoryIdsArray) {
    if (categoryId == MBCategoryConstants.DEFAULT_PARENT_CATEGORY_ID) {
      categoryId=groupId;
    }
    subscriptionSender.notifyPersistedSubscribers(MBCategory.class.getName(),categoryId);
  }
  subscriptionSender.notifyPersistedSubscribers(MBThread.class.getName(),threadId);
  if (!sourceMailingList) {
    subscriptionSender.setBulk(false);
    for (    long categoryId : categoryIdsArray) {
      notifyMailingList(groupId,categoryId,subscriptionSender,getMailingListSubject(subject,mailId));
    }
  }
  if (_log.isInfoEnabled()) {
    _log.info("Finished sending notifications");
  }
}
