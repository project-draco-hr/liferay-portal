{
  long companyId=message.getLong("companyId");
  long userId=message.getLong("userId");
  long groupId=message.getLong("groupId");
  String categoryIds=message.getString("categoryIds");
  long threadId=message.getLong("threadId");
  String fromName=message.getString("fromName");
  String fromAddress=message.getString("fromAddress");
  String subject=message.getString("subject");
  String body=message.getString("body");
  String replyToAddress=message.getString("replyToAddress");
  String mailId=message.getString("mailId");
  String inReplyTo=message.getString("inReplyTo");
  boolean htmlFormat=message.getBoolean("htmlFormat");
  boolean sourceMailingList=message.getBoolean("sourceMailingList");
  if (sourceMailingList) {
    subject=getMailingListSubject(subject,mailId);
  }
  Set<Long> sent=new HashSet<Long>();
  if (_log.isInfoEnabled()) {
    _log.info("Sending notifications for {mailId=" + mailId + ", threadId="+ threadId+ ", categoryIds="+ categoryIds+ "}");
  }
  List<Subscription> subscriptions=SubscriptionLocalServiceUtil.getSubscriptions(companyId,MBThread.class.getName(),threadId);
  sendEmail(userId,groupId,fromName,fromAddress,subject,body,subscriptions,sent,replyToAddress,mailId,inReplyTo,htmlFormat);
  long[] categoryIdsArray=StringUtil.split(categoryIds,0L);
  for (  long categoryId : categoryIdsArray) {
    if (categoryId == MBCategoryConstants.DEFAULT_PARENT_CATEGORY_ID) {
      categoryId=groupId;
    }
    subscriptions=SubscriptionLocalServiceUtil.getSubscriptions(companyId,MBCategory.class.getName(),categoryId);
    sendEmail(userId,groupId,fromName,fromAddress,subject,body,subscriptions,sent,replyToAddress,mailId,inReplyTo,htmlFormat);
  }
  if (!sourceMailingList) {
    for (    long categoryId : categoryIdsArray) {
      try {
        notifyMailingList(subject,body,replyToAddress,mailId,inReplyTo,htmlFormat,groupId,categoryId);
      }
 catch (      NoSuchMailingListException nsmle) {
      }
    }
  }
  if (_log.isInfoEnabled()) {
    _log.info("Finished sending notifications");
  }
}
