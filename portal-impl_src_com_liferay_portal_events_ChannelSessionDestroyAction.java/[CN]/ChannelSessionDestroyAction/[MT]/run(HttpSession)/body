{
  User user=null;
  try {
    user=(User)session.getAttribute(WebKeys.USER);
  }
 catch (  IllegalStateException ise) {
    return;
  }
  try {
    if (user == null) {
      Long userId=(Long)session.getAttribute(WebKeys.USER_ID);
      if (userId != null) {
        user=UserLocalServiceUtil.getUser(userId);
      }
    }
    if ((user == null) || user.isDefaultUser()) {
      return;
    }
    if (_log.isDebugEnabled()) {
      _log.debug("Destroying channel " + user.getUserId());
    }
    try {
      ChannelHubManagerUtil.destroyChannel(user.getCompanyId(),user.getUserId());
    }
 catch (    ChannelException ce) {
      if (_log.isDebugEnabled()) {
        _log.debug("User channel " + user.getUserId() + " is already unregistered",ce);
      }
    }
  }
 catch (  Exception e) {
    _log.error(e,e);
  }
}
