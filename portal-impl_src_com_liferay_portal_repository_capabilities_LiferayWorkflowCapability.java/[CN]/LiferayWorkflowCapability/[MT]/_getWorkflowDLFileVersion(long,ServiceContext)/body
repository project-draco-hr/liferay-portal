{
  DLFileEntry dlFileEntry=DLFileEntryLocalServiceUtil.getDLFileEntry(fileEntryId);
  boolean checkedOut=dlFileEntry.isCheckedOut();
  DLFileVersion dlFileVersion=DLFileVersionLocalServiceUtil.getLatestFileVersion(fileEntryId,!checkedOut);
  boolean autoCheckIn=!checkedOut && dlFileVersion.isApproved();
  if (autoCheckIn) {
    return new DLFileVersionReference(autoCheckIn,fileEntryId,null);
  }
  int workflowAction=serviceContext.getWorkflowAction();
  if (!checkedOut && (workflowAction == WorkflowConstants.ACTION_PUBLISH)) {
    return new DLFileVersionReference(autoCheckIn,fileEntryId,dlFileVersion);
  }
  return new DLFileVersionReference(autoCheckIn,fileEntryId,null);
}
