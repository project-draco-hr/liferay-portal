{
  StringBundler sb=new StringBundler();
  sb.append(themeDisplay.getPathMain());
  sb.append("/portal/render_portlet?");
  long plid=themeDisplay.getPlid();
  sb.append("p_l_id=");
  sb.append(plid);
  Portlet portlet=(Portlet)request.getAttribute(WebKeys.RENDER_PORTLET);
  String portletId=portlet.getPortletId();
  sb.append("&p_p_id=");
  sb.append(portletId);
  sb.append("&p_p_lifecycle=0");
  WindowState windowState=WindowState.NORMAL;
  LayoutTypePortlet layoutTypePortlet=themeDisplay.getLayoutTypePortlet();
  if (layoutTypePortlet.hasStateMaxPortletId(portletId)) {
    windowState=WindowState.MAXIMIZED;
  }
 else   if (layoutTypePortlet.hasStateMinPortletId(portletId)) {
    windowState=WindowState.MINIMIZED;
  }
  sb.append("&p_p_state=");
  sb.append(windowState);
  sb.append("&p_p_mode=view");
  String columnId=(String)request.getAttribute(WebKeys.RENDER_PORTLET_COLUMN_ID);
  sb.append("&p_p_col_id=");
  sb.append(columnId);
  Integer columnPos=(Integer)request.getAttribute(WebKeys.RENDER_PORTLET_COLUMN_POS);
  sb.append("&p_p_col_pos=");
  sb.append(columnPos);
  Integer columnCount=(Integer)request.getAttribute(WebKeys.RENDER_PORTLET_COLUMN_COUNT);
  sb.append("&p_p_col_count=");
  sb.append(columnCount);
  if (portlet.isStatic()) {
    sb.append("&p_p_static=1");
    if (portlet.isStaticStart()) {
      sb.append("&p_p_static_start=1");
    }
  }
  sb.append("&p_p_isolated=1");
  String doAsUserId=themeDisplay.getDoAsUserId();
  if (Validator.isNotNull(doAsUserId)) {
    sb.append("&doAsUserId=");
    sb.append(HttpUtil.encodeURL(doAsUserId));
  }
  String currentURL=PortalUtil.getCurrentURL(request);
  sb.append("&currentURL=");
  sb.append(HttpUtil.encodeURL(currentURL));
  String ppid=ParamUtil.getString(request,"p_p_id");
  if (ppid.equals(portletId)) {
    Enumeration<String> enu=request.getParameterNames();
    while (enu.hasMoreElements()) {
      String name=enu.nextElement();
      if (!PortalUtil.isReservedParameter(name)) {
        String[] values=request.getParameterValues(name);
        for (int i=0; i < values.length; i++) {
          sb.append(StringPool.AMPERSAND);
          sb.append(name);
          sb.append(StringPool.EQUAL);
          sb.append(HttpUtil.encodeURL(values[i]));
        }
      }
    }
    Map<String,String[]> renderParameters=RenderParametersPool.get(request,plid,ppid);
    Iterator<String> itr=renderParameters.keySet().iterator();
    while (itr.hasNext()) {
      String name=itr.next();
      String[] values=renderParameters.get(name);
      for (int i=0; i < values.length; i++) {
        sb.append(StringPool.AMPERSAND);
        sb.append(name);
        sb.append(StringPool.EQUAL);
        sb.append(HttpUtil.encodeURL(values[i]));
      }
    }
  }
  return sb.toString();
}
