{
  HttpServletRequest request=(HttpServletRequest)pageContext.getRequest();
  ThemeDisplay themeDisplay=(ThemeDisplay)request.getAttribute(WebKeys.THEME_DISPLAY);
  String value=null;
  if (themeDisplay != null) {
    value=get(themeDisplay.getCompanyId(),themeDisplay.getLocale(),key,defaultValue);
    if (value != defaultValue) {
      return value;
    }
  }
  if (key == null) {
    return null;
  }
  try {
    value=TagUtils.getInstance().message(pageContext,null,null,key);
  }
 catch (  Exception e) {
    _log.error(e);
  }
  if (value == null) {
    PortletConfig portletConfig=(PortletConfig)request.getAttribute(JavaConstants.JAVAX_PORTLET_CONFIG);
    if (portletConfig != null) {
      Locale locale=request.getLocale();
      ResourceBundle bundle=portletConfig.getResourceBundle(locale);
      try {
        value=bundle.getString(key);
      }
 catch (      MissingResourceException mre) {
      }
    }
    if ((value == defaultValue) || (value == null) && portletConfig.getPortletName().equals(PortletKeys.PORTLET_CONFIGURATION)) {
      String portletResource=ParamUtil.getString(request,"portletResource");
      long companyId=PortalUtil.getCompanyId(request);
      try {
        Portlet portlet=PortletLocalServiceUtil.getPortletById(companyId,portletResource);
        portletConfig=PortletConfigFactory.create(portlet,pageContext.getServletContext());
        if (portletConfig != null) {
          Locale locale=request.getLocale();
          ResourceBundle bundle=portletConfig.getResourceBundle(locale);
          try {
            value=bundle.getString(key);
          }
 catch (          MissingResourceException mre) {
          }
        }
      }
 catch (      Exception e) {
      }
    }
  }
  if (value == null) {
    value=defaultValue;
  }
  return value;
}
