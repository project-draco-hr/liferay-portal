{
  PermissionChecker permissionChecker=PermissionThreadLocal.getPermissionChecker();
  long[] allCategoryIds=_assetEntryQuery.getAllCategoryIds();
  if (allCategoryIds.length == 0) {
    return;
  }
  long[] filteredAllCategoryIds=AssetUtil.filterCategoryIds(permissionChecker,allCategoryIds);
  if (allCategoryIds.length != filteredAllCategoryIds.length) {
    contextQuery.addTerm(Field.ASSET_CATEGORY_IDS,"-1",false,BooleanClauseOccur.MUST);
    return;
  }
  BooleanQuery categoryIdsQuery=BooleanQueryFactoryUtil.create(searchContext);
  for (  long allCategoryId : filteredAllCategoryIds) {
    AssetCategory assetCategory=AssetCategoryLocalServiceUtil.fetchAssetCategory(allCategoryId);
    if (assetCategory == null) {
      continue;
    }
    List<Long> categoryIds=new ArrayList<Long>();
    if (PropsValues.ASSET_CATEGORIES_SEARCH_HIERARCHICAL) {
      categoryIds=AssetCategoryLocalServiceUtil.getSubcategoryIds(allCategoryId);
    }
    if (categoryIds.isEmpty()) {
      categoryIds.add(allCategoryId);
    }
    BooleanQuery categoryIdQuery=BooleanQueryFactoryUtil.create(searchContext);
    for (    long categoryId : categoryIds) {
      categoryIdQuery.addTerm(Field.ASSET_CATEGORY_IDS,categoryId);
    }
    categoryIdsQuery.add(categoryIdQuery,BooleanClauseOccur.MUST);
  }
  contextQuery.add(categoryIdsQuery,BooleanClauseOccur.MUST);
}
