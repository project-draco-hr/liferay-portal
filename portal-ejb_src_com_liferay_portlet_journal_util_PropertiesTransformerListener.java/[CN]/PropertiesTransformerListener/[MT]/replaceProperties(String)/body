{
  Map tokens=getTokens();
  String templateId=(String)tokens.get("template_id");
  if ((templateId == null) || ((templateId != null) && (templateId.equals(_GLOBAL_PROPERTIES)))) {
    return s;
  }
  Properties props=new Properties();
  try {
    Map newTokens=CollectionFactory.getHashMap();
    MapUtil.copy(tokens,newTokens);
    newTokens.put("template_id",_GLOBAL_PROPERTIES);
    String companyId=(String)tokens.get("company_id");
    long groupId=GetterUtil.getLong((String)tokens.get("group_id"));
    String script=JournalUtil.getTemplateScript(companyId,groupId,_GLOBAL_PROPERTIES,newTokens,getLanguageId());
    PropertiesUtil.load(props,script);
  }
 catch (  Exception e) {
    _log.error(e);
  }
  if (props.size() == 0) {
    return s;
  }
  String[] escapedKeys=new String[props.size()];
  String[] escapedValues=new String[props.size()];
  String[] keys=new String[props.size()];
  String[] values=new String[props.size()];
  String[] tempEscapedKeys=new String[props.size()];
  String[] tempEscapedValues=new String[props.size()];
  int counter=0;
  Iterator itr=props.entrySet().iterator();
  while (itr.hasNext()) {
    Map.Entry entry=(Map.Entry)itr.next();
    String key=(String)entry.getKey();
    String value=(String)entry.getValue();
    String escapedKey=StringPool.AT + StringPool.AT + key+ StringPool.AT+ StringPool.AT;
    String actualKey=StringPool.AT + key + StringPool.AT;
    String tempEscapedKey=TokensTransformerListener.TEMP_ESCAPED_AT_OPEN + key + TokensTransformerListener.TEMP_ESCAPED_AT_CLOSE;
    escapedKeys[counter]=escapedKey;
    escapedValues[counter]=tempEscapedKey;
    keys[counter]=actualKey;
    values[counter]=value;
    tempEscapedKeys[counter]=tempEscapedKey;
    tempEscapedValues[counter]=actualKey;
    counter++;
  }
  s=StringUtil.replace(s,escapedKeys,escapedValues);
  s=StringUtil.replace(s,keys,values);
  s=StringUtil.replace(s,tempEscapedKeys,tempEscapedValues);
  return s;
}
