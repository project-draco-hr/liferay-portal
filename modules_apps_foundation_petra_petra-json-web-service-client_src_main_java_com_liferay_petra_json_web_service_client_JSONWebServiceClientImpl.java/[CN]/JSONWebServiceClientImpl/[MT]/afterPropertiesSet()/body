{
  HttpClientBuilder httpClientBuilder=HttpClients.custom();
  httpClientBuilder=httpClientBuilder.useSystemProperties();
  HttpClientConnectionManager httpClientConnectionManager=getPoolingHttpClientConnectionManager();
  httpClientBuilder.setConnectionManager(httpClientConnectionManager);
  if ((!isNull(_login) && !isNull(_password)) || (!isNull(_proxyLogin) && !isNull(_proxyPassword))) {
    CredentialsProvider credentialsProvider=new BasicCredentialsProvider();
    if (!isNull(_login)) {
      credentialsProvider.setCredentials(new AuthScope(_hostName,_hostPort),new UsernamePasswordCredentials(_login,_password));
    }
 else {
      if (_logger.isInfoEnabled()) {
        _logger.info("No credentials are used");
      }
    }
    if (!isNull(_proxyLogin)) {
      credentialsProvider.setCredentials(new AuthScope(_proxyHostName,_proxyHostPort),new UsernamePasswordCredentials(_proxyLogin,_proxyPassword));
    }
    httpClientBuilder.setDefaultCredentialsProvider(credentialsProvider);
    httpClientBuilder.setRetryHandler(new HttpRequestRetryHandlerImpl());
  }
  try {
    if (_proxySelector != null) {
      httpClientBuilder.setRoutePlanner(new SystemDefaultRoutePlanner(_proxySelector));
    }
 else {
      setProxyHost(httpClientBuilder);
    }
    if (!isNull(_proxyAuthType) && _proxyAuthType.equalsIgnoreCase("ntlm")) {
      RegistryBuilder registerBuilder=RegistryBuilder.<AuthSchemeProvider>create();
      registerBuilder=registerBuilder.register(AuthSchemes.NTLM,new JCIFSNTLMSchemeFactory(_proxyDomain,_proxyWorkstation));
      Lookup<AuthSchemeProvider> authSchemeRegistry=registerBuilder.build();
      httpClientBuilder.setDefaultAuthSchemeRegistry(authSchemeRegistry);
    }
    _closeableHttpClient=httpClientBuilder.build();
    _idleConnectionMonitorThread=new IdleConnectionMonitorThread(httpClientConnectionManager);
    _idleConnectionMonitorThread.start();
    if (_logger.isDebugEnabled()) {
      _logger.debug("Configured client for " + _protocol + "://"+ _hostName);
    }
  }
 catch (  Exception e) {
    _logger.error("Unable to configure client",e);
  }
}
