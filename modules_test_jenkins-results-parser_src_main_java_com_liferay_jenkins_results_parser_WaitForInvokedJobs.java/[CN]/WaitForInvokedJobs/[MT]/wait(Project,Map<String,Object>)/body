{
  TopLevelJob topLevelJob=(TopLevelJob)beanShellMap.get(BEANSHELL_MAP_TOP_LEVEL_JOB_KEY);
  if (topLevelJob == null) {
    throw new NullPointerException("topLevelJob does not exist in beanShellMap");
  }
  beanShellMap.remove(BEANSHELL_MAP_TOP_LEVEL_JOB_KEY);
  long maxStartingTime=900000;
  if (project.getProperty(MAX_STARTING_TIME_PROPERTY_NAME) != null) {
    maxStartingTime=Long.parseLong(project.getProperty(MAX_STARTING_TIME_PROPERTY_NAME)) * 60000;
  }
  long maxWaitTime=7200000;
  if (project.getProperty(MAX_WAIT_TIME_PROPERTY_NAME) != null) {
    maxWaitTime=Long.parseLong(project.getProperty(MAX_WAIT_TIME_PROPERTY_NAME)) * 60000;
  }
  long updatePeriod=30000;
  if (project.getProperty(UPDATE_PERIOD_PROPERTY_NAME) != null) {
    updatePeriod=Long.parseLong(project.getProperty(UPDATE_PERIOD_PROPERTY_NAME)) * 1000;
  }
  wait(topLevelJob,updatePeriod,maxStartingTime,maxWaitTime);
  List<DownstreamJob> completedJobs=topLevelJob.getDownstreamJobs("completed");
  String completedBuildURLs=StringUtils.join(getBuildURLs(completedJobs),",");
  project.setProperty(COMPLETED_BUILD_URLS_PROPERTY_NAME,completedBuildURLs);
  return topLevelJob;
}
