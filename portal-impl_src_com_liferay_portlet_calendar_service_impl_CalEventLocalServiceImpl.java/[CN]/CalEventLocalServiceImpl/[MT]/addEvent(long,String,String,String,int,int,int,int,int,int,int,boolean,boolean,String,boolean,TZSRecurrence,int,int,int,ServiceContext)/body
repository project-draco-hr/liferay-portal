{
  User user=userPersistence.findByPrimaryKey(userId);
  long groupId=serviceContext.getScopeGroupId();
  Locale locale=null;
  TimeZone timeZone=null;
  if (timeZoneSensitive) {
    locale=user.getLocale();
    timeZone=user.getTimeZone();
  }
 else {
    locale=LocaleUtil.getSiteDefault();
    timeZone=TimeZoneUtil.getTimeZone(StringPool.UTC);
  }
  Calendar startDate=CalendarFactoryUtil.getCalendar(timeZone,locale);
  startDate.set(Calendar.MONTH,startDateMonth);
  startDate.set(Calendar.DATE,startDateDay);
  startDate.set(Calendar.YEAR,startDateYear);
  startDate.set(Calendar.HOUR_OF_DAY,startDateHour);
  startDate.set(Calendar.MINUTE,startDateMinute);
  startDate.set(Calendar.SECOND,0);
  startDate.set(Calendar.MILLISECOND,0);
  if (allDay) {
    startDate.set(Calendar.HOUR_OF_DAY,0);
    startDate.set(Calendar.MINUTE,0);
    durationHour=24;
    durationMinute=0;
  }
  validate(title,startDateMonth,startDateDay,startDateYear,durationHour,durationMinute,allDay,repeating,recurrence);
  long eventId=counterLocalService.increment();
  CalEvent event=calEventPersistence.create(eventId);
  event.setUuid(serviceContext.getUuid());
  event.setGroupId(groupId);
  event.setCompanyId(user.getCompanyId());
  event.setUserId(user.getUserId());
  event.setUserName(user.getFullName());
  event.setTitle(title);
  event.setDescription(description);
  event.setLocation(location);
  event.setStartDate(startDate.getTime());
  event.setEndDate(getEndDate(recurrence));
  event.setDurationHour(durationHour);
  event.setDurationMinute(durationMinute);
  event.setAllDay(allDay);
  event.setTimeZoneSensitive(timeZoneSensitive);
  event.setType(type);
  event.setRepeating(repeating);
  event.setRecurrenceObj(recurrence);
  event.setRemindBy(remindBy);
  event.setFirstReminder(firstReminder);
  event.setSecondReminder(secondReminder);
  event.setExpandoBridgeAttributes(serviceContext);
  calEventPersistence.update(event);
  if (serviceContext.isAddGroupPermissions() || serviceContext.isAddGuestPermissions()) {
    addEventResources(event,serviceContext.isAddGroupPermissions(),serviceContext.isAddGuestPermissions());
  }
 else {
    addEventResources(event,serviceContext.getGroupPermissions(),serviceContext.getGuestPermissions());
  }
  updateAsset(userId,event,serviceContext.getAssetCategoryIds(),serviceContext.getAssetTagNames(),serviceContext.getAssetLinkEntryIds());
  if (PropsValues.CALENDAR_EVENT_COMMENTS_ENABLED) {
    mbMessageLocalService.addDiscussionMessage(userId,event.getUserName(),groupId,CalEvent.class.getName(),event.getEventId(),WorkflowConstants.ACTION_PUBLISH);
  }
  CalEventLocalUtil.clearEventsPool(event.getGroupId());
  return event;
}
