{
  QueryConfig queryConfig=searchContext.getQueryConfig();
  String[] selectedFieldNames=queryConfig.getSelectedFieldNames();
  if (ArrayUtil.isNotEmpty(selectedFieldNames) && (selectedFieldNames.length == 1) && selectedFieldNames[0].equals(Field.ALL_FIELDS_ID)) {
    Set<String> selectedFieldNameSet=SetUtil.fromArray(selectedFieldNames);
    selectedFieldNameSet.addAll(_PERMISSION_SELECTED_FIELD_NAMES);
    selectedFieldNames=selectedFieldNameSet.toArray(new String[selectedFieldNameSet.size()]);
    queryConfig.setSelectedFieldNames(selectedFieldNames);
  }
  int end=searchContext.getEnd();
  int start=searchContext.getStart();
  if ((end == QueryUtil.ALL_POS) && (start == QueryUtil.ALL_POS)) {
    Hits hits=getHits(searchContext);
    filterHits(hits,searchContext);
    return hits;
  }
  if ((start < 0) || (start > end)) {
    return new HitsImpl();
  }
  int excludedDocsSize=0;
  int hitsSize=0;
  int offset=0;
  long startTime=0;
  List<Document> documents=new ArrayList<Document>();
  List<Float> scores=new ArrayList<Float>();
  while (true) {
    int count=end - documents.size();
    int amplifiedCount=(int)(count * _INDEX_PERMISSION_FILTER_SEARCH_AMPLIFICATION_FACTOR);
    int amplifiedEnd=offset + amplifiedCount;
    searchContext.setEnd(amplifiedEnd);
    searchContext.setStart(offset);
    Hits hits=getHits(searchContext);
    if (startTime == 0) {
      hitsSize=hits.getLength();
      startTime=hits.getStart();
    }
    Document[] oldDocs=hits.getDocs();
    filterHits(hits,searchContext);
    Document[] newDocs=hits.getDocs();
    excludedDocsSize+=oldDocs.length - newDocs.length;
    collectHits(hits,documents,scores,count);
    if ((newDocs.length >= count) || (oldDocs.length < amplifiedCount) || (amplifiedEnd >= hitsSize)) {
      updateHits(hits,documents,scores,start,end,hitsSize - excludedDocsSize,startTime);
      return hits;
    }
    offset=amplifiedEnd;
  }
}
