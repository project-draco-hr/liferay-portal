{
  EmailReaderRequest request=(EmailReaderRequest)JSONFactoryUtil.deserialize(message);
  List<Message> processedMessages=new LinkedList<Message>();
  try {
    openInbox(request);
    Message[] messages=fetchMessages();
    for (    Message mailMessage : messages) {
      if (!isSpam(mailMessage)) {
        processMessage(request,mailMessage);
        processedMessages.add(mailMessage);
      }
    }
  }
 catch (  Exception e) {
    _log.error(e,e);
  }
 finally {
    try {
      _inboxFolder.setFlags(processedMessages.toArray(new Message[0]),new Flags(Flags.Flag.DELETED),true);
    }
 catch (    Exception e) {
    }
    closeInbox();
  }
}
