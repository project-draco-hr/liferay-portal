{
  ThemeDisplay themeDisplay=(ThemeDisplay)actionRequest.getAttribute(WebKeys.THEME_DISPLAY);
  long userId=themeDisplay.getUserId();
  long groupId=themeDisplay.getScopeGroupId();
  int[] queryRulesIndexes=StringUtil.split(ParamUtil.getString(actionRequest,"queryLogicIndexes"),0);
  int i=0;
  for (  int queryRulesIndex : queryRulesIndexes) {
    boolean contains=ParamUtil.getBoolean(actionRequest,"queryContains" + queryRulesIndex);
    boolean andOperator=ParamUtil.getBoolean(actionRequest,"queryAndOperator" + queryRulesIndex);
    String name=ParamUtil.getString(actionRequest,"queryName" + queryRulesIndex);
    String[] values=null;
    if (name.equals("assetTags")) {
      values=StringUtil.split(ParamUtil.getString(actionRequest,"queryTagNames" + queryRulesIndex));
      AssetTagLocalServiceUtil.checkTags(userId,groupId,values);
    }
 else {
      values=StringUtil.split(ParamUtil.getString(actionRequest,"queryCategoryIds" + queryRulesIndex));
    }
    setPreference(actionRequest,"queryContains" + i,String.valueOf(contains));
    setPreference(actionRequest,"queryAndOperator" + i,String.valueOf(andOperator));
    setPreference(actionRequest,"queryName" + i,name);
    setPreference(actionRequest,"queryValues" + i,values);
    i++;
  }
  String[] values=preferences.getValues("queryValues" + i,new String[0]);
  while (values.length > 0) {
    setPreference(actionRequest,"queryContains" + i,StringPool.BLANK);
    setPreference(actionRequest,"queryAndOperator" + i,StringPool.BLANK);
    setPreference(actionRequest,"queryName" + i,StringPool.BLANK);
    setPreference(actionRequest,"queryValues" + i,new String[0]);
    i++;
    values=preferences.getValues("queryValues" + i,new String[0]);
  }
}
