{
  ThemeDisplay themeDisplay=(ThemeDisplay)actionRequest.getAttribute(WebKeys.THEME_DISPLAY);
  long userId=themeDisplay.getUserId();
  long groupId=themeDisplay.getSiteGroupId();
  int[] queryRulesIndexes=StringUtil.split(ParamUtil.getString(actionRequest,"queryLogicIndexes"),0);
  int i=0;
  List<AssetQueryRule> assetQueryRules=new ArrayList<AssetQueryRule>();
  for (  int queryRulesIndex : queryRulesIndexes) {
    AssetQueryRule assetQueryRule=new AssetQueryRule();
    assetQueryRule.setAndOperator(ParamUtil.getBoolean(actionRequest,"queryAndOperator" + queryRulesIndex));
    assetQueryRule.setContains(ParamUtil.getBoolean(actionRequest,"queryContains" + queryRulesIndex));
    assetQueryRule.setName(ParamUtil.getString(actionRequest,"queryName" + queryRulesIndex));
    if (!assetQueryRules.isEmpty()) {
      for (      AssetQueryRule addedAssetQueryRule : assetQueryRules) {
        if (addedAssetQueryRule.equals(assetQueryRule)) {
          throw new DuplicateAssetQueryRuleException(assetQueryRule.getAndOperator(),assetQueryRule.getContains(),assetQueryRule.getName());
        }
      }
    }
    if (assetQueryRule.getName().equals("assetTags")) {
      assetQueryRule.setValues(StringUtil.split(ParamUtil.getString(actionRequest,"queryTagNames" + queryRulesIndex)));
      AssetTagLocalServiceUtil.checkTags(userId,groupId,assetQueryRule.getValues());
    }
 else {
      assetQueryRule.setValues(StringUtil.split(ParamUtil.getString(actionRequest,"queryCategoryIds" + queryRulesIndex)));
    }
    setPreference(actionRequest,"queryContains" + i,String.valueOf(assetQueryRule.getContains()));
    setPreference(actionRequest,"queryAndOperator" + i,String.valueOf(assetQueryRule.getAndOperator()));
    setPreference(actionRequest,"queryName" + i,assetQueryRule.getName());
    setPreference(actionRequest,"queryValues" + i,assetQueryRule.getValues());
    assetQueryRules.add(assetQueryRule);
    i++;
  }
  String[] values=preferences.getValues("queryValues" + i,new String[0]);
  while (values.length > 0) {
    setPreference(actionRequest,"queryContains" + i,StringPool.BLANK);
    setPreference(actionRequest,"queryAndOperator" + i,StringPool.BLANK);
    setPreference(actionRequest,"queryName" + i,StringPool.BLANK);
    setPreference(actionRequest,"queryValues" + i,new String[0]);
    i++;
    values=preferences.getValues("queryValues" + i,new String[0]);
  }
}
