{
  ThemeDisplay themeDisplay=(ThemeDisplay)actionRequest.getAttribute(WebKeys.THEME_DISPLAY);
  Layout layout=themeDisplay.getLayout();
  long groupId=AssetPublisherUtil.getGroupIdFromScopeId(scopeId,themeDisplay.getSiteGroupId(),layout.isPrivateLayout());
  if (scopeId.startsWith(AssetPublisherUtil.SCOPE_ID_CHILD_GROUP_PREFIX)) {
    Group group=GroupLocalServiceUtil.getGroup(groupId);
    if (!group.hasAncestor(themeDisplay.getScopeGroupId())) {
      throw new PrincipalException();
    }
  }
 else   if (scopeId.startsWith(AssetPublisherUtil.SCOPE_ID_PARENT_GROUP_PREFIX)) {
    Group siteGroup=themeDisplay.getSiteGroup();
    if (!siteGroup.hasAncestor(groupId)) {
      throw new PrincipalException();
    }
    if (!SitesUtil.isContentSharingWithChildrenEnabled(siteGroup)) {
      GroupPermissionUtil.check(themeDisplay.getPermissionChecker(),groupId,ActionKeys.UPDATE);
    }
  }
 else   if (groupId != themeDisplay.getCompanyGroupId()) {
    GroupPermissionUtil.check(themeDisplay.getPermissionChecker(),groupId,ActionKeys.UPDATE);
  }
}
