{
  ThemeDisplay themeDisplay=(ThemeDisplay)portletRequest.getAttribute(WebKeys.THEME_DISPLAY);
  String tabs1=ParamUtil.getString(portletRequest,"tabs1");
  boolean privateLayout=true;
  if (tabs1.equals("public-pages")) {
    privateLayout=false;
  }
  String scope=ParamUtil.getString(portletRequest,"scope");
  Map<Long,Boolean> layoutIdMap=new LinkedHashMap<Long,Boolean>();
  if (scope.equals("selected-pages")) {
    long[] rowIds=ParamUtil.getLongValues(portletRequest,"rowIds");
    for (    long selPlid : rowIds) {
      boolean delete=ParamUtil.getBoolean(portletRequest,"delete_" + selPlid);
      boolean includeChildren=ParamUtil.getBoolean(portletRequest,"includeChildren_" + selPlid);
      if (!delete && includeChildren) {
        layoutIdMap.put(selPlid,true);
      }
 else {
        layoutIdMap.put(selPlid,false);
      }
    }
  }
  DateRange dateRange=ExportImportUtil.getDateRange(portletRequest,sourceGroupId,privateLayout,0,null);
  if (schedule) {
    String groupName=getSchedulerGroupName(DestinationNames.LAYOUTS_LOCAL_PUBLISHER,targetGroupId);
    int recurrenceType=ParamUtil.getInteger(portletRequest,"recurrenceType");
    Calendar startCal=ExportImportUtil.getDate(portletRequest,"schedulerStartDate",true);
    String cronText=SchedulerEngineHelperUtil.getCronText(portletRequest,startCal,true,recurrenceType);
    Date schedulerEndDate=null;
    int endDateType=ParamUtil.getInteger(portletRequest,"endDateType");
    if (endDateType == 1) {
      Calendar endCal=ExportImportUtil.getDate(portletRequest,"schedulerEndDate",true);
      schedulerEndDate=endCal.getTime();
    }
    String description=ParamUtil.getString(portletRequest,"description");
    LayoutServiceUtil.schedulePublishToLive(sourceGroupId,targetGroupId,privateLayout,layoutIdMap,parameterMap,scope,dateRange.getStartDate(),dateRange.getEndDate(),groupName,cronText,startCal.getTime(),schedulerEndDate,description);
  }
 else {
    MessageStatus messageStatus=new MessageStatus();
    messageStatus.startTimer();
    String command=LayoutsLocalPublisherRequest.COMMAND_SELECTED_PAGES;
    try {
      if (scope.equals("all-pages")) {
        command=LayoutsLocalPublisherRequest.COMMAND_ALL_PAGES;
        publishLayouts(themeDisplay.getUserId(),sourceGroupId,targetGroupId,privateLayout,parameterMap,dateRange.getStartDate(),dateRange.getEndDate());
      }
 else {
        publishLayouts(themeDisplay.getUserId(),sourceGroupId,targetGroupId,privateLayout,layoutIdMap,parameterMap,dateRange.getStartDate(),dateRange.getEndDate());
      }
    }
 catch (    Exception e) {
      messageStatus.setException(e);
      throw e;
    }
 finally {
      messageStatus.stopTimer();
      LayoutsLocalPublisherRequest publisherRequest=new LayoutsLocalPublisherRequest(command,themeDisplay.getUserId(),sourceGroupId,targetGroupId,privateLayout,layoutIdMap,parameterMap,dateRange.getStartDate(),dateRange.getEndDate());
      messageStatus.setPayload(publisherRequest);
      MessageBusUtil.sendMessage(DestinationNames.MESSAGE_BUS_MESSAGE_STATUS,messageStatus);
    }
  }
}
