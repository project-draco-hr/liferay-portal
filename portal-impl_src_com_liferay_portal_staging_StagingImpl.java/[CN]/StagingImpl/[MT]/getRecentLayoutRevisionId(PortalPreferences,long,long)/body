{
  long layoutRevisionId=0;
  String preferencesString=portalPreferences.getValue(Staging.class.getName(),"ATTRIBUTE_MAP");
  String recentLayoutRevisionIdKey=getRecentLayoutRevisionIdKey(layoutSetBranchId,plid);
  try {
    JSONArray jsonArray=JSONFactoryUtil.createJSONArray(preferencesString);
    for (int i=0; i < jsonArray.length(); i++) {
      JSONObject jsonObject=jsonArray.getJSONObject(i);
      if (jsonObject.has(recentLayoutRevisionIdKey)) {
        layoutRevisionId=GetterUtil.getLong(jsonObject.getString(recentLayoutRevisionIdKey));
      }
    }
  }
 catch (  JSONException je) {
    _log.warn("Staging preferences are not in JSON format");
  }
  if (layoutRevisionId > 0) {
    return layoutRevisionId;
  }
  long layoutBranchId=getRecentLayoutBranchId(portalPreferences,layoutSetBranchId,plid);
  if (layoutBranchId > 0) {
    try {
      LayoutBranchLocalServiceUtil.getLayoutBranch(layoutBranchId);
    }
 catch (    NoSuchLayoutBranchException nslbe) {
      LayoutBranch layoutBranch=LayoutBranchLocalServiceUtil.getMasterLayoutBranch(layoutSetBranchId,plid);
      layoutBranchId=layoutBranch.getLayoutBranchId();
    }
  }
  if (layoutBranchId > 0) {
    try {
      LayoutRevision layoutRevision=LayoutRevisionLocalServiceUtil.getLayoutRevision(layoutSetBranchId,layoutBranchId,plid);
      if (layoutRevision != null) {
        layoutRevisionId=layoutRevision.getLayoutRevisionId();
      }
    }
 catch (    NoSuchLayoutRevisionException nslre) {
    }
  }
  return layoutRevisionId;
}
