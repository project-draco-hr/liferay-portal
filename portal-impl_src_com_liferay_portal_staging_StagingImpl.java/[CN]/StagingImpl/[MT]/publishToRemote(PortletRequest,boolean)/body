{
  ThemeDisplay themeDisplay=(ThemeDisplay)portletRequest.getAttribute(WebKeys.THEME_DISPLAY);
  String tabs1=ParamUtil.getString(portletRequest,"tabs1");
  long groupId=ParamUtil.getLong(portletRequest,"groupId");
  boolean privateLayout=true;
  if (tabs1.equals("public-pages")) {
    privateLayout=false;
  }
  String scope=ParamUtil.getString(portletRequest,"scope");
  if (Validator.isNull(scope)) {
    scope="all-pages";
  }
  Map<Long,Boolean> layoutIdMap=null;
  if (scope.equals("selected-pages")) {
    layoutIdMap=new LinkedHashMap<Long,Boolean>();
    long[] rowIds=ParamUtil.getLongValues(portletRequest,"rowIds");
    for (    long selPlid : rowIds) {
      boolean delete=ParamUtil.getBoolean(portletRequest,"delete_" + selPlid);
      boolean includeChildren=ParamUtil.getBoolean(portletRequest,"includeChildren_" + selPlid);
      if (!delete && includeChildren) {
        layoutIdMap.put(selPlid,true);
      }
 else {
        layoutIdMap.put(selPlid,false);
      }
    }
  }
  Map<String,String[]> parameterMap=getStagingParameters(portletRequest);
  parameterMap.put(PortletDataHandlerKeys.PUBLISH_TO_REMOTE,new String[]{Boolean.TRUE.toString()});
  Group group=GroupLocalServiceUtil.getGroup(groupId);
  UnicodeProperties groupTypeSettingsProperties=group.getTypeSettingsProperties();
  String remoteAddress=ParamUtil.getString(portletRequest,"remoteAddress",groupTypeSettingsProperties.getProperty("remoteAddress"));
  remoteAddress=stripProtocolFromRemoteAddress(remoteAddress);
  int remotePort=ParamUtil.getInteger(portletRequest,"remotePort",GetterUtil.getInteger(groupTypeSettingsProperties.getProperty("remotePort")));
  String remotePathContext=ParamUtil.getString(portletRequest,"remotePathContext",groupTypeSettingsProperties.getProperty("remotePathContext"));
  boolean secureConnection=ParamUtil.getBoolean(portletRequest,"secureConnection",GetterUtil.getBoolean(groupTypeSettingsProperties.getProperty("secureConnection")));
  long remoteGroupId=ParamUtil.getLong(portletRequest,"remoteGroupId",GetterUtil.getLong(groupTypeSettingsProperties.getProperty("remoteGroupId")));
  boolean remotePrivateLayout=ParamUtil.getBoolean(portletRequest,"remotePrivateLayout");
  validate(remoteAddress,remotePort,remotePathContext,secureConnection,remoteGroupId);
  if (group.isCompany()) {
    updateGroupTypeSettingsProperties(group,remoteAddress,remotePort,remotePathContext,secureConnection,remoteGroupId);
  }
  String range=ParamUtil.getString(portletRequest,"range");
  Date startDate=null;
  Date endDate=null;
  if (range.equals("dateRange")) {
    startDate=getDate(portletRequest,"startDate",true).getTime();
    endDate=getDate(portletRequest,"endDate",true).getTime();
  }
 else   if (range.equals("fromLastPublishDate")) {
    LayoutSet layoutSet=LayoutSetLocalServiceUtil.getLayoutSet(groupId,privateLayout);
    long lastPublishDate=GetterUtil.getLong(layoutSet.getSettingsProperty("last-publish-date"));
    if (lastPublishDate > 0) {
      endDate=new Date();
      startDate=new Date(lastPublishDate);
    }
  }
 else   if (range.equals("last")) {
    int rangeLast=ParamUtil.getInteger(portletRequest,"last");
    Date now=new Date();
    startDate=new Date(now.getTime() - (rangeLast * Time.HOUR));
    endDate=now;
  }
  if (schedule) {
    String groupName=getSchedulerGroupName(DestinationNames.LAYOUTS_REMOTE_PUBLISHER,groupId);
    int recurrenceType=ParamUtil.getInteger(portletRequest,"recurrenceType");
    Calendar startCal=getDate(portletRequest,"schedulerStartDate",true);
    String cronText=SchedulerEngineHelperUtil.getCronText(portletRequest,startCal,true,recurrenceType);
    Date schedulerEndDate=null;
    int endDateType=ParamUtil.getInteger(portletRequest,"endDateType");
    if (endDateType == 1) {
      Calendar endCal=getDate(portletRequest,"schedulerEndDate",true);
      schedulerEndDate=endCal.getTime();
    }
    String description=ParamUtil.getString(portletRequest,"description");
    LayoutServiceUtil.schedulePublishToRemote(groupId,privateLayout,layoutIdMap,parameterMap,remoteAddress,remotePort,remotePathContext,secureConnection,remoteGroupId,remotePrivateLayout,startDate,endDate,groupName,cronText,startCal.getTime(),schedulerEndDate,description);
  }
 else {
    MessageStatus messageStatus=new MessageStatus();
    messageStatus.startTimer();
    try {
      copyRemoteLayouts(groupId,privateLayout,layoutIdMap,parameterMap,remoteAddress,remotePort,remotePathContext,secureConnection,remoteGroupId,remotePrivateLayout,startDate,endDate);
    }
 catch (    Exception e) {
      messageStatus.setException(e);
      throw e;
    }
 finally {
      messageStatus.stopTimer();
      LayoutsRemotePublisherRequest publisherRequest=new LayoutsRemotePublisherRequest(themeDisplay.getUserId(),groupId,privateLayout,layoutIdMap,parameterMap,remoteAddress,remotePort,remotePathContext,secureConnection,remoteGroupId,remotePrivateLayout,startDate,endDate);
      messageStatus.setPayload(publisherRequest);
      MessageBusUtil.sendMessage(DestinationNames.MESSAGE_BUS_MESSAGE_STATUS,messageStatus);
    }
  }
}
