{
  long layoutBranchId=0;
  try {
    LayoutRevision layoutRevision=LayoutRevisionLocalServiceUtil.getLayoutRevision(layoutRevisionId);
    layoutBranchId=layoutRevision.getLayoutBranchId();
    LayoutRevision lastLayoutRevision=LayoutRevisionLocalServiceUtil.getLayoutRevision(layoutSetBranchId,layoutBranchId,plid);
    if (lastLayoutRevision.getLayoutRevisionId() == layoutRevisionId) {
      deleteRecentLayoutRevisionId(portalPreferences,layoutSetBranchId,plid);
    }
 else {
      String oldPortalPreferences=portalPreferences.getValue(Staging.class.getName(),"ATTRIBUTE_MAP");
      try {
        JSONArray jsonArray=JSONFactoryUtil.createJSONArray();
        JSONArray oldJsonArray=JSONFactoryUtil.createJSONArray(oldPortalPreferences);
        String recentLayoutRevisionIdKey=getRecentLayoutRevisionIdKey(layoutSetBranchId,plid);
        boolean alreadyExists=false;
        for (int i=0; i < oldJsonArray.length(); i++) {
          JSONObject jsonObject=oldJsonArray.getJSONObject(i);
          if (Validator.isNotNull(jsonObject.getString(recentLayoutRevisionIdKey))) {
            alreadyExists=true;
            jsonObject.remove(recentLayoutRevisionIdKey);
            jsonObject.put(recentLayoutRevisionIdKey,String.valueOf(layoutRevisionId));
          }
          jsonArray.put(jsonObject);
        }
        if (!alreadyExists) {
          JSONObject jsonObject=JSONFactoryUtil.createJSONObject();
          jsonObject.put(recentLayoutRevisionIdKey,String.valueOf(layoutRevisionId));
          jsonArray.put(jsonObject);
        }
        portalPreferences.setValue(Staging.class.getName(),"ATTRIBUTE_MAP",jsonArray.toString());
      }
 catch (      JSONException je) {
        if (_log.isWarnEnabled()) {
          _log.warn("Staging preferences are not in JSON format " + "Unable to set recent layout revision ID",je);
        }
      }
    }
  }
 catch (  PortalException pe) {
    if (_log.isWarnEnabled()) {
      _log.warn("Unable to set recent layout revision ID",pe);
    }
  }
  setRecentLayoutBranchId(portalPreferences,layoutSetBranchId,plid,layoutBranchId);
}
