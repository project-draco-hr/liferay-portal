{
  Registry registry=RegistryUtil.getRegistry();
  CustomJspBag customJspBag=registry.getService(serviceReference);
  List<String> customJsps=customJspBag.getCustomJsps();
  if (customJsps.isEmpty()) {
    getCustomJsps(customJspBag.getServletContext(),customJspBag.getCustomJspDir(),customJspBag.getCustomJsps());
    customJsps=customJspBag.getCustomJsps();
    if (customJsps.isEmpty()) {
      return null;
    }
  }
  if (_log.isDebugEnabled()) {
    StringBundler sb=new StringBundler(customJsps.size() * 2);
    sb.append("Custom JSP files:\n");
    for (int i=0; i < customJsps.size(); i++) {
      String customJsp=customJsps.get(0);
      sb.append(customJsp);
      if ((i + 1) < customJsps.size()) {
        sb.append(StringPool.NEW_LINE);
      }
    }
    Log log=SanitizerLogWrapper.allowCRLF(_log);
    log.debug(sb.toString());
  }
  String servletContextName=customJspBag.getServletContextName();
  if (customJspBag.isCustomJspGlobal() && !_customJspBagsMap.isEmpty() && !_customJspBagsMap.containsKey(servletContextName)) {
    try {
      verifyCustomJsps(servletContextName,customJspBag);
    }
 catch (    DuplicateCustomJspException e) {
      return null;
    }
  }
  _customJspBagsMap.put(servletContextName,customJspBag);
  try {
    initCustomJspBag(servletContextName,customJspBag.getPluginPackageName(),customJspBag);
  }
 catch (  Exception e) {
    return null;
  }
  return customJspBag;
}
