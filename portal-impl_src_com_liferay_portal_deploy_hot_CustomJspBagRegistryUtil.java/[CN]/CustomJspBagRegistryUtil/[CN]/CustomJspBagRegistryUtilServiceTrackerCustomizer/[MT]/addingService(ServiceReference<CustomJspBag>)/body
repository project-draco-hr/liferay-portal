{
  Registry registry=RegistryUtil.getRegistry();
  CustomJspBag customJspBag=registry.getService(serviceReference);
  List<String> customJsps=customJspBag.getCustomJsps();
  if (customJsps.isEmpty()) {
    getCustomJsps(customJspBag.getURLContainer(),customJspBag.getCustomJspDir(),customJspBag.getCustomJsps());
    customJsps=customJspBag.getCustomJsps();
    if (customJsps.isEmpty()) {
      return null;
    }
  }
  if (_log.isDebugEnabled()) {
    StringBundler sb=new StringBundler(customJsps.size() * 2);
    sb.append("Custom JSP files:\n");
    for (int i=0; i < customJsps.size(); i++) {
      String customJsp=customJsps.get(i);
      sb.append(customJsp);
      if ((i + 1) < customJsps.size()) {
        sb.append(StringPool.NEW_LINE);
      }
    }
    Log log=SanitizerLogWrapper.allowCRLF(_log);
    log.debug(sb.toString());
  }
  String contextId=GetterUtil.getString(serviceReference.getProperty("context.id"));
  if (customJspBag.isCustomJspGlobal() && !_customJspBagsMap.isEmpty()) {
    try {
      verifyCustomJsps(contextId,customJspBag);
    }
 catch (    DuplicateCustomJspException e) {
      return null;
    }
  }
  _customJspBagsMap.put(serviceReference,customJspBag);
  String contextName=GetterUtil.getString(serviceReference.getProperty("context.name"));
  try {
    initCustomJspBag(contextId,contextName,customJspBag);
  }
 catch (  Exception e) {
    return null;
  }
  return customJspBag;
}
