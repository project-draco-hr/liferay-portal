{
  PortletConfigImpl configImpl=(PortletConfigImpl)config;
  String portletId=configImpl.getPortletId();
  PortletPreferences prefs=PortletPreferencesFactoryUtil.getPortletSetup(req,portletId);
  boolean requireCaptcha=GetterUtil.getBoolean(prefs.getValue("requireCaptcha",StringPool.BLANK));
  String successURL=GetterUtil.getString(prefs.getValue("successURL",StringPool.BLANK));
  boolean sendAsEmail=GetterUtil.getBoolean(prefs.getValue("sendAsEmail",StringPool.BLANK),true);
  boolean saveToFile=GetterUtil.getBoolean(prefs.getValue("saveToFile",StringPool.BLANK));
  String fileName=GetterUtil.getString(prefs.getValue("fileName",StringPool.BLANK));
  if (requireCaptcha) {
    try {
      CaptchaUtil.check(req);
    }
 catch (    CaptchaTextException cte) {
      SessionErrors.add(req,CaptchaTextException.class.getName());
    }
  }
  List<String> fieldValues=new ArrayList<String>();
  for (int i=1; i <= _MAX_FIELDS; i++) {
    fieldValues.add(req.getParameter("field" + i));
  }
  if (validate(fieldValues,prefs)) {
    boolean emailSent=false;
    boolean fileSaved=false;
    if (sendAsEmail) {
      emailSent=sendEmail(fieldValues,prefs);
    }
    if (saveToFile) {
      fileSaved=saveFile(fieldValues,prefs,fileName);
    }
    if ((sendAsEmail == emailSent) && (saveToFile == fileSaved)) {
      SessionMessages.add(req,"emailSent");
    }
 else {
      SessionErrors.add(req,"emailNotSent");
    }
  }
 else {
    SessionErrors.add(req,"allFieldsRequired");
  }
  if (SessionErrors.isEmpty(req) && Validator.isNotNull(successURL)) {
    res.sendRedirect(successURL);
  }
}
