{
  PortletConfigImpl portletConfigImpl=(PortletConfigImpl)portletConfig;
  String portletId=portletConfigImpl.getPortletId();
  PortletPreferences preferences=PortletPreferencesFactoryUtil.getPortletSetup(actionRequest,portletId);
  boolean requireCaptcha=GetterUtil.getBoolean(preferences.getValue("requireCaptcha",StringPool.BLANK));
  String successURL=GetterUtil.getString(preferences.getValue("successURL",StringPool.BLANK));
  boolean sendAsEmail=GetterUtil.getBoolean(preferences.getValue("sendAsEmail",StringPool.BLANK));
  boolean saveToDatabase=GetterUtil.getBoolean(preferences.getValue("saveToDatabase",StringPool.BLANK));
  String databaseTableName=GetterUtil.getString(preferences.getValue("databaseTableName",StringPool.BLANK));
  boolean saveToFile=GetterUtil.getBoolean(preferences.getValue("saveToFile",StringPool.BLANK));
  String fileName=GetterUtil.getString(preferences.getValue("fileName",StringPool.BLANK));
  if (requireCaptcha) {
    try {
      CaptchaUtil.check(actionRequest);
    }
 catch (    CaptchaTextException cte) {
      SessionErrors.add(actionRequest,CaptchaTextException.class.getName());
      return;
    }
  }
  Map<String,String> fieldsMap=new LinkedHashMap<String,String>();
  for (int i=1; true; i++) {
    String fieldLabel=preferences.getValue("fieldLabel" + i,StringPool.BLANK);
    if (Validator.isNull(fieldLabel)) {
      break;
    }
    fieldsMap.put(fieldLabel,actionRequest.getParameter("field" + i));
  }
  Set<String> validationErrors=null;
  try {
    validationErrors=validate(fieldsMap,preferences);
  }
 catch (  Exception e) {
    actionRequest.setAttribute("validationScriptError",e.getMessage().trim());
    setForward(actionRequest,"portlet.web_form.error");
    return;
  }
  if (validationErrors.isEmpty()) {
    boolean emailSuccess=true;
    boolean databaseSuccess=true;
    boolean fileSuccess=true;
    if (sendAsEmail) {
      emailSuccess=sendEmail(fieldsMap,preferences);
    }
    if (saveToDatabase) {
      if (Validator.isNull(databaseTableName)) {
        databaseTableName=WebFormUtil.getNewDatabaseTableName(portletId);
        preferences.setValue("databaseTableName",databaseTableName);
        preferences.store();
      }
      databaseSuccess=saveDatabase(fieldsMap,preferences,databaseTableName);
    }
    if (saveToFile) {
      fileSuccess=saveFile(fieldsMap,fileName);
    }
    if (emailSuccess && databaseSuccess && fileSuccess) {
      SessionMessages.add(actionRequest,"success");
    }
 else {
      SessionErrors.add(actionRequest,"error");
    }
  }
 else {
    for (    String badField : validationErrors) {
      SessionErrors.add(actionRequest,"error" + badField);
    }
  }
  if (SessionErrors.isEmpty(actionRequest) && Validator.isNotNull(successURL)) {
    actionResponse.sendRedirect(successURL);
  }
 else {
    sendRedirect(actionRequest,actionResponse);
  }
}
