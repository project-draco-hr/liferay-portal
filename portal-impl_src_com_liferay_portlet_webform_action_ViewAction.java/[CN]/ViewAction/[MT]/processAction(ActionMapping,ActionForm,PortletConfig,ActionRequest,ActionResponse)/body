{
  PortletConfigImpl configImpl=(PortletConfigImpl)config;
  String portletId=configImpl.getPortletId();
  PortletPreferences prefs=PortletPreferencesFactoryUtil.getPortletSetup(req,portletId);
  boolean requireCaptcha=GetterUtil.getBoolean(prefs.getValue("requireCaptcha",StringPool.BLANK));
  String successURL=GetterUtil.getString(prefs.getValue("successURL",StringPool.BLANK));
  boolean sendAsEmail=GetterUtil.getBoolean(prefs.getValue("sendAsEmail",StringPool.BLANK));
  boolean saveToDatabase=GetterUtil.getBoolean(prefs.getValue("saveToDatabase",StringPool.BLANK));
  String databaseTableName=GetterUtil.getString(prefs.getValue("databaseTableName",StringPool.BLANK));
  boolean saveToFile=GetterUtil.getBoolean(prefs.getValue("saveToFile",StringPool.BLANK));
  String fileName=GetterUtil.getString(prefs.getValue("fileName",StringPool.BLANK));
  if (requireCaptcha) {
    try {
      CaptchaUtil.check(req);
    }
 catch (    CaptchaTextException cte) {
      SessionErrors.add(req,CaptchaTextException.class.getName());
      return;
    }
  }
  List<String> fieldValues=new ArrayList<String>();
  for (int i=1; i <= WebFormUtil.MAX_FIELDS; i++) {
    fieldValues.add(req.getParameter("field" + i));
  }
  if (validate(fieldValues,prefs)) {
    boolean emailSuccess=true;
    boolean databaseSuccess=true;
    boolean fileSuccess=true;
    if (sendAsEmail) {
      emailSuccess=sendEmail(fieldValues,prefs);
    }
    if (saveToDatabase) {
      if (Validator.isNull(databaseTableName)) {
        databaseTableName=WebFormUtil.getNewDatabaseTableName(portletId);
        prefs.setValue("databaseTableName",databaseTableName);
        prefs.store();
      }
      databaseSuccess=saveDatabase(fieldValues,prefs,databaseTableName);
    }
    if (saveToFile) {
      fileSuccess=saveFile(fieldValues,prefs,fileName);
    }
    if (emailSuccess && databaseSuccess && fileSuccess) {
      SessionMessages.add(req,"success");
    }
 else {
      SessionErrors.add(req,"error");
    }
  }
 else {
    SessionErrors.add(req,"requiredFieldMissing");
  }
  if (SessionErrors.isEmpty(req)) {
    if (Validator.isNotNull(successURL)) {
      res.sendRedirect(successURL);
    }
 else {
      sendRedirect(req,res);
    }
  }
}
