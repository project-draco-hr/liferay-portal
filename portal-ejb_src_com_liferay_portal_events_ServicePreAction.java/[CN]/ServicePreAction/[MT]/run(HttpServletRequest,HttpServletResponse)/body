{
  try {
    HttpSession ses=req.getSession();
    Company company=PortalUtil.getCompany(req);
    String companyId=company.getCompanyId();
    String contextPath=CompanyPropsUtil.get(companyId,PropsUtil.PORTAL_CTX);
    if (contextPath.equals(StringPool.SLASH)) {
      contextPath=StringPool.BLANK;
    }
    String rootPath=(String)req.getAttribute(WebKeys.ROOT_PATH);
    String mainPath=(String)req.getAttribute(WebKeys.MAIN_PATH);
    String captchaPath=(String)req.getAttribute(WebKeys.CAPTCHA_PATH);
    String friendlyURLPrivatePath=(String)req.getAttribute(WebKeys.FRIENDLY_URL_PRIVATE_PATH);
    String friendlyURLPublicPath=(String)req.getAttribute(WebKeys.FRIENDLY_URL_PUBLIC_PATH);
    String imagePath=(String)req.getAttribute(WebKeys.IMAGE_PATH);
    String companyLogo=imagePath + "/company_logo?img_id=" + companyId;
    User user=null;
    try {
      user=PortalUtil.getUser(req);
    }
 catch (    NoSuchUserException nsue) {
      return;
    }
    boolean signedIn=false;
    if (user == null) {
      user=company.getDefaultUser();
    }
 else {
      signedIn=true;
    }
    PermissionChecker permissionChecker=PermissionCheckerFactory.create(user,signedIn);
    PermissionThreadLocal.setPermissionChecker(permissionChecker);
    Locale locale=(Locale)ses.getAttribute(Globals.LOCALE_KEY);
    if (locale == null) {
      if (signedIn) {
        locale=user.getLocale();
      }
 else {
        String languageId=CookieUtil.get(req.getCookies(),CookieKeys.GUEST_LANGUAGE_ID);
        if (Validator.isNotNull(languageId)) {
          locale=LocaleUtil.fromLanguageId(languageId);
        }
        if ((locale == null) && GetterUtil.getBoolean(PropsUtil.get(PropsUtil.LOCALE_DEFAULT_REQUEST))) {
          locale=req.getLocale();
        }
        if (locale == null) {
          locale=user.getLocale();
        }
        if (Validator.isNull(locale.getCountry())) {
          locale=LanguageUtil.getLocale(locale.getLanguage());
        }
        List availableLocales=ListUtil.fromArray(LanguageUtil.getAvailableLocales());
        if (!availableLocales.contains(locale)) {
          locale=user.getLocale();
        }
      }
      ses.setAttribute(Globals.LOCALE_KEY,locale);
      LanguageUtil.updateCookie(res,locale);
    }
    CookieKeys.addSupportCookie(res);
    TimeZone timeZone=user.getTimeZone();
    if (timeZone == null) {
      timeZone=company.getTimeZone();
    }
    if (signedIn) {
      boolean layoutsRequired=user.isLayoutsRequired();
      if (layoutsRequired) {
        addDefaultLayouts(user);
      }
 else {
        deleteDefaultLayouts(user);
      }
    }
    Layout layout=null;
    List layouts=null;
    String plid=ParamUtil.getString(req,"p_l_id");
    String layoutId=Layout.getLayoutId(plid);
    String ownerId=Layout.getOwnerId(plid);
    if ((layoutId != null) && (ownerId != null)) {
      try {
        layout=LayoutLocalServiceUtil.getLayout(layoutId,ownerId);
        if (!isViewableCommunity(user,ownerId)) {
          layout=null;
        }
 else {
          layouts=LayoutLocalServiceUtil.getLayouts(ownerId,Layout.DEFAULT_PARENT_LAYOUT_ID);
        }
      }
 catch (      NoSuchLayoutException nsle) {
      }
    }
    if (layout == null) {
      Object[] defaultLayout=getDefaultLayout(user,signedIn);
      layout=(Layout)defaultLayout[0];
      layouts=(List)defaultLayout[1];
    }
    Object[] viewableLayouts=getViewableLayouts(layout,layouts,permissionChecker,req);
    layout=(Layout)viewableLayouts[0];
    layouts=(List)viewableLayouts[1];
    if (layout != null) {
      plid=layout.getPlid();
      layoutId=layout.getLayoutId();
      ownerId=layout.getOwnerId();
    }
    if ((layout != null) && layout.isShared()) {
      layout=(Layout)layout.clone();
    }
    LayoutTypePortlet layoutTypePortlet=null;
    if (layout != null) {
      req.setAttribute(WebKeys.LAYOUT,layout);
      req.setAttribute(WebKeys.LAYOUTS,layouts);
      layoutTypePortlet=(LayoutTypePortlet)layout.getLayoutType();
    }
    String portletGroupId=PortalUtil.getPortletGroupId(plid);
    Theme theme=null;
    ColorScheme colorScheme=null;
    if (layout != null) {
      theme=layout.getTheme();
      colorScheme=layout.getColorScheme();
    }
 else {
      theme=ThemeLocalUtil.getTheme(companyId,CompanyPropsUtil.get(companyId,PropsUtil.DEFAULT_THEME_ID));
      colorScheme=ThemeLocalUtil.getColorScheme(companyId,theme.getThemeId(),CompanyPropsUtil.get(companyId,PropsUtil.DEFAULT_COLOR_SCHEME_ID));
    }
    req.setAttribute(WebKeys.THEME,theme);
    req.setAttribute(WebKeys.COLOR_SCHEME,colorScheme);
    int resolution=Resolution.FULL_RESOLUTION;
    String resolutionKey=user.getResolution();
    if (resolutionKey.equals(Resolution.S1024X768_KEY)) {
      resolution=Resolution.S1024X768_RESOLUTION;
    }
 else     if (resolutionKey.equals(Resolution.S800X600_KEY)) {
      resolution=Resolution.S800X600_RESOLUTION;
    }
    String protocol=Http.getProtocol(req) + "://";
    ThemeDisplay themeDisplay=ThemeDisplayFactory.create();
    themeDisplay.setCompany(company);
    themeDisplay.setCompanyLogo(companyLogo);
    themeDisplay.setUser(user);
    themeDisplay.setLayout(layout);
    themeDisplay.setLayouts(layouts);
    themeDisplay.setPlid(plid);
    themeDisplay.setLayoutTypePortlet(layoutTypePortlet);
    themeDisplay.setPortletGroupId(portletGroupId);
    themeDisplay.setSignedIn(signedIn);
    themeDisplay.setPermissionChecker(permissionChecker);
    themeDisplay.setLocale(locale);
    themeDisplay.setTimeZone(timeZone);
    themeDisplay.setLookAndFeel(contextPath,theme,colorScheme);
    themeDisplay.setResolution(resolution);
    themeDisplay.setStatePopUp(LiferayWindowState.isPopUp(req));
    themeDisplay.setPathApplet(contextPath + "/applets");
    themeDisplay.setPathCaptcha(captchaPath);
    themeDisplay.setPathContext(contextPath);
    themeDisplay.setPathFlash(contextPath + "/flash");
    themeDisplay.setPathFriendlyURLPrivate(friendlyURLPrivatePath);
    themeDisplay.setPathFriendlyURLPublic(friendlyURLPublicPath);
    themeDisplay.setPathImage(imagePath);
    themeDisplay.setPathJavaScript(contextPath + "/html/js");
    themeDisplay.setPathMain(mainPath);
    themeDisplay.setPathRoot(rootPath);
    themeDisplay.setPathSound(contextPath + "/html/sound");
    themeDisplay.setShowAddContentIcon(false);
    themeDisplay.setShowHomeIcon(true);
    themeDisplay.setShowMyAccountIcon(signedIn);
    themeDisplay.setShowPageSettingsIcon(false);
    themeDisplay.setShowPortalIcon(true);
    themeDisplay.setShowSignInIcon(!signedIn);
    themeDisplay.setShowSignOutIcon(signedIn);
    themeDisplay.setURLHome(protocol + company.getHomeURL());
    if (layout != null) {
      boolean hasManageLayoutsPermission=GroupPermission.contains(permissionChecker,portletGroupId,ActionKeys.MANAGE_LAYOUTS);
      boolean hasUpdateLayoutPermission=LayoutPermission.contains(permissionChecker,layout,ActionKeys.UPDATE);
      if (hasManageLayoutsPermission || hasUpdateLayoutPermission) {
        themeDisplay.setShowAddContentIcon(true);
        themeDisplay.setURLAddContent("LayoutConfiguration.toggle('" + PortletKeys.LAYOUT_CONFIGURATION + "', '"+ plid+ "', '"+ mainPath+ "','"+ themeDisplay.getPathThemeImage()+ "');");
      }
      if (hasManageLayoutsPermission) {
        themeDisplay.setShowPageSettingsIcon(true);
        PortletURL pageSettingsURL=new PortletURLImpl(req,PortletKeys.LAYOUT_MANAGEMENT,plid,false);
        pageSettingsURL.setWindowState(WindowState.MAXIMIZED);
        pageSettingsURL.setPortletMode(PortletMode.VIEW);
        pageSettingsURL.setParameter("struts_action","/layout_management/edit_pages");
        if (layout.isPrivateLayout()) {
          pageSettingsURL.setParameter("tabs2","private");
        }
 else {
          pageSettingsURL.setParameter("tabs2","public");
        }
        pageSettingsURL.setParameter("groupId",portletGroupId);
        pageSettingsURL.setParameter("selPlid",plid);
        themeDisplay.setURLPageSettings(pageSettingsURL);
      }
      PortletURL myAccountURL=new PortletURLImpl(req,PortletKeys.MY_ACCOUNT,plid,false);
      myAccountURL.setWindowState(WindowState.MAXIMIZED);
      myAccountURL.setPortletMode(PortletMode.VIEW);
      myAccountURL.setParameter("struts_action","/my_account/edit_user");
      themeDisplay.setURLMyAccount(myAccountURL);
    }
    themeDisplay.setURLPortal(protocol + company.getPortalURL());
    themeDisplay.setURLSignIn(mainPath + "/portal/login");
    themeDisplay.setURLSignOut(mainPath + "/portal/logout?referer=" + mainPath);
    req.setAttribute(WebKeys.THEME_DISPLAY,themeDisplay);
    fixState(req,themeDisplay);
  }
 catch (  Exception e) {
    _log.error(StackTraceUtil.getStackTrace(e));
    throw new ActionException(e);
  }
}
