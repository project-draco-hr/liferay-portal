{
  SPIAgentResponse spiAgentResponse=new SPIAgentResponse(_SERVLET_CONTEXT_NAME);
  String threadLocalValue="threadLocalValue";
  _threadLocal.set(threadLocalValue);
  HttpSession session=_mockHttpServletRequest.getSession();
  session.setAttribute(_SESSION_ATTRIBUTE_1,_SESSION_ATTRIBUTE_1);
  session.setAttribute(_SESSION_ATTRIBUTE_2,null);
  session.setAttribute(_SESSION_ATTRIBUTE_3,_SESSION_ATTRIBUTE_3);
  spiAgentResponse.captureRequestSessionAttributes(_mockHttpServletRequest);
  _threadLocal.remove();
  Map<String,Serializable> distributedRequestAttributes=spiAgentResponse.distributedRequestAttributes;
  Assert.assertEquals(2,distributedRequestAttributes.size());
  Assert.assertEquals(RequestAttributes.ATTRIBUTE_1,distributedRequestAttributes.get(RequestAttributes.ATTRIBUTE_1));
  Assert.assertEquals(RequestAttributes.ATTRIBUTE_3,distributedRequestAttributes.get(RequestAttributes.ATTRIBUTE_3));
  Map<String,Serializable> deltaSessionAttributes=spiAgentResponse.deltaSessionAttributes;
  Assert.assertEquals(3,deltaSessionAttributes.size());
  Assert.assertEquals(_SESSION_ATTRIBUTE_1,deltaSessionAttributes.get(_SESSION_ATTRIBUTE_1));
  Assert.assertNull(deltaSessionAttributes.get(_SESSION_ATTRIBUTE_2));
  Assert.assertEquals(_SESSION_ATTRIBUTE_3,deltaSessionAttributes.get(_SESSION_ATTRIBUTE_3));
  spiAgentResponse.restoreThreadLocals();
  Assert.assertEquals(threadLocalValue,_threadLocal.get());
  _threadLocal.remove();
}
