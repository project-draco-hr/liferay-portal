{
  SPIAgentResponse spiAgentResponse=new SPIAgentResponse();
  String threadLocalValue="threadLocalValue";
  _threadLocal.set(threadLocalValue);
  HttpSession session=_mockHttpServletRequest.getSession();
  session.setAttribute(_sessionAttribute1,_sessionAttribute1);
  session.setAttribute(_sessionAttribute2,null);
  session.setAttribute(_sessionAttribute3,_sessionAttribute3);
  spiAgentResponse.captureRequestSessionAttributes(_mockHttpServletRequest);
  _threadLocal.remove();
  Map<String,Serializable> distributedRequestAttributes=spiAgentResponse.distributedRequestAttributes;
  Assert.assertEquals(2,distributedRequestAttributes.size());
  Assert.assertEquals(RequestAttributes.ATTRIBUTE1,distributedRequestAttributes.get(RequestAttributes.ATTRIBUTE1));
  Assert.assertEquals(RequestAttributes.ATTRIBUTE3,distributedRequestAttributes.get(RequestAttributes.ATTRIBUTE3));
  Map<String,Serializable> deltaSessionAttributes=spiAgentResponse.deltaSessionAttributes;
  Assert.assertEquals(3,deltaSessionAttributes.size());
  Assert.assertEquals(_sessionAttribute1,deltaSessionAttributes.get(_sessionAttribute1));
  Assert.assertNull(deltaSessionAttributes.get(_sessionAttribute2));
  Assert.assertEquals(_sessionAttribute3,deltaSessionAttributes.get(_sessionAttribute3));
  spiAgentResponse.restoreThreadLocals();
  Assert.assertEquals(threadLocalValue,_threadLocal.get());
  _threadLocal.remove();
}
