{
  StringMaker sm=new StringMaker();
  ThemeDisplay themeDisplay=(ThemeDisplay)_req.getAttribute(WebKeys.THEME_DISPLAY);
  PortletDisplay portletDisplay=themeDisplay.getPortletDisplay();
  String portalURL=PortalUtil.getPortalURL(_req,_secure);
  sm.append(portalURL);
  try {
    if (_layoutFriendlyURL == null) {
      Layout layout=getLayout();
      if (layout != null) {
        _layoutFriendlyURL=GetterUtil.getString(PortalUtil.getLayoutFriendlyURL(layout,themeDisplay));
        if (_layoutFriendlyURL.startsWith(portalURL)) {
          _layoutFriendlyURL=_layoutFriendlyURL.substring(portalURL.length(),_layoutFriendlyURL.length());
        }
      }
    }
  }
 catch (  Exception e) {
    _log.error(e);
  }
  Key key=null;
  try {
    if (_encrypt) {
      Company company=PortalUtil.getCompany(_req);
      key=company.getKeyObj();
    }
  }
 catch (  Exception e) {
    _log.error(e);
  }
  if (Validator.isNull(_layoutFriendlyURL)) {
    sm.append(themeDisplay.getPathMain());
    sm.append("/portal/layout?");
    sm.append("p_l_id");
    sm.append(StringPool.EQUAL);
    sm.append(_processValue(key,_plid));
    sm.append(StringPool.AMPERSAND);
  }
 else {
    sm.append(_layoutFriendlyURL);
    sm.append(StringPool.QUESTION);
  }
  sm.append("p_p_id");
  sm.append(StringPool.EQUAL);
  sm.append(_processValue(key,_portletName));
  sm.append(StringPool.AMPERSAND);
  sm.append("p_p_action");
  sm.append(StringPool.EQUAL);
  sm.append(_action ? _processValue(key,"1") : _processValue(key,"0"));
  sm.append(StringPool.AMPERSAND);
  if (_windowState != null) {
    sm.append("p_p_state");
    sm.append(StringPool.EQUAL);
    sm.append(_processValue(key,_windowState.toString()));
    sm.append(StringPool.AMPERSAND);
  }
  if (_portletMode != null) {
    sm.append("p_p_mode");
    sm.append(StringPool.EQUAL);
    sm.append(_processValue(key,_portletMode.toString()));
    sm.append(StringPool.AMPERSAND);
  }
  sm.append("p_p_col_id");
  sm.append(StringPool.EQUAL);
  sm.append(_processValue(key,portletDisplay.getColumnId()));
  sm.append(StringPool.AMPERSAND);
  sm.append("p_p_col_pos");
  sm.append(StringPool.EQUAL);
  sm.append(_processValue(key,portletDisplay.getColumnPos()));
  sm.append(StringPool.AMPERSAND);
  sm.append("p_p_col_count");
  sm.append(StringPool.EQUAL);
  sm.append(_processValue(key,portletDisplay.getColumnCount()));
  sm.append(StringPool.AMPERSAND);
  if (Validator.isNotNull(_doAsUserId)) {
    try {
      Company company=PortalUtil.getCompany(_req);
      sm.append("doAsUserId");
      sm.append(StringPool.EQUAL);
      sm.append(_processValue(company.getKeyObj(),_doAsUserId));
      sm.append(StringPool.AMPERSAND);
    }
 catch (    Exception e) {
      _log.error(e);
    }
  }
 else {
    String doAsUserId=themeDisplay.getDoAsUserId();
    if (Validator.isNotNull(doAsUserId)) {
      sm.append("doAsUserId");
      sm.append(StringPool.EQUAL);
      sm.append(_processValue(key,doAsUserId));
      sm.append(StringPool.AMPERSAND);
    }
  }
  Iterator itr=_params.entrySet().iterator();
  while (itr.hasNext()) {
    Map.Entry entry=(Map.Entry)itr.next();
    String name=PortalUtil.getPortletNamespace(_portletName) + (String)entry.getKey();
    String[] values=(String[])entry.getValue();
    for (int i=0; i < values.length; i++) {
      sm.append(name);
      sm.append(StringPool.EQUAL);
      sm.append(_processValue(key,values[i]));
      if ((i + 1 < values.length) || itr.hasNext()) {
        sm.append(StringPool.AMPERSAND);
      }
    }
  }
  if (_encrypt) {
    sm.append(StringPool.AMPERSAND + WebKeys.ENCRYPT + "=1");
  }
  if (GetterUtil.getBoolean(PropsUtil.get(PropsUtil.PORTLET_URL_ANCHOR_ENABLE))) {
    if (_anchor && (_windowState != null) && (!_windowState.equals(WindowState.MAXIMIZED))&& (!_windowState.equals(LiferayWindowState.EXCLUSIVE))&& (!_windowState.equals(LiferayWindowState.POP_UP))) {
      if (sm.lastIndexOf(StringPool.AMPERSAND) != (sm.length() - 1)) {
        sm.append(StringPool.AMPERSAND);
      }
      sm.append("#p_").append(_portletName);
    }
  }
  return sm.toString();
}
