{
  try {
    User user=getUser();
    long definitionId=GetterUtil.getLong(WorkflowComponentServiceUtil.deploy(xml));
    long companyId=user.getCompanyId();
    String portletId=CompanyImpl.SYSTEM_STRING;
    long groupId=GroupImpl.DEFAULT_PARENT_GROUP_ID;
    long repositoryId=CompanyImpl.SYSTEM;
    String dirName="workflow/definitions";
    String fileName=dirName + "/" + definitionId+ ".xml";
    try {
      DLServiceUtil.addDirectory(companyId,repositoryId,dirName);
    }
 catch (    DuplicateDirectoryException dde) {
    }
    DLServiceUtil.addFile(companyId,portletId,groupId,repositoryId,fileName,xml.getBytes());
    if ((addCommunityPermissions != null) && (addGuestPermissions != null)) {
      addDefinitionResources(user,definitionId,addCommunityPermissions.booleanValue(),addGuestPermissions.booleanValue());
    }
 else {
      addDefinitionResources(user,definitionId,communityPermissions,guestPermissions);
    }
    return getDefinition(definitionId);
  }
 catch (  RemoteException re) {
    throw new SystemException(re);
  }
}
