{
  MBSubscriptionNotificationMessageListener listener=new MBSubscriptionNotificationMessageListener(new MessageSender(){
    public void send(    String destination,    Message message){
      _toMailService.add(message);
    }
  }
,_subscriptionLocalService,_userLocalService);
  _messageFromMB.put("categoryIds","2");
  final List<Subscription> threadSubscriptions=Arrays.asList(new Subscription[]{new MockSubscriptionImpl(1,1,1)});
  final MockUserImpl threadSubscriber=new MockUserImpl(1,"test@liferay.com","Joe","","Bloggs",true);
  final List<Subscription> categorySubscriptions=Arrays.asList(new Subscription[]{new MockSubscriptionImpl(1,1,1)});
  _mockery.checking(new Expectations(){
{
      one(_subscriptionLocalService).getSubscriptions(with(any(Long.class)),with(equal(MBThread.class.getName())),with(any(Long.class)));
      will(returnValue(threadSubscriptions));
      exactly(threadSubscriptions.size()).of(_userLocalService).getUserById(with(any(Long.class)));
      will(returnValue(threadSubscriber));
      never(_subscriptionLocalService).deleteSubscription(with(any(Long.class)));
      exactly(StringUtil.split(_messageFromMB.getString("categoryIds")).length).of(_subscriptionLocalService).getSubscriptions(with(any(Long.class)),with(equal(MBCategory.class.getName())),with(any(Long.class)));
      will(returnValue(categorySubscriptions));
      never(_userLocalService).getUserById(with(any(Long.class)));
    }
  }
);
  listener.receive(_messageFromMB);
  assertTrue(_toMailService.size() == 1);
  MailMessage toThreadSubscriber=(MailMessage)_toMailService.get(0).getPayload();
  assertNull(toThreadSubscriber.getSMTPAccount());
  _assertToMailServiceMessage(toThreadSubscriber);
  assertEquals(threadSubscriber.getEmailAddress(),toThreadSubscriber.getBulkAddresses()[0].getAddress());
  assertEquals(threadSubscriber.getFullName(),toThreadSubscriber.getBulkAddresses()[0].getPersonal());
}
