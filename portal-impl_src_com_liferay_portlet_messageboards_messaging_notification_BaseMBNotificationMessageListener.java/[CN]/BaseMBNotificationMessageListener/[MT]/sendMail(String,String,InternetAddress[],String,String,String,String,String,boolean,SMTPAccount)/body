{
  try {
    if (bulkAddresses.length == 0) {
      return;
    }
    InternetAddress from=new InternetAddress(fromAddress,fromName);
    InternetAddress to=new InternetAddress(replyToAddress,replyToAddress);
    String curSubject=StringUtil.replace(subject,new String[]{"[$TO_ADDRESS$]","[$TO_NAME$]"},new String[]{replyToAddress,replyToAddress});
    String curBody=StringUtil.replace(body,new String[]{"[$TO_ADDRESS$]","[$TO_NAME$]"},new String[]{replyToAddress,replyToAddress});
    InternetAddress replyTo=new InternetAddress(replyToAddress,replyToAddress);
    if (htmlFormat) {
      try {
        curBody=BBCodeUtil.getHTML(curBody);
      }
 catch (      Exception e) {
        _log.error("Could not parse message " + mailId + " "+ e.getMessage());
      }
    }
    MailMessage mailMessage=new MailMessage(from,to,curSubject,curBody,htmlFormat);
    mailMessage.setBulkAddresses(bulkAddresses);
    mailMessage.setMessageId(mailId);
    mailMessage.setInReplyTo(inReplyTo);
    mailMessage.setReplyTo(new InternetAddress[]{replyTo});
    mailMessage.setSMTPAccount(account);
    Message message=new Message();
    message.setPayload(mailMessage);
    _mailMessageSender.send(DestinationNames.MAIL,message);
  }
 catch (  Exception e) {
    _log.error(e);
  }
}
