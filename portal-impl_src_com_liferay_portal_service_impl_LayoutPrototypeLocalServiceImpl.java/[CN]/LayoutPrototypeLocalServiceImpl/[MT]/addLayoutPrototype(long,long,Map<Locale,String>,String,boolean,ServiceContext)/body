{
  User user=userPersistence.findByPrimaryKey(userId);
  Date now=new Date();
  long layoutPrototypeId=counterLocalService.increment();
  LayoutPrototype layoutPrototype=layoutPrototypePersistence.create(layoutPrototypeId);
  if (serviceContext != null) {
    layoutPrototype.setUuid(serviceContext.getUuid());
    layoutPrototype.setCreateDate(serviceContext.getCreateDate(now));
    layoutPrototype.setModifiedDate(serviceContext.getModifiedDate(now));
  }
 else {
    layoutPrototype.setCreateDate(now);
    layoutPrototype.setModifiedDate(now);
  }
  layoutPrototype.setCompanyId(companyId);
  layoutPrototype.setUserId(userId);
  layoutPrototype.setUserName(user.getFullName());
  layoutPrototype.setNameMap(nameMap);
  layoutPrototype.setDescription(description);
  layoutPrototype.setActive(active);
  layoutPrototypePersistence.update(layoutPrototype);
  if (userId > 0) {
    resourceLocalService.addResources(companyId,0,userId,LayoutPrototype.class.getName(),layoutPrototype.getLayoutPrototypeId(),false,false,false);
  }
  String friendlyURL="/template-" + layoutPrototype.getLayoutPrototypeId();
  Group group=groupLocalService.addGroup(userId,GroupConstants.DEFAULT_PARENT_GROUP_ID,LayoutPrototype.class.getName(),layoutPrototype.getLayoutPrototypeId(),GroupConstants.DEFAULT_LIVE_GROUP_ID,layoutPrototype.getName(LocaleUtil.getDefault()),null,0,friendlyURL,false,true,null);
  layoutLocalService.addLayout(userId,group.getGroupId(),true,LayoutConstants.DEFAULT_PARENT_LAYOUT_ID,layoutPrototype.getName(LocaleUtil.getDefault()),null,null,LayoutConstants.TYPE_PORTLET,false,"/layout",serviceContext);
  return layoutPrototype;
}
