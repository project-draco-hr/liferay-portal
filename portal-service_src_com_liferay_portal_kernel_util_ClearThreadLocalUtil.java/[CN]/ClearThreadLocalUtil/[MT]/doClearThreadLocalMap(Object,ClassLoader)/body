{
  if (threadLocalMap == null) {
    return;
  }
  Object[] table=(Object[])_tableField.get(threadLocalMap);
  if (table == null) {
    return;
  }
  int staleEntriesCount=0;
  for (  Object tableEntry : table) {
    if (tableEntry == null) {
      continue;
    }
    boolean remove=false;
    Object key=((Reference<?>)tableEntry).get();
    Object value=_tableValueField.get(tableEntry);
    if (key != null && key.getClass().getClassLoader() == classLoader) {
      remove=true;
    }
    if (value != null && value.getClass().getClassLoader() == classLoader) {
      remove=true;
    }
    if (remove) {
      if (key != null) {
        if (_log.isDebugEnabled()) {
          _log.debug("Clear a ThreadLocal with key of type " + key.getClass().getCanonicalName());
        }
        _removeMethod.invoke(threadLocalMap,key);
      }
 else {
        staleEntriesCount++;
      }
    }
  }
  if (staleEntriesCount > 0) {
    _expungeStaleEntriesMethod.invoke(threadLocalMap);
  }
}
