{
  long companyId=message.getLong("companyId");
  if (companyId > 0) {
    CompanyThreadLocal.setCompanyId(companyId);
  }
  PermissionChecker permissionChecker=(PermissionChecker)message.get("permissionChecker");
  String principalName=message.getString("principalName");
  if (Validator.isNotNull(principalName)) {
    PrincipalThreadLocal.setName(principalName);
  }
  if ((permissionChecker == null) && Validator.isNotNull(principalName)) {
    try {
      User user=UserLocalServiceUtil.fetchUser(PrincipalThreadLocal.getUserId());
      permissionChecker=PermissionCheckerFactoryUtil.create(user);
    }
 catch (    Exception e) {
      throw new RuntimeException(e);
    }
  }
  if (permissionChecker != null) {
    PermissionThreadLocal.setPermissionChecker(permissionChecker);
  }
  String principalPassword=message.getString("principalPassword");
  if (Validator.isNotNull(principalPassword)) {
    PrincipalThreadLocal.setPassword(principalPassword);
  }
  Boolean clusterForwardMessage=(Boolean)message.get(ClusterLinkUtil.CLUSTER_FORWARD_MESSAGE);
  if (clusterForwardMessage != null) {
    MessageValuesThreadLocal.setValue(ClusterLinkUtil.CLUSTER_FORWARD_MESSAGE,clusterForwardMessage);
  }
}
