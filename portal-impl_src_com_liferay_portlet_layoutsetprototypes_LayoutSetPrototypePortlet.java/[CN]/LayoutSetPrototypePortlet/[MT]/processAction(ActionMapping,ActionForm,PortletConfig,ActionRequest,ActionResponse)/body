{
  String cmd=ParamUtil.getString(actionRequest,Constants.CMD);
  String redirect=ParamUtil.getString(actionRequest,"redirect");
  try {
    if (cmd.equals(Constants.ADD) || cmd.equals(Constants.UPDATE)) {
      LayoutSetPrototype layoutSetPrototype=updateLayoutSetPrototype(actionRequest);
      ThemeDisplay themeDisplay=(ThemeDisplay)actionRequest.getAttribute(WebKeys.THEME_DISPLAY);
      ThemeDisplay siteThemeDisplay=(ThemeDisplay)themeDisplay.clone();
      siteThemeDisplay.setScopeGroupId(layoutSetPrototype.getGroupId());
      PortletURL siteAdministrationURL=PortalUtil.getSiteAdministrationURL(actionResponse,siteThemeDisplay,PortletKeys.SITE_TEMPLATE_SETTINGS);
      String controlPanelURL=HttpUtil.setParameter(themeDisplay.getURLControlPanel(),"p_p_id",PortletKeys.LAYOUT_SET_PROTOTYPE);
      controlPanelURL=HttpUtil.setParameter(controlPanelURL,"controlPanelCategory",themeDisplay.getControlPanelCategory());
      siteAdministrationURL.setParameter("redirect",controlPanelURL);
      redirect=siteAdministrationURL.toString();
      if (cmd.equals(Constants.ADD)) {
        hideDefaultSuccessMessage(actionRequest);
        MultiSessionMessages.add(actionRequest,PortletKeys.SITE_TEMPLATE_SETTINGS + "requestProcessed");
      }
    }
 else     if (cmd.equals(Constants.DELETE)) {
      deleteLayoutSetPrototypes(actionRequest);
    }
 else     if (cmd.equals("reset_merge_fail_count")) {
      resetMergeFailCount(actionRequest);
    }
    sendRedirect(actionRequest,actionResponse,redirect);
  }
 catch (  Exception e) {
    if (e instanceof PrincipalException) {
      SessionErrors.add(actionRequest,e.getClass());
      setForward(actionRequest,"portlet.layout_set_prototypes.error");
    }
 else     if (e instanceof RequiredLayoutSetPrototypeException) {
      SessionErrors.add(actionRequest,e.getClass());
      redirect=PortalUtil.escapeRedirect(redirect);
      if (Validator.isNotNull(redirect)) {
        actionResponse.sendRedirect(redirect);
      }
    }
 else {
      throw e;
    }
  }
}
