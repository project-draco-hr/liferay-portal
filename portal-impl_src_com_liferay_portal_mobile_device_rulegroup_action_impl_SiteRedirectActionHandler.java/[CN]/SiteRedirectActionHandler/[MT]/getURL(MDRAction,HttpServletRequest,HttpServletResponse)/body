{
  UnicodeProperties typeSettingsProperties=action.getTypeSettingsProperties();
  long layoutId=GetterUtil.get(typeSettingsProperties.getProperty(LAYOUT_ID),0L);
  ThemeDisplay themeDisplay=(ThemeDisplay)request.getAttribute(WebKeys.THEME_DISPLAY);
  long currentLayoutId=themeDisplay.getLayout().getLayoutId();
  if (currentLayoutId == layoutId) {
    return null;
  }
  Layout layout=_layoutLocalService.fetchLayout(layoutId);
  long groupId=GetterUtil.get(typeSettingsProperties.getProperty(GROUP_ID),0L);
  if ((layout != null) && (layout.getGroupId() != groupId)) {
    if (_log.isWarnEnabled()) {
      _log.warn("layoutId " + layoutId + " does not belong to group with ID: "+ groupId+ ". Using default public page");
    }
    layout=null;
  }
  if (layout == null) {
    if (_log.isWarnEnabled()) {
      _log.warn("Using default public group layout, invalid plid: " + layoutId);
    }
    long currentGroupId=themeDisplay.getLayout().getGroupId();
    Group group=null;
    if (currentGroupId != groupId) {
      group=_groupLocalService.fetchGroup(groupId);
    }
    if (group == null) {
      if (_log.isWarnEnabled()) {
        _log.warn("Group does not exist: " + groupId);
      }
      return null;
    }
    layout=LayoutLocalServiceUtil.fetchLayout(group.getDefaultPublicPlid());
  }
  if (layout != null) {
    return PortalUtil.getLayoutURL(layout,themeDisplay);
  }
 else {
    if (_log.isWarnEnabled()) {
      _log.warn("Unable to resolve default layout");
    }
    return null;
  }
}
