{
  if (_closed) {
    throw new IOException();
  }
  if (_bufferedOutput instanceof ByteArrayOutputStream) {
    ByteArrayOutputStream baos=(ByteArrayOutputStream)_bufferedOutput;
    ByteArrayOutputStream compressedContent=new ByteArrayOutputStream();
    GZIPOutputStream gzipOutput=new GZIPOutputStream(compressedContent);
    gzipOutput.write(baos.toByteArray());
    gzipOutput.finish();
    byte[] compressedBytes=compressedContent.toByteArray();
    _res.setContentLength(compressedBytes.length);
    _res.addHeader(_CONTENT_ENCODING,_GZIP);
    _output.write(compressedBytes);
    _output.flush();
    _output.close();
    _closed=true;
  }
 else   if (_bufferedOutput instanceof GZIPOutputStream) {
    GZIPOutputStream gzipOutput=(GZIPOutputStream)_bufferedOutput;
    gzipOutput.finish();
    _output.flush();
    _output.close();
    _closed=true;
  }
}
