{
  if (key == null) {
    return getDefaultFactory();
  }
  List possiblePostfixes=calculateSuffixes((Locale)key);
  XmlDefinitionsSet lastXmlFile=null;
  DefinitionsFactory factory=null;
  String curPostfix=null;
  int i=0;
  for (i=possiblePostfixes.size() - 1; i >= 0; i--) {
    curPostfix=(String)possiblePostfixes.get(i);
    factory=(DefinitionsFactory)loaded.get(curPostfix);
    if (factory != null) {
      return factory;
    }
    lastXmlFile=parseXmlFiles(servletContext,curPostfix,null);
    if (lastXmlFile != null) {
      break;
    }
  }
  if (lastXmlFile == null) {
    return getDefaultFactory();
  }
  String lastPostfix=curPostfix;
  XmlDefinitionsSet rootXmlConfig=parseXmlFiles(servletContext,"",null);
  for (int j=0; j < i; j++) {
    curPostfix=(String)possiblePostfixes.get(j);
    parseXmlFiles(servletContext,curPostfix,rootXmlConfig);
  }
  rootXmlConfig.extend(lastXmlFile);
  rootXmlConfig.resolveInheritances();
  factory=new DefinitionsFactory(rootXmlConfig);
  loaded.put(lastPostfix,factory);
  if (log.isDebugEnabled()) {
    log.debug("factory loaded : " + factory);
  }
  return factory;
}
