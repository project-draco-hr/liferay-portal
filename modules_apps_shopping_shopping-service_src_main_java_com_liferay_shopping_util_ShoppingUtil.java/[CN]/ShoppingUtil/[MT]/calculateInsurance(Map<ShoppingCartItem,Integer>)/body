{
  double insurance=0.0;
  double subtotal=0.0;
  ShoppingGroupServiceOverriddenConfiguration shoppingGroupServiceOverriddenConfiguration=null;
  for (  Map.Entry<ShoppingCartItem,Integer> entry : items.entrySet()) {
    ShoppingCartItem cartItem=entry.getKey();
    Integer count=entry.getValue();
    ShoppingItem item=cartItem.getItem();
    if (shoppingGroupServiceOverriddenConfiguration == null) {
      ShoppingCategory category=item.getCategory();
      shoppingGroupServiceOverriddenConfiguration=getShoppingGroupServiceOverriddenConfiguration(category.getGroupId());
    }
    ShoppingItemPrice itemPrice=_getItemPrice(item,count.intValue());
    subtotal+=calculateActualPrice(itemPrice) * count.intValue();
  }
  if ((shoppingGroupServiceOverriddenConfiguration == null) || (subtotal == 0)) {
    return insurance;
  }
  double insuranceRate=0.0;
  double[] range=ShoppingGroupServiceOverriddenConfiguration.INSURANCE_RANGE;
  for (int i=0; i < range.length - 1; i++) {
    if ((subtotal > range[i]) && (subtotal <= range[i + 1])) {
      int rangeId=i / 2;
      if (MathUtil.isOdd(i)) {
        rangeId=(i + 1) / 2;
      }
      String[] insurances=shoppingGroupServiceOverriddenConfiguration.getInsurance();
      if (insurances.length < rangeId) {
        continue;
      }
      insuranceRate=GetterUtil.getDouble(insurances[rangeId]);
    }
  }
  String formula=shoppingGroupServiceOverriddenConfiguration.getInsuranceFormula();
  if (formula.equals("flat")) {
    insurance+=insuranceRate;
  }
 else   if (formula.equals("percentage")) {
    insurance+=subtotal * insuranceRate;
  }
  return insurance;
}
