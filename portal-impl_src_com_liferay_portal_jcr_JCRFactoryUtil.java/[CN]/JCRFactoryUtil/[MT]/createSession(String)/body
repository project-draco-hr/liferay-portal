{
  if (workspaceName == null) {
    workspaceName=JCRFactory.WORKSPACE_NAME;
  }
  if (!PropsValues.JCR_WRAP_SESSION) {
    JCRFactory jcrFactory=getJCRFactory();
    return jcrFactory.createSession(workspaceName);
  }
  Map<String,Session> sessions=_sessions.get();
  Session session=sessions.get(workspaceName);
  if (session != null) {
    return session;
  }
  JCRFactory jcrFactory=getJCRFactory();
  Session jcrSession=jcrFactory.createSession(workspaceName);
  JCRSessionInvocationHandler jcrSessionInvocationHandler=new JCRSessionInvocationHandler(jcrSession);
  Object sessionProxy=ProxyUtil.newProxyInstance(ClassLoaderUtil.getPortalClassLoader(),new Class<?>[]{Map.class,Session.class},jcrSessionInvocationHandler);
  FinalizeManager.register(sessionProxy,jcrSessionInvocationHandler);
  session=(Session)sessionProxy;
  sessions.put(workspaceName,session);
  return session;
}
