{
  Company company=companyLocalService.getCompanyById(user.getCompanyId());
  Ticket ticket=ticketLocalService.addTicket(user.getCompanyId(),User.class.getName(),user.getUserId(),TicketConstants.TYPE_EMAIL_ADDRESS,emailAddress,null,serviceContext);
  String verifyEmailAddressURL=serviceContext.getPortalURL() + serviceContext.getPathMain() + "/portal/verify_email_address?key="+ ticket.getKey();
  Layout layout=layoutLocalService.getLayout(serviceContext.getPlid());
  Group group=layout.getGroup();
  if (!layout.isPrivateLayout() && !group.isUser()) {
    verifyEmailAddressURL+="&p_l_id=" + serviceContext.getPlid();
  }
  String fromName=PrefsPropsUtil.getString(user.getCompanyId(),PropsKeys.ADMIN_EMAIL_FROM_NAME);
  String fromAddress=PrefsPropsUtil.getString(user.getCompanyId(),PropsKeys.ADMIN_EMAIL_FROM_ADDRESS);
  String toName=user.getFullName();
  String toAddress=emailAddress;
  String subject=PrefsPropsUtil.getContent(user.getCompanyId(),PropsKeys.ADMIN_EMAIL_VERIFICATION_SUBJECT);
  String body=PrefsPropsUtil.getContent(user.getCompanyId(),PropsKeys.ADMIN_EMAIL_VERIFICATION_BODY);
  subject=StringUtil.replace(subject,new String[]{"[$EMAIL_VERIFICATION_CODE$]","[$EMAIL_VERIFICATION_URL$]","[$FROM_ADDRESS$]","[$FROM_NAME$]","[$PORTAL_URL$]","[$REMOTE_ADDRESS$]","[$REMOTE_HOST$]","[$TO_ADDRESS$]","[$TO_NAME$]","[$USER_AGENT$]","[$USER_ID$]","[$USER_SCREENNAME$]"},new String[]{ticket.getKey(),verifyEmailAddressURL,fromAddress,fromName,company.getVirtualHostname(),serviceContext.getRemoteAddr(),serviceContext.getRemoteHost(),toAddress,toName,serviceContext.getUserAgent(),String.valueOf(user.getUserId()),user.getScreenName()});
  body=StringUtil.replace(body,new String[]{"[$EMAIL_VERIFICATION_CODE$]","[$EMAIL_VERIFICATION_URL$]","[$FROM_ADDRESS$]","[$FROM_NAME$]","[$PORTAL_URL$]","[$REMOTE_ADDRESS$]","[$REMOTE_HOST$]","[$TO_ADDRESS$]","[$TO_NAME$]","[$USER_AGENT$]","[$USER_ID$]","[$USER_SCREENNAME$]"},new String[]{ticket.getKey(),verifyEmailAddressURL,fromAddress,fromName,company.getVirtualHostname(),serviceContext.getRemoteAddr(),serviceContext.getRemoteHost(),toAddress,toName,serviceContext.getUserAgent(),String.valueOf(user.getUserId()),user.getScreenName()});
  try {
    InternetAddress from=new InternetAddress(fromAddress,fromName);
    InternetAddress to=new InternetAddress(toAddress,toName);
    MailMessage message=new MailMessage(from,to,subject,body,true);
    mailService.sendEmail(message);
  }
 catch (  Exception e) {
    throw new SystemException(e);
  }
}
