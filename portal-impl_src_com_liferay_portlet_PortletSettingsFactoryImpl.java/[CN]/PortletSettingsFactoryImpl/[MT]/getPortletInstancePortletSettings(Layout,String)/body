{
  long ownerId=PortletKeys.PREFS_OWNER_ID_DEFAULT;
  int ownerType=PortletKeys.PREFS_OWNER_TYPE_LAYOUT;
  if (PortletConstants.hasUserId(portletId)) {
    ownerId=PortletConstants.getUserId(portletId);
    ownerType=PortletKeys.PREFS_OWNER_TYPE_USER;
  }
  PortletPreferences instancePortletPreferences=PortletPreferencesLocalServiceUtil.getPreferences(layout.getCompanyId(),ownerId,ownerType,layout.getPlid(),portletId);
  PortletInstancePortletSettings instancePortletSettings=new PortletInstancePortletSettings(instancePortletPreferences);
  PortletPreferences sitePortletPreferences=PortletPreferencesLocalServiceUtil.getPreferences(layout.getCompanyId(),layout.getGroupId(),PortletKeys.PREFS_OWNER_TYPE_LAYOUT_DEFAULTS_GROUP,0,portletId);
  instancePortletSettings.setSiteDefaults(sitePortletPreferences);
  PortletPreferences companyPortletPreferences=PortletPreferencesLocalServiceUtil.getPreferences(layout.getCompanyId(),layout.getCompanyId(),PortletKeys.PREFS_OWNER_TYPE_LAYOUT_DEFAULTS_COMPANY,0,portletId);
  instancePortletSettings.setCompanyDefaults(companyPortletPreferences);
  Properties portalProperties=PropsUtil.getProperties(portletId,false);
  instancePortletSettings.setPortalDefaults(portalProperties);
  return instancePortletSettings;
}
