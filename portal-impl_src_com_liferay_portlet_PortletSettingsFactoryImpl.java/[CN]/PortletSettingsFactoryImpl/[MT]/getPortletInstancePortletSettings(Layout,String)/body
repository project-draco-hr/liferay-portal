{
  long ownerId=PortletKeys.PREFS_OWNER_ID_DEFAULT;
  int ownerType=PortletKeys.PREFS_OWNER_TYPE_LAYOUT;
  if (PortletConstants.hasUserId(portletId)) {
    ownerId=PortletConstants.getUserId(portletId);
    ownerType=PortletKeys.PREFS_OWNER_TYPE_USER;
  }
  PortletPreferences portletInstancePortletPreferences=PortletPreferencesLocalServiceUtil.getPreferences(layout.getCompanyId(),ownerId,ownerType,layout.getPlid(),portletId);
  PortletInstancePortletSettings portletInstancePortletSettings=new PortletInstancePortletSettings(portletInstancePortletPreferences);
  PortletPreferences groupPortletPreferences=PortletPreferencesLocalServiceUtil.getPreferences(layout.getCompanyId(),layout.getGroupId(),PortletKeys.PREFS_OWNER_TYPE_LAYOUT_DEFAULTS_GROUP,0,portletId);
  portletInstancePortletSettings.setGroupPortletPreferences(groupPortletPreferences);
  PortletPreferences companyPortletPreferences=PortletPreferencesLocalServiceUtil.getPreferences(layout.getCompanyId(),layout.getCompanyId(),PortletKeys.PREFS_OWNER_TYPE_LAYOUT_DEFAULTS_COMPANY,0,portletId);
  portletInstancePortletSettings.setCompanyPortletPreferences(companyPortletPreferences);
  Properties portalProperties=PropsUtil.getProperties(portletId,false);
  portletInstancePortletSettings.setPortalProperties(portalProperties);
  return portletInstancePortletSettings;
}
