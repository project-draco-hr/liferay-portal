{
  long appPackageId=ParamUtil.getLong(actionRequest,"appPackageId");
  boolean unlicensed=ParamUtil.getBoolean(actionRequest,"unlicensed");
  String orderUuid=ParamUtil.getString(actionRequest,"orderUuid");
  String productEntryName=ParamUtil.getString(actionRequest,"productEntryName");
  File file=null;
  try {
    file=FileUtil.createTempFile();
    downloadApp(actionRequest,actionResponse,appPackageId,unlicensed,file);
    App app=AppServiceUtil.updateApp(file);
    if (Validator.isNull(orderUuid) && Validator.isNotNull(productEntryName)) {
      orderUuid=MarketplaceLicenseUtil.getOrder(productEntryName);
    }
    if (Validator.isNotNull(orderUuid)) {
      MarketplaceLicenseUtil.registerOrder(orderUuid,productEntryName);
    }
    AppServiceUtil.installApp(app.getRemoteAppId());
    JSONObject jsonObject=getAppJSONObject(app.getRemoteAppId());
    jsonObject.put("cmd","updateApp");
    jsonObject.put("message","success");
    writeJSON(actionRequest,actionResponse,jsonObject);
  }
  finally {
    if (file != null) {
      file.delete();
    }
  }
}
