{
  DLDocumentType documentType=dlDocumentTypeLocalService.getDocumentType(documentTypeId);
  long companyId=documentType.getCompanyId();
  List<DDMStructure> ddmStructures=documentType.getDDMStructures();
  for (  DDMStructure ddmStructure : ddmStructures) {
    long ddmStructureId=ddmStructure.getStructureId();
    Fields fields=fieldsMap.get(ddmStructureId);
    if (fields == null) {
      continue;
    }
    try {
      DLDocumentMetadataSet metadataSet=dlDocumentMetadataSetPersistence.findByD_F(ddmStructureId,fileVersionId);
      StorageEngineUtil.update(metadataSet.getClassPK(),fields,serviceContext);
    }
 catch (    NoSuchDocumentMetadataSetException nsdmse) {
      long metadataSetId=counterLocalService.increment();
      DLDocumentMetadataSet metadataSet=dlDocumentMetadataSetPersistence.create(metadataSetId);
      metadataSet.setFileVersionId(fileVersionId);
      metadataSet.setDocumentTypeId(documentTypeId);
      metadataSet.setDDMStructureId(ddmStructureId);
      metadataSet.setClassNameId(ddmStructure.getClassNameId());
      long classPK=StorageEngineUtil.create(companyId,ddmStructureId,fields,serviceContext);
      metadataSet.setClassPK(classPK);
      dlDocumentMetadataSetPersistence.update(metadataSet,false);
      long classNameId=PortalUtil.getClassNameId(DLDocumentMetadataSet.class);
      ddmStructureLinkLocalService.addStructureLink(classNameId,metadataSet.getMetadataSetId(),ddmStructureId,serviceContext);
    }
  }
}
