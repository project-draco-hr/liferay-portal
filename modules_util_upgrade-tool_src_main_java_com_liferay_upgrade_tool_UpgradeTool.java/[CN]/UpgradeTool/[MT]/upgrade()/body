{
  verifyProperties();
  System.setOut(new TeePrintStream(new FileOutputStream(_logFile),System.out));
  String classPath=_getClassPath();
  List<String> commands=new ArrayList<>();
  if (JAVA_HOME != null) {
    commands.add(JAVA_HOME + "/bin/java");
  }
 else {
    commands.add("java");
  }
  commands.addAll(Arrays.asList(_jvmOpts.split(" ")));
  commands.add("-Dexternal-properties=portal-upgrade.properties");
  commands.add("-cp");
  commands.add(classPath);
  commands.add("com.liferay.portal.tools.DBUpgrader");
  ProcessBuilder processBuilder=new ProcessBuilder();
  processBuilder.redirectErrorStream(true);
  processBuilder.command(commands);
  Process process=processBuilder.start();
  try (InputStreamReader isr=new InputStreamReader(process.getInputStream());BufferedReader br=new BufferedReader(isr)){
    String line;
    while ((line=br.readLine()) != null) {
      if (line.equals("Running modules upgrades. Connect to your Gogo " + "Shell to check the status.")) {
        break;
      }
 else {
        System.out.println(line);
      }
    }
    System.out.flush();
  }
 catch (  IOException ioe) {
    ioe.printStackTrace();
  }
  boolean upgrading=true;
  while (upgrading) {
    try (GogoTelnetClient client=new GogoTelnetClient()){
      System.out.println("You are now connected to Gogo Shell");
      _printHelp();
      _consoleReader.setPrompt("g! ");
      String line;
      while ((line=_consoleReader.readLine()) != null) {
        if (line.equals("exit") || line.equals("quit")) {
          break;
        }
 else         if (line.equals("upgrade:help")) {
          _printHelp();
        }
 else {
          System.out.println(client.send(line));
        }
      }
      System.out.print("Making sure all upgrades steps have been completed");
      String upgradeSteps=client.send("upgrade:list | grep Registered | grep step");
      upgrading=upgradeSteps.contains("true");
      if (upgrading) {
        System.out.println("...one of your upgrades is still running or failed");
        System.out.println("Are you sure you want to exit (y/N)?");
        _consoleReader.setPrompt("");
        String response=_consoleReader.readLine();
        if (response.equals("y")) {
          upgrading=false;
        }
      }
 else {
        System.out.println("...done.");
      }
    }
 catch (    Exception e) {
      upgrading=false;
    }
  }
  System.out.println("Exiting Gogo Shell");
  process.getInputStream().close();
  process.getOutputStream().close();
  process.getErrorStream().close();
  process.destroy();
}
