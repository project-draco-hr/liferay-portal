{
  Field field=getDeclaredField("COMPANY_SECURITY_STRANGERS_WITH_MX");
  Object value=field.get(null);
  String name=PrincipalThreadLocal.getName();
  try {
    field.set(null,Boolean.FALSE);
    User user=addUserWithoutPermissions();
    PrincipalThreadLocal.setName(user.getUserId());
    String emailAddress="UserServiceTest." + ServiceTestUtil.nextLong() + "@liferay.com";
    UserServiceUtil.updateEmailAddress(user.getUserId(),user.getPassword(),emailAddress,emailAddress,new ServiceContext());
    Assert.fail();
  }
 catch (  ReservedUserEmailAddressException rueae) {
  }
 finally {
    field.set(null,value);
    PrincipalThreadLocal.setName(name);
  }
}
