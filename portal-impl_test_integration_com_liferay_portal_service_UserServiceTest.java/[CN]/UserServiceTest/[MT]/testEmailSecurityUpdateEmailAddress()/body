{
  Field field=getField("COMPANY_SECURITY_STRANGERS_WITH_MX");
  Object value=field.get(null);
  field.set(null,Boolean.FALSE);
  User user=addUserWithoutPermissions();
  user.setEmailAddress("testcompanymx@test.com");
  UserLocalServiceUtil.updateUser(user);
  String name=PrincipalThreadLocal.getName();
  PrincipalThreadLocal.setName(user.getUserId());
  try {
    String emailAddress="UserServiceTest." + ServiceTestUtil.nextLong() + "@liferay.com";
    UserServiceUtil.updateEmailAddress(user.getUserId(),user.getPassword(),emailAddress,emailAddress,new ServiceContext());
    Assert.fail();
  }
 catch (  ReservedUserEmailAddressException rueae) {
  }
 finally {
    field.set(null,value);
    PrincipalThreadLocal.setName(name);
  }
}
