{
  String poolId=PortletContextFactory.class.getName();
  if (!portlet.isWARFile()) {
    poolId+="." + portlet.getCompanyId();
  }
  Map map=(Map)_pool.get(poolId);
  if (map == null) {
    map=CollectionFactory.getSyncHashMap();
    _pool.put(poolId,map);
  }
  Map portletContexts=(Map)map.get(portlet.getRootPortletId());
  if (portletContexts == null) {
    portletContexts=CollectionFactory.getSyncHashMap();
    map.put(portlet.getRootPortletId(),portletContexts);
  }
  PortletContext portletContext=(PortletContext)portletContexts.get(portlet.getPortletId());
  if (portletContext == null) {
    if (portlet.isWARFile()) {
      PortletContextWrapper pcw=PortletContextPool.get(portlet.getRootPortletId());
      String mainPath=(String)ctx.getAttribute(WebKeys.MAIN_PATH);
      ctx=pcw.getServletContext();
      ctx.setAttribute(WebKeys.MAIN_PATH,mainPath);
    }
    portletContext=new PortletContextImpl(ctx);
    VelocityContextPool.put(portletContext.getPortletContextName(),ctx);
    portletContexts.put(portlet.getPortletId(),portletContext);
  }
  return portletContext;
}
