{
  UploadServletRequest uploadServletRequest=null;
  try {
    String cmd=ParamUtil.getString(request,Constants.CMD);
    ThemeDisplay themeDisplay=(ThemeDisplay)request.getAttribute(WebKeys.THEME_DISPLAY);
    long groupId=ParamUtil.getLong(request,"groupId");
    String articleId=ParamUtil.getString(request,"articleId");
    double version=ParamUtil.getDouble(request,"version",JournalArticleConstants.VERSION_DEFAULT);
    String languageId=LanguageUtil.getLanguageId(request);
    String output=null;
    if (cmd.equals(Constants.PREVIEW)) {
      uploadServletRequest=PortalUtil.getUploadServletRequest(request);
      String title=ParamUtil.getString(uploadServletRequest,"title");
      String description=ParamUtil.getString(uploadServletRequest,"description");
      String ddmStructureKey=ParamUtil.getString(uploadServletRequest,"ddmStructureKey");
      String ddmTemplateKey=ParamUtil.getString(uploadServletRequest,"ddmTemplateKey");
      Date now=new Date();
      Date createDate=now;
      Date modifiedDate=now;
      Date displayDate=now;
      User user=PortalUtil.getUser(uploadServletRequest);
      String xml=ParamUtil.getString(uploadServletRequest,"xml");
      Document doc=SAXReaderUtil.read(xml);
      Element root=doc.getRootElement();
      String previewArticleId="PREVIEW_" + StringUtil.randomString(10);
      format(groupId,articleId,version,previewArticleId,root,uploadServletRequest);
      Map<String,String> tokens=JournalUtil.getTokens(groupId,themeDisplay);
      tokens.put("article_resource_pk","-1");
      JournalArticle article=new JournalArticleImpl();
      article.setGroupId(groupId);
      article.setCompanyId(user.getCompanyId());
      article.setUserId(user.getUserId());
      article.setUserName(user.getFullName());
      article.setCreateDate(createDate);
      article.setModifiedDate(modifiedDate);
      article.setArticleId(articleId);
      article.setVersion(version);
      article.setTitle(title);
      article.setDescription(description);
      article.setContent(xml);
      article.setDDMStructureKey(ddmStructureKey);
      article.setDDMTemplateKey(ddmTemplateKey);
      article.setDisplayDate(displayDate);
      output=JournalArticleLocalServiceUtil.getArticleContent(article,ddmTemplateKey,null,languageId,themeDisplay);
    }
 else     if (cmd.equals(Constants.VIEW)) {
      JournalArticle article=JournalArticleServiceUtil.getArticle(groupId,articleId,version);
      output=JournalArticleLocalServiceUtil.getArticleContent(article,article.getDDMTemplateKey(),null,languageId,themeDisplay);
    }
 else {
      output=JournalArticleServiceUtil.getArticleContent(groupId,articleId,version,languageId,themeDisplay);
    }
    request.setAttribute(WebKeys.JOURNAL_ARTICLE_CONTENT,output);
    if (output.startsWith("<?xml ")) {
      return actionMapping.findForward("portlet.journal.raw_article_content");
    }
 else {
      return actionMapping.findForward("portlet.journal.view_article_content");
    }
  }
 catch (  Exception e) {
    PortalUtil.sendError(e,request,response);
    return null;
  }
 finally {
    if (uploadServletRequest != null) {
      uploadServletRequest.cleanUp();
    }
  }
}
