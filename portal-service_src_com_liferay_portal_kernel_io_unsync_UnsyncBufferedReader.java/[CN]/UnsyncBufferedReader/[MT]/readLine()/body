{
  if (reader == null) {
    throw new IOException("Reader is null");
  }
  StringBundler sb=null;
  while (true) {
    if (index >= firstInvalidIndex) {
      fillInBuffer();
    }
    if (index >= firstInvalidIndex) {
      if ((sb != null) && (sb.index() > 0)) {
        return sb.toString();
      }
 else {
        return null;
      }
    }
    boolean hasLineBreak=false;
    char lineEndChar=0;
    int x=index;
    int y=index;
    while (y < firstInvalidIndex) {
      lineEndChar=buffer[y];
      if ((lineEndChar == CharPool.NEW_LINE) || (lineEndChar == CharPool.RETURN)) {
        hasLineBreak=true;
        break;
      }
      y++;
    }
    String line=new String(buffer,x,y - x);
    index=y;
    if (hasLineBreak) {
      index++;
      if (lineEndChar == CharPool.RETURN) {
        if ((index < buffer.length) && (buffer[index] == CharPool.NEW_LINE)) {
          index++;
        }
      }
      if (sb == null) {
        return line;
      }
      sb.append(line);
      return sb.toString();
    }
    if (sb == null) {
      sb=new StringBundler();
    }
    sb.append(line);
  }
}
