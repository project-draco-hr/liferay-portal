{
  MembershipPolicyException membershipPolicyException=null;
  for (  long groupId : groupIds) {
    Group group=GroupLocalServiceUtil.getGroup(groupId);
    if (!group.isLimitedToParentSiteMembers()) {
      continue;
    }
    for (    long userId : userIds) {
      if (!GroupLocalServiceUtil.hasUserGroup(userId,group.getParentGroupId(),false)) {
        if (membershipPolicyException == null) {
          membershipPolicyException=new MembershipPolicyException(MembershipPolicyException.SITE_MEMBERSHIP_NOT_ALLOWED);
        }
        User user=UserLocalServiceUtil.getUser(userId);
        membershipPolicyException.addUser(user);
      }
    }
    if (membershipPolicyException != null) {
      membershipPolicyException.addGroup(group);
    }
  }
  if (membershipPolicyException != null) {
    throw membershipPolicyException;
  }
}
