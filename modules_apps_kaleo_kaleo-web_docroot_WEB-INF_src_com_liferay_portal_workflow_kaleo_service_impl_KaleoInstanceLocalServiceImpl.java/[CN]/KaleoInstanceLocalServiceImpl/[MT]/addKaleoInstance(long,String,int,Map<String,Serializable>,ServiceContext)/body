{
  User user=userPersistence.fetchByPrimaryKey(serviceContext.getUserId());
  if (user == null) {
    user=userLocalService.getDefaultUser(serviceContext.getCompanyId());
  }
  Date now=new Date();
  long kaleoInstanceId=counterLocalService.increment();
  KaleoInstance kaleoInstance=kaleoInstancePersistence.create(kaleoInstanceId);
  long groupId=StagingUtil.getLiveGroupId(serviceContext.getScopeGroupId());
  kaleoInstance.setGroupId(groupId);
  kaleoInstance.setCompanyId(user.getCompanyId());
  kaleoInstance.setUserId(user.getUserId());
  kaleoInstance.setUserName(user.getFullName());
  kaleoInstance.setCreateDate(now);
  kaleoInstance.setModifiedDate(now);
  kaleoInstance.setKaleoDefinitionId(kaleoDefinitionId);
  kaleoInstance.setKaleoDefinitionName(kaleoDefinitionName);
  kaleoInstance.setKaleoDefinitionVersion(kaleoDefinitionVersion);
  kaleoInstance.setClassName((String)workflowContext.get(WorkflowConstants.CONTEXT_ENTRY_CLASS_NAME));
  if (workflowContext.containsKey(WorkflowConstants.CONTEXT_ENTRY_CLASS_PK)) {
    kaleoInstance.setClassPK(GetterUtil.getLong((String)workflowContext.get(WorkflowConstants.CONTEXT_ENTRY_CLASS_PK)));
  }
  kaleoInstance.setCompleted(false);
  kaleoInstance.setWorkflowContext(WorkflowContextUtil.convert(workflowContext));
  kaleoInstancePersistence.update(kaleoInstance);
  return kaleoInstance;
}
