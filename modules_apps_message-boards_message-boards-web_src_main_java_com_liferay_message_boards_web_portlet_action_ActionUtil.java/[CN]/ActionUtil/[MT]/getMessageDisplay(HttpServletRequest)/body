{
  long messageId=ParamUtil.getLong(request,"messageId");
  ThemeDisplay themeDisplay=(ThemeDisplay)request.getAttribute(WebKeys.THEME_DISPLAY);
  PermissionChecker permissionChecker=themeDisplay.getPermissionChecker();
  int status=WorkflowConstants.STATUS_APPROVED;
  if (permissionChecker.isContentReviewer(themeDisplay.getUserId(),themeDisplay.getScopeGroupId())) {
    status=WorkflowConstants.STATUS_ANY;
  }
  PortalPreferences preferences=PortletPreferencesFactoryUtil.getPortalPreferences(request);
  String threadView=ParamUtil.getString(request,"threadView");
  if (Validator.isNotNull(threadView)) {
    preferences.setValue(MBPortletKeys.MESSAGE_BOARDS,"thread-view",threadView);
  }
 else {
    threadView=preferences.getValue(MBPortletKeys.MESSAGE_BOARDS,"thread-view",PropsValues.MESSAGE_BOARDS_THREAD_VIEWS_DEFAULT);
  }
  if (!ArrayUtil.contains(PropsValues.MESSAGE_BOARDS_THREAD_VIEWS,threadView)) {
    threadView=PropsValues.MESSAGE_BOARDS_THREAD_VIEWS_DEFAULT;
    preferences.setValue(MBPortletKeys.MESSAGE_BOARDS,"thread-view",threadView);
  }
  boolean includePrevAndNext=PropsValues.MESSAGE_BOARDS_THREAD_PREVIOUS_AND_NEXT_NAVIGATION_ENABLED;
  MBMessageDisplay messageDisplay=MBMessageServiceUtil.getMessageDisplay(messageId,status,threadView,includePrevAndNext);
  if (messageDisplay != null) {
    MBMessage message=messageDisplay.getMessage();
    if ((message != null) && message.isInTrash()) {
      throw new NoSuchMessageException("{messageId=" + messageId + "}");
    }
  }
  return messageDisplay;
}
