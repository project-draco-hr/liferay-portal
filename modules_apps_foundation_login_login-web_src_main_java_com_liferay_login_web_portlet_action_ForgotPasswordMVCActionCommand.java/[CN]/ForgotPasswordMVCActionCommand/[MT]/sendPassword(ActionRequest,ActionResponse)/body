{
  ThemeDisplay themeDisplay=(ThemeDisplay)actionRequest.getAttribute(WebKeys.THEME_DISPLAY);
  Company company=themeDisplay.getCompany();
  User user=getUser(actionRequest);
  if (PropsValues.USERS_REMINDER_QUERIES_ENABLED) {
    if (PropsValues.USERS_REMINDER_QUERIES_REQUIRED && !user.hasReminderQuery()) {
      throw new RequiredReminderQueryException("No reminder query or answer is defined for user " + user.getUserId());
    }
    String answer=ParamUtil.getString(actionRequest,"answer");
    if (!user.getReminderQueryAnswer().equals(answer)) {
      throw new UserReminderQueryException("Reminder query answer does not match answer");
    }
  }
  PortletPreferences portletPreferences=actionRequest.getPreferences();
  String languageId=LanguageUtil.getLanguageId(actionRequest);
  String emailFromName=portletPreferences.getValue("emailFromName",null);
  String emailFromAddress=portletPreferences.getValue("emailFromAddress",null);
  String emailToAddress=user.getEmailAddress();
  String emailParam="emailPasswordSent";
  if (company.isSendPasswordResetLink()) {
    emailParam="emailPasswordReset";
  }
  String subject=portletPreferences.getValue(emailParam + "Subject_" + languageId,null);
  String body=portletPreferences.getValue(emailParam + "Body_" + languageId,null);
  LoginUtil.sendPassword(actionRequest,emailFromName,emailFromAddress,emailToAddress,subject,body);
  HttpServletRequest request=PortalUtil.getHttpServletRequest(actionRequest);
  SessionMessages.add(request,"passwordSentTo",emailToAddress);
  sendRedirect(actionRequest,actionResponse,null);
}
