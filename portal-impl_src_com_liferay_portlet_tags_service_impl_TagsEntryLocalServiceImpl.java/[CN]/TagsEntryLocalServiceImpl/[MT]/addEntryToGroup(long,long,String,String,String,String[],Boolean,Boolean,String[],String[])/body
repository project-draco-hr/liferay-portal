{
  User user=userPersistence.findByPrimaryKey(userId);
  name=name.trim().toLowerCase();
  if (Validator.isNull(vocabularyName)) {
    vocabularyName=PropsValues.TAGS_VOCABULARY_DEFAULT;
  }
  if (properties != null) {
    properties=new String[0];
  }
  Date now=new Date();
  validate(name);
  if (hasEntry(groupId,name)) {
    throw new DuplicateEntryException("A tag entry with the name " + name + " already exists");
  }
  long entryId=counterLocalService.increment();
  TagsEntry entry=tagsEntryPersistence.create(entryId);
  entry.setGroupId(groupId);
  entry.setCompanyId(user.getCompanyId());
  entry.setUserId(user.getUserId());
  entry.setUserName(user.getFullName());
  entry.setCreateDate(now);
  entry.setModifiedDate(now);
  if (Validator.isNotNull(parentEntryName)) {
    TagsEntry parentEntry=tagsEntryPersistence.findByG_N(groupId,parentEntryName);
    entry.setParentEntryId(parentEntry.getEntryId());
  }
 else {
    entry.setParentEntryId(TagsEntryConstants.DEFAULT_PARENT_ENTRY_ID);
  }
  entry.setName(name);
  TagsVocabulary vocabulary=null;
  try {
    vocabulary=tagsVocabularyPersistence.findByG_N(groupId,vocabularyName);
  }
 catch (  NoSuchVocabularyException nsve) {
    if (vocabularyName.equals(PropsValues.TAGS_VOCABULARY_DEFAULT)) {
      vocabulary=tagsVocabularyLocalService.addVocabularyToGroup(userId,groupId,vocabularyName,true,Boolean.TRUE,Boolean.TRUE,null,null);
    }
 else {
      throw nsve;
    }
  }
  entry.setVocabularyId(vocabulary.getVocabularyId());
  tagsEntryPersistence.update(entry,false);
  if ((addCommunityPermissions != null) && (addGuestPermissions != null)) {
    addEntryResources(entry,addCommunityPermissions.booleanValue(),addGuestPermissions.booleanValue());
  }
 else {
    addEntryResources(entry,communityPermissions,guestPermissions);
  }
  for (int i=0; i < properties.length; i++) {
    String[] property=StringUtil.split(properties[i],StringPool.COLON);
    String key=StringPool.BLANK;
    if (property.length > 1) {
      key=GetterUtil.getString(property[1]);
    }
    String value=StringPool.BLANK;
    if (property.length > 2) {
      value=GetterUtil.getString(property[2]);
    }
    if (Validator.isNotNull(key)) {
      tagsPropertyLocalService.addProperty(userId,entryId,key,value);
    }
  }
  return entry;
}
