{
  if (Validator.isNull(vocabularyName)) {
    vocabularyName=PropsValues.TAGS_VOCABULARY_DEFAULT;
  }
  TagsEntry entry=tagsEntryPersistence.findByPrimaryKey(entryId);
  entry.setModifiedDate(new Date());
  TagsVocabulary vocabulary=null;
  try {
    vocabulary=tagsVocabularyPersistence.findByG_N(entry.getGroupId(),vocabularyName);
  }
 catch (  NoSuchVocabularyException nsve) {
    if (vocabularyName.equals(PropsValues.TAGS_VOCABULARY_DEFAULT)) {
      ServiceContext vocabularyServiceContext=new ServiceContext();
      vocabularyServiceContext.setAddCommunityPermissions(true);
      vocabularyServiceContext.setAddGuestPermissions(true);
      vocabularyServiceContext.setScopeGroupId(entry.getGroupId());
      vocabulary=tagsVocabularyLocalService.addVocabulary(userId,vocabularyName,TagsEntryConstants.FOLKSONOMY_TAG,vocabularyServiceContext);
    }
 else {
      throw nsve;
    }
  }
  entry.setVocabularyId(vocabulary.getVocabularyId());
  boolean folksonomy=vocabulary.isFolksonomy();
  name=name.trim();
  if (folksonomy) {
    name=name.toLowerCase();
    if (!entry.getName().equals(name) && hasEntry(entry.getGroupId(),name,folksonomy)) {
      throw new DuplicateEntryException("A tag entry with the name " + name + " already exists");
    }
  }
  if (!entry.getName().equals(name)) {
    try {
      TagsEntry existingEntry=getEntry(entry.getGroupId(),name,folksonomy);
      if (existingEntry.getEntryId() != entryId) {
        throw new DuplicateEntryException("A tag entry with the name " + name + " already exists");
      }
    }
 catch (    NoSuchEntryException nsee) {
    }
  }
  validate(name);
  entry.setName(name);
  if (Validator.isNotNull(parentEntryName)) {
    TagsEntry parentEntry=getEntry(entry.getGroupId(),parentEntryName,folksonomy);
    entry.setParentEntryId(parentEntry.getEntryId());
  }
 else {
    entry.setParentEntryId(TagsEntryConstants.DEFAULT_PARENT_ENTRY_ID);
  }
  tagsEntryPersistence.update(entry,false);
  Set<Long> newProperties=new HashSet<Long>();
  List<TagsProperty> oldProperties=tagsPropertyPersistence.findByEntryId(entryId);
  for (int i=0; i < properties.length; i++) {
    String[] property=StringUtil.split(properties[i],StringPool.COLON);
    long propertyId=0;
    if (property.length > 0) {
      propertyId=GetterUtil.getLong(property[0]);
    }
    String key=StringPool.BLANK;
    if (property.length > 1) {
      key=GetterUtil.getString(property[1]);
    }
    String value=StringPool.BLANK;
    if (property.length > 2) {
      value=GetterUtil.getString(property[2]);
    }
    if (propertyId == 0) {
      if (Validator.isNotNull(key)) {
        tagsPropertyLocalService.addProperty(userId,entryId,key,value);
      }
    }
 else {
      if (Validator.isNull(key)) {
        tagsPropertyLocalService.deleteProperty(propertyId);
      }
 else {
        tagsPropertyLocalService.updateProperty(propertyId,key,value);
        newProperties.add(propertyId);
      }
    }
  }
  for (  TagsProperty property : oldProperties) {
    if (!newProperties.contains(property.getPropertyId())) {
      tagsPropertyLocalService.deleteProperty(property);
    }
  }
  return entry;
}
