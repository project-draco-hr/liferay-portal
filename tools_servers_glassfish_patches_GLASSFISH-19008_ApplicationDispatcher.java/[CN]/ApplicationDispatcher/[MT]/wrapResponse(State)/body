{
  ServletResponse previous=null;
  ServletResponse current=state.outerResponse;
  while (current != null) {
    if (!(current instanceof ServletResponseWrapper))     break;
    if (current instanceof ApplicationHttpResponse)     break;
    if (current instanceof ApplicationResponse)     break;
    if (current instanceof org.apache.catalina.Response)     break;
    previous=current;
    current=((ServletResponseWrapper)current).getResponse();
  }
  ServletResponse wrapper=null;
  if ((current instanceof ApplicationHttpResponse) || (current instanceof HttpResponse) || (current instanceof HttpServletResponse))   wrapper=new ApplicationHttpResponse((HttpServletResponse)current,DispatcherType.INCLUDE == state.dispatcherType);
 else   wrapper=new ApplicationResponse(current,DispatcherType.INCLUDE == state.dispatcherType);
  if (previous == null)   state.outerResponse=wrapper;
 else   ((ServletResponseWrapper)previous).setResponse(wrapper);
  state.wrapResponse=wrapper;
  return (wrapper);
}
