{
  Layout layout=(Layout)request.getAttribute(WebKeys.LAYOUT);
  WindowState windowState=WindowStateFactory.getWindowState(ParamUtil.getString(request,"p_p_state"));
  if (layout.isTypeControlPanel() && ((windowState == null) || windowState.equals(WindowState.NORMAL) || Validator.isNull(windowState.toString()))) {
    windowState=WindowState.MAXIMIZED;
  }
  PortletMode portletMode=PortletModeFactory.getPortletMode(ParamUtil.getString(request,"p_p_mode"));
  PortletPreferencesIds portletPreferencesIds=PortletPreferencesFactoryUtil.getPortletPreferencesIds(request,portlet.getPortletId());
  PortletPreferences portletPreferences=PortletPreferencesLocalServiceUtil.getStrictPreferences(portletPreferencesIds);
  ServletContext servletContext=(ServletContext)request.getAttribute(WebKeys.CTX);
  InvokerPortlet invokerPortlet=PortletInstanceFactoryUtil.create(portlet,servletContext);
  PortletConfig portletConfig=PortletConfigFactoryUtil.create(portlet,servletContext);
  PortletContext portletContext=portletConfig.getPortletContext();
  String contentType=request.getHeader(HttpHeaders.CONTENT_TYPE);
  if (_log.isDebugEnabled()) {
    _log.debug("Content type " + contentType);
  }
  try {
    ActionRequestImpl actionRequestImpl=ActionRequestFactory.create(request,portlet,invokerPortlet,portletContext,windowState,portletMode,portletPreferences,layout.getPlid());
    User user=PortalUtil.getUser(request);
    ActionResponseImpl actionResponseImpl=ActionResponseFactory.create(actionRequestImpl,response,portlet.getPortletId(),user,layout,windowState,portletMode);
    actionRequestImpl.defineObjects(portletConfig,actionResponseImpl);
    ServiceContext serviceContext=ServiceContextFactory.getInstance(actionRequestImpl);
    ServiceContextThreadLocal.pushServiceContext(serviceContext);
    invokerPortlet.processAction(actionRequestImpl,actionResponseImpl);
    actionResponseImpl.transferHeaders(response);
    RenderParametersPool.put(request,layout.getPlid(),portlet.getPortletId(),actionResponseImpl.getRenderParameterMap());
    List<Event> events=actionResponseImpl.getEvents();
    String redirectLocation=actionResponseImpl.getRedirectLocation();
    if (Validator.isNull(redirectLocation) && portlet.isActionURLRedirect()) {
      PortletURL portletURL=PortletURLFactoryUtil.create(actionRequestImpl,actionRequestImpl.getPortletName(),layout.getPlid(),PortletRequest.RENDER_PHASE);
      Map<String,String[]> renderParameters=actionResponseImpl.getRenderParameterMap();
      for (      Map.Entry<String,String[]> entry : renderParameters.entrySet()) {
        String key=entry.getKey();
        String[] value=entry.getValue();
        portletURL.setParameter(key,value);
      }
      redirectLocation=portletURL.toString();
    }
    return new ActionResult(events,redirectLocation);
  }
  finally {
    ServiceContextThreadLocal.popServiceContext();
  }
}
