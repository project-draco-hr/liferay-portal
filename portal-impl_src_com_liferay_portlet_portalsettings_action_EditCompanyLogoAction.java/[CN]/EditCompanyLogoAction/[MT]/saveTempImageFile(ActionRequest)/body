{
  FileEntry tempFileEntry=null;
  InputStream tempImageStream=null;
  try {
    tempFileEntry=getTempImageFileEntry(actionRequest);
    tempImageStream=tempFileEntry.getContentStream();
    ImageBag imageBag=ImageToolUtil.read(tempImageStream);
    RenderedImage renderedImage=imageBag.getRenderedImage();
    String cropRegionJSON=ParamUtil.getString(actionRequest,"cropRegion");
    if (Validator.isNotNull(cropRegionJSON)) {
      JSONObject jsonObject=JSONFactoryUtil.createJSONObject(cropRegionJSON);
      int height=jsonObject.getInt("height");
      int width=jsonObject.getInt("width");
      int x=jsonObject.getInt("x");
      int y=jsonObject.getInt("y");
      renderedImage=getCroppedRenderedImage(renderedImage,height,width,x,y);
    }
    byte[] bytes=ImageToolUtil.getBytes(renderedImage,imageBag.getType());
    saveTempImageFile(actionRequest,bytes);
  }
 catch (  NoSuchFileEntryException nsfee) {
    throw new UploadException(nsfee);
  }
catch (  NoSuchRepositoryException nsre) {
    throw new UploadException(nsre);
  }
 finally {
    StreamUtil.cleanUp(tempImageStream);
    if (tempFileEntry != null) {
      TempFileUtil.deleteTempFile(tempFileEntry.getFileEntryId());
    }
  }
}
