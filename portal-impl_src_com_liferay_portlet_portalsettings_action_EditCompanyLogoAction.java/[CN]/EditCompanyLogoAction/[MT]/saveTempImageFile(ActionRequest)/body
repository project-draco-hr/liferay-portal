{
  String tempFilePath=getTempImageFilePath(actionRequest);
  InputStream tempImageStream=null;
  try {
    tempImageStream=getTempImageStream(tempFilePath);
    if (tempImageStream == null) {
      throw new UploadException();
    }
    ImageBag imageBag=ImageToolUtil.read(tempImageStream);
    RenderedImage renderedImage=imageBag.getRenderedImage();
    String cropRegionJSON=ParamUtil.getString(actionRequest,"cropRegion");
    if (Validator.isNotNull(cropRegionJSON)) {
      JSONObject jsonObject=JSONFactoryUtil.createJSONObject(cropRegionJSON);
      int height=jsonObject.getInt("height");
      int width=jsonObject.getInt("width");
      int x=jsonObject.getInt("x");
      int y=jsonObject.getInt("y");
      renderedImage=getCroppedRenderedImage(renderedImage,height,width,x,y);
    }
    byte[] bytes=ImageToolUtil.getBytes(renderedImage,imageBag.getType());
    saveTempImageFile(actionRequest,bytes);
  }
  finally {
    TempFileUtil.deleteTempFile(tempFilePath);
    StreamUtil.cleanUp(tempImageStream);
  }
}
