{
  UploadPortletRequest uploadPortletRequest=PortalUtil.getUploadPortletRequest(portletRequest);
  ThemeDisplay themeDisplay=(ThemeDisplay)portletRequest.getAttribute(WebKeys.THEME_DISPLAY);
  InputStream inputStream=null;
  try {
    inputStream=uploadPortletRequest.getFileAsStream("fileName");
    String mimeType=MimeTypesUtil.getContentType(inputStream,null);
    if (!_imageMimeTypes.contains(mimeType)) {
      throw new ImageTypeException();
    }
    TempFileUtil.addTempFile(themeDisplay.getUserId(),getTempImageFileName(portletRequest),getTempImageFolderName(),inputStream);
  }
 catch (  DuplicateFileException dfe) {
    TempFileUtil.deleteTempFile(getTempImageFilePath(portletRequest));
    TempFileUtil.addTempFile(themeDisplay.getUserId(),getTempImageFileName(portletRequest),getTempImageFolderName(),inputStream);
  }
 finally {
    StreamUtil.cleanUp(inputStream);
  }
}
