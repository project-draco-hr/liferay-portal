{
  if (image.getType() == BufferedImage.TYPE_BYTE_BINARY) {
    SampleModel sampleModel=image.getSampleModel();
    int type=sampleModel.getDataType();
    if (!((type < DataBuffer.TYPE_BYTE) || (type > DataBuffer.TYPE_INT) || (sampleModel.getNumBands() != 1)|| (sampleModel.getSampleSize(0) != 1))) {
      BufferedImage binaryImage=new BufferedImage(image.getWidth(),image.getHeight(),BufferedImage.TYPE_BYTE_BINARY);
      binaryImage.getGraphics().drawImage(image,0,0,null);
      image=binaryImage;
    }
  }
  if (!ImageIO.write(image,"wbmp",out)) {
    out.write(0);
    out.write(0);
    out.write(_toMultiByte(image.getWidth()));
    out.write(_toMultiByte(image.getHeight()));
    DataBuffer dataBuffer=image.getData().getDataBuffer();
    int size=dataBuffer.getSize();
    for (int i=0; i < size; i++) {
      out.write((byte)dataBuffer.getElem(i));
    }
  }
}
