{
  super.prepare(contextObjects,request);
  ThemeDisplay themeDisplay=(ThemeDisplay)request.getAttribute(WebKeys.THEME_DISPLAY);
  if (themeDisplay != null) {
    contextObjects.put("init",themeDisplay.getPathContext() + TemplateConstants.SERVLET_SEPARATOR + "/classic/templates/init.vm");
  }
  Theme theme=(Theme)request.getAttribute(WebKeys.THEME);
  if ((theme == null) && (themeDisplay != null)) {
    theme=themeDisplay.getTheme();
  }
  if (theme != null) {
    String servletContextName=GetterUtil.getString(theme.getServletContextName());
    contextObjects.put("fullCssPath",servletContextName + theme.getVelocityResourceListener() + theme.getCssPath());
    contextObjects.put("fullTemplatesPath",servletContextName + theme.getVelocityResourceListener() + theme.getTemplatesPath());
  }
  PortletDisplay portletDisplay=themeDisplay.getPortletDisplay();
  Map<String,Object> vmVariables=(Map<String,Object>)request.getAttribute(WebKeys.VM_VARIABLES + portletDisplay.getId());
  if (vmVariables != null) {
    for (    Map.Entry<String,Object> entry : vmVariables.entrySet()) {
      String key=entry.getKey();
      Object value=entry.getValue();
      if (Validator.isNotNull(key)) {
        contextObjects.put(key,value);
      }
    }
  }
}
