{
  Date now=new Date();
  validate(0,companyId,name);
  User user=userPersistence.findByPrimaryKey(userId);
  long userGroupId=counterLocalService.increment();
  UserGroup userGroup=userGroupPersistence.create(userGroupId);
  if (serviceContext != null) {
    userGroup.setUuid(serviceContext.getUuid());
  }
  userGroup.setCompanyId(companyId);
  userGroup.setUserId(user.getUserId());
  userGroup.setUserName(user.getFullName());
  if (serviceContext != null) {
    userGroup.setCreateDate(serviceContext.getCreateDate(now));
    userGroup.setModifiedDate(serviceContext.getModifiedDate(now));
  }
 else {
    userGroup.setCreateDate(now);
    userGroup.setModifiedDate(now);
  }
  userGroup.setParentUserGroupId(UserGroupConstants.DEFAULT_PARENT_USER_GROUP_ID);
  userGroup.setName(name);
  userGroup.setDescription(description);
  userGroup.setAddedByLDAPImport(LDAPUserGroupTransactionThreadLocal.isOriginatesFromLDAP());
  userGroup.setExpandoBridgeAttributes(serviceContext);
  userGroupPersistence.update(userGroup);
  groupLocalService.addGroup(userId,GroupConstants.DEFAULT_PARENT_GROUP_ID,UserGroup.class.getName(),userGroup.getUserGroupId(),GroupConstants.DEFAULT_LIVE_GROUP_ID,String.valueOf(userGroupId),null,0,null,false,true,true,null);
  resourceLocalService.addResources(companyId,0,userId,UserGroup.class.getName(),userGroup.getUserGroupId(),false,false,false);
  Indexer indexer=IndexerRegistryUtil.nullSafeGetIndexer(UserGroup.class);
  indexer.reindex(userGroup);
  return userGroup;
}
