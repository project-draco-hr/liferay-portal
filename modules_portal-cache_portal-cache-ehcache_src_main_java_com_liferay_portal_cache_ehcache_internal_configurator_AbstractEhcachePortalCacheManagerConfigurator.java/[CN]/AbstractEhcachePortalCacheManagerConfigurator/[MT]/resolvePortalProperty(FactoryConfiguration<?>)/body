{
  if (factoryConfiguration == null) {
    return;
  }
  String propertySeparatorPortalPropertyKey=getPortalPropertyKey(factoryConfiguration.getPropertySeparator());
  if (Validator.isNotNull(propertySeparatorPortalPropertyKey)) {
    factoryConfiguration.setPropertySeparator(StringPool.COMMA);
  }
  String propertiesStringPortalPropertyKey=getPortalPropertyKey(factoryConfiguration.getProperties());
  if (Validator.isNotNull(propertiesStringPortalPropertyKey)) {
    String[] values=props.getArray(propertiesStringPortalPropertyKey);
    if (_log.isInfoEnabled()) {
      _log.info("portalPropertyKey " + propertiesStringPortalPropertyKey + " has value "+ Arrays.toString(values));
    }
    StringBundler sb=new StringBundler(values.length * 4 - 1);
    String propertySeparator=factoryConfiguration.getPropertySeparator();
    for (    String value : values) {
      String[] valueParts=StringUtil.split(value,CharPool.EQUAL);
      if (valueParts.length != 2) {
        if (_log.isWarnEnabled()) {
          _log.warn("Ignore malformed value " + value);
        }
        continue;
      }
      sb.append(valueParts[0]);
      sb.append(CharPool.EQUAL);
      sb.append(StringUtil.replace(valueParts[1],"&",";",_unescapeMap));
      sb.append(propertySeparator);
    }
    if (values.length > 0) {
      sb.setIndex(sb.index() - 1);
    }
    factoryConfiguration.setProperties(sb.toString());
  }
  String classPathPortalPropertyKey=getPortalPropertyKey(factoryConfiguration.getFullyQualifiedClassPath());
  if (Validator.isNull(classPathPortalPropertyKey)) {
    return;
  }
  String value=props.get(classPathPortalPropertyKey);
  if (_log.isInfoEnabled()) {
    _log.info("portalPropertyKey " + classPathPortalPropertyKey + " has value "+ value);
  }
  factoryConfiguration.setClass(props.get(classPathPortalPropertyKey));
  if (classPathPortalPropertyKey.equals(PropsKeys.EHCACHE_CACHE_EVENT_LISTENER_FACTORY)) {
    StringBundler sb=new StringBundler(5);
    String propertiesString=factoryConfiguration.getProperties();
    if (propertiesString != null) {
      sb.append(factoryConfiguration.getProperties());
      sb.append(factoryConfiguration.getPropertySeparator());
    }
    sb.append(PortalCacheReplicator.REPLICATOR);
    sb.append(CharPool.EQUAL);
    sb.append(Boolean.TRUE);
    factoryConfiguration.setProperties(sb.toString());
  }
}
