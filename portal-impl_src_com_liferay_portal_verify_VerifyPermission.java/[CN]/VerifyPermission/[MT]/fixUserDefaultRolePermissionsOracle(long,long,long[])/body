{
  try {
    runSQL("alter table ResourcePermission drop column plid");
  }
 catch (  SQLException sqle) {
    if (_log.isDebugEnabled()) {
      _log.debug(sqle,sqle);
    }
  }
  runSQL("alter table ResourcePermission add plid NUMBER null");
  runSQL("create index tmp_res_plid on ResourcePermission(plid)");
  StringBundler sb=new StringBundler(6);
  sb.append("update ResourcePermission r1 set plid = (select ");
  sb.append("SUBSTR(ResourcePermission.primKey, 0, ");
  sb.append("INSTR(ResourcePermission.primKey, '_LAYOUT_') -1) from ");
  sb.append("ResourcePermission where r1.resourcePermissionId = ");
  sb.append("ResourcePermission.resourcePermissionId and ");
  sb.append("ResourcePermission.primKey like '%_LAYOUT_%')");
  runSQL(sb.toString());
  for (  long companyId : companyIds) {
    Role powerUserRole=RoleLocalServiceUtil.getRole(companyId,RoleConstants.POWER_USER);
    Role userRole=RoleLocalServiceUtil.getRole(companyId,RoleConstants.USER);
    deleteConflictingUserDefaultRolePermissions(companyId,powerUserRole.getRoleId(),userRole.getRoleId(),userClassNameId,userGroupClassNameId);
    sb=new StringBundler(19);
    sb.append("update ResourcePermission r1 set roleId = ");
    sb.append(userRole.getRoleId());
    sb.append(" where exists (select ");
    sb.append("ResourcePermission.resourcePermissionId from ");
    sb.append("ResourcePermission inner join Layout on ");
    sb.append("ResourcePermission.plid = Layout.plid inner join ");
    sb.append("Group_ on Layout.groupId = Group_.groupId where ");
    sb.append("r1.resourcePermissionId = ResourcePermission.");
    sb.append("resourcePermissionId and ResourcePermission.scope = ");
    sb.append(ResourceConstants.SCOPE_INDIVIDUAL);
    sb.append(" and ResourcePermission.roleId = ");
    sb.append(powerUserRole.getRoleId());
    sb.append(" and (Group_.classNameId = ");
    sb.append(userClassNameId);
    sb.append(" or Group_.classNameId = ");
    sb.append(userGroupClassNameId);
    sb.append(") and Layout.type_ = '");
    sb.append(LayoutConstants.TYPE_PORTLET);
    sb.append("')");
    runSQL(sb.toString());
  }
  runSQL("alter table ResourcePermission drop column plid");
}
