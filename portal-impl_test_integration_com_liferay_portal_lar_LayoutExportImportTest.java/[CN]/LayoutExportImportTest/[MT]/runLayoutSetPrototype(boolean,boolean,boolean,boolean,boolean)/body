{
  LayoutSetPrototype layoutSetPrototype=ServiceTestUtil.addLayoutSetPrototype(ServiceTestUtil.randomString());
  Group layoutSetPrototypeGroup=layoutSetPrototype.getGroup();
  int layoutSetPrototypeLayoutsCount=LayoutLocalServiceUtil.getLayoutsCount(layoutSetPrototypeGroup,true);
  ServiceTestUtil.addLayout(layoutSetPrototypeGroup.getGroupId(),ServiceTestUtil.randomString(),true);
  ServiceTestUtil.addLayout(layoutSetPrototypeGroup.getGroupId(),ServiceTestUtil.randomString(),true);
  Group group=ServiceTestUtil.addGroup();
  SitesUtil.updateLayoutSetPrototypesLinks(group,layoutSetPrototype.getLayoutSetPrototypeId(),0,layoutSetLinkEnabled,false);
  propagateChanges(group);
  int groupLayoutsCount=LayoutLocalServiceUtil.getLayoutsCount(group,false);
  Assert.assertEquals(groupLayoutsCount,layoutSetPrototypeLayoutsCount + 2);
  if (addPage) {
    Layout layout=null;
    if (useLayoutPrototype) {
      LayoutPrototype layoutPrototype=ServiceTestUtil.addLayoutPrototype(ServiceTestUtil.randomString());
      Layout layoutPrototypeLayout=layoutPrototype.getLayout();
      updateLayoutTemplateId(layoutPrototypeLayout,"2_2_columns");
      layout=ServiceTestUtil.addLayout(group.getGroupId(),ServiceTestUtil.randomString(),false,layoutPrototype,layoutLinkEnabled);
      if (layoutLinkEnabled) {
        layout=propagateChanges(layout);
      }
      updateLayoutTemplateId(layoutPrototypeLayout,"1_column");
      if (layoutLinkEnabled) {
        Assert.assertEquals("2_2_columns",layout.getTypeSettingsProperty(LayoutTypePortletConstants.LAYOUT_TEMPLATE_ID));
        layout=propagateChanges(layout);
      }
    }
 else {
      Thread.sleep(2000);
      layout=ServiceTestUtil.addLayout(layoutSetPrototypeGroup.getGroupId(),ServiceTestUtil.randomString(),true);
    }
    if (!useLayoutPrototype) {
      groupLayoutsCount=LayoutLocalServiceUtil.getLayoutsCount(group,false);
      Assert.assertEquals(groupLayoutsCount,layoutSetPrototypeLayoutsCount + 2);
    }
    propagateChanges(group);
    groupLayoutsCount=LayoutLocalServiceUtil.getLayoutsCount(group,false);
    if (layoutSetLinkEnabled) {
      Assert.assertEquals(groupLayoutsCount,layoutSetPrototypeLayoutsCount + 3);
      if (useLayoutPrototype) {
        if (layoutLinkEnabled) {
          Assert.assertEquals("1_column",layout.getTypeSettingsProperty(LayoutTypePortletConstants.LAYOUT_TEMPLATE_ID));
        }
 else {
          Assert.assertEquals("2_2_columns",layout.getTypeSettingsProperty(LayoutTypePortletConstants.LAYOUT_TEMPLATE_ID));
        }
      }
    }
    if (deletePage) {
      LayoutLocalServiceUtil.deleteLayout(layout,true,ServiceTestUtil.getServiceContext());
      groupLayoutsCount=LayoutLocalServiceUtil.getLayoutsCount(group,false);
      if (layoutSetLinkEnabled) {
        if (!useLayoutPrototype) {
          Assert.assertEquals(groupLayoutsCount,layoutSetPrototypeLayoutsCount + 3);
          propagateChanges(group);
        }
        groupLayoutsCount=LayoutLocalServiceUtil.getLayoutsCount(group,false);
      }
      Assert.assertEquals(groupLayoutsCount,layoutSetPrototypeLayoutsCount + 2);
    }
  }
}
