{
  LayoutSetPrototype simple=ServiceTestUtil.addLayoutSetPrototype("simple");
  Group layoutsetprototypegroup=simple.getGroup();
  int layoutSetPrototypePagesCount=LayoutLocalServiceUtil.getLayoutsCount(layoutsetprototypegroup,true);
  ServiceTestUtil.addLayout(layoutsetprototypegroup.getGroupId(),"one",true);
  ServiceTestUtil.addLayout(layoutsetprototypegroup.getGroupId(),"two",true);
  Group site=ServiceTestUtil.addGroup("group-one");
  SitesUtil.updateLayoutSetPrototypesLinks(site,simple.getLayoutSetPrototypeId(),0,layoutSetLinkEnabled,false);
  _propagateChanges(site);
  int sitePagesCount=LayoutLocalServiceUtil.getLayoutsCount(site,false);
  Assert.assertEquals(sitePagesCount,layoutSetPrototypePagesCount + 2);
  if (pageAddition) {
    Layout page=null;
    if (useLayoutPrototype) {
      LayoutPrototype simplePage=ServiceTestUtil.addLayoutPrototype("Simple Page");
      Layout simplePageLayout=simplePage.getLayout();
      _changeLayoutTemplateId(simplePageLayout,"2_2_columns");
      page=_addLayoutUsingLayoutPrototype(site.getGroupId(),"three",simplePage,layoutLinkEnabled);
      if (layoutLinkEnabled) {
        _propagateChanges(page);
      }
      _changeLayoutTemplateId(simplePageLayout,"1_column");
      if (layoutLinkEnabled) {
        Assert.assertEquals("2_2_columns",page.getTypeSettingsProperty(LayoutTypePortletConstants.LAYOUT_TEMPLATE_ID));
        _propagateChanges(page);
      }
    }
 else {
      page=ServiceTestUtil.addLayout(layoutsetprototypegroup.getGroupId(),"three",true);
    }
    if (!useLayoutPrototype) {
      sitePagesCount=LayoutLocalServiceUtil.getLayoutsCount(site,false);
      Assert.assertEquals(sitePagesCount,layoutSetPrototypePagesCount + 2);
    }
    _propagateChanges(site);
    sitePagesCount=LayoutLocalServiceUtil.getLayoutsCount(site,false);
    if (layoutSetLinkEnabled) {
      Assert.assertEquals(sitePagesCount,layoutSetPrototypePagesCount + 3);
      if (useLayoutPrototype) {
        if (layoutLinkEnabled) {
          Assert.assertEquals("1_column",page.getTypeSettingsProperty(LayoutTypePortletConstants.LAYOUT_TEMPLATE_ID));
        }
 else {
          Assert.assertEquals("2_2_columns",page.getTypeSettingsProperty(LayoutTypePortletConstants.LAYOUT_TEMPLATE_ID));
        }
      }
    }
    if (pageDeletion) {
      LayoutLocalServiceUtil.deleteLayout(page.getPlid(),ServiceTestUtil.getServiceContext());
      sitePagesCount=LayoutLocalServiceUtil.getLayoutsCount(site,false);
      if (layoutSetLinkEnabled) {
        if (!useLayoutPrototype) {
          Assert.assertEquals(sitePagesCount,layoutSetPrototypePagesCount + 3);
          _propagateChanges(site);
        }
        sitePagesCount=LayoutLocalServiceUtil.getLayoutsCount(site,false);
      }
      Assert.assertEquals(sitePagesCount,layoutSetPrototypePagesCount + 2);
    }
  }
}
