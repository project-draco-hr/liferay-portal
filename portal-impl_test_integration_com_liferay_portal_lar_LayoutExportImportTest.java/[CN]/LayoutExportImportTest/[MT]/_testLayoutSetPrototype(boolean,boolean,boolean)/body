{
  LayoutSetPrototype simple=ServiceTestUtil.addLayoutSetPrototype("simple");
  Group layoutsetprototypegroup=simple.getGroup();
  int layoutSetPrototypePagesCount=LayoutLocalServiceUtil.getLayoutsCount(layoutsetprototypegroup,true);
  ServiceTestUtil.addLayout(layoutsetprototypegroup.getGroupId(),"one",true);
  ServiceTestUtil.addLayout(layoutsetprototypegroup.getGroupId(),"two",true);
  Group site=ServiceTestUtil.addGroup("group-one");
  SitesUtil.updateLayoutSetPrototypesLinks(site,simple.getLayoutSetPrototypeId(),0,linkEnabled,false);
  _propagateChanges(site);
  int sitePagesCount=LayoutLocalServiceUtil.getLayoutsCount(site,false);
  Assert.assertEquals(sitePagesCount,layoutSetPrototypePagesCount + 2);
  if (pageAddition) {
    Layout page=ServiceTestUtil.addLayout(layoutsetprototypegroup.getGroupId(),"three",true);
    sitePagesCount=LayoutLocalServiceUtil.getLayoutsCount(site,false);
    Assert.assertEquals(sitePagesCount,layoutSetPrototypePagesCount + 2);
    _propagateChanges(site);
    sitePagesCount=LayoutLocalServiceUtil.getLayoutsCount(site,false);
    if (linkEnabled) {
      Assert.assertEquals(sitePagesCount,layoutSetPrototypePagesCount + 3);
    }
    if (pageDeletion) {
      LayoutLocalServiceUtil.deleteLayout(page.getPlid(),ServiceTestUtil.getServiceContext());
      sitePagesCount=LayoutLocalServiceUtil.getLayoutsCount(site,false);
      if (linkEnabled) {
        Assert.assertEquals(sitePagesCount,layoutSetPrototypePagesCount + 3);
        _propagateChanges(site);
        sitePagesCount=LayoutLocalServiceUtil.getLayoutsCount(site,false);
      }
      Assert.assertEquals(sitePagesCount,layoutSetPrototypePagesCount + 2);
    }
  }
}
