{
  warnPorletProperties(portletName,serviceReference);
  Bundle bundle=serviceReference.getBundle();
  BundleWiring bundleWiring=bundle.adapt(BundleWiring.class);
  ClassLoader bundleClassLoader=bundleWiring.getClassLoader();
  Thread thread=Thread.currentThread();
  ClassLoader contextClassLoader=thread.getContextClassLoader();
  thread.setContextClassLoader(bundleWiring.getClassLoader());
  ServiceRegistrations serviceRegistrations=getServiceRegistrations(bundle);
  try {
    BundlePortletApp bundlePortletApp=createBundlePortletApp(bundle,bundleClassLoader,serviceRegistrations);
    com.liferay.portal.kernel.model.Portlet portletModel=buildPortletModel(bundlePortletApp,portletId);
    portletModel.setPortletName(portletName);
    String displayName=GetterUtil.getString(serviceReference.getProperty("javax.portlet.display-name"),portletName);
    portletModel.setDisplayName(displayName);
    Class<?> portletClazz=portlet.getClass();
    portletModel.setPortletClass(portletClazz.getName());
    collectJxPortletFeatures(serviceReference,portletModel);
    collectLiferayFeatures(serviceReference,portletModel);
    PortletContextBag portletContextBag=new PortletContextBag(bundlePortletApp.getServletContextName());
    PortletContextBagPool.put(bundlePortletApp.getServletContextName(),portletContextBag);
    PortletBagFactory portletBagFactory=new BundlePortletBagFactory(portlet);
    portletBagFactory.setClassLoader(bundleClassLoader);
    portletBagFactory.setServletContext(bundlePortletApp.getServletContext());
    portletBagFactory.setWARFile(true);
    portletBagFactory.create(portletModel,true);
    checkWebResources(bundle.getBundleContext(),bundlePortletApp.getServletContextName(),bundleClassLoader,serviceRegistrations);
    checkResourceBundles(bundle.getBundleContext(),bundleClassLoader,portletModel,serviceRegistrations);
    List<Company> companies=_companyLocalService.getCompanies();
    deployPortlet(serviceReference,portletModel,companies);
    portletModel.setReady(true);
    if (_log.isInfoEnabled()) {
      _log.info("Added " + serviceReference);
    }
    serviceRegistrations.addServiceReference(serviceReference);
    return portletModel;
  }
 catch (  Exception e) {
    _log.error("Portlet " + portletId + " from "+ bundle+ " failed to initialize",e);
    return null;
  }
 finally {
    thread.setContextClassLoader(contextClassLoader);
  }
}
