{
  BundleContext bundleContext=_componentContext.getBundleContext();
  Portlet portlet=bundleContext.getService(serviceReference);
  String portletName=(String)serviceReference.getProperty("javax.portlet.name");
  if (Validator.isNull(portletName)) {
    Class<?> clazz=portlet.getClass();
    portletName=StringUtil.replace(clazz.getName(),new String[]{".","$"},new String[]{"_","_"});
  }
  String portletId=StringUtil.replace(portletName,new String[]{".","$"},new String[]{"_","_"});
  if (portletId.length() > PortletInstance.PORTLET_INSTANCE_KEY_MAX_LENGTH) {
    _log.error("Portlet ID " + portletId + " has more than "+ PortletInstance.PORTLET_INSTANCE_KEY_MAX_LENGTH+ " characters");
    bundleContext.ungetService(serviceReference);
    return null;
  }
  com.liferay.portal.model.Portlet portletModel=_portletLocalService.getPortletById(portletId);
  if (portletModel != null) {
    _log.error("Portlet id " + portletId + " is already in use");
    bundleContext.ungetService(serviceReference);
    return null;
  }
  if (_log.isInfoEnabled()) {
    _log.info("Adding " + serviceReference);
  }
  portletModel=addingPortlet(serviceReference,portlet,portletName,portletId);
  if (portletModel == null) {
    bundleContext.ungetService(serviceReference);
  }
  return portletModel;
}
