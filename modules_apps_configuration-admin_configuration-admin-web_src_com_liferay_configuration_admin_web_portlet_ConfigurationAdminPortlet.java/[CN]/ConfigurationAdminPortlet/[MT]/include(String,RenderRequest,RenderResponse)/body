{
  ThemeDisplay themeDisplay=(ThemeDisplay)renderRequest.getAttribute(WebKeys.THEME_DISPLAY);
  String factoryPid=ParamUtil.getString(renderRequest,"factoryPid");
  ConfigurationHelper configurationHelper=new ConfigurationHelper(_bundleContext,_configurationAdmin,_metaTypeService,themeDisplay.getLanguageId());
  if (path.equals("/edit_configuration.ftl")) {
    String pid=ParamUtil.getString(renderRequest,"pid",factoryPid);
    ConfigurationModel configurationModel=configurationHelper.getConfigurationModel(pid);
    if ((configurationModel == null) && Validator.isNotNull(factoryPid)) {
      configurationModel=configurationHelper.getConfigurationModel(factoryPid);
    }
    if (configurationModel != null) {
      configurationModel=new ConfigurationModel(configurationModel.getObjectClassDefinition(),configurationHelper.getConfiguration(pid),configurationModel.getBundleLocation(),configurationModel.isFactory());
    }
    renderRequest.setAttribute("configurationModel",configurationModel);
    renderRequest.setAttribute("factoryPid",factoryPid);
    renderRequest.setAttribute("pid",pid);
    DDMFormRendererHelper ddmFormRendererHelper=new DDMFormRendererHelper(renderRequest,renderResponse,configurationModel,_ddmFormRenderer);
    renderRequest.setAttribute(DDMWebKeys.DYNAMIC_DATA_MAPPING_FORM_HTML,ddmFormRendererHelper.getDDMFormHTML());
  }
 else {
    String viewType=ParamUtil.getString(renderRequest,"viewType");
    if (viewType.equals("factoryInstances")) {
      List<ConfigurationModel> configurationModels=configurationHelper.getFactoryInstances(themeDisplay.getLanguageId(),factoryPid);
      renderRequest.setAttribute("configurationModelIterator",new ConfigurationModelIterator(configurationModels));
      ConfigurationModel factoryConfigurationModel=configurationHelper.getConfigurationModel(factoryPid);
      renderRequest.setAttribute("factoryConfigurationModel",factoryConfigurationModel);
    }
 else {
      List<ConfigurationModel> configurationModels=configurationHelper.getConfigurationModels();
      renderRequest.setAttribute("configurationModelIterator",new ConfigurationModelIterator(configurationModels));
    }
  }
  include(path,renderRequest,renderResponse,PortletRequest.RENDER_PHASE);
}
