{
  StringBuffer sb=new StringBuffer(text);
  Pattern pattern=Pattern.compile("/image_gallery\\?(.*?)&(amp;)?t=");
  Matcher matcher=pattern.matcher(text);
  while (matcher.find()) {
    try {
      Map<String,String> detail=MapUtil.toLinkedHashMap(matcher.group(1).replace("&amp;","&").split("&"),StringPool.EQUAL);
      IGImage image=null;
      if (detail.containsKey("uuid")) {
        String uuid=detail.get("uuid");
        long groupId=GetterUtil.getLong(detail.get("groupId"));
        image=IGImageLocalServiceUtil.getImageByUuidAndGroupId(uuid,groupId);
      }
 else       if (detail.containsKey("image_id") || detail.containsKey("img_id") || detail.containsKey("i_id")) {
        long imageId=GetterUtil.getLong(detail.get("image_id"));
        if (imageId <= 0) {
          imageId=GetterUtil.getLong(detail.get("img_id"));
          if (imageId <= 0) {
            imageId=GetterUtil.getLong(detail.get("i_id"));
          }
        }
        image=IGImageLocalServiceUtil.getIGImage(imageId);
      }
      if (image == null) {
        continue;
      }
      IGPortletDataHandlerImpl.exportImage(context,foldersEl,imagesEl,image);
      sb.replace(matcher.start(1),matcher.end(1),"uuid=" + image.getUuid() + "&amp;groupId=@group_id@");
    }
 catch (    Exception e) {
      if (_log.isWarnEnabled()) {
        _log.warn(e,e);
      }
    }
  }
  return sb.toString();
}
