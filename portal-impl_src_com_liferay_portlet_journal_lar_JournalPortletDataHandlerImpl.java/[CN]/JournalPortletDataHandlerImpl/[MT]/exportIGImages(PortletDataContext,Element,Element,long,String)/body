{
  StringBuilder sb=new StringBuilder(content);
  int beginPos=content.length();
  while (true) {
    beginPos=content.lastIndexOf("/image_gallery?",beginPos);
    if (beginPos == -1) {
      return sb.toString();
    }
    int endPos1=content.indexOf(StringPool.APOSTROPHE,beginPos);
    int endPos2=content.indexOf(StringPool.CLOSE_BRACKET,beginPos);
    int endPos3=content.indexOf(StringPool.CLOSE_PARENTHESIS,beginPos);
    int endPos4=content.indexOf(StringPool.LESS_THAN,beginPos);
    int endPos5=content.indexOf(StringPool.QUOTE,beginPos);
    int endPos6=content.indexOf(StringPool.SPACE,beginPos);
    int endPos=endPos1;
    if ((endPos == -1) || ((endPos2 != -1) && (endPos2 < endPos))) {
      endPos=endPos2;
    }
    if ((endPos == -1) || ((endPos3 != -1) && (endPos3 < endPos))) {
      endPos=endPos3;
    }
    if ((endPos == -1) || ((endPos4 != -1) && (endPos4 < endPos))) {
      endPos=endPos4;
    }
    if ((endPos == -1) || ((endPos5 != -1) && (endPos5 < endPos))) {
      endPos=endPos5;
    }
    if ((endPos == -1) || ((endPos6 != -1) && (endPos6 < endPos))) {
      endPos=endPos6;
    }
    if ((beginPos == -1) || (endPos == -1)) {
      break;
    }
    try {
      String oldParameters=content.substring(beginPos,endPos);
      oldParameters=oldParameters.substring(oldParameters.indexOf(StringPool.QUESTION) + 1);
      boolean hasEncodedAmpersands=false;
      while (oldParameters.contains(StringPool.AMPERSAND_ENCODED)) {
        hasEncodedAmpersands=true;
        oldParameters=oldParameters.replace(StringPool.AMPERSAND_ENCODED,StringPool.AMPERSAND);
      }
      Map<String,String> map=MapUtil.toLinkedHashMap(oldParameters.split(StringPool.AMPERSAND),StringPool.EQUAL);
      IGImage image=null;
      if (map.containsKey("uuid")) {
        String uuid=map.get("uuid");
        String groupIdString=map.get("groupId");
        long groupId=GetterUtil.getLong(groupIdString);
        if (groupIdString.equals("@group_id@")) {
          groupId=entityGroupId;
        }
        image=IGImageLocalServiceUtil.getImageByUuidAndGroupId(uuid,groupId);
      }
 else       if (map.containsKey("image_id") || map.containsKey("img_id") || map.containsKey("i_id")) {
        long imageId=GetterUtil.getLong(map.get("image_id"));
        if (imageId <= 0) {
          imageId=GetterUtil.getLong(map.get("img_id"));
          if (imageId <= 0) {
            imageId=GetterUtil.getLong(map.get("i_id"));
          }
        }
        try {
          image=IGImageLocalServiceUtil.getImageByLargeImageId(imageId);
        }
 catch (        Exception e) {
          image=IGImageLocalServiceUtil.getImageBySmallImageId(imageId);
        }
      }
      if (image == null) {
        beginPos--;
        continue;
      }
      IGPortletDataHandlerImpl.exportImage(context,foldersEl,imagesEl,image);
      String timestamp=map.get("t");
      if (timestamp == null) {
        timestamp=String.valueOf(System.currentTimeMillis());
      }
      String newParameters="/image_gallery?uuid=" + image.getUuid() + "&groupId=@data_handler_group_id@&t="+ timestamp;
      if (hasEncodedAmpersands) {
        newParameters=newParameters.replace(StringPool.AMPERSAND,StringPool.AMPERSAND_ENCODED);
      }
      sb.replace(beginPos,endPos,newParameters);
    }
 catch (    Exception e) {
      if (_log.isWarnEnabled()) {
        _log.warn(e);
      }
    }
    beginPos--;
  }
  return sb.toString();
}
