{
  String path=templateElement.attributeValue("path");
  if (!portletDataContext.isPathNotProcessed(path)) {
    return;
  }
  JournalTemplate template=(JournalTemplate)portletDataContext.getZipEntryAsObject(path);
  long userId=portletDataContext.getUserId(template.getUserUuid());
  JournalCreationStrategy creationStrategy=JournalCreationStrategyFactory.getInstance();
  long authorId=creationStrategy.getAuthorUserId(portletDataContext,template);
  if (authorId != JournalCreationStrategy.USE_DEFAULT_USER_ID_STRATEGY) {
    userId=authorId;
  }
  String templateId=template.getTemplateId();
  boolean autoTemplateId=false;
  if (Validator.isNumber(templateId) || (JournalTemplateUtil.fetchByG_T(portletDataContext.getScopeGroupId(),templateId) != null)) {
    autoTemplateId=true;
  }
  Map<String,String> structureIds=(Map<String,String>)portletDataContext.getNewPrimaryKeysMap(JournalStructure.class + ".structureId");
  String parentStructureId=MapUtil.getString(structureIds,template.getStructureId(),template.getStructureId());
  String xsl=template.getXsl();
  xsl=importDLFileEntries(portletDataContext,templateElement,xsl);
  Group group=GroupLocalServiceUtil.getGroup(portletDataContext.getScopeGroupId());
  xsl=StringUtil.replace(xsl,"@data_handler_group_friendly_url@",group.getFriendlyURL());
  template.setXsl(xsl);
  boolean formatXsl=false;
  boolean addGroupPermissions=creationStrategy.addGroupPermissions(portletDataContext,template);
  boolean addGuestPermissions=creationStrategy.addGuestPermissions(portletDataContext,template);
  ServiceContext serviceContext=portletDataContext.createServiceContext(templateElement,template,_NAMESPACE);
  serviceContext.setAddGroupPermissions(addGroupPermissions);
  serviceContext.setAddGuestPermissions(addGuestPermissions);
  File smallFile=null;
  String smallImagePath=templateElement.attributeValue("small-image-path");
  if (template.isSmallImage() && Validator.isNotNull(smallImagePath)) {
    if (smallImagePath.endsWith(StringPool.PERIOD)) {
      smallImagePath+=template.getSmallImageType();
    }
    byte[] bytes=portletDataContext.getZipEntryAsByteArray(smallImagePath);
    if (bytes != null) {
      smallFile=File.createTempFile(String.valueOf(template.getSmallImageId()),StringPool.PERIOD + template.getSmallImageType());
      FileUtil.write(smallFile,bytes);
    }
  }
  JournalTemplate importedTemplate=null;
  if (portletDataContext.isDataStrategyMirror()) {
    JournalTemplate existingTemplate=JournalTemplateUtil.fetchByUUID_G(template.getUuid(),portletDataContext.getScopeGroupId());
    if (existingTemplate == null) {
      Group companyGroup=GroupLocalServiceUtil.getCompanyGroup(portletDataContext.getCompanyId());
      long companyGroupId=companyGroup.getGroupId();
      existingTemplate=JournalTemplateUtil.fetchByUUID_G(template.getUuid(),companyGroupId);
    }
    if (existingTemplate == null) {
      serviceContext.setUuid(template.getUuid());
      importedTemplate=JournalTemplateLocalServiceUtil.addTemplate(userId,portletDataContext.getScopeGroupId(),templateId,autoTemplateId,parentStructureId,template.getNameMap(),template.getDescriptionMap(),template.getXsl(),formatXsl,template.getLangType(),template.getCacheable(),template.isSmallImage(),template.getSmallImageURL(),smallFile,serviceContext);
    }
 else {
      String structureId=existingTemplate.getStructureId();
      if (Validator.isNull(structureId) && Validator.isNotNull(template.getStructureId())) {
        JournalStructure structure=JournalStructureUtil.fetchByG_S(template.getGroupId(),template.getStructureId());
        if (structure == null) {
          structureId=template.getStructureId();
        }
 else {
          JournalStructure existingStructure=JournalStructureUtil.findByUUID_G(structure.getUuid(),portletDataContext.getScopeGroupId());
          structureId=existingStructure.getStructureId();
        }
      }
      importedTemplate=JournalTemplateLocalServiceUtil.updateTemplate(existingTemplate.getGroupId(),existingTemplate.getTemplateId(),structureId,template.getNameMap(),template.getDescriptionMap(),template.getXsl(),formatXsl,template.getLangType(),template.getCacheable(),template.isSmallImage(),template.getSmallImageURL(),smallFile,serviceContext);
    }
  }
 else {
    importedTemplate=JournalTemplateLocalServiceUtil.addTemplate(userId,portletDataContext.getScopeGroupId(),templateId,autoTemplateId,parentStructureId,template.getNameMap(),template.getDescriptionMap(),template.getXsl(),formatXsl,template.getLangType(),template.getCacheable(),template.isSmallImage(),template.getSmallImageURL(),smallFile,serviceContext);
  }
  if (smallFile != null) {
    smallFile.delete();
  }
  portletDataContext.importClassedModel(template,importedTemplate,_NAMESPACE);
  Map<String,String> templateIds=(Map<String,String>)portletDataContext.getNewPrimaryKeysMap(JournalTemplate.class + ".templateId");
  templateIds.put(template.getTemplateId(),importedTemplate.getTemplateId());
  if (!templateId.equals(importedTemplate.getTemplateId())) {
    if (_log.isWarnEnabled()) {
      _log.warn("A template with the ID " + templateId + " already "+ "exists. The new generated ID is "+ importedTemplate.getTemplateId());
    }
  }
}
