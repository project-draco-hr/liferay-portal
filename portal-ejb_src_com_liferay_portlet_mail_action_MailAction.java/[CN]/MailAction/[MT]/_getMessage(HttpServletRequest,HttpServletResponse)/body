{
  JSONObject jsonObj=new JSONObject();
  long messageId=ParamUtil.getLong(req,"messageId");
  String folderId=ParamUtil.getString(req,"folderId");
  StringBuffer header=new StringBuffer();
  ServletContext ctx=(ServletContext)req.getAttribute(WebKeys.CTX);
  MailUtil.getFolder(req.getSession(),folderId);
  ThemeDisplay themeDisplay=(ThemeDisplay)req.getAttribute(WebKeys.THEME_DISPLAY);
  String url=themeDisplay.getPathMain() + "/mail/get_attachment?";
  MailMessage mm=MailUtil.getMessage(req.getSession(),messageId,url);
  req.setAttribute("mailMessage",mm);
  PortalUtil.renderPage(header,ctx,req,res,"/html/portlet/mail/message_details.jsp");
  jsonObj.put("body",mm.getHtmlBody());
  jsonObj.put("header",header.toString());
  jsonObj.put("id",messageId);
  return jsonObj.toString();
}
