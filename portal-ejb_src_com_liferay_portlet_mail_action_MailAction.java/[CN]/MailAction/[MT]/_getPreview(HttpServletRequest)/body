{
  JSONObject jsonObj=new JSONObject();
  HttpSession ses=req.getSession();
  String folderId=ParamUtil.getString(req,"folderId");
  String sortBy=ParamUtil.getString(req,"sortBy");
  boolean asc=ParamUtil.getBoolean(req,"asc");
  MailUtil.getFolder(ses,folderId);
  SortedSet set=null;
  if (sortBy.equals("name")) {
    set=MailUtil.getEnvelopes(ses,new RecipientComparator(asc));
  }
 else   if (sortBy.equals("subject")) {
    set=MailUtil.getEnvelopes(ses,new SubjectComparator(asc));
  }
 else {
    set=MailUtil.getEnvelopes(ses,new DateComparator(asc));
  }
  User user=PortalUtil.getUser(req);
  Locale locale=user.getLocale();
  TimeZone tz=user.getTimeZone();
  DateFormat dtf=DateFormats.getDateTime(locale,tz);
  DateFormat tf=DateFormats.getTime(locale,tz);
  DateFormat df=DateFormats.getDate(locale,tz);
  Date today=new Date();
  Calendar cal=Calendar.getInstance(tz,locale);
  cal.setTime(today);
  cal.add(Calendar.DATE,-1);
  Date yesterday=cal.getTime();
  String td=df.format(today);
  String yd=df.format(yesterday);
  JSONArray jsonEnvelopes=new JSONArray();
  Iterator itr=set.iterator();
  while (itr.hasNext()) {
    MailEnvelope me=(MailEnvelope)itr.next();
    JSONObject jEnvelope=new JSONObject();
    String formattedDate=null;
    String day=df.format(me.getDate());
    if (td.equals(day)) {
      formattedDate=LanguageUtil.get(user,"today") + StringPool.SPACE + tf.format(me.getDate());
    }
 else     if (yd.equals(day)) {
      formattedDate=LanguageUtil.get(user,"yesterday") + StringPool.SPACE + tf.format(me.getDate());
    }
 else {
      formattedDate=dtf.format(me.getDate());
    }
    jEnvelope.put("date",formattedDate);
    jEnvelope.put("id",me.getMessageId());
    jEnvelope.put("email",GetterUtil.getString(me.getRecipient(),StringPool.NBSP));
    jEnvelope.put("subject",GetterUtil.getString(me.getSubject(),StringPool.NBSP));
    jEnvelope.put("recent",me.isRecent());
    jsonEnvelopes.put(jEnvelope);
  }
  jsonObj.put("headers",jsonEnvelopes);
  return jsonObj.toString();
}
