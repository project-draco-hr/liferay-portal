{
  JSONObject jsonObj=new JSONObject();
  String folderId=ParamUtil.getString(req,"folderId");
  ThemeDisplay themeDisplay=(ThemeDisplay)req.getAttribute(WebKeys.THEME_DISPLAY);
  User user=themeDisplay.getUser();
  Locale locale=themeDisplay.getLocale();
  TimeZone timeZone=themeDisplay.getTimeZone();
  Date today=new Date();
  Calendar cal=Calendar.getInstance(timeZone,locale);
  cal.setTime(today);
  cal.add(Calendar.DATE,-1);
  Date yesterday=cal.getTime();
  DateFormat dateFormatDate=DateFormats.getDate(locale,timeZone);
  DateFormat dateFormatDateTime=DateFormats.getDateTime(locale,timeZone);
  DateFormat dateFormatTime=DateFormats.getTime(locale,timeZone);
  String todayString=dateFormatDate.format(today);
  String yesterdayString=dateFormatDate.format(yesterday);
  JSONArray jsonEnvelopes=new JSONArray();
  Iterator itr=getEnvelopes(req).iterator();
  while (itr.hasNext()) {
    MailEnvelope mailEnvelope=(MailEnvelope)itr.next();
    JSONObject jsonEnvelope=new JSONObject();
    String recipient=GetterUtil.getString(mailEnvelope.getRecipient(),StringPool.NBSP);
    String subject=GetterUtil.getString(mailEnvelope.getSubject(),StringPool.NBSP);
    String dateString=StringPool.NBSP;
    if (mailEnvelope.getDate() != null) {
      dateString=dateFormatDate.format(mailEnvelope.getDate());
      if (dateString.equals(todayString)) {
        dateString=LanguageUtil.get(user,"today") + StringPool.SPACE + dateFormatTime.format(mailEnvelope.getDate());
      }
 else       if (dateString.equals(yesterdayString)) {
        dateString=LanguageUtil.get(user,"yesterday") + StringPool.SPACE + dateFormatTime.format(mailEnvelope.getDate());
      }
 else {
        dateString=dateFormatDateTime.format(mailEnvelope.getDate());
      }
    }
    jsonEnvelope.put("id",mailEnvelope.getMessageId());
    jsonEnvelope.put("email",recipient);
    jsonEnvelope.put("subject",subject);
    jsonEnvelope.put("date",dateString);
    jsonEnvelope.put("size",TextFormatter.formatKB(mailEnvelope.getSize(),locale) + "k");
    jsonEnvelope.put("read",mailEnvelope.isRead());
    jsonEnvelope.put("replied",mailEnvelope.isAnswered());
    jsonEnvelope.put("flagged",mailEnvelope.isFlagged());
    jsonEnvelopes.put(jsonEnvelope);
  }
  jsonObj.put("folderId",folderId);
  jsonObj.put("headers",jsonEnvelopes);
  return jsonObj.toString();
}
