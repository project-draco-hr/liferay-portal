{
  if (layout == null) {
    return themeDisplay.getPathMain() + PATH_PORTAL_LAYOUT;
  }
  if (!layout.getType().equals(LayoutImpl.TYPE_URL)) {
    String layoutFriendlyURL=getLayoutFriendlyURL(layout,themeDisplay);
    if (Validator.isNotNull(layoutFriendlyURL)) {
      if (doAsUser && Validator.isNotNull(themeDisplay.getDoAsUserId())) {
        layoutFriendlyURL=Http.addParameter(layoutFriendlyURL,"doAsUserId",themeDisplay.getDoAsUserId());
      }
      return layoutFriendlyURL;
    }
  }
  String layoutURL=getLayoutActualURL(layout);
  if (doAsUser && Validator.isNotNull(themeDisplay.getDoAsUserId())) {
    layoutURL=Http.addParameter(layoutURL,"doAsUserId",themeDisplay.getDoAsUserId());
  }
  return layoutURL;
}
