{
  StringMaker layoutFriendlyURL=new StringMaker();
  if (!layout.getType().equals(LayoutImpl.TYPE_URL)) {
    layoutFriendlyURL.append(getLayoutFriendlyURL(layout,themeDisplay));
    if (layoutFriendlyURL.length() > 0) {
      boolean queryAdded=false;
      if (doAsUser && Validator.isNotNull(themeDisplay.getDoAsUserId())) {
        layoutFriendlyURL.append("?doAsUserId=");
        layoutFriendlyURL.append(themeDisplay.getDoAsUserId());
        queryAdded=true;
      }
      if (resetParams) {
        if (!queryAdded) {
          layoutFriendlyURL.append("?");
        }
        layoutFriendlyURL.append("p_l_reset=1");
        queryAdded=true;
      }
      return layoutFriendlyURL.toString();
    }
  }
  String layoutURL=getLayoutActualURL(layout);
  if (doAsUser && Validator.isNotNull(themeDisplay.getDoAsUserId())) {
    layoutURL=Http.addParameter(layoutURL,"doAsUserId",themeDisplay.getDoAsUserId());
  }
  if (resetParams) {
    layoutURL=Http.addParameter(layoutURL,"p_l_reset",1);
  }
  return layoutURL;
}
