{
  User user=userPersistence.findByPrimaryKey(userId);
  validate(nameMap,ddmFormValues);
  long dataProviderInstanceId=counterLocalService.increment();
  DDMDataProviderInstance dataProviderInstance=ddmDataProviderInstancePersistence.create(dataProviderInstanceId);
  dataProviderInstance.setUuid(serviceContext.getUuid());
  dataProviderInstance.setGroupId(groupId);
  dataProviderInstance.setCompanyId(user.getCompanyId());
  dataProviderInstance.setUserId(user.getUserId());
  dataProviderInstance.setUserName(user.getFullName());
  dataProviderInstance.setNameMap(nameMap);
  dataProviderInstance.setDescriptionMap(descriptionMap);
  dataProviderInstance.setDefinition(ddmFormValuesJSONSerializer.serialize(ddmFormValues));
  dataProviderInstance.setType(type);
  ddmDataProviderInstancePersistence.update(dataProviderInstance);
  if (serviceContext.isAddGroupPermissions() || serviceContext.isAddGuestPermissions()) {
    addDataProviderInstanceResources(dataProviderInstance,serviceContext.isAddGroupPermissions(),serviceContext.isAddGuestPermissions());
  }
 else {
    addDataProviderInstanceResources(dataProviderInstance,serviceContext.getModelPermissions());
  }
  return dataProviderInstance;
}
