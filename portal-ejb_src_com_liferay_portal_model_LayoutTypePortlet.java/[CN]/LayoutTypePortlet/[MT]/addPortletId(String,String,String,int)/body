{
  Portlet portlet=null;
  try {
    portlet=PortletServiceUtil.getPortletById(getLayout().getCompanyId(),portletId);
    if (!portlet.hasAddPortletPermission(userId)) {
      return null;
    }
  }
 catch (  Exception e) {
    _log.error(e);
  }
  if (portlet != null) {
    if (portlet.isSystem()) {
      return null;
    }
    if ((portlet.isInstanceable()) && (Portlet.getInstanceId(portlet.getPortletId()) == null)) {
      portletId=portletId + getFullInstanceSeparator();
    }
    if (columnId == null) {
      LayoutTemplate layoutTemplate=getLayoutTemplate();
      List columns=layoutTemplate.getColumns();
      if (columns.size() > 0) {
        columnId=(String)columns.get(0);
      }
    }
    if (columnId != null) {
      String columnValue=getTypeSettingsProperties().getProperty(columnId);
      if (columnPos >= 0) {
        List portletIds=ListUtil.fromArray(StringUtil.split(columnValue));
        if (columnPos <= portletIds.size()) {
          portletIds.add(columnPos,portletId);
          columnValue=StringUtil.merge(portletIds);
        }
      }
 else {
        columnValue=StringUtil.add(columnValue,portletId);
      }
      getTypeSettingsProperties().setProperty(columnId,columnValue);
    }
    return portletId;
  }
 else {
    return null;
  }
}
