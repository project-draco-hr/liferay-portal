{
  InputStream inputStream=null;
  String returnValue=null;
  try {
    ServletFileUpload servletFileUpload=new LiferayFileUpload(new LiferayFileItemFactory(UploadServletRequestImpl.getTempDir()),request);
    servletFileUpload.setFileSizeMax(PrefsPropsUtil.getLong(PropsKeys.UPLOAD_SERVLET_REQUEST_IMPL_MAX_SIZE));
    LiferayServletRequest liferayServletRequest=new LiferayServletRequest(request);
    List<FileItem> fileItems=servletFileUpload.parseRequest(liferayServletRequest);
    Map<String,Object> fields=new HashMap<String,Object>();
    for (    FileItem fileItem : fileItems) {
      if (fileItem.isFormField()) {
        fields.put(fileItem.getFieldName(),fileItem.getString());
      }
 else {
        fields.put(fileItem.getFieldName(),fileItem);
      }
    }
    DiskFileItem diskFileItem=(DiskFileItem)fields.get("NewFile");
    String fileName=StringUtil.replace(diskFileItem.getName(),CharPool.BACK_SLASH,CharPool.SLASH);
    String[] fileNameArray=StringUtil.split(fileName,'/');
    fileName=fileNameArray[fileNameArray.length - 1];
    String contentType=diskFileItem.getContentType();
    if (Validator.isNull(contentType) || contentType.equals(ContentTypes.APPLICATION_OCTET_STREAM)) {
      contentType=MimeTypesUtil.getContentType(diskFileItem.getStoreLocation());
    }
    if (diskFileItem.isInMemory()) {
      inputStream=diskFileItem.getInputStream();
    }
 else {
      inputStream=new ByteArrayFileInputStream(diskFileItem.getStoreLocation(),LiferayFileItem.THRESHOLD_SIZE);
    }
    long size=diskFileItem.getSize();
    returnValue=fileUpload(commandArgument,fileName,inputStream,contentType,size);
  }
 catch (  Exception e) {
    if (_log.isDebugEnabled()) {
      _log.debug(e,e);
    }
    FCKException fcke=null;
    if (e instanceof FCKException) {
      fcke=(FCKException)e;
    }
 else {
      fcke=new FCKException(e);
    }
    Throwable cause=fcke.getCause();
    returnValue="203";
    if (cause != null) {
      String causeString=GetterUtil.getString(cause.toString());
      if (causeString.contains("DuplicateFileException")) {
        returnValue="201";
      }
 else       if (causeString.contains("NoSuchFolderException") || causeString.contains("NoSuchGroupException")) {
        returnValue="204";
      }
 else       if (causeString.contains("ImageNameException")) {
        returnValue="205";
      }
 else       if (causeString.contains("FileExtensionException") || causeString.contains("FileNameException")) {
        returnValue="206";
      }
 else       if (causeString.contains("PrincipalException")) {
        returnValue="207";
      }
 else       if (causeString.contains("ImageSizeException") || causeString.contains("FileSizeException")) {
        returnValue="208";
      }
 else       if (causeString.contains("SystemException")) {
        returnValue="209";
      }
 else       if (causeString.contains("AssetCategoryException")) {
        returnValue="210";
      }
 else       if (causeString.contains("AntivirusScannerException")) {
        returnValue="211";
      }
 else {
        throw fcke;
      }
    }
    _writeUploadResponse(returnValue,response);
  }
 finally {
    StreamUtil.cleanUp(inputStream);
  }
  _writeUploadResponse(returnValue,response);
}
