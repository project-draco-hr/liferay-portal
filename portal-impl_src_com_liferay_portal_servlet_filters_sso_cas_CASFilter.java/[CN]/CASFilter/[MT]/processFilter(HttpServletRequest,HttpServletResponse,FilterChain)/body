{
  HttpSession session=request.getSession();
  long companyId=PortalUtil.getCompanyId(request);
  String pathInfo=request.getPathInfo();
  if (session.getAttribute(CASAutoLogin.FIRST_TIME_WITH_NO_SUCH_USER) != null) {
    session.removeAttribute(CASAutoLogin.FIRST_TIME_WITH_NO_SUCH_USER);
    String logoutUrl=PrefsPropsUtil.getString(companyId,PropsKeys.CAS_LOGOUT_URL,PropsValues.CAS_LOGOUT_URL);
    response.sendRedirect(logoutUrl);
    return;
  }
  if (pathInfo.indexOf("/portal/logout") != -1) {
    session.invalidate();
    String logoutUrl=PrefsPropsUtil.getString(companyId,PropsKeys.CAS_LOGOUT_URL,PropsValues.CAS_LOGOUT_URL);
    response.sendRedirect(logoutUrl);
    return;
  }
 else {
    String login=(String)session.getAttribute(LOGIN);
    String serverName=PrefsPropsUtil.getString(companyId,PropsKeys.CAS_SERVER_NAME,PropsValues.CAS_SERVER_NAME);
    String serviceUrl=PrefsPropsUtil.getString(companyId,PropsKeys.CAS_SERVICE_URL,PropsValues.CAS_SERVICE_URL);
    if (Validator.isNull(serviceUrl)) {
      serviceUrl=CommonUtils.constructServiceUrl(request,response,serviceUrl,serverName,"ticket",false);
    }
    String ticket=ParamUtil.getString(request,"ticket");
    if (Validator.isNull(ticket)) {
      if (Validator.isNotNull(login)) {
        processFilter(CASFilter.class,request,response,filterChain);
      }
 else {
        String loginUrl=PrefsPropsUtil.getString(companyId,PropsKeys.CAS_LOGIN_URL,PropsValues.CAS_LOGIN_URL);
        loginUrl=HttpUtil.addParameter(loginUrl,"service",serviceUrl);
        response.sendRedirect(loginUrl);
      }
      return;
    }
    TicketValidator ticketValidator=getTicketValidator(companyId);
    Assertion assertion=ticketValidator.validate(ticket,serviceUrl);
    if (assertion != null) {
      AttributePrincipal attributePrincipal=assertion.getPrincipal();
      login=attributePrincipal.getName();
      session.setAttribute(LOGIN,login);
    }
  }
  processFilter(CASFilter.class,request,response,filterChain);
}
