{
  long companyId=PortalUtil.getCompanyId(request);
  if (PrefsPropsUtil.getBoolean(companyId,PropsKeys.CAS_AUTH_ENABLED,PropsValues.CAS_AUTH_ENABLED)) {
    HttpSession session=request.getSession();
    String pathInfo=request.getPathInfo();
    if (pathInfo.indexOf("/portal/logout") != -1) {
      session.invalidate();
      String logoutUrl=PrefsPropsUtil.getString(companyId,PropsKeys.CAS_LOGOUT_URL,PropsValues.CAS_LOGOUT_URL);
      response.sendRedirect(logoutUrl);
    }
 else {
      String login=(String)session.getAttribute(LOGIN);
      String loginUrl=PrefsPropsUtil.getString(companyId,PropsKeys.CAS_LOGIN_URL,PropsValues.CAS_LOGIN_URL);
      String serviceUrl=PrefsPropsUtil.getString(companyId,PropsKeys.CAS_SERVICE_URL,PropsValues.CAS_SERVICE_URL);
      String ticket=request.getParameter(CAS_TICKET_PARAMETER);
      if (Validator.isNull(ticket)) {
        if (Validator.isNotNull(login)) {
          processFilter(CASFilter.class,request,response,filterChain);
        }
 else {
          loginUrl=HttpUtil.addParameter(loginUrl,CAS_SERVICE_PARAMETER,serviceUrl);
          response.sendRedirect(loginUrl);
        }
        return;
      }
      TicketValidator validator=getCASTicketValidator(companyId);
      Assertion assertion=validator.validate(ticket,serviceUrl);
      if (assertion != null) {
        AttributePrincipal attributePrincipal=assertion.getPrincipal();
        login=attributePrincipal.getName();
        session.setAttribute(LOGIN,login);
      }
    }
  }
  processFilter(CASFilter.class,request,response,filterChain);
}
