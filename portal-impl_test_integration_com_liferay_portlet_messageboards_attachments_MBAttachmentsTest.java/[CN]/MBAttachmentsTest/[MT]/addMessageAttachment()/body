{
  if (_message == null) {
    if (_category == null) {
      addCategory();
    }
    if (_group == null) {
      _group=GroupTestUtil.addGroup();
    }
    ServiceContext serviceContext=ServiceTestUtil.getServiceContext(_group.getGroupId());
    User user=TestPropsValues.getUser();
    List<ObjectValuePair<String,InputStream>> objectValuePairs=MBTestUtil.getInputStreamOVPs("company_logo.png",getClass(),StringPool.BLANK);
    _message=MBMessageLocalServiceUtil.addMessage(user.getUserId(),user.getFullName(),_group.getGroupId(),MBCategoryConstants.DEFAULT_PARENT_CATEGORY_ID,"Subject","Body",MBMessageConstants.DEFAULT_FORMAT,objectValuePairs,false,0,false,serviceContext);
  }
 else {
    ServiceContext serviceContext=ServiceTestUtil.getServiceContext(_group.getGroupId());
    User user=TestPropsValues.getUser();
    List<ObjectValuePair<String,InputStream>> objectValuePairs=MBTestUtil.getInputStreamOVPs("OSX_Test.docx",getClass(),StringPool.BLANK);
    List<FileEntry> fileEntries=_message.getAttachmentsFileEntries();
    List<String> existingFiles=new ArrayList<String>();
    for (    FileEntry fileEntry : fileEntries) {
      existingFiles.add(String.valueOf(fileEntry.getFileEntryId()));
    }
    _message=MBMessageLocalServiceUtil.updateMessage(user.getUserId(),_message.getMessageId(),"Subject","Body",objectValuePairs,existingFiles,0,false,serviceContext);
  }
}
