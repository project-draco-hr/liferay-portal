{
  Group group=themeDisplay.getScopeGroup();
  List<Portlet> filteredPortlets=new ArrayList<Portlet>();
  if (category.equals(PortletCategoryKeys.CONTENT) && group.isLayout()) {
    for (    Portlet portlet : portlets) {
      if (portlet.isScopeable()) {
        filteredPortlets.add(portlet);
      }
    }
  }
 else {
    filteredPortlets.addAll(portlets);
  }
  Iterator<Portlet> itr=filteredPortlets.iterator();
  while (itr.hasNext()) {
    Portlet portlet=itr.next();
    try {
      ControlPanelEntry controlPanelEntry=portlet.getControlPanelEntryInstance();
      if (controlPanelEntry == null) {
        controlPanelEntry=DefaultControlPanelEntryFactory.getInstance();
      }
      if (!controlPanelEntry.isVisible(portlet,category,themeDisplay)) {
        itr.remove();
      }
    }
 catch (    Exception e) {
      _log.error(e,e);
      itr.remove();
    }
  }
  return filteredPortlets;
}
