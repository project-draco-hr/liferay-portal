{
  LayoutSet layoutSet=LayoutSetLocalServiceUtil.getLayoutSet(group.getGroupId(),privateLayoutSet);
  String portalURL=StringPool.BLANK;
  if (!themeDisplay.getServerName().equals(_LOCALHOST)) {
    String virtualHostname=layoutSet.getVirtualHostname();
    if (Validator.isNull(virtualHostname) && Validator.isNotNull(PropsValues.VIRTUAL_HOSTS_DEFAULT_SITE_NAME) && !layoutSet.isPrivateLayout()) {
      try {
        Group defaultGroup=GroupLocalServiceUtil.getGroup(themeDisplay.getCompanyId(),PropsValues.VIRTUAL_HOSTS_DEFAULT_SITE_NAME);
        if (layoutSet.getGroupId() == defaultGroup.getGroupId()) {
          Company company=themeDisplay.getCompany();
          virtualHostname=company.getVirtualHostname();
        }
      }
 catch (      Exception e) {
        _log.error(e,e);
      }
    }
    if (Validator.isNotNull(virtualHostname) && !virtualHostname.equalsIgnoreCase(_LOCALHOST)) {
      virtualHostname=getPortalURL(virtualHostname,themeDisplay.getServerPort(),themeDisplay.isSecure());
      String portalDomain=HttpUtil.getDomain(themeDisplay.getPortalURL());
      if (virtualHostname.contains(portalDomain)) {
        String path=StringPool.BLANK;
        if (themeDisplay.isWidget()) {
          path=PropsValues.WIDGET_SERVLET_MAPPING;
        }
        if (themeDisplay.isI18n()) {
          path=themeDisplay.getI18nPath();
        }
        return virtualHostname.concat(_pathContext).concat(path);
      }
    }
 else {
      Layout curLayout=themeDisplay.getLayout();
      LayoutSet curLayoutSet=curLayout.getLayoutSet();
      if ((layoutSet.getLayoutSetId() != curLayoutSet.getLayoutSetId()) && (group.getClassPK() != themeDisplay.getUserId())) {
        Company company=themeDisplay.getCompany();
        virtualHostname=company.getVirtualHostname();
        if (!virtualHostname.equalsIgnoreCase(_LOCALHOST)) {
          portalURL=getPortalURL(virtualHostname,themeDisplay.getServerPort(),themeDisplay.isSecure());
        }
      }
    }
  }
  String friendlyURL=null;
  if (privateLayoutSet) {
    if (group.isUser()) {
      friendlyURL=_PRIVATE_USER_SERVLET_MAPPING;
    }
 else {
      friendlyURL=_PRIVATE_GROUP_SERVLET_MAPPING;
    }
  }
 else {
    friendlyURL=_PUBLIC_GROUP_SERVLET_MAPPING;
  }
  if (themeDisplay.isWidget()) {
    friendlyURL=PropsValues.WIDGET_SERVLET_MAPPING + friendlyURL;
  }
  if (themeDisplay.isI18n()) {
    friendlyURL=themeDisplay.getI18nPath() + friendlyURL;
  }
  return portalURL + _pathContext + friendlyURL+ group.getFriendlyURL();
}
