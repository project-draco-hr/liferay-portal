{
  DLFileEntryMetadata fileEntryMetadata=dlFileEntryMetadataPersistence.fetchByD_F(ddmStructure.getStructureId(),fileVersionId);
  if (fileEntryMetadata != null) {
    StorageEngineUtil.update(fileEntryMetadata.getDDMStorageId(),fields,true,serviceContext);
  }
 else {
    long fileEntryMetadataId=counterLocalService.increment();
    fileEntryMetadata=dlFileEntryMetadataPersistence.create(fileEntryMetadataId);
    long ddmStorageId=StorageEngineUtil.create(companyId,ddmStructure.getStructureId(),fields,serviceContext);
    fileEntryMetadata.setDDMStorageId(ddmStorageId);
    fileEntryMetadata.setDDMStructureId(ddmStructure.getStructureId());
    fileEntryMetadata.setFileEntryTypeId(fileEntryTypeId);
    fileEntryMetadata.setFileEntryId(fileEntryId);
    fileEntryMetadata.setFileVersionId(fileVersionId);
    dlFileEntryMetadataPersistence.update(fileEntryMetadata);
    long classNameId=classNameLocalService.getClassNameId(DLFileEntryMetadata.class);
    ddmStructureLinkLocalService.addStructureLink(classNameId,fileEntryMetadata.getFileEntryMetadataId(),ddmStructure.getStructureId(),serviceContext);
  }
}
