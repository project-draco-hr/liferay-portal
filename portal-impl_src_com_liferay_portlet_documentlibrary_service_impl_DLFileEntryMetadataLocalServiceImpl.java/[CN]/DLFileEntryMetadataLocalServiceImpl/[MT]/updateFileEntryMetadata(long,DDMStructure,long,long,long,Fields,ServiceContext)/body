{
  DLFileEntryMetadata fileEntryMetadata=dlFileEntryMetadataPersistence.fetchByD_F(ddmStructure.getStructureId(),fileVersionId);
  if (fileEntryMetadata != null) {
    StorageEngineUtil.update(fileEntryMetadata.getDDMStorageId(),fields,serviceContext);
  }
 else {
    long fileEntryMetadataId=counterLocalService.increment();
    fileEntryMetadata=dlFileEntryMetadataPersistence.create(fileEntryMetadataId);
    long ddmStorageId=StorageEngineUtil.create(companyId,ddmStructure.getStructureId(),fields,serviceContext);
    fileEntryMetadata.setDDMStorageId(ddmStorageId);
    fileEntryMetadata.setDDMStructureId(ddmStructure.getStructureId());
    fileEntryMetadata.setFileEntryTypeId(fileEntryTypeId);
    fileEntryMetadata.setFileEntryId(fileEntryId);
    fileEntryMetadata.setFileVersionId(fileVersionId);
    dlFileEntryMetadataPersistence.update(fileEntryMetadata);
    long classNameId=PortalUtil.getClassNameId(DLFileEntryMetadata.class);
    ddmStructureLinkLocalService.addStructureLink(classNameId,fileEntryMetadata.getFileEntryMetadataId(),ddmStructure.getStructureId(),serviceContext);
  }
  try {
    String namespace=String.valueOf(ddmStructure.getStructureId());
    for (    String fieldName : ddmStructure.getFieldNames()) {
      String fieldDataType=ddmStructure.getFieldDataType(fieldName);
      if (fieldDataType.equals(FieldConstants.FILE_UPLOAD)) {
        DDMUtil.uploadFieldFile(fileEntryMetadata.getDDMStructureId(),fileEntryMetadata.getDDMStorageId(),fileEntryMetadata,fieldName,namespace,serviceContext);
      }
    }
  }
 catch (  Exception e) {
  }
}
