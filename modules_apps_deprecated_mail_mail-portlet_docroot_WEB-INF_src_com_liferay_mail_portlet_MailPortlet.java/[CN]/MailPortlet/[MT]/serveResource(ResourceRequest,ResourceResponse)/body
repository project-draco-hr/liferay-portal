{
  String mvcPath=resourceRequest.getParameter("mvcPath");
  if (mvcPath.equals("/attachment.jsp")) {
    HttpServletRequest request=PortalUtil.getHttpServletRequest(resourceRequest);
    long attachmentId=ParamUtil.getLong(resourceRequest,"attachmentId");
    AttachmentHandler attachmentHandler=null;
    try {
      MailManager mailManager=MailManager.getInstance(request);
      Attachment attachment=AttachmentLocalServiceUtil.getAttachment(attachmentId);
      attachmentHandler=mailManager.getAttachment(attachmentId);
      if (attachmentHandler != null) {
        String contentType=MimeTypesUtil.getContentType(attachment.getFileName());
        PortletResponseUtil.sendFile(resourceRequest,resourceResponse,attachment.getFileName(),attachmentHandler.getInputStream(),contentType);
      }
    }
 catch (    Exception e) {
      _log.error(e,e);
    }
 finally {
      attachmentHandler.cleanUp();
    }
  }
 else {
    super.serveResource(resourceRequest,resourceResponse);
  }
}
