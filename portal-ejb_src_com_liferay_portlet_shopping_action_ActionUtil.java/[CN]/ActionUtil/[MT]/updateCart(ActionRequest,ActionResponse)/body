{
  PortletSession ses=req.getPortletSession();
  String companyId=PortalUtil.getCompanyId(req);
  String cmd=ParamUtil.getString(req,"shopping_" + Constants.CMD);
  ShoppingCart cart=ShoppingCartServiceUtil.getCart(ses.getId(),companyId);
  if (cmd.equals(Constants.ADD)) {
    String itemId=ParamUtil.getString(req,"item_id");
    String fields=ParamUtil.getString(req,"item_fields");
    if (Validator.isNotNull(fields)) {
      fields="|" + fields;
    }
    ShoppingItem item=ShoppingItemServiceUtil.getItemById(itemId);
    if (item.getMinQuantity() > 0) {
      for (int i=0; i < item.getMinQuantity(); i++) {
        cart.addItemId(itemId,fields);
      }
    }
 else {
      cart.addItemId(itemId,fields);
    }
  }
 else   if (cmd.equals(Constants.SAVE) || cmd.equals(Constants.UPDATE)) {
    String itemIds=ParamUtil.getString(req,"item_ids");
    String couponIds=ParamUtil.getString(req,"coupon_ids");
    int altShipping=ParamUtil.getInteger(req,"alt_shipping");
    boolean insure=ParamUtil.getBoolean(req,"insure");
    cart.setItemIds(itemIds);
    cart.setCouponIds(couponIds);
    cart.setAltShipping(altShipping);
    cart.setInsure(insure);
  }
  ShoppingCartServiceUtil.updateCart(ses.getId(),companyId,cart.getItemIds(),cart.getCouponIds(),cart.getAltShipping(),cart.isInsure());
  SessionMessages.add(req,"cart_updated");
}
