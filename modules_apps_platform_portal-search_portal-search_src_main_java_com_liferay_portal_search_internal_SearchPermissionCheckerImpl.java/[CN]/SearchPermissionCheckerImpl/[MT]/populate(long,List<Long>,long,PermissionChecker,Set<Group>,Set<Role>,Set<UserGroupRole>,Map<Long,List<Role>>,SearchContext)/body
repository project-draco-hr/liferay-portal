{
  UserBag userBag=permissionChecker.getUserBag();
  if (permissionChecker.isSignedIn()) {
    roles.addAll(userBag.getRoles());
    roles.add(_roleLocalService.getRole(companyId,RoleConstants.GUEST));
  }
 else {
    Group guestGroup=_groupLocalService.getGroup(companyId,GroupConstants.GUEST);
    roles.addAll(_roleLocalService.getUserRelatedRoles(userId,Collections.singletonList(guestGroup)));
  }
  long searchContextGroupId=GetterUtil.getLong(searchContext.getAttribute("groupId"));
  if ((searchContextGroupId == 0) && _searchPermissionCheckerConfiguration.includeInheritedPermissions()) {
    List<Group> usersGroups=_groupLocalService.getUserGroups(userId,true);
    groups.addAll(usersGroups);
    for (    Group group : groups) {
      if (!groupIds.contains(group.getGroupId())) {
        groupIds.add(group.getGroupId());
      }
    }
  }
  if (ListUtil.isEmpty(groupIds)) {
    groups.addAll(_groupLocalService.getUserGroups(userId,true));
    groups.addAll(userBag.getGroups());
    userGroupRoles.addAll(_userGroupRoleLocalService.getUserGroupRoles(userId));
  }
 else {
    for (    long groupId : groupIds) {
      if (_groupLocalService.hasUserGroup(userId,groupId)) {
        Group group=_groupLocalService.getGroup(groupId);
        groups.add(group);
      }
      userGroupRoles.addAll(_userGroupRoleLocalService.getUserGroupRoles(userId,groupId));
      userGroupRoles.addAll(_userGroupRoleLocalService.getUserGroupRolesByUserUserGroupAndGroup(userId,groupId));
    }
  }
  if (permissionChecker.isSignedIn()) {
    roles.add(_roleLocalService.getRole(companyId,RoleConstants.GUEST));
  }
  for (  Group group : groups) {
    long[] roleIds=permissionChecker.getRoleIds(userId,group.getGroupId());
    List<Role> groupRoles=_roleLocalService.getRoles(roleIds);
    groupIdsToRoles.put(group.getGroupId(),groupRoles);
    roles.addAll(groupRoles);
  }
}
