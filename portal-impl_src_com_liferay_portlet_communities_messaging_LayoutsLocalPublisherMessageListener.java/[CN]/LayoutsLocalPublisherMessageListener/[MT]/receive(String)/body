{
  PermissionCheckerImpl permissionChecker=null;
  try {
    LayoutsLocalPublisherRequest publisherRequest=(LayoutsLocalPublisherRequest)JSONUtil.deserialize(message);
    String command=publisherRequest.getCommand();
    long userId=publisherRequest.getUserId();
    long sourceGroupId=publisherRequest.getSourceGroupId();
    long targetGroupId=publisherRequest.getTargetGroupId();
    boolean privateLayout=publisherRequest.isPrivateLayout();
    Map<Long,Boolean> layoutIdMap=publisherRequest.getLayoutIdMap();
    Map<String,String[]> parameterMap=publisherRequest.getParameterMap();
    PrincipalThreadLocal.setName(userId);
    User user=UserLocalServiceUtil.getUserById(userId);
    permissionChecker=PermissionCheckerFactory.create(user,false);
    PermissionThreadLocal.setPermissionChecker(permissionChecker);
    if (command.equals(LayoutsLocalPublisherRequest.COMMAND_ALL_PAGES)) {
      StagingUtil.publishLayouts(sourceGroupId,targetGroupId,privateLayout,parameterMap);
    }
 else     if (command.equals(LayoutsLocalPublisherRequest.COMMAND_SELECTED_PAGES)) {
      StagingUtil.publishLayouts(sourceGroupId,targetGroupId,privateLayout,layoutIdMap,parameterMap);
    }
  }
 catch (  Exception e) {
    _log.error(e,e);
  }
 finally {
    try {
      PermissionCheckerFactory.recycle(permissionChecker);
    }
 catch (    Exception e) {
    }
  }
}
