{
  try {
    HttpServletRequest req=(HttpServletRequest)pageContext.getRequest();
    if (portletName == null) {
      PortletConfigImpl portletConfig=(PortletConfigImpl)req.getAttribute(WebKeys.JAVAX_PORTLET_CONFIG);
      portletName=portletConfig.getPortletId();
    }
    RenderResponseImpl renderResponse=(RenderResponseImpl)req.getAttribute(WebKeys.JAVAX_PORTLET_RESPONSE);
    if (renderResponse == null) {
      _log.error("Render response is null because this tag is not being " + "called within the context of a portlet");
      return StringPool.BLANK;
    }
    PortletURLImpl portletURL=null;
    if (action) {
      portletURL=(PortletURLImpl)renderResponse.createActionURL(portletName);
    }
 else {
      portletURL=(PortletURLImpl)renderResponse.createRenderURL(portletName);
    }
    if (Validator.isNotNull(windowState)) {
      portletURL.setWindowState(new WindowState(windowState));
    }
    if (Validator.isNotNull(portletMode)) {
      portletURL.setPortletMode(new PortletMode(portletMode));
    }
    if (secure != null) {
      portletURL.setSecure(secure.booleanValue());
    }
 else {
      portletURL.setSecure(req.isSecure());
    }
    if (anchor != null) {
      portletURL.setAnchor(anchor.booleanValue());
    }
    if (encrypt != null) {
      portletURL.setEncrypt(encrypt.booleanValue());
    }
    if (doAsUserId > 0) {
      portletURL.setDoAsUserId(doAsUserId);
    }
    if ((portletConfiguration != null) && portletConfiguration.booleanValue()) {
      String portletResource=ParamUtil.getString(req,"portletResource");
      String previewWidth=ParamUtil.getString(req,"previewWidth");
      portletURL.setParameter("struts_action","/portlet_configuration/edit_configuration");
      portletURL.setParameter("portletResource",portletResource);
      portletURL.setParameter("previewWidth",previewWidth);
    }
    if (params != null) {
      MapUtil.merge(portletURL.getParameterMap(),params);
      portletURL.setParameters(params);
    }
    if (Validator.isNotNull(var)) {
      pageContext.setAttribute(var,portletURL.toString());
    }
 else     if (Validator.isNotNull(varImpl)) {
      pageContext.setAttribute(varImpl,portletURL);
    }
 else     if (writeOutput) {
      pageContext.getOut().print(portletURL.toString());
    }
    return portletURL.toString();
  }
 catch (  Exception e) {
    _log.error(e,e);
    throw new JspException(e);
  }
}
