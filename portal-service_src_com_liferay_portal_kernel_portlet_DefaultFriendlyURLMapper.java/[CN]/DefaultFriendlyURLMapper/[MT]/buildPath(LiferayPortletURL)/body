{
  Map<String,String[]> portletURLParameters=portletURL.getParameterMap();
  Map<String,String[]> parameters=new HashMap<String,String[]>(portletURLParameters);
  WindowState windowState=portletURL.getWindowState();
  parameters.put("p_p_state",new String[]{String.valueOf(windowState)});
  parameters.put("p_p_lifecycle",new String[]{getLifecycle(portletURL)});
  if (isPortletInstanceable()) {
    String portletId=portletURL.getPortletId();
    parameters.put("p_p_id",new String[]{portletId});
    if (Validator.isNotNull(portletId)) {
      String[] parts=portletId.split(PortletConstants.INSTANCE_SEPARATOR);
      if (parts.length > 1) {
        String instanceId=parts[1];
        parameters.put("instanceId",new String[]{instanceId});
      }
    }
  }
  String friendlyURLPath=router.parametersToUrl(parameters);
  if (friendlyURLPath == null) {
    return null;
  }
  for (  String name : portletURLParameters.keySet()) {
    if (!parameters.containsKey(name)) {
      portletURL.addParameterIncludedInPath(name);
    }
  }
  portletURL.addParameterIncludedInPath("p_p_id");
  friendlyURLPath=StringPool.SLASH.concat(getMapping()).concat(friendlyURLPath);
  return friendlyURLPath;
}
