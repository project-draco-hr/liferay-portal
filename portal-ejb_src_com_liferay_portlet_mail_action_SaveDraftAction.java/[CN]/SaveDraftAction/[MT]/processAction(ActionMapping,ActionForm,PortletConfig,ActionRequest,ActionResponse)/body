{
  try {
    PortletSession ses=req.getPortletSession();
    String to=req.getParameter("msg_to");
    String subject=req.getParameter("msg_sub");
    String cc=req.getParameter("msg_cc");
    String bcc=req.getParameter("msg_bcc");
    String body=req.getParameter("msg_body");
    Message msg=(Message)ses.getAttribute(WebKeys.MAIL_MESSAGE,PortletSession.APPLICATION_SCOPE);
    User user=PortalUtil.getUser(req);
    MailAccount account=MailAccounts.getCurrentAccount(req);
    msg.setFrom(new InternetAddress(account.getEmailAddress(),user.getFirstName() + " " + user.getLastName()));
    msg.setRecipients(Message.RecipientType.TO,MailUtil.parseAddresses(req,to));
    msg.setSubject(subject);
    if (cc != null) {
      msg.setRecipients(Message.RecipientType.CC,MailUtil.parseAddresses(req,cc));
    }
    if (bcc != null) {
      msg.setRecipients(Message.RecipientType.BCC,MailUtil.parseAddresses(req,bcc));
    }
    msg.setSentDate(new Date());
    MimeBodyPart bodyPart=new MimeBodyPart();
    bodyPart.setText(body);
    Multipart multipart=(Multipart)msg.getContent();
    multipart.removeBodyPart(0);
    multipart.addBodyPart(bodyPart,0);
    Folder folder=MailUtil.getFolder(req,MailUtil.MAIL_BOX_STYLE + MailUtil.MAIL_DRAFTS_NAME);
    String[] liferayDraftIdArray=msg.getHeader("liferay-draft-id");
    String liferayDraftId=null;
    if ((liferayDraftIdArray != null) && (liferayDraftIdArray.length > 0)) {
      liferayDraftId=liferayDraftIdArray[0];
      Message oldDraftMsg=null;
      Message[] messages=folder.getMessages();
      for (int i=0; i < messages.length; i++) {
        String[] curLiferayDraftIdArray=messages[i].getHeader("liferay-draft-id");
        if ((curLiferayDraftIdArray != null) && (curLiferayDraftIdArray.length > 0)) {
          String curLiferayDraftId=curLiferayDraftIdArray[0];
          if (liferayDraftId.equals(curLiferayDraftId)) {
            oldDraftMsg=messages[i];
            break;
          }
        }
      }
      if (oldDraftMsg != null) {
        folder.setFlags(new Message[]{oldDraftMsg},new Flags(Flags.Flag.DELETED),true);
        folder.expunge();
      }
    }
    if (liferayDraftId == null) {
      liferayDraftId=PwdGenerator.getPassword(PwdGenerator.KEY1 + PwdGenerator.KEY2,6);
      msg.addHeader("liferay-draft-id",liferayDraftId);
    }
    folder.appendMessages(new Message[]{msg});
    ses.removeAttribute(WebKeys.MAIL_MESSAGE,PortletSession.APPLICATION_SCOPE);
    ses.removeAttribute(WebKeys.MAIL_MESSAGE_MODEL,PortletSession.APPLICATION_SCOPE);
    res.sendRedirect(ParamUtil.getString(req,"redirect"));
  }
 catch (  Exception e) {
    req.setAttribute(PageContext.EXCEPTION,e);
    setForward(req,Constants.COMMON_ERROR);
  }
}
