{
  ServiceReference<ConfigurationAdmin> serviceReference=bundleContext.getServiceReference(ConfigurationAdmin.class);
  try {
    ConfigurationAdmin configurationAdmin=bundleContext.getService(serviceReference);
    Configuration jcrConfiguration=configurationAdmin.getConfiguration("com.liferay.portal.store.jcr.configuration." + "JCRStoreConfiguration",null);
    Dictionary<String,Object> properties=new Hashtable<>();
    properties.put("initializeOnStartup",Boolean.TRUE);
    properties.put("jackrabbitConfigFilePath","repository.xml");
    properties.put("jackrabbitCredentialsPassword","none");
    properties.put("jackrabbitCredentialsUsername","none");
    properties.put("jackrabbitRepositoryHome","home");
    properties.put("jackrabbitRepositoryRoot","data/jackrabbit");
    properties.put("moveVersionLabels",Boolean.FALSE);
    properties.put("nodeDocumentlibrary","documentlibrary");
    properties.put("workspaceName","liferay");
    properties.put("wrapSession",Boolean.TRUE);
    jcrConfiguration.update(properties);
    Filter filter=bundleContext.createFilter("(&(objectClass=" + Store.class.getName() + ")(store.type=com.liferay.portal.store.jcr.JCRStore))");
    ServiceTracker<?,?> serviceTracker=new ServiceTracker<>(bundleContext,filter,null);
    serviceTracker.open();
    Object jcrStore=serviceTracker.waitForService(10000);
    serviceTracker.close();
    if (jcrStore == null) {
      jcrConfiguration.delete();
      throw new IllegalStateException("JCR store was not registered within 10 seconds");
    }
  }
  finally {
    bundleContext.ungetService(serviceReference);
  }
}
