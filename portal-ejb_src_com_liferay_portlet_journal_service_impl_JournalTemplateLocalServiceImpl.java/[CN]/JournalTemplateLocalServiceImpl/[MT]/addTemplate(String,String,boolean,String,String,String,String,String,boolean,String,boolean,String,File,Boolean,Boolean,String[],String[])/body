{
  User user=UserUtil.findByPrimaryKey(userId);
  templateId=templateId.trim().toUpperCase();
  String groupId=PortalUtil.getPortletGroupId(plid);
  Date now=new Date();
  try {
    if (formatXsl) {
      if (langType.equals(JournalTemplateImpl.LANG_TYPE_VM)) {
        xsl=JournalUtil.formatVM(xsl);
      }
 else {
        xsl=JournalUtil.formatXML(xsl);
      }
    }
  }
 catch (  DocumentException de) {
    throw new TemplateXslException();
  }
catch (  IOException ioe) {
    throw new TemplateXslException();
  }
  byte[] smallBytes=null;
  try {
    smallBytes=FileUtil.getBytes(smallFile);
  }
 catch (  IOException ioe) {
  }
  validate(user.getCompanyId(),groupId,templateId,autoTemplateId,name,description,xsl,smallImage,smallImageURL,smallFile,smallBytes);
  if (autoTemplateId) {
    templateId=Long.toString(CounterLocalServiceUtil.increment(JournalTemplate.class.getName() + "." + user.getCompanyId()));
  }
  JournalTemplatePK pk=new JournalTemplatePK(user.getCompanyId(),groupId,templateId);
  JournalTemplate template=JournalTemplateUtil.create(pk);
  template.setGroupId(groupId);
  template.setCompanyId(user.getCompanyId());
  template.setUserId(user.getUserId());
  template.setUserName(user.getFullName());
  template.setCreateDate(now);
  template.setModifiedDate(now);
  template.setStructureId(structureId);
  template.setName(name);
  template.setDescription(description);
  template.setXsl(xsl);
  template.setLangType(langType);
  template.setSmallImage(smallImage);
  template.setSmallImageURL(smallImageURL);
  JournalTemplateUtil.update(template);
  saveImages(smallImage,template.getSmallImageId(),smallFile,smallBytes);
  if ((addCommunityPermissions != null) && (addGuestPermissions != null)) {
    addTemplateResources(template,addCommunityPermissions.booleanValue(),addGuestPermissions.booleanValue());
  }
 else {
    addTemplateResources(template,communityPermissions,guestPermissions);
  }
  return template;
}
