{
  MBMessage rootMessage=mbMessagePersistence.findByPrimaryKey(thread.getRootMessageId());
  Indexer indexer=IndexerRegistryUtil.getIndexer(MBMessage.class);
  indexer.delete(thread);
  long companyId=rootMessage.getCompanyId();
  String portletId=CompanyConstants.SYSTEM_STRING;
  long repositoryId=CompanyConstants.SYSTEM;
  String dirName=thread.getAttachmentsDir();
  try {
    dlService.deleteDirectory(companyId,portletId,repositoryId,dirName);
  }
 catch (  NoSuchDirectoryException nsde) {
  }
  List<MBMessage> messages=mbMessagePersistence.findByThreadId(thread.getThreadId());
  for (  MBMessage message : messages) {
    socialActivityLocalService.deleteActivities(MBMessage.class.getName(),message.getMessageId());
    ratingsStatsLocalService.deleteStats(MBMessage.class.getName(),message.getMessageId());
    assetEntryLocalService.deleteEntry(MBMessage.class.getName(),message.getMessageId());
    if (!message.isDiscussion()) {
      mbStatsUserLocalService.updateStatsUser(message.getGroupId(),message.getUserId());
    }
    mbMessageFlagPersistence.removeByMessageId(message.getMessageId());
    if (!message.isDiscussion()) {
      resourceLocalService.deleteResource(message.getCompanyId(),MBMessage.class.getName(),ResourceConstants.SCOPE_INDIVIDUAL,message.getMessageId());
    }
    mbMessagePersistence.remove(message);
    workflowInstanceLinkLocalService.deleteWorkflowInstanceLink(message.getCompanyId(),message.getGroupId(),message.getWorkflowClassName(),message.getMessageId());
  }
  if (MBUtil.isRegularCategoryId(rootMessage.getCategoryId())) {
    MBCategory category=mbCategoryPersistence.findByPrimaryKey(thread.getCategoryId());
    category.setThreadCount(category.getThreadCount() - 1);
    category.setMessageCount(category.getMessageCount() - messages.size());
    mbCategoryPersistence.update(category,false);
  }
  mbThreadPersistence.remove(thread);
}
