{
  MBCategory category=mbCategoryPersistence.findByPrimaryKey(thread.getCategoryId());
  MBMessage rootMessage=mbMessagePersistence.findByPrimaryKey(thread.getRootMessageId());
  try {
    MBIndexer.deleteMessages(rootMessage.getCompanyId(),thread.getThreadId());
  }
 catch (  SearchException se) {
    _log.error("Deleting index " + thread.getThreadId(),se);
  }
  long companyId=rootMessage.getCompanyId();
  String portletId=CompanyConstants.SYSTEM_STRING;
  long repositoryId=CompanyConstants.SYSTEM;
  String dirName=thread.getAttachmentsDir();
  try {
    dlService.deleteDirectory(companyId,portletId,repositoryId,dirName);
  }
 catch (  NoSuchDirectoryException nsde) {
  }
  List<MBMessage> messages=mbMessagePersistence.findByThreadId(thread.getThreadId());
  for (  MBMessage message : messages) {
    socialActivityLocalService.deleteActivities(MBMessage.class.getName(),message.getMessageId());
    ratingsStatsLocalService.deleteStats(MBMessage.class.getName(),message.getMessageId());
    assetEntryLocalService.deleteEntry(MBMessage.class.getName(),message.getMessageId());
    if (!message.isDiscussion()) {
      mbStatsUserLocalService.updateStatsUser(message.getGroupId(),message.getUserId());
    }
    mbMessageFlagPersistence.removeByMessageId(message.getMessageId());
    if (!message.isDiscussion()) {
      resourceLocalService.deleteResource(message.getCompanyId(),MBMessage.class.getName(),ResourceConstants.SCOPE_INDIVIDUAL,message.getMessageId());
    }
    mbMessagePersistence.remove(message);
  }
  category.setThreadCount(category.getThreadCount() - 1);
  category.setMessageCount(category.getMessageCount() - messages.size());
  mbCategoryPersistence.update(category,false);
  mbThreadPersistence.remove(thread);
}
