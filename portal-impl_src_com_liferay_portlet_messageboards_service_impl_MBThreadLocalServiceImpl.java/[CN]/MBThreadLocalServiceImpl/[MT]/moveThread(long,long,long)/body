{
  MBThread thread=mbThreadPersistence.findByPrimaryKey(threadId);
  long oldCategoryId=thread.getCategoryId();
  MBCategory oldCategory=mbCategoryPersistence.findByPrimaryKey(oldCategoryId);
  MBCategory category=mbCategoryPersistence.findByPrimaryKey(categoryId);
  List<MBMessage> messages=mbMessagePersistence.findByG_C_T(groupId,oldCategoryId,thread.getThreadId());
  for (  MBMessage message : messages) {
    message.setCategoryId(category.getCategoryId());
    mbMessagePersistence.update(message,false);
    if (!message.isDiscussion()) {
      Indexer indexer=IndexerRegistryUtil.getIndexer(MBMessage.class);
      indexer.reindex(message);
    }
  }
  thread.setCategoryId(category.getCategoryId());
  mbThreadPersistence.update(thread,false);
  oldCategory.setThreadCount(oldCategory.getThreadCount() - 1);
  oldCategory.setMessageCount(oldCategory.getMessageCount() - messages.size());
  mbCategoryPersistence.update(oldCategory,false);
  category.setThreadCount(category.getThreadCount() + 1);
  category.setMessageCount(category.getMessageCount() + messages.size());
  mbCategoryPersistence.update(category,false);
  return thread;
}
