{
  MBThread thread=mbThreadPersistence.findByPrimaryKey(threadId);
  long oldCategoryId=thread.getCategoryId();
  MBCategory oldCategory=null;
  if (oldCategoryId != MBCategoryConstants.DEFAULT_PARENT_CATEGORY_ID) {
    oldCategory=mbCategoryPersistence.fetchByPrimaryKey(oldCategoryId);
  }
  MBCategory category=null;
  if (categoryId != MBCategoryConstants.DEFAULT_PARENT_CATEGORY_ID) {
    category=mbCategoryPersistence.fetchByPrimaryKey(categoryId);
  }
  thread.setCategoryId(categoryId);
  mbThreadPersistence.update(thread);
  List<MBMessage> messages=mbMessagePersistence.findByG_C_T(groupId,oldCategoryId,thread.getThreadId());
  for (  MBMessage message : messages) {
    message.setCategoryId(categoryId);
    mbMessagePersistence.update(message);
    if (!message.isDiscussion()) {
      Indexer indexer=IndexerRegistryUtil.nullSafeGetIndexer(MBMessage.class);
      indexer.reindex(message);
    }
  }
  if ((oldCategory != null) && (categoryId != oldCategoryId)) {
    MBUtil.updateCategoryStatistics(oldCategory.getCompanyId(),oldCategory.getCategoryId());
  }
  if ((category != null) && (categoryId != oldCategoryId)) {
    MBUtil.updateCategoryStatistics(category.getCompanyId(),category.getCategoryId());
  }
  Indexer indexer=IndexerRegistryUtil.nullSafeGetIndexer(MBThread.class);
  indexer.reindex(thread);
  return thread;
}
