{
  MBThread thread=mbThreadPersistence.findByPrimaryKey(threadId);
  long oldCategoryId=thread.getCategoryId();
  MBCategory oldCategory=null;
  MBCategory category=null;
  if (oldCategoryId != MBCategoryConstants.DEFAULT_PARENT_CATEGORY_ID) {
    oldCategory=mbCategoryPersistence.findByPrimaryKey(oldCategoryId);
  }
  if (categoryId != MBCategoryConstants.DEFAULT_PARENT_CATEGORY_ID) {
    category=mbCategoryPersistence.findByPrimaryKey(categoryId);
  }
  List<MBMessage> messages=mbMessagePersistence.findByG_C_T(groupId,oldCategoryId,thread.getThreadId());
  for (  MBMessage message : messages) {
    message.setCategoryId(categoryId);
    mbMessagePersistence.update(message,false);
    try {
      if (category != null && !category.isDiscussion()) {
        Indexer.updateMessage(message.getCompanyId(),message.getGroupId(),message.getUserId(),message.getUserName(),categoryId,message.getThreadId(),message.getMessageId(),message.getSubject(),message.getBody(),message.isAnonymous(),message.getModifiedDate(),message.getAssetTagNames(),message.getExpandoBridge());
      }
    }
 catch (    SearchException se) {
      _log.error("Indexing " + message.getMessageId(),se);
    }
  }
  thread.setCategoryId(categoryId);
  mbThreadPersistence.update(thread,false);
  if (oldCategory != null) {
    oldCategory.setThreadCount(oldCategory.getThreadCount() - 1);
    oldCategory.setMessageCount(oldCategory.getMessageCount() - messages.size());
    mbCategoryPersistence.update(oldCategory,false);
  }
  if (category != null) {
    category.setThreadCount(category.getThreadCount() + 1);
    category.setMessageCount(category.getMessageCount() + messages.size());
    mbCategoryPersistence.update(category,false);
  }
  return thread;
}
