{
  long threadId=message.getThreadId();
  if (threadId <= 0) {
    threadId=counterLocalService.increment();
  }
  MBThread thread=mbThreadPersistence.create(threadId);
  thread.setGroupId(message.getGroupId());
  thread.setCompanyId(message.getCompanyId());
  thread.setCategoryId(categoryId);
  thread.setRootMessageId(message.getMessageId());
  thread.setRootMessageUserId(message.getUserId());
  if (message.isAnonymous()) {
    thread.setLastPostByUserId(0);
  }
 else {
    thread.setLastPostByUserId(message.getUserId());
  }
  thread.setLastPostDate(message.getCreateDate());
  if (message.getPriority() != MBThreadConstants.PRIORITY_NOT_GIVEN) {
    thread.setPriority(message.getPriority());
  }
  thread.setStatus(message.getStatus());
  thread.setStatusByUserId(message.getStatusByUserId());
  thread.setStatusByUserName(message.getStatusByUserName());
  thread.setStatusDate(message.getStatusDate());
  mbThreadPersistence.update(thread,false);
  if (categoryId >= 0) {
    assetEntryLocalService.updateEntry(message.getUserId(),message.getGroupId(),MBThread.class.getName(),thread.getThreadId(),null,new long[0],new String[0],false,null,null,null,null,null,String.valueOf(thread.getRootMessageId()),null,null,null,null,0,0,null,false);
  }
  return thread;
}
