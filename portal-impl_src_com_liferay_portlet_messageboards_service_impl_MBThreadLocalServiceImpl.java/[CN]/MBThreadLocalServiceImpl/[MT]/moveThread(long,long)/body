{
  MBThread thread=mbThreadPersistence.findByPrimaryKey(threadId);
  long oldCategoryId=thread.getCategoryId();
  MBCategory category=mbCategoryPersistence.findByPrimaryKey(categoryId);
  List<MBMessage> messages=mbMessagePersistence.findByC_T(oldCategoryId,thread.getThreadId());
  for (  MBMessage message : messages) {
    message.setCategoryId(category.getCategoryId());
    mbMessagePersistence.update(message,false);
    try {
      if (!category.isDiscussion()) {
        Indexer.updateMessage(message.getCompanyId(),category.getGroupId(),message.getUserName(),category.getCategoryId(),message.getThreadId(),message.getMessageId(),message.getSubject(),message.getBody(),message.getTagsEntries());
      }
    }
 catch (    IOException ioe) {
      _log.error("Indexing " + message.getMessageId(),ioe);
    }
  }
  thread.setCategoryId(category.getCategoryId());
  mbThreadPersistence.update(thread,false);
  return thread;
}
