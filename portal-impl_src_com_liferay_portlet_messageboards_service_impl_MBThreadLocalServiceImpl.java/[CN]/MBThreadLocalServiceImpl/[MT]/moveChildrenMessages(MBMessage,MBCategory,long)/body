{
  int messagesMoved=0;
  List<MBMessage> messages=mbMessagePersistence.findByT_P(oldThreadId,parentMessage.getMessageId());
  for (  MBMessage message : messages) {
    String oldAttachmentsDir=message.getAttachmentsDir();
    message.setCategoryId(parentMessage.getCategoryId());
    message.setThreadId(parentMessage.getThreadId());
    message.setAttachmentsDir(null);
    mbMessagePersistence.update(message,false);
    moveAttachmentsFromOldThread(message,oldAttachmentsDir);
    try {
      if (!message.isDiscussion()) {
        MBIndexer.updateMessage(message.getCompanyId(),message.getGroupId(),message.getUserId(),message.getUserName(),category.getCategoryId(),message.getThreadId(),message.getMessageId(),message.getSubject(),message.getBody(),message.isAnonymous(),message.getModifiedDate(),message.getAssetTagNames(),message.getExpandoBridge());
      }
    }
 catch (    SearchException se) {
      _log.error("Indexing " + message.getMessageId(),se);
    }
    messagesMoved++;
    messagesMoved+=moveChildrenMessages(message,category,oldThreadId);
  }
  return messagesMoved;
}
