{
  MBMessage message=mbMessagePersistence.findByPrimaryKey(messageId);
  if (message.isRoot()) {
    throw new SplitThreadException();
  }
  MBCategory category=message.getCategory();
  MBThread oldThread=message.getThread();
  MBMessage rootMessage=mbMessagePersistence.findByPrimaryKey(oldThread.getRootMessageId());
  mbMessageLocalService.updateAnswer(message,false,true);
  MBThread thread=addThread(message.getCategoryId(),message,serviceContext);
  oldThread.setModifiedDate(serviceContext.getModifiedDate(new Date()));
  mbThreadPersistence.update(oldThread);
  if (Validator.isNotNull(subject)) {
    MBMessageDisplay messageDisplay=mbMessageService.getMessageDisplay(messageId,WorkflowConstants.STATUS_ANY,MBThreadConstants.THREAD_VIEW_TREE,false);
    MBTreeWalker treeWalker=messageDisplay.getTreeWalker();
    List<MBMessage> messages=treeWalker.getMessages();
    int[] range=treeWalker.getChildrenRange(message);
    for (int i=range[0]; i < range[1]; i++) {
      MBMessage curMessage=messages.get(i);
      String oldSubject=message.getSubject();
      String curSubject=curMessage.getSubject();
      if (oldSubject.startsWith("RE: ")) {
        curSubject=StringUtil.replace(curSubject,rootMessage.getSubject(),subject);
      }
 else {
        curSubject=StringUtil.replace(curSubject,oldSubject,subject);
      }
      curMessage.setSubject(curSubject);
      mbMessagePersistence.update(curMessage);
    }
    message.setSubject(subject);
  }
  message.setThreadId(thread.getThreadId());
  message.setRootMessageId(thread.getRootMessageId());
  message.setParentMessageId(0);
  mbMessagePersistence.update(message);
  if (!message.isDiscussion()) {
    Indexer indexer=IndexerRegistryUtil.nullSafeGetIndexer(MBMessage.class);
    indexer.reindex(message);
  }
  moveChildrenMessages(message,category,oldThread.getThreadId());
  MBUtil.updateThreadMessageCount(thread.getCompanyId(),thread.getThreadId());
  MBUtil.updateThreadMessageCount(oldThread.getCompanyId(),oldThread.getThreadId());
  if ((message.getCategoryId() != MBCategoryConstants.DEFAULT_PARENT_CATEGORY_ID) && (message.getCategoryId() != MBCategoryConstants.DISCUSSION_CATEGORY_ID)) {
    MBUtil.updateCategoryThreadCount(category.getCompanyId(),category.getCategoryId());
  }
  Indexer indexer=IndexerRegistryUtil.nullSafeGetIndexer(MBThread.class);
  indexer.reindex(oldThread);
  indexer.reindex(message.getThread());
  return thread;
}
