{
  MBMessage message=mbMessagePersistence.findByPrimaryKey(messageId);
  if (message.isRoot()) {
    throw new SplitThreadException();
  }
  MBCategory category=message.getCategory();
  MBThread oldThread=message.getThread();
  MBMessage rootMessage=mbMessagePersistence.findByPrimaryKey(oldThread.getRootMessageId());
  String oldAttachmentsDir=message.getAttachmentsDir();
  mbMessageFlagLocalService.deleteAnswerFlags(oldThread.getThreadId(),message.getMessageId());
  int count=mbMessageFlagPersistence.countByT_F(oldThread.getThreadId(),MBMessageFlagConstants.ANSWER_FLAG);
  if (count == 1) {
    MBMessageFlag messageFlag=mbMessageFlagPersistence.fetchByU_M_F(rootMessage.getUserId(),rootMessage.getMessageId(),MBMessageFlagConstants.ANSWER_FLAG);
    messageFlag.setFlag(MBMessageFlagConstants.QUESTION_FLAG);
    mbMessageFlagPersistence.update(messageFlag,false);
  }
  if (Validator.isNotNull(newSubject)) {
    MBMessageDisplay messageDisplay=mbMessageService.getMessageDisplay(messageId,WorkflowConstants.STATUS_ANY,MBThreadConstants.THREAD_VIEW_TREE,false);
    MBTreeWalker treeWalker=messageDisplay.getTreeWalker();
    List messages=treeWalker.getMessages();
    int[] range=treeWalker.getChildrenRange(message);
    for (int i=range[0]; i < range[1]; i++) {
      MBMessage curMessage=(MBMessage)messages.get(i);
      String curSubject=null;
      if (message.getSubject().startsWith("RE: ")) {
        curSubject=StringUtil.replace(curMessage.getSubject(),rootMessage.getSubject(),newSubject);
      }
 else {
        curSubject=StringUtil.replace(curMessage.getSubject(),message.getSubject(),newSubject);
      }
      curMessage.setSubject(curSubject);
      mbMessagePersistence.update(curMessage,false);
    }
    message.setSubject(newSubject);
  }
  MBThread thread=addThread(message.getCategoryId(),message);
  message.setThreadId(thread.getThreadId());
  message.setRootMessageId(thread.getRootMessageId());
  message.setParentMessageId(0);
  message.setAttachmentsDir(null);
  mbMessagePersistence.update(message,false);
  moveAttachmentsFromOldThread(message,oldAttachmentsDir);
  if (!message.isDiscussion()) {
    Indexer indexer=IndexerRegistryUtil.getIndexer(MBMessage.class);
    indexer.reindex(message);
  }
  int messagesMoved=1;
  messagesMoved+=moveChildrenMessages(message,category,oldThread.getThreadId());
  thread.setMessageCount(messagesMoved);
  mbThreadPersistence.update(thread,false);
  oldThread.setMessageCount(oldThread.getMessageCount() - messagesMoved);
  mbThreadPersistence.update(oldThread,false);
  if ((message.getCategoryId() != MBCategoryConstants.DEFAULT_PARENT_CATEGORY_ID) && (message.getCategoryId() != MBCategoryConstants.DISCUSSION_CATEGORY_ID)) {
    category.setThreadCount(category.getThreadCount() + 1);
    mbCategoryPersistence.update(category,false);
  }
  return thread;
}
