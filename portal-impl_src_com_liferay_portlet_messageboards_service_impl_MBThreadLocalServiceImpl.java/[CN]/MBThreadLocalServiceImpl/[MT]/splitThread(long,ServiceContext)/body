{
  MBMessage message=mbMessagePersistence.findByPrimaryKey(messageId);
  if (message.isRoot()) {
    throw new SplitThreadException();
  }
  MBCategory category=message.getCategory();
  long oldThreadId=message.getThreadId();
  String oldAttachmentsDir=message.getAttachmentsDir();
  mbMessageFlagLocalService.deleteThreadFlags(oldThreadId);
  MBThread thread=addThread(message.getCategoryId(),message);
  message.setThreadId(thread.getThreadId());
  message.setParentMessageId(0);
  message.setAttachmentsDir(null);
  mbMessagePersistence.update(message,false);
  moveAttachmentsFromOldThread(message,oldAttachmentsDir);
  try {
    if (!message.isDiscussion()) {
      Indexer.updateMessage(message.getCompanyId(),message.getGroupId(),message.getUserId(),message.getUserName(),category.getCategoryId(),message.getThreadId(),message.getMessageId(),message.getSubject(),message.getBody(),message.isAnonymous(),message.getModifiedDate(),message.getAssetTagNames(),message.getExpandoBridge());
    }
  }
 catch (  SearchException se) {
    _log.error("Indexing " + message.getMessageId(),se);
  }
  int messagesMoved=1;
  messagesMoved+=moveChildrenMessages(message,category,oldThreadId);
  thread.setMessageCount(messagesMoved);
  mbThreadPersistence.update(thread,false);
  MBThread oldThread=mbThreadPersistence.findByPrimaryKey(oldThreadId);
  oldThread.setMessageCount(oldThread.getMessageCount() - messagesMoved);
  mbThreadPersistence.update(oldThread,false);
  category.setThreadCount(category.getThreadCount() + 1);
  mbCategoryPersistence.update(category,false);
  return thread;
}
