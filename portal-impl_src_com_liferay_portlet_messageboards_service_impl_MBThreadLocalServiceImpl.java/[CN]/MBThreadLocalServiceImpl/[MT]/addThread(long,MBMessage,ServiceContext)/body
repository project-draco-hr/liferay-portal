{
  Date now=new Date();
  long threadId=message.getThreadId();
  if (!message.isRoot() || (threadId <= 0)) {
    threadId=counterLocalService.increment();
  }
  MBThread thread=mbThreadPersistence.create(threadId);
  thread.setUuid(serviceContext.getUuid());
  thread.setGroupId(message.getGroupId());
  thread.setCompanyId(message.getCompanyId());
  thread.setUserId(message.getUserId());
  thread.setUserName(message.getUserName());
  thread.setCreateDate(serviceContext.getCreateDate(now));
  thread.setModifiedDate(serviceContext.getModifiedDate(now));
  thread.setCategoryId(categoryId);
  thread.setRootMessageId(message.getMessageId());
  thread.setRootMessageUserId(message.getUserId());
  if (message.isAnonymous()) {
    thread.setLastPostByUserId(0);
  }
 else {
    thread.setLastPostByUserId(message.getUserId());
  }
  thread.setLastPostDate(message.getModifiedDate());
  if (message.getPriority() != MBThreadConstants.PRIORITY_NOT_GIVEN) {
    thread.setPriority(message.getPriority());
  }
  thread.setStatus(message.getStatus());
  thread.setStatusByUserId(message.getStatusByUserId());
  thread.setStatusByUserName(message.getStatusByUserName());
  thread.setStatusDate(message.getStatusDate());
  mbThreadPersistence.update(thread);
  if (categoryId >= 0) {
    assetEntryLocalService.updateEntry(message.getUserId(),message.getGroupId(),thread.getStatusDate(),thread.getLastPostDate(),MBThread.class.getName(),thread.getThreadId(),thread.getUuid(),0,new long[0],new String[0],false,null,null,null,null,String.valueOf(thread.getRootMessageId()),null,null,null,null,0,0,null);
  }
  return thread;
}
