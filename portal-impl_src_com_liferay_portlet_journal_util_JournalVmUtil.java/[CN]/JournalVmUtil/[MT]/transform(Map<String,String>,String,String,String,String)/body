{
  StringWriter output=new StringWriter();
  boolean load=false;
  try {
    VelocityContext velocityContext=VelocityEngineUtil.getWrappedRestrictedToolsContext();
    Document doc=SAXReaderUtil.read(xml);
    Element root=doc.getRootElement();
    List<TemplateNode> nodes=_extractDynamicContents(root);
    for (    TemplateNode node : nodes) {
      velocityContext.put(node.getName(),node);
    }
    velocityContext.put("xmlRequest",root.element("request").asXML());
    velocityContext.put("request",_insertRequestVariables(root.element("request")));
    long companyId=GetterUtil.getLong(tokens.get("company_id"));
    Company company=CompanyLocalServiceUtil.getCompanyById(companyId);
    long groupId=GetterUtil.getLong(tokens.get("group_id"));
    String templateId=tokens.get("template_id");
    String journalTemplatesPath=VelocityResourceListener.JOURNAL_SEPARATOR + StringPool.SLASH + companyId+ StringPool.SLASH+ groupId;
    String randomNamespace=PwdGenerator.getPassword(PwdGenerator.KEY3,4) + StringPool.UNDERLINE;
    velocityContext.put("company",company);
    velocityContext.put("companyId",String.valueOf(companyId));
    velocityContext.put("groupId",String.valueOf(groupId));
    velocityContext.put("journalTemplatesPath",journalTemplatesPath);
    velocityContext.put("viewMode",viewMode);
    velocityContext.put("locale",LocaleUtil.fromLanguageId(languageId));
    velocityContext.put("permissionChecker",PermissionThreadLocal.getPermissionChecker());
    velocityContext.put("randomNamespace",randomNamespace);
    script=_injectEditInPlace(xml,script);
    try {
      String velocityTemplateId=companyId + groupId + templateId;
      load=VelocityEngineUtil.mergeTemplate(velocityTemplateId,script,velocityContext,output);
    }
 catch (    VelocityException ve) {
      velocityContext.put("exception",ve.getMessage());
      velocityContext.put("script",script);
      if (ve instanceof ParseErrorException) {
        ParseErrorException pe=(ParseErrorException)ve;
        velocityContext.put("column",new Integer(pe.getColumnNumber()));
        velocityContext.put("line",new Integer(pe.getLineNumber()));
      }
      String velocityTemplateId=PropsValues.JOURNAL_ERROR_TEMPLATE_VELOCITY;
      String velocityTemplateContent=ContentUtil.get(PropsValues.JOURNAL_ERROR_TEMPLATE_VELOCITY);
      load=VelocityEngineUtil.mergeTemplate(velocityTemplateId,velocityTemplateContent,velocityContext,output);
    }
  }
 catch (  Exception e) {
    if (e instanceof DocumentException) {
      throw new TransformException("Unable to read XML document",e);
    }
 else     if (e instanceof VelocityException) {
      VelocityException pex=(VelocityException)e;
      throw new TransformException("Unable to parse velocity template: " + HtmlUtil.escape(pex.getMessage()),e);
    }
 else     if (e instanceof IOException) {
      throw new TransformException("Error reading velocity template",e);
    }
 else     if (e instanceof TransformException) {
      throw (TransformException)e;
    }
 else {
      throw new TransformException("Unhandled exception",e);
    }
  }
  if (!load) {
    throw new TransformException("Unable to dynamically load velocity transform script");
  }
  return output.toString();
}
