{
  try {
    if (Validator.isNotNull(velocityTemplateContent)) {
      if (!PropsValues.LAYOUT_TEMPLATE_CACHE_ENABLED || !resourceExists(velocityTemplateId)) {
        StringResourceRepository stringResourceRepository=StringResourceLoader.getRepository();
        stringResourceRepository.putStringResource(velocityTemplateId,velocityTemplateContent);
        if (_log.isDebugEnabled()) {
          _log.debug("Added " + velocityTemplateId + " to the Velocity template repository");
        }
      }
    }
    VelocityContextImpl velocityContextImpl=(VelocityContextImpl)velocityContext;
    return _velocityEngine.mergeTemplate(velocityTemplateId,StringPool.UTF8,velocityContextImpl.getWrappedVelocityContext(),writer);
  }
 catch (  IOException ioe) {
    throw ioe;
  }
catch (  Exception e) {
    throw new SystemException(e);
  }
}
