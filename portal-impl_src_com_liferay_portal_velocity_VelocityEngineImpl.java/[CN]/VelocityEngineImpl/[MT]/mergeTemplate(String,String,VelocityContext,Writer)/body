{
  try {
    if (Validator.isNotNull(template) && !resourceExists(velocityTemplateId)) {
      StringResourceLoader.getRepository().putStringResource(velocityTemplateId,template);
      _log.debug("Added " + velocityTemplateId + " to the Velocity template repository");
    }
    VelocityContextImpl velocityContextImpl=(VelocityContextImpl)velocityContext;
    return _velocityEngine.mergeTemplate(velocityTemplateId,StringPool.UTF8,velocityContextImpl.getWrappedVelocityContext(),writer);
  }
 catch (  IOException ioe) {
    throw ioe;
  }
catch (  Exception e) {
    throw new SystemException(e);
  }
}
