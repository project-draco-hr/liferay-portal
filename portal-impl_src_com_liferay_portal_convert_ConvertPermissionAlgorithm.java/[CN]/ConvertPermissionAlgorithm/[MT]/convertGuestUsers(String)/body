{
  UnsyncBufferedReader legacyFileReader=new UnsyncBufferedReader(new FileReader(legacyFile));
  Writer legacyFileUpdatedWriter=new UnsyncBufferedWriter(new FileWriter(legacyFile + _UPDATED));
  Writer legacyFileExtRolesPermissionsWriter=new UnsyncBufferedWriter(new FileWriter(legacyFile + _EXT_ROLES_PERMIMISSIONS));
  try {
    String line=null;
    while (Validator.isNotNull(line=legacyFileReader.readLine())) {
      String[] values=StringUtil.split(line);
      long companyId=PermissionView.getCompanyId(values);
      long permissionId=PermissionView.getPermissionId(values);
      int scope=PermissionView.getScopeId(values);
      long userId=PermissionView.getPrimaryKey(values);
      if ((scope == ResourceConstants.SCOPE_INDIVIDUAL) && _guestUsersSet.contains(userId)) {
        long roleId=_guestRolesMap.get(companyId).getRoleId();
        String key=roleId + "_" + permissionId;
        if (_rolesPermissions.contains(key)) {
          continue;
        }
 else {
          _rolesPermissions.add(key);
        }
        legacyFileExtRolesPermissionsWriter.write(roleId + "," + permissionId+ "\n");
      }
 else {
        legacyFileUpdatedWriter.write(line + "\n");
      }
    }
  }
  finally {
    legacyFileReader.close();
    legacyFileUpdatedWriter.close();
    legacyFileExtRolesPermissionsWriter.close();
  }
  Table table=new Table("Roles_Permissions",new Object[][]{{"roleId",Types.BIGINT},{"permissionId",Types.BIGINT}});
  table.populateTable(legacyFile + _EXT_ROLES_PERMIMISSIONS);
  FileUtil.delete(legacyFile);
  FileUtil.delete(legacyFile + _EXT_ROLES_PERMIMISSIONS);
  return legacyFile + _UPDATED;
}
