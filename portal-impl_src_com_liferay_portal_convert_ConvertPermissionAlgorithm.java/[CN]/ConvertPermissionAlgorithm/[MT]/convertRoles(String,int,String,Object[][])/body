{
  UnsyncBufferedReader legacyFileReader=new UnsyncBufferedReader(new FileReader(legacyFile));
  Writer legacyFileExtRoleWriter=new UnsyncBufferedWriter(new FileWriter(legacyFile + _EXT_ROLE));
  Writer legacyFileExtRolesPermissionsWriter=new UnsyncBufferedWriter(new FileWriter(legacyFile + _EXT_ROLES_PERMIMISSIONS));
  Writer legacyFileExtOtherRolesWriter=new UnsyncBufferedWriter(new FileWriter(legacyFile + _EXT_OTHER_ROLES));
  try {
    MultiValueMap<Long,String[]> mvp=(MultiValueMap<Long,String[]>)MultiValueMapFactoryUtil.getMultiValueMap(_CONVERT_ROLES_MAP);
    String line=null;
    while (Validator.isNotNull(line=legacyFileReader.readLine())) {
      String[] values=StringUtil.split(line);
      long resourceId=PermissionView.getResourceId(values);
      mvp.put(resourceId,values);
    }
    for (    Long key : (Set<Long>)mvp.keySet()) {
      List<String[]> valuesList=new ArrayList<String[]>(mvp.getAll(key));
      String[] values=valuesList.get(0);
      long companyId=PermissionView.getCompanyId(values);
      long groupId=PermissionView.getPrimaryKey(values);
      String name=PermissionView.getNameId(values);
      int scope=PermissionView.getScopeId(values);
      List<String> actionsIds=new ArrayList<String>();
      List<Long> permissionIds=new ArrayList<Long>();
      for (      String[] curValues : valuesList) {
        String actionId=PermissionView.getActionId(curValues);
        long permissionId=PermissionView.getPermissionId(curValues);
        actionsIds.add(actionId);
        permissionIds.add(permissionId);
      }
      if ((type != RoleConstants.TYPE_ORGANIZATION) && (scope == ResourceConstants.SCOPE_INDIVIDUAL)) {
        List<String> defaultActions=null;
        if (type == RoleConstants.TYPE_REGULAR) {
          defaultActions=ResourceActionsUtil.getResourceActions(name);
        }
 else {
          defaultActions=ResourceActionsUtil.getResourceCommunityDefaultActions(name);
        }
        Role defaultRole=null;
        if (type == RoleConstants.TYPE_REGULAR) {
          Collections.sort(actionsIds);
          Collections.sort(defaultActions);
          if (defaultActions.equals(actionsIds)) {
            defaultRole=_ownerRolesMap.get(companyId);
          }
        }
 else {
          if (defaultActions.containsAll(actionsIds)) {
            Role[] defaultRoles=_defaultRolesMap.get(companyId);
            Group group=_groupsMap.get(groupId);
            if (group == null) {
              continue;
            }
            if (group.isCommunity()) {
              defaultRole=defaultRoles[0];
            }
 else             if (group.isOrganization()) {
              defaultRole=defaultRoles[1];
            }
 else             if (group.isUser() || group.isUserGroup()) {
              defaultRole=defaultRoles[2];
            }
          }
        }
        if (defaultRole != null) {
          long roleId=defaultRole.getRoleId();
          for (          Long permissionId : permissionIds) {
            String curKey=roleId + "_" + permissionId;
            if (_rolesPermissions.contains(curKey)) {
              continue;
            }
 else {
              _rolesPermissions.add(curKey);
            }
            legacyFileExtRolesPermissionsWriter.write(roleId + "," + permissionId+ ",\n");
          }
          continue;
        }
      }
      if (isGenerateCustomRoles()) {
        long roleId=CounterLocalServiceUtil.increment();
        String roleName=StringUtil.upperCaseFirstLetter(RoleConstants.getTypeLabel(type));
        roleName+=" " + StringUtil.toHexString(roleId);
        String[] roleColumns=new String[]{String.valueOf(roleId),String.valueOf(companyId),String.valueOf(ClassNameLocalServiceUtil.getClassNameId(Role.class)),String.valueOf(roleId),roleName,StringPool.BLANK,"Autogenerated role from portal upgrade",String.valueOf(type),"lfr-permission-algorithm-5"};
        for (int i=0; i < roleColumns.length; i++) {
          legacyFileExtRoleWriter.write(roleColumns[i] + StringPool.COMMA);
          if (i == (roleColumns.length - 1)) {
            legacyFileExtRoleWriter.write(StringPool.NEW_LINE);
          }
        }
        for (        Long permissionId : permissionIds) {
          String curKey=roleId + "_" + permissionId;
          if (_rolesPermissions.contains(curKey)) {
            continue;
          }
 else {
            _rolesPermissions.add(curKey);
          }
          legacyFileExtRolesPermissionsWriter.write(roleId + "," + permissionId+ ",\n");
        }
        for (int i=0; i < newColumns.length - 1; i++) {
          legacyFileExtOtherRolesWriter.write(values[i] + StringPool.COMMA);
        }
        legacyFileExtOtherRolesWriter.write(roleId + ",\n");
      }
    }
  }
  finally {
    legacyFileReader.close();
    legacyFileExtRoleWriter.close();
    legacyFileExtRolesPermissionsWriter.close();
    legacyFileExtOtherRolesWriter.close();
  }
  Table roleTable=new Table(RoleModelImpl.TABLE_NAME,RoleModelImpl.TABLE_COLUMNS);
  roleTable.populateTable(legacyFile + _EXT_ROLE);
  Table rolesPermissionsTable=new Table("Roles_Permissions",new Object[][]{{"roleId",Types.BIGINT},{"permissionId",Types.BIGINT}});
  rolesPermissionsTable.populateTable(legacyFile + _EXT_ROLES_PERMIMISSIONS);
  Table othersRolesTable=new Table(newName,newColumns);
  othersRolesTable.populateTable(legacyFile + _EXT_OTHER_ROLES);
  FileUtil.delete(legacyFile + _EXT_ROLE);
  FileUtil.delete(legacyFile + _EXT_ROLES_PERMIMISSIONS);
  FileUtil.delete(legacyFile + _EXT_OTHER_ROLES);
}
