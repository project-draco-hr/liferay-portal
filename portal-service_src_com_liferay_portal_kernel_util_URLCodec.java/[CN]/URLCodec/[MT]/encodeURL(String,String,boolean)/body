{
  if (rawURLString == null) {
    return null;
  }
  if (rawURLString.length() == 0) {
    return StringPool.BLANK;
  }
  StringBuilder sb=new StringBuilder(rawURLString.length());
  CharsetEncoder charsetEncoder=null;
  char[] hexes=new char[2];
  boolean modified=false;
  for (int i=0; i < rawURLString.length(); i++) {
    char c=rawURLString.charAt(i);
    if (_validChars.get(c)) {
      sb.append(c);
    }
 else     if (c == CharPool.SPACE) {
      if (escapeSpaces) {
        sb.append("%20");
      }
 else {
        sb.append(CharPool.PLUS);
      }
      modified=true;
    }
 else {
      CharBuffer charBuffer=_getRawCharBuffer(rawURLString,i);
      if (charsetEncoder == null) {
        charsetEncoder=CharsetEncoderUtil.getCharsetEncoder(charsetName);
      }
      i+=charBuffer.length() - 1;
      ByteBuffer byteBuffer=null;
      try {
        byteBuffer=charsetEncoder.encode(charBuffer);
      }
 catch (      CharacterCodingException cce) {
        _log.error(cce,cce);
        return StringPool.BLANK;
      }
      for (int j=byteBuffer.position(); j < byteBuffer.limit(); j++) {
        sb.append(CharPool.PERCENT);
        String hex=new String(UnicodeFormatter.byteToHex(byteBuffer.get(),hexes));
        hex=hex.toUpperCase();
        sb.append(hex);
      }
    }
  }
  if (!modified && (sb.length() == rawURLString.length())) {
    return rawURLString;
  }
 else {
    return sb.toString();
  }
}
