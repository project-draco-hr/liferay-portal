{
  MockHttpServletResponse response=new MockHttpServletResponse();
  response.setCharacterEncoding(StringPool.UTF8);
  if (headers == null) {
    headers=new HashMap<String,String>();
  }
  String requestURI=_CONTEXT_PATH + _SERVLET_PATH + _PATH_INFO_PREFACE+ path;
  MockHttpServletRequest request=new MockHttpServletRequest(method,requestURI);
  request.setAttribute(WebKeys.USER,TestPropsValues.getUser());
  request.setContextPath(_CONTEXT_PATH);
  request.setServletPath(_SERVLET_PATH);
  request.setPathInfo(_PATH_INFO_PREFACE + path);
  if (data != null) {
    request.setContent(data);
    String contentType=headers.remove(HttpHeaders.CONTENT_TYPE);
    if (contentType != null) {
      request.setContentType(contentType);
    }
 else {
      request.setContentType(ContentTypes.TEXT_PLAIN);
    }
  }
  for (  Map.Entry<String,String> entry : headers.entrySet()) {
    String key=entry.getKey();
    String value=entry.getValue();
    request.addHeader(key,value);
  }
  getServlet().service(request,response);
  return response;
}
