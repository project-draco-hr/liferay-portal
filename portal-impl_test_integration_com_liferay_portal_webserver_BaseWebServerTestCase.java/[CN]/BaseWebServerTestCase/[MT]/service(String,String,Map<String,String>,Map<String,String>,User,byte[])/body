{
  if (headers == null) {
    headers=new HashMap<>();
  }
  if (params == null) {
    params=new HashMap<>();
  }
  if (user == null) {
    user=TestPropsValues.getUser();
  }
  String requestURI=_CONTEXT_PATH + _SERVLET_PATH + _PATH_INFO_PREFACE+ path;
  MockHttpServletRequest mockHttpServletRequest=new MockHttpServletRequest(method,requestURI);
  mockHttpServletRequest.setAttribute(WebKeys.USER,user);
  mockHttpServletRequest.setContextPath(_CONTEXT_PATH);
  mockHttpServletRequest.setParameters(params);
  mockHttpServletRequest.setPathInfo(_PATH_INFO_PREFACE + path);
  mockHttpServletRequest.setServletPath(_SERVLET_PATH);
  if (data != null) {
    mockHttpServletRequest.setContent(data);
    String contentType=headers.remove(HttpHeaders.CONTENT_TYPE);
    if (contentType != null) {
      mockHttpServletRequest.setContentType(contentType);
    }
 else {
      mockHttpServletRequest.setContentType(ContentTypes.TEXT_PLAIN);
    }
  }
  for (  Map.Entry<String,String> entry : headers.entrySet()) {
    String key=entry.getKey();
    String value=entry.getValue();
    mockHttpServletRequest.addHeader(key,value);
  }
  MockHttpServletResponse mockHttpServletResponse=new MockHttpServletResponse();
  mockHttpServletResponse.setCharacterEncoding(StringPool.UTF8);
  Servlet httpServlet=getServlet();
  httpServlet.service(mockHttpServletRequest,mockHttpServletResponse);
  return mockHttpServletResponse;
}
