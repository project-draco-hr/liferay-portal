{
  PortletPreferences portletPreferences=portletPreferencesPersistence.fetchByO_O_P_P(ownerId,ownerType,plid,portletId);
  if (portletPreferences == null) {
    Portlet portlet=portletLocalService.getPortletById(companyId,portletId);
    if (strict && (Validator.isNull(defaultPreferences) || ((portlet != null) && portlet.isUndeployedPortlet()))) {
      if (portlet == null) {
        defaultPreferences=PortletConstants.DEFAULT_PREFERENCES;
      }
 else {
        defaultPreferences=portlet.getDefaultPreferences();
      }
      return PortletPreferencesFactoryUtil.strictFromXML(companyId,ownerId,ownerType,plid,portletId,defaultPreferences);
    }
    portletPreferences=portletPreferencesLocalService.addPortletPreferences(companyId,ownerId,ownerType,plid,portletId,portlet,defaultPreferences);
  }
  PortletPreferencesImpl portletPreferencesImpl=(PortletPreferencesImpl)PortletPreferencesFactoryUtil.fromXML(companyId,ownerId,ownerType,plid,portletId,portletPreferences.getPreferences());
  return portletPreferencesImpl;
}
