{
  Map<String,PortletPreferencesImpl> prefsPool=PortletPreferencesLocalUtil.getPreferencesPool(ownerId,ownerType);
  String key=encodeKey(plid,portletId);
  PortletPreferencesImpl prefs=prefsPool.get(key);
  if (prefs == null) {
    PortletPreferences portletPreferences=null;
    Portlet portlet=portletLocalService.getPortletById(companyId,portletId);
    try {
      portletPreferences=portletPreferencesPersistence.findByO_O_P_P(ownerId,ownerType,plid,portletId);
    }
 catch (    NoSuchPortletPreferencesException nsppe) {
      long portletPreferencesId=counterLocalService.increment();
      portletPreferences=portletPreferencesPersistence.create(portletPreferencesId);
      portletPreferences.setOwnerId(ownerId);
      portletPreferences.setOwnerType(ownerType);
      portletPreferences.setPlid(plid);
      portletPreferences.setPortletId(portletId);
      if (Validator.isNull(defaultPreferences)) {
        if (portlet == null) {
          defaultPreferences=PortletImpl.DEFAULT_PREFERENCES;
        }
 else {
          defaultPreferences=portlet.getDefaultPreferences();
        }
      }
      portletPreferences.setPreferences(defaultPreferences);
      portletPreferencesPersistence.update(portletPreferences,false);
    }
    prefs=PortletPreferencesSerializer.fromXML(companyId,ownerId,ownerType,plid,portletId,portletPreferences.getPreferences());
    prefsPool.put(key,prefs);
  }
  return (PortletPreferencesImpl)prefs.clone();
}
