{
  Map<Serializable,BasePreferencesImpl> preferencesPool=PortletPreferencesLocalUtil.getPreferencesPool(ownerId,ownerType);
  PreferencesKey preferencesKey=new PreferencesKey(plid,portletId);
  PortletPreferencesImpl portletPreferencesImpl=(PortletPreferencesImpl)preferencesPool.get(preferencesKey);
  if (portletPreferencesImpl == null) {
    Portlet portlet=portletLocalService.getPortletById(companyId,portletId);
    PortletPreferences portletPreferences=portletPreferencesPersistence.fetchByO_O_P_P(ownerId,ownerType,plid,portletId);
    if (portletPreferences == null) {
      if (PortletPreferencesThreadLocal.isStrict() && (Validator.isNull(defaultPreferences) || ((portlet != null) && portlet.isUndeployedPortlet()))) {
        return new PortletPreferencesImpl();
      }
      portletPreferences=portletPreferencesLocalService.addPortletPreferences(companyId,ownerId,ownerType,plid,portletId,portlet,defaultPreferences);
    }
    portletPreferencesImpl=(PortletPreferencesImpl)PortletPreferencesFactoryUtil.fromXML(companyId,ownerId,ownerType,plid,portletId,portletPreferences.getPreferences());
synchronized (preferencesPool) {
      preferencesPool.put(preferencesKey,portletPreferencesImpl);
    }
  }
  return (PortletPreferencesImpl)portletPreferencesImpl.clone();
}
