{
  long portletPreferencesId=counterLocalService.increment();
  PortletPreferences portletPreferences=portletPreferencesPersistence.create(portletPreferencesId);
  portletPreferences.setOwnerId(ownerId);
  portletPreferences.setOwnerType(ownerType);
  portletPreferences.setPlid(plid);
  portletPreferences.setPortletId(portletId);
  if (Validator.isNull(defaultPreferences)) {
    if (portlet == null) {
      defaultPreferences=PortletConstants.DEFAULT_PREFERENCES;
    }
 else {
      defaultPreferences=portlet.getDefaultPreferences();
    }
  }
  portletPreferences.setPreferences(defaultPreferences);
  if (_log.isDebugEnabled()) {
    StringBundler sb=new StringBundler(13);
    sb.append("Add {companyId=");
    sb.append(companyId);
    sb.append(", ownerId=");
    sb.append(ownerId);
    sb.append(", ownerType=");
    sb.append(ownerType);
    sb.append(", plid=");
    sb.append(plid);
    sb.append(", portletId=");
    sb.append(portletId);
    sb.append(", defaultPreferences=");
    sb.append(defaultPreferences);
    sb.append("}");
    _log.debug(sb.toString());
  }
  try {
    portletPreferencesPersistence.update(portletPreferences);
  }
 catch (  SystemException se) {
    if (_log.isWarnEnabled()) {
      _log.warn("Add failed, fetch {ownerId=" + ownerId + ", ownerType="+ ownerType+ ", plid="+ plid+ ", portletId="+ portletId+ "}");
    }
    portletPreferences=portletPreferencesPersistence.fetchByO_O_P_P(ownerId,ownerType,plid,portletId,false);
    if (portletPreferences == null) {
      throw se;
    }
  }
  return portletPreferences;
}
