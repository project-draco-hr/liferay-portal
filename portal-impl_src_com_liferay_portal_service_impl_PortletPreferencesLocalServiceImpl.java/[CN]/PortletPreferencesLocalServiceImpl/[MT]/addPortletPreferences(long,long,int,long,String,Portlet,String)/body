{
  long portletPreferencesId=counterLocalService.increment();
  PortletPreferences portletPreferences=portletPreferencesPersistence.create(portletPreferencesId);
  portletPreferences.setOwnerId(ownerId);
  portletPreferences.setOwnerType(ownerType);
  portletPreferences.setPlid(plid);
  portletPreferences.setPortletId(portletId);
  if (Validator.isNull(defaultPreferences)) {
    if (portlet == null) {
      defaultPreferences=PortletConstants.DEFAULT_PREFERENCES;
    }
 else {
      defaultPreferences=portlet.getDefaultPreferences();
    }
  }
  portletPreferences.setPreferences(defaultPreferences);
  try {
    portletPreferencesPersistence.update(portletPreferences,false);
  }
 catch (  SystemException se) {
    if (_log.isWarnEnabled()) {
      _log.warn("Add failed, fetch {ownerId=" + ownerId + ", ownerType="+ ownerType+ ", plid="+ plid+ ", portletId="+ portletId+ "}");
    }
    portletPreferences=portletPreferencesPersistence.fetchByO_O_P_P(ownerId,ownerType,plid,portletId);
    if (portletPreferences == null) {
      throw se;
    }
  }
  return portletPreferences;
}
