{
  long portletPreferencesId=counterLocalService.increment();
  PortletPreferences portletPreferences=portletPreferencesPersistence.create(portletPreferencesId);
  portletPreferences.setOwnerId(ownerId);
  portletPreferences.setOwnerType(ownerType);
  portletPreferences.setPlid(plid);
  portletPreferences.setPortletId(portletId);
  if (Validator.isNull(defaultPreferences)) {
    if (portlet == null) {
      defaultPreferences=PortletConstants.DEFAULT_PREFERENCES;
    }
 else {
      defaultPreferences=portlet.getDefaultPreferences();
    }
  }
  portletPreferences.setPreferences(defaultPreferences);
  portletPreferencesPersistence.update(portletPreferences,false);
  return portletPreferences;
}
