{
  PortletPreferences portletPreferences=portletPreferencesPersistence.fetchByO_O_P_P(ownerId,ownerType,plid,portletId);
  if (portletPreferences == null) {
    long portletPreferencesId=counterLocalService.increment();
    portletPreferences=portletPreferencesPersistence.create(portletPreferencesId);
    portletPreferences.setOwnerId(ownerId);
    portletPreferences.setOwnerType(ownerType);
    portletPreferences.setPlid(plid);
    portletPreferences.setPortletId(portletId);
  }
  PortletPreferencesImpl preferencesImpl=(PortletPreferencesImpl)preferences;
  String xml=PortletPreferencesSerializer.toXML(preferencesImpl);
  portletPreferences.setPreferences(xml);
  portletPreferencesPersistence.update(portletPreferences,false);
  PortletPreferencesLocalUtil.clearPreferencesPool(ownerId,ownerType);
  return portletPreferences;
}
