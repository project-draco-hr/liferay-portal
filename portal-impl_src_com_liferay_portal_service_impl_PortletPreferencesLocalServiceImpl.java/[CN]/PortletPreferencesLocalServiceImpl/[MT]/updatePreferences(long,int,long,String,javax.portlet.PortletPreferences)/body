{
  PortletPreferences portletPreferences=null;
  try {
    portletPreferences=PortletPreferencesUtil.findByO_O_P_P(ownerId,ownerType,plid,portletId);
  }
 catch (  NoSuchPortletPreferencesException nsppe) {
    long portletPreferencesId=counterLocalService.increment();
    portletPreferences=PortletPreferencesUtil.create(portletPreferencesId);
    portletPreferences.setOwnerId(ownerId);
    portletPreferences.setOwnerType(ownerType);
    portletPreferences.setPlid(plid);
    portletPreferences.setPortletId(portletId);
  }
  PortletPreferencesImpl prefsImpl=(PortletPreferencesImpl)prefs;
  String xml=PortletPreferencesSerializer.toXML(prefsImpl);
  portletPreferences.setPreferences(xml);
  PortletPreferencesUtil.update(portletPreferences);
  PortletPreferencesLocalUtil.clearPreferencesPool(ownerId,ownerType);
  return portletPreferences;
}
