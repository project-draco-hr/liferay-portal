{
  Properties userMappings=getUserMappings(companyId);
  User user=null;
  Attributes attr=null;
  try {
    attr=ctx.getAttributes(fullUserDN);
  }
 catch (  NameNotFoundException nnfe) {
    _log.error("LDAP user not found with fullUserDN " + fullUserDN);
    _log.error(nnfe,nnfe);
    return null;
  }
  String emailAddress=LDAPUtil.getAttributeValue(attr,userMappings.getProperty("emailAddress"));
  try {
    user=UserLocalServiceUtil.getUserByEmailAddress(companyId,emailAddress);
  }
 catch (  NoSuchUserException nsue) {
    if (create) {
      try {
        if (_log.isDebugEnabled()) {
          _log.debug("Adding user to portal " + fullUserDN);
        }
        user=importLDAPUser(companyId,ctx,attr,StringPool.BLANK,false);
      }
 catch (      Exception e) {
        if (_log.isWarnEnabled()) {
          _log.warn("Could not create user " + fullUserDN);
        }
        if (_log.isDebugEnabled()) {
          _log.debug(e,e);
        }
      }
    }
  }
  return user;
}
