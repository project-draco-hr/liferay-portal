{
  String postfix=LDAPSettingsUtil.getPropertyPostfix(ldapServerId);
  LdapContext ldapContext=getContext(ldapServerId,companyId);
  NamingEnumeration<SearchResult> enu=null;
  try {
    if (ldapContext == null) {
      return null;
    }
    String baseDN=PrefsPropsUtil.getString(companyId,PropsKeys.LDAP_BASE_DN + postfix);
    String groupFilter=PrefsPropsUtil.getString(companyId,PropsKeys.LDAP_IMPORT_GROUP_SEARCH_FILTER + postfix);
    if (!LDAPUtil.isValidFilter(groupFilter)) {
      StringBundler sb=new StringBundler(4);
      sb.append(PropsKeys.LDAP_IMPORT_GROUP_SEARCH_FILTER);
      sb.append(postfix);
      sb.append(" specifies an invalid filter:");
      sb.append(groupFilter);
      throw new LDAPFilterException(sb.toString());
    }
    StringBundler sb=new StringBundler(Validator.isNotNull(groupFilter) ? 9 : 5);
    if (Validator.isNotNull(groupFilter)) {
      sb.append(StringPool.OPEN_PARENTHESIS);
      sb.append(StringPool.AMPERSAND);
    }
    sb.append(StringPool.OPEN_PARENTHESIS);
    Properties groupMappings=LDAPSettingsUtil.getGroupMappings(ldapServerId,companyId);
    sb.append(groupMappings.getProperty("groupName"));
    sb.append(StringPool.EQUAL);
    sb.append(groupName);
    sb.append(StringPool.CLOSE_PARENTHESIS);
    if (Validator.isNotNull(groupFilter)) {
      sb.append(groupFilter);
      sb.append(StringPool.CLOSE_PARENTHESIS);
    }
    SearchControls searchControls=new SearchControls(SearchControls.SUBTREE_SCOPE,1,0,null,false,false);
    enu=ldapContext.search(baseDN,sb.toString(),searchControls);
    if (enu.hasMoreElements()) {
      return enu.nextElement();
    }
    return null;
  }
  finally {
    if (enu != null) {
      enu.close();
    }
    if (ldapContext != null) {
      ldapContext.close();
    }
  }
}
