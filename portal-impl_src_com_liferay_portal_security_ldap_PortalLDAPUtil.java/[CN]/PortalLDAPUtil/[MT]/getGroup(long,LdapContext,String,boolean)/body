{
  Properties groupMappings=getGroupMappings(companyId);
  UserGroup userGroup=null;
  Attributes attr=null;
  try {
    attr=ctx.getAttributes(fullGroupDN);
  }
 catch (  NameNotFoundException nnfe) {
    _log.error("LDAP group not found with fullGroupDN " + fullGroupDN);
    _log.error(nnfe,nnfe);
    return null;
  }
  String groupName=LDAPUtil.getAttributeValue(attr,groupMappings.getProperty("groupName"));
  try {
    userGroup=UserGroupLocalServiceUtil.getUserGroup(companyId,groupName);
  }
 catch (  NoSuchUserGroupException nsuge) {
    if (create) {
      try {
        if (_log.isDebugEnabled()) {
          _log.debug("Adding user group to portal " + fullGroupDN);
        }
        long defaultUserId=UserLocalServiceUtil.getDefaultUserId(companyId);
        String description=LDAPUtil.getAttributeValue(attr,groupMappings.getProperty("description"));
        userGroup=UserGroupLocalServiceUtil.addUserGroup(defaultUserId,companyId,groupName,description);
      }
 catch (      Exception e) {
        if (_log.isWarnEnabled()) {
          _log.warn("Could not create user group " + fullGroupDN);
        }
        if (_log.isDebugEnabled()) {
          _log.debug(e,e);
        }
      }
    }
  }
  return userGroup;
}
