{
  String postfix=LDAPSettingsUtil.getPropertyPostfix(ldapServerId);
  LdapContext ldapContext=getContext(ldapServerId,companyId);
  NamingEnumeration<SearchResult> enu=null;
  try {
    if (ldapContext == null) {
      return null;
    }
    String baseDN=PrefsPropsUtil.getString(companyId,PropsKeys.LDAP_BASE_DN + postfix);
    String filter=null;
    String userFilter=PrefsPropsUtil.getString(companyId,PropsKeys.LDAP_IMPORT_USER_SEARCH_FILTER + postfix);
    Properties userMappings=LDAPSettingsUtil.getUserMappings(ldapServerId,companyId);
    String login=null;
    String loginMapping=null;
    String authType=PrefsPropsUtil.getString(companyId,PropsKeys.COMPANY_SECURITY_AUTH_TYPE,PropsValues.COMPANY_SECURITY_AUTH_TYPE);
    if (authType.equals(CompanyConstants.AUTH_TYPE_SN) && !PrefsPropsUtil.getBoolean(companyId,PropsKeys.USERS_SCREEN_NAME_ALWAYS_AUTOGENERATE)) {
      login=screenName;
      loginMapping=userMappings.getProperty("screenName");
    }
 else {
      login=emailAddress;
      loginMapping=userMappings.getProperty("emailAddress");
    }
    if (Validator.isNotNull(userFilter)) {
      StringBundler sb=new StringBundler(11);
      sb.append(StringPool.OPEN_PARENTHESIS);
      sb.append(StringPool.AMPERSAND);
      sb.append(StringPool.OPEN_PARENTHESIS);
      sb.append(loginMapping);
      sb.append(StringPool.EQUAL);
      sb.append(login);
      sb.append(StringPool.CLOSE_PARENTHESIS);
      sb.append(StringPool.OPEN_PARENTHESIS);
      sb.append(userFilter);
      sb.append(StringPool.CLOSE_PARENTHESIS);
      sb.append(StringPool.CLOSE_PARENTHESIS);
      filter=sb.toString();
    }
 else {
      StringBundler sb=new StringBundler(5);
      sb.append(StringPool.OPEN_PARENTHESIS);
      sb.append(loginMapping);
      sb.append(StringPool.EQUAL);
      sb.append(login);
      sb.append(StringPool.CLOSE_PARENTHESIS);
      filter=sb.toString();
    }
    SearchControls searchControls=new SearchControls(SearchControls.SUBTREE_SCOPE,1,0,null,false,false);
    enu=ldapContext.search(baseDN,filter,searchControls);
    if (enu.hasMoreElements()) {
      Binding binding=enu.nextElement();
      return binding;
    }
 else {
      return null;
    }
  }
  finally {
    if (enu != null) {
      enu.close();
    }
    if (ldapContext != null) {
      ldapContext.close();
    }
  }
}
