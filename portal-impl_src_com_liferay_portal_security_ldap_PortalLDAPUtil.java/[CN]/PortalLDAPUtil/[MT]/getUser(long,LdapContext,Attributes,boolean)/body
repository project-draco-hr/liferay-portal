{
  Properties userMappings=getUserMappings(companyId);
  User user=null;
  String emailAddress=LDAPUtil.getAttributeValue(attr,userMappings.getProperty("emailAddress"));
  try {
    user=UserLocalServiceUtil.getUserByEmailAddress(companyId,emailAddress);
  }
 catch (  NoSuchUserException nsue) {
    if (create) {
      try {
        if (_log.isDebugEnabled()) {
          _log.debug("Adding user to portal " + emailAddress);
        }
        user=importLDAPUser(companyId,ctx,attr,StringPool.BLANK,false);
      }
 catch (      Exception e) {
        if (_log.isWarnEnabled()) {
          _log.warn("Could not create user " + emailAddress);
        }
        if (_log.isDebugEnabled()) {
          _log.debug(e,e);
        }
      }
    }
  }
  return user;
}
