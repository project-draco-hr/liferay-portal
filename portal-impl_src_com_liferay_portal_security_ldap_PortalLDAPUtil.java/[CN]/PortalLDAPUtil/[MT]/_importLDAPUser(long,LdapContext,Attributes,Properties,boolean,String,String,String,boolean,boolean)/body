{
  LogUtil.debug(_log,userMappings);
  User defaultUser=UserLocalServiceUtil.getDefaultUser(companyId);
  long creatorUserId=0;
  boolean passwordReset=false;
  boolean autoScreenName=false;
  Locale locale=defaultUser.getLocale();
  String firstName=LDAPUtil.getAttributeValue(attrs,userMappings.getProperty("firstName"));
  String middleName=LDAPUtil.getAttributeValue(attrs,userMappings.getProperty("middleName"));
  String lastName=LDAPUtil.getAttributeValue(attrs,userMappings.getProperty("lastName"));
  if (Validator.isNull(firstName) || Validator.isNull(lastName)) {
    String fullName=LDAPUtil.getAttributeValue(attrs,userMappings.getProperty("fullName"));
    String[] names=LDAPUtil.splitFullName(fullName);
    firstName=names[0];
    middleName=names[1];
    lastName=names[2];
  }
  int prefixId=0;
  int suffixId=0;
  boolean male=true;
  int birthdayMonth=Calendar.JANUARY;
  int birthdayDay=1;
  int birthdayYear=1970;
  String jobTitle=LDAPUtil.getAttributeValue(attrs,userMappings.getProperty("jobTitle"));
  long organizationId=0;
  long locationId=0;
  boolean sendEmail=false;
  if (_log.isDebugEnabled()) {
    _log.debug("Screen name " + screenName + " and email address "+ emailAddress);
  }
  if (Validator.isNull(screenName) || Validator.isNull(emailAddress)) {
    if (_log.isWarnEnabled()) {
      _log.warn("Cannot add user because screen name and email address " + "are required");
    }
    return null;
  }
  User user=null;
  try {
    user=UserLocalServiceUtil.getUserByEmailAddress(companyId,emailAddress);
    if (updatePassword) {
      UserLocalServiceUtil.updatePassword(user.getUserId(),password,password,passwordReset,true);
    }
  }
 catch (  NoSuchUserException nsue) {
  }
  if (user != null) {
    try {
      user=UserLocalServiceUtil.addUser(creatorUserId,companyId,autoPassword,password,password,autoScreenName,screenName,emailAddress,locale,firstName,middleName,lastName,prefixId,suffixId,male,birthdayMonth,birthdayDay,birthdayYear,jobTitle,organizationId,locationId,sendEmail);
    }
 catch (    Exception e) {
      _log.error("Problem adding user with screen name " + screenName + " and email address "+ emailAddress,e);
    }
  }
  if (importGroupMembership && (user != null)) {
    Attribute attr=attrs.get(userMappings.getProperty("group"));
    if (attr != null) {
      _importGroupsAndMembershipFromLDAPUser(companyId,ctx,user.getUserId(),attr);
    }
  }
  return user;
}
