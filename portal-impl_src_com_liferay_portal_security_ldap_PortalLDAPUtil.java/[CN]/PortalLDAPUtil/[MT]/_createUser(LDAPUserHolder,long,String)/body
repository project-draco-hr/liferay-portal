{
  User user=null;
  try {
    if (_log.isDebugEnabled()) {
      _log.debug("Adding user to portal " + data.getEmailAddress());
    }
    Calendar birthdayCal=CalendarFactoryUtil.getCalendar();
    birthdayCal.setTime(data.getBirthday());
    int birthdayMonth=birthdayCal.get(Calendar.MONTH);
    int birthdayDay=birthdayCal.get(Calendar.DAY_OF_MONTH);
    int birthdayYear=birthdayCal.get(Calendar.YEAR);
    CompanyThreadLocal.setCompanyId(companyId);
    user=UserLocalServiceUtil.addUser(data.getCreatorUserId(),companyId,data.isAutoPassword(),password,password,data.isAutoScreenName(),data.getScreenName(),data.getEmailAddress(),data.getOpenId(),data.getLocale(),data.getFirstName(),data.getMiddleName(),data.getLastName(),data.getPrefixId(),data.getSuffixId(),data.getMale(),birthdayMonth,birthdayDay,birthdayYear,data.getJobTitle(),data.getGroupIds(),data.getOrganizationIds(),data.getRoleIds(),data.getUserGroupIds(),data.isSendEmail(),data.getServiceContext());
    _updateExpando(user,data);
  }
 catch (  Exception e) {
    _log.error("Problem adding user with screen name " + data.getScreenName() + " and email address "+ data.getEmailAddress(),e);
  }
  return user;
}
