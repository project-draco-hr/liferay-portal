{
  ThemeDisplay themeDisplay=(ThemeDisplay)actionRequest.getAttribute(WebKeys.THEME_DISPLAY);
  String redirect=ParamUtil.getString(actionRequest,"redirect");
  Layout refererLayout=layoutLocalService.fetchLayout(themeDisplay.getRefererPlid());
  if (refererLayout == null) {
    return redirect;
  }
  boolean isAncestorLayout=false;
  if (layout.getPlid() == themeDisplay.getRefererPlid()) {
    isAncestorLayout=true;
  }
 else {
    for (    Layout parentLayout : refererLayout.getAncestors()) {
      if (parentLayout.getPlid() == layout.getPlid()) {
        isAncestorLayout=true;
      }
    }
  }
  if (!isAncestorLayout) {
    return redirect;
  }
  long newRefererPlid=getNewPlid(layout);
  Layout redirectLayout=layoutLocalService.fetchLayout(newRefererPlid);
  if (redirectLayout != null) {
    redirect=PortalUtil.getLayoutFullURL(redirectLayout,themeDisplay);
  }
 else {
    redirect=getEmptyLayoutSetURL(actionRequest,layout.getGroupId(),layout.isPrivateLayout());
  }
  return redirect;
}
