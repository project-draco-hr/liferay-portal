{
  String userIdAndInstanceId=routeParameters.remove("userIdAndInstanceId");
  if (!isPortletInstanceable() && Validator.isNull(userIdAndInstanceId)) {
    return getPortletId();
  }
  String portletInstanceKey=routeParameters.remove("p_p_id");
  if (Validator.isNotNull(portletInstanceKey)) {
    return portletInstanceKey;
  }
  if (Validator.isNotNull(userIdAndInstanceId)) {
    PortletInstance portletInstance=PortletInstance.fromPortletNameAndUserIdAndInstanceId(getPortletId(),userIdAndInstanceId);
    return portletInstance.getPortletInstanceKey();
  }
  String instanceId=routeParameters.remove("instanceId");
  if (Validator.isNotNull(instanceId)) {
    return PortletConstants.assemblePortletId(getPortletId(),instanceId);
  }
  if (!isAllPublicRenderParameters(routeParameters)) {
    _log.error("Either p_p_id or instanceId must be provided for an " + "instanceable portlet");
  }
  return null;
}
