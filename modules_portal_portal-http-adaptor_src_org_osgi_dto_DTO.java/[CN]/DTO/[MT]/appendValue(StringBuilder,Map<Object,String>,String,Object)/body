{
  if (value == null) {
    return result.append("null");
  }
  if (value instanceof String || value instanceof Character) {
    return appendString(result,compress(value.toString()));
  }
  if (value instanceof Number || value instanceof Boolean) {
    return result.append(value.toString());
  }
  final String path=objectRefs.get(value);
  if (path != null) {
    result.append("{\"$ref\":");
    appendString(result,path);
    result.append("}");
    return result;
  }
  objectRefs.put(value,refpath);
  if (value instanceof DTO) {
    return appendDTO(result,objectRefs,refpath,(DTO)value);
  }
  if (value instanceof Map) {
    return appendMap(result,objectRefs,refpath,(Map<?,?>)value);
  }
  if (value instanceof List || value instanceof Set) {
    return appendIterable(result,objectRefs,refpath,(Iterable<?>)value);
  }
  if (value.getClass().isArray()) {
    return appendArray(result,objectRefs,refpath,value);
  }
  return appendString(result,compress(value.toString()));
}
