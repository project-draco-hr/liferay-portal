{
  long companyId=PortalUtil.getCompanyId(request);
  String ppid=ParamUtil.getString(request,"p_p_id");
  String portletNamespace=PortalUtil.getPortletNamespace(ppid);
  String strutsAction=ParamUtil.getString(request,portletNamespace + "struts_action");
  if (AuthTokenWhitelistUtil.isPortletCSRFWhitelisted(companyId,ppid,strutsAction)) {
    return;
  }
  String requestAuthenticationToken=ParamUtil.getString(request,"p_auth");
  String sessionAuthenticationToken=getSessionAuthenticationToken(request,_PORTAL);
  String propertiesAuthenticatonTokenSharedSecret=Encryptor.digest(PropsValues.AUTH_TOKEN_SHARED_SECRET);
  String requestAuthenticatonTokenSharedSecret=ParamUtil.getString(request,"p_auth_secret");
  if (!requestAuthenticationToken.equals(sessionAuthenticationToken) && !requestAuthenticatonTokenSharedSecret.equals(propertiesAuthenticatonTokenSharedSecret)) {
    throw new PrincipalException("Invalid authentication token");
  }
}
