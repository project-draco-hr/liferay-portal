{
  if (AuthTokenWhitelistUtil.isPortletInvocationWhitelisted(request,portlet)) {
    return true;
  }
  long plid=layout.getPlid();
  String portletId=portlet.getPortletId();
  String portletToken=ParamUtil.getString(request,"p_p_auth");
  if (Validator.isNull(portletToken)) {
    HttpServletRequest originalRequest=PortalUtil.getOriginalServletRequest(request);
    portletToken=ParamUtil.getString(originalRequest,"p_p_auth");
  }
  if (Validator.isNotNull(portletToken)) {
    String key=PortletPermissionUtil.getPrimaryKey(plid,portletId);
    String sessionToken=getSessionAuthenticationToken(request,key,false);
    if (Validator.isNotNull(sessionToken) && sessionToken.equals(portletToken)) {
      return true;
    }
  }
  return false;
}
