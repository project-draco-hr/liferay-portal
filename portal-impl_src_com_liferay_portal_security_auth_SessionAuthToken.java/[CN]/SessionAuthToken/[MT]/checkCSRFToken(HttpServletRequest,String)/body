{
  if (!PropsValues.AUTH_TOKEN_CHECK_ENABLED) {
    return;
  }
  String csrfSharedSecret=ParamUtil.getString(request,"p_auth_secret");
  if (AuthTokenWhitelistUtil.isValidCSRFSharedSecret(csrfSharedSecret)) {
    return;
  }
  long companyId=PortalUtil.getCompanyId(request);
  if (AuthTokenWhitelistUtil.isCSRFContextWhitelisted(companyId,context)) {
    return;
  }
  if (context.equals(SecurityPortletContainerWrapper.class.getName())) {
    String ppid=ParamUtil.getString(request,"p_p_id");
    String portletNamespace=PortalUtil.getPortletNamespace(ppid);
    String strutsAction=ParamUtil.getString(request,portletNamespace + "struts_action");
    if (AuthTokenWhitelistUtil.isPortletCSRFWhitelisted(companyId,ppid,strutsAction)) {
      return;
    }
  }
  String csrfToken=ParamUtil.getString(request,"p_auth");
  String sessionToken=getSessionAuthenticationToken(request,_CSRF,false);
  if (!csrfToken.equals(sessionToken)) {
    throw new PrincipalException("Invalid authentication token");
  }
}
