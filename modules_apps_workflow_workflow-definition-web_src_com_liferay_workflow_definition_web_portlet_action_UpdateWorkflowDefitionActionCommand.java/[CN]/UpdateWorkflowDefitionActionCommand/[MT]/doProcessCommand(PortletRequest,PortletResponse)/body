{
  UploadPortletRequest uploadPortletRequest=PortalUtil.getUploadPortletRequest(portletRequest);
  ThemeDisplay themeDisplay=(ThemeDisplay)portletRequest.getAttribute(WebKeys.THEME_DISPLAY);
  Map<Locale,String> titleMap=LocalizationUtil.getLocalizationMap(portletRequest,WorkflowDefinitionConstants.TITLE);
  File file=uploadPortletRequest.getFile(WorkflowDefinitionConstants.FILE);
  WorkflowDefinition workflowDefinition=null;
  String name=ParamUtil.getString(portletRequest,WorkflowDefinitionConstants.NAME);
  int version=ParamUtil.getInteger(portletRequest,WorkflowDefinitionConstants.VERSION);
  if (Validator.isNotNull(name)) {
    workflowDefinition=WorkflowDefinitionManagerUtil.getWorkflowDefinition(themeDisplay.getCompanyId(),name,version);
    WorkflowDefinitionManagerUtil.updateTitle(themeDisplay.getCompanyId(),themeDisplay.getUserId(),name,version,getTitle(titleMap));
  }
 else {
    if (file.length() == 0) {
      throw new WorkflowDefinitionFileException();
    }
    workflowDefinition=WorkflowDefinitionManagerUtil.deployWorkflowDefinition(themeDisplay.getCompanyId(),themeDisplay.getUserId(),getTitle(titleMap),FileUtil.getBytes(file));
  }
  portletRequest.setAttribute(WebKeys.WORKFLOW_DEFINITION,workflowDefinition);
}
