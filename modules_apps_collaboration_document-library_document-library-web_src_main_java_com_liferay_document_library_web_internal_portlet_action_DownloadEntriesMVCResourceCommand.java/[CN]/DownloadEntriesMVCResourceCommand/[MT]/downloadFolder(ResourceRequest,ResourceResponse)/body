{
  ThemeDisplay themeDisplay=(ThemeDisplay)resourceRequest.getAttribute(WebKeys.THEME_DISPLAY);
  long repositoryId=ParamUtil.getLong(resourceRequest,"repositoryId");
  long folderId=ParamUtil.getLong(resourceRequest,"folderId");
  File file=null;
  InputStream inputStream=null;
  try {
    String zipFileName=getZipFileName(folderId,themeDisplay);
    ZipWriter zipWriter=ZipWriterFactoryUtil.getZipWriter();
    zipFolder(repositoryId,folderId,StringPool.SLASH,zipWriter);
    file=zipWriter.getFile();
    inputStream=new FileInputStream(file);
    PortletResponseUtil.sendFile(resourceRequest,resourceResponse,zipFileName,inputStream,ContentTypes.APPLICATION_ZIP);
  }
  finally {
    StreamUtil.cleanUp(inputStream);
    if (file != null) {
      file.delete();
    }
  }
}
