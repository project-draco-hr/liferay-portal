{
  ThemeDisplay themeDisplay=(ThemeDisplay)request.getAttribute(WebKeys.THEME_DISPLAY);
  Company company=themeDisplay.getCompany();
  String doAsURL=company.getHomeURL();
  if (Validator.isNull(doAsURL)) {
    Layout layout=null;
    List<Layout> layouts=LayoutLocalServiceUtil.getLayouts(themeDisplay.getScopeGroupId(),false,LayoutConstants.DEFAULT_PARENT_LAYOUT_ID);
    if (!layouts.isEmpty()) {
      layout=layouts.get(0);
      doAsURL=PortalUtil.getLayoutFriendlyURL(layout,themeDisplay);
    }
    if (Validator.isNull(doAsURL)) {
      doAsURL=themeDisplay.getPathContext() + _COMPANY_DEFAULT_HOME_URL;
    }
  }
 else {
    doAsURL=themeDisplay.getPathContext() + doAsURL;
  }
  if (doAsUserId <= 0) {
    doAsUserId=company.getDefaultUser().getUserId();
  }
  String encDoAsUserId=Encryptor.encrypt(company.getKeyObj(),String.valueOf(doAsUserId));
  return HttpUtil.addParameter(doAsURL,"doAsUserId",encDoAsUserId);
}
