{
  List orders=ShoppingOrderUtil.findByG_U_PPPS(groupId,userId,ShoppingOrderImpl.STATUS_LATEST,0,1);
  ShoppingOrder order=null;
  if (orders.size() == 1) {
    order=(ShoppingOrder)orders.get(0);
  }
 else {
    User user=UserUtil.findByPrimaryKey(userId);
    Date now=new Date();
    String orderId=getOrderId();
    List pastOrders=ShoppingOrderUtil.findByG_U_PPPS(groupId,userId,ShoppingOrderImpl.STATUS_CHECKOUT,0,1);
    if (pastOrders.size() == 1) {
      ShoppingOrder pastOrder=(ShoppingOrder)pastOrders.get(0);
      order=ShoppingOrderUtil.create(orderId);
      order.setBillingCompany(pastOrder.getBillingCompany());
      order.setBillingStreet(pastOrder.getBillingStreet());
      order.setBillingCity(pastOrder.getBillingCity());
      order.setBillingState(pastOrder.getBillingState());
      order.setBillingZip(pastOrder.getBillingZip());
      order.setBillingCountry(pastOrder.getBillingCountry());
      order.setBillingPhone(pastOrder.getBillingPhone());
      order.setShipToBilling(pastOrder.isShipToBilling());
      order.setShippingCompany(pastOrder.getShippingCompany());
      order.setShippingStreet(pastOrder.getShippingStreet());
      order.setShippingCity(pastOrder.getShippingCity());
      order.setShippingState(pastOrder.getShippingState());
      order.setShippingZip(pastOrder.getShippingZip());
      order.setShippingCountry(pastOrder.getShippingCountry());
      order.setShippingPhone(pastOrder.getShippingPhone());
    }
    if (order == null) {
      order=ShoppingOrderUtil.create(orderId);
    }
    order.setGroupId(groupId);
    order.setCompanyId(user.getCompanyId());
    order.setUserId(user.getUserId());
    order.setUserName(user.getFullName());
    order.setCreateDate(now);
    order.setModifiedDate(now);
    order.setBillingFirstName(user.getFirstName());
    order.setBillingLastName(user.getLastName());
    order.setBillingEmailAddress(user.getEmailAddress());
    order.setShippingFirstName(user.getFirstName());
    order.setShippingLastName(user.getLastName());
    order.setShippingEmailAddress(user.getEmailAddress());
    order.setCcName(user.getFullName());
    order.setPpPaymentStatus(ShoppingOrderImpl.STATUS_LATEST);
    order.setSendOrderEmail(true);
    order.setSendShippingEmail(true);
    ShoppingOrderUtil.update(order);
  }
  return order;
}
