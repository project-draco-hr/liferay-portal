{
  Map items=cart.getItems();
  Date now=new Date();
  ShoppingPreferences shoppingPrefs=ShoppingPreferences.getInstance(cart.getCompanyId(),cart.getGroupId());
  if (!ShoppingUtil.meetsMinOrder(shoppingPrefs,items)) {
    throw new CartMinOrderException();
  }
  ShoppingOrder order=getLatestOrder(cart.getUserId(),cart.getGroupId());
  order.setCreateDate(now);
  order.setModifiedDate(now);
  order.setPpPaymentStatus(ShoppingOrderImpl.STATUS_CHECKOUT);
  ShoppingOrderUtil.update(order);
  boolean requiresShipping=false;
  Iterator itr=items.entrySet().iterator();
  while (itr.hasNext()) {
    Map.Entry entry=(Map.Entry)itr.next();
    ShoppingCartItem cartItem=(ShoppingCartItem)entry.getKey();
    Integer count=(Integer)entry.getValue();
    ShoppingItem item=cartItem.getItem();
    if (item.isRequiresShipping()) {
      requiresShipping=true;
    }
    ShoppingOrderItemPK orderItemPK=new ShoppingOrderItemPK(order.getOrderId(),cartItem.getCartItemId());
    ShoppingOrderItem orderItem=ShoppingOrderItemUtil.create(orderItemPK);
    orderItem.setSku(item.getSku());
    orderItem.setName(item.getName());
    orderItem.setDescription(item.getDescription());
    orderItem.setProperties(item.getProperties());
    orderItem.setPrice(ShoppingUtil.calculateActualPrice(item,count.intValue()) / count.intValue());
    orderItem.setQuantity(count.intValue());
    ShoppingOrderItemUtil.update(orderItem);
  }
  order.setModifiedDate(new Date());
  order.setTax(ShoppingUtil.calculateTax(items,order.getBillingState()));
  order.setShipping(ShoppingUtil.calculateAlternativeShipping(items,cart.getAltShipping()));
  order.setAltShipping(shoppingPrefs.getAlternativeShippingName(cart.getAltShipping()));
  order.setRequiresShipping(requiresShipping);
  order.setInsure(cart.isInsure());
  order.setInsurance(ShoppingUtil.calculateInsurance(items));
  order.setCouponIds(cart.getCouponIds());
  order.setCouponDiscount(ShoppingUtil.calculateCouponDiscount(items,order.getBillingState(),cart.getCoupon()));
  order.setSendOrderEmail(true);
  order.setSendShippingEmail(true);
  ShoppingOrderUtil.update(order);
  return order;
}
