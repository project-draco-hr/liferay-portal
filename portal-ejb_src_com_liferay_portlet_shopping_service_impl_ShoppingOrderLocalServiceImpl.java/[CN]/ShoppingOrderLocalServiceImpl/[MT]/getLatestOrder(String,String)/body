{
  List orders=ShoppingOrderUtil.findByG_U_PPPS(groupId,userId,ShoppingOrder.STATUS_LATEST,0,1);
  ShoppingOrder order=null;
  if (orders.size() == 1) {
    order=(ShoppingOrder)orders.get(0);
  }
 else {
    User user=UserUtil.findByPrimaryKey(userId);
    Date now=new Date();
    List pastOrders=ShoppingOrderUtil.findByG_U_PPPS(groupId,userId,ShoppingOrder.STATUS_CHECKOUT,0,1);
    if (pastOrders.size() == 1) {
      ShoppingOrder pastOrder=(ShoppingOrder)pastOrders.get(0);
      order=(ShoppingOrder)pastOrder.clone();
    }
    String orderId=getOrderId();
    if (order == null) {
      order=ShoppingOrderUtil.create(orderId);
    }
 else {
      order.setOrderId(orderId);
    }
    order.setGroupId(groupId);
    order.setCompanyId(user.getCompanyId());
    order.setUserId(user.getUserId());
    order.setUserName(user.getFullName());
    order.setCreateDate(now);
    order.setModifiedDate(now);
    order.setBillingFirstName(user.getFirstName());
    order.setBillingLastName(user.getLastName());
    order.setBillingEmailAddress(user.getEmailAddress());
    order.setShippingFirstName(user.getFirstName());
    order.setShippingLastName(user.getLastName());
    order.setShippingEmailAddress(user.getEmailAddress());
    order.setCcName(user.getFullName());
    order.setPpPaymentStatus(ShoppingOrder.STATUS_LATEST);
    order.setSendOrderEmail(true);
    order.setSendShippingEmail(true);
    ShoppingOrderUtil.update(order);
  }
  return order;
}
