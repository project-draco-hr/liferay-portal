{
  try {
    User user=null;
    long companyId=ParamUtil.getLong(request,"companyId");
    String remoteUser=request.getRemoteUser();
    if (_log.isDebugEnabled()) {
      _log.debug("Remote user " + remoteUser);
    }
    if (remoteUser != null) {
      PrincipalThreadLocal.setName(remoteUser);
      long userId=GetterUtil.getLong(remoteUser);
      user=UserLocalServiceUtil.getUserById(userId);
      if (companyId == 0) {
        companyId=user.getCompanyId();
      }
    }
 else {
      if (companyId == 0) {
        companyId=PortalInstances.getCompanyId(request);
      }
      if (companyId != 0) {
        user=UserLocalServiceUtil.getDefaultUser(companyId);
      }
    }
    if (user != null) {
      PermissionChecker permissionChecker=PermissionCheckerFactoryUtil.create(user,true);
      PermissionThreadLocal.setPermissionChecker(permissionChecker);
    }
    CompanyThreadLocal.setCompanyId(companyId);
    super.service(request,response);
  }
 catch (  Exception e) {
    throw new ServletException(e);
  }
}
