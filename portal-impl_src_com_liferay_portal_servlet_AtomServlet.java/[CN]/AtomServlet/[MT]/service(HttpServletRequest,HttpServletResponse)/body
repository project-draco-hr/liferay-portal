{
  try {
    UserCompanyResolver userCompanyResolver=new UserCompanyResolver(request);
    User user=userCompanyResolver.getUser();
    if (user != null) {
      if (_log.isDebugEnabled()) {
        _log.debug("User " + user.getUserId());
      }
      PermissionChecker permissionChecker=PermissionCheckerFactoryUtil.create(user,true);
      PermissionThreadLocal.setPermissionChecker(permissionChecker);
      AtomUtil.saveUserInRequest(request,user);
    }
    long companyId=userCompanyResolver.getCompanyId();
    CompanyThreadLocal.setCompanyId(companyId);
    super.service(request,response);
  }
 catch (  Exception e) {
    throw new ServletException(e);
  }
}
