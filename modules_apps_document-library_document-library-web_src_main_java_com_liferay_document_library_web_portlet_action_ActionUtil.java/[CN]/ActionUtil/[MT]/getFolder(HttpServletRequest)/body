{
  ThemeDisplay themeDisplay=(ThemeDisplay)request.getAttribute(WebKeys.THEME_DISPLAY);
  long folderId=ParamUtil.getLong(request,"folderId");
  boolean ignoreRootFolder=ParamUtil.getBoolean(request,"ignoreRootFolder");
  if ((folderId <= 0) && !ignoreRootFolder) {
    PortletDisplay portletDisplay=themeDisplay.getPortletDisplay();
    String portletId=portletDisplay.getId();
    PortletPreferences portletPreferences=PortletPreferencesFactoryUtil.getPortletPreferences(request,portletId);
    folderId=GetterUtil.getLong(portletPreferences.getValue("rootFolderId",null));
  }
  Folder folder=null;
  if (folderId > 0) {
    folder=DLAppServiceUtil.getFolder(folderId);
    if (folder.getModel() instanceof DLFolder) {
      DLFolder dlFolder=(DLFolder)folder.getModel();
      if (dlFolder.isInTrash()) {
        throw new NoSuchFolderException("{folderId=" + folderId + "}");
      }
    }
  }
 else {
    DLPermission.check(themeDisplay.getPermissionChecker(),themeDisplay.getScopeGroupId(),ActionKeys.VIEW);
  }
  return folder;
}
