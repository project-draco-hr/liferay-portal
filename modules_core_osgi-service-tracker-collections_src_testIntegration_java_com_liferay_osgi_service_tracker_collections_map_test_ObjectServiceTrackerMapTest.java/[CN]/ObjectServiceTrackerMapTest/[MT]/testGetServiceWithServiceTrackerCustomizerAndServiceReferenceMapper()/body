{
  ServiceTrackerMap<String,TrackedTwo> serviceTrackerMap=ServiceTrackerMapFactory.singleValueMap(_bundleContext,TrackedOne.class,("(target=*)"),new ServiceReferenceMapper<String,TrackedOne>(){
    @Override public void map(    ServiceReference<TrackedOne> serviceReference,    Emitter<String> emitter){
      TrackedOne trackedOne=_bundleContext.getService(serviceReference);
      emitter.emit(serviceReference.getProperty("target") + "-" + trackedOne.getKey());
      _bundleContext.ungetService(serviceReference);
    }
  }
,new ServiceTrackerCustomizer<TrackedOne,TrackedTwo>(){
    @Override public TrackedTwo addingService(    ServiceReference<TrackedOne> serviceReference){
      return new TrackedTwo(_bundleContext.getService(serviceReference));
    }
    @Override public void modifiedService(    ServiceReference<TrackedOne> serviceReference,    TrackedTwo trackedTwo){
      removedService(serviceReference,trackedTwo);
    }
    @Override public void removedService(    ServiceReference<TrackedOne> serviceReference,    TrackedTwo trackedTwo){
      _bundleContext.ungetService(serviceReference);
    }
  }
);
  serviceTrackerMap.open();
  TrackedOne trackedOne1=new TrackedOne("1");
  registerService(trackedOne1,"one");
  TrackedOne trackedOne2=new TrackedOne("2");
  registerService(trackedOne2,"two");
  TrackedTwo trackedTwo1=serviceTrackerMap.getService("one-1");
  Assert.assertEquals(trackedOne1,trackedTwo1.getTrackedOne());
  TrackedTwo trackedTwo2=serviceTrackerMap.getService("two-2");
  Assert.assertEquals(trackedOne2,trackedTwo2.getTrackedOne());
  serviceTrackerMap.close();
}
