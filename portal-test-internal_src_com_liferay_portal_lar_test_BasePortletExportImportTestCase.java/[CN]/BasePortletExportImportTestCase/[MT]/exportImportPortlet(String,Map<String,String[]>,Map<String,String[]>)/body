{
  User user=TestPropsValues.getUser();
  MapUtil.merge(getExportParameterMap(),exportParameterMap);
  Map<String,Serializable> settingsMap=ExportImportConfigurationSettingsMapFactory.buildExportSettingsMap(user.getUserId(),layout.getPlid(),layout.getGroupId(),portletId,exportParameterMap,user.getLocale(),user.getTimeZone(),StringPool.BLANK);
  ExportImportConfiguration exportImportConfiguration=ExportImportConfigurationLocalServiceUtil.addExportImportConfiguration(user.getUserId(),layout.getGroupId(),StringPool.BLANK,StringPool.BLANK,ExportImportConfigurationConstants.TYPE_EXPORT_PORTLET,settingsMap,WorkflowConstants.STATUS_DRAFT,new ServiceContext());
  ExportImportThreadLocal.setPortletStagingInProcess(true);
  try {
    larFile=ExportImportLocalServiceUtil.exportPortletInfoAsFile(exportImportConfiguration);
    importedLayout=LayoutTestUtil.addLayout(importedGroup);
    MapUtil.merge(getImportParameterMap(),importParameterMap);
    settingsMap=ExportImportConfigurationSettingsMapFactory.buildImportSettingsMap(user.getUserId(),importedLayout.getPlid(),importedGroup.getGroupId(),portletId,importParameterMap,user.getLocale(),user.getTimeZone(),StringPool.BLANK);
    exportImportConfiguration=ExportImportConfigurationLocalServiceUtil.addExportImportConfiguration(user.getUserId(),importedGroup.getGroupId(),StringPool.BLANK,StringPool.BLANK,ExportImportConfigurationConstants.TYPE_IMPORT_PORTLET,settingsMap,WorkflowConstants.STATUS_DRAFT,new ServiceContext());
    ExportImportLocalServiceUtil.importPortletDataDeletions(exportImportConfiguration,larFile);
    ExportImportLocalServiceUtil.importPortletInfo(exportImportConfiguration,larFile);
  }
  finally {
    ExportImportThreadLocal.setPortletStagingInProcess(false);
  }
}
