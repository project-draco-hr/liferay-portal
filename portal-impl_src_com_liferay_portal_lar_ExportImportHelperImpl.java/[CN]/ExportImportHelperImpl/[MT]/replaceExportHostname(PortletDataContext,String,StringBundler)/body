{
  Group group=GroupLocalServiceUtil.getGroup(portletDataContext.getScopeGroupId());
  if (!HttpUtil.hasProtocol(url) || !group.isStagingGroup()) {
    return url;
  }
  boolean isSecureUrl=HttpUtil.isSecure(url);
  int portalPort=PortalUtil.getPortalPort(isSecureUrl);
  if (portalPort == -1) {
    return url;
  }
  LayoutSet publicLayoutSet=group.getPublicLayoutSet();
  String publicLayoutSetVirtualHostname=publicLayoutSet.getVirtualHostname();
  String portalUrl=StringPool.BLANK;
  if (Validator.isNotNull(publicLayoutSetVirtualHostname)) {
    portalUrl=PortalUtil.getPortalURL(publicLayoutSetVirtualHostname,portalPort,isSecureUrl);
    if (url.startsWith(portalUrl)) {
      if (isSecureUrl) {
        urlSB.append(_DATA_HANDLER_PUBLIC_LAYOUT_SET_SECURE_URL);
      }
 else {
        urlSB.append(_DATA_HANDLER_PUBLIC_LAYOUT_SET_URL);
      }
      return url.substring(portalUrl.length());
    }
  }
  LayoutSet privateLayoutSet=group.getPrivateLayoutSet();
  String privateLayoutSetVirtualHostname=privateLayoutSet.getVirtualHostname();
  if (Validator.isNotNull(privateLayoutSetVirtualHostname)) {
    portalUrl=PortalUtil.getPortalURL(privateLayoutSetVirtualHostname,portalPort,isSecureUrl);
    if (url.startsWith(portalUrl)) {
      if (isSecureUrl) {
        urlSB.append(_DATA_HANDLER_PRIVATE_LAYOUT_SET_SECURE_URL);
      }
 else {
        urlSB.append(_DATA_HANDLER_PRIVATE_LAYOUT_SET_URL);
      }
      return url.substring(portalUrl.length());
    }
  }
  Company company=CompanyLocalServiceUtil.getCompany(group.getCompanyId());
  String companyVirtualHostname=company.getVirtualHostname();
  if (Validator.isNotNull(companyVirtualHostname)) {
    portalUrl=PortalUtil.getPortalURL(companyVirtualHostname,portalPort,isSecureUrl);
    if (url.startsWith(portalUrl)) {
      if (isSecureUrl) {
        urlSB.append(_DATA_HANDLER_COMPANY_SECURE_URL);
      }
 else {
        urlSB.append(_DATA_HANDLER_COMPANY_URL);
      }
      return url.substring(portalUrl.length());
    }
  }
  portalUrl=PortalUtil.getPortalURL("localhost",portalPort,isSecureUrl);
  if (url.startsWith(portalUrl)) {
    return url.substring(portalUrl.length());
  }
  return url;
}
