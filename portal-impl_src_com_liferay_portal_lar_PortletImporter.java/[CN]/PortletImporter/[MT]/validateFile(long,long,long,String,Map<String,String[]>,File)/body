{
  ZipReader zipReader=ZipReaderFactoryUtil.getZipReader(file);
  try {
    ExportImportThreadLocal.setPortletValidationInProcess(true);
    Layout layout=LayoutLocalServiceUtil.getLayout(plid);
    validateFile(layout.getCompanyId(),groupId,portletId,zipReader);
    String userIdStrategyString=MapUtil.getString(parameterMap,PortletDataHandlerKeys.USER_ID_STRATEGY);
    UserIdStrategy userIdStrategy=ExportImportHelperUtil.getUserIdStrategy(userId,userIdStrategyString);
    PortletDataContext portletDataContext=PortletDataContextFactoryUtil.createImportPortletDataContext(layout.getCompanyId(),groupId,parameterMap,userIdStrategy,zipReader);
    portletDataContext.setPrivateLayout(layout.isPrivateLayout());
    MissingReferences missingReferences=ExportImportHelperUtil.validateMissingReferences(portletDataContext);
    Map<String,MissingReference> dependencyMissingReferences=missingReferences.getDependencyMissingReferences();
    if (!dependencyMissingReferences.isEmpty()) {
      throw new MissingReferenceException(missingReferences);
    }
    return missingReferences;
  }
  finally {
    ExportImportThreadLocal.setPortletValidationInProcess(false);
    zipReader.close();
  }
}
