{
  boolean deletePortletData=MapUtil.getBoolean(parameterMap,PortletDataHandlerKeys.DELETE_PORTLET_DATA);
  boolean importPermissions=MapUtil.getBoolean(parameterMap,PortletDataHandlerKeys.PERMISSIONS);
  boolean importPortletData=MapUtil.getBoolean(parameterMap,PortletDataHandlerKeys.PORTLET_DATA);
  boolean importPortletDataAll=MapUtil.getBoolean(parameterMap,PortletDataHandlerKeys.PORTLET_DATA_ALL);
  boolean importPortletArchivedSetups=MapUtil.getBoolean(parameterMap,PortletDataHandlerKeys.PORTLET_ARCHIVED_SETUPS);
  boolean importPortletSetup=MapUtil.getBoolean(parameterMap,PortletDataHandlerKeys.PORTLET_SETUP);
  boolean importPortletSetupAll=MapUtil.getBoolean(parameterMap,PortletDataHandlerKeys.PORTLET_SETUP_ALL);
  boolean importPortletUserPreferences=MapUtil.getBoolean(parameterMap,PortletDataHandlerKeys.PORTLET_USER_PREFERENCES);
  String userIdStrategyString=MapUtil.getString(parameterMap,PortletDataHandlerKeys.USER_ID_STRATEGY);
  String rootPortletId=PortletConstants.getRootPortletId(portletId);
  if (importPortletDataAll) {
    importPortletData=true;
  }
 else   if (parameterMap.containsKey(PortletDataHandlerKeys.PORTLET_DATA + "_" + rootPortletId)) {
    importPortletData=MapUtil.getBoolean(parameterMap,PortletDataHandlerKeys.PORTLET_DATA + "_" + PortletConstants.getRootPortletId(portletId));
  }
  if (importPortletSetupAll) {
    importPortletSetup=true;
  }
 else   if (parameterMap.containsKey(PortletDataHandlerKeys.PORTLET_SETUP + "_" + rootPortletId)) {
    importPortletSetup=MapUtil.getBoolean(parameterMap,PortletDataHandlerKeys.PORTLET_SETUP + "_" + rootPortletId);
  }
  StopWatch stopWatch=null;
  if (_log.isInfoEnabled()) {
    stopWatch=new StopWatch();
    stopWatch.start();
  }
  Layout layout=LayoutLocalServiceUtil.getLayout(plid);
  User user=UserUtil.findByPrimaryKey(userId);
  UserIdStrategy userIdStrategy=getUserIdStrategy(user,userIdStrategyString);
  ZipReader zipReader=ZipReaderFactoryUtil.getZipReader(file);
  PortletDataContext portletDataContext=PortletDataContextFactoryUtil.createImportPortletDataContext(layout.getCompanyId(),groupId,parameterMap,userIdStrategy,zipReader);
  portletDataContext.setPortetDataContextListener(new PortletDataContextListenerImpl(portletDataContext));
  portletDataContext.setPlid(plid);
  portletDataContext.setPrivateLayout(layout.isPrivateLayout());
  validateFile(portletDataContext,portletId);
  long sourceCompanyId=GetterUtil.getLong(_headerElement.attributeValue("company-id"));
  portletDataContext.setSourceCompanyId(sourceCompanyId);
  long sourceCompanyGroupId=GetterUtil.getLong(_headerElement.attributeValue("company-group-id"));
  portletDataContext.setSourceCompanyGroupId(sourceCompanyGroupId);
  long sourceGroupId=GetterUtil.getLong(_headerElement.attributeValue("group-id"));
  portletDataContext.setSourceGroupId(sourceGroupId);
  long sourceUserPersonalSiteGroupId=GetterUtil.getLong(_headerElement.attributeValue("user-personal-site-group-id"));
  portletDataContext.setSourceUserPersonalSiteGroupId(sourceUserPersonalSiteGroupId);
  if (importPermissions) {
    _permissionImporter.readPortletDataPermissions(portletDataContext);
  }
  readAssetCategories(portletDataContext);
  readAssetTags(portletDataContext);
  readComments(portletDataContext);
  readExpandoTables(portletDataContext);
  readLocks(portletDataContext);
  readRatingsEntries(portletDataContext);
  if (_log.isDebugEnabled()) {
    _log.debug("Deleting portlet data");
  }
  if (deletePortletData) {
    deletePortletData(portletDataContext,portletId,plid);
  }
  Element portletElement=null;
  try {
    portletElement=_rootElement.element("portlet");
    Document portletDocument=SAXReaderUtil.read(portletDataContext.getZipEntryAsString(portletElement.attributeValue("path")));
    portletElement=portletDocument.getRootElement();
  }
 catch (  DocumentException de) {
    throw new SystemException(de);
  }
  setPortletScope(portletDataContext,portletElement);
  Element portletDataElement=portletElement.element("portlet-data");
  boolean importData=importPortletData && (portletDataElement != null);
  try {
    importPortletPreferences(portletDataContext,layout.getCompanyId(),groupId,layout,portletId,portletElement,importPortletSetup,importPortletArchivedSetups,importPortletUserPreferences,true,importData);
    if (importData) {
      if (_log.isDebugEnabled()) {
        _log.debug("Importing portlet data");
      }
      importPortletData(portletDataContext,portletId,plid,portletDataElement);
    }
  }
  finally {
    resetPortletScope(portletDataContext,groupId);
  }
  if (importPermissions) {
    if (_log.isDebugEnabled()) {
      _log.debug("Importing portlet permissions");
    }
    LayoutCache layoutCache=new LayoutCache();
    _permissionImporter.importPortletPermissions(layoutCache,layout.getCompanyId(),groupId,userId,layout,portletElement,portletId);
    if (userId > 0) {
      Indexer indexer=IndexerRegistryUtil.nullSafeGetIndexer(User.class);
      indexer.reindex(userId);
    }
  }
  if (_log.isDebugEnabled()) {
    _log.debug("Importing asset links");
  }
  readAssetLinks(portletDataContext);
  if (_log.isInfoEnabled()) {
    _log.info("Importing portlet takes " + stopWatch.getTime() + " ms");
  }
  zipReader.close();
}
