{
  boolean deletePortletData=MapUtil.getBoolean(parameterMap,PortletDataHandlerKeys.DELETE_PORTLET_DATA);
  boolean importPermissions=MapUtil.getBoolean(parameterMap,PortletDataHandlerKeys.PERMISSIONS);
  String userIdStrategyString=MapUtil.getString(parameterMap,PortletDataHandlerKeys.USER_ID_STRATEGY);
  StopWatch stopWatch=null;
  if (_log.isInfoEnabled()) {
    stopWatch=new StopWatch();
    stopWatch.start();
  }
  User user=UserUtil.findByPrimaryKey(userId);
  ServiceContext serviceContext=ServiceContextThreadLocal.getServiceContext();
  if (serviceContext == null) {
    serviceContext=new ServiceContext();
    serviceContext.setCompanyId(user.getCompanyId());
    serviceContext.setSignedIn(false);
    serviceContext.setUserId(userId);
    ServiceContextThreadLocal.pushServiceContext(serviceContext);
  }
  Layout layout=LayoutLocalServiceUtil.getLayout(plid);
  UserIdStrategy userIdStrategy=getUserIdStrategy(user,userIdStrategyString);
  ZipReader zipReader=ZipReaderFactoryUtil.getZipReader(file);
  PortletDataContext portletDataContext=PortletDataContextFactoryUtil.createImportPortletDataContext(layout.getCompanyId(),groupId,parameterMap,userIdStrategy,zipReader);
  portletDataContext.setPortetDataContextListener(new PortletDataContextListenerImpl(portletDataContext));
  portletDataContext.setPlid(plid);
  portletDataContext.setPrivateLayout(layout.isPrivateLayout());
  validateFile(portletDataContext,portletId);
  if (BackgroundTaskThreadLocal.hasBackgroundTask()) {
    ManifestSummary manifestSummary=ExportImportHelperUtil.getManifestSummary(userId,groupId,parameterMap,file);
    PortletDataHandlerStatusMessageSenderUtil.sendStatusMessage("portlet",portletId,manifestSummary);
  }
  long sourceCompanyId=GetterUtil.getLong(_headerElement.attributeValue("company-id"));
  portletDataContext.setSourceCompanyId(sourceCompanyId);
  long sourceCompanyGroupId=GetterUtil.getLong(_headerElement.attributeValue("company-group-id"));
  portletDataContext.setSourceCompanyGroupId(sourceCompanyGroupId);
  long sourceGroupId=GetterUtil.getLong(_headerElement.attributeValue("group-id"));
  portletDataContext.setSourceGroupId(sourceGroupId);
  long sourceUserPersonalSiteGroupId=GetterUtil.getLong(_headerElement.attributeValue("user-personal-site-group-id"));
  portletDataContext.setSourceUserPersonalSiteGroupId(sourceUserPersonalSiteGroupId);
  Element portletElement=null;
  try {
    portletElement=_rootElement.element("portlet");
    Document portletDocument=SAXReaderUtil.read(portletDataContext.getZipEntryAsString(portletElement.attributeValue("path")));
    portletElement=portletDocument.getRootElement();
  }
 catch (  DocumentException de) {
    throw new SystemException(de);
  }
  LayoutCache layoutCache=new LayoutCache();
  if (importPermissions) {
    _permissionImporter.checkRoles(layoutCache,layout.getCompanyId(),groupId,userId,portletElement);
    _permissionImporter.readPortletDataPermissions(portletDataContext);
  }
  readAssetCategories(portletDataContext);
  readAssetTags(portletDataContext);
  readComments(portletDataContext);
  readExpandoTables(portletDataContext);
  readLocks(portletDataContext);
  readRatingsEntries(portletDataContext);
  if (_log.isDebugEnabled()) {
    _log.debug("Deleting portlet data");
  }
  if (deletePortletData) {
    deletePortletData(portletDataContext,portletId,plid);
  }
  Element portletDataElement=portletElement.element("portlet-data");
  boolean[] importPortletControls=ExportImportHelperUtil.getImportPortletControls(layout.getCompanyId(),portletId,parameterMap,portletDataElement);
  try {
    importPortletPreferences(portletDataContext,layout.getCompanyId(),groupId,layout,portletId,portletElement,true,importPortletControls[0],importPortletControls[1],importPortletControls[2],importPortletControls[3]);
    if (importPortletControls[1]) {
      if (_log.isDebugEnabled()) {
        _log.debug("Importing portlet data");
      }
      importPortletData(portletDataContext,portletId,plid,portletDataElement);
    }
  }
  finally {
    resetPortletScope(portletDataContext,groupId);
  }
  if (importPermissions) {
    if (_log.isDebugEnabled()) {
      _log.debug("Importing portlet permissions");
    }
    _permissionImporter.importPortletPermissions(layoutCache,layout.getCompanyId(),groupId,userId,layout,portletElement,portletId);
    if (userId > 0) {
      Indexer indexer=IndexerRegistryUtil.nullSafeGetIndexer(User.class);
      indexer.reindex(userId);
    }
  }
  if (_log.isDebugEnabled()) {
    _log.debug("Importing asset links");
  }
  readAssetLinks(portletDataContext);
  _deletionSystemEventImporter.importDeletionSystemEvents(portletDataContext);
  if (_log.isInfoEnabled()) {
    _log.info("Importing portlet takes " + stopWatch.getTime() + " ms");
  }
  zipReader.close();
}
