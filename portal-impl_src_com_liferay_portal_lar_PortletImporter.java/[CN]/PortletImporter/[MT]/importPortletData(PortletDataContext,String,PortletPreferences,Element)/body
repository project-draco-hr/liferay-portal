{
  Portlet portlet=PortletLocalServiceUtil.getPortletById(context.getCompanyId(),portletId);
  if (portlet == null) {
    if (_log.isDebugEnabled()) {
      _log.debug("Do not import portlet data for " + portletId + " because the portlet does not exist");
    }
    return null;
  }
  PortletDataHandler portletDataHandler=portlet.getPortletDataHandlerInstance();
  if (portletDataHandler == null) {
    if (_log.isDebugEnabled()) {
      _log.debug("Do not import portlet data for " + portletId + " because the portlet does not have a "+ "PortletDataHandler");
    }
    return null;
  }
  if (_log.isDebugEnabled()) {
    _log.debug("Importing data for " + portletId);
  }
  long groupId=context.getGroupId();
  Group scopeGroup=null;
  String scopeLayoutUuid=context.getScopeLayoutUuid();
  String scopeType=context.getScopeType();
  if (Validator.isNull(scopeType)) {
    scopeLayoutUuid=GetterUtil.getString(portletDataRefEl.getParent().attributeValue("scope-layout-uuid"));
  }
  try {
    if (scopeType.equals(GroupConstants.GLOBAL)) {
      scopeGroup=GroupLocalServiceUtil.getCompanyGroup(context.getCompanyId());
    }
 else     if (Validator.isNotNull(scopeLayoutUuid)) {
      Layout scopeLayout=LayoutLocalServiceUtil.getLayoutByUuidAndGroupId(scopeLayoutUuid,groupId);
      scopeGroup=null;
      if (scopeLayout.hasScopeGroup()) {
        scopeGroup=scopeLayout.getScopeGroup();
      }
 else {
        String name=String.valueOf(scopeLayout.getPlid());
        scopeGroup=GroupLocalServiceUtil.addGroup(context.getUserId(null),Layout.class.getName(),scopeLayout.getPlid(),name,null,0,null,true,null);
      }
      Group group=scopeLayout.getGroup();
      if (group.isStaged() && !group.isStagedRemotely()) {
        try {
          Layout oldLayout=LayoutLocalServiceUtil.getLayoutByUuidAndGroupId(scopeLayoutUuid,context.getSourceGroupId());
          Group oldScopeGroup=oldLayout.getScopeGroup();
          oldScopeGroup.setLiveGroupId(scopeGroup.getGroupId());
          GroupLocalServiceUtil.updateGroup(oldScopeGroup,true);
        }
 catch (        NoSuchLayoutException nsle) {
          if (_log.isWarnEnabled()) {
            _log.warn(nsle);
          }
        }
      }
      context.setScopeGroupId(scopeGroup.getGroupId());
    }
  }
 catch (  PortalException pe) {
  }
  PortletPreferencesImpl portletPreferencesImpl=null;
  if (portletPreferences != null) {
    portletPreferencesImpl=(PortletPreferencesImpl)PortletPreferencesFactoryUtil.fromDefaultXML(portletPreferences.getPreferences());
  }
  String portletData=context.getZipEntryAsString(portletDataRefEl.attributeValue("path"));
  try {
    SocialActivityThreadLocal.setEnabled(false);
    WorkflowThreadLocal.setEnabled(false);
    portletPreferencesImpl=(PortletPreferencesImpl)portletDataHandler.importData(context,portletId,portletPreferencesImpl,portletData);
  }
 catch (  Exception e) {
    _log.error(e,e);
    throw new SystemException(e);
  }
 finally {
    context.setScopeGroupId(groupId);
    SocialActivityThreadLocal.setEnabled(true);
    WorkflowThreadLocal.setEnabled(true);
  }
  if (portletPreferencesImpl == null) {
    return null;
  }
  return PortletPreferencesFactoryUtil.toXML(portletPreferencesImpl);
}
