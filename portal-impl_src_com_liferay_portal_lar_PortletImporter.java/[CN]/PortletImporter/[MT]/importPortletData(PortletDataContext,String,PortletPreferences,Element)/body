{
  Portlet portlet=PortletLocalServiceUtil.getPortletById(context.getCompanyId(),portletId);
  if (portlet == null) {
    if (_log.isDebugEnabled()) {
      _log.debug("Do not import portlet data for " + portletId + " because the portlet does not exist");
    }
    return null;
  }
  String portletDataHandlerClass=portlet.getPortletDataHandlerClass();
  if (Validator.isNull(portletDataHandlerClass)) {
    if (_log.isDebugEnabled()) {
      _log.debug("Do not import portlet data for " + portletId + " because the portlet does not have a "+ "PortletDataHandler");
    }
    return null;
  }
  if (_log.isDebugEnabled()) {
    _log.debug("Importing data for " + portletId);
  }
  long groupId=context.getGroupId();
  long scopeLayoutId=context.getScopeLayoutId();
  if (scopeLayoutId > 0) {
    scopeLayoutId=GetterUtil.getLong(portletDataRefEl.getParent().attributeValue("scope-layout-id"));
  }
  if (scopeLayoutId > 0) {
    try {
      Layout scopeLayout=LayoutLocalServiceUtil.getLayout(context.getGroupId(),context.isPrivateLayout(),scopeLayoutId);
      if (scopeLayout.hasScopeGroup()) {
        Group scopeGroup=scopeLayout.getScopeGroup();
        context.setGroupId(scopeGroup.getGroupId());
      }
    }
 catch (    PortalException pe) {
    }
  }
  PortletPreferencesImpl preferencesImpl=null;
  if (portletPreferences != null) {
    preferencesImpl=(PortletPreferencesImpl)PortletPreferencesSerializer.fromDefaultXML(portletPreferences.getPreferences());
  }
  String portletData=context.getZipEntryAsString(portletDataRefEl.attributeValue("path"));
  try {
    preferencesImpl=(PortletPreferencesImpl)PortletClassInvoker.invoke(portletId,portletDataHandlerClass,"importData",context,portletId,preferencesImpl,portletData);
  }
 catch (  Exception e) {
    throw new SystemException(e);
  }
 finally {
    context.setGroupId(groupId);
  }
  if (preferencesImpl == null) {
    return null;
  }
  return PortletPreferencesSerializer.toXML(preferencesImpl);
}
