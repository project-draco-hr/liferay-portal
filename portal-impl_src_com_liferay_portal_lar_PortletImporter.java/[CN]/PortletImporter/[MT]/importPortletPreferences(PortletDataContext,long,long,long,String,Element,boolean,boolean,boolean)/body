{
  long defaultUserId=UserLocalServiceUtil.getDefaultUserId(companyId);
  List<Element> prefsEls=parentEl.elements("portlet-preference");
  for (  Element prefEl : prefsEls) {
    String path=prefEl.attributeValue("path");
    if (context.isPathNotProcessed(path)) {
      Element el=null;
      String preferences=null;
      try {
        preferences=context.getZipEntryAsString(path);
        Document prefsDoc=DocumentUtil.readDocumentFromXML(preferences);
        el=prefsDoc.getRootElement();
      }
 catch (      DocumentException de) {
        throw new SystemException(de);
      }
      long ownerId=GetterUtil.getLong(el.attributeValue("owner-id"));
      int ownerType=GetterUtil.getInteger(el.attributeValue("owner-type"));
      if (ownerType == PortletKeys.PREFS_OWNER_TYPE_COMPANY) {
        continue;
      }
      if (((ownerType == PortletKeys.PREFS_OWNER_TYPE_GROUP) || (ownerType == PortletKeys.PREFS_OWNER_TYPE_LAYOUT)) && !importPortletSetup) {
        continue;
      }
      if ((ownerType == PortletKeys.PREFS_OWNER_TYPE_ARCHIVED) && !importPortletArchivedSetups) {
        continue;
      }
      if ((ownerType == PortletKeys.PREFS_OWNER_TYPE_USER) && (ownerId != PortletKeys.PREFS_OWNER_ID_DEFAULT) && !importUserPreferences) {
        continue;
      }
      if (ownerType == PortletKeys.PREFS_OWNER_TYPE_GROUP) {
        plid=PortletKeys.PREFS_PLID_SHARED;
        ownerId=context.getGroupId();
      }
      boolean defaultUser=GetterUtil.getBoolean(el.attributeValue("default-user"));
      if (portletId == null) {
        portletId=el.attributeValue("portlet-id");
      }
      if (ownerType == PortletKeys.PREFS_OWNER_TYPE_ARCHIVED) {
        String userUuid=el.attributeValue("archive-user-uuid");
        String name=el.attributeValue("archive-name");
        long userId=context.getUserId(userUuid);
        PortletItem portletItem=PortletItemLocalServiceUtil.updatePortletItem(userId,groupId,name,portletId,PortletPreferences.class.getName());
        plid=0;
        ownerId=portletItem.getPortletItemId();
      }
      if (defaultUser) {
        ownerId=defaultUserId;
      }
      PortletPreferences prefs=PortletPreferencesUtil.fetchByO_O_P_P(ownerId,ownerType,plid,portletId);
      if (prefs != null) {
        PortletPreferencesLocalServiceUtil.deletePortletPreferences(ownerId,ownerType,plid,portletId);
      }
      long portletPreferencesId=CounterLocalServiceUtil.increment();
      PortletPreferences portletPreferences=PortletPreferencesUtil.create(portletPreferencesId);
      portletPreferences.setOwnerId(ownerId);
      portletPreferences.setOwnerType(ownerType);
      portletPreferences.setPlid(plid);
      portletPreferences.setPortletId(portletId);
      portletPreferences.setPreferences(preferences);
      PortletPreferencesUtil.update(portletPreferences,true);
    }
  }
}
