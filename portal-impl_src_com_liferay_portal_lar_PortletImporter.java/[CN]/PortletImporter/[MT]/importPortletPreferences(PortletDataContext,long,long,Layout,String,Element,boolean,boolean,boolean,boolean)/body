{
  long defaultUserId=UserLocalServiceUtil.getDefaultUserId(companyId);
  long plid=0;
  String scopeType=StringPool.BLANK;
  String scopeLayoutUuid=StringPool.BLANK;
  if (layout != null) {
    plid=layout.getPlid();
    if (preserveScopeLayoutId && (portletId != null)) {
      javax.portlet.PortletPreferences jxPreferences=PortletPreferencesFactoryUtil.getLayoutPortletSetup(layout,portletId);
      scopeType=GetterUtil.getString(jxPreferences.getValue("lfr-scope-type",null));
      scopeLayoutUuid=GetterUtil.getString(jxPreferences.getValue("lfrScopeLayoutUuid",null));
      portletDataContext.setScopeType(scopeType);
      portletDataContext.setScopeLayoutUuid(scopeLayoutUuid);
    }
  }
  List<Element> portletPreferencesElements=parentElement.elements("portlet-preferences");
  for (  Element portletPreferencesElement : portletPreferencesElements) {
    String path=portletPreferencesElement.attributeValue("path");
    if (portletDataContext.isPathNotProcessed(path)) {
      String xml=null;
      Element element=null;
      try {
        xml=portletDataContext.getZipEntryAsString(path);
        Document preferencesDocument=SAXReaderUtil.read(xml);
        element=preferencesDocument.getRootElement();
      }
 catch (      DocumentException de) {
        throw new SystemException(de);
      }
      long ownerId=GetterUtil.getLong(element.attributeValue("owner-id"));
      int ownerType=GetterUtil.getInteger(element.attributeValue("owner-type"));
      if (ownerType == PortletKeys.PREFS_OWNER_TYPE_COMPANY) {
        continue;
      }
      if (((ownerType == PortletKeys.PREFS_OWNER_TYPE_GROUP) || (ownerType == PortletKeys.PREFS_OWNER_TYPE_LAYOUT)) && !importPortletSetup) {
        continue;
      }
      if ((ownerType == PortletKeys.PREFS_OWNER_TYPE_ARCHIVED) && !importPortletArchivedSetups) {
        continue;
      }
      if ((ownerType == PortletKeys.PREFS_OWNER_TYPE_USER) && (ownerId != PortletKeys.PREFS_OWNER_ID_DEFAULT) && !importPortletUserPreferences) {
        continue;
      }
      if (ownerType == PortletKeys.PREFS_OWNER_TYPE_GROUP) {
        plid=PortletKeys.PREFS_PLID_SHARED;
        ownerId=portletDataContext.getScopeGroupId();
      }
      boolean defaultUser=GetterUtil.getBoolean(element.attributeValue("default-user"));
      if (portletId == null) {
        portletId=element.attributeValue("portlet-id");
      }
      if (ownerType == PortletKeys.PREFS_OWNER_TYPE_ARCHIVED) {
        portletId=PortletConstants.getRootPortletId(portletId);
        String userUuid=element.attributeValue("archive-user-uuid");
        String name=element.attributeValue("archive-name");
        long userId=portletDataContext.getUserId(userUuid);
        PortletItem portletItem=PortletItemLocalServiceUtil.updatePortletItem(userId,groupId,name,portletId,PortletPreferences.class.getName());
        plid=0;
        ownerId=portletItem.getPortletItemId();
      }
      if (defaultUser) {
        ownerId=defaultUserId;
      }
      String rootPotletId=PortletConstants.getRootPortletId(portletId);
      if (rootPotletId.equals(PortletKeys.ASSET_PUBLISHER)) {
        PortletPreferencesImpl portletPreferences=(PortletPreferencesImpl)PortletPreferencesFactoryUtil.fromXML(companyId,ownerId,ownerType,plid,portletId,xml);
        Enumeration<String> names=portletPreferences.getNames();
        while (names.hasMoreElements()) {
          String name=names.nextElement();
          String value=portletPreferences.getValue(name,null);
          String prefix="queryName";
          if ((value != null) && value.equalsIgnoreCase("assetCategories") && name.startsWith(prefix)) {
            String idx=name.substring(prefix.length(),name.length());
            String queryValuesName="queryValues" + idx;
            String[] importedCategoryPKs=portletPreferences.getValues(queryValuesName,null);
            Map<Long,Long> assetCategoryPKs=(Map<Long,Long>)portletDataContext.getNewPrimaryKeysMap(AssetCategory.class);
            String[] newCategoryPKs=new String[importedCategoryPKs.length];
            int i=0;
            for (            String importedCategoryPK : importedCategoryPKs) {
              newCategoryPKs[i++]=StringUtil.valueOf(assetCategoryPKs.get(new Long(importedCategoryPK)));
            }
            try {
              portletPreferences.setValues(queryValuesName,newCategoryPKs);
            }
 catch (            Exception e) {
              throw new PortalException(e);
            }
          }
        }
        xml=PortletPreferencesFactoryUtil.toXML(portletPreferences);
      }
      PortletPreferencesLocalServiceUtil.updatePreferences(ownerId,ownerType,plid,portletId,xml);
    }
  }
  if (preserveScopeLayoutId && (layout != null)) {
    javax.portlet.PortletPreferences jxPreferences=PortletPreferencesFactoryUtil.getLayoutPortletSetup(layout,portletId);
    try {
      jxPreferences.setValue("lfr-scope-type",scopeType);
      jxPreferences.setValue("lfrScopeLayoutUuid",scopeLayoutUuid);
      jxPreferences.store();
    }
  finally {
      portletDataContext.setScopeType(scopeType);
      portletDataContext.setScopeLayoutUuid(scopeLayoutUuid);
    }
  }
}
