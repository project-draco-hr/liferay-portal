{
  List items=new ArrayList();
  boolean successful=false;
  try {
    FileItemIterator iter=getItemIterator(ctx);
    FileItemFactory fac=getFileItemFactory();
    if (fac == null) {
      throw new NullPointerException("No FileItemFactory has been set.");
    }
    while (iter.hasNext()) {
      final FileItemStream item=iter.next();
      final String fileName=((org.apache.commons.fileupload.FileUploadBase.FileItemIteratorImpl.FileItemStreamImpl)item).name;
      FileItem fileItem=fac.createItem(item.getFieldName(),item.getContentType(),item.isFormField(),fileName);
      items.add(fileItem);
      try {
        Streams.copy(item.openStream(),fileItem.getOutputStream(),true);
      }
 catch (      FileUploadIOException e) {
        throw (FileUploadException)e.getCause();
      }
catch (      IOException e) {
        throw new IOFileUploadException("Processing of " + MULTIPART_FORM_DATA + " request failed. "+ e.getMessage(),e);
      }
      if (fileItem instanceof FileItemHeadersSupport) {
        final FileItemHeaders fih=item.getHeaders();
        ((FileItemHeadersSupport)fileItem).setHeaders(fih);
      }
    }
    successful=true;
    return items;
  }
 catch (  FileUploadIOException e) {
    throw (FileUploadException)e.getCause();
  }
catch (  IOException e) {
    throw new FileUploadException(e.getMessage(),e);
  }
 finally {
    if (!successful) {
      for (Iterator iterator=items.iterator(); iterator.hasNext(); ) {
        FileItem fileItem=(FileItem)iterator.next();
        try {
          fileItem.delete();
        }
 catch (        Throwable e) {
        }
      }
    }
  }
}
