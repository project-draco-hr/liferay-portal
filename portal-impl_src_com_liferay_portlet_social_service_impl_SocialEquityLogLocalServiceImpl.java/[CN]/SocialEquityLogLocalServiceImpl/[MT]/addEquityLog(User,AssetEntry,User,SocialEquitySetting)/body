{
  int actionDate=getEquityDate();
  double k=getK(equitySetting.getValue(),equitySetting.getValidity());
  double b=getB(actionDate,equitySetting.getValue(),equitySetting.getValidity());
  if (equitySetting.getType() == SocialEquitySettingConstants.TYPE_INFORMATION) {
    int count=socialEquityAssetEntryPersistence.countByAssetEntryId(assetEntry.getEntryId());
    if (count == 0) {
      addSocialEquityAssetEntry(assetEntry);
    }
    updateSocialEquityAssetEntry_IQ(assetEntry.getEntryId(),actionDate,k,b);
    updateAssetEntry(assetEntry.getEntryId());
    assetEntryPersistence.clearCache(assetEntry);
    if (!assetEntryOwner.isDefaultUser()) {
      updateSocialEquityUser_CQ(assetEntry.getGroupId(),assetEntryOwner.getUserId());
      updateSocialEquityUser_PEQ(assetEntry.getGroupId(),assetEntryOwner.getUserId());
      updateUser_CQPQ(assetEntryOwner.getUserId());
      updateUser_PEQ(assetEntryOwner.getUserId());
      userPersistence.clearCache(assetEntryOwner);
    }
  }
 else   if (equitySetting.getType() == SocialEquitySettingConstants.TYPE_PARTICIPATION) {
    int count=socialEquityUserPersistence.countByUserId(user.getUserId());
    if (count == 0) {
      addSocialEquityUser(assetEntry.getGroupId(),user);
    }
    if (!user.isDefaultUser()) {
      updateSocialEquityUser_PQ(assetEntry.getGroupId(),user.getUserId(),actionDate,k,b);
      updateSocialEquityUser_PEQ(assetEntry.getGroupId(),user.getUserId());
      updateUser_CQPQ(user.getUserId());
      updateUser_PEQ(user.getUserId());
      userPersistence.clearCache(user);
    }
  }
  long equityLogId=counterLocalService.increment();
  SocialEquityLog equityLog=socialEquityLogPersistence.create(equityLogId);
  equityLog.setGroupId(assetEntry.getGroupId());
  equityLog.setCompanyId(user.getCompanyId());
  equityLog.setUserId(user.getUserId());
  equityLog.setAssetEntryId(assetEntry.getEntryId());
  equityLog.setActionId(equitySetting.getActionId());
  equityLog.setActionDate(actionDate);
  equityLog.setType(equitySetting.getType());
  equityLog.setValue(equitySetting.getValue());
  equityLog.setValidity(actionDate + equitySetting.getValidity());
  equityLog.setActive(true);
  socialEquityLogPersistence.update(equityLog,false);
}
