{
  String portletName=portletElement.elementText("portlet-name");
  String portletId=portletName;
  if (Validator.isNotNull(servletContextName)) {
    portletId=portletId.concat(PortletConstants.WAR_SEPARATOR).concat(servletContextName);
  }
  portletId=PortalUtil.getJsSafePortletId(portletId);
  if (portletId.length() > PortletInstance.PORTLET_INSTANCE_KEY_MAX_LENGTH) {
    throw new PortletIdException("Portlet ID " + portletId + " has more than "+ PortletInstance.PORTLET_INSTANCE_KEY_MAX_LENGTH+ " characters");
  }
  if (_log.isDebugEnabled()) {
    _log.debug("Reading portlet " + portletId);
  }
  Portlet portletModel=_portletsMap.get(portletId);
  if (portletModel == null) {
    portletModel=new PortletImpl(CompanyConstants.SYSTEM,portletId);
  }
  portletModel.setPluginPackage(pluginPackage);
  portletModel.setPortletApp(portletApp);
  portletModel.setPortletName(portletName);
  portletModel.setDisplayName(GetterUtil.getString(portletElement.elementText("display-name"),portletModel.getDisplayName()));
  portletModel.setPortletClass(GetterUtil.getString(portletElement.elementText("portlet-class")));
  Map<String,String> initParams=new HashMap<>();
  for (  Element initParamElement : portletElement.elements("init-param")) {
    initParams.put(initParamElement.elementText("name"),initParamElement.elementText("value"));
  }
  portletModel.setInitParams(initParams);
  Element expirationCacheElement=portletElement.element("expiration-cache");
  if (expirationCacheElement != null) {
    portletModel.setExpCache(GetterUtil.getInteger(expirationCacheElement.getText()));
  }
  Map<String,Set<String>> portletModes=new HashMap<>();
  Map<String,Set<String>> windowStates=new HashMap<>();
  for (  Element supportsElement : portletElement.elements("supports")) {
    String mimeType=supportsElement.elementText("mime-type");
    Set<String> mimeTypePortletModes=new HashSet<>();
    mimeTypePortletModes.add(StringUtil.toLowerCase(PortletMode.VIEW.toString()));
    for (    Element portletModeElement : supportsElement.elements("portlet-mode")) {
      mimeTypePortletModes.add(StringUtil.toLowerCase(portletModeElement.getTextTrim()));
    }
    portletModes.put(mimeType,mimeTypePortletModes);
    Set<String> mimeTypeWindowStates=new HashSet<>();
    mimeTypeWindowStates.add(StringUtil.toLowerCase(WindowState.NORMAL.toString()));
    List<Element> windowStateElements=supportsElement.elements("window-state");
    if (windowStateElements.isEmpty()) {
      mimeTypeWindowStates.add(StringUtil.toLowerCase(WindowState.MAXIMIZED.toString()));
      mimeTypeWindowStates.add(StringUtil.toLowerCase(WindowState.MINIMIZED.toString()));
      mimeTypeWindowStates.add(StringUtil.toLowerCase(LiferayWindowState.EXCLUSIVE.toString()));
      mimeTypeWindowStates.add(StringUtil.toLowerCase(LiferayWindowState.POP_UP.toString()));
    }
    for (    Element windowStateElement : windowStateElements) {
      mimeTypeWindowStates.add(StringUtil.toLowerCase(windowStateElement.getTextTrim()));
    }
    windowStates.put(mimeType,mimeTypeWindowStates);
  }
  portletModel.setPortletModes(portletModes);
  portletModel.setWindowStates(windowStates);
  Set<String> supportedLocales=new HashSet<>();
  for (  Element supportedLocaleElement : portletElement.elements("supported-locale")) {
    String supportedLocale=supportedLocaleElement.getText();
    supportedLocales.add(supportedLocale);
  }
  portletModel.setSupportedLocales(supportedLocales);
  portletModel.setResourceBundle(portletElement.elementText("resource-bundle"));
  Element portletInfoElement=portletElement.element("portlet-info");
  String portletInfoTitle=null;
  String portletInfoShortTitle=null;
  String portletInfoKeyWords=null;
  String portletInfoDescription=null;
  if (portletInfoElement != null) {
    portletInfoTitle=portletInfoElement.elementText("title");
    portletInfoShortTitle=portletInfoElement.elementText("short-title");
    portletInfoKeyWords=portletInfoElement.elementText("keywords");
  }
  PortletInfo portletInfo=new PortletInfo(portletInfoTitle,portletInfoShortTitle,portletInfoKeyWords,portletInfoDescription);
  portletModel.setPortletInfo(portletInfo);
  Element portletPreferencesElement=portletElement.element("portlet-preferences");
  String defaultPreferences=null;
  String preferencesValidator=null;
  if (portletPreferencesElement != null) {
    Element preferencesValidatorElement=portletPreferencesElement.element("preferences-validator");
    if (preferencesValidatorElement != null) {
      preferencesValidator=preferencesValidatorElement.getText();
      portletPreferencesElement.remove(preferencesValidatorElement);
    }
    defaultPreferences=portletPreferencesElement.asXML();
  }
  portletModel.setDefaultPreferences(defaultPreferences);
  portletModel.setPreferencesValidator(preferencesValidator);
  if (!portletApp.isWARFile() && Validator.isNotNull(preferencesValidator) && PropsValues.PREFERENCE_VALIDATE_ON_STARTUP) {
    try {
      PreferencesValidator preferencesValidatorObj=PortalUtil.getPreferencesValidator(portletModel);
      preferencesValidatorObj.validate(PortletPreferencesFactoryUtil.fromDefaultXML(defaultPreferences));
    }
 catch (    Exception e) {
      if (_log.isWarnEnabled()) {
        _log.warn("Portlet with the name " + portletId + " does not have valid default preferences");
      }
    }
  }
  Set<String> unlinkedRoles=new HashSet<>();
  for (  Element roleElement : portletElement.elements("security-role-ref")) {
    unlinkedRoles.add(roleElement.elementText("role-name"));
  }
  portletModel.setUnlinkedRoles(unlinkedRoles);
  Set<QName> processingEvents=new HashSet<>();
  for (  Element supportedProcessingEventElement : portletElement.elements("supported-processing-event")) {
    Element qNameElement=supportedProcessingEventElement.element("qname");
    Element nameElement=supportedProcessingEventElement.element("name");
    QName qName=PortletQNameUtil.getQName(qNameElement,nameElement,portletApp.getDefaultNamespace());
    processingEvents.add(qName);
    Set<EventDefinition> eventDefinitions=portletApp.getEventDefinitions();
    for (    EventDefinition eventDefinition : eventDefinitions) {
      Set<QName> qNames=eventDefinition.getQNames();
      if (qNames.contains(qName)) {
        processingEvents.addAll(qNames);
      }
    }
  }
  portletModel.setProcessingEvents(processingEvents);
  Set<QName> publishingEvents=new HashSet<>();
  for (  Element supportedPublishingEventElement : portletElement.elements("supported-publishing-event")) {
    Element qNameElement=supportedPublishingEventElement.element("qname");
    Element nameElement=supportedPublishingEventElement.element("name");
    QName qName=PortletQNameUtil.getQName(qNameElement,nameElement,portletApp.getDefaultNamespace());
    publishingEvents.add(qName);
  }
  portletModel.setPublishingEvents(publishingEvents);
  Set<PublicRenderParameter> publicRenderParameters=new HashSet<>();
  for (  Element supportedPublicRenderParameter : portletElement.elements("supported-public-render-parameter")) {
    String identifier=supportedPublicRenderParameter.getTextTrim();
    PublicRenderParameter publicRenderParameter=portletApp.getPublicRenderParameter(identifier);
    if (publicRenderParameter == null) {
      _log.error("Supported public render parameter references " + "unknown identifier " + identifier);
      continue;
    }
    publicRenderParameters.add(publicRenderParameter);
  }
  portletModel.setPublicRenderParameters(publicRenderParameters);
  portletsMap.put(portletId,portletModel);
}
