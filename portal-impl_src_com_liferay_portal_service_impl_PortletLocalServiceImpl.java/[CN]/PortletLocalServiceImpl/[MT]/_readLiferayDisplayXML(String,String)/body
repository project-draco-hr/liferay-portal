{
  PortletCategory portletCategory=new PortletCategory();
  if (xml == null) {
    xml=ContentUtil.get("com/liferay/portal/deploy/dependencies/liferay-display.xml");
  }
  Document doc=PortalUtil.readDocumentFromXML(xml,true);
  Element root=doc.getRootElement();
  Set portletIds=new HashSet();
  _readLiferayDisplay(servletContextName,root,portletCategory,portletIds);
  Set undefinedPortletIds=new HashSet();
  Iterator itr=_getPortletsPool().values().iterator();
  while (itr.hasNext()) {
    Portlet portlet=(Portlet)itr.next();
    String portletId=portlet.getPortletId();
    if ((servletContextName != null) && (portlet.isWARFile()) && (portletId.endsWith(PortletImpl.WAR_SEPARATOR + PortalUtil.getJsSafePortletId(servletContextName)) && (!portletIds.contains(portletId)))) {
      undefinedPortletIds.add(portletId);
    }
 else     if ((servletContextName == null) && (!portlet.isWARFile()) && (portletId.indexOf(PortletImpl.WAR_SEPARATOR) == -1)&& (!portletIds.contains(portletId))) {
      undefinedPortletIds.add(portletId);
    }
  }
  if (undefinedPortletIds.size() > 0) {
    PortletCategory undefinedCategory=new PortletCategory("category.undefined");
    portletCategory.addCategory(undefinedCategory);
    undefinedCategory.getPortlets().addAll(undefinedPortletIds);
  }
  return portletCategory;
}
