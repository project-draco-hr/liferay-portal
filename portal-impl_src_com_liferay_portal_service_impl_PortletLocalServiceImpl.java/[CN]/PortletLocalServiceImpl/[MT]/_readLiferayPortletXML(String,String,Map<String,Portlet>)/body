{
  Set<String> liferayPortletIds=new HashSet<String>();
  if (xml == null) {
    return liferayPortletIds;
  }
  Document doc=SAXReaderUtil.read(xml,true);
  Element root=doc.getRootElement();
  PortletApp portletApp=_getPortletApp(servletContextName);
  Map<String,String> roleMappers=new HashMap<String,String>();
  Iterator<Element> itr1=root.elements("role-mapper").iterator();
  while (itr1.hasNext()) {
    Element roleMapper=itr1.next();
    String roleName=roleMapper.elementText("role-name");
    String roleLink=roleMapper.elementText("role-link");
    roleMappers.put(roleName,roleLink);
  }
  Map<String,String> customUserAttributes=portletApp.getCustomUserAttributes();
  itr1=root.elements("custom-user-attribute").iterator();
  while (itr1.hasNext()) {
    Element customUserAttribute=itr1.next();
    String customClass=customUserAttribute.elementText("custom-class");
    Iterator<Element> itr2=customUserAttribute.elements("name").iterator();
    while (itr2.hasNext()) {
      Element nameEl=itr2.next();
      String name=nameEl.getText();
      customUserAttributes.put(name,customClass);
    }
  }
  itr1=root.elements("portlet").iterator();
  while (itr1.hasNext()) {
    Element portlet=itr1.next();
    String portletId=portlet.elementText("portlet-name");
    if (Validator.isNotNull(servletContextName)) {
      portletId=portletId + PortletConstants.WAR_SEPARATOR + servletContextName;
    }
    portletId=PortalUtil.getJsSafePortletId(portletId);
    if (_log.isDebugEnabled()) {
      _log.debug("Reading portlet extension " + portletId);
    }
    liferayPortletIds.add(portletId);
    Portlet portletModel=portletsPool.get(portletId);
    if (portletModel != null) {
      portletModel.setIcon(GetterUtil.getString(portlet.elementText("icon"),portletModel.getIcon()));
      portletModel.setVirtualPath(GetterUtil.getString(portlet.elementText("virtual-path"),portletModel.getVirtualPath()));
      portletModel.setStrutsPath(GetterUtil.getString(portlet.elementText("struts-path"),portletModel.getStrutsPath()));
      if (Validator.isNotNull(portlet.elementText("configuration-path"))) {
        _log.error("The configuration-path element is no longer " + "supported. Use configuration-action-class " + "instead.");
      }
      portletModel.setConfigurationActionClass(GetterUtil.getString(portlet.elementText("configuration-action-class"),portletModel.getConfigurationActionClass()));
      portletModel.setIndexerClass(GetterUtil.getString(portlet.elementText("indexer-class"),portletModel.getIndexerClass()));
      portletModel.setOpenSearchClass(GetterUtil.getString(portlet.elementText("open-search-class"),portletModel.getOpenSearchClass()));
      portletModel.setSchedulerClass(GetterUtil.getString(portlet.elementText("scheduler-class"),portletModel.getSchedulerClass()));
      Iterator<Element> schedulerEntryElementIterator=portlet.elementIterator("scheduler-entry");
      while (schedulerEntryElementIterator.hasNext()) {
        Element schedulerEntryElement=schedulerEntryElementIterator.next();
        SchedulerEntry schedulerEntry=new SchedulerEntryImpl();
        String schedulerDescription=schedulerEntryElement.elementText("scheduler-description");
        schedulerEntry.setDescription(GetterUtil.getString(schedulerDescription,StringPool.BLANK));
        schedulerEntry.setListenerClass(GetterUtil.getString(schedulerEntryElement.elementText("scheduler-event-listener-class"),schedulerEntry.getEventListenerClass()));
        Element triggerElement=schedulerEntryElement.element("trigger");
        Element realTriggerElement=triggerElement.elementIterator().next();
        schedulerEntry.setTriggerType(TriggerType.valueOf(realTriggerElement.getName().toUpperCase()));
        Element triggerValueElement=realTriggerElement.elementIterator().next();
        String triggerValueElementName=triggerValueElement.getName();
        schedulerEntry.setReadProperty(triggerValueElementName.equals("property-key"));
        if (schedulerEntry.getTriggerType() == TriggerType.SIMPLE && triggerValueElementName.equals("simple-trigger-value")) {
          String timeUnit=triggerValueElement.attributeValue("time-unit","sec");
          long timeValue=Long.parseLong(triggerValueElement.getTextTrim());
          schedulerEntry.setTriggerValue(Long.toString(_timeUnitMap.get(timeUnit) * timeValue));
        }
 else {
          schedulerEntry.setTriggerValue(triggerValueElement.getTextTrim());
        }
        portletModel.addSchedulerEntry(schedulerEntry);
      }
      portletModel.setPortletURLClass(GetterUtil.getString(portlet.elementText("portlet-url-class"),portletModel.getPortletURLClass()));
      portletModel.setFriendlyURLMapperClass(GetterUtil.getString(portlet.elementText("friendly-url-mapper-class"),portletModel.getFriendlyURLMapperClass()));
      if (Validator.isNull(portletModel.getFriendlyURLMapperClass())) {
        _friendlyURLMapperPortlets.remove(portletId);
      }
 else {
        _friendlyURLMapperPortlets.put(portletId,portletModel);
      }
      portletModel.setURLEncoderClass(GetterUtil.getString(portlet.elementText("url-encoder-class"),portletModel.getURLEncoderClass()));
      portletModel.setPortletDataHandlerClass(GetterUtil.getString(portlet.elementText("portlet-data-handler-class"),portletModel.getPortletDataHandlerClass()));
      portletModel.setPortletLayoutListenerClass(GetterUtil.getString(portlet.elementText("portlet-layout-listener-class"),portletModel.getPortletLayoutListenerClass()));
      portletModel.setPollerProcessorClass(GetterUtil.getString(portlet.elementText("poller-processor-class"),portletModel.getPollerProcessorClass()));
      portletModel.setPopMessageListenerClass(GetterUtil.getString(portlet.elementText("pop-message-listener-class"),portletModel.getPopMessageListenerClass()));
      portletModel.setSocialActivityInterpreterClass(GetterUtil.getString(portlet.elementText("social-activity-interpreter-class"),portletModel.getSocialActivityInterpreterClass()));
      portletModel.setSocialRequestInterpreterClass(GetterUtil.getString(portlet.elementText("social-request-interpreter-class"),portletModel.getSocialRequestInterpreterClass()));
      portletModel.setWebDAVStorageToken(GetterUtil.getString(portlet.elementText("webdav-storage-token"),portletModel.getWebDAVStorageToken()));
      portletModel.setWebDAVStorageClass(GetterUtil.getString(portlet.elementText("webdav-storage-class"),portletModel.getWebDAVStorageClass()));
      portletModel.setControlPanelEntryCategory(GetterUtil.getString(portlet.elementText("control-panel-entry-category"),portletModel.getControlPanelEntryCategory()));
      portletModel.setControlPanelEntryWeight(GetterUtil.getDouble(portlet.elementText("control-panel-entry-weight"),portletModel.getControlPanelEntryWeight()));
      portletModel.setControlPanelEntryClass(GetterUtil.getString(portlet.elementText("control-panel-entry-class"),portletModel.getControlPanelEntryClass()));
      List<String> assetRendererFactoryClasses=portletModel.getAssetRendererFactoryClasses();
      Iterator<Element> itr2=portlet.elements("asset-renderer-factory").iterator();
      while (itr2.hasNext()) {
        Element assetRendererFactoryClassEl=itr2.next();
        assetRendererFactoryClasses.add(assetRendererFactoryClassEl.getText());
      }
      List<String> customAttributesDisplayClasses=portletModel.getCustomAttributesDisplayClasses();
      itr2=portlet.elements("custom-attributes-display").iterator();
      while (itr2.hasNext()) {
        Element customAttributesDisplayClassEl=itr2.next();
        customAttributesDisplayClasses.add(customAttributesDisplayClassEl.getText());
      }
      if (portletModel.getCustomAttributesDisplayClasses().isEmpty()) {
        _customAttributesDisplayPortlets.remove(portletId);
      }
 else {
        _customAttributesDisplayPortlets.put(portletId,portletModel);
      }
      List<String> workflowHandlerClasses=portletModel.getWorkflowHandlerClasses();
      itr2=portlet.elements("workflow-handler").iterator();
      while (itr2.hasNext()) {
        Element workflowHandlerClassEl=itr2.next();
        workflowHandlerClasses.add(workflowHandlerClassEl.getText());
      }
      portletModel.setPreferencesCompanyWide(GetterUtil.getBoolean(portlet.elementText("preferences-company-wide"),portletModel.isPreferencesCompanyWide()));
      portletModel.setPreferencesUniquePerLayout(GetterUtil.getBoolean(portlet.elementText("preferences-unique-per-layout"),portletModel.isPreferencesUniquePerLayout()));
      portletModel.setPreferencesOwnedByGroup(GetterUtil.getBoolean(portlet.elementText("preferences-owned-by-group"),portletModel.isPreferencesOwnedByGroup()));
      portletModel.setUseDefaultTemplate(GetterUtil.getBoolean(portlet.elementText("use-default-template"),portletModel.isUseDefaultTemplate()));
      portletModel.setShowPortletAccessDenied(GetterUtil.getBoolean(portlet.elementText("show-portlet-access-denied"),portletModel.isShowPortletAccessDenied()));
      portletModel.setShowPortletInactive(GetterUtil.getBoolean(portlet.elementText("show-portlet-inactive"),portletModel.isShowPortletInactive()));
      portletModel.setActionURLRedirect(GetterUtil.getBoolean(portlet.elementText("action-url-redirect"),portletModel.isActionURLRedirect()));
      portletModel.setRestoreCurrentView(GetterUtil.getBoolean(portlet.elementText("restore-current-view"),portletModel.isRestoreCurrentView()));
      portletModel.setMaximizeEdit(GetterUtil.getBoolean(portlet.elementText("maximize-edit"),portletModel.isMaximizeEdit()));
      portletModel.setMaximizeHelp(GetterUtil.getBoolean(portlet.elementText("maximize-help"),portletModel.isMaximizeHelp()));
      portletModel.setPopUpPrint(GetterUtil.getBoolean(portlet.elementText("pop-up-print"),portletModel.isPopUpPrint()));
      portletModel.setLayoutCacheable(GetterUtil.getBoolean(portlet.elementText("layout-cacheable"),portletModel.isLayoutCacheable()));
      portletModel.setInstanceable(GetterUtil.getBoolean(portlet.elementText("instanceable"),portletModel.isInstanceable()));
      portletModel.setScopeable(GetterUtil.getBoolean(portlet.elementText("scopeable"),portletModel.isScopeable()));
      portletModel.setUserPrincipalStrategy(GetterUtil.getString(portlet.elementText("user-principal-strategy"),portletModel.getUserPrincipalStrategy()));
      portletModel.setPrivateRequestAttributes(GetterUtil.getBoolean(portlet.elementText("private-request-attributes"),portletModel.isPrivateRequestAttributes()));
      portletModel.setPrivateSessionAttributes(GetterUtil.getBoolean(portlet.elementText("private-session-attributes"),portletModel.isPrivateSessionAttributes()));
      portletModel.setRenderWeight(GetterUtil.getInteger(portlet.elementText("render-weight"),portletModel.getRenderWeight()));
      portletModel.setAjaxable(GetterUtil.getBoolean(portlet.elementText("ajaxable"),portletModel.isAjaxable()));
      List<String> headerPortalCssList=portletModel.getHeaderPortalCss();
      itr2=portlet.elements("header-portal-css").iterator();
      while (itr2.hasNext()) {
        Element headerPortalCssEl=itr2.next();
        headerPortalCssList.add(headerPortalCssEl.getText());
      }
      List<String> headerPortletCssList=portletModel.getHeaderPortletCss();
      List<Element> list=new ArrayList<Element>();
      list.addAll(portlet.elements("header-css"));
      list.addAll(portlet.elements("header-portlet-css"));
      itr2=list.iterator();
      while (itr2.hasNext()) {
        Element headerPortletCssEl=itr2.next();
        headerPortletCssList.add(headerPortletCssEl.getText());
      }
      List<String> headerPortalJavaScriptList=portletModel.getHeaderPortalJavaScript();
      itr2=portlet.elements("header-portal-javascript").iterator();
      while (itr2.hasNext()) {
        Element headerPortalJavaScriptEl=itr2.next();
        headerPortalJavaScriptList.add(headerPortalJavaScriptEl.getText());
      }
      List<String> headerPortletJavaScriptList=portletModel.getHeaderPortletJavaScript();
      list.clear();
      list.addAll(portlet.elements("header-javascript"));
      list.addAll(portlet.elements("header-portlet-javascript"));
      itr2=list.iterator();
      while (itr2.hasNext()) {
        Element headerPortletJavaScriptEl=itr2.next();
        headerPortletJavaScriptList.add(headerPortletJavaScriptEl.getText());
      }
      List<String> footerPortalCssList=portletModel.getFooterPortalCss();
      itr2=portlet.elements("footer-portal-css").iterator();
      while (itr2.hasNext()) {
        Element footerPortalCssEl=itr2.next();
        footerPortalCssList.add(footerPortalCssEl.getText());
      }
      List<String> footerPortletCssList=portletModel.getFooterPortletCss();
      itr2=portlet.elements("footer-portlet-css").iterator();
      while (itr2.hasNext()) {
        Element footerPortletCssEl=itr2.next();
        footerPortletCssList.add(footerPortletCssEl.getText());
      }
      List<String> footerPortalJavaScriptList=portletModel.getFooterPortalJavaScript();
      itr2=portlet.elements("footer-portal-javascript").iterator();
      while (itr2.hasNext()) {
        Element footerPortalJavaScriptEl=itr2.next();
        footerPortalJavaScriptList.add(footerPortalJavaScriptEl.getText());
      }
      List<String> footerPortletJavaScriptList=portletModel.getFooterPortletJavaScript();
      itr2=portlet.elements("footer-portlet-javascript").iterator();
      while (itr2.hasNext()) {
        Element footerPortletJavaScriptEl=itr2.next();
        footerPortletJavaScriptList.add(footerPortletJavaScriptEl.getText());
      }
      portletModel.setCssClassWrapper(GetterUtil.getString(portlet.elementText("css-class-wrapper"),portletModel.getCssClassWrapper()));
      portletModel.setFacebookIntegration(GetterUtil.getString(portlet.elementText("facebook-integration"),portletModel.getFacebookIntegration()));
      portletModel.setAddDefaultResource(GetterUtil.getBoolean(portlet.elementText("add-default-resource"),portletModel.isAddDefaultResource()));
      portletModel.setSystem(GetterUtil.getBoolean(portlet.elementText("system"),portletModel.isSystem()));
      portletModel.setActive(GetterUtil.getBoolean(portlet.elementText("active"),portletModel.isActive()));
      portletModel.setInclude(GetterUtil.getBoolean(portlet.elementText("include"),portletModel.isInclude()));
      if (!portletModel.isAjaxable() && (portletModel.getRenderWeight() < 1)) {
        portletModel.setRenderWeight(1);
      }
      portletModel.getRoleMappers().putAll(roleMappers);
      portletModel.linkRoles();
    }
  }
  return liferayPortletIds;
}
