{
  Set<String> portletIds=new HashSet<String>();
  if (xml == null) {
    return portletIds;
  }
  Document document=SAXReaderUtil.read(xml,PropsValues.PORTLET_XML_VALIDATE);
  Element rootElement=document.getRootElement();
  PortletApp portletApp=_getPortletApp(servletContextName);
  portletApp.getServletURLPatterns().addAll(servletURLPatterns);
  Set<String> userAttributes=portletApp.getUserAttributes();
  for (  Element userAttributeElement : rootElement.elements("user-attribute")) {
    String name=userAttributeElement.elementText("name");
    userAttributes.add(name);
  }
  String defaultNamespace=rootElement.elementText("default-namespace");
  if (Validator.isNotNull(defaultNamespace)) {
    portletApp.setDefaultNamespace(defaultNamespace);
  }
  for (  Element eventDefinitionElement : rootElement.elements("event-definition")) {
    Element qNameElement=eventDefinitionElement.element("qname");
    Element nameElement=eventDefinitionElement.element("name");
    String valueType=eventDefinitionElement.elementText("value-type");
    QName qName=PortletQNameUtil.getQName(qNameElement,nameElement,portletApp.getDefaultNamespace());
    EventDefinition eventDefinition=new EventDefinitionImpl(qName,valueType,portletApp);
    portletApp.addEventDefinition(eventDefinition);
  }
  for (  Element publicRenderParameterElement : rootElement.elements("public-render-parameter")) {
    String identifier=publicRenderParameterElement.elementText("identifier");
    Element qNameElement=publicRenderParameterElement.element("qname");
    Element nameElement=publicRenderParameterElement.element("name");
    QName qName=PortletQNameUtil.getQName(qNameElement,nameElement,portletApp.getDefaultNamespace());
    PublicRenderParameter publicRenderParameter=new PublicRenderParameterImpl(identifier,qName,portletApp);
    portletApp.addPublicRenderParameter(publicRenderParameter);
  }
  for (  Element containerRuntimeOptionElement : rootElement.elements("container-runtime-option")) {
    String name=GetterUtil.getString(containerRuntimeOptionElement.elementText("name"));
    List<String> values=new ArrayList<String>();
    for (    Element valueElement : containerRuntimeOptionElement.elements("value")) {
      values.add(valueElement.getTextTrim());
    }
    Map<String,String[]> containerRuntimeOptions=portletApp.getContainerRuntimeOptions();
    containerRuntimeOptions.put(name,values.toArray(new String[values.size()]));
    if (name.equals(LiferayPortletConfig.RUNTIME_OPTION_PORTAL_CONTEXT) && !values.isEmpty() && GetterUtil.getBoolean(values.get(0))) {
      portletApp.setWARFile(false);
    }
  }
  long timestamp=ServletContextUtil.getLastModified(servletContext);
  for (  Element portletElement : rootElement.elements("portlet")) {
    String portletName=portletElement.elementText("portlet-name");
    String portletId=portletName;
    if (Validator.isNotNull(servletContextName)) {
      portletId=portletId + PortletConstants.WAR_SEPARATOR + servletContextName;
    }
    portletId=PortalUtil.getJsSafePortletId(portletId);
    if (_log.isDebugEnabled()) {
      _log.debug("Reading portlet " + portletId);
    }
    portletIds.add(portletId);
    Portlet portletModel=portletsPool.get(portletId);
    if (portletModel == null) {
      portletModel=new PortletImpl(CompanyConstants.SYSTEM,portletId);
      portletsPool.put(portletId,portletModel);
    }
    portletModel.setTimestamp(timestamp);
    portletModel.setPluginPackage(pluginPackage);
    portletModel.setPortletApp(portletApp);
    portletModel.setPortletName(portletName);
    portletModel.setDisplayName(GetterUtil.getString(portletElement.elementText("display-name"),portletModel.getDisplayName()));
    portletModel.setPortletClass(GetterUtil.getString(portletElement.elementText("portlet-class")));
    Iterator<Element> itr2=portletElement.elements("init-param").iterator();
    while (itr2.hasNext()) {
      Element initParam=itr2.next();
      portletModel.getInitParams().put(initParam.elementText("name"),initParam.elementText("value"));
    }
    Element expirationCache=portletElement.element("expiration-cache");
    if (expirationCache != null) {
      portletModel.setExpCache(new Integer(GetterUtil.getInteger(expirationCache.getText())));
    }
    itr2=portletElement.elements("supports").iterator();
    while (itr2.hasNext()) {
      Element supports=itr2.next();
      String mimeType=supports.elementText("mime-type");
      Set<String> mimeTypePortletModes=portletModel.getPortletModes().get(mimeType);
      if (mimeTypePortletModes == null) {
        mimeTypePortletModes=new HashSet<String>();
        portletModel.getPortletModes().put(mimeType,mimeTypePortletModes);
      }
      mimeTypePortletModes.add(PortletMode.VIEW.toString().toLowerCase());
      Iterator<Element> itr3=supports.elements("portlet-mode").iterator();
      while (itr3.hasNext()) {
        Element portletMode=itr3.next();
        mimeTypePortletModes.add(portletMode.getTextTrim().toLowerCase());
      }
      Set<String> mimeTypeWindowStates=portletModel.getWindowStates().get(mimeType);
      if (mimeTypeWindowStates == null) {
        mimeTypeWindowStates=new HashSet<String>();
        portletModel.getWindowStates().put(mimeType,mimeTypeWindowStates);
      }
      mimeTypeWindowStates.add(WindowState.NORMAL.toString().toLowerCase());
      itr3=supports.elements("window-state").iterator();
      if (!itr3.hasNext()) {
        mimeTypeWindowStates.add(WindowState.MAXIMIZED.toString().toLowerCase());
        mimeTypeWindowStates.add(WindowState.MINIMIZED.toString().toLowerCase());
        mimeTypeWindowStates.add(LiferayWindowState.EXCLUSIVE.toString().toLowerCase());
        mimeTypeWindowStates.add(LiferayWindowState.POP_UP.toString().toLowerCase());
      }
      while (itr3.hasNext()) {
        Element windowState=itr3.next();
        mimeTypeWindowStates.add(windowState.getTextTrim().toLowerCase());
      }
    }
    Set<String> supportedLocales=portletModel.getSupportedLocales();
    itr2=portletElement.elements("supported-locale").iterator();
    while (itr2.hasNext()) {
      Element supportedLocaleEl=itr2.next();
      String supportedLocale=supportedLocaleEl.getText();
      supportedLocales.add(supportedLocale);
    }
    portletModel.setResourceBundle(portletElement.elementText("resource-bundle"));
    Element portletInfo=portletElement.element("portlet-info");
    String portletInfoTitle=null;
    String portletInfoShortTitle=null;
    String portletInfoKeyWords=null;
    String portletInfoDescription=null;
    if (portletInfo != null) {
      portletInfoTitle=portletInfo.elementText("title");
      portletInfoShortTitle=portletInfo.elementText("short-title");
      portletInfoKeyWords=portletInfo.elementText("keywords");
    }
    portletModel.setPortletInfo(new PortletInfo(portletInfoTitle,portletInfoShortTitle,portletInfoKeyWords,portletInfoDescription));
    Element portletPreferences=portletElement.element("portlet-preferences");
    String defaultPreferences=null;
    String preferencesValidator=null;
    if (portletPreferences != null) {
      Element preferencesValidatorEl=portletPreferences.element("preferences-validator");
      if (preferencesValidatorEl != null) {
        preferencesValidator=preferencesValidatorEl.getText();
        portletPreferences.remove(preferencesValidatorEl);
      }
      defaultPreferences=portletPreferences.asXML();
    }
    portletModel.setDefaultPreferences(defaultPreferences);
    portletModel.setPreferencesValidator(preferencesValidator);
    if (!portletApp.isWARFile() && Validator.isNotNull(preferencesValidator) && PropsValues.PREFERENCE_VALIDATE_ON_STARTUP) {
      try {
        PreferencesValidator preferencesValidatorObj=PortalUtil.getPreferencesValidator(portletModel);
        preferencesValidatorObj.validate(PortletPreferencesSerializer.fromDefaultXML(defaultPreferences));
      }
 catch (      Exception e) {
        if (_log.isWarnEnabled()) {
          _log.warn("Portlet with the name " + portletId + " does not have valid default preferences");
        }
      }
    }
    Set<String> unlikedRoles=portletModel.getUnlinkedRoles();
    itr2=portletElement.elements("security-role-ref").iterator();
    while (itr2.hasNext()) {
      Element role=itr2.next();
      unlikedRoles.add(role.elementText("role-name"));
    }
    itr2=portletElement.elements("supported-processing-event").iterator();
    while (itr2.hasNext()) {
      Element supportedProcessingEvent=itr2.next();
      Element qNameEl=supportedProcessingEvent.element("qname");
      Element nameEl=supportedProcessingEvent.element("name");
      QName qName=PortletQNameUtil.getQName(qNameEl,nameEl,portletApp.getDefaultNamespace());
      portletModel.addProcessingEvent(qName);
    }
    itr2=portletElement.elements("supported-publishing-event").iterator();
    while (itr2.hasNext()) {
      Element supportedPublishingEvent=itr2.next();
      Element qNameEl=supportedPublishingEvent.element("qname");
      Element nameEl=supportedPublishingEvent.element("name");
      QName qName=PortletQNameUtil.getQName(qNameEl,nameEl,portletApp.getDefaultNamespace());
      portletModel.addPublishingEvent(qName);
    }
    itr2=portletElement.elements("supported-public-render-parameter").iterator();
    while (itr2.hasNext()) {
      Element supportedPublicRenderParameter=itr2.next();
      String identifier=supportedPublicRenderParameter.getTextTrim();
      PublicRenderParameter publicRenderParameter=portletApp.getPublicRenderParameter(identifier);
      if (publicRenderParameter == null) {
        _log.error("Supported public render parameter references " + "unnknown identifier " + identifier);
        continue;
      }
      portletModel.addPublicRenderParameter(publicRenderParameter);
    }
  }
  for (  Element filterElement : rootElement.elements("filter")) {
    String filterName=filterElement.elementText("filter-name");
    String filterClass=filterElement.elementText("filter-class");
    Set<String> lifecycles=new LinkedHashSet<String>();
    for (    Element lifecycleElement : filterElement.elements("lifecycle")) {
      lifecycles.add(lifecycleElement.getText());
    }
    Map<String,String> initParams=new HashMap<String,String>();
    for (    Element initParamElement : filterElement.elements("init-param")) {
      initParams.put(initParamElement.elementText("name"),initParamElement.elementText("value"));
    }
    PortletFilter portletFilter=new PortletFilterImpl(filterName,filterClass,lifecycles,initParams,portletApp);
    portletApp.addPortletFilter(portletFilter);
  }
  for (  Element filterMappingElement : rootElement.elements("filter-mapping")) {
    String filterName=filterMappingElement.elementText("filter-name");
    for (    Element portletNameElement : filterMappingElement.elements("portlet-name")) {
      String portletName=portletNameElement.getTextTrim();
      PortletFilter portletFilter=portletApp.getPortletFilter(filterName);
      if (portletFilter == null) {
        _log.error("Filter mapping references unnknown filter name " + filterName);
        continue;
      }
      List<Portlet> portletModels=_getPortletsByPortletName(portletName,servletContextName,portletsPool);
      if (portletModels.size() == 0) {
        _log.error("Filter mapping with filter name " + filterName + " references unnknown portlet name "+ portletName);
      }
      for (      Portlet portletModel : portletModels) {
        portletModel.getPortletFilters().put(filterName,portletFilter);
      }
    }
  }
  for (  Element listenerElement : rootElement.elements("listener")) {
    String listenerClass=listenerElement.elementText("listener-class");
    PortletURLListener portletURLListener=new PortletURLListenerImpl(listenerClass,portletApp);
    portletApp.addPortletURLListener(portletURLListener);
  }
  return portletIds;
}
