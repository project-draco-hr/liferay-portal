{
  Set<String> portletIds=new HashSet<String>();
  if (xml == null) {
    return portletIds;
  }
  Document doc=PortalUtil.readDocumentFromXML(xml);
  Element root=doc.getRootElement();
  PortletApp portletApp=_getPortletApp(servletContextName);
  portletApp.getServletURLPatterns().addAll(servletURLPatterns);
  Set<String> userAttributes=portletApp.getUserAttributes();
  Iterator<Element> itr1=root.elements("user-attribute").iterator();
  while (itr1.hasNext()) {
    Element userAttribute=itr1.next();
    String name=userAttribute.elementText("name");
    userAttributes.add(name);
  }
  String defaultNamespace=root.elementText("default-namespace");
  if (Validator.isNotNull(defaultNamespace)) {
    portletApp.setDefaultNamespace(defaultNamespace);
  }
  itr1=root.elements("event-definition").iterator();
  while (itr1.hasNext()) {
    Element eventDefinitionEl=itr1.next();
    Element qNameEl=eventDefinitionEl.element("qname");
    Element nameEl=eventDefinitionEl.element("name");
    String valueType=eventDefinitionEl.elementText("value-type");
    QName qName=QNameUtil.getQName(qNameEl,nameEl,portletApp.getDefaultNamespace());
    EventDefinition eventDefinition=new EventDefinitionImpl(qName,valueType,portletApp);
    portletApp.addEventDefinition(eventDefinition);
  }
  itr1=root.elements("public-render-parameter").iterator();
  while (itr1.hasNext()) {
    Element publicRenderParameterEl=itr1.next();
    String identifier=publicRenderParameterEl.elementText("identifier");
    Element qNameEl=publicRenderParameterEl.element("qname");
    Element nameEl=publicRenderParameterEl.element("name");
    QName qName=QNameUtil.getQName(qNameEl,nameEl,portletApp.getDefaultNamespace());
    PublicRenderParameter publicRenderParameter=new PublicRenderParameterImpl(identifier,qName,portletApp);
    portletApp.addPublicRenderParameter(publicRenderParameter);
  }
  itr1=root.elements("container-runtime-option").iterator();
  while (itr1.hasNext()) {
    Element containerRuntimeOption=itr1.next();
    String name=containerRuntimeOption.elementText("name");
    List<String> values=new ArrayList<String>();
    for (    Element value : (List<Element>)containerRuntimeOption.elements("value")) {
      values.add(value.getTextTrim());
    }
    portletApp.getContainerRuntimeOptions().put(name,values.toArray(new String[values.size()]));
  }
  itr1=root.elements("portlet").iterator();
  while (itr1.hasNext()) {
    Element portlet=itr1.next();
    String portletId=portlet.elementText("portlet-name");
    if (Validator.isNotNull(servletContextName)) {
      portletId=portletId + PortletImpl.WAR_SEPARATOR + servletContextName;
    }
    portletId=PortalUtil.getJsSafePortletId(portletId);
    if (_log.isDebugEnabled()) {
      _log.debug("Reading portlet " + portletId);
    }
    portletIds.add(portletId);
    Portlet portletModel=portletsPool.get(portletId);
    if (portletModel == null) {
      portletModel=new PortletImpl(CompanyImpl.SYSTEM,portletId);
      portletsPool.put(portletId,portletModel);
    }
    portletModel.setPluginPackage(pluginPackage);
    portletModel.setPortletApp(portletApp);
    portletModel.setDisplayName(GetterUtil.getString(portlet.elementText("display-name"),portletModel.getDisplayName()));
    portletModel.setPortletClass(GetterUtil.getString(portlet.elementText("portlet-class")));
    Iterator<Element> itr2=portlet.elements("init-param").iterator();
    while (itr2.hasNext()) {
      Element initParam=itr2.next();
      portletModel.getInitParams().put(initParam.elementText("name"),initParam.elementText("value"));
    }
    Element expirationCache=portlet.element("expiration-cache");
    if (expirationCache != null) {
      portletModel.setExpCache(new Integer(GetterUtil.getInteger(expirationCache.getText())));
    }
    itr2=portlet.elements("supports").iterator();
    while (itr2.hasNext()) {
      Element supports=itr2.next();
      String mimeType=supports.elementText("mime-type");
      Set<String> mimeTypeModes=portletModel.getPortletModes().get(mimeType);
      if (mimeTypeModes == null) {
        mimeTypeModes=new HashSet<String>();
        portletModel.getPortletModes().put(mimeType,mimeTypeModes);
      }
      mimeTypeModes.add(PortletMode.VIEW.toString().toLowerCase());
      Iterator<Element> itr3=supports.elements("portlet-mode").iterator();
      while (itr3.hasNext()) {
        Element portletMode=itr3.next();
        mimeTypeModes.add(portletMode.getTextTrim().toLowerCase());
      }
    }
    Set<String> supportedLocales=portletModel.getSupportedLocales();
    itr2=portlet.elements("supported-locale").iterator();
    while (itr2.hasNext()) {
      Element supportedLocaleEl=itr2.next();
      String supportedLocale=supportedLocaleEl.getText();
      supportedLocales.add(supportedLocale);
    }
    portletModel.setResourceBundle(portlet.elementText("resource-bundle"));
    Element portletInfo=portlet.element("portlet-info");
    String portletInfoTitle=null;
    String portletInfoShortTitle=null;
    String portletInfoKeyWords=null;
    if (portletInfo != null) {
      portletInfoTitle=portletInfo.elementText("title");
      portletInfoShortTitle=portletInfo.elementText("short-title");
      portletInfoKeyWords=portletInfo.elementText("keywords");
    }
    portletModel.setPortletInfo(new PortletInfo(portletInfoTitle,portletInfoShortTitle,portletInfoKeyWords));
    Element portletPreferences=portlet.element("portlet-preferences");
    String defaultPreferences=null;
    String prefsValidator=null;
    if (portletPreferences != null) {
      Element prefsValidatorEl=portletPreferences.element("preferences-validator");
      if (prefsValidatorEl != null) {
        prefsValidator=prefsValidatorEl.getText();
        portletPreferences.remove(prefsValidatorEl);
      }
      StringWriter sw=new StringWriter();
      XMLWriter writer=new XMLWriter(sw,OutputFormat.createCompactFormat());
      writer.write(portletPreferences);
      defaultPreferences=sw.toString();
    }
    portletModel.setDefaultPreferences(defaultPreferences);
    portletModel.setPreferencesValidator(prefsValidator);
    if (!portletApp.isWARFile() && Validator.isNotNull(prefsValidator) && PropsValues.PREFERENCE_VALIDATE_ON_STARTUP) {
      try {
        PreferencesValidator prefsValidatorObj=PortalUtil.getPreferencesValidator(portletModel);
        prefsValidatorObj.validate(PortletPreferencesSerializer.fromDefaultXML(defaultPreferences));
      }
 catch (      Exception e) {
        if (_log.isWarnEnabled()) {
          _log.warn("Portlet with the name " + portletId + " does not have valid default preferences");
        }
      }
    }
    Set<String> unlikedRoles=portletModel.getUnlinkedRoles();
    itr2=portlet.elements("security-role-ref").iterator();
    while (itr2.hasNext()) {
      Element role=itr2.next();
      unlikedRoles.add(role.elementText("role-name"));
    }
    itr2=portlet.elements("supported-processing-event").iterator();
    while (itr2.hasNext()) {
      Element supportedProcessingEvent=itr2.next();
      Element qNameEl=supportedProcessingEvent.element("qname");
      Element nameEl=supportedProcessingEvent.element("name");
      QName qName=QNameUtil.getQName(qNameEl,nameEl,portletApp.getDefaultNamespace());
      portletModel.addProcessingEvent(qName);
    }
    itr2=portlet.elements("supported-publishing-event").iterator();
    while (itr2.hasNext()) {
      Element supportedPublishingEvent=itr2.next();
      Element qNameEl=supportedPublishingEvent.element("qname");
      Element nameEl=supportedPublishingEvent.element("name");
      QName qName=QNameUtil.getQName(qNameEl,nameEl,portletApp.getDefaultNamespace());
      portletModel.addPublishingEvent(qName);
    }
    itr2=portlet.elements("supported-public-render-parameter").iterator();
    while (itr2.hasNext()) {
      Element supportedPublicRenderParameter=itr2.next();
      String identifier=supportedPublicRenderParameter.getTextTrim();
      PublicRenderParameter publicRenderParameter=portletApp.getPublicRenderParameter(identifier);
      if (publicRenderParameter == null) {
        _log.error("Supported public render parameter references " + "unnknown identifier " + identifier);
        continue;
      }
      portletModel.addPublicRenderParameter(publicRenderParameter);
    }
  }
  itr1=root.elements("filter").iterator();
  while (itr1.hasNext()) {
    Element filter=itr1.next();
    String filterName=filter.elementText("filter-name");
    String filterClass=filter.elementText("filter-class");
    Set<String> lifecycles=new LinkedHashSet<String>();
    Iterator<Element> itr2=filter.elements("lifecycle").iterator();
    while (itr2.hasNext()) {
      Element lifecycle=itr2.next();
      lifecycles.add(lifecycle.getText());
    }
    Map<String,String> initParams=new HashMap<String,String>();
    itr2=filter.elements("init-param").iterator();
    while (itr2.hasNext()) {
      Element initParam=itr2.next();
      initParams.put(initParam.elementText("name"),initParam.elementText("value"));
    }
    PortletFilter portletFilter=new PortletFilterImpl(filterName,filterClass,lifecycles,initParams,portletApp);
    portletApp.addPortletFilter(portletFilter);
  }
  itr1=root.elements("filter-mapping").iterator();
  while (itr1.hasNext()) {
    Element filterMapping=itr1.next();
    String filterName=filterMapping.elementText("filter-name");
    Iterator<Element> itr2=filterMapping.elements("portlet-name").iterator();
    while (itr2.hasNext()) {
      Element portletNameEl=itr2.next();
      String portletName=portletNameEl.getTextTrim();
      PortletFilter portletFilter=portletApp.getPortletFilter(filterName);
      if (portletFilter == null) {
        _log.error("Filter mapping references unnknown filter name " + filterName);
        continue;
      }
      List<Portlet> portletModels=_getPortletsByPortletName(portletName,servletContextName,portletsPool);
      if (portletModels.size() == 0) {
        _log.error("Filter mapping with filter name " + filterName + " references unnknown portlet name "+ portletName);
      }
      for (      Portlet portletModel : portletModels) {
        portletModel.getPortletFilters().put(filterName,portletFilter);
      }
    }
  }
  itr1=root.elements("listener").iterator();
  while (itr1.hasNext()) {
    Element listener=itr1.next();
    String listenerClass=listener.elementText("listener-class");
    PortletURLListener portletURLListener=new PortletURLListenerImpl(listenerClass,portletApp);
    portletApp.addPortletURLListener(portletURLListener);
  }
  return portletIds;
}
