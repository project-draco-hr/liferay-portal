{
  Portlet portlet=fetchPortletById(companyId,portletId);
  if (portlet != null) {
    return portlet;
  }
  if (portletId.equals(PortletKeys.LIFERAY_PORTAL)) {
    return portlet;
  }
  if (_portletsMap.isEmpty()) {
    if (_log.isDebugEnabled()) {
      _log.debug("No portlets are installed");
    }
  }
 else {
    if (_log.isInfoEnabled()) {
      _log.info("Portlet not found for " + companyId + " "+ portletId);
    }
    portlet=new PortletImpl(CompanyConstants.SYSTEM,portletId);
    PortletApp portletApp=getPortletApp(StringPool.BLANK);
    portlet.setPortletApp(portletApp);
    portlet.setPortletName(portletId);
    portlet.setDisplayName(portletId);
    portlet.setPortletClass(UndeployedPortlet.class.getName());
    Set<String> mimeTypePortletModes=new HashSet<>();
    mimeTypePortletModes.add(StringUtil.toLowerCase(PortletMode.VIEW.toString()));
    Map<String,Set<String>> portletModes=portlet.getPortletModes();
    portletModes.put(ContentTypes.TEXT_HTML,mimeTypePortletModes);
    Set<String> mimeTypeWindowStates=new HashSet<>();
    mimeTypeWindowStates.add(StringUtil.toLowerCase(WindowState.NORMAL.toString()));
    Map<String,Set<String>> windowStates=portlet.getWindowStates();
    windowStates.put(ContentTypes.TEXT_HTML,mimeTypeWindowStates);
    portlet.setPortletInfo(new PortletInfo(portletId,portletId,portletId,portletId));
    if (PortletConstants.hasInstanceId(portletId)) {
      portlet.setInstanceable(true);
    }
    portlet.setActive(true);
    portlet.setUndeployedPortlet(true);
  }
  return portlet;
}
