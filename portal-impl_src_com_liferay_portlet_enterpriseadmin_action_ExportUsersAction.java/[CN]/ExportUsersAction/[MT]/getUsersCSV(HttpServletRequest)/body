{
  ThemeDisplay themeDisplay=(ThemeDisplay)req.getAttribute(WebKeys.THEME_DISPLAY);
  if (!RoleLocalServiceUtil.hasUserRole(themeDisplay.getUserId(),themeDisplay.getCompanyId(),RoleImpl.ADMINISTRATOR,true)) {
    return StringPool.BLANK;
  }
  String exportProgressId=ParamUtil.getString(req,"exportProgressId");
  ProgressTracker progressTracker=new ProgressTracker(req,exportProgressId);
  progressTracker.start();
  List<User> users=UserLocalServiceUtil.search(themeDisplay.getCompanyId(),null,Boolean.TRUE,null,QueryUtil.ALL_POS,QueryUtil.ALL_POS,null);
  int percentage=10;
  int total=users.size();
  progressTracker.updateProgress(percentage);
  StringMaker sm=new StringMaker(users.size() * 50);
  Iterator<User> itr=users.iterator();
  for (int i=0; itr.hasNext(); i++) {
    User user=itr.next();
    sm.append(user.getFullName());
    sm.append(StringPool.COMMA);
    sm.append(user.getEmailAddress());
    sm.append(StringPool.NEW_LINE);
    percentage=Math.min(10 + (i * 90) / total,99);
    progressTracker.updateProgress(percentage);
  }
  progressTracker.finish();
  return sm.toString();
}
