{
  userName=PortalUtil.getUserName(userId,userName);
  try {
    content=BBCodeUtil.getHTML(content);
  }
 catch (  Exception e) {
    _log.error("Could not parse message " + messageId + ": "+ e.getMessage());
  }
  content=HtmlUtil.extractText(content);
  Document doc=new DocumentImpl();
  doc.addUID(PORTLET_ID,messageId);
  doc.addModifiedDate(modifiedDate);
  doc.addKeyword(Field.COMPANY_ID,companyId);
  doc.addKeyword(Field.PORTLET_ID,PORTLET_ID);
  doc.addKeyword(Field.GROUP_ID,groupId);
  doc.addKeyword(Field.USER_ID,userId);
  if (!anonymous) {
    doc.addText(Field.USER_NAME,userName);
  }
  doc.addText(Field.TITLE,title);
  doc.addText(Field.CONTENT,content);
  doc.addKeyword(Field.TAGS_ENTRIES,tagsEntries);
  doc.addKeyword("categoryId",categoryId);
  doc.addKeyword("threadId",threadId);
  doc.addKeyword(Field.ENTRY_CLASS_NAME,MBMessage.class.getName());
  doc.addKeyword(Field.ENTRY_CLASS_PK,messageId);
  try {
    long rootMessageId=MBThreadLocalServiceUtil.getMBThread(threadId).getRootMessageId();
    if (rootMessageId != messageId) {
      Resource resource=ResourceLocalServiceUtil.getResource(companyId,MBMessage.class.getName(),ResourceConstants.SCOPE_INDIVIDUAL,Long.toString(rootMessageId));
      doc.addKeyword("permissionResourceId",resource.getResourceId());
    }
  }
 catch (  Exception ee) {
  }
  ExpandoBridgeIndexerUtil.addAttributes(doc,expandoBridge);
  return doc;
}
