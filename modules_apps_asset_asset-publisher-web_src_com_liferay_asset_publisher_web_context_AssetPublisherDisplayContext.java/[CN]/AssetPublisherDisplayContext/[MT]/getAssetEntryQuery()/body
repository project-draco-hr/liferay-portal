{
  if (_assetEntryQuery != null) {
    return _assetEntryQuery;
  }
  ThemeDisplay themeDisplay=(ThemeDisplay)_request.getAttribute(WebKeys.THEME_DISPLAY);
  _assetEntryQuery=AssetPublisherUtil.getAssetEntryQuery(_portletPreferences,getGroupIds(),getAllAssetCategoryIds(),getAllAssetTagNames());
  String portletName=getPortletName();
  if (!portletName.equals(AssetPublisherPortletKeys.RELATED_ASSETS)) {
    _assetEntryQuery.setGroupIds(getGroupIds());
  }
  _assetEntryQuery.setClassTypeIds(getClassTypeIds());
  _assetEntryQuery.setEnablePermissions(isEnablePermissions());
  _assetEntryQuery.setExcludeZeroViewCount(isExcludeZeroViewCount());
  configureSubtypeFieldFilter(_assetEntryQuery,themeDisplay.getLocale());
  if (isShowOnlyLayoutAssets()) {
    _assetEntryQuery.setLayout(themeDisplay.getLayout());
  }
  if (portletName.equals(AssetPublisherPortletKeys.RELATED_ASSETS)) {
    AssetEntry layoutAssetEntry=(AssetEntry)_request.getAttribute(WebKeys.LAYOUT_ASSET_ENTRY);
    if (layoutAssetEntry != null) {
      _assetEntryQuery.setLinkedAssetEntryId(layoutAssetEntry.getEntryId());
    }
  }
  _assetEntryQuery.setPaginationType(getPaginationType());
  _assetEntryQuery.setOrderByCol1(getOrderByColumn1());
  _assetEntryQuery.setOrderByCol2(getOrderByColumn2());
  _assetEntryQuery.setOrderByType1(getOrderByType1());
  _assetEntryQuery.setOrderByType2(getOrderByType2());
  AssetPublisherUtil.processAssetEntryQuery(themeDisplay.getUser(),_portletPreferences,_assetEntryQuery);
  return _assetEntryQuery;
}
