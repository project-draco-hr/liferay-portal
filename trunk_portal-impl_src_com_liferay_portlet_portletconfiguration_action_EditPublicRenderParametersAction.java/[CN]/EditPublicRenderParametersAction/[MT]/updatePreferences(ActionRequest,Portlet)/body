{
  ThemeDisplay themeDisplay=(ThemeDisplay)actionRequest.getAttribute(WebKeys.THEME_DISPLAY);
  Layout layout=themeDisplay.getLayout();
  PortletPreferences preferences=PortletPreferencesFactoryUtil.getLayoutPortletSetup(layout,portlet.getPortletId());
  Enumeration<String> enu=preferences.getNames();
  while (enu.hasMoreElements()) {
    String name=enu.nextElement();
    if (name.startsWith(PublicRenderParameterConfiguration.IGNORE_PREFIX) || name.startsWith(PublicRenderParameterConfiguration.MAPPING_PREFIX)) {
      preferences.reset(name);
    }
  }
  for (  PublicRenderParameter publicRenderParameter : portlet.getPublicRenderParameters()) {
    String ignoreKey=PublicRenderParameterConfiguration.getIgnoreKey(publicRenderParameter);
    boolean ignoreValue=ParamUtil.getBoolean(actionRequest,ignoreKey);
    if (ignoreValue) {
      preferences.setValue(ignoreKey,String.valueOf(Boolean.TRUE));
    }
 else {
      String mappingKey=PublicRenderParameterConfiguration.getMappingKey(publicRenderParameter);
      String mappingValue=ParamUtil.getString(actionRequest,mappingKey);
      if (Validator.isNotNull(mappingValue)) {
        preferences.setValue(mappingKey,mappingValue);
      }
    }
  }
  if (SessionErrors.isEmpty(actionRequest)) {
    preferences.store();
  }
}
