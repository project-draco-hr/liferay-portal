{
  User user=userPersistence.findByPrimaryKey(userId);
  long groupId=serviceContext.getScopeGroupId();
  code=code.trim().toUpperCase();
  if (autoCode) {
    code=getCode();
  }
  Date startDate=PortalUtil.getDate(startDateMonth,startDateDay,startDateYear,startDateHour,startDateMinute,user.getTimeZone(),new CouponStartDateException());
  Date endDate=null;
  if (!neverExpire) {
    endDate=PortalUtil.getDate(endDateMonth,endDateDay,endDateYear,endDateHour,endDateMinute,user.getTimeZone(),new CouponEndDateException());
  }
  if ((endDate != null) && (startDate.after(endDate))) {
    throw new CouponDateException();
  }
  Date now=new Date();
  validate(user.getCompanyId(),groupId,code,autoCode,name,description,limitCategories,limitSkus,minOrder,discount);
  long couponId=counterLocalService.increment();
  ShoppingCoupon coupon=shoppingCouponPersistence.create(couponId);
  coupon.setGroupId(groupId);
  coupon.setCompanyId(user.getCompanyId());
  coupon.setUserId(user.getUserId());
  coupon.setUserName(user.getFullName());
  coupon.setCreateDate(now);
  coupon.setModifiedDate(now);
  coupon.setCode(code);
  coupon.setName(name);
  coupon.setDescription(description);
  coupon.setStartDate(startDate);
  coupon.setEndDate(endDate);
  coupon.setActive(active);
  coupon.setLimitCategories(limitCategories);
  coupon.setLimitSkus(limitSkus);
  coupon.setMinOrder(GetterUtil.getDouble(minOrder));
  coupon.setDiscount(GetterUtil.getDouble(discount));
  coupon.setDiscountType(discountType);
  shoppingCouponPersistence.update(coupon,false);
  return coupon;
}
