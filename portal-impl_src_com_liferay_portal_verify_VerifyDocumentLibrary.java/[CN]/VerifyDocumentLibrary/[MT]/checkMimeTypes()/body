{
  List<DLFileEntry> dlFileEntries=DLFileEntryLocalServiceUtil.getFileEntriesByMimeType(ContentTypes.APPLICATION_OCTET_STREAM);
  if (_log.isDebugEnabled()) {
    _log.debug("Processing " + dlFileEntries.size() + " file entries with "+ ContentTypes.APPLICATION_OCTET_STREAM);
  }
  for (  DLFileEntry dlFileEntry : dlFileEntries) {
    InputStream inputStream=DLFileEntryLocalServiceUtil.getFileAsStream(dlFileEntry.getUserId(),dlFileEntry.getFileEntryId(),dlFileEntry.getVersion(),false);
    String title=DLUtil.getTitleWithExtension(dlFileEntry.getTitle(),dlFileEntry.getExtension());
    String mimeType=MimeTypesUtil.getContentType(inputStream,title);
    if (mimeType.equals(ContentTypes.APPLICATION_OCTET_STREAM)) {
      continue;
    }
    dlFileEntry.setMimeType(mimeType);
    DLFileEntryLocalServiceUtil.updateDLFileEntry(dlFileEntry);
    DLFileVersion dlFileVersion=dlFileEntry.getFileVersion();
    dlFileVersion.setMimeType(mimeType);
    DLFileVersionLocalServiceUtil.updateDLFileVersion(dlFileVersion);
  }
  if (_log.isDebugEnabled()) {
    _log.debug("Fixed file entries with invalid mime types");
  }
}
