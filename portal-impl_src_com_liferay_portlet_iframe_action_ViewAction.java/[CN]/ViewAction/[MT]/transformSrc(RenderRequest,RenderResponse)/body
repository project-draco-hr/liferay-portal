{
  PortletPreferences prefs=req.getPreferences();
  String src=getSrc(req,res);
  boolean auth=GetterUtil.getBoolean(prefs.getValue("auth",StringPool.BLANK));
  String authType=prefs.getValue("auth-type",StringPool.BLANK);
  String userName=getUserName(req,res);
  String password=getPassword(req,res);
  if (auth) {
    if (authType.equals("basic")) {
      int pos=src.indexOf("://");
      String protocol=src.substring(0,pos + 3);
      String url=src.substring(pos + 3,src.length());
      src=protocol + userName + ":"+ password+ "@"+ url;
    }
 else {
      ThemeDisplay themeDisplay=(ThemeDisplay)req.getAttribute(WebKeys.THEME_DISPLAY);
      String portletId=PortalUtil.getPortletId(req);
      Portlet portlet=PortletLocalServiceUtil.getPortletById(themeDisplay.getCompanyId(),portletId);
      src=themeDisplay.getPathMain() + "/" + portlet.getStrutsPath()+ "/proxy?p_l_id="+ themeDisplay.getPlid()+ "&p_p_id="+ portletId;
    }
  }
  return src;
}
