{
  Layout layoutPrototypeLayout=layoutPrototype.getLayout();
  ServiceContext serviceContext=ServiceContextThreadLocal.getServiceContext();
  serviceContext.setAttribute("layoutPrototypeLinkEnabled",linkEnabled);
  serviceContext.setAttribute("layoutPrototypeUuid",layoutPrototype.getUuid());
  targetLayout=LayoutLocalServiceUtil.updateLayout(targetLayout.getGroupId(),targetLayout.isPrivateLayout(),targetLayout.getLayoutId(),targetLayout.getParentLayoutId(),targetLayout.getNameMap(),targetLayout.getTitleMap(),targetLayout.getDescriptionMap(),targetLayout.getKeywordsMap(),targetLayout.getRobotsMap(),layoutPrototypeLayout.getType(),targetLayout.getHidden(),targetLayout.getFriendlyURL(),targetLayout.getIconImage(),null,serviceContext);
  targetLayout=LayoutLocalServiceUtil.updateLayout(targetLayout.getGroupId(),targetLayout.isPrivateLayout(),targetLayout.getLayoutId(),layoutPrototypeLayout.getTypeSettings());
  copyLayoutPrototypePermissions(targetLayout,layoutPrototype);
  copyPortletPermissions(targetLayout,layoutPrototypeLayout);
  copyPortletSetups(layoutPrototypeLayout,targetLayout);
  copyLookAndFeel(targetLayout,layoutPrototypeLayout);
  targetLayout=LayoutLocalServiceUtil.getLayout(targetLayout.getPlid());
  UnicodeProperties typeSettingsProperties=targetLayout.getTypeSettingsProperties();
  typeSettingsProperties.setProperty("last-merge-time",String.valueOf(targetLayout.getModifiedDate().getTime()));
  LayoutLocalServiceUtil.updateLayout(targetLayout,false);
  UnicodeProperties prototypeTypeSettingsProperties=layoutPrototypeLayout.getTypeSettingsProperties();
  prototypeTypeSettingsProperties.setProperty("merge-fail-count","0");
  LayoutLocalServiceUtil.updateLayout(layoutPrototypeLayout,false);
}
