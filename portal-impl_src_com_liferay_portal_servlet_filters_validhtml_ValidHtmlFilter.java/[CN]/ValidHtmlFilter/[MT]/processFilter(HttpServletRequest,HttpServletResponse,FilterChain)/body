{
  if (isEnsureValidHtml(request,response) && !isAlreadyFiltered(request)) {
    request.setAttribute(SKIP_FILTER,Boolean.TRUE);
    if (_log.isDebugEnabled()) {
      String completeURL=HttpUtil.getCompleteURL(request);
      _log.debug("Ensuring valid HTML " + completeURL);
    }
    StringServletResponse stringServerResponse=new StringServletResponse(response);
    processFilter(ValidHtmlFilter.class,request,stringServerResponse,filterChain);
    String content=getContent(request,stringServerResponse.getString());
    ServletResponseUtil.write(response,content);
  }
 else {
    if (_log.isDebugEnabled()) {
      String completeURL=HttpUtil.getCompleteURL(request);
      _log.debug("Not ensuring valid HTML " + completeURL);
    }
    processFilter(ValidHtmlFilter.class,request,response,filterChain);
  }
}
