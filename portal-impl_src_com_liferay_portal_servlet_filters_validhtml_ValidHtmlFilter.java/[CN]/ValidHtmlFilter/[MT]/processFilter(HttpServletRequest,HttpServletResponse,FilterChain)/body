{
  request.setAttribute(SKIP_FILTER,Boolean.TRUE);
  if (_log.isDebugEnabled()) {
    String completeURL=HttpUtil.getCompleteURL(request);
    _log.debug("Ensuring valid HTML " + completeURL);
  }
  BufferCacheServletResponse bufferCacheServletResponse=new BufferCacheServletResponse(response);
  processFilter(ValidHtmlFilter.class,request,bufferCacheServletResponse,filterChain);
  String content=bufferCacheServletResponse.getString();
  String contentType=response.getContentType();
  if ((contentType != null) && contentType.startsWith(ContentTypes.TEXT_HTML)) {
    content=getContent(request,content);
    ServletResponseUtil.write(response,content);
  }
 else {
    ServletResponseUtil.write(response,bufferCacheServletResponse);
  }
}
