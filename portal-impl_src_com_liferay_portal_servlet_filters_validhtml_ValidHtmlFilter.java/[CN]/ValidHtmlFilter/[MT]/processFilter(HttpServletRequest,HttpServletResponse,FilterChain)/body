{
  if (isAlreadyFiltered(request)) {
    processFilter(ValidHtmlFilter.class,request,response,filterChain);
    return;
  }
  request.setAttribute(SKIP_FILTER,Boolean.TRUE);
  if (_log.isDebugEnabled()) {
    String completeURL=HttpUtil.getCompleteURL(request);
    _log.debug("Ensuring valid HTML " + completeURL);
  }
  StringServletResponse stringServerResponse=new StringServletResponse(response);
  processFilter(ValidHtmlFilter.class,request,stringServerResponse,filterChain);
  String contentType=response.getContentType();
  if (contentType != null && contentType.startsWith("text/html")) {
    String content=getContent(request,stringServerResponse.getString());
    ServletResponseUtil.write(response,content);
  }
 else {
    ServletResponseUtil.write(response,stringServerResponse);
  }
}
