{
  Set<String> invalidEmailAddresses=new HashSet<>();
  Set<String> validEmailAddresses=new HashSet<>();
  PortletPreferences portletPreferences=actionRequest.getPreferences();
  int emailMessageMaxRecipients=InvitationUtil.getEmailMessageMaxRecipients(portletPreferences);
  for (int i=0; i < emailMessageMaxRecipients; i++) {
    String emailAddress=ParamUtil.getString(actionRequest,"emailAddress" + i);
    if (Validator.isEmailAddress(emailAddress)) {
      validEmailAddresses.add(emailAddress);
    }
 else     if (Validator.isNotNull(emailAddress)) {
      invalidEmailAddresses.add("emailAddress" + i);
    }
  }
  if (validEmailAddresses.isEmpty() && invalidEmailAddresses.isEmpty()) {
    invalidEmailAddresses.add("emailAddress0");
  }
  if (!invalidEmailAddresses.isEmpty()) {
    SessionErrors.add(actionRequest,"emailAddresses",invalidEmailAddresses);
    return;
  }
  ThemeDisplay themeDisplay=(ThemeDisplay)actionRequest.getAttribute(WebKeys.THEME_DISPLAY);
  User user=themeDisplay.getUser();
  String fromAddress=user.getEmailAddress();
  String fromName=user.getFullName();
  InternetAddress from=new InternetAddress(fromAddress,fromName);
  Layout layout=themeDisplay.getLayout();
  String portalURL=PortalUtil.getPortalURL(actionRequest);
  String layoutFullURL=PortalUtil.getLayoutFullURL(layout,themeDisplay);
  Map<Locale,String> localizedSubjectMap=InvitationUtil.getEmailMessageSubjectMap(portletPreferences);
  Map<Locale,String> localizedBodyMap=InvitationUtil.getEmailMessageBodyMap(portletPreferences);
  Locale locale=user.getLocale();
  Locale defaultLocale=LocaleUtil.getSiteDefault();
  String subject=localizedSubjectMap.get(locale);
  if (Validator.isNull(subject)) {
    subject=localizedSubjectMap.get(defaultLocale);
  }
  String body=localizedBodyMap.get(locale);
  if (Validator.isNull(body)) {
    body=localizedBodyMap.get(defaultLocale);
  }
  subject=StringUtil.replace(subject,new String[]{"[$FROM_ADDRESS$]","[$FROM_NAME$]","[$PAGE_URL$]","[$PORTAL_URL$]"},new String[]{fromAddress,fromName,layoutFullURL,portalURL});
  body=StringUtil.replace(body,new String[]{"[$FROM_ADDRESS$]","[$FROM_NAME$]","[$PAGE_URL$]","[$PORTAL_URL$]"},new String[]{fromAddress,fromName,layoutFullURL,portalURL});
  for (  String emailAddress : validEmailAddresses) {
    InternetAddress to=new InternetAddress(emailAddress);
    MailMessage message=new MailMessage(from,to,subject,body,true);
    Company company=themeDisplay.getCompany();
    message.setMessageId(PortalUtil.getMailId(company.getMx(),InvitationUtil.MESSAGE_POP_PORTLET_PREFIX,PortalUUIDUtil.generate()));
    _mailService.sendEmail(message);
  }
  SessionMessages.add(actionRequest,"invitationSent");
  String redirect=PortalUtil.escapeRedirect(ParamUtil.getString(actionRequest,"redirect"));
  if (Validator.isNotNull(redirect)) {
    actionResponse.setRenderParameter("mvcPath",redirect);
  }
  actionResponse.setRenderParameter("mvcPath","/view.jsp");
}
