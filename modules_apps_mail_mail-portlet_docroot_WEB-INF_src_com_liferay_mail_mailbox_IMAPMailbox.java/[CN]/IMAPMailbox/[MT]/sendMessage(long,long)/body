{
  Account account=AccountLocalServiceUtil.getAccount(accountId);
  Message message=MessageLocalServiceUtil.getMessage(messageId);
  Address[] toAddresses=parseAddresses(message.getTo());
  Address[] ccAddresses=parseAddresses(message.getCc());
  Address[] bccAddresses=parseAddresses(message.getBcc());
  if ((toAddresses.length == 0) && (ccAddresses.length == 0) && (bccAddresses.length == 0)) {
    throw new MailException(MailException.MESSAGE_HAS_NO_RECIPIENTS);
  }
  List<Attachment> attachments=AttachmentLocalServiceUtil.getAttachments(messageId);
  List<MailFile> mailFiles=new ArrayList<>();
  for (  Attachment attachment : attachments) {
    File file=AttachmentLocalServiceUtil.getFile(attachment.getAttachmentId());
    MailFile mailFile=new MailFile(file,attachment.getFileName(),attachment.getSize());
    mailFiles.add(mailFile);
  }
  _imapAccessor.sendMessage(account.getPersonalName(),account.getAddress(),toAddresses,ccAddresses,bccAddresses,message.getSubject(),message.getBody(),mailFiles);
  MessageLocalServiceUtil.deleteMessage(messageId);
}
