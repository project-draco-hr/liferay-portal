{
  if (!FreeMarkerEngineUtil.resourceExists(resourcePath)) {
    if (readOnly) {
      resourcePath=_TPL_DEFAULT_READ_ONLY_PATH;
    }
 else     if (mode.equals(DDMTemplateConstants.TEMPLATE_MODE_EDIT)) {
      resourcePath=_TPL_DEFAULT_MODE_EDIT_PATH;
    }
 else {
      resourcePath=_TPL_DEFAULT_PATH;
    }
  }
  HttpServletRequest request=(HttpServletRequest)pageContext.getRequest();
  FreeMarkerVariablesUtil.insertVariables(freeMarkerContext,request);
  HttpServletResponse response=(HttpServletResponse)pageContext.getResponse();
  Writer writer=new UnsyncStringWriter();
  TaglibFactory portalTaglib=new TaglibFactory(pageContext.getServletContext());
  freeMarkerContext.put("PortalJspTagLibs",portalTaglib);
  final Servlet servlet=(Servlet)pageContext.getPage();
  GenericServlet genericServlet=null;
  if (servlet instanceof GenericServlet) {
    genericServlet=(GenericServlet)servlet;
  }
 else {
    genericServlet=new GenericServlet(){
      @Override public void service(      ServletRequest servletRequest,      ServletResponse servletResponse) throws ServletException, IOException {
        servlet.service(servletRequest,servletResponse);
      }
    }
;
    genericServlet.init(pageContext.getServletConfig());
  }
  ServletContextHashModel servletContextHashModel=new ServletContextHashModel(genericServlet,ObjectWrapper.DEFAULT_WRAPPER);
  freeMarkerContext.put("Application",servletContextHashModel);
  HttpRequestHashModel httpRequestHashModel=new HttpRequestHashModel(request,response,ObjectWrapper.DEFAULT_WRAPPER);
  freeMarkerContext.put("Request",httpRequestHashModel);
  FreeMarkerEngineUtil.mergeTemplate(resourcePath,freeMarkerContext,writer);
  return writer.toString();
}
