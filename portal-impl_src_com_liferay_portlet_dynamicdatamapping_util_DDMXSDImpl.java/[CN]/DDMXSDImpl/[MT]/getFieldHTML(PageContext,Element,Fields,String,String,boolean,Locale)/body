{
  HttpServletRequest request=(HttpServletRequest)pageContext.getRequest();
  ThemeDisplay themeDisplay=(ThemeDisplay)request.getAttribute(WebKeys.THEME_DISPLAY);
  String portletId=PortalUtil.getPortletId(request);
  String portletNamespace=PortalUtil.getPortletNamespace(portletId);
  Map<String,Object> freeMarkerContext=getFreeMarkerContext(element,locale);
  freeMarkerContext.put("portletNamespace",portletNamespace);
  freeMarkerContext.put("namespace",namespace);
  Map<String,Object> fieldStructure=(Map<String,Object>)freeMarkerContext.get("fieldStructure");
  int valuesSize=1;
  if (fields != null) {
    freeMarkerContext.put("fields",fields);
    String name=element.attributeValue("name");
    Field field=fields.get(name);
    if (field != null) {
      List<Serializable> values=field.getValues(themeDisplay.getLocale());
      valuesSize=values.size();
    }
  }
  StringBuffer sb=new StringBuffer(valuesSize);
  for (int i=0; i < valuesSize; i++) {
    fieldStructure.put("randomNamespace",PwdGenerator.getPassword(4));
    fieldStructure.put("valueIndex",i);
    String childrenHTML=getHTML(pageContext,element,fields,namespace,mode,readOnly,locale);
    fieldStructure.put("children",childrenHTML);
    sb.append(processFTL(pageContext,element,mode,readOnly,freeMarkerContext));
  }
  return sb.toString();
}
