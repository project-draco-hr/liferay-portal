{
  StringBundler sb=new StringBundler();
  HttpServletRequest request=(HttpServletRequest)pageContext.getRequest();
  String portletId=PortalUtil.getPortletId(request);
  String portletNamespace=PortalUtil.getPortletNamespace(portletId);
  List<Element> dynamicElementElements=element.elements("dynamic-element");
  for (  Element dynamicElementElement : dynamicElementElements) {
    Map<String,Object> freeMarkerContext=getFreeMarkerContext(dynamicElementElement,locale);
    freeMarkerContext.put("portletNamespace",portletNamespace);
    freeMarkerContext.put("namespace",namespace);
    if (fields != null) {
      freeMarkerContext.put("fields",fields);
    }
    Map<String,Object> field=(Map<String,Object>)freeMarkerContext.get("fieldStructure");
    String childrenHTML=getHTML(pageContext,dynamicElementElement,fields,namespace,mode,readOnly,locale);
    field.put("children",childrenHTML);
    String fieldNamespace=dynamicElementElement.attributeValue("fieldNamespace",_DEFAULT_NAMESPACE);
    TemplateResource templateResource=_defaultTemplateResource;
    boolean fieldReadOnly=GetterUtil.getBoolean(field.get("readOnly"));
    if ((fieldReadOnly && Validator.isNotNull(mode) && mode.equalsIgnoreCase(DDMTemplateConstants.TEMPLATE_MODE_EDIT)) || readOnly) {
      fieldNamespace=_DEFAULT_READ_ONLY_NAMESPACE;
      templateResource=_defaultReadonlyTemplateResource;
    }
    String type=dynamicElementElement.attributeValue("type");
    String templateName=StringUtil.replaceFirst(type,fieldNamespace.concat(StringPool.DASH),StringPool.BLANK);
    StringBundler resourcePath=new StringBundler(5);
    resourcePath.append(_TPL_PATH);
    resourcePath.append(fieldNamespace.toLowerCase());
    resourcePath.append(CharPool.SLASH);
    resourcePath.append(templateName);
    resourcePath.append(_TPL_EXT);
    String resource=resourcePath.toString();
    ClassLoader classLoader=DDMXSDImpl.class.getClassLoader();
    URL templateURL=classLoader.getResource(resource);
    if (templateURL != null) {
      templateResource=new URLTemplateResource(resource,templateURL);
    }
    if (templateResource == null) {
      throw new Exception("Failed to load TemplateResource " + resource);
    }
    Template template=TemplateManagerUtil.getTemplate(TemplateManager.FREEMARKER,templateResource,TemplateContextType.STANDARD);
    for (    Map.Entry<String,Object> entry : freeMarkerContext.entrySet()) {
      template.put(entry.getKey(),entry.getValue());
    }
    sb.append(processFTL(pageContext,template));
  }
  return sb.toString();
}
