{
  distributedRequestAttributes=extractDistributedRequestAttributes(request,Direction.RESPONSE);
  AgentRequest agentRequest=(AgentRequest)request.getAttribute(SPIAgent.SPI_AGENT_REQUEST);
  Map<String,Serializable> originalSessionAttributes=agentRequest.getOriginalSessionAttributes();
  Map<String,Serializable> newSessionAttributes=extractSessionAttributes(request.getSession());
  Set<String> removedSessionAttributeNames=originalSessionAttributes.keySet();
  removedSessionAttributeNames.removeAll(newSessionAttributes.keySet());
  deltaSessionAttributes=new HashMap<String,Serializable>(newSessionAttributes);
  for (  String removedSessionAttributeName : removedSessionAttributeNames) {
    deltaSessionAttributes.put(removedSessionAttributeName,null);
  }
  captureThreadLocals();
}
