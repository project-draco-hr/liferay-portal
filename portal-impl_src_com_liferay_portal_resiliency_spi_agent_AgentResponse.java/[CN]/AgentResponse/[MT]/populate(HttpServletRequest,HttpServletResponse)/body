{
  if (exception != null) {
    throw new PortalResiliencyException("SPI Exception",exception);
  }
  if (portalResiliencyResponse) {
    String typeSetting=(String)distributedRequestAttributes.remove(SPIAgent.SPI_AGENT_LAYOUT_TYPE_SETTINGS);
    if (typeSetting != null) {
      Layout layout=(Layout)request.getAttribute(WebKeys.LAYOUT);
      layout.setTypeSettings(typeSetting);
    }
    for (    Map.Entry<String,Serializable> entry : distributedRequestAttributes.entrySet()) {
      request.setAttribute(entry.getKey(),entry.getValue());
    }
    HttpSession session=request.getSession();
    for (    Map.Entry<String,Serializable> entry : deltaSessionAttributes.entrySet()) {
      session.setAttribute(entry.getKey(),entry.getValue());
    }
    try {
      MetaInfoCacheServletResponse.finishResponse(metaData,response);
      if (byteData != null) {
        ServletResponseUtil.write(response,ByteBuffer.wrap(byteData));
      }
      if (stringData != null) {
        ServletResponseUtil.write(response,CharBuffer.wrap(stringData));
      }
    }
 catch (    IOException ioe) {
      throw new PortalResiliencyException(ioe);
    }
    restoreThreadLocals();
  }
}
