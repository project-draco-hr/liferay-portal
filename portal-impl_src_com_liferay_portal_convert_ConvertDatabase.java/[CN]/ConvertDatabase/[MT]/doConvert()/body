{
  DataSource dataSource=getDataSource();
  Dialect dialect=DialectDetector.getDialect(dataSource);
  DB db=DBFactoryUtil.getDB(dialect,dataSource);
  List<String> modelNames=ModelHintsUtil.getModels();
  Map<String,Tuple> tableDetails=new LinkedHashMap<>();
  Connection connection=dataSource.getConnection();
  try {
    MaintenanceUtil.appendStatus("Collecting information for database tables to migration");
    for (    String modelName : modelNames) {
      if (!modelName.contains(".model.")) {
        continue;
      }
      String implClassName=modelName.replaceFirst("(\\.model\\.)(\\p{Upper}.*)","$1impl.$2Impl");
      if (_log.isDebugEnabled()) {
        _log.debug("Loading class " + implClassName);
      }
      Class<?> implClass=getImplClass(implClassName);
      if (implClass == null) {
        _log.error("Unable to load class " + implClassName);
        continue;
      }
      Field[] fields=implClass.getFields();
      for (      Field field : fields) {
        Tuple tuple=null;
        String fieldName=field.getName();
        if (fieldName.equals("TABLE_NAME") || (fieldName.startsWith("MAPPING_TABLE_") && fieldName.endsWith("_NAME"))) {
          tuple=getTableDetails(implClass,field,fieldName);
        }
        if (tuple != null) {
          String table=(String)tuple.getObject(0);
          tableDetails.put(table,tuple);
        }
      }
    }
    for (    Tuple tuple : _UNMAPPED_TABLES) {
      String table=(String)tuple.getObject(0);
      tableDetails.put(table,tuple);
    }
    if (_log.isDebugEnabled()) {
      _log.debug("Migrating database tables");
    }
    int i=0;
    for (    Tuple tuple : tableDetails.values()) {
      if ((i > 0) && (i % (tableDetails.size() / 4) == 0)) {
        MaintenanceUtil.appendStatus((i * 100 / tableDetails.size()) + "%");
      }
      String table=(String)tuple.getObject(0);
      Object[][] columns=(Object[][])tuple.getObject(1);
      String sqlCreate=(String)tuple.getObject(2);
      migrateTable(db,connection,table,columns,sqlCreate);
      i++;
    }
    if (_log.isDebugEnabled()) {
      _log.debug("Migrating database indexes");
    }
    StartupHelperUtil.updateIndexes(db,connection,false);
    List<ServiceComponent> serviceComponents=ServiceComponentLocalServiceUtil.getLatestServiceComponents();
    Set<String> validIndexNames=new HashSet<>();
    for (    ServiceComponent serviceComponent : serviceComponents) {
      String indexesSQL=serviceComponent.getIndexesSQL();
      db.addIndexes(connection,indexesSQL,validIndexNames);
    }
  }
  finally {
    DataAccess.cleanUp(connection);
  }
  MaintenanceUtil.appendStatus("Please change your JDBC settings before restarting server");
  ShutdownUtil.shutdown(0);
}
