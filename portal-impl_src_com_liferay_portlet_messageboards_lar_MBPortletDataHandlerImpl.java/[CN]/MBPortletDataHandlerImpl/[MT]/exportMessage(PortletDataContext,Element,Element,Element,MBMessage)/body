{
  if (!context.isWithinDateRange(message.getModifiedDate())) {
    return;
  }
  exportParentCategory(context,categoriesEl,message.getCategoryId());
  String path=getMessagePath(context,message);
  if (context.isPathNotProcessed(path)) {
    Element messageEl=messagesEl.addElement("message");
    messageEl.addAttribute("path",path);
    message.setUserUuid(message.getUserUuid());
    message.setPriority(message.getPriority());
    context.addPermissions(MBMessage.class,message.getMessageId());
    if (context.getBooleanParameter(_NAMESPACE,"ratings")) {
      context.addRatingsEntries(MBMessage.class,message.getMessageId());
    }
    if (context.getBooleanParameter(_NAMESPACE,"tags")) {
      context.addAssetTags(MBMessage.class,message.getMessageId());
    }
    if (context.getBooleanParameter(_NAMESPACE,"attachments") && message.isAttachments()) {
      for (      String attachment : message.getAttachmentsFiles()) {
        int pos=attachment.lastIndexOf(StringPool.FORWARD_SLASH);
        String name=attachment.substring(pos + 1);
        String binPath=getMessageAttachementBinPath(context,message,name);
        Element attachmentEl=messageEl.addElement("attachment");
        attachmentEl.addAttribute("name",name);
        attachmentEl.addAttribute("bin-path",binPath);
        byte[] bytes=DLServiceUtil.getFile(context.getCompanyId(),CompanyConstants.SYSTEM,attachment);
        context.addZipEntry(binPath,bytes);
      }
      message.setAttachmentsDir(message.getAttachmentsDir());
    }
    if (context.getBooleanParameter(_NAMESPACE,"flags")) {
      List<MBMessageFlag> messageFlags=MBMessageFlagUtil.findByMessageId(message.getMessageId());
      for (      MBMessageFlag messageFlag : messageFlags) {
        exportMessageFlag(context,messageFlagsEl,messageFlag);
      }
    }
    context.addZipEntry(path,message);
  }
}
