{
  if (!portletDataContext.isWithinDateRange(message.getModifiedDate())) {
    return;
  }
  if (message.getStatus() != WorkflowConstants.STATUS_APPROVED) {
    return;
  }
  exportParentCategory(portletDataContext,categoriesElement,message.getCategoryId());
  String path=getMessagePath(portletDataContext,message);
  if (portletDataContext.isPathNotProcessed(path)) {
    Element messageElement=messagesElement.addElement("message");
    messageElement.addAttribute("path",path);
    message.setUserUuid(message.getUserUuid());
    message.setPriority(message.getPriority());
    portletDataContext.addPermissions(MBMessage.class,message.getMessageId());
    portletDataContext.addLocks(MBThread.class,String.valueOf(message.getThreadId()));
    if (portletDataContext.getBooleanParameter(_NAMESPACE,"ratings")) {
      portletDataContext.addRatingsEntries(MBMessage.class,message.getMessageId());
    }
    if (portletDataContext.getBooleanParameter(_NAMESPACE,"tags")) {
      portletDataContext.addAssetTags(MBMessage.class,message.getMessageId());
    }
    if (portletDataContext.getBooleanParameter(_NAMESPACE,"attachments") && message.isAttachments()) {
      for (      String attachment : message.getAttachmentsFiles()) {
        int pos=attachment.lastIndexOf(CharPool.FORWARD_SLASH);
        String name=attachment.substring(pos + 1);
        String binPath=getMessageAttachementBinPath(portletDataContext,message,name);
        Element attachmentElement=messageElement.addElement("attachment");
        attachmentElement.addAttribute("name",name);
        attachmentElement.addAttribute("bin-path",binPath);
        byte[] bytes=DLLocalServiceUtil.getFile(portletDataContext.getCompanyId(),CompanyConstants.SYSTEM,attachment);
        portletDataContext.addZipEntry(binPath,bytes);
      }
      message.setAttachmentsDir(message.getAttachmentsDir());
    }
    if (portletDataContext.getBooleanParameter(_NAMESPACE,"message-flags")) {
      List<MBMessageFlag> messageFlags=MBMessageFlagUtil.findByMessageId(message.getMessageId());
      for (      MBMessageFlag messageFlag : messageFlags) {
        exportMessageFlag(portletDataContext,messageFlagsElement,messageFlag);
      }
    }
    portletDataContext.addZipEntry(path,messageElement,message);
  }
}
