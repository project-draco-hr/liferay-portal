{
  long userId=context.getUserId(message.getUserUuid());
  String userName=message.getUserName();
  Map<Long,Long> categoryPKs=(Map<Long,Long>)context.getNewPrimaryKeysMap(MBCategory.class);
  long categoryId=MapUtil.getLong(categoryPKs,message.getCategoryId(),message.getCategoryId());
  Map<Long,Long> threadPKs=(Map<Long,Long>)context.getNewPrimaryKeysMap(MBThread.class);
  long threadId=MapUtil.getLong(threadPKs,message.getThreadId(),message.getThreadId());
  Map<Long,Long> messagePKs=(Map<Long,Long>)context.getNewPrimaryKeysMap(MBMessage.class);
  long parentMessageId=MapUtil.getLong(messagePKs,message.getParentMessageId(),message.getParentMessageId());
  List<ObjectValuePair<String,byte[]>> files=new ArrayList<ObjectValuePair<String,byte[]>>();
  List<String> existingFiles=new ArrayList<String>();
  if (context.getBooleanParameter(_NAMESPACE,"attachments") && message.isAttachments()) {
    List<Element> attachmentElements=messageElement.elements("attachment");
    for (    Element attachmentElement : attachmentElements) {
      String name=attachmentElement.attributeValue("name");
      String binPath=attachmentElement.attributeValue("bin-path");
      byte[] bytes=context.getZipEntryAsByteArray(binPath);
      files.add(new ObjectValuePair<String,byte[]>(name,bytes));
    }
    if (files.size() <= 0) {
      _log.error("Could not find attachments for message " + message.getMessageId());
    }
  }
  String[] assetTagNames=null;
  if (context.getBooleanParameter(_NAMESPACE,"tags")) {
    assetTagNames=context.getAssetTagNames(MBMessage.class,message.getMessageId());
  }
  ServiceContext serviceContext=new ServiceContext();
  serviceContext.setAddCommunityPermissions(true);
  serviceContext.setAddGuestPermissions(true);
  serviceContext.setAssetTagNames(assetTagNames);
  serviceContext.setCreateDate(message.getCreateDate());
  serviceContext.setModifiedDate(message.getModifiedDate());
  serviceContext.setScopeGroupId(context.getScopeGroupId());
  if (message.getStatus() != WorkflowConstants.STATUS_APPROVED) {
    serviceContext.setWorkflowAction(WorkflowConstants.ACTION_SAVE_DRAFT);
  }
  if (MBUtil.isRegularCategoryId(categoryId) && (categoryId == message.getCategoryId())) {
    String path=getImportCategoryPath(context,categoryId);
    MBCategory category=(MBCategory)context.getZipEntryAsObject(path);
    importCategory(context,category);
    categoryId=MapUtil.getLong(categoryPKs,message.getCategoryId(),message.getCategoryId());
  }
  MBMessage importedMessage=null;
  if (context.isDataStrategyMirror()) {
    MBMessage existingMessage=MBMessageUtil.fetchByUUID_G(message.getUuid(),context.getScopeGroupId());
    if (existingMessage == null) {
      serviceContext.setUuid(message.getUuid());
      importedMessage=MBMessageLocalServiceUtil.addMessage(userId,userName,context.getScopeGroupId(),categoryId,threadId,parentMessageId,message.getSubject(),message.getBody(),files,message.getAnonymous(),message.getPriority(),message.getAllowPingbacks(),serviceContext);
    }
 else {
      importedMessage=MBMessageLocalServiceUtil.updateMessage(userId,existingMessage.getMessageId(),message.getSubject(),message.getBody(),files,existingFiles,message.getPriority(),message.getAllowPingbacks(),serviceContext);
    }
  }
 else {
    importedMessage=MBMessageLocalServiceUtil.addMessage(userId,userName,context.getScopeGroupId(),categoryId,threadId,parentMessageId,message.getSubject(),message.getBody(),files,message.getAnonymous(),message.getPriority(),message.getAllowPingbacks(),serviceContext);
  }
  threadPKs.put(message.getThreadId(),importedMessage.getThreadId());
  messagePKs.put(message.getMessageId(),importedMessage.getMessageId());
  context.importLocks(MBThread.class,String.valueOf(message.getThreadId()),String.valueOf(importedMessage.getThreadId()));
  context.importPermissions(MBMessage.class,message.getMessageId(),importedMessage.getMessageId());
  if (context.getBooleanParameter(_NAMESPACE,"ratings")) {
    context.importRatingsEntries(MBMessage.class,message.getMessageId(),importedMessage.getMessageId());
  }
}
