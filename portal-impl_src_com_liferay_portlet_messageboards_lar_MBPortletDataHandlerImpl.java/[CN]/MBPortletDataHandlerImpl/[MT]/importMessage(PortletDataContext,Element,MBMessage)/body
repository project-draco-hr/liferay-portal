{
  long userId=portletDataContext.getUserId(message.getUserUuid());
  String userName=message.getUserName();
  Map<Long,Long> categoryPKs=(Map<Long,Long>)portletDataContext.getNewPrimaryKeysMap(MBCategory.class);
  long categoryId=MapUtil.getLong(categoryPKs,message.getCategoryId(),message.getCategoryId());
  Map<Long,Long> threadPKs=(Map<Long,Long>)portletDataContext.getNewPrimaryKeysMap(MBThread.class);
  long threadId=MapUtil.getLong(threadPKs,message.getThreadId(),message.getThreadId());
  Map<Long,Long> messagePKs=(Map<Long,Long>)portletDataContext.getNewPrimaryKeysMap(MBMessage.class);
  long parentMessageId=MapUtil.getLong(messagePKs,message.getParentMessageId(),message.getParentMessageId());
  List<String> existingFiles=new ArrayList<String>();
  List<ObjectValuePair<String,InputStream>> files=getAttachments(portletDataContext,messageElement,message);
  try {
    ServiceContext serviceContext=portletDataContext.createServiceContext(messageElement,message,_NAMESPACE);
    if (message.getStatus() != WorkflowConstants.STATUS_APPROVED) {
      serviceContext.setWorkflowAction(WorkflowConstants.ACTION_SAVE_DRAFT);
    }
    categoryId=getCategoryId(portletDataContext,message,categoryPKs,categoryId);
    MBMessage importedMessage=null;
    if (portletDataContext.isDataStrategyMirror()) {
      MBMessage existingMessage=MBMessageUtil.fetchByUUID_G(message.getUuid(),portletDataContext.getScopeGroupId());
      if (existingMessage == null) {
        serviceContext.setUuid(message.getUuid());
        importedMessage=MBMessageLocalServiceUtil.addMessage(userId,userName,portletDataContext.getScopeGroupId(),categoryId,threadId,parentMessageId,message.getSubject(),message.getBody(),message.getFormat(),files,message.getAnonymous(),message.getPriority(),message.getAllowPingbacks(),serviceContext);
      }
 else {
        importedMessage=MBMessageLocalServiceUtil.updateMessage(userId,existingMessage.getMessageId(),message.getSubject(),message.getBody(),files,existingFiles,message.getPriority(),message.getAllowPingbacks(),serviceContext);
      }
    }
 else {
      importedMessage=MBMessageLocalServiceUtil.addMessage(userId,userName,portletDataContext.getScopeGroupId(),categoryId,threadId,parentMessageId,message.getSubject(),message.getBody(),message.getFormat(),files,message.getAnonymous(),message.getPriority(),message.getAllowPingbacks(),serviceContext);
    }
    threadPKs.put(message.getThreadId(),importedMessage.getThreadId());
    portletDataContext.importClassedModel(message,importedMessage,_NAMESPACE);
  }
  finally {
    for (    ObjectValuePair<String,InputStream> ovp : files) {
      InputStream inputStream=ovp.getValue();
      StreamUtil.cleanUp(inputStream);
    }
  }
}
