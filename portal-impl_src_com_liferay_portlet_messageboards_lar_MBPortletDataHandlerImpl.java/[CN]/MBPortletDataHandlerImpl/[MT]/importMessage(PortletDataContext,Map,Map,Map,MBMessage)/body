{
  long userId=context.getUserId(message.getUserUuid());
  long categoryId=MapUtil.getLong(categoryPKs,message.getCategoryId(),message.getCategoryId());
  long threadId=MapUtil.getLong(threadPKs,message.getThreadId(),message.getThreadId());
  long parentMessageId=MapUtil.getLong(messagePKs,message.getParentMessageId(),message.getParentMessageId());
  List files=new ArrayList();
  if (context.getBooleanParameter(_NAMESPACE,"attachments") && message.isAttachments()) {
    files=(List)context.getZipReader().getFolderEntries().get(message.getAttachmentsDir() + "/");
    if (files == null) {
      _log.error("Could not find attachments for message " + message.getMessageId());
      files=new ArrayList();
    }
  }
  String[] tagsEntries=null;
  if (context.getBooleanParameter(_NAMESPACE,"tags")) {
    tagsEntries=context.getTagsEntries(MBMessage.class,message.getPrimaryKeyObj());
  }
  PortletPreferences prefs=null;
  boolean addCommunityPermissions=true;
  boolean addGuestPermissions=true;
  ThemeDisplay themeDisplay=null;
  MBMessage existingMessage=null;
  try {
    MBCategoryUtil.findByPrimaryKey(categoryId);
    if (parentMessageId != MBMessageImpl.DEFAULT_PARENT_MESSAGE_ID) {
      MBMessageUtil.findByPrimaryKey(parentMessageId);
      MBThreadUtil.findByPrimaryKey(threadId);
    }
    if (context.getDataStrategy().equals(PortletDataHandlerKeys.DATA_STRATEGY_MIRROR)) {
      try {
        existingMessage=MBMessageFinderUtil.findByUuid_G(message.getUuid(),context.getGroupId());
        MBMessageLocalServiceUtil.updateMessage(userId,existingMessage.getMessageId(),message.getSubject(),message.getBody(),files,message.getPriority(),tagsEntries,prefs,themeDisplay);
      }
 catch (      NoSuchMessageException nsme) {
        existingMessage=MBMessageLocalServiceUtil.addMessage(message.getUuid(),userId,categoryId,threadId,parentMessageId,message.getSubject(),message.getBody(),files,message.getAnonymous(),message.getPriority(),tagsEntries,prefs,addCommunityPermissions,addGuestPermissions,themeDisplay);
      }
    }
 else {
      existingMessage=MBMessageLocalServiceUtil.addMessage(userId,categoryId,threadId,parentMessageId,message.getSubject(),message.getBody(),files,message.getAnonymous(),message.getPriority(),tagsEntries,prefs,addCommunityPermissions,addGuestPermissions,themeDisplay);
    }
    threadPKs.put(new Long(message.getThreadId()),new Long(existingMessage.getThreadId()));
    messagePKs.put(message.getPrimaryKeyObj(),existingMessage.getPrimaryKeyObj());
  }
 catch (  NoSuchCategoryException nsce) {
    _log.error("Could not find the parent category for message " + message.getMessageId());
  }
catch (  NoSuchMessageException nsme) {
    _log.error("Could not find the parent message for message " + message.getMessageId());
  }
catch (  NoSuchThreadException nste) {
    _log.error("Could not find the thread for message " + message.getMessageId());
  }
}
