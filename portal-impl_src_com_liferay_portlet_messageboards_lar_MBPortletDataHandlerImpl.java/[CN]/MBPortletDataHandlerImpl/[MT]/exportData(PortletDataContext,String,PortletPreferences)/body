{
  try {
    XStream xStream=new XStream();
    Document doc=DocumentHelper.createDocument();
    Element root=doc.addElement("message-boards-data");
    root.addAttribute("group-id",String.valueOf(context.getGroupId()));
    List<MBCategory> categories=MBCategoryUtil.findByGroupId(context.getGroupId());
    List<MBMessage> messages=new ArrayList<MBMessage>();
    Iterator<MBCategory> categoriesItr=categories.iterator();
    while (categoriesItr.hasNext()) {
      MBCategory category=categoriesItr.next();
      if (context.addPrimaryKey(MBCategory.class,category.getPrimaryKeyObj())) {
        categoriesItr.remove();
      }
 else {
        category.setUserUuid(category.getUserUuid());
        List<MBMessage> categoryMessages=MBMessageUtil.findByCategoryId(category.getCategoryId());
        if (context.hasDateRange()) {
          for (          MBMessage message : categoryMessages) {
            if (context.isWithinDateRange(message.getModifiedDate())) {
              messages.add(message);
            }
          }
          if (!context.isWithinDateRange(category.getModifiedDate())) {
            categoriesItr.remove();
          }
        }
 else {
          messages.addAll(categoryMessages);
        }
      }
    }
    String xml=xStream.toXML(categories);
    Element el=root.addElement("message-board-categories");
    Document tempDoc=DocumentUtil.readDocumentFromXML(xml);
    el.content().add(tempDoc.getRootElement().createCopy());
    List<MBMessageFlag> flags=new ArrayList<MBMessageFlag>();
    Iterator<MBMessage> messagesItr=messages.iterator();
    while (messagesItr.hasNext()) {
      MBMessage message=messagesItr.next();
      if (context.addPrimaryKey(MBMessage.class,message.getPrimaryKeyObj())) {
        messagesItr.remove();
      }
 else {
        message.setUserUuid(message.getUserUuid());
        message.setPriority(message.getPriority());
        if (context.getBooleanParameter(_NAMESPACE,"tags")) {
          context.addTagsEntries(MBMessage.class,message.getPrimaryKeyObj());
        }
        if (context.getBooleanParameter(_NAMESPACE,"attachments") && message.isAttachments()) {
          String[] attachments=message.getAttachmentsFiles();
          for (int i=0; i < attachments.length; i++) {
            String attachment=attachments[i];
            byte[] byteArray=DLServiceUtil.getFile(context.getCompanyId(),CompanyConstants.SYSTEM,attachment);
            context.getZipWriter().addEntry(attachment,byteArray);
          }
          message.setAttachmentsDir(message.getAttachmentsDir());
        }
        if (context.getBooleanParameter(_NAMESPACE,"flags")) {
          List<MBMessageFlag> messageFlags=MBMessageFlagUtil.findByMessageId(message.getMessageId());
          flags.addAll(messageFlags);
        }
      }
    }
    xml=xStream.toXML(messages);
    el=root.addElement("message-board-messages");
    tempDoc=DocumentUtil.readDocumentFromXML(xml);
    el.content().add(tempDoc.getRootElement().createCopy());
    Iterator<MBMessageFlag> flagsItr=flags.iterator();
    while (flagsItr.hasNext()) {
      MBMessageFlag flag=flagsItr.next();
      if (context.addPrimaryKey(MBMessageFlag.class,flag.getPrimaryKeyObj())) {
        flagsItr.remove();
      }
 else {
        flag.setUserUuid(flag.getUserUuid());
      }
    }
    xml=xStream.toXML(flags);
    el=root.addElement("message-board-flags");
    tempDoc=DocumentUtil.readDocumentFromXML(xml);
    el.content().add(tempDoc.getRootElement().createCopy());
    List<MBBan> bans=new ArrayList<MBBan>();
    if (context.getBooleanParameter(_NAMESPACE,"user-bans")) {
      bans=MBBanUtil.findByGroupId(context.getGroupId());
      Iterator<MBBan> bansItr=bans.iterator();
      while (bansItr.hasNext()) {
        MBBan ban=bansItr.next();
        if (context.addPrimaryKey(MBBan.class,ban.getPrimaryKeyObj())) {
          bansItr.remove();
        }
 else {
          ban.setBanUserUuid(ban.getBanUserUuid());
          ban.setUserUuid(ban.getUserUuid());
        }
      }
    }
    xml=xStream.toXML(bans);
    el=root.addElement("message-board-bans");
    tempDoc=DocumentUtil.readDocumentFromXML(xml);
    el.content().add(tempDoc.getRootElement().createCopy());
    return doc.asXML();
  }
 catch (  Exception e) {
    throw new PortletDataException(e);
  }
}
