{
  String portletId=portletDataContext.getPortletId();
  Group scopeGroup=_groupLocalService.fetchGroup(portletDataContext.getScopeGroupId());
  Group liveGroup=scopeGroup.getLiveGroup();
  boolean isPartialStaging=false;
  if (ExportImportThreadLocal.isStagingInProcess() && (liveGroup != null) && !liveGroup.isStagedPortlet(portletId)) {
    isPartialStaging=true;
  }
  String hiddenNodeNames=portletPreferences.getValue("hiddenNodes",null);
  for (  String hiddenNodeName : StringUtil.split(hiddenNodeNames)) {
    WikiNode hiddenWikiNode=null;
    try {
      hiddenWikiNode=_wikiNodeLocalService.getNode(portletDataContext.getScopeGroupId(),hiddenNodeName);
    }
 catch (    PortalException pe1) {
      if (isPartialStaging) {
        try {
          _wikiNodeLocalService.getNode(liveGroup.getGroupId(),hiddenNodeName);
        }
 catch (        PortalException pe2) {
          throw new PortletDataException("Unable to find wiki node " + hiddenNodeName + " for preference of portlet "+ portletId,pe2);
        }
        continue;
      }
 else {
        throw new PortletDataException("Unable to find wiki node " + hiddenNodeName + " for preference of portlet "+ portletId,pe1);
      }
    }
    StagedModelDataHandlerUtil.exportReferenceStagedModel(portletDataContext,portletId,hiddenWikiNode);
  }
  String visibleNodeNames=portletPreferences.getValue("visibleNodes",null);
  for (  String visibleNodeName : StringUtil.split(visibleNodeNames)) {
    WikiNode visibleWikiNode=null;
    try {
      visibleWikiNode=_wikiNodeLocalService.getNode(portletDataContext.getScopeGroupId(),visibleNodeName);
    }
 catch (    PortalException pe1) {
      if (isPartialStaging) {
        try {
          _wikiNodeLocalService.getNode(liveGroup.getGroupId(),visibleNodeName);
        }
 catch (        PortalException pe2) {
          throw new PortletDataException("Unable to find wiki node " + visibleNodeName + " for preference of portlet "+ portletId,pe2);
        }
        continue;
      }
 else {
        throw new PortletDataException("Unable to find wiki node " + visibleNodeName + " for preference of portlet "+ portletId,pe1);
      }
    }
    StagedModelDataHandlerUtil.exportReferenceStagedModel(portletDataContext,portletId,visibleWikiNode);
  }
  return portletPreferences;
}
