{
  HttpSession ses=req.getSession();
  JabberSession jabberSes=(JabberSession)ses.getAttribute(WebKeys.JABBER_XMPP_SESSION);
  JSONObject jo=new JSONObject();
  String waitCmd="";
  try {
    MessageWait msgWait=jabberSes.getMessageWait();
    if (msgWait != null) {
      jabberSes.setMessageWait(null);
      msgWait.expire();
    }
    msgWait=new MessageWait();
    msgWait.setSessionId(ses.getId());
    jabberSes.setMessageWait(msgWait);
    msgWait.waitForMessages();
    jabberSes=(JabberSession)ses.getAttribute(WebKeys.JABBER_XMPP_SESSION);
    msgWait=jabberSes.getMessageWait();
    if (msgWait == null) {
      jo.put("status","failure");
    }
 else     if (msgWait.isTimedOut()) {
      jo.put("status","timedOut");
    }
 else {
      waitCmd=msgWait.getCmd();
      if ("getRoster".equals(waitCmd)) {
        jo=getRosterEntries(req);
      }
 else       if ("getMessages".equals(waitCmd)) {
        jo=getChatMessages(req);
      }
      jo.put("status","success");
    }
  }
 catch (  Exception e) {
    jo.put("status","failure");
  }
 finally {
    jabberSes.setMessageWait(null);
  }
  return jo;
}
