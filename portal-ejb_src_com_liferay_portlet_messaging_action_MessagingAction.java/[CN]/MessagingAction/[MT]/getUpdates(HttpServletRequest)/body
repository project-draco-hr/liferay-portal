{
  HttpSession ses=req.getSession();
  JabberSession jabberSes=(JabberSession)ses.getAttribute(WebKeys.JABBER_XMPP_SESSION);
  JSONObject jo=new JSONObject();
  String waitCmd="";
  try {
    MessageWait msgWait=jabberSes.getMessageWait();
    if (msgWait != null) {
      release(req);
    }
    msgWait=new MessageWait();
    jabberSes.setMessageWait(msgWait);
    msgWait.waitForMessages();
    msgWait=jabberSes.getMessageWait();
    if (msgWait == null) {
      jo.put("status","failure");
    }
 else {
      waitCmd=msgWait.getCmd();
      if ("getRoster".equals(waitCmd)) {
        jo=getRosterEntries(req);
      }
 else {
        jo=getChatMessages(req);
      }
      jo.put("status","success");
    }
  }
 catch (  Exception e) {
    jo.put("status","failure");
  }
 finally {
    jabberSes.setMessageWait(null);
  }
  return jo;
}
