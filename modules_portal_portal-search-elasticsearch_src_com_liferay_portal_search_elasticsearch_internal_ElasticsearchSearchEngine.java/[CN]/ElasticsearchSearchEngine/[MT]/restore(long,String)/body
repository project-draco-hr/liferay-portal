{
  backupName=StringUtil.toLowerCase(backupName);
  validateBackupName(backupName);
  AdminClient adminClient=_elasticsearchConnectionManager.getAdminClient();
  IndicesAdminClient indicesAdminClient=adminClient.indices();
  CloseIndexRequestBuilder closeIndexRequestBuilder=indicesAdminClient.prepareClose(String.valueOf(companyId));
  try {
    CloseIndexResponse closeIndexResponse=closeIndexRequestBuilder.get();
    LogUtil.logActionResponse(_log,closeIndexResponse);
  }
 catch (  Exception e) {
    throw new SearchException(e);
  }
  ClusterAdminClient clusterAdminClient=_elasticsearchConnectionManager.getClusterAdminClient();
  RestoreSnapshotRequestBuilder restoreSnapshotRequestBuilder=clusterAdminClient.prepareRestoreSnapshot(_BACKUP_REPOSITORY_NAME,backupName);
  restoreSnapshotRequestBuilder.setIndices(String.valueOf(companyId));
  restoreSnapshotRequestBuilder.setWaitForCompletion(true);
  try {
    RestoreSnapshotResponse restoreSnapshotResponse=restoreSnapshotRequestBuilder.get();
    LogUtil.logActionResponse(_log,restoreSnapshotResponse);
  }
 catch (  Exception e) {
    throw new SearchException(e);
  }
  ClusterHealthResponse clusterHealthResponse=null;
  if (PortalRunMode.isTestMode()) {
    clusterHealthResponse=_elasticsearchConnectionManager.getClusterHealthResponse(Time.HOUR);
  }
 else {
    clusterHealthResponse=_elasticsearchConnectionManager.getClusterHealthResponse(30 * Time.SECOND);
  }
  if (clusterHealthResponse.getStatus() == ClusterHealthStatus.RED) {
    throw new IllegalStateException("Unable to initialize Elasticsearch cluster: " + clusterHealthResponse);
  }
}
