{
  Group group=GroupTestUtil.addGroup();
  group=GroupTestUtil.updateDisplaySettings(group.getGroupId(),groupAvailableLocales,groupDefaultLocale);
  Map<Locale,String> nameMap=new HashMap<Locale,String>();
  nameMap.put(LocaleUtil.GERMANY,"Zuhause");
  nameMap.put(LocaleUtil.SPAIN,"Casa");
  nameMap.put(LocaleUtil.US,"Home");
  Map<Locale,String> friendlyURLMap=new HashMap<Locale,String>();
  friendlyURLMap.put(LocaleUtil.GERMANY,"/zuhause");
  friendlyURLMap.put(LocaleUtil.SPAIN,"/casa");
  friendlyURLMap.put(LocaleUtil.US,"/home");
  Layout layout=LayoutTestUtil.addLayout(group.getGroupId(),false,nameMap,friendlyURLMap);
  String completeURL=generateURL(portalDomain,i18nPath,group.getFriendlyURL(),layout.getFriendlyURL());
  setVirtualHost(layout,virtualHostname);
  ThemeDisplay themeDisplay=getThemeDisplay(group);
  themeDisplay.setPortalURL("http://" + portalDomain + ":8080/");
  String actualCanonicalURL=PortalUtil.getCanonicalURL(completeURL,themeDisplay,layout,true);
  String expectedCanonicalURL=generateURL(portalDomain,StringPool.BLANK,group.getFriendlyURL(),expectedFriendlyURL);
  Assert.assertEquals(expectedCanonicalURL,actualCanonicalURL);
}
