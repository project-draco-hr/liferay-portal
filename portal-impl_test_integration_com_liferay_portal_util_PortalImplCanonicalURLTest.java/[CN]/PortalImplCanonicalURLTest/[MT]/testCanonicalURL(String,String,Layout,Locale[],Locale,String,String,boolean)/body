{
  _group=GroupTestUtil.updateDisplaySettings(_group.getGroupId(),groupAvailableLocales,groupDefaultLocale);
  String completeURL=generateURL(portalDomain,i18nPath,_group.getFriendlyURL(),layout.getFriendlyURL());
  setVirtualHost(layout.getCompanyId(),virtualHostname);
  ThemeDisplay themeDisplay=getThemeDisplay(_group);
  themeDisplay.setPortalURL("http://" + portalDomain + ":8080/");
  String actualCanonicalURL=PortalUtil.getCanonicalURL(completeURL,themeDisplay,layout,forceLayoutFriendlyURL);
  String expectedCanonicalURL=generateURL(portalDomain,StringPool.BLANK,_group.getFriendlyURL(),expectedFriendlyURL);
  Assert.assertEquals(expectedCanonicalURL,actualCanonicalURL);
}
