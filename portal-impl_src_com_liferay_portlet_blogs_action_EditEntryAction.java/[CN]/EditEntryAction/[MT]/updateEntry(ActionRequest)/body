{
  long entryId=ParamUtil.getLong(actionRequest,"entryId");
  String title=ParamUtil.getString(actionRequest,"title");
  String subtitle=ParamUtil.getString(actionRequest,"subtitle");
  String description=ParamUtil.getString(actionRequest,"description");
  String content=ParamUtil.getString(actionRequest,"content");
  int displayDateMonth=ParamUtil.getInteger(actionRequest,"displayDateMonth");
  int displayDateDay=ParamUtil.getInteger(actionRequest,"displayDateDay");
  int displayDateYear=ParamUtil.getInteger(actionRequest,"displayDateYear");
  int displayDateHour=ParamUtil.getInteger(actionRequest,"displayDateHour");
  int displayDateMinute=ParamUtil.getInteger(actionRequest,"displayDateMinute");
  int displayDateAmPm=ParamUtil.getInteger(actionRequest,"displayDateAmPm");
  if (displayDateAmPm == Calendar.PM) {
    displayDateHour+=12;
  }
  boolean allowPingbacks=ParamUtil.getBoolean(actionRequest,"allowPingbacks");
  boolean allowTrackbacks=ParamUtil.getBoolean(actionRequest,"allowTrackbacks");
  String[] trackbacks=StringUtil.split(ParamUtil.getString(actionRequest,"trackbacks"));
  boolean smallImage=false;
  long smallImageFileEntryId=0;
  String smallImageURL=null;
  String smallImageFileName=null;
  InputStream smallImageInputStream=null;
  BlogsEntry entry=null;
  String oldUrlTitle=null;
  try {
    boolean ajax=ParamUtil.getBoolean(actionRequest,"ajax");
    if (!ajax) {
      smallImage=ParamUtil.getBoolean(actionRequest,"smallImage");
      smallImageFileEntryId=ParamUtil.getLong(actionRequest,"smallImageFileEntryId");
      smallImageURL=ParamUtil.getString(actionRequest,"smallImageURL");
      if (smallImage && Validator.isNull(smallImageURL)) {
        UploadPortletRequest uploadPortletRequest=PortalUtil.getUploadPortletRequest(actionRequest);
        smallImageFileName=uploadPortletRequest.getFileName("smallFile");
        smallImageInputStream=uploadPortletRequest.getFileAsStream("smallFile");
      }
    }
    ServiceContext serviceContext=ServiceContextFactory.getInstance(BlogsEntry.class.getName(),actionRequest);
    entry=null;
    oldUrlTitle=StringPool.BLANK;
    if (entryId <= 0) {
      entry=BlogsEntryServiceUtil.addEntry(title,subtitle,description,content,displayDateMonth,displayDateDay,displayDateYear,displayDateHour,displayDateMinute,allowPingbacks,allowTrackbacks,trackbacks,smallImage,smallImageURL,smallImageFileName,smallImageInputStream,smallImageFileEntryId,serviceContext);
      AssetPublisherUtil.addAndStoreSelection(actionRequest,BlogsEntry.class.getName(),entry.getEntryId(),-1);
    }
 else {
      entry=BlogsEntryLocalServiceUtil.getEntry(entryId);
      String tempOldUrlTitle=entry.getUrlTitle();
      entry=BlogsEntryServiceUtil.updateEntry(entryId,title,subtitle,description,content,displayDateMonth,displayDateDay,displayDateYear,displayDateHour,displayDateMinute,allowPingbacks,allowTrackbacks,trackbacks,smallImage,smallImageURL,smallImageFileName,smallImageInputStream,smallImageFileEntryId,serviceContext);
      if (!tempOldUrlTitle.equals(entry.getUrlTitle())) {
        oldUrlTitle=tempOldUrlTitle;
      }
      AssetPublisherUtil.addAndStoreSelection(actionRequest,BlogsEntry.class.getName(),entry.getEntryId(),-1);
    }
  }
  finally {
    StreamUtil.cleanUp(smallImageInputStream);
  }
  return new Object[]{entry,oldUrlTitle};
}
