{
  if ((expirationTime <= 0) || (expirationTime > DLFolderImpl.LOCK_EXPIRATION_TIME)) {
    expirationTime=DLFolderImpl.LOCK_EXPIRATION_TIME;
  }
  Lock lock=lockService.lock(DLFolder.class.getName(),folderId,getUser().getUserId(),owner,inheritable,expirationTime);
  Set<String> fileNames=new HashSet<String>();
  try {
    List<DLFileEntry> fileEntries=dlFileEntryService.getFileEntries(folderId);
    for (    DLFileEntry fileEntry : fileEntries) {
      dlFileEntryService.lockFileEntry(folderId,fileEntry.getName(),owner,expirationTime);
      fileNames.add(fileEntry.getName());
    }
  }
 catch (  Exception e) {
    for (    String fileName : fileNames) {
      dlFileEntryService.unlockFileEntry(folderId,fileName);
    }
    unlockFolder(folderId,lock.getUuid());
    if (e instanceof PortalException) {
      throw (PortalException)e;
    }
 else     if (e instanceof RemoteException) {
      throw (RemoteException)e;
    }
 else     if (e instanceof SystemException) {
      throw (SystemException)e;
    }
 else {
      throw new PortalException(e);
    }
  }
  return lock;
}
