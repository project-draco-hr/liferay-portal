{
  if ((expirationTime <= 0) || (expirationTime > DLFolderImpl.LOCK_EXPIRATION_TIME)) {
    expirationTime=DLFolderImpl.LOCK_EXPIRATION_TIME;
  }
  Lock lock=lockLocalService.lock(getUser().getUserId(),DLFolder.class.getName(),folderId,owner,inheritable,expirationTime);
  Set<String> fileNames=new HashSet<String>();
  DLFolder folder=dlFolderPersistence.findByPrimaryKey(folderId);
  List<DLFolder> folders=dlFolderPersistence.findByG_P(folder.getGroupId(),folderId);
  for (  DLFolder curFolder : folders) {
    lockFolder(curFolder.getFolderId(),null,false,DLFolderImpl.LOCK_EXPIRATION_TIME);
  }
  long groupId=folder.getGroupId();
  try {
    List<DLFileEntry> fileEntries=dlFileEntryService.getFileEntries(groupId,folderId);
    for (    DLFileEntry fileEntry : fileEntries) {
      dlFileEntryService.lockFileEntry(groupId,folderId,fileEntry.getName(),owner,expirationTime);
      fileNames.add(fileEntry.getName());
    }
  }
 catch (  Exception e) {
    for (    String fileName : fileNames) {
      dlFileEntryService.unlockFileEntry(groupId,folderId,fileName);
    }
    unlockFolder(groupId,folderId,lock.getUuid());
    if (e instanceof DuplicateLockException) {
      throw (DuplicateLockException)e;
    }
 else     if (e instanceof PortalException) {
      throw (PortalException)e;
    }
 else     if (e instanceof RemoteException) {
      throw (RemoteException)e;
    }
 else     if (e instanceof SystemException) {
      throw (SystemException)e;
    }
 else {
      throw new PortalException(e);
    }
  }
  return lock;
}
