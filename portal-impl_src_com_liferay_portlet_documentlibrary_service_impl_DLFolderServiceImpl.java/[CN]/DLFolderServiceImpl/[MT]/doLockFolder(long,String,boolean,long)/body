{
  DLFolder dlFolder=dlFolderLocalService.getFolder(folderId);
  if ((expirationTime <= 0) || (expirationTime > DLFolderImpl.LOCK_EXPIRATION_TIME)) {
    expirationTime=DLFolderImpl.LOCK_EXPIRATION_TIME;
  }
  Lock lock=lockLocalService.lock(getUserId(),DLFolder.class.getName(),folderId,owner,inheritable,expirationTime);
  Set<Long> fileFileEntryIds=new HashSet<Long>();
  long groupId=dlFolder.getGroupId();
  try {
    List<DLFileEntry> dlFileEntries=dlFileEntryLocalService.getFileEntries(groupId,folderId,QueryUtil.ALL_POS,QueryUtil.ALL_POS,null);
    for (    DLFileEntry dlFileEntry : dlFileEntries) {
      dlFileEntryService.lockFileEntry(dlFileEntry.getFileEntryId(),owner,expirationTime);
      fileFileEntryIds.add(dlFileEntry.getFileEntryId());
    }
  }
 catch (  Exception e) {
    for (    long fileEntryId : fileFileEntryIds) {
      dlFileEntryService.unlockFileEntry(fileEntryId);
    }
    unlockFolder(groupId,folderId,lock.getUuid());
    if (e instanceof PortalException) {
      throw (PortalException)e;
    }
 else     if (e instanceof SystemException) {
      throw (SystemException)e;
    }
 else {
      throw new PortalException(e);
    }
  }
  return lock;
}
