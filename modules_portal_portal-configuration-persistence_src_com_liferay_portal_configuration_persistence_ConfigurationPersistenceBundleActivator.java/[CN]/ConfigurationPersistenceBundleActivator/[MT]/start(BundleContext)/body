{
  Collection<ServiceReference<DataSource>> serviceReferences=bundleContext.getServiceReferences(DataSource.class,"(bean.id=liferayDataSource)");
  if ((serviceReferences == null) || serviceReferences.isEmpty()) {
    throw new IllegalStateException("LiferayDataSource is needed");
  }
  Iterator<ServiceReference<DataSource>> iterator=serviceReferences.iterator();
  _dataSourceServiceReference=iterator.next();
  _configurationPersistenceManager=new ConfigurationPersistenceManager();
  _configurationPersistenceManager.setDataSource(bundleContext.getService(_dataSourceServiceReference));
  _configurationPersistenceManager.start();
  Dictionary<String,Object> properties=new Hashtable<>();
  properties.put(Constants.SERVICE_RANKING,(Integer.MAX_VALUE - 1000));
  _serviceRegistration=bundleContext.registerService(PersistenceManager.class,_configurationPersistenceManager,properties);
}
