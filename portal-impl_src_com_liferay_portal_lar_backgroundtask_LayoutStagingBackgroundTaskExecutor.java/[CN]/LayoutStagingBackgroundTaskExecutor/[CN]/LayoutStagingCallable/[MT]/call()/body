{
  File file=null;
  MissingReferences missingReferences=null;
  try {
    Map<String,Serializable> settingsMap=_exportImportConfiguration.getSettingsMap();
    boolean privateLayout=MapUtil.getBoolean(settingsMap,"privateLayout");
    initThreadLocals(_sourceGroupId,privateLayout);
    long[] layoutIds=GetterUtil.getLongValues(settingsMap.get("layoutIds"));
    Map<String,String[]> parameterMap=(Map<String,String[]>)settingsMap.get("parameterMap");
    DateRange dateRange=ExportImportDateUtil.getDateRange(_exportImportConfiguration,ExportImportDateUtil.RANGE_FROM_LAST_PUBLISH_DATE);
    file=LayoutLocalServiceUtil.exportLayoutsAsFile(_sourceGroupId,privateLayout,layoutIds,parameterMap,dateRange.getStartDate(),dateRange.getEndDate());
    markBackgroundTask(_backgroundTaskId,"exported");
    missingReferences=LayoutLocalServiceUtil.validateImportLayoutsFile(_userId,_targetGroupId,privateLayout,parameterMap,file);
    markBackgroundTask(_backgroundTaskId,"validated");
    LayoutLocalServiceUtil.importLayouts(_userId,_targetGroupId,privateLayout,parameterMap,file);
    initLayoutSetBranches(_userId,_sourceGroupId,_targetGroupId);
  }
 catch (  Exception e) {
    if (PropsValues.STAGING_DELETE_TEMP_LAR_ON_FAILURE) {
      FileUtil.delete(file);
    }
 else     if ((file != null) && _log.isErrorEnabled()) {
      _log.error("Temporary LAR file is kept at " + file.getAbsolutePath());
    }
    throw e;
  }
  if (PropsValues.STAGING_DELETE_TEMP_LAR_ON_SUCCESS) {
    FileUtil.delete(file);
  }
 else   if ((file != null) && _log.isDebugEnabled()) {
    _log.debug("Temporary LAR file is kept at " + file.getAbsolutePath());
  }
  return missingReferences;
}
