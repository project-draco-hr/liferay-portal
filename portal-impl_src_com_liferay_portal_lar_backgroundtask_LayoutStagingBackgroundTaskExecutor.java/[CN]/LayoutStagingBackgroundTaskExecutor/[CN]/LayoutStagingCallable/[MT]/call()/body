{
  File file=null;
  MissingReferences missingReferences=null;
  try {
    Map<String,Serializable> settingsMap=_exportImportConfiguration.getSettingsMap();
    boolean privateLayout=MapUtil.getBoolean(settingsMap,"privateLayout");
    long[] layoutIds=GetterUtil.getLongValues(settingsMap.get("layoutIds"));
    Map<String,String[]> parameterMap=(Map<String,String[]>)settingsMap.get("parameterMap");
    DateRange dateRange=ExportImportDateUtil.getDateRange(_exportImportConfiguration,ExportImportDateUtil.RANGE_FROM_LAST_PUBLISH_DATE);
    file=LayoutLocalServiceUtil.exportLayoutsAsFile(_sourceGroupId,privateLayout,layoutIds,parameterMap,dateRange.getStartDate(),dateRange.getEndDate());
    markBackgroundTask(_backgroundTaskId,"exported");
    missingReferences=LayoutLocalServiceUtil.validateImportLayoutsFile(_userId,_targetGroupId,privateLayout,parameterMap,file);
    markBackgroundTask(_backgroundTaskId,"validated");
    LayoutLocalServiceUtil.importLayouts(_userId,_targetGroupId,privateLayout,parameterMap,file);
    initLayoutSetBranches(_userId,_sourceGroupId,_targetGroupId);
    boolean updateLastPublishDate=MapUtil.getBoolean(parameterMap,PortletDataHandlerKeys.UPDATE_LAST_PUBLISH_DATE);
    if (updateLastPublishDate) {
      Group sourceGroup=GroupLocalServiceUtil.getGroup(_sourceGroupId);
      if (!sourceGroup.hasStagingGroup()) {
        ExportImportDateUtil.updateLastPublishDate(_sourceGroupId,privateLayout,dateRange,dateRange.getEndDate());
      }
 else {
        ExportImportDateUtil.updateLastPublishDate(_targetGroupId,privateLayout,dateRange,dateRange.getEndDate());
      }
    }
  }
  finally {
    FileUtil.delete(file);
  }
  return missingReferences;
}
