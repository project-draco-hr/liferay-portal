{
  JSONObject additionalInfo=new JSONObject();
  long companyId=CompanyThreadLocal.getCompanyId();
  long realUserId=AuditThreadLocal.getRealUserId();
  long userId=0;
  long modifierId=0;
  String modifierUserName=StringPool.BLANK;
  if (PrincipalThreadLocal.getName() != null) {
    userId=Long.parseLong(PrincipalThreadLocal.getName());
    modifierId=userId;
  }
  if (realUserId > 0 && userId != realUserId) {
    modifierId=realUserId;
    additionalInfo.put("doAsUserId",String.valueOf(userId));
    additionalInfo.put("doAsUserName",PortalUtil.getUserName(userId,StringPool.BLANK));
  }
  modifierUserName=PortalUtil.getUserName(modifierId,StringPool.BLANK);
  additionalInfo.put("userId",user.getUserId());
  additionalInfo.put("emailAddress",user.getEmailAddress());
  additionalInfo.put("screenName",user.getScreenName());
  additionalInfo.put("userName",user.getFullName());
  String type=create ? "user-create" : "user-remove";
  String clientIP=AuditThreadLocal.getClientIP();
  String serverIP=AuditThreadLocal.getServerIP();
  String sessionID=AuditThreadLocal.getSessionID();
  return new AuditMessage(companyId,modifierId,modifierUserName,String.valueOf(user.getUserId()),User.class.getName(),type,sessionID,clientIP,serverIP,additionalInfo);
}
