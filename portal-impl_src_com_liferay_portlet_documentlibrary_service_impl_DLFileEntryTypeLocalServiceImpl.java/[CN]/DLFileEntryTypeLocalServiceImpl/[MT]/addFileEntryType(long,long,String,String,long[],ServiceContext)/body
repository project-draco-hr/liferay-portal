{
  User user=userPersistence.findByPrimaryKey(userId);
  String fileEntryTypeUuid=serviceContext.getUuid();
  if (Validator.isNull(fileEntryTypeUuid)) {
    fileEntryTypeUuid=PortalUUIDUtil.generate();
  }
  long fileEntryTypeId=counterLocalService.increment();
  long ddmStructureId=updateDDMStructure(userId,fileEntryTypeUuid,fileEntryTypeId,groupId,name,description,serviceContext);
  if (ddmStructureId > 0) {
    ddmStructureIds=ArrayUtil.append(ddmStructureIds,ddmStructureId);
  }
  Date now=new Date();
  validate(fileEntryTypeId,groupId,name,ddmStructureIds);
  DLFileEntryType dlFileEntryType=dlFileEntryTypePersistence.create(fileEntryTypeId);
  dlFileEntryType.setUuid(fileEntryTypeUuid);
  dlFileEntryType.setGroupId(groupId);
  dlFileEntryType.setCompanyId(user.getCompanyId());
  dlFileEntryType.setUserId(user.getUserId());
  dlFileEntryType.setUserName(user.getFullName());
  dlFileEntryType.setCreateDate(serviceContext.getCreateDate(now));
  dlFileEntryType.setModifiedDate(serviceContext.getModifiedDate(now));
  dlFileEntryType.setName(name);
  dlFileEntryType.setDescription(description);
  dlFileEntryTypePersistence.update(dlFileEntryType);
  dlFileEntryTypePersistence.addDDMStructures(fileEntryTypeId,ddmStructureIds);
  if (serviceContext.isAddGroupPermissions() || serviceContext.isAddGuestPermissions()) {
    addFileEntryTypeResources(dlFileEntryType,serviceContext.isAddGroupPermissions(),serviceContext.isAddGuestPermissions());
  }
 else {
    addFileEntryTypeResources(dlFileEntryType,serviceContext.getGroupPermissions(),serviceContext.getGuestPermissions());
  }
  return dlFileEntryType;
}
