{
  fixDDMStructureKey(fileEntryTypeUuid,fileEntryTypeId,groupId);
  String ddmStructureKey=DLUtil.getDDMStructureKey(fileEntryTypeUuid);
  String definition=ParamUtil.getString(serviceContext,"definition");
  DDMStructure ddmStructure=ddmStructureLocalService.fetchStructure(groupId,classNameLocalService.getClassNameId(DLFileEntryMetadata.class),ddmStructureKey);
  if ((ddmStructure != null) && Validator.isNull(definition)) {
    definition=ddmStructure.getDefinition();
  }
  try {
    if (ddmStructure == null) {
      DDMForm ddmForm=DDMFormXSDDeserializerUtil.deserialize(definition);
      ddmStructure=ddmStructureLocalService.addStructure(userId,groupId,DDMStructureConstants.DEFAULT_PARENT_STRUCTURE_ID,classNameLocalService.getClassNameId(DLFileEntryMetadata.class),ddmStructureKey,nameMap,descriptionMap,ddmForm,"xml",DDMStructureConstants.TYPE_AUTO,serviceContext);
    }
 else {
      ddmStructure=ddmStructureLocalService.updateStructure(ddmStructure.getStructureId(),ddmStructure.getParentStructureId(),nameMap,descriptionMap,definition,serviceContext);
    }
    return ddmStructure.getStructureId();
  }
 catch (  StructureDefinitionException sde) {
    if (ddmStructure != null) {
      ddmStructureLocalService.deleteStructure(ddmStructure.getStructureId());
    }
  }
  return 0;
}
