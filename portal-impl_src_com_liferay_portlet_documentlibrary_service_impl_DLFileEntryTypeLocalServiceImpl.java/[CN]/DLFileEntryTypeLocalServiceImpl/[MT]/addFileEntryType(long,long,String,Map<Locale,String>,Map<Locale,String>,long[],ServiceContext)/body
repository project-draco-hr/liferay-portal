{
  User user=userPersistence.findByPrimaryKey(userId);
  if (Validator.isNull(fileEntryTypeKey)) {
    fileEntryTypeKey=String.valueOf(counterLocalService.increment());
  }
 else {
    fileEntryTypeKey=StringUtil.toUpperCase(fileEntryTypeKey.trim());
  }
  String fileEntryTypeUuid=serviceContext.getUuid();
  if (Validator.isNull(fileEntryTypeUuid)) {
    fileEntryTypeUuid=PortalUUIDUtil.generate();
  }
  long fileEntryTypeId=counterLocalService.increment();
  long ddmStructureId=updateDDMStructure(userId,fileEntryTypeUuid,fileEntryTypeId,groupId,nameMap,descriptionMap,serviceContext);
  if (ddmStructureId > 0) {
    ddmStructureIds=ArrayUtil.append(ddmStructureIds,ddmStructureId);
  }
  validate(fileEntryTypeId,groupId,fileEntryTypeKey,ddmStructureIds);
  DLFileEntryType dlFileEntryType=dlFileEntryTypePersistence.create(fileEntryTypeId);
  dlFileEntryType.setUuid(fileEntryTypeUuid);
  dlFileEntryType.setGroupId(groupId);
  dlFileEntryType.setCompanyId(user.getCompanyId());
  dlFileEntryType.setUserId(user.getUserId());
  dlFileEntryType.setUserName(user.getFullName());
  dlFileEntryType.setFileEntryTypeKey(fileEntryTypeKey);
  dlFileEntryType.setNameMap(nameMap);
  dlFileEntryType.setDescriptionMap(descriptionMap);
  dlFileEntryTypePersistence.update(dlFileEntryType);
  dlFileEntryTypePersistence.addDDMStructures(fileEntryTypeId,ddmStructureIds);
  if (serviceContext.isAddGroupPermissions() || serviceContext.isAddGuestPermissions()) {
    addFileEntryTypeResources(dlFileEntryType,serviceContext.isAddGroupPermissions(),serviceContext.isAddGuestPermissions());
  }
 else {
    addFileEntryTypeResources(dlFileEntryType,serviceContext.getGroupPermissions(),serviceContext.getGuestPermissions());
  }
  return dlFileEntryType;
}
