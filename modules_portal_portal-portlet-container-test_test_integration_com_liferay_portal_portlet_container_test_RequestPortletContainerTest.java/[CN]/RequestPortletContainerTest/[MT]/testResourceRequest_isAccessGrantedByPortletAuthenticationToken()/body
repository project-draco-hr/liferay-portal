{
  final String portletToTarget="TEST_TARGET";
  _properties.put("com.liferay.portlet.add-default-resource",Boolean.TRUE);
  _properties.put("com.liferay.portlet.system",Boolean.TRUE);
  setUpPortlet(new TestPortlet(_map),_properties,portletToTarget,false);
  _properties=new Hashtable<>();
  Map<String,String> ignored=new HashMap<>();
  _testPortlet=new TestPortlet(ignored){
    @Override public void serveResource(    ResourceRequest resourceRequest,    ResourceResponse resourceResponse) throws IOException {
      PortletURL portletURL=PortletURLFactoryUtil.create(resourceRequest,portletToTarget,layout.getPlid(),PortletRequest.RENDER_PHASE);
      String queryString=HttpUtil.getQueryString(portletURL.toString());
      Map<String,String[]> parameterMap=HttpUtil.getParameterMap(queryString);
      String p_p_auth=MapUtil.getString(parameterMap,"p_p_auth");
      PrintWriter writer=resourceResponse.getWriter();
      writer.write(p_p_auth);
    }
  }
;
  setUpPortlet(_testPortlet,_properties,_TEST_PORTLET_ID);
  HttpServletRequest request=getHttpServletRequest();
  PortletURL portletURL=new PortletURLImpl(request,_TEST_PORTLET_ID,layout.getPlid(),PortletRequest.RESOURCE_PHASE);
  Map<String,List<String>> responseMap=request(portletURL.toString());
  String p_p_auth=getString(responseMap,"body");
  List<String> cookies=responseMap.get("Set-Cookie");
  _map.clear();
  portletURL=new PortletURLImpl(request,portletToTarget,layout.getPlid(),PortletRequest.RESOURCE_PHASE);
  portletURL.setWindowState(WindowState.MAXIMIZED);
  String url=portletURL.toString();
  url=HttpUtil.setParameter(url,"p_p_auth",p_p_auth);
  Map<String,List<String>> headers=new HashMap<>();
  headers.put("Cookie",cookies);
  responseMap=request(url,headers);
  Assert.assertEquals("200",getString(responseMap,"code"));
  Assert.assertTrue(_map.containsKey("serveResource"));
}
