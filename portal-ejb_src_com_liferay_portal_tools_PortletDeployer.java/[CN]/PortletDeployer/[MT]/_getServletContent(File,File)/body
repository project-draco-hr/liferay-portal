{
  StringBuffer sb=new StringBuffer();
  SAXReader reader=SAXReaderFactory.getInstance();
  Document doc=reader.read(portletXML);
  Element root=doc.getRootElement();
  Iterator itr1=root.elements("portlet").iterator();
  while (itr1.hasNext()) {
    Element portlet=(Element)itr1.next();
    String portletName=PortalUtil.getJsSafePortletName(portlet.elementText("portlet-name"));
    String portletClass=portlet.elementText("portlet-class");
    sb.append("<servlet>");
    sb.append("<servlet-name>");
    sb.append(portletName);
    sb.append("</servlet-name>");
    sb.append("<servlet-class>");
    sb.append("com.liferay.portal.kernel.servlet.PortletServlet");
    sb.append("</servlet-class>");
    sb.append("<init-param>");
    sb.append("<param-name>portlet-class</param-name>");
    sb.append("<param-value>");
    sb.append(portletClass);
    sb.append("</param-value>");
    sb.append("</init-param>");
    sb.append("<load-on-startup>0</load-on-startup>");
    sb.append("</servlet>");
    sb.append("<servlet-mapping>");
    sb.append("<servlet-name>");
    sb.append(portletName);
    sb.append("</servlet-name>");
    sb.append("<url-pattern>/");
    sb.append(portletName);
    sb.append("/*</url-pattern>");
    sb.append("</servlet-mapping>");
  }
  reader=SAXReaderFactory.getInstance(false);
  doc=reader.read(webXML);
  root=doc.getRootElement();
  boolean hasCompanyId=false;
  itr1=root.elements("context-param").iterator();
  while (itr1.hasNext()) {
    Element contextParam=(Element)itr1.next();
    String paramName=contextParam.elementText("param-name");
    if ((paramName != null) && (paramName.equals("company_id"))) {
      hasCompanyId=true;
      break;
    }
  }
  if (!hasCompanyId) {
    sb.append("<context-param>");
    sb.append("<param-name>company_id</param-name>");
    sb.append("<param-value>liferay.com</param-value>");
    sb.append("</context-param>");
  }
  itr1=root.elements("servlet").iterator();
  while (itr1.hasNext()) {
    Element servlet=(Element)itr1.next();
    String icon=servlet.elementText("icon");
    String servletName=servlet.elementText("servlet-name");
    String displayName=servlet.elementText("display-name");
    String description=servlet.elementText("description");
    String servletClass=servlet.elementText("servlet-class");
    List initParams=servlet.elements("init-param");
    String loadOnStartup=servlet.elementText("load-on-startup");
    String runAs=servlet.elementText("run-as");
    List securityRoleRefs=servlet.elements("security-role-ref");
    if ((servletClass != null) && (servletClass.equals("com.liferay.portal.servlet.SharedServletWrapper"))) {
      sb.append("<servlet>");
      if (icon != null) {
        sb.append("<icon>");
        sb.append(icon);
        sb.append("</icon>");
      }
      if (servletName != null) {
        sb.append("<servlet-name>");
        sb.append(servletName);
        sb.append("</servlet-name>");
      }
      if (displayName != null) {
        sb.append("<display-name>");
        sb.append(displayName);
        sb.append("</display-name>");
      }
      if (description != null) {
        sb.append("<description>");
        sb.append(description);
        sb.append("</description>");
      }
      Iterator itr2=initParams.iterator();
      while (itr2.hasNext()) {
        Element initParam=(Element)itr2.next();
        String paramName=initParam.elementText("param-name");
        String paramValue=initParam.elementText("param-value");
        if ((paramName != null) && (paramName.equals("servlet-class"))) {
          sb.append("<servlet-class>");
          sb.append(paramValue);
          sb.append("</servlet-class>");
        }
      }
      itr2=initParams.iterator();
      while (itr2.hasNext()) {
        Element initParam=(Element)itr2.next();
        String paramName=initParam.elementText("param-name");
        String paramValue=initParam.elementText("param-value");
        String paramDesc=initParam.elementText("description");
        if ((paramName != null) && (!paramName.equals("servlet-class"))) {
          sb.append("<init-param>");
          sb.append("<param-name>");
          sb.append(paramName);
          sb.append("</param-name>");
          if (paramValue != null) {
            sb.append("<param-value>");
            sb.append(paramValue);
            sb.append("</param-value>");
          }
          if (paramDesc != null) {
            sb.append("<description>");
            sb.append(paramDesc);
            sb.append("</description>");
          }
          sb.append("</init-param>");
        }
      }
      if (loadOnStartup != null) {
        sb.append("<load-on-startup>");
        sb.append(loadOnStartup);
        sb.append("</load-on-startup>");
      }
      if (runAs != null) {
        sb.append("<run-as>");
        sb.append(runAs);
        sb.append("</run-as>");
      }
      itr2=securityRoleRefs.iterator();
      while (itr2.hasNext()) {
        Element roleRef=(Element)itr2.next();
        String roleDesc=roleRef.elementText("description");
        String roleName=roleRef.elementText("role-name");
        String roleLink=roleRef.elementText("role-link");
        sb.append("<security-role-ref>");
        if (roleDesc != null) {
          sb.append("<description>");
          sb.append(roleDesc);
          sb.append("</description>");
        }
        if (roleName != null) {
          sb.append("<role-name>");
          sb.append(roleName);
          sb.append("</role-name>");
        }
        if (roleLink != null) {
          sb.append("<role-link>");
          sb.append(roleLink);
          sb.append("</role-link>");
        }
        sb.append("</security-role-ref>");
      }
      sb.append("</servlet>");
    }
  }
  return sb.toString();
}
