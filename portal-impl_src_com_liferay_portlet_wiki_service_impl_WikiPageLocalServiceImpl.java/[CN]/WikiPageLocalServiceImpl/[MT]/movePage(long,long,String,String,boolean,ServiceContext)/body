{
  validateTitle(newTitle);
  if (isUsedTitle(nodeId,newTitle)) {
    WikiPage page=getPage(nodeId,newTitle);
    if (((page.getVersion() == WikiPageImpl.DEFAULT_VERSION) && (page.getContent().length() < 200)) || !strict) {
      deletePage(nodeId,newTitle);
    }
 else {
      throw new DuplicatePageException(newTitle);
    }
  }
  List<WikiPage> pageVersions=wikiPagePersistence.findByN_T(nodeId,title);
  if (pageVersions.size() == 0) {
    return;
  }
  for (  WikiPage page : pageVersions) {
    page.setTitle(newTitle);
    wikiPagePersistence.update(page,false);
  }
  List<WikiPage> children=wikiPagePersistence.findByN_P(nodeId,title);
  for (  WikiPage page : children) {
    page.setParentTitle(newTitle);
    wikiPagePersistence.update(page,false);
  }
  WikiPage page=pageVersions.get(pageVersions.size() - 1);
  long resourcePrimKey=page.getResourcePrimKey();
  WikiPageResource wikiPageResource=wikiPageResourcePersistence.findByPrimaryKey(resourcePrimKey);
  wikiPageResource.setTitle(newTitle);
  wikiPageResourcePersistence.update(wikiPageResource,false);
  String uuid=null;
  double version=WikiPageImpl.DEFAULT_VERSION;
  String summary=WikiPageImpl.MOVED + " to " + title;
  String format=page.getFormat();
  boolean head=true;
  String parentTitle=page.getParentTitle();
  String redirectTitle=page.getTitle();
  String content=StringPool.DOUBLE_OPEN_BRACKET + redirectTitle + StringPool.DOUBLE_CLOSE_BRACKET;
  addPage(uuid,userId,nodeId,title,version,content,summary,false,format,head,parentTitle,redirectTitle,serviceContext);
  List<WikiPage> redirectedPages=wikiPagePersistence.findByN_R(nodeId,title);
  for (  WikiPage redirectedPage : redirectedPages) {
    redirectedPage.setRedirectTitle(newTitle);
    wikiPagePersistence.update(redirectedPage,false);
  }
  String[] tagsCategories=tagsEntryLocalService.getEntryNames(WikiPage.class.getName(),resourcePrimKey,TagsEntryConstants.FOLKSONOMY_CATEGORY);
  String[] tagsEntries=tagsEntryLocalService.getEntryNames(WikiPage.class.getName(),resourcePrimKey,TagsEntryConstants.FOLKSONOMY_TAG);
  updateTagsAsset(userId,page,tagsCategories,tagsEntries);
  try {
    Indexer.updatePage(page.getCompanyId(),page.getNode().getGroupId(),resourcePrimKey,nodeId,newTitle,page.getContent(),tagsEntries,page.getExpandoBridge());
    Indexer.deletePage(page.getCompanyId(),page.getNode().getGroupId(),title);
  }
 catch (  SearchException se) {
    _log.error("Indexing " + newTitle,se);
  }
}
