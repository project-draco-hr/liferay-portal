{
  PortletPreferences preferences=null;
  String rootPortletId=serviceContext.getRootPortletId();
  if (Validator.isNull(rootPortletId) || !rootPortletId.equals(PortletKeys.WIKI_DISPLAY)) {
    preferences=ServiceContextUtil.getPortletPreferences(serviceContext);
  }
  if (preferences == null) {
    preferences=portletPreferencesLocalService.getPreferences(node.getCompanyId(),node.getGroupId(),PortletKeys.PREFS_OWNER_TYPE_GROUP,PortletKeys.PREFS_PLID_SHARED,PortletKeys.WIKI_ADMIN,null);
  }
  if (!update && WikiUtil.getEmailPageAddedEnabled(preferences)) {
  }
 else   if (update && WikiUtil.getEmailPageUpdatedEnabled(preferences)) {
  }
 else {
    return;
  }
  String portalURL=serviceContext.getPortalURL();
  String layoutFullURL=serviceContext.getLayoutFullURL();
  WikiPage previousVersionPage=getPreviousVersionPage(page);
  String attachmentURLPrefix=WikiUtil.getAttachmentURLPrefix(serviceContext.getPathMain(),serviceContext.getPlid(),page.getNodeId(),page.getTitle());
  attachmentURLPrefix=portalURL + attachmentURLPrefix;
  String pageDiffs=StringPool.BLANK;
  try {
    pageDiffs=WikiUtil.diffHtml(previousVersionPage,page,null,null,attachmentURLPrefix);
  }
 catch (  Exception e) {
  }
  String pageContent=null;
  if (Validator.equals(page.getFormat(),"creole")) {
    pageContent=WikiUtil.convert(page,null,null,attachmentURLPrefix);
  }
 else {
    pageContent=page.getContent();
    pageContent=WikiUtil.processContent(pageContent);
  }
  String pageURL=StringPool.BLANK;
  String diffsURL=StringPool.BLANK;
  HttpServletRequest request=serviceContext.getRequest();
  if (Validator.isNotNull(layoutFullURL) && (request != null)) {
    long controlPanelPlid=PortalUtil.getControlPanelPlid(serviceContext.getCompanyId());
    layoutFullURL=getPortletLayoutURL(node.getGroupId(),PortletKeys.WIKI,serviceContext);
    if (Validator.isNotNull(layoutFullURL)) {
      pageURL=layoutFullURL + Portal.FRIENDLY_URL_SEPARATOR + "wiki/"+ node.getNodeId()+ StringPool.SLASH+ HttpUtil.encodeURL(page.getTitle());
    }
 else {
      PortletURL portletURL=PortletURLFactoryUtil.create(request,PortletKeys.WIKI_ADMIN,controlPanelPlid,PortletRequest.RENDER_PHASE);
      portletURL.setParameter("struts_action","/wiki_admin/view_page_activities");
      portletURL.setParameter("nodeId",String.valueOf(node.getNodeId()));
      portletURL.setParameter("title",page.getTitle());
      pageURL=portletURL.toString();
    }
    if (previousVersionPage != null) {
      long wikiPlid=serviceContext.getPlid();
      String portletId=null;
      long plid=LayoutConstants.DEFAULT_PLID;
      String strutsAction=null;
      if (wikiPlid != LayoutConstants.DEFAULT_PLID) {
        portletId=PortletKeys.WIKI;
        plid=wikiPlid;
        strutsAction="/wiki/compare_versions";
      }
 else {
        portletId=PortletKeys.WIKI_ADMIN;
        plid=controlPanelPlid;
        strutsAction="/wiki_admin/compare_versions";
      }
      PortletURL portletURL=PortletURLFactoryUtil.create(request,portletId,plid,PortletRequest.RENDER_PHASE);
      portletURL.setParameter("struts_action",strutsAction);
      portletURL.setParameter("nodeId",String.valueOf(node.getNodeId()));
      portletURL.setParameter("title",page.getTitle());
      portletURL.setParameter("sourceVersion",String.valueOf(previousVersionPage.getVersion()));
      portletURL.setParameter("targetVersion",String.valueOf(page.getVersion()));
      portletURL.setParameter("type","html");
      diffsURL=portletURL.toString();
    }
  }
  String fromName=WikiUtil.getEmailFromName(preferences,page.getCompanyId());
  String fromAddress=WikiUtil.getEmailFromAddress(preferences,page.getCompanyId());
  String subject=null;
  String body=null;
  String signature=null;
  if (update) {
    subject=WikiUtil.getEmailPageUpdatedSubject(preferences);
    body=WikiUtil.getEmailPageUpdatedBody(preferences);
    signature=WikiUtil.getEmailPageUpdatedSignature(preferences);
  }
 else {
    subject=WikiUtil.getEmailPageAddedSubject(preferences);
    body=WikiUtil.getEmailPageAddedBody(preferences);
    signature=WikiUtil.getEmailPageAddedSignature(preferences);
  }
  if (Validator.isNotNull(signature)) {
    body+="\n" + signature;
  }
  SubscriptionSender subscriptionSender=new SubscriptionSender();
  subscriptionSender.setBody(body);
  subscriptionSender.setCompanyId(page.getCompanyId());
  subscriptionSender.setContextAttributes("[$DIFFS_URL$]",diffsURL,"[$NODE_NAME$]",node.getName(),"[$PAGE_DATE_UPDATE$]",page.getModifiedDate(),"[$PAGE_ID$]",page.getPageId(),"[$PAGE_SUMMARY$]",page.getSummary(),"[$PAGE_TITLE$]",page.getTitle(),"[$PAGE_URL$]",pageURL);
  subscriptionSender.setContextAttribute("[$PAGE_CONTENT$]",pageContent,false);
  subscriptionSender.setContextAttribute("[$PAGE_DIFFS$]",replaceStyles(pageDiffs),false);
  subscriptionSender.setContextUserPrefix("PAGE");
  subscriptionSender.setFrom(fromAddress,fromName);
  subscriptionSender.setHtmlFormat(true);
  subscriptionSender.setMailId("wiki_page",page.getNodeId(),page.getPageId());
  subscriptionSender.setPortletId(PortletKeys.WIKI);
  subscriptionSender.setReplyToAddress(fromAddress);
  subscriptionSender.setScopeGroupId(node.getGroupId());
  subscriptionSender.setServiceContext(serviceContext);
  subscriptionSender.setSubject(subject);
  subscriptionSender.setUserId(page.getUserId());
  subscriptionSender.addPersistedSubscribers(WikiNode.class.getName(),node.getNodeId());
  subscriptionSender.addPersistedSubscribers(WikiPage.class.getName(),page.getResourcePrimKey());
  subscriptionSender.flushNotificationsAsync();
}
