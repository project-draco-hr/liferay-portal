{
  if (prefs == null) {
    long ownerId=node.getGroupId();
    int ownerType=PortletKeys.PREFS_OWNER_TYPE_GROUP;
    long plid=PortletKeys.PREFS_PLID_SHARED;
    String portletId=PortletKeys.WIKI;
    String defaultPreferences=null;
    prefs=portletPreferencesLocalService.getPreferences(node.getCompanyId(),ownerId,ownerType,plid,portletId,defaultPreferences);
  }
  if (!update && WikiUtil.getEmailPageAddedEnabled(prefs)) {
  }
 else   if (update && WikiUtil.getEmailPageUpdatedEnabled(prefs)) {
  }
 else {
    return;
  }
  Company company=companyPersistence.findByPrimaryKey(page.getCompanyId());
  Group group=groupPersistence.findByPrimaryKey(node.getGroupId());
  User user=userPersistence.findByPrimaryKey(page.getUserId());
  String pageURL=StringPool.BLANK;
  if (themeDisplay != null) {
    String portalURL=PortalUtil.getPortalURL(themeDisplay);
    String layoutURL=PortalUtil.getLayoutURL(themeDisplay);
    pageURL=portalURL + layoutURL + "/wiki/"+ node.getNodeId()+ "/"+ page.getTitle();
  }
  String portletName=PortalUtil.getPortletTitle(PortletKeys.WIKI,user);
  String fromName=WikiUtil.getEmailFromName(prefs);
  String fromAddress=WikiUtil.getEmailFromAddress(prefs);
  String replyToAddress=fromAddress;
  String mailId=WikiUtil.getMailId(company.getMx(),page.getNodeId(),page.getPageId());
  fromName=StringUtil.replace(fromName,new String[]{"[$COMPANY_ID$]","[$COMPANY_MX$]","[$COMPANY_NAME$]","[$COMMUNITY_NAME$]","[$PAGE_USER_ADDRESS$]","[$PAGE_USER_NAME$]","[$PORTLET_NAME$]"},new String[]{String.valueOf(company.getCompanyId()),company.getMx(),company.getName(),group.getName(),user.getEmailAddress(),user.getFullName(),portletName});
  fromAddress=StringUtil.replace(fromAddress,new String[]{"[$COMPANY_ID$]","[$COMPANY_MX$]","[$COMPANY_NAME$]","[$COMMUNITY_NAME$]","[$PAGE_USER_ADDRESS$]","[$PAGE_USER_NAME$]","[$PORTLET_NAME$]"},new String[]{String.valueOf(company.getCompanyId()),company.getMx(),company.getName(),group.getName(),user.getEmailAddress(),user.getFullName(),portletName});
  String subjectPrefix=null;
  String body=null;
  String signature=null;
  if (update) {
    subjectPrefix=WikiUtil.getEmailPageUpdatedSubjectPrefix(prefs);
    body=WikiUtil.getEmailPageUpdatedBody(prefs);
    signature=WikiUtil.getEmailPageUpdatedSignature(prefs);
  }
 else {
    subjectPrefix=WikiUtil.getEmailPageAddedSubjectPrefix(prefs);
    body=WikiUtil.getEmailPageAddedBody(prefs);
    signature=WikiUtil.getEmailPageAddedSignature(prefs);
  }
  if (Validator.isNotNull(signature)) {
    body+="\n--\n" + signature;
  }
  subjectPrefix=StringUtil.replace(subjectPrefix,new String[]{"[$COMPANY_ID$]","[$COMPANY_MX$]","[$COMPANY_NAME$]","[$COMMUNITY_NAME$]","[$FROM_ADDRESS$]","[$FROM_NAME$]","[$NODE_NAME$]","[$PAGE_CONTENT$]","[$PAGE_ID$]","[$PAGE_TITLE$]","[$PAGE_USER_ADDRESS$]","[$PAGE_USER_NAME$]","[$PORTAL_URL$]","[$PORTLET_NAME$]"},new String[]{String.valueOf(company.getCompanyId()),company.getMx(),company.getName(),group.getName(),fromAddress,fromName,node.getName(),page.getContent(),String.valueOf(page.getPageId()),page.getTitle(),user.getEmailAddress(),user.getFullName(),company.getVirtualHost(),portletName});
  body=StringUtil.replace(body,new String[]{"[$COMPANY_ID$]","[$COMPANY_MX$]","[$COMPANY_NAME$]","[$COMMUNITY_NAME$]","[$FROM_ADDRESS$]","[$FROM_NAME$]","[$NODE_NAME$]","[$PAGE_CONTENT$]","[$PAGE_ID$]","[$PAGE_TITLE$]","[$PAGE_URL$]","[$PAGE_USER_ADDRESS$]","[$PAGE_USER_NAME$]","[$PORTAL_URL$]","[$PORTLET_NAME$]"},new String[]{String.valueOf(company.getCompanyId()),company.getMx(),company.getName(),group.getName(),fromAddress,fromName,node.getName(),page.getContent(),String.valueOf(page.getPageId()),page.getTitle(),pageURL,user.getEmailAddress(),user.getFullName(),company.getVirtualHost(),portletName});
  String subject=page.getTitle();
  if (subject.indexOf(subjectPrefix) == -1) {
    subject=subjectPrefix + subject;
  }
  Message notifMesg=new Message(MessageTypes.WIKI_NOTIFICATION_MESSAGE);
  notifMesg.setDestination(DestinationNames.WIKI);
  JSONObject jsonObj=JSONFactoryUtil.createJSONObject();
  jsonObj.put("companyId",node.getCompanyId());
  jsonObj.put("userId",node.getUserId());
  jsonObj.put("nodeId",node.getNodeId());
  jsonObj.put("pageResourcePrimKey",page.getResourcePrimKey());
  jsonObj.put("fromName",fromName);
  jsonObj.put("fromAddress",fromAddress);
  jsonObj.put("subject",subject);
  jsonObj.put("body",body);
  jsonObj.put("replyToAddress",replyToAddress);
  jsonObj.put("mailId",mailId);
  notifMesg.setPayload(jsonObj.toString());
  MessageBusUtil.sendMessage(DestinationNames.WIKI,notifMesg);
}
