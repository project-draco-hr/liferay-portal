{
  User user=userPersistence.findByPrimaryKey(userId);
  Date now=new Date();
  validate(title);
  long pageId=counterLocalService.increment();
  long resourcePrimKey=wikiPageResourceLocalService.getPageResourcePrimKey(nodeId,title);
  WikiPage page=wikiPagePersistence.create(pageId);
  page.setResourcePrimKey(resourcePrimKey);
  page.setCompanyId(user.getCompanyId());
  page.setUserId(user.getUserId());
  page.setUserName(user.getFullName());
  page.setCreateDate(now);
  page.setNodeId(nodeId);
  page.setTitle(title);
  page.setVersion(WikiPageImpl.DEFAULT_VERSION);
  page.setFormat(WikiPageImpl.DEFAULT_FORMAT);
  page.setHead(true);
  wikiPagePersistence.update(page);
  addPageResources(page.getNode(),page,true,true);
  return page;
}
