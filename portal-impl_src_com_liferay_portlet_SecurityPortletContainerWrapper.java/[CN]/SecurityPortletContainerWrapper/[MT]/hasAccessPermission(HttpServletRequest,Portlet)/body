{
  PermissionChecker permissionChecker=PermissionThreadLocal.getPermissionChecker();
  ThemeDisplay themeDisplay=(ThemeDisplay)request.getAttribute(WebKeys.THEME_DISPLAY);
  Layout layout=(Layout)request.getAttribute(WebKeys.LAYOUT);
  String p_p_id=ParamUtil.getString(request,"p_p_id");
  String p_p_mode=ParamUtil.getString(request,"p_p_mode",null);
  if (portlet.getPortletId().equals(p_p_id) && p_p_mode != null) {
    PortletMode portletMode=PortletModeFactory.getPortletMode(p_p_mode);
    return PortletPermissionUtil.hasAccessPermission(permissionChecker,themeDisplay.getScopeGroupId(),layout,portlet,portletMode);
  }
 else {
    return PortletPermissionUtil.hasAccessPermission(permissionChecker,themeDisplay.getScopeGroupId(),layout,portlet,PortletMode.VIEW);
  }
}
