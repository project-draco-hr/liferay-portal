{
  if (!PropsValues.PORTLET_EVENT_DISTRIBUTION_LAYOUT_SET || PropsValues.PORTLET_CROSS_LAYOUT_INVOCATION_MODE.equals("render")) {
    return request;
  }
  Layout ownerLayout=null;
  LayoutTypePortlet ownerLayoutTypePortlet=null;
  ThemeDisplay themeDisplay=(ThemeDisplay)request.getAttribute(WebKeys.THEME_DISPLAY);
  Layout requestLayout=(Layout)request.getAttribute(WebKeys.LAYOUT);
  List<LayoutTypePortlet> layoutTypePortlets=PortletContainerUtil.getLayoutTypePortlets(requestLayout);
  for (  LayoutTypePortlet layoutTypePortlet : layoutTypePortlets) {
    if (layoutTypePortlet.hasPortletId(portlet.getPortletId())) {
      ownerLayoutTypePortlet=layoutTypePortlet;
      ownerLayout=layoutTypePortlet.getLayout();
      break;
    }
  }
  if (ownerLayout == null) {
    return request;
  }
  Layout currentLayout=themeDisplay.getLayout();
  if (currentLayout.equals(ownerLayout)) {
    return request;
  }
  ThemeDisplay themeDisplayClone=(ThemeDisplay)themeDisplay.clone();
  themeDisplayClone.setLayout(ownerLayout);
  themeDisplayClone.setLayoutTypePortlet(ownerLayoutTypePortlet);
  TempAttributesServletRequest tempAttributesServletRequest=new TempAttributesServletRequest(request);
  tempAttributesServletRequest.setTempAttribute(WebKeys.LAYOUT,ownerLayout);
  tempAttributesServletRequest.setTempAttribute(WebKeys.THEME_DISPLAY,themeDisplayClone);
  return tempAttributesServletRequest;
}
