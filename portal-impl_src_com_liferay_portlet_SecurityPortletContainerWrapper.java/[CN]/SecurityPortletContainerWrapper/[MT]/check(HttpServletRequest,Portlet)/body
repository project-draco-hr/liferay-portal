{
  if (portlet == null) {
    return;
  }
  if (!isValidPortletId(portlet.getPortletId())) {
    if (_log.isWarnEnabled()) {
      _log.warn("Invalid portlet id " + portlet.getPortletId());
    }
    throw new PrincipalException();
  }
  if (portlet.isSystem() || portlet.isUndeployedPortlet()) {
    return;
  }
  Layout layout=(Layout)request.getAttribute(WebKeys.LAYOUT);
  if (layout.isTypeControlPanel()) {
    isAccessAllowedToControlPanelPortlet(request,portlet);
    return;
  }
  if (isAccessAllowedToLayoutPortlet(request,portlet)) {
    PortalUtil.addPortletDefaultResource(request,portlet);
    if (hasAccessPermission(request,portlet)) {
      return;
    }
  }
  throw new PrincipalException();
}
