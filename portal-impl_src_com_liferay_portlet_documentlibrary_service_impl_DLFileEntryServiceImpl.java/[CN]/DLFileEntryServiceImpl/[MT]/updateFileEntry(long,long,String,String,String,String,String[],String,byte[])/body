{
  User user=getUser();
  DLFileEntryPermission.check(getPermissionChecker(),folderId,name,ActionKeys.UPDATE);
  String lockId=DLUtil.getLockId(folderId,name);
  boolean alreadyHasLock=lockService.hasLock(DLFileEntry.class.getName(),lockId,user.getUserId());
  if (!alreadyHasLock) {
    lockService.lock(DLFileEntry.class.getName(),lockId,user.getUserId(),null,DLFileEntryImpl.LOCK_EXPIRATION_TIME);
  }
  DLFileEntry fileEntry=null;
  try {
    fileEntry=dlFileEntryLocalService.updateFileEntry(getUserId(),folderId,newFolderId,name,sourceFileName,title,description,tagsEntries,extraSettings,bytes);
  }
  finally {
    if (!alreadyHasLock) {
      lockService.unlock(DLFileEntry.class.getName(),lockId);
    }
  }
  return fileEntry;
}
