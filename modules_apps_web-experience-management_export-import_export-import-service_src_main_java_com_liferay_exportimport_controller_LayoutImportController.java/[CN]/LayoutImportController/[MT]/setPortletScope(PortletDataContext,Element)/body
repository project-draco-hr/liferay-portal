{
  String scopeLayoutUuid=GetterUtil.getString(portletElement.attributeValue("scope-layout-uuid"));
  String scopeLayoutType=GetterUtil.getString(portletElement.attributeValue("scope-layout-type"));
  portletDataContext.setScopeLayoutUuid(scopeLayoutUuid);
  portletDataContext.setScopeType(scopeLayoutType);
  try {
    Group scopeGroup=null;
    if (scopeLayoutType.equals("company")) {
      scopeGroup=_groupLocalService.getCompanyGroup(portletDataContext.getCompanyId());
    }
 else     if (Validator.isNotNull(scopeLayoutUuid)) {
      Layout scopeLayout=_layoutLocalService.getLayoutByUuidAndGroupId(scopeLayoutUuid,portletDataContext.getGroupId(),portletDataContext.isPrivateLayout());
      scopeGroup=_groupLocalService.checkScopeGroup(scopeLayout,portletDataContext.getUserId(null));
      Group group=scopeLayout.getGroup();
      if (group.isStaged() && !group.isStagedRemotely()) {
        try {
          boolean privateLayout=GetterUtil.getBoolean(portletElement.attributeValue("private-layout"));
          Layout oldLayout=_layoutLocalService.getLayoutByUuidAndGroupId(scopeLayoutUuid,portletDataContext.getSourceGroupId(),privateLayout);
          Group oldScopeGroup=oldLayout.getScopeGroup();
          if (group.isStagingGroup()) {
            scopeGroup.setLiveGroupId(oldScopeGroup.getGroupId());
            _groupLocalService.updateGroup(scopeGroup);
          }
 else {
            oldScopeGroup.setLiveGroupId(scopeGroup.getGroupId());
            _groupLocalService.updateGroup(oldScopeGroup);
          }
        }
 catch (        NoSuchLayoutException nsle) {
          if (_log.isWarnEnabled()) {
            _log.warn(nsle);
          }
        }
      }
    }
    if (scopeGroup != null) {
      portletDataContext.setScopeGroupId(scopeGroup.getGroupId());
      Map<Long,Long> groupIds=(Map<Long,Long>)portletDataContext.getNewPrimaryKeysMap(Group.class);
      long oldScopeGroupId=GetterUtil.getLong(portletElement.attributeValue("scope-group-id"));
      groupIds.put(oldScopeGroupId,scopeGroup.getGroupId());
    }
  }
 catch (  PortalException pe) {
  }
catch (  Exception e) {
    _log.error(e,e);
  }
}
