{
  LiferayServletRequest liferayServletRequest=PortletContainerTestUtil.getMultipartRequest(TestUploadPortlet.PARAMETER_NAME,bytes);
  setUp(liferayServletRequest,layout);
  ServletRequest servletRequest=liferayServletRequest.getRequest();
  MockMultipartHttpServletRequest mockServletRequest=(MockMultipartHttpServletRequest)servletRequest;
  Response response=PortletContainerTestUtil.getPortalAuthentication(mockServletRequest,layout,TestUploadPortlet.PORTLET_NAME);
  PortletURL portletURL=PortletURLFactoryUtil.create(mockServletRequest,TestUploadPortlet.PORTLET_NAME,layout.getPlid(),PortletRequest.ACTION_PHASE);
  portletURL.setParameter(ActionRequest.ACTION_NAME,TestUploadPortlet.MVC_COMMAND_NAME);
  portletURL.setParameter("randomId",RandomTestUtil.randomString());
  String url=portletURL.toString();
  url=HttpUtil.setParameter(url,"p_auth",response.getBody());
  List<String> cookies=response.getCookies();
  mockServletRequest.addParameter("Cookie",cookies.toArray(new String[cookies.size()]));
  return PortletContainerTestUtil.postMultipart(url,mockServletRequest,TestUploadPortlet.PARAMETER_NAME);
}
