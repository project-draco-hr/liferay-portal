{
  LiferayServletRequest liferayServletRequest=PortletContainerTestUtil.getMultipartRequest(TestUploadPortlet.TEST_UPLOAD_FILE_NAME_PARAMETER,bytes);
  _addGroupAndLayoutToServletRequest(liferayServletRequest,layout);
  ServletRequest servletRequest=liferayServletRequest.getRequest();
  MockMultipartHttpServletRequest mockServletRequest=(MockMultipartHttpServletRequest)servletRequest;
  Response response=PortletContainerTestUtil.getPortalAuthentication(mockServletRequest,layout,TestUploadPortlet.TEST_UPLOAD_PORTLET);
  PortletURL portletURL=PortletURLFactoryUtil.create(mockServletRequest,TestUploadPortlet.TEST_UPLOAD_PORTLET,layout.getPlid(),PortletRequest.ACTION_PHASE);
  portletURL.setParameter(ActionRequest.ACTION_NAME,TestUploadPortlet.TEST_MVC_COMMAND_NAME);
  portletURL.setParameter("randomId",RandomTestUtil.randomString());
  String url=portletURL.toString();
  url=HttpUtil.setParameter(url,"p_auth",response.getBody());
  List<String> cookies=response.getCookies();
  mockServletRequest.addParameter("Cookie",cookies.toArray(new String[cookies.size()]));
  return PortletContainerTestUtil.postMultipart(url,mockServletRequest,TestUploadPortlet.TEST_UPLOAD_FILE_NAME_PARAMETER);
}
