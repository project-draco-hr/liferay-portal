{
  StopWatch stopWatch=new StopWatch();
  if (_log.isDebugEnabled()) {
    stopWatch.start();
    _log.debug("Adding LDAP user " + ldapUser + " to company "+ companyId);
  }
  boolean autoPassword=ldapUser.isAutoPassword();
  LDAPImportConfiguration ldapImportConfiguration=_ldapImportConfigurationProvider.getConfiguration(companyId);
  if (!ldapImportConfiguration.importUserPasswordEnabled()) {
    autoPassword=ldapImportConfiguration.importUserPasswordAutogenerated();
    if (!autoPassword) {
      String defaultPassword=ldapImportConfiguration.importUserPasswordDefault();
      if (StringUtil.equalsIgnoreCase(defaultPassword,_USER_PASSWORD_SCREEN_NAME)) {
        defaultPassword=ldapUser.getScreenName();
      }
      password=defaultPassword;
    }
  }
  Calendar birthdayCal=CalendarFactoryUtil.getCalendar();
  birthdayCal.setTime(ldapUser.getBirthday());
  int birthdayMonth=birthdayCal.get(Calendar.MONTH);
  int birthdayDay=birthdayCal.get(Calendar.DAY_OF_MONTH);
  int birthdayYear=birthdayCal.get(Calendar.YEAR);
  User user=_userLocalService.addUser(ldapUser.getCreatorUserId(),companyId,autoPassword,password,password,ldapUser.isAutoScreenName(),ldapUser.getScreenName(),ldapUser.getEmailAddress(),0,StringPool.BLANK,ldapUser.getLocale(),ldapUser.getFirstName(),ldapUser.getMiddleName(),ldapUser.getLastName(),0,0,ldapUser.isMale(),birthdayMonth,birthdayDay,birthdayYear,StringPool.BLANK,ldapUser.getGroupIds(),ldapUser.getOrganizationIds(),ldapUser.getRoleIds(),ldapUser.getUserGroupIds(),ldapUser.isSendEmail(),ldapUser.getServiceContext());
  if (ldapUser.isUpdatePortrait()) {
    byte[] portraitBytes=ldapUser.getPortraitBytes();
    if (ArrayUtil.isNotEmpty(portraitBytes)) {
      user=_userLocalService.updatePortrait(user.getUserId(),portraitBytes);
    }
  }
  if (_log.isDebugEnabled()) {
    _log.debug("Finished adding LDAP user " + ldapUser + " as user "+ user+ " in "+ stopWatch.getTime()+ "ms");
  }
  return user;
}
