{
  if (size < _MINIMUM_INCREMENT_SIZE) {
    size=_MINIMUM_INCREMENT_SIZE;
  }
  CounterRegister register=getCounterRegister(name);
synchronized (register) {
    long newValue=register.getCurrentValue() + size;
    if (newValue > register.getRangeMax()) {
      Session session=null;
      try {
        session=new SessionImpl(_sessionFactory.openSession(_connection));
        Counter counter=(Counter)session.get(Counter.class,register.getName());
        newValue=counter.getCurrentId() + 1;
        long rangeMax=counter.getCurrentId() + register.getRangeSize();
        counter.setCurrentId(rangeMax);
        session.save(counter);
        session.flush();
        register.setCurrentValue(newValue);
        register.setRangeMax(rangeMax);
      }
 catch (      Exception e) {
        throw processException(e);
      }
 finally {
        session.close();
      }
    }
 else {
      register.setCurrentValue(newValue);
    }
    return newValue;
  }
}
