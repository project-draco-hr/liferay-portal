{
  MBMessage message=MBMessageServiceUtil.getMessage(messageId);
  FileEntry fileEntry=PortletFileRepositoryUtil.getPortletFileEntry(message.getGroupId(),message.getAttachmentsFolderId(),fileName);
  DLFileEntry dlFileEntry=(DLFileEntry)fileEntry.getModel();
  DLFileVersion dlFileVersion=dlFileEntry.getFileVersion();
  if ((status != WorkflowConstants.STATUS_IN_TRASH) && (dlFileVersion.isInTrash() || dlFileEntry.isInTrashFolder())) {
    return;
  }
  if (dlFileVersion.isInTrash()) {
    fileName=TrashUtil.stripTrashNamespace(dlFileEntry.getTitle());
  }
  ServletResponseUtil.sendFile(request,response,fileName,fileEntry.getContentStream(),fileEntry.getSize(),fileEntry.getMimeType());
}
