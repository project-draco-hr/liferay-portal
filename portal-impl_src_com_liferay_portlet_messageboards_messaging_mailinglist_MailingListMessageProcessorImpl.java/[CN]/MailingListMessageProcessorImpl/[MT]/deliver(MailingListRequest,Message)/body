{
  String from=_getFromAddress(mailMessage);
  Company company=_companyLocalService.getCompany(mailingListRequest.getCompanyId());
  long categoryId=mailingListRequest.getCategoryId();
  if (_log.isDebugEnabled()) {
    _log.debug("Category id " + categoryId);
  }
  MBMessage parentMessage=_getParentMessage(mailMessage);
  if (_log.isDebugEnabled()) {
    _log.debug("Parent message " + parentMessage);
  }
  boolean anonymous=_validateUser(company,mailingListRequest,from);
  MBMailMessage collector=new MBMailMessage();
  MBUtil.collectPartContent(mailMessage,collector);
  MailingListThreadLocal.setSourceMailingList(true);
  String subject=MBUtil.getSubjectWithoutMessageId(mailMessage);
  ServiceContext serviceContext=new ServiceContext();
  serviceContext.setAddCommunityPermissions(true);
  serviceContext.setAddGuestPermissions(true);
  if (parentMessage == null) {
    _mbMessageService.addMessage(categoryId,subject,collector.getBody(),collector.getFiles(),anonymous,0.0,serviceContext);
  }
 else {
    _mbMessageService.addMessage(categoryId,parentMessage.getThreadId(),parentMessage.getMessageId(),subject,collector.getBody(),collector.getFiles(),anonymous,0.0,serviceContext);
  }
}
