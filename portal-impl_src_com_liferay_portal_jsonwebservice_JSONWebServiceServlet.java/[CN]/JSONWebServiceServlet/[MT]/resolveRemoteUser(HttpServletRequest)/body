{
  UserCompanyResolver userCompanyResolver=new UserCompanyResolver(request);
  User user=userCompanyResolver.getUser();
  long companyId=userCompanyResolver.getCompanyId();
  if (user != null) {
    PermissionChecker permissionChecker=PermissionCheckerFactoryUtil.create(user,true);
    PermissionThreadLocal.setPermissionChecker(permissionChecker);
    request.setAttribute("userId",user.getUserId());
    request.setAttribute("user",user);
  }
  CompanyThreadLocal.setCompanyId(companyId);
  request.setAttribute("companyId",companyId);
}
