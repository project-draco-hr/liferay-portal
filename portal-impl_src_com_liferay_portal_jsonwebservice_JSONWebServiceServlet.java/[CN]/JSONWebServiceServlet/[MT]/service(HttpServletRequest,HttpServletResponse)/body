{
  String path=GetterUtil.getString(request.getPathInfo());
  if (!PropsValues.JSONWS_WEB_SERVICE_API_DISCOVERABLE || (!path.equals(StringPool.BLANK) && !path.equals(StringPool.SLASH)) || (request.getParameter("discover") != null)) {
    Locale locale=PortalUtil.getLocale(request,response,true);
    LocaleThreadLocal.setThemeDisplayLocale(locale);
    super.service(request,response);
    return;
  }
  if (_log.isDebugEnabled()) {
    _log.debug("Servlet context " + request.getContextPath());
  }
  String apiPath=PortalUtil.getPathMain() + "/portal/api/jsonws";
  HttpSession session=request.getSession();
  ServletContext servletContext=session.getServletContext();
  boolean remoteAccess=AccessControlThreadLocal.isRemoteAccess();
  try {
    AccessControlThreadLocal.setRemoteAccess(true);
    String contextPath=PortalContextLoaderListener.getPortalServletContextPath();
    if (contextPath.isEmpty()) {
      contextPath=StringPool.SLASH;
    }
    String proxyPath=PortalUtil.getPathProxy();
    if (servletContext.getContext(contextPath) != null) {
      if (Validator.isNotNull(proxyPath) && apiPath.startsWith(proxyPath)) {
        apiPath=apiPath.substring(proxyPath.length());
      }
      if (!contextPath.equals(StringPool.SLASH) && apiPath.startsWith(contextPath)) {
        apiPath=apiPath.substring(contextPath.length());
      }
      RequestDispatcher requestDispatcher=request.getRequestDispatcher(apiPath);
      requestDispatcher.forward(request,response);
    }
 else {
      String servletContextPath=servletContext.getContextPath();
      String redirectPath=PortalUtil.getPathContext() + "/api/jsonws?contextPath=" + HttpUtil.encodeURL(servletContextPath);
      response.sendRedirect(redirectPath);
    }
  }
  finally {
    AccessControlThreadLocal.setRemoteAccess(remoteAccess);
  }
}
