{
  if (PortalUtil.isMultipartRequest(request)) {
    UploadServletRequest uploadServletRequest=new UploadServletRequestImpl(request);
    request=uploadServletRequest;
  }
  String path=GetterUtil.getString(request.getPathInfo());
  if (!path.equals(StringPool.SLASH) && !path.equals(StringPool.BLANK)) {
    super.service(request,response);
    return;
  }
  String uri=request.getRequestURI();
  int pos=uri.indexOf("/secure/");
  if (pos != -1) {
    uri=uri.substring(0,pos) + uri.substring(pos + 7);
    String queryString=request.getQueryString();
    if (queryString != null) {
      uri=uri.concat(StringPool.QUESTION).concat(queryString);
    }
    response.sendRedirect(uri);
    return;
  }
  String mainPath=PortalUtil.getPathMain();
  String apiPath=mainPath + "/portal/api/jsonws";
  ServletContext servletContext=request.getSession().getServletContext();
  String portalContextPath=PropsUtil.get(PropsKeys.PORTAL_CTX);
  if (servletContext.getContext(portalContextPath) != null) {
    RequestDispatcher requestDispatcher=request.getRequestDispatcher(apiPath);
    requestDispatcher.forward(request,response);
  }
 else {
    String requestUri=request.getRequestURI();
    String requestUrl=request.getRequestURL().toString();
    String queryString=request.getQueryString();
    String serverUrl=requestUrl.substring(0,requestUrl.length() - requestUri.length());
    if (Validator.isNull(queryString)) {
      String servletContextName=servletContext.getServletContextName();
      queryString="contextName=" + URLDecoder.decode(servletContextName,"UTF-8");
    }
    apiPath=serverUrl + apiPath + '?'+ queryString;
    URL url=new URL(apiPath);
    InputStream inputStream=null;
    try {
      inputStream=url.openStream();
      OutputStream outputStream=response.getOutputStream();
      StreamUtil.transfer(inputStream,outputStream);
    }
  finally {
      StreamUtil.cleanUp(inputStream);
    }
  }
}
