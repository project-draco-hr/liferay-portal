{
  long userId=portletDataContext.getUserId(feed.getUserUuid());
  JournalCreationStrategy creationStrategy=JournalCreationStrategyFactory.getInstance();
  long authorId=creationStrategy.getAuthorUserId(portletDataContext,feed);
  if (authorId != JournalCreationStrategy.USE_DEFAULT_USER_ID_STRATEGY) {
    userId=authorId;
  }
  Group group=GroupLocalServiceUtil.getGroup(portletDataContext.getScopeGroupId());
  String newGroupFriendlyURL=group.getFriendlyURL().substring(1);
  String[] friendlyURLParts=StringUtil.split(feed.getTargetLayoutFriendlyUrl(),'/');
  String oldGroupFriendlyURL=friendlyURLParts[2];
  if (oldGroupFriendlyURL.equals(ExportImportHelper.DATA_HANDLER_GROUP_FRIENDLY_URL)) {
    feed.setTargetLayoutFriendlyUrl(StringUtil.replace(feed.getTargetLayoutFriendlyUrl(),ExportImportHelper.DATA_HANDLER_GROUP_FRIENDLY_URL,newGroupFriendlyURL));
  }
  String feedId=feed.getFeedId();
  boolean autoFeedId=false;
  if (Validator.isNumber(feedId) || (JournalFeedLocalServiceUtil.fetchFeed(portletDataContext.getScopeGroupId(),feedId) != null)) {
    autoFeedId=true;
  }
  List<Element> ddmStructureElements=portletDataContext.getReferenceDataElements(feed,DDMStructure.class);
  String parentDDMStructureKey=StringPool.BLANK;
  if (!ddmStructureElements.isEmpty()) {
    Element ddmStructureElement=ddmStructureElements.get(0);
    String ddmStructurePath=ddmStructureElement.attributeValue("path");
    DDMStructure ddmStructure=(DDMStructure)portletDataContext.getZipEntryAsObject(ddmStructurePath);
    StagedModelDataHandlerUtil.importReferenceStagedModel(portletDataContext,ddmStructure);
    Map<String,String> ddmStructureKeys=(Map<String,String>)portletDataContext.getNewPrimaryKeysMap(DDMStructure.class + ".ddmStructureKey");
    parentDDMStructureKey=MapUtil.getString(ddmStructureKeys,ddmStructure.getStructureKey(),ddmStructure.getStructureKey());
  }
  List<Element> ddmTemplateElements=portletDataContext.getReferenceDataElements(feed,DDMTemplate.class);
  String parentDDMTemplateKey=StringPool.BLANK;
  String parentRendererDDMTemplateKey=StringPool.BLANK;
  for (  Element ddmTemplateElement : ddmTemplateElements) {
    String ddmTemplatePath=ddmTemplateElement.attributeValue("path");
    DDMTemplate ddmTemplate=(DDMTemplate)portletDataContext.getZipEntryAsObject(ddmTemplatePath);
    StagedModelDataHandlerUtil.importReferenceStagedModel(portletDataContext,ddmTemplate);
    Map<String,String> ddmTemplateKeys=(Map<String,String>)portletDataContext.getNewPrimaryKeysMap(DDMTemplate.class + ".ddmTemplateKey");
    boolean rendererDDMTemplate=GetterUtil.getBoolean(ddmTemplateElement.attributeValue("rendererDDMTemplate"));
    String ddmTemplateKey=MapUtil.getString(ddmTemplateKeys,ddmTemplate.getTemplateKey(),ddmTemplate.getTemplateKey());
    if (rendererDDMTemplate) {
      parentDDMTemplateKey=ddmTemplateKey;
    }
 else {
      parentRendererDDMTemplateKey=ddmTemplateKey;
    }
  }
  ServiceContext serviceContext=portletDataContext.createServiceContext(feed,JournalPortletDataHandler.NAMESPACE);
  boolean addGroupPermissions=creationStrategy.addGroupPermissions(portletDataContext,feed);
  serviceContext.setAddGroupPermissions(addGroupPermissions);
  boolean addGuestPermissions=creationStrategy.addGuestPermissions(portletDataContext,feed);
  serviceContext.setAddGuestPermissions(addGuestPermissions);
  JournalFeed importedFeed=null;
  try {
    if (portletDataContext.isDataStrategyMirror()) {
      JournalFeed existingFeed=JournalFeedLocalServiceUtil.fetchJournalFeedByUuidAndGroupId(feed.getUuid(),portletDataContext.getScopeGroupId());
      if (existingFeed == null) {
        serviceContext.setUuid(feed.getUuid());
        importedFeed=JournalFeedLocalServiceUtil.addFeed(userId,portletDataContext.getScopeGroupId(),feedId,autoFeedId,feed.getName(),feed.getDescription(),feed.getType(),parentDDMStructureKey,parentDDMTemplateKey,parentRendererDDMTemplateKey,feed.getDelta(),feed.getOrderByCol(),feed.getOrderByType(),feed.getTargetLayoutFriendlyUrl(),feed.getTargetPortletId(),feed.getContentField(),feed.getFeedFormat(),feed.getFeedVersion(),serviceContext);
      }
 else {
        importedFeed=JournalFeedLocalServiceUtil.updateFeed(existingFeed.getGroupId(),existingFeed.getFeedId(),feed.getName(),feed.getDescription(),feed.getType(),parentDDMStructureKey,parentDDMTemplateKey,parentRendererDDMTemplateKey,feed.getDelta(),feed.getOrderByCol(),feed.getOrderByType(),feed.getTargetLayoutFriendlyUrl(),feed.getTargetPortletId(),feed.getContentField(),feed.getFeedFormat(),feed.getFeedVersion(),serviceContext);
      }
    }
 else {
      importedFeed=JournalFeedLocalServiceUtil.addFeed(userId,portletDataContext.getScopeGroupId(),feedId,autoFeedId,feed.getName(),feed.getDescription(),feed.getType(),parentDDMStructureKey,parentDDMTemplateKey,parentRendererDDMTemplateKey,feed.getDelta(),feed.getOrderByCol(),feed.getOrderByType(),feed.getTargetLayoutFriendlyUrl(),feed.getTargetPortletId(),feed.getContentField(),feed.getFeedFormat(),feed.getFeedVersion(),serviceContext);
    }
    portletDataContext.importClassedModel(feed,importedFeed);
    if (!feedId.equals(importedFeed.getFeedId())) {
      if (_log.isWarnEnabled()) {
        StringBundler sb=new StringBundler(5);
        sb.append("A feed with the ID ");
        sb.append(feedId);
        sb.append(" already exists. The new generated ID is ");
        sb.append(importedFeed.getFeedId());
        sb.append(".");
        _log.warn(sb.toString());
      }
    }
  }
 catch (  FeedTargetLayoutFriendlyUrlException ftlfurle) {
    if (_log.isWarnEnabled()) {
      StringBundler sb=new StringBundler(6);
      sb.append("A feed with the ID ");
      sb.append(feedId);
      sb.append(" cannot be imported because layout with friendly ");
      sb.append("URL ");
      sb.append(feed.getTargetLayoutFriendlyUrl());
      sb.append(" does not exist");
      _log.warn(sb.toString());
    }
  }
}
