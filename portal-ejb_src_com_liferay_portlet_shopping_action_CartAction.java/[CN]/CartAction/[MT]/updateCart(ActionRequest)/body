{
  String cmd=ParamUtil.getString(req,Constants.CMD);
  ShoppingCart cart=ShoppingUtil.getCart(req);
  if (cmd.equals(Constants.ADD)) {
    String itemId=ParamUtil.getString(req,"itemId");
    String fields=ParamUtil.getString(req,"fields");
    if (Validator.isNotNull(fields)) {
      fields="|" + fields;
    }
    ShoppingItem item=ShoppingItemLocalServiceUtil.getItem(itemId);
    if (item.getMinQuantity() > 0) {
      for (int i=0; i < item.getMinQuantity(); i++) {
        cart.addItemId(itemId,fields);
      }
    }
 else {
      cart.addItemId(itemId,fields);
    }
  }
 else {
    String itemIds=ParamUtil.getString(req,"itemIds");
    String couponIds=ParamUtil.getString(req,"couponIds");
    int altShipping=ParamUtil.getInteger(req,"altShipping");
    boolean insure=ParamUtil.getBoolean(req,"insure");
    cart.setItemIds(itemIds);
    cart.setCouponIds(couponIds);
    cart.setAltShipping(altShipping);
    cart.setInsure(insure);
  }
  ShoppingCartLocalServiceUtil.updateCart(cart.getUserId(),cart.getGroupId(),cart.getCartId(),cart.getItemIds(),cart.getCouponIds(),cart.getAltShipping(),cart.isInsure());
  if (cmd.equals(Constants.ADD) || cmd.equals(Constants.UPDATE)) {
    SessionMessages.add(req,"request_processed");
  }
}
