{
  if ((_shardDataSourceTargetSource == null) || (_shardSessionFactoryTargetSource == null)) {
    return proceedingJoinPoint.proceed();
  }
  Object target=proceedingJoinPoint.getTarget();
  if (target instanceof ClassNamePersistence || target instanceof CompanyPersistence || target instanceof CounterFinder|| target instanceof CounterPersistence|| target instanceof PortalPreferencesPersistence|| target instanceof ReleasePersistence|| target instanceof ResourceActionPersistence|| target instanceof ServiceComponentPersistence|| target instanceof ShardPersistence|| target instanceof VirtualHostPersistence) {
    _shardDataSourceTargetSource.setDataSource(PropsValues.SHARD_DEFAULT_NAME);
    _shardSessionFactoryTargetSource.setSessionFactory(PropsValues.SHARD_DEFAULT_NAME);
    if (_log.isDebugEnabled()) {
      _log.debug("Using default shard for " + _getSignature(proceedingJoinPoint));
    }
    pushCompanyService(PropsValues.SHARD_DEFAULT_NAME);
    try {
      return proceedingJoinPoint.proceed();
    }
  finally {
      popCompanyService();
    }
  }
  if (_globalCall.get() == null) {
    _setShardNameByCompany();
    String shardName=_getShardName();
    _shardDataSourceTargetSource.setDataSource(shardName);
    _shardSessionFactoryTargetSource.setSessionFactory(shardName);
    if (_log.isInfoEnabled()) {
      _log.info("Using shard name " + shardName + " for "+ _getSignature(proceedingJoinPoint));
    }
    return proceedingJoinPoint.proceed();
  }
 else {
    return proceedingJoinPoint.proceed();
  }
}
