{
  SearchContext searchContext=getSearchContext();
  long[] groupIds=getGroupIds(searchContext);
  if (ArrayUtil.isEmpty(groupIds) || ((groupIds.length == 1) && (groupIds[0] == 0))) {
    return null;
  }
  BooleanFilter facetBooleanFilter=new BooleanFilter();
  long ownerUserId=searchContext.getOwnerUserId();
  if (ownerUserId > 0) {
    facetBooleanFilter.addRequiredTerm(Field.USER_ID,ownerUserId);
  }
  TermsFilter groupIdsTermsFilter=new TermsFilter(Field.GROUP_ID);
  TermsFilter scopeGroupIdsTermsFilter=new TermsFilter(Field.SCOPE_GROUP_ID);
  for (int i=0; i < groupIds.length; i++) {
    long groupId=groupIds[i];
    if (groupId <= 0) {
      continue;
    }
    try {
      Group group=GroupLocalServiceUtil.getGroup(groupId);
      if (!group.isActive()) {
        continue;
      }
      long parentGroupId=groupId;
      if (group.isLayout()) {
        parentGroupId=group.getParentGroupId();
      }
      groupIdsTermsFilter.addValue(String.valueOf(parentGroupId));
      groupIds[i]=parentGroupId;
      if (group.isLayout() || searchContext.isScopeStrict()) {
        scopeGroupIdsTermsFilter.addValue(String.valueOf(groupId));
      }
    }
 catch (    Exception e) {
      if (_log.isDebugEnabled()) {
        _log.debug(e,e);
      }
    }
  }
  searchContext.setGroupIds(groupIds);
  if (!groupIdsTermsFilter.isEmpty()) {
    facetBooleanFilter.add(groupIdsTermsFilter,BooleanClauseOccur.MUST);
  }
  if (!scopeGroupIdsTermsFilter.isEmpty()) {
    facetBooleanFilter.add(scopeGroupIdsTermsFilter,BooleanClauseOccur.MUST);
  }
  return BooleanClauseFactoryUtil.createFilter(searchContext,facetBooleanFilter,BooleanClauseOccur.MUST);
}
