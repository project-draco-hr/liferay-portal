{
  UploadPortletRequest uploadReq=PortalUtil.getUploadPortletRequest(req);
  String fileName=null;
  String deploymentContext=ParamUtil.getString(req,"deploymentContext");
  if (Validator.isNotNull(deploymentContext)) {
    fileName=BaseDeployer.DEPLOY_TO_PREFIX + deploymentContext + ".war";
  }
 else {
    fileName=GetterUtil.getString(uploadReq.getFileName("file"));
    int pos=fileName.lastIndexOf(StringPool.PERIOD);
    if (pos != -1) {
      deploymentContext=fileName.substring(0,pos);
    }
  }
  File file=uploadReq.getFile("file");
  byte[] bytes=FileUtil.getBytes(file);
  if ((bytes == null) || (bytes.length == 0)) {
    SessionErrors.add(req,UploadException.class.getName());
    return;
  }
  try {
    PluginPackageUtil.registerPluginPackageInstallation(deploymentContext);
    String source=file.toString();
    String deployDir=PrefsPropsUtil.getString(PropsUtil.AUTO_DEPLOY_DEPLOY_DIR,PropsValues.AUTO_DEPLOY_DEPLOY_DIR);
    String destination=deployDir + StringPool.SLASH + fileName;
    FileUtil.copyFile(source,destination);
    SessionMessages.add(req,"pluginUploaded");
  }
  finally {
    PluginPackageUtil.endPluginPackageInstallation(deploymentContext);
  }
}
