{
  UploadPortletRequest uploadPortletRequest=PortalUtil.getUploadPortletRequest(actionRequest);
  String fileName=null;
  String deploymentContext=ParamUtil.getString(actionRequest,"deploymentContext");
  if (Validator.isNotNull(deploymentContext)) {
    fileName=BaseDeployer.DEPLOY_TO_PREFIX + deploymentContext + ".war";
  }
 else {
    fileName=GetterUtil.getString(uploadPortletRequest.getFileName("file"));
    int pos=fileName.lastIndexOf(CharPool.PERIOD);
    if (pos != -1) {
      deploymentContext=fileName.substring(0,pos);
    }
  }
  File file=uploadPortletRequest.getFile("file");
  byte[] bytes=FileUtil.getBytes(file);
  if ((bytes == null) || (bytes.length == 0)) {
    SessionErrors.add(actionRequest,UploadException.class.getName());
    return;
  }
  try {
    PluginPackageUtil.registerPluginPackageInstallation(deploymentContext);
    String source=file.toString();
    String deployDir=PrefsPropsUtil.getString(PropsKeys.AUTO_DEPLOY_DEPLOY_DIR,PropsValues.AUTO_DEPLOY_DEPLOY_DIR);
    String destination=deployDir + StringPool.SLASH + fileName;
    FileUtil.copyFile(source,destination);
    SessionMessages.add(actionRequest,"pluginUploaded");
  }
  finally {
    PluginPackageUtil.endPluginPackageInstallation(deploymentContext);
  }
}
