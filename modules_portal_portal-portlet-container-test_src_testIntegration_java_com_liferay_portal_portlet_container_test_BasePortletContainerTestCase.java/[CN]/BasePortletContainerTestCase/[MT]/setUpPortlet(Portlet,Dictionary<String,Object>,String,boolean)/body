{
  Bundle bundle=FrameworkUtil.getBundle(getClass());
  BundleContext bundleContext=bundle.getBundleContext();
  Assert.assertNotNull(properties);
  properties.put("javax.portlet.name",portletName);
  serviceRegistrations.add(bundleContext.registerService(new String[]{Object.class.getName(),Portlet.class.getName()},portlet,properties));
  if (addToLayout) {
    LayoutTestUtil.addPortletToLayout(TestPropsValues.getUserId(),layout,portletName,"column-1",new HashMap<String,String[]>());
  }
}
