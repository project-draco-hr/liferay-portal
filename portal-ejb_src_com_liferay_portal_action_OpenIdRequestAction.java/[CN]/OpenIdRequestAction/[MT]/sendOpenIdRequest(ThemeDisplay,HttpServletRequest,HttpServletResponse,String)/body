{
  String returnToUrl=PortalUtil.getPortalURL(req) + themeDisplay.getPathMain() + "/portal/open_id_response";
  ConsumerManager manager=OpenIdUtil.getConsumerManager();
  List discoveries=manager.discover(openId);
  DiscoveryInformation discovered=manager.associate(discoveries);
  req.getSession().setAttribute("openid-disco",discovered);
  AuthRequest authReq=manager.authenticate(discovered,returnToUrl);
  if (_processUser(themeDisplay.getCompanyId(),openId)) {
    FetchRequest fetch=FetchRequest.createFetchRequest();
    fetch.addAttribute("email","http://schema.openid.net/contact/email",true);
    fetch.addAttribute("firstName","http://schema.openid.net/namePerson/first",true);
    fetch.addAttribute("lastName","http://schema.openid.net/namePerson/last",true);
    authReq.addExtension(fetch);
    SRegRequest sregReq=SRegRequest.createFetchRequest();
    sregReq.addAttribute("fullname",true);
    sregReq.addAttribute("email",true);
    authReq.addExtension(sregReq);
  }
  res.sendRedirect(authReq.getDestinationUrl(true));
}
