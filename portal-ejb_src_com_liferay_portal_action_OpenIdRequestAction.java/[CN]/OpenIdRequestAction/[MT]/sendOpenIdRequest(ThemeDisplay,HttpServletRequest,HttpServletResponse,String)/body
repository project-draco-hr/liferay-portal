{
  HttpSession ses=req.getSession();
  String returnURL=PortalUtil.getPortalURL(req) + themeDisplay.getPathMain() + "/portal/open_id_response";
  ConsumerManager manager=OpenIdUtil.getConsumerManager();
  List discoveries=manager.discover(openId);
  DiscoveryInformation discovered=manager.associate(discoveries);
  ses.setAttribute(WebKeys.OPEN_ID_DISCO,discovered);
  AuthRequest authReq=manager.authenticate(discovered,returnURL);
  String screenName=OpenIdUtil.getScreenName(openId);
  try {
    UserLocalServiceUtil.getUserByScreenName(themeDisplay.getCompanyId(),screenName);
  }
 catch (  NoSuchUserException nsue) {
    FetchRequest fetch=FetchRequest.createFetchRequest();
    fetch.addAttribute("email","http://schema.openid.net/contact/email",true);
    fetch.addAttribute("firstName","http://schema.openid.net/namePerson/first",true);
    fetch.addAttribute("lastName","http://schema.openid.net/namePerson/last",true);
    authReq.addExtension(fetch);
    SRegRequest sregReq=SRegRequest.createFetchRequest();
    sregReq.addAttribute("fullname",true);
    sregReq.addAttribute("email",true);
    authReq.addExtension(sregReq);
  }
  res.sendRedirect(authReq.getDestinationUrl(true));
}
