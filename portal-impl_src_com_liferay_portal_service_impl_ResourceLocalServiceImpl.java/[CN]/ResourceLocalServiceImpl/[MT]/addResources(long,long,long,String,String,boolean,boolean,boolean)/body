{
  StopWatch stopWatch=null;
  if (_log.isDebugEnabled()) {
    stopWatch=new StopWatch();
    stopWatch.start();
  }
  validate(companyId,name,portletActions);
  logAddResources(name,primKey,stopWatch,1);
  addResource(companyId,name,ResourceConstants.SCOPE_COMPANY,String.valueOf(companyId));
  logAddResources(name,primKey,stopWatch,2);
  if (groupId > 0) {
    addResource(companyId,name,ResourceConstants.SCOPE_GROUP,String.valueOf(groupId));
  }
  logAddResources(name,primKey,stopWatch,3);
  if (primKey != null) {
    Resource resource=addResource(companyId,name,ResourceConstants.SCOPE_INDIVIDUAL,primKey);
    logAddResources(name,primKey,stopWatch,4);
    List<Permission> permissionsList=permissionLocalService.addPermissions(companyId,name,resource.getResourceId(),portletActions);
    logAddResources(name,primKey,stopWatch,5);
    PermissionsListFilter permissionsListFilter=PermissionsListFilterFactory.getInstance();
    List<Permission> userPermissionsList=permissionsListFilter.filterUserPermissions(companyId,groupId,userId,name,primKey,portletActions,permissionsList);
    if (PropsValues.PERMISSIONS_USER_CHECK_ALGORITHM != 5) {
      long defaultUserId=userLocalService.getDefaultUserId(companyId);
      if ((userId > 0) && (userId != defaultUserId)) {
        userPersistence.addPermissions(userId,userPermissionsList);
      }
    }
    logAddResources(name,primKey,stopWatch,6);
    if ((groupId > 0) && addCommunityPermissions) {
      addCommunityPermissions(companyId,groupId,userId,name,resource,portletActions);
    }
    logAddResources(name,primKey,stopWatch,7);
    if (PropsValues.PERMISSIONS_USER_CHECK_ALGORITHM == 5) {
      Role role=roleLocalService.getRole(companyId,RoleNames.OWNER);
      rolePersistence.addPermissions(role.getRoleId(),userPermissionsList);
    }
    if (addGuestPermissions) {
      addGuestPermissions(companyId,groupId,userId,name,resource,portletActions);
    }
    logAddResources(name,primKey,stopWatch,8);
  }
}
