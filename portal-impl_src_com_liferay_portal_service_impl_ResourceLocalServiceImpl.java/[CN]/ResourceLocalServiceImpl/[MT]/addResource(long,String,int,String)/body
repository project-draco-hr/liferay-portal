{
  ResourceCode resourceCode=resourceCodeLocalService.getResourceCode(companyId,name,scope);
  long codeId=resourceCode.getCodeId();
  Resource resource=resourcePersistence.fetchByC_P(codeId,primKey,false);
  if (resource == null) {
    long resourceId=counterLocalService.increment(Resource.class.getName());
    resource=resourcePersistence.create(resourceId);
    resource.setCodeId(codeId);
    resource.setPrimKey(primKey);
    try {
      resourcePersistence.update(resource,false);
    }
 catch (    SystemException se) {
      if (_log.isWarnEnabled()) {
        _log.warn("Add failed, fetch {codeId=" + codeId + ", primKey="+ primKey+ "}");
      }
      resource=resourcePersistence.fetchByC_P(codeId,primKey,false);
      if (resource == null) {
        throw se;
      }
    }
  }
  return resource;
}
