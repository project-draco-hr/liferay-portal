{
  long defaultUserId=userLocalService.getDefaultUserId(companyId);
  PermissionsListFilter permissionsListFilter=PermissionsListFilterFactory.getInstance();
  List<Permission> permissionsList=permissionLocalService.addPermissions(companyId,resource.getName(),resource.getResourceId(),false);
  List<Permission> userPermissionsList=permissionsListFilter.filterUserPermissions(companyId,groupId,userId,resource.getName(),resource.getPrimKey(),false,permissionsList);
  filterOwnerPermissions(resource.getName(),userPermissionsList);
  if ((userId > 0) && (userId != defaultUserId)) {
    userPersistence.addPermissions(userId,userPermissionsList);
  }
  if (groupId > 0) {
    if (groupPermissions == null) {
      groupPermissions=new String[0];
    }
    List<Permission> groupPermissionsList=permissionLocalService.getPermissions(companyId,groupPermissions,resource.getResourceId());
    groupPermissionsList=permissionsListFilter.filterGroupPermissions(companyId,groupId,userId,resource.getName(),resource.getPrimKey(),false,groupPermissionsList);
    groupPersistence.addPermissions(groupId,groupPermissionsList);
  }
  if (guestPermissions == null) {
    guestPermissions=new String[0];
  }
  List<Permission> guestPermissionsList=permissionLocalService.getPermissions(companyId,guestPermissions,resource.getResourceId());
  guestPermissionsList=permissionsListFilter.filterGuestPermissions(companyId,groupId,userId,resource.getName(),resource.getPrimKey(),false,guestPermissionsList);
  userPersistence.addPermissions(defaultUserId,guestPermissionsList);
}
