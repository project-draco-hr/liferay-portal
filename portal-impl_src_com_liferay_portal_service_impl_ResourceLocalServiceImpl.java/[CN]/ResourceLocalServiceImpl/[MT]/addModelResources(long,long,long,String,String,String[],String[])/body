{
  validate(companyId,name,false);
  addResource(companyId,name,ResourceImpl.SCOPE_COMPANY,String.valueOf(companyId));
  Group guestGroup=groupLocalService.getGroup(companyId,GroupImpl.GUEST);
  addResource(companyId,name,ResourceImpl.SCOPE_GROUP,String.valueOf(guestGroup.getGroupId()));
  if ((groupId > 0) && (guestGroup.getGroupId() != groupId)) {
    addResource(companyId,name,ResourceImpl.SCOPE_GROUP,String.valueOf(groupId));
  }
  if (primKey != null) {
    Resource resource=addResource(companyId,name,ResourceImpl.SCOPE_INDIVIDUAL,primKey);
    List<Permission> permissionsList=permissionLocalService.addPermissions(companyId,name,resource.getResourceId(),false);
    PermissionsListFilter permissionsListFilter=PermissionsListFilterFactory.getInstance();
    long defaultUserId=userLocalService.getDefaultUserId(companyId);
    if ((userId > 0) && (userId != defaultUserId)) {
      List<Permission> userPermissionsList=permissionsListFilter.filterUserPermissions(companyId,groupId,userId,name,primKey,false,permissionsList);
      userPersistence.addPermissions(userId,userPermissionsList);
    }
    if (groupId > 0) {
      groupPersistence.findByPrimaryKey(groupId);
      if (communityPermissions == null) {
        communityPermissions=new String[0];
      }
      List<Permission> communityPermissionsList=permissionLocalService.getPermissions(companyId,communityPermissions,resource.getResourceId());
      communityPermissionsList=permissionsListFilter.filterCommunityPermissions(companyId,groupId,userId,name,primKey,false,communityPermissionsList);
      groupPersistence.addPermissions(groupId,communityPermissionsList);
    }
    if (guestPermissions == null) {
      guestPermissions=new String[0];
    }
    List<Permission> guestPermissionsList=permissionLocalService.getPermissions(companyId,guestPermissions,resource.getResourceId());
    guestPermissionsList=permissionsListFilter.filterGuestPermissions(companyId,groupId,userId,name,primKey,false,guestPermissionsList);
    userPersistence.addPermissions(defaultUserId,guestPermissionsList);
  }
}
