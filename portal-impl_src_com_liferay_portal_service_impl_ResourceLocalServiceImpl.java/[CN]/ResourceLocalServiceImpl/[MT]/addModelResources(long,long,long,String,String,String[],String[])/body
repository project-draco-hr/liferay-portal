{
  validate(companyId,name,false);
  addResource(companyId,name,ResourceConstants.SCOPE_COMPANY,String.valueOf(companyId));
  Group guestGroup=groupLocalService.getGroup(companyId,GroupImpl.GUEST);
  addResource(companyId,name,ResourceConstants.SCOPE_GROUP,String.valueOf(guestGroup.getGroupId()));
  if ((groupId > 0) && (guestGroup.getGroupId() != groupId)) {
    addResource(companyId,name,ResourceConstants.SCOPE_GROUP,String.valueOf(groupId));
  }
  if (primKey != null) {
    Resource resource=addResource(companyId,name,ResourceConstants.SCOPE_INDIVIDUAL,primKey);
    long defaultUserId=userLocalService.getDefaultUserId(companyId);
    PermissionsListFilter permissionsListFilter=PermissionsListFilterFactory.getInstance();
    List<Permission> permissionsList=permissionLocalService.addPermissions(companyId,name,resource.getResourceId(),false);
    List<Permission> userPermissionsList=permissionsListFilter.filterUserPermissions(companyId,groupId,userId,name,primKey,false,permissionsList);
    if (PropsValues.PERMISSIONS_USER_CHECK_ALGORITHM == 5) {
      Role ownerRole=roleLocalService.getRole(companyId,RoleNames.OWNER);
      rolePersistence.addPermissions(ownerRole.getRoleId(),userPermissionsList);
    }
 else {
      if ((userId > 0) && (userId != defaultUserId)) {
        userPersistence.addPermissions(userId,userPermissionsList);
      }
    }
    if (groupId > 0) {
      Group group=groupPersistence.findByPrimaryKey(groupId);
      if (communityPermissions == null) {
        communityPermissions=new String[0];
      }
      List<Permission> communityPermissionsList=permissionLocalService.getPermissions(companyId,communityPermissions,resource.getResourceId());
      communityPermissionsList=permissionsListFilter.filterCommunityPermissions(companyId,groupId,userId,name,primKey,false,communityPermissionsList);
      if (PropsValues.PERMISSIONS_USER_CHECK_ALGORITHM == 5) {
        Role role=null;
        if (group.isLayout()) {
          Layout layout=layoutLocalService.getLayout(group.getClassPK());
          group=layout.getGroup();
        }
        if (group.isCommunity()) {
          role=roleLocalService.getRole(companyId,RoleNames.COMMUNITY_MEMBER);
        }
 else         if (group.isOrganization()) {
          role=roleLocalService.getRole(companyId,RoleNames.ORGANIZATION_MEMBER);
        }
 else         if (group.isUser() || group.isUserGroup()) {
          role=roleLocalService.getRole(companyId,RoleNames.POWER_USER);
        }
        rolePersistence.addPermissions(role.getRoleId(),communityPermissionsList);
      }
 else {
        groupPersistence.addPermissions(groupId,communityPermissionsList);
      }
    }
    if (guestPermissions == null) {
      guestPermissions=new String[0];
    }
    List<Permission> guestPermissionsList=permissionLocalService.getPermissions(companyId,guestPermissions,resource.getResourceId());
    guestPermissionsList=permissionsListFilter.filterGuestPermissions(companyId,groupId,userId,name,primKey,false,guestPermissionsList);
    if (PropsValues.PERMISSIONS_USER_CHECK_ALGORITHM == 5) {
      Role guestRole=roleLocalService.getRole(companyId,RoleImpl.GUEST);
      rolePersistence.addPermissions(guestRole.getRoleId(),guestPermissionsList);
    }
 else {
      userPersistence.addPermissions(defaultUserId,guestPermissionsList);
    }
  }
}
