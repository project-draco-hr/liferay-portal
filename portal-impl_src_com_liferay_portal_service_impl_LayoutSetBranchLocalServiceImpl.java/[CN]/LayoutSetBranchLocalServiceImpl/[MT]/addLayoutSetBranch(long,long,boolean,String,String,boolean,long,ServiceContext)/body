{
  User user=userPersistence.findByPrimaryKey(userId);
  Date now=new Date();
  validate(0,groupId,privateLayout,name,master);
  boolean logo=false;
  long logoId=0;
  String themeId=null;
  String colorSchemeId=null;
  String wapThemeId=null;
  String wapColorSchemeId=null;
  String css=null;
  String settings=null;
  if (copyLayoutSetBranchId > 0) {
    LayoutSetBranch copyLayoutSetBranch=getLayoutSetBranch(copyLayoutSetBranchId);
    logo=copyLayoutSetBranch.getLogo();
    logoId=copyLayoutSetBranch.getLogoId();
    themeId=copyLayoutSetBranch.getThemeId();
    colorSchemeId=copyLayoutSetBranch.getColorSchemeId();
    wapThemeId=copyLayoutSetBranch.getWapThemeId();
    wapColorSchemeId=copyLayoutSetBranch.getWapColorSchemeId();
    css=copyLayoutSetBranch.getCss();
    settings=copyLayoutSetBranch.getSettings();
  }
 else {
    LayoutSet layoutSet=layoutSetLocalService.getLayoutSet(groupId,privateLayout);
    logo=layoutSet.getLogo();
    logoId=layoutSet.getLogoId();
    themeId=layoutSet.getThemeId();
    colorSchemeId=layoutSet.getColorSchemeId();
    wapThemeId=layoutSet.getWapThemeId();
    wapColorSchemeId=layoutSet.getWapColorSchemeId();
    css=layoutSet.getCss();
    settings=layoutSet.getSettings();
  }
  long layoutSetBranchId=counterLocalService.increment();
  LayoutSetBranch layoutSetBranch=layoutSetBranchPersistence.create(layoutSetBranchId);
  layoutSetBranch.setGroupId(groupId);
  layoutSetBranch.setCompanyId(user.getCompanyId());
  layoutSetBranch.setUserId(user.getUserId());
  layoutSetBranch.setUserName(user.getFullName());
  layoutSetBranch.setCreateDate(serviceContext.getCreateDate(now));
  layoutSetBranch.setModifiedDate(serviceContext.getModifiedDate(now));
  layoutSetBranch.setPrivateLayout(privateLayout);
  layoutSetBranch.setName(name);
  layoutSetBranch.setDescription(description);
  layoutSetBranch.setMaster(master);
  layoutSetBranch.setLogo(logo);
  layoutSetBranch.setLogoId(logoId);
  if (logo) {
    Image logoImage=imageLocalService.getImage(logoId);
    long layoutSetBranchLogoId=counterLocalService.increment();
    imageLocalService.updateImage(layoutSetBranchLogoId,logoImage.getTextObj(),logoImage.getType(),logoImage.getHeight(),logoImage.getWidth(),logoImage.getSize());
    layoutSetBranch.setLogoId(layoutSetBranchLogoId);
  }
  layoutSetBranch.setThemeId(themeId);
  layoutSetBranch.setColorSchemeId(colorSchemeId);
  layoutSetBranch.setWapThemeId(wapThemeId);
  layoutSetBranch.setWapColorSchemeId(wapColorSchemeId);
  layoutSetBranch.setCss(css);
  layoutSetBranch.setSettings(settings);
  layoutSetBranchPersistence.update(layoutSetBranch);
  resourceLocalService.addResources(user.getCompanyId(),layoutSetBranch.getGroupId(),user.getUserId(),LayoutSetBranch.class.getName(),layoutSetBranch.getLayoutSetBranchId(),false,true,false);
  if (layoutSetBranch.isMaster() || (copyLayoutSetBranchId == LayoutSetBranchConstants.ALL_BRANCHES)) {
    List<Layout> layouts=layoutPersistence.findByG_P(layoutSetBranch.getGroupId(),layoutSetBranch.getPrivateLayout());
    for (    Layout layout : layouts) {
      LayoutBranch layoutBranch=layoutBranchLocalService.addLayoutBranch(layoutSetBranchId,layout.getPlid(),LayoutBranchConstants.MASTER_BRANCH_NAME,LayoutBranchConstants.MASTER_BRANCH_DESCRIPTION,true,serviceContext);
      LayoutRevision lastLayoutRevision=layoutRevisionLocalService.fetchLastLayoutRevision(layout.getPlid(),true);
      if (lastLayoutRevision != null) {
        layoutRevisionLocalService.addLayoutRevision(userId,layoutSetBranchId,layoutBranch.getLayoutBranchId(),LayoutRevisionConstants.DEFAULT_PARENT_LAYOUT_REVISION_ID,true,lastLayoutRevision.getPlid(),lastLayoutRevision.getLayoutRevisionId(),lastLayoutRevision.getPrivateLayout(),lastLayoutRevision.getName(),lastLayoutRevision.getTitle(),lastLayoutRevision.getDescription(),lastLayoutRevision.getKeywords(),lastLayoutRevision.getRobots(),lastLayoutRevision.getTypeSettings(),lastLayoutRevision.isIconImage(),lastLayoutRevision.getIconImageId(),lastLayoutRevision.getThemeId(),lastLayoutRevision.getColorSchemeId(),lastLayoutRevision.getWapThemeId(),lastLayoutRevision.getWapColorSchemeId(),lastLayoutRevision.getCss(),serviceContext);
      }
 else {
        layoutRevisionLocalService.addLayoutRevision(userId,layoutSetBranchId,layoutBranch.getLayoutBranchId(),LayoutRevisionConstants.DEFAULT_PARENT_LAYOUT_REVISION_ID,false,layout.getPlid(),LayoutConstants.DEFAULT_PLID,layout.getPrivateLayout(),layout.getName(),layout.getTitle(),layout.getDescription(),layout.getKeywords(),layout.getRobots(),layout.getTypeSettings(),layout.isIconImage(),layout.getIconImageId(),layout.getThemeId(),layout.getColorSchemeId(),layout.getWapThemeId(),layout.getWapColorSchemeId(),layout.getCss(),serviceContext);
      }
    }
  }
 else   if (copyLayoutSetBranchId > 0) {
    List<LayoutRevision> layoutRevisions=layoutRevisionLocalService.getLayoutRevisions(copyLayoutSetBranchId,true);
    for (    LayoutRevision layoutRevision : layoutRevisions) {
      LayoutBranch layoutBranch=layoutBranchLocalService.addLayoutBranch(layoutSetBranchId,layoutRevision.getPlid(),LayoutBranchConstants.MASTER_BRANCH_NAME,LayoutBranchConstants.MASTER_BRANCH_DESCRIPTION,true,serviceContext);
      layoutRevisionLocalService.addLayoutRevision(userId,layoutSetBranchId,layoutBranch.getLayoutBranchId(),LayoutRevisionConstants.DEFAULT_PARENT_LAYOUT_REVISION_ID,true,layoutRevision.getPlid(),layoutRevision.getLayoutRevisionId(),layoutRevision.getPrivateLayout(),layoutRevision.getName(),layoutRevision.getTitle(),layoutRevision.getDescription(),layoutRevision.getKeywords(),layoutRevision.getRobots(),layoutRevision.getTypeSettings(),layoutRevision.isIconImage(),layoutRevision.getIconImageId(),layoutRevision.getThemeId(),layoutRevision.getColorSchemeId(),layoutRevision.getWapThemeId(),layoutRevision.getWapColorSchemeId(),layoutRevision.getCss(),serviceContext);
    }
  }
  LayoutSet layoutSet=layoutSetBranch.getLayoutSet();
  StagingUtil.setRecentLayoutSetBranchId(user,layoutSet.getLayoutSetId(),layoutSetBranch.getLayoutSetBranchId());
  return layoutSetBranch;
}
