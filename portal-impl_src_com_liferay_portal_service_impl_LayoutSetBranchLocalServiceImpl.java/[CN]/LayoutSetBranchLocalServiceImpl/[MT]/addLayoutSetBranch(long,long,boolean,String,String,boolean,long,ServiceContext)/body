{
  User user=userPersistence.findByPrimaryKey(userId);
  Date now=new Date();
  validate(groupId,LayoutSetBranchConstants.NO_BRANCHES,privateLayout,name,master);
  long layoutSetBranchId=counterLocalService.increment();
  LayoutSetBranch layoutSetBranch=layoutSetBranchPersistence.create(layoutSetBranchId);
  layoutSetBranch.setGroupId(groupId);
  layoutSetBranch.setCompanyId(user.getCompanyId());
  layoutSetBranch.setUserId(user.getUserId());
  layoutSetBranch.setUserName(user.getFullName());
  layoutSetBranch.setCreateDate(serviceContext.getCreateDate(now));
  layoutSetBranch.setModifiedDate(serviceContext.getModifiedDate(now));
  layoutSetBranch.setPrivateLayout(privateLayout);
  layoutSetBranch.setName(name);
  layoutSetBranch.setDescription(description);
  layoutSetBranch.setMaster(master);
  layoutSetBranchPersistence.update(layoutSetBranch,false);
  resourceLocalService.addResources(user.getCompanyId(),layoutSetBranch.getGroupId(),user.getUserId(),LayoutSetBranch.class.getName(),layoutSetBranch.getLayoutSetBranchId(),false,true,false);
  if (layoutSetBranch.isMaster() || (copyLayoutSetBranchId == LayoutSetBranchConstants.ALL_BRANCHES)) {
    List<Layout> layouts=layoutPersistence.findByG_P(layoutSetBranch.getGroupId(),layoutSetBranch.getPrivateLayout());
    for (    Layout layout : layouts) {
      LayoutBranch layoutBranch=layoutBranchLocalService.addLayoutBranch(layoutSetBranchId,layout.getPlid(),LayoutBranchConstants.MASTER_BRANCH_NAME,LayoutBranchConstants.MASTER_BRANCH_DESCRIPTION,true,serviceContext);
      layoutRevisionLocalService.addLayoutRevision(userId,layoutSetBranchId,layoutBranch.getLayoutBranchId(),LayoutRevisionConstants.DEFAULT_PARENT_LAYOUT_REVISION_ID,true,layout.getPlid(),layout.getPrivateLayout(),layout.getName(),layout.getTitle(),layout.getDescription(),layout.getKeywords(),layout.getRobots(),layout.getTypeSettings(),layout.isIconImage(),layout.getIconImageId(),layout.getThemeId(),layout.getColorSchemeId(),layout.getWapThemeId(),layout.getWapColorSchemeId(),layout.getCss(),serviceContext);
    }
  }
 else   if (copyLayoutSetBranchId > 0) {
    List<LayoutRevision> layoutRevisions=layoutRevisionLocalService.getLayoutRevisions(copyLayoutSetBranchId,true);
    for (    LayoutRevision layoutRevision : layoutRevisions) {
      layoutRevisionLocalService.addLayoutRevision(userId,layoutSetBranchId,layoutRevision.getLayoutBranchId(),LayoutRevisionConstants.DEFAULT_PARENT_LAYOUT_REVISION_ID,true,layoutRevision.getPlid(),layoutRevision.getPrivateLayout(),layoutRevision.getName(),layoutRevision.getTitle(),layoutRevision.getDescription(),layoutRevision.getKeywords(),layoutRevision.getRobots(),layoutRevision.getTypeSettings(),layoutRevision.isIconImage(),layoutRevision.getIconImageId(),layoutRevision.getThemeId(),layoutRevision.getColorSchemeId(),layoutRevision.getWapThemeId(),layoutRevision.getWapColorSchemeId(),layoutRevision.getCss(),serviceContext);
    }
  }
  return layoutSetBranch;
}
