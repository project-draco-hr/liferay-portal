{
  PortletPreferences preferences=actionRequest.getPreferences();
  ThemeDisplay themeDisplay=(ThemeDisplay)actionRequest.getAttribute(WebKeys.THEME_DISPLAY);
  long groupId=themeDisplay.getScopeGroupId();
  long categoryId=ParamUtil.getLong(actionRequest,"mbCategoryId");
  long threadId=ParamUtil.getLong(actionRequest,"threadId");
  MBThread thread=MBThreadLocalServiceUtil.getThread(threadId);
  MBThreadServiceUtil.moveThread(categoryId,threadId);
  boolean addExplanationPost=ParamUtil.getBoolean(actionRequest,"addExplanationPost");
  if (addExplanationPost) {
    String subject=ParamUtil.getString(actionRequest,"subject");
    String body=ParamUtil.getString(actionRequest,"body");
    String format=GetterUtil.getString(preferences.getValue("messageFormat",null),MBMessageConstants.DEFAULT_FORMAT);
    ServiceContext serviceContext=ServiceContextFactory.getInstance(MBMessage.class.getName(),actionRequest);
    MBMessageServiceUtil.addMessage(groupId,categoryId,threadId,thread.getRootMessageId(),subject,body,format,Collections.<ObjectValuePair<String,InputStream>>emptyList(),false,MBThreadConstants.PRIORITY_NOT_GIVEN,false,serviceContext);
  }
  PortletURL portletURL=((ActionResponseImpl)actionResponse).createRenderURL();
  portletURL.setParameter("struts_action","/message_boards/view_message");
  portletURL.setParameter("messageId",String.valueOf(thread.getRootMessageId()));
  actionResponse.sendRedirect(portletURL.toString());
}
