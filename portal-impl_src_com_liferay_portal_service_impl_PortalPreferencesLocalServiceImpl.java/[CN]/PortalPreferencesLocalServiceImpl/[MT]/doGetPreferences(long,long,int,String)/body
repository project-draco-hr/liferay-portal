{
  Map<Serializable,BasePreferencesImpl> preferencesPool=PortletPreferencesLocalUtil.getPreferencesPool(ownerId,ownerType);
  PortalPreferencesImpl portalPreferencesImpl=(PortalPreferencesImpl)preferencesPool.get(companyId);
  if (portalPreferencesImpl == null) {
    PortalPreferences portalPreferences=portalPreferencesPersistence.fetchByO_O(ownerId,ownerType);
    if (portalPreferences == null) {
      if (PortletPreferencesThreadLocal.isStrict() && Validator.isNull(defaultPreferences)) {
        return new PortalPreferencesWrapper(new PortalPreferencesImpl());
      }
      portalPreferences=portalPreferencesLocalService.addPortalPreferences(companyId,ownerId,ownerType,defaultPreferences);
    }
    portalPreferencesImpl=(PortalPreferencesImpl)PortletPreferencesFactoryUtil.fromXML(companyId,ownerId,ownerType,portalPreferences.getPreferences());
synchronized (preferencesPool) {
      preferencesPool.put(companyId,portalPreferencesImpl);
    }
  }
  return new PortalPreferencesWrapper((PortalPreferencesImpl)portalPreferencesImpl.clone());
}
