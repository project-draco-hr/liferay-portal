{
  PortalPreferences previousPortalPreferences=portalPreferencesPersistence.fetchByO_O(ownerId,ownerType);
  if (previousPortalPreferences != null) {
    throw new IllegalArgumentException("Duplicate owner ID and owner type exists in " + previousPortalPreferences);
  }
  PortalPreferencesWrapperCacheUtil.remove(ownerId,ownerType);
  long portalPreferencesId=counterLocalService.increment();
  PortalPreferences portalPreferences=portalPreferencesPersistence.create(portalPreferencesId);
  portalPreferences.setOwnerId(ownerId);
  portalPreferences.setOwnerType(ownerType);
  if (Validator.isNull(defaultPreferences)) {
    defaultPreferences=PortletConstants.DEFAULT_PREFERENCES;
  }
  portalPreferences.setPreferences(defaultPreferences);
  try {
    portalPreferencesPersistence.update(portalPreferences);
  }
 catch (  SystemException se) {
    if (_log.isWarnEnabled()) {
      _log.warn("Add failed, fetch {ownerId=" + ownerId + ", ownerType="+ ownerType+ "}");
    }
    portalPreferences=portalPreferencesPersistence.fetchByO_O(ownerId,ownerType,false);
    if (portalPreferences == null) {
      throw se;
    }
  }
  return portalPreferences;
}
