{
  boolean enabled=ParamUtil.getBoolean(req,"enabled");
  boolean required=ParamUtil.getBoolean(req,"required");
  String baseProviderURL=ParamUtil.getString(req,"baseProviderURL");
  String baseDN=ParamUtil.getString(req,"baseDN");
  String principal=ParamUtil.getString(req,"principal");
  String credentials=ParamUtil.getString(req,"credentials");
  String searchFilter=ParamUtil.getString(req,"searchFilter");
  String passwordEncryptionAlgorithm=ParamUtil.getString(req,"passwordEncryptionAlgorithm");
  String userMappings=ParamUtil.getString(req,"userMappings");
  try {
    if (enabled) {
      Properties env=new Properties();
      env.put(Context.INITIAL_CONTEXT_FACTORY,PrefsPropsUtil.getString(PropsUtil.LDAP_FACTORY_INITIAL));
      env.put(Context.PROVIDER_URL,LDAPUtil.getFullProviderURL(baseProviderURL,baseDN));
      env.put(Context.SECURITY_PRINCIPAL,principal);
      env.put(Context.SECURITY_CREDENTIALS,credentials);
      if (_log.isDebugEnabled()) {
        StringWriter sw=new StringWriter();
        env.list(new PrintWriter(sw));
        _log.debug(sw.getBuffer().toString());
      }
      new InitialLdapContext(env,null);
    }
  }
 catch (  Exception e) {
    SessionErrors.add(req,"ldapAuthentication");
    return;
  }
  prefs.setValue(PropsUtil.LDAP_AUTH_ENABLED,Boolean.toString(enabled));
  prefs.setValue(PropsUtil.LDAP_AUTH_REQUIRED,Boolean.toString(required));
  prefs.setValue(PropsUtil.LDAP_BASE_PROVIDER_URL,baseProviderURL);
  prefs.setValue(PropsUtil.LDAP_BASE_DN,baseDN);
  prefs.setValue(PropsUtil.LDAP_SECURITY_PRINCIPAL,principal);
  prefs.setValue(PropsUtil.LDAP_SECURITY_CREDENTIALS,credentials);
  prefs.setValue(PropsUtil.LDAP_AUTH_SEARCH_FILTER,searchFilter);
  prefs.setValue(PropsUtil.LDAP_AUTH_PASSWORD_ENCRYPTION_ALGORITHM,passwordEncryptionAlgorithm);
  prefs.setValue(PropsUtil.LDAP_USER_MAPPINGS,userMappings);
  prefs.store();
}
