{
  long userId=0;
  try {
    String name=PrincipalThreadLocal.getName();
    if (name == null) {
      userId=getUserId(sc);
      name=String.valueOf(userId);
      PrincipalThreadLocal.setName(name);
    }
  }
 catch (  PrincipalException pe) {
  }
  try {
    PermissionCheckerImpl permissionChecker=PermissionThreadLocal.getPermissionChecker();
    if (permissionChecker == null) {
      permissionChecker=(PermissionCheckerImpl)Class.forName(PropsUtil.get(PropsUtil.PERMISSIONS_CHECKER)).newInstance();
      User user=null;
      boolean signedIn=false;
      boolean checkGuest=true;
      if (userId > 0) {
        UserLocalService userLocalService=UserLocalServiceFactory.getTxImpl();
        user=userLocalService.getUserById(userId);
        signedIn=true;
      }
      permissionChecker.init(user,signedIn,checkGuest);
      PermissionThreadLocal.setPermissionChecker(permissionChecker);
    }
  }
 catch (  Exception e) {
    _log.error(e);
  }
}
