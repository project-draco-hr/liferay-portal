{
  String userId=null;
  try {
    userId=PrincipalThreadLocal.getName();
    if (userId == null) {
      userId=getUserId(sc);
      PrincipalThreadLocal.setName(userId);
    }
  }
 catch (  PrincipalException pe) {
  }
  try {
    PermissionChecker permissionChecker=PermissionThreadLocal.getPermissionChecker();
    if (permissionChecker == null) {
      permissionChecker=(PermissionChecker)Class.forName(PropsUtil.get(PropsUtil.PERMISSIONS_CHECKER)).newInstance();
      User user=null;
      boolean signedIn=false;
      if (userId != null) {
        user=UserUtil.findByPrimaryKey(userId);
        signedIn=true;
      }
      permissionChecker.init(user,signedIn);
      PermissionThreadLocal.setPermissionChecker(permissionChecker);
    }
  }
 catch (  Exception e) {
    _log.error(e.getMessage());
    _log.warn(StackTraceUtil.getStackTrace(e));
  }
}
