{
  Set<Long> remoteSyncSiteIds=new HashSet<>();
  if (_remoteSyncSites == null) {
    _remoteSyncSites=JSONUtil.readValue(response,new TypeReference<List<SyncSite>>(){
    }
);
  }
  for (  SyncSite remoteSyncSite : _remoteSyncSites) {
    SyncSite localSyncSite=SyncSiteService.fetchSyncSite(remoteSyncSite.getGroupId(),getSyncAccountId());
    SyncAccount syncAccount=SyncAccountService.fetchSyncAccount(getSyncAccountId());
    String filePathName=FileUtil.getFilePathName(syncAccount.getFilePathName(),remoteSyncSite.getSanitizedName());
    if (localSyncSite == null) {
      SyncSite deletedSyncSite=SyncSiteService.fetchSyncSite(filePathName,getSyncAccountId());
      if (deletedSyncSite != null) {
        if (deletedSyncSite.isActive()) {
          if (_logger.isDebugEnabled()) {
            _logger.debug("Sync site {} was deactivated or removed.",deletedSyncSite.getName());
          }
          deletedSyncSite.setUiEvent(SyncSite.UI_EVENT_SYNC_SITE_DEACTIVATED);
          SyncSiteService.update(deletedSyncSite);
        }
        SyncSiteService.deleteSyncSite(deletedSyncSite.getSyncSiteId());
      }
      remoteSyncSite.setFilePathName(filePathName);
      remoteSyncSite.setRemoteSyncTime(-1);
      remoteSyncSite.setSyncAccountId(getSyncAccountId());
      SyncSiteService.update(remoteSyncSite);
      remoteSyncSiteIds.add(remoteSyncSite.getSyncSiteId());
      SyncFileService.addSyncFile(null,null,false,null,remoteSyncSite.getFilePathName(),null,remoteSyncSite.getName(),0,remoteSyncSite.getGroupId(),0,SyncFile.STATE_SYNCED,remoteSyncSite.getSyncAccountId(),SyncFile.TYPE_SYSTEM);
    }
 else {
      String localSyncSiteName=localSyncSite.getName();
      localSyncSite.setDescription(remoteSyncSite.getDescription());
      localSyncSite.setFriendlyURL(remoteSyncSite.getFriendlyURL());
      localSyncSite.setName(remoteSyncSite.getName());
      localSyncSite.setType(remoteSyncSite.getType());
      localSyncSite.setTypeSettings(remoteSyncSite.getTypeSettings());
      localSyncSite.setSite(remoteSyncSite.getSite());
      SyncSiteService.update(localSyncSite);
      if (!localSyncSiteName.equals(remoteSyncSite.getName())) {
        SyncSiteService.setFilePathName(localSyncSite.getSyncSiteId(),filePathName);
        FileUtil.moveFile(Paths.get(localSyncSite.getFilePathName()),Paths.get(filePathName));
      }
      remoteSyncSiteIds.add(localSyncSite.getSyncSiteId());
    }
  }
  List<SyncSite> localSyncSites=SyncSiteService.findSyncSites(getSyncAccountId());
  for (  SyncSite localSyncSite : localSyncSites) {
    if (remoteSyncSiteIds.contains(localSyncSite.getSyncSiteId())) {
      continue;
    }
    SyncSiteService.deleteSyncSite(localSyncSite.getSyncSiteId());
  }
}
