{
  final String MN="handlePortletStateChange";
  PortletContext portletContext=null;
  Portlet portlet=null;
  try {
    portlet=provider.getPortletPool().get(request.getPortletContext().getPortletHandle());
  }
 catch (  WSRPException e) {
    if (e.getErrorCode() == ErrorCodes.GET_PORTLET_FAILED) {
      WSRPXHelper.throwX(logger,Logger.ERROR,MN,ErrorCodes.INVALID_HANDLE);
    }
 else {
      WSRPXHelper.throwX(e.getErrorCode());
    }
  }
  StateChange stateChange=null;
  stateChange=request.getInteractionParams().getPortletStateChange();
  if (portlet instanceof ProducerOfferedPortlet) {
    if (stateChange.toString().equals(StateChange._readOnly)) {
      WSRPXHelper.throwX(ErrorCodes.PORTLET_STATE_CHANGE_REQUIRED);
    }
 else     if (stateChange.toString().equals(StateChange._cloneBeforeWrite)) {
      portletContext=handleCloneBeforeWrite(request);
    }
 else {
      WSRPXHelper.throwX(ErrorCodes.OPERATION_FAILED);
    }
  }
 else   if (portlet instanceof ConsumerConfiguredPortlet) {
    if (stateChange.toString().equals(StateChange._readOnly)) {
      WSRPXHelper.throwX(ErrorCodes.PORTLET_STATE_CHANGE_REQUIRED);
    }
 else     if (stateChange.toString().equals(StateChange._cloneBeforeWrite)) {
      portletContext=handleCloneBeforeWrite(request);
    }
 else {
    }
  }
 else {
    WSRPXHelper.throwX(logger,Logger.ERROR,MN,ErrorCodes.OPERATION_FAILED);
  }
  return portletContext;
}
