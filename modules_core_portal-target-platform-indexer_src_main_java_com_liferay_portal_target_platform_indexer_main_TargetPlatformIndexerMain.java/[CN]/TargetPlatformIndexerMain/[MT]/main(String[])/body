{
  String moduleFrameworkBaseDirName=System.getProperty("module.framework.base.dir");
  if (moduleFrameworkBaseDirName == null) {
    System.err.println("== -Dmodule.framework.base.dir must point to a valid " + "directory");
    return;
  }
  String moduleFrameworkModulesDirName=System.getProperty("module.framework.modules.dir");
  if (moduleFrameworkModulesDirName == null) {
    moduleFrameworkModulesDirName=moduleFrameworkBaseDirName + "/modules/";
  }
  String moduleFrameworkPortalDirName=System.getProperty("module.framework.portal.dir");
  if (moduleFrameworkPortalDirName == null) {
    moduleFrameworkPortalDirName=moduleFrameworkBaseDirName + "/portal/";
  }
  File targetPlatformDir=new File(moduleFrameworkBaseDirName,TargetPlatformIndexer.DIR_NAME_TARGET_PLATFORM);
  if (!targetPlatformDir.exists() && !targetPlatformDir.mkdirs()) {
    System.err.printf("== Unable to create directory %s\n",targetPlatformDir);
    return;
  }
  Framework framework=null;
  Path tempPath=Files.createTempDirectory(null);
  try {
    ServiceLoader<FrameworkFactory> serviceLoader=ServiceLoader.load(FrameworkFactory.class);
    FrameworkFactory frameworkFactory=serviceLoader.iterator().next();
    Map<String,String> properties=new HashMap<>();
    properties.put(org.osgi.framework.Constants.FRAMEWORK_STORAGE,tempPath.toString());
    framework=frameworkFactory.newFramework(properties);
    framework.init();
    BundleContext bundleContext=framework.getBundleContext();
    Bundle systemBundle=bundleContext.getBundle(0);
    TargetPlatformIndexer targetPlatformIndexer=new TargetPlatformIndexer(systemBundle,moduleFrameworkBaseDirName,moduleFrameworkModulesDirName,moduleFrameworkPortalDirName);
    File indexFile=targetPlatformIndexer.index(targetPlatformDir);
    System.out.println("== Wrote index file " + indexFile);
  }
  finally {
    framework.stop();
    PathUtil.deltree(tempPath);
  }
}
