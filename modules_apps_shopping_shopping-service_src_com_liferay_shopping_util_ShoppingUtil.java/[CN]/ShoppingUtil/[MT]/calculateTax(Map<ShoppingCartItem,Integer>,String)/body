{
  double tax=0.0;
  ShoppingGroupServiceSettings shoppingGroupServiceSettings=null;
  for (  Map.Entry<ShoppingCartItem,Integer> entry : items.entrySet()) {
    ShoppingCartItem cartItem=entry.getKey();
    ShoppingItem item=cartItem.getItem();
    if (shoppingGroupServiceSettings == null) {
      ShoppingCategory category=item.getCategory();
      shoppingGroupServiceSettings=getShoppingGroupServiceSettings(category.getGroupId());
      break;
    }
  }
  if ((shoppingGroupServiceSettings != null) && shoppingGroupServiceSettings.getTaxState().equals(stateId)) {
    double subtotal=0.0;
    for (    Map.Entry<ShoppingCartItem,Integer> entry : items.entrySet()) {
      ShoppingCartItem cartItem=entry.getKey();
      Integer count=entry.getValue();
      ShoppingItem item=cartItem.getItem();
      if (item.isTaxable()) {
        subtotal+=calculatePrice(item,count.intValue());
      }
    }
    tax=shoppingGroupServiceSettings.getTaxRate() * subtotal;
  }
  return tax;
}
