{
  PermissionCollection permissionCollection=null;
  if (protectionDomain == null) {
    return new Permissions();
  }
  Object key=getKey(protectionDomain);
  permissionCollection=_protectionDomainMapping.get(key);
  if (permissionCollection != null) {
    return permissionCollection;
  }
  permissionCollection=getPermissions(protectionDomain.getCodeSource());
  if (permissionCollection == null) {
    permissionCollection=new Permissions();
  }
  if (_parent != null) {
    addExtraPermissions(permissionCollection,_parent.getPermissions(protectionDomain));
  }
  addExtraPermissions(permissionCollection,protectionDomain.getPermissions());
  PACLPolicy paclPolicy=PACLPolicyManager.getPACLPolicy(protectionDomain.getClassLoader());
  if (paclPolicy == null) {
    paclPolicy=_defaultPaclPolicy;
    permissionCollection.add(_ALL_PERMISSION);
  }
  return paclPolicyToPermissionCollection(paclPolicy,permissionCollection);
}
