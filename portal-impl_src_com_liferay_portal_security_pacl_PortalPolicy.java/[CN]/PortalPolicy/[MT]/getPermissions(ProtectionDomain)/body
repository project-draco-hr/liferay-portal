{
  PermissionCollection permissionCollection=null;
  if (protectionDomain == null) {
    return new Permissions();
  }
  Object key=_getKey(protectionDomain);
  permissionCollection=_permissionCollections.get(key);
  if (permissionCollection != null) {
    return permissionCollection;
  }
  permissionCollection=getPermissions(protectionDomain.getCodeSource());
  if (permissionCollection == null) {
    permissionCollection=new Permissions();
  }
  if (_policy != null) {
    _addExtraPermissions(permissionCollection,_policy.getPermissions(protectionDomain));
  }
  _addExtraPermissions(permissionCollection,protectionDomain.getPermissions());
  PACLPolicy paclPolicy=PACLPolicyManager.getPACLPolicy(protectionDomain.getClassLoader());
  if (paclPolicy == null) {
    paclPolicy=_paclPolicy;
    permissionCollection.add(_allPermission);
  }
  return new PortalPermissionCollection(paclPolicy,permissionCollection);
}
