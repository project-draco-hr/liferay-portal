{
  if (protectionDomain == null) {
    return new Permissions();
  }
  Object key=_getKey(protectionDomain);
  PermissionCollection permissionCollection=_getPermissionCollection(key);
  if (permissionCollection != null) {
    return permissionCollection;
  }
  permissionCollection=getPermissions(protectionDomain.getCodeSource());
  if (permissionCollection == null) {
    permissionCollection=new Permissions();
  }
  if (_policy != null) {
    _addExtraPermissions(permissionCollection,_policy.getPermissions(protectionDomain));
  }
  _addExtraPermissions(permissionCollection,protectionDomain.getPermissions());
  PACLPolicy paclPolicy=PACLPolicyManager.getPACLPolicy(protectionDomain.getClassLoader());
  if (paclPolicy != null) {
    return new PortalPermissionCollection(paclPolicy,permissionCollection);
  }
  permissionCollection.add(_allPermission);
  return permissionCollection;
}
