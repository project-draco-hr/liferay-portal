{
  PortalPreferencesImpl portalPreferencesImpl=portalPreferencesWrapper.getPortalPreferencesImpl();
  int x=preferences.indexOf(_PREFIX);
  int y=-1;
  if (x != -1) {
    x+=_PREFIX.length();
    y=preferences.indexOf(_SUFFIX,x);
  }
 else {
    return;
  }
  while (x != -1) {
    String[] parts=StringUtil.split(preferences.substring(x,y),StringPool.POUND);
    long plid=GetterUtil.getLong(parts[0]);
    String key=GetterUtil.getString(parts[1]);
    if (key.startsWith(LayoutTypePortletConstants.COLUMN_PREFIX)) {
      String value=portalPreferencesImpl.getValue(namespacePlid(plid),key);
      List<String> newPortletIds=new ArrayList<>();
      try (PreparedStatement ps=connection.prepareStatement("update PortletPreferences set ownerId = ?, " + "ownerType = ?, plid = ?, portletId = ? where " + "ownerId = ? and ownerType = ? and plid = ? and "+ "portletId = ?")){
        for (        String customPortletId : StringUtil.split(value)) {
          String newPortletId=null;
          if (!PortletConstants.hasInstanceId(customPortletId)) {
            newPortletIds.add(customPortletId);
          }
 else {
            String instanceId=PortletConstants.getInstanceId(customPortletId);
            newPortletId=PortletConstants.assemblePortletId(customPortletId,ownerId,instanceId);
            ps.setLong(1,ownerId);
            ps.setInt(2,PortletKeys.PREFS_OWNER_TYPE_USER);
            ps.setLong(3,plid);
            ps.setString(4,newPortletId);
            ps.setLong(5,0L);
            ps.setInt(6,PortletKeys.PREFS_OWNER_TYPE_LAYOUT);
            ps.setLong(7,plid);
            ps.setString(8,newPortletId);
            newPortletIds.add(newPortletId);
            ps.addBatch();
          }
        }
        ps.executeBatch();
      }
       value=StringUtil.merge(newPortletIds);
      portalPreferencesImpl.setValue(namespacePlid(plid),key,value);
    }
    x=preferences.indexOf(_PREFIX,y);
    y=-1;
    if (x != -1) {
      x+=_PREFIX.length();
      y=preferences.indexOf(_SUFFIX,x);
    }
  }
}
