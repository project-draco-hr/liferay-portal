{
  ThemeDisplay themeDisplay=(ThemeDisplay)request.getAttribute(WebKeys.THEME_DISPLAY);
  if (!FacebookConnectUtil.isEnabled(themeDisplay.getCompanyId())) {
    return null;
  }
  HttpSession session=request.getSession();
  String redirect=ParamUtil.getString(request,"redirect");
  String code=ParamUtil.getString(request,"code");
  String token=getAccessToken(themeDisplay.getCompanyId(),redirect,code);
  if (Validator.isNotNull(token)) {
    session.setAttribute(WebKeys.FACEBOOK_ACCESS_TOKEN,token);
    setFacebookCredentials(session,themeDisplay.getCompanyId(),token);
  }
  if ((session.getAttribute(WebKeys.FACEBOOK_ACCESS_TOKEN) == null) || (session.getAttribute(WebKeys.FACEBOOK_USER_EMAIL_ADDRESS) == null)) {
    addUser(request,themeDisplay);
  }
  response.sendRedirect(redirect);
  return null;
}
