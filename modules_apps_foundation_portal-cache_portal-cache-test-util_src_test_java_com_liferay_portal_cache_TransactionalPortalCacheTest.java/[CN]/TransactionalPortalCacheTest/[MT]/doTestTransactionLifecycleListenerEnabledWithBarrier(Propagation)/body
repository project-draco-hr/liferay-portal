{
  setEnableTransactionalCache(true);
  Assert.assertEquals(0,getTransactionStackSize());
  TransactionLifecycleListener transactionLifecycleListener=TransactionalPortalCacheHelper.TRANSACTION_LIFECYCLE_LISTENER;
  Builder parentBuilder=new Builder();
  TransactionAttribute parentTransactionAttribute=parentBuilder.build();
  TransactionStatus parentTransactionStatus=new TestTrasactionStatus(true,false,false);
  transactionLifecycleListener.created(parentTransactionAttribute,parentTransactionStatus);
  Assert.assertEquals(1,getTransactionStackSize());
  Builder childBuilder=new Builder();
  childBuilder.setPropagation(propagation);
  TransactionAttribute childTransactionAttribute=childBuilder.build();
  TransactionStatus childTransactionStatus=new TestTrasactionStatus(true,false,false);
  transactionLifecycleListener.created(childTransactionAttribute,childTransactionStatus);
  Assert.assertEquals(0,getTransactionStackSize());
  Builder grandchildBuilder=new Builder();
  TransactionAttribute grandchildTransactionAttribute=grandchildBuilder.build();
  TransactionStatus grandchildTransactionStatus=new TestTrasactionStatus(true,false,false);
  transactionLifecycleListener.created(grandchildTransactionAttribute,grandchildTransactionStatus);
  Assert.assertEquals(1,getTransactionStackSize());
  transactionLifecycleListener.committed(grandchildTransactionAttribute,grandchildTransactionStatus);
  Assert.assertEquals(0,getTransactionStackSize());
  transactionLifecycleListener.created(grandchildTransactionAttribute,grandchildTransactionStatus);
  Assert.assertEquals(1,getTransactionStackSize());
  transactionLifecycleListener.rollbacked(grandchildTransactionAttribute,grandchildTransactionStatus,null);
  Assert.assertEquals(0,getTransactionStackSize());
  transactionLifecycleListener.committed(childTransactionAttribute,childTransactionStatus);
  Assert.assertEquals(1,getTransactionStackSize());
  transactionLifecycleListener.created(childTransactionAttribute,childTransactionStatus);
  Assert.assertEquals(0,getTransactionStackSize());
  transactionLifecycleListener.rollbacked(childTransactionAttribute,childTransactionStatus,null);
  Assert.assertEquals(1,getTransactionStackSize());
  transactionLifecycleListener.committed(parentTransactionAttribute,parentTransactionStatus);
  Assert.assertEquals(0,getTransactionStackSize());
}
