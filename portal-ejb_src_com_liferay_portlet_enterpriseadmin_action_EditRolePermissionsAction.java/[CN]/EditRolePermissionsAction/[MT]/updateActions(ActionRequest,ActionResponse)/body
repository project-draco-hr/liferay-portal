{
  ThemeDisplay themeDisplay=(ThemeDisplay)req.getAttribute(WebKeys.THEME_DISPLAY);
  String roleId=ParamUtil.getString(req,"roleId");
  String portletResource=ParamUtil.getString(req,"portletResource");
  String modelResource=ParamUtil.getString(req,"modelResource");
  String selResource=modelResource;
  if (Validator.isNull(modelResource)) {
    selResource=portletResource;
  }
  List groupScopeActionIds=new ArrayList();
  List actions=ResourceActionsUtil.getResourceActions(themeDisplay.getCompanyId(),portletResource,modelResource);
  Collections.sort(actions,new ActionComparator(themeDisplay.getCompanyId(),themeDisplay.getLocale()));
  Role role=RoleServiceUtil.getRole(roleId);
  for (int i=0; i < actions.size(); i++) {
    String actionId=(String)actions.get(i);
    String scope=ParamUtil.getString(req,"scope" + actionId);
    if (scope.equals(ResourceImpl.SCOPE_COMPANY)) {
      PermissionServiceUtil.setRolePermission(roleId,themeDisplay.getPortletGroupId(),selResource,ResourceImpl.TYPE_CLASS,scope,themeDisplay.getCompanyId(),actionId);
    }
 else     if (scope.equals(ResourceImpl.SCOPE_GROUP)) {
      if (role.getType() == RoleImpl.TYPE_COMMUNITY) {
        PermissionServiceUtil.setRolePermission(roleId,themeDisplay.getPortletGroupId(),selResource,ResourceImpl.TYPE_CLASS,ResourceImpl.SCOPE_GROUP_TEMPLATE,String.valueOf(GroupImpl.DEFAULT_PARENT_GROUP_ID),actionId);
      }
 else {
        groupScopeActionIds.add(actionId);
      }
    }
 else {
      PermissionServiceUtil.unsetRolePermissions(roleId,themeDisplay.getPortletGroupId(),selResource,ResourceImpl.TYPE_CLASS,ResourceImpl.SCOPE_COMPANY,actionId);
      PermissionServiceUtil.unsetRolePermissions(roleId,themeDisplay.getPortletGroupId(),selResource,ResourceImpl.TYPE_CLASS,ResourceImpl.SCOPE_GROUP_TEMPLATE,actionId);
      PermissionServiceUtil.unsetRolePermissions(roleId,themeDisplay.getPortletGroupId(),selResource,ResourceImpl.TYPE_CLASS,ResourceImpl.SCOPE_GROUP,actionId);
    }
  }
  String redirect=ParamUtil.getString(req,"redirect");
  if (groupScopeActionIds.size() == 0) {
    redirect+="&groupScopePos=-1";
  }
 else {
    redirect+="&groupScopePos=0&groupScopeActionIds=" + StringUtil.merge(groupScopeActionIds);
  }
  res.sendRedirect(redirect);
}
