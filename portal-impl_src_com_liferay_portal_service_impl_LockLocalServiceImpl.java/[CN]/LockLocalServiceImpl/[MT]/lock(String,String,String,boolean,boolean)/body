{
  Lock lock=lockPersistence.fetchByC_K(className,key,retrieveFromCache);
  if (lock != null) {
    if (lock.isExpired() || replaceOldLock) {
      lockPersistence.remove(lock);
      lock=null;
    }
 else     if (!lock.getOwner().equals(owner)) {
      return lock;
    }
  }
  if (lock == null) {
    long lockId=counterLocalService.increment();
    lock=lockPersistence.create(lockId);
    lock.setClassName(className);
    lock.setKey(key);
    lock.setOwner(owner);
    lock.setCreateDate(new Date());
    lockPersistence.update(lock,false);
  }
  return lock;
}
