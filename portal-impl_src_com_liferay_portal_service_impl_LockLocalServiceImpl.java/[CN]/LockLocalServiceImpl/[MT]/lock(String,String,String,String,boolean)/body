{
  Lock lock=lockPersistence.fetchByC_K(className,key,retrieveFromCache);
  if (lock != null) {
    String owner=lock.getOwner();
    if (!owner.equals(expectedOwner)) {
      return lock;
    }
    lockPersistence.remove(lock);
    lock=null;
  }
  if (lock == null) {
    long lockId=counterLocalService.increment();
    lock=lockPersistence.create(lockId);
    lock.setCreateDate(new Date());
    lock.setClassName(className);
    lock.setKey(key);
    lock.setOwner(updatedOwner);
    lockPersistence.update(lock,false);
    lock.setNew(true);
  }
  return lock;
}
