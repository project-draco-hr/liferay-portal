{
  Lock lock=lockPersistence.fetchByC_K(className,key,retrieveFromCache);
  if (lock != null) {
    String owner=lock.getOwner();
    if (lock.isExpired() || replaceOldLock) {
      if (!owner.equals(oldOwner)) {
        return lock;
      }
      lockPersistence.remove(lock);
      lock=null;
    }
 else     if (!owner.equals(newOwner)) {
      return lock;
    }
  }
  if (lock == null) {
    long lockId=counterLocalService.increment();
    lock=lockPersistence.create(lockId);
    lock.setCreateDate(new Date());
    lock.setClassName(className);
    lock.setKey(key);
    lock.setOwner(newOwner);
    lockPersistence.update(lock,false);
  }
  return lock;
}
