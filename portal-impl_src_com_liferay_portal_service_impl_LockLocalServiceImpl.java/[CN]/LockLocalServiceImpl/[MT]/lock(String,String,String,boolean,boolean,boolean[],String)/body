{
  if (isNewLock == null || isNewLock.length == 0) {
    throw new IllegalArgumentException();
  }
  Lock lock=lockPersistence.fetchByC_K(className,key,retrieveFromCache);
  if (lock != null) {
    if (lock.isExpired() || replaceOldLock) {
      if (!lock.getOwner().equals(oldOwner)) {
        return lock;
      }
      lockPersistence.remove(lock);
      lock=null;
    }
 else     if (!lock.getOwner().equals(owner)) {
      return lock;
    }
  }
  if (lock == null) {
    long lockId=counterLocalService.increment();
    lock=lockPersistence.create(lockId);
    lock.setCreateDate(new Date());
    lock.setClassName(className);
    lock.setKey(key);
    lock.setOwner(owner);
    lockPersistence.update(lock,false);
  }
  isNewLock[0]=true;
  return lock;
}
