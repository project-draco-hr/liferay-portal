{
  User user=UserUtil.findByPrimaryKey(userId);
  SCProductEntry productEntry=getProductEntry(user.getCompanyId(),productEntryId);
  productEntryId=productEntry.getProductEntryId();
  Date now=new Date();
  long productVersionId=CounterLocalServiceUtil.increment(SCProductVersion.class.getName());
  SCProductVersion productVersion=SCProductVersionUtil.create(productVersionId);
  productVersion.setCompanyId(user.getCompanyId());
  productVersion.setUserId(user.getUserId());
  productVersion.setUserName(user.getFullName());
  productVersion.setCreateDate(now);
  productVersion.setModifiedDate(now);
  productVersion.setProductEntryId(productEntryId);
  productVersion.setVersion(version);
  productVersion.setChangeLog(changeLog);
  productVersion.setDownloadPageURL(downloadPageURL);
  productVersion.setDirectDownloadURL(directDownloadURL);
  productVersion.setRepoStoreArtifact(repoStoreArtifact);
  SCProductVersionUtil.update(productVersion);
  SCProductEntryUtil.update(productEntry);
  if ((addCommunityPermissions != null) && (addGuestPermissions != null)) {
    addProductVersionResources(productEntry,productVersion,addCommunityPermissions.booleanValue(),addGuestPermissions.booleanValue());
  }
 else {
    addProductVersionResources(productEntry,productVersion,communityPermissions,guestPermissions);
  }
  SCProductVersionUtil.setSCFrameworkVersions(productEntryId,frameworkVersionIds);
  productEntry.setModifiedDate(now);
  return productVersion;
}
