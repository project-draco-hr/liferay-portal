{
  User user=userLocalService.getUserById(userId);
  Date now=new Date();
  validate(groupId,privateLayout,name);
  long layoutSetBranchId=counterLocalService.increment();
  LayoutSetBranch layoutSetBranch=layoutSetBranchPersistence.create(layoutSetBranchId);
  layoutSetBranch.setGroupId(groupId);
  layoutSetBranch.setCompanyId(user.getCompanyId());
  layoutSetBranch.setUserId(user.getUserId());
  layoutSetBranch.setUserName(user.getFullName());
  layoutSetBranch.setCreateDate(serviceContext.getCreateDate(now));
  layoutSetBranch.setModifiedDate(serviceContext.getModifiedDate(now));
  layoutSetBranch.setPrivateLayout(privateLayout);
  layoutSetBranch.setName(name);
  layoutSetBranch.setDescription(description);
  layoutSetBranchPersistence.update(layoutSetBranch,false);
  resourceLocalService.addResources(user.getCompanyId(),layoutSetBranch.getGroupId(),user.getUserId(),LayoutSetBranch.class.getName(),layoutSetBranch.getLayoutSetBranchId(),false,true,false);
  if (layoutSetBranch.isMaster()) {
    List<Layout> layouts=layoutPersistence.findByG_P(layoutSetBranch.getGroupId(),layoutSetBranch.getPrivateLayout());
    for (    Layout layout : layouts) {
      layoutRevisionLocalService.addLayoutRevision(userId,layoutSetBranchId,LayoutRevisionConstants.DEFAULT_PARENT_LAYOUT_REVISION_ID,true,LayoutRevisionConstants.DEFAULT_LAYOUT_VARIATION_NAME,layout.getPlid(),layout.getPrivateLayout(),layout.getName(),layout.getTitle(),layout.getDescription(),layout.getKeywords(),layout.getRobots(),layout.getTypeSettings(),layout.isIconImage(),layout.getIconImageId(),layout.getThemeId(),layout.getColorSchemeId(),layout.getWapThemeId(),layout.getWapColorSchemeId(),layout.getCss(),serviceContext);
    }
  }
  return layoutSetBranch;
}
