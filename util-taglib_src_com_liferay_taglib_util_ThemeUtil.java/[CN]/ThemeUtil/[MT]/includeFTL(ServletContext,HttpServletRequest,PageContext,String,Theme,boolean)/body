{
  String servletContextName=GetterUtil.getString(theme.getServletContextName());
  if (ServletContextPool.get(servletContextName) == null) {
    ServletContextPool.put(servletContextName,servletContext);
  }
  int pos=page.lastIndexOf(StringPool.PERIOD);
  StringBundler sb=new StringBundler(7);
  sb.append(servletContextName);
  sb.append(theme.getFreeMarkerTemplateLoader());
  sb.append(theme.getTemplatesPath());
  sb.append(StringPool.SLASH);
  sb.append(page.substring(0,pos));
  sb.append(StringPool.PERIOD);
  sb.append(_TEMPLATE_EXTENSION_FTL);
  String source=sb.toString();
  if (!FreeMarkerEngineUtil.resourceExists(source)) {
    _log.error(source + " does not exist");
    return null;
  }
  FreeMarkerContext freeMarkerContext=FreeMarkerEngineUtil.getWrappedStandardToolsContext();
  FreeMarkerVariables.insertVariables(freeMarkerContext,request);
  ServletContext themeServletContext=ServletContextPool.get(servletContextName);
  freeMarkerContext.put("themeServletContext",themeServletContext);
  HttpServletResponse response=(HttpServletResponse)pageContext.getResponse();
  Writer writer=null;
  if (write) {
    writer=new UnsyncPrintWriter(pageContext.getOut());
  }
 else {
    writer=new UnsyncStringWriter();
  }
  VelocityTaglib velocityTaglib=new VelocityTaglib(servletContext,request,new PipingServletResponse(response,writer),pageContext);
  request.setAttribute(WebKeys.VELOCITY_TAGLIB,velocityTaglib);
  freeMarkerContext.put("taglibLiferay",velocityTaglib);
  freeMarkerContext.put("theme",velocityTaglib);
  TaglibFactory portalTaglib=new TaglibFactory(servletContext);
  freeMarkerContext.put("PortalJspTagLibs",portalTaglib);
  TaglibFactory themeTaglib=new TaglibFactory(themeServletContext);
  freeMarkerContext.put("ThemeJspTaglibs",themeTaglib);
  HttpRequestHashModel httpRequestHashModel=new HttpRequestHashModel(request,response,ObjectWrapper.DEFAULT_WRAPPER);
  ServletContextHashModel servletContextHashModel=new ServletContextHashModel((GenericServlet)pageContext.getPage(),ObjectWrapper.DEFAULT_WRAPPER);
  freeMarkerContext.put("Application",servletContextHashModel);
  freeMarkerContext.put("Request",httpRequestHashModel);
  FreeMarkerEngineUtil.mergeTemplate(source,freeMarkerContext,writer);
  if (write) {
    return null;
  }
 else {
    return ((UnsyncStringWriter)writer).toString();
  }
}
