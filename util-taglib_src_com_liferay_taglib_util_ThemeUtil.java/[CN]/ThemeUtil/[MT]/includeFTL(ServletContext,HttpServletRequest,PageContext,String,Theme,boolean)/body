{
  String servletContextName=GetterUtil.getString(theme.getServletContextName());
  if (ServletContextPool.get(servletContextName) == null) {
    ServletContextPool.put(servletContextName,servletContext);
  }
  String portletId=getPortletId(request);
  String resourcePath=theme.getResourcePath(servletContext,portletId,path);
  if (Validator.isNotNull(portletId) && !TemplateManagerUtil.hasTemplate(TemplateManager.FREEMARKER,resourcePath) && portletId.contains(PortletConstants.INSTANCE_SEPARATOR)) {
    String rootPortletId=PortletConstants.getRootPortletId(portletId);
    resourcePath=theme.getResourcePath(servletContext,rootPortletId,path);
  }
  if (Validator.isNotNull(portletId) && !TemplateManagerUtil.hasTemplate(TemplateManager.FREEMARKER,resourcePath)) {
    resourcePath=theme.getResourcePath(servletContext,null,path);
  }
  if (!TemplateManagerUtil.hasTemplate(TemplateManager.FREEMARKER,resourcePath)) {
    _log.error(resourcePath + " does not exist");
    return null;
  }
  Template template=TemplateManagerUtil.getTemplate(TemplateManager.FREEMARKER,resourcePath,TemplateContextType.STANDARD);
  template.prepare(request);
  ServletContext themeServletContext=ServletContextPool.get(servletContextName);
  template.put("themeServletContext",themeServletContext);
  HttpServletResponse response=(HttpServletResponse)pageContext.getResponse();
  Writer writer=null;
  if (write) {
    writer=UnsyncPrintWriterPool.borrow(pageContext.getOut());
  }
 else {
    writer=new UnsyncStringWriter();
  }
  VelocityTaglib velocityTaglib=new VelocityTaglib(servletContext,request,new PipingServletResponse(response,writer),pageContext);
  template.put("taglibLiferay",velocityTaglib);
  template.put("theme",velocityTaglib);
  template.put("writer",writer);
  TemplateHashModel portalTaglib=FreeMarkerTaglibFactoryUtil.createTaglibFactory(servletContext);
  template.put("PortalJspTagLibs",portalTaglib);
  TemplateHashModel themeTaglib=FreeMarkerTaglibFactoryUtil.createTaglibFactory(themeServletContext);
  template.put("ThemeJspTaglibs",themeTaglib);
  final Servlet servlet=(Servlet)pageContext.getPage();
  GenericServlet genericServlet=null;
  if (servlet instanceof GenericServlet) {
    genericServlet=(GenericServlet)servlet;
  }
 else {
    genericServlet=new GenericServlet(){
      @Override public void service(      ServletRequest servletRequest,      ServletResponse servletResponse) throws ServletException, IOException {
        servlet.service(servletRequest,servletResponse);
      }
    }
;
    genericServlet.init(pageContext.getServletConfig());
  }
  ServletContextHashModel servletContextHashModel=new ServletContextHashModel(genericServlet,ObjectWrapper.DEFAULT_WRAPPER);
  template.put("Application",servletContextHashModel);
  request.setAttribute(WebKeys.VELOCITY_TAGLIB,velocityTaglib);
  HttpRequestHashModel httpRequestHashModel=new HttpRequestHashModel(request,response,ObjectWrapper.DEFAULT_WRAPPER);
  template.put("Request",httpRequestHashModel);
  try {
    template.processTemplate(writer);
  }
  finally {
    request.removeAttribute(WebKeys.VELOCITY_TAGLIB);
  }
  if (write) {
    return null;
  }
 else {
    return writer.toString();
  }
}
