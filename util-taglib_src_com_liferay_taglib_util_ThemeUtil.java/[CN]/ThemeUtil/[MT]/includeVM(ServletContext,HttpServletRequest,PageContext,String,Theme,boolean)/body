{
  String ctxName=GetterUtil.getString(theme.getServletContextName());
  if (VelocityContextPool.get(ctxName) == null) {
    VelocityContextPool.put(ctxName,servletContext);
  }
  int pos=page.lastIndexOf(StringPool.PERIOD);
  StringBundler sb=new StringBundler(7);
  sb.append(ctxName);
  sb.append(theme.getVelocityResourceListener());
  sb.append(theme.getTemplatesPath());
  sb.append(StringPool.SLASH);
  sb.append(page.substring(0,pos));
  sb.append(StringPool.PERIOD);
  sb.append(_TEMPLATE_EXTENSION_VM);
  String source=sb.toString();
  if (!VelocityEngineUtil.resourceExists(source)) {
    _log.error(source + " does not exist");
    return null;
  }
  Writer writer=null;
  if (write) {
    writer=pageContext.getOut();
  }
 else {
    writer=new UnsyncStringWriter(true);
  }
  VelocityContext velocityContext=VelocityEngineUtil.getWrappedStandardToolsContext();
  VelocityVariables.insertVariables(velocityContext,request);
  ServletContext themeServletContext=VelocityContextPool.get(ctxName);
  PipingServletResponse pipingResponse=new PipingServletResponse((HttpServletResponse)pageContext.getResponse(),writer);
  VelocityTaglib velocityTaglib=new VelocityTaglib(servletContext,request,pipingResponse,pageContext);
  request.setAttribute(WebKeys.VELOCITY_TAGLIB,velocityTaglib);
  velocityContext.put("themeServletContext",themeServletContext);
  velocityContext.put("taglibLiferay",velocityTaglib);
  velocityContext.put("theme",velocityTaglib);
  VelocityEngineUtil.mergeTemplate(source,velocityContext,writer);
  if (write) {
    return null;
  }
 else {
    return ((UnsyncStringWriter)writer).toString();
  }
}
