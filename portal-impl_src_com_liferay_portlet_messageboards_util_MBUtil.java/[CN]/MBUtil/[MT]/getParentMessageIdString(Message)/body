{
  String parentHeader=null;
  String[] references=message.getHeader("References");
  if ((references != null) && (references.length > 0)) {
    int beginIndex=references[0].indexOf("<mb.");
    int endIndex;
    if (beginIndex > -1) {
      endIndex=references[0].indexOf(">",beginIndex);
      parentHeader=references[0].substring(beginIndex,endIndex);
    }
  }
  if (parentHeader == null) {
    String[] inReplyToHeaders=message.getHeader("In-Reply-To");
    if ((inReplyToHeaders != null) && (inReplyToHeaders.length > 0)) {
      parentHeader=inReplyToHeaders[0];
    }
  }
  if (Validator.isNull(parentHeader) || !parentHeader.startsWith(POP_PORTLET_PREFIX,1)) {
    parentHeader=_getParentMessageIdFromSubject(message);
  }
  return parentHeader;
}
