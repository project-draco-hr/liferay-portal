{
  String parentHeader=null;
  String[] references=message.getHeader("References");
  if (ArrayUtil.isNotEmpty(references)) {
    String reference=references[0];
    int x=reference.lastIndexOf(StringPool.LESS_THAN + MESSAGE_POP_PORTLET_PREFIX);
    if (x > -1) {
      int y=reference.indexOf(StringPool.GREATER_THAN,x);
      parentHeader=reference.substring(x,y + 1);
    }
  }
  if (parentHeader == null) {
    String[] inReplyToHeaders=message.getHeader("In-Reply-To");
    if (ArrayUtil.isNotEmpty(inReplyToHeaders)) {
      parentHeader=inReplyToHeaders[0];
    }
  }
  if (Validator.isNull(parentHeader) || !parentHeader.startsWith(MESSAGE_POP_PORTLET_PREFIX,1)) {
    parentHeader=_getParentMessageIdFromSubject(message);
  }
  return parentHeader;
}
