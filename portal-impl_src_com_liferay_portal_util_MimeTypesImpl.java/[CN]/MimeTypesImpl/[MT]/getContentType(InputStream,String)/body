{
  if (inputStream == null) {
    return getContentType(fileName);
  }
  String contentType=null;
  TikaInputStream tikaInputStream=null;
  try {
    tikaInputStream=TikaInputStream.get(new CloseShieldInputStream(inputStream));
    Metadata metadata=new Metadata();
    metadata.set(Metadata.RESOURCE_NAME_KEY,fileName);
    MediaType mediaType=_detector.detect(tikaInputStream,metadata);
    contentType=mediaType.toString();
    if (contentType.contains("tika")) {
      if (_log.isDebugEnabled()) {
        _log.debug("Retrieved invalid content type " + contentType);
      }
      contentType=getContentType(fileName);
    }
    if (contentType.contains("tika")) {
      if (_log.isDebugEnabled()) {
        _log.debug("Retrieved invalid content type " + contentType);
      }
      contentType=ContentTypes.APPLICATION_OCTET_STREAM;
    }
  }
 catch (  Exception e) {
    _log.error(e,e);
    contentType=ContentTypes.APPLICATION_OCTET_STREAM;
  }
 finally {
    StreamUtil.cleanUp(tikaInputStream);
  }
  return contentType;
}
