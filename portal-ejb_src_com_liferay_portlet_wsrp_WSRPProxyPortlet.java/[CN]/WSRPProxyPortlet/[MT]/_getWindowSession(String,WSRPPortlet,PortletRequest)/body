{
  PortletKey portletKey=portlet.getPortletKey();
  javax.portlet.PortletSession jsrPortletSession=request.getPortletSession();
  _getProducer(portletKey.getProducerId());
  UserSession userSession=null;
synchronized (_sessionHdlrLock) {
    SessionHandler sessionHandler=(SessionHandler)_consumerEnv.getSessionHandler();
    sessionHandler.setPortletSession(jsrPortletSession);
    userSession=sessionHandler.getUserSession(portletKey.getProducerId(),userID);
  }
  if (userSession != null) {
    String groupID=_getPortletDescription(portlet).getGroupID();
    groupID=groupID == null ? "default" : groupID;
    GroupSession groupSession=userSession.getGroupSession(groupID);
    if (groupSession != null) {
      String handle=_portletConfig.getPortletName();
      PortletSession portletSession=groupSession.getPortletSession(handle);
      int sessionScope=javax.portlet.PortletSession.PORTLET_SCOPE;
      boolean clearSessionCtx=GetterUtil.get((String)jsrPortletSession.getAttribute(WebKeys.WSRP_NEW_SESSION,sessionScope),false);
      if (clearSessionCtx) {
        portletSession.setSessionContext(null);
        jsrPortletSession.setAttribute(WebKeys.WSRP_NEW_SESSION,"false");
      }
      if (portletSession != null) {
        PortletWindowSession windowSession=portletSession.getPortletWindowSession(handle);
        return windowSession;
      }
 else {
        WSRPXHelper.throwX(ErrorCodes.PORTLET_SESSION_NOT_FOUND);
      }
    }
 else {
      WSRPXHelper.throwX(ErrorCodes.GROUP_SESSION_NOT_FOUND);
    }
  }
 else {
    WSRPXHelper.throwX(ErrorCodes.USER_SESSION_NOT_FOUND);
  }
  return null;
}
