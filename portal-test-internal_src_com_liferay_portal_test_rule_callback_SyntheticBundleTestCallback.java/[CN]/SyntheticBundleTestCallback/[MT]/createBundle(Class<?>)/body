{
  Builder builder=new Builder();
  builder.setBundleSymbolicName(clazz.getName());
  try {
    URL url=clazz.getResource("");
    String protocol=url.getProtocol();
    if (!protocol.equals("file")) {
      throw new IllegalStateException("Test classes are not on the file system");
    }
    String basePath=url.getPath();
    Package pkg=clazz.getPackage();
    String packageName=pkg.getName();
    int index=basePath.indexOf(packageName.replace('.','/') + '/');
    basePath=basePath.substring(0,index);
    File baseDir=new File(basePath);
    builder.setBase(baseDir);
    builder.setClasspath(new File[]{baseDir});
    builder.setProperty("bundle.package",packageName + "." + _bundlePackageName);
    Properties properties=builder.getProperties();
    try (InputStream inputStream=clazz.getResourceAsStream(_bundlePackageName.replace('.','/') + "/bnd.bnd")){
      properties.load(inputStream);
      Jar jar=builder.build();
      UnsyncByteArrayOutputStream outputStream=new UnsyncByteArrayOutputStream();
      jar.write(outputStream);
      return new UnsyncByteArrayInputStream(outputStream.toByteArray());
    }
   }
  finally {
    builder.close();
  }
}
