{
  Builder builder=new Builder();
  builder.setBundleSymbolicName(clazz.getName());
  try {
    URL url=clazz.getResource("");
    if (!url.getProtocol().equals("file")) {
      throw new IllegalStateException("This only works from test classes which are on the " + "file system.");
    }
    Package packageObject=clazz.getPackage();
    String packageName=packageObject.getName();
    String packagePath=packageName.replace('.','/') + '/';
    String basePath=url.getPath();
    int index=basePath.indexOf(packagePath);
    basePath=basePath.substring(0,index);
    File base=new File(basePath);
    builder.setBase(base);
    builder.setClasspath(new File[]{base});
    InputStream inputStream=clazz.getResourceAsStream(_bundlePackage.replace('.','/') + "/bnd.bnd");
    builder.setProperty("bundle.package",packageName + "." + _bundlePackage);
    Properties properties=builder.getProperties();
    properties.load(inputStream);
    Jar jar=builder.build();
    UnsyncByteArrayOutputStream outputStream=new UnsyncByteArrayOutputStream();
    jar.write(outputStream);
    inputStream=new UnsyncByteArrayInputStream(outputStream.toByteArray());
    return inputStream;
  }
  finally {
    builder.close();
  }
}
