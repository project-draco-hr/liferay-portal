{
  ThemeDisplay themeDisplay=(ThemeDisplay)request.getAttribute(WebKeys.THEME_DISPLAY);
  if (!PropsValues.SETUP_WIZARD_ENABLED) {
    response.sendRedirect(themeDisplay.getPathMain());
  }
  String cmd=ParamUtil.getString(request,Constants.CMD);
  if (Validator.isNull(cmd)) {
    return mapping.findForward("portal.setup_wizard");
  }
  try {
    if (cmd.equals(Constants.TRANSLATE)) {
      SetupWizardUtil.processPortalLanguage(request,response);
      return mapping.findForward("portal.setup_wizard");
    }
 else     if (cmd.equals(Constants.TEST)) {
      JSONObject jsonObject=JSONFactoryUtil.createJSONObject();
      try {
        SetupWizardUtil.testDatabase(request);
        jsonObject.put("success",Boolean.TRUE);
        jsonObject.put("message",LanguageUtil.get(themeDisplay.getLocale(),"database-connection-has-been-established-" + "sucessfully"));
      }
 catch (      ClassNotFoundException cnfe) {
        jsonObject.put("message",LanguageUtil.format(themeDisplay.getLocale(),"database-driver-x-is-not-present",cnfe.getLocalizedMessage()));
      }
catch (      SQLException sqle) {
        jsonObject.put("message",LanguageUtil.get(themeDisplay.getLocale(),"database-connection-has-not-been-established"));
      }
      response.setContentType(ContentTypes.TEXT_JAVASCRIPT);
      response.setHeader(HttpHeaders.CACHE_CONTROL,HttpHeaders.CACHE_CONTROL_NO_CACHE_VALUE);
      ServletResponseUtil.write(response,jsonObject.toString());
      return null;
    }
 else     if (cmd.equals(Constants.UPDATE)) {
      SetupWizardUtil.processSetup(request,response);
    }
    response.sendRedirect(themeDisplay.getPathMain() + "/portal/setup_wizard");
    return null;
  }
 catch (  Exception e) {
    if (e instanceof PrincipalException) {
      SessionErrors.add(request,e.getClass().getName());
      return mapping.findForward("portal.setup_wizard");
    }
 else {
      PortalUtil.sendError(e,request,response);
      return null;
    }
  }
}
