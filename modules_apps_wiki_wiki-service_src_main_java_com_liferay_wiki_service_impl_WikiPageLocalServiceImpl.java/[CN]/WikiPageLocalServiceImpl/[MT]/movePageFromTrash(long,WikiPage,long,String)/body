{
  String trashTitle=page.getTitle();
  String originalTitle=TrashUtil.getOriginalTitle(trashTitle);
  long oldNodeId=page.getNodeId();
  if (newNodeId == 0) {
    newNodeId=oldNodeId;
  }
  List<WikiPage> pageVersions=wikiPagePersistence.findByR_N_H(page.getResourcePrimKey(),oldNodeId,false);
  for (  WikiPage pageVersion : pageVersions) {
    pageVersion.setParentTitle(newParentTitle);
    pageVersion.setNodeId(newNodeId);
    pageVersion.setTitle(originalTitle);
    wikiPagePersistence.update(pageVersion);
  }
  WikiPageResource pageResource=wikiPageResourcePersistence.fetchByPrimaryKey(page.getResourcePrimKey());
  pageResource.setNodeId(newNodeId);
  pageResource.setTitle(originalTitle);
  wikiPageResourcePersistence.update(pageResource);
  page.setNodeId(newNodeId);
  page.setTitle(originalTitle);
  WikiPage parentPage=page.getParentPage();
  if ((parentPage != null) && parentPage.isInTrash()) {
    page.setParentTitle(StringPool.BLANK);
  }
  if (Validator.isNotNull(newParentTitle)) {
    WikiPage newParentPage=getPage(newNodeId,newParentTitle);
    if (!newParentPage.isInTrash()) {
      page.setParentTitle(newParentTitle);
    }
  }
  WikiPage redirectPage=page.getRedirectPage();
  if ((redirectPage != null) && redirectPage.isInTrash()) {
    page.setRedirectTitle(StringPool.BLANK);
  }
  wikiPagePersistence.update(page);
  TrashEntry trashEntry=trashEntryLocalService.getEntry(WikiPage.class.getName(),page.getResourcePrimKey());
  updateStatus(userId,page,trashEntry.getStatus(),new ServiceContext(),new HashMap<String,Serializable>());
  for (  FileEntry fileEntry : page.getAttachmentsFileEntries()) {
    PortletFileRepositoryUtil.restorePortletFileEntryFromTrash(userId,fileEntry.getFileEntryId());
  }
  moveDependentChildPagesFromTrash(page,oldNodeId,trashTitle);
  moveDependentRedirectorPagesFromTrash(page,oldNodeId,trashTitle);
  List<TrashVersion> trashVersions=trashVersionLocalService.getVersions(trashEntry.getEntryId());
  for (  TrashVersion trashVersion : trashVersions) {
    WikiPage trashArticleVersion=wikiPagePersistence.findByPrimaryKey(trashVersion.getClassPK());
    trashArticleVersion.setStatus(trashVersion.getStatus());
    wikiPagePersistence.update(trashArticleVersion);
  }
  trashEntryLocalService.deleteEntry(WikiPage.class.getName(),page.getResourcePrimKey());
  CommentManagerUtil.restoreDiscussionFromTrash(WikiPage.class.getName(),page.getResourcePrimKey());
  JSONObject extraDataJSONObject=JSONFactoryUtil.createJSONObject();
  extraDataJSONObject.put("title",page.getTitle());
  extraDataJSONObject.put("version",page.getVersion());
  SocialActivityManagerUtil.addActivity(userId,page,SocialActivityConstants.TYPE_RESTORE_FROM_TRASH,extraDataJSONObject.toString(),0);
  if (!pageVersions.isEmpty()) {
    Indexer<WikiPage> indexer=IndexerRegistryUtil.nullSafeGetIndexer(WikiPage.class);
    for (    WikiPage pageVersion : pageVersions) {
      indexer.reindex(pageVersion);
    }
  }
}
