{
  if (response instanceof BufferCacheServletResponse) {
    BufferCacheServletResponse bufferCacheServletResponse=(BufferCacheServletResponse)response;
    ByteBuffer byteBuffer=ByteBuffer.wrap(FileUtil.getBytes(file));
    bufferCacheServletResponse.setByteBuffer(byteBuffer);
  }
 else {
    FileInputStream fileInputStream=new FileInputStream(file);
    FileChannel fileChannel=fileInputStream.getChannel();
    try {
      int contentLength=(int)fileChannel.size();
      response.setContentLength(contentLength);
      response.flushBuffer();
      fileChannel.transferTo(0,contentLength,Channels.newChannel(response.getOutputStream()));
    }
  finally {
      fileChannel.close();
      fileInputStream.close();
    }
  }
}
