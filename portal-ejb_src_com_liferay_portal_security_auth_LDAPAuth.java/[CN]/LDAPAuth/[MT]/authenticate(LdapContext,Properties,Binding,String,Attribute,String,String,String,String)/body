{
  if (userPassword != null) {
    String ldapPassword=new String((byte[])userPassword.get());
    String encryptedPassword=password;
    String algorithm=PrefsPropsUtil.getString(companyId,PropsUtil.AUTH_IMPL_LDAP_PASSWORD_ENCRYPTION_ALGORITHM);
    if (Validator.isNotNull(algorithm)) {
      encryptedPassword="{" + algorithm + "}"+ Encryptor.digest(algorithm,password);
    }
    if (!ldapPassword.equals(encryptedPassword)) {
      _log.error("LDAP password " + ldapPassword + " does not match with given password "+ encryptedPassword+ " for user id "+ userId);
      return false;
    }
  }
 else {
    try {
      String userDN=binding.getName() + StringPool.COMMA + baseDN;
      env.put(Context.SECURITY_PRINCIPAL,userDN);
      env.put(Context.SECURITY_CREDENTIALS,password);
      ctx=new InitialLdapContext(env,null);
    }
 catch (    Exception e) {
      _log.error("Failed to bind to the LDAP server with " + userId + " "+ password,e);
      return false;
    }
  }
  return true;
}
