{
  boolean enabled=PrefsPropsUtil.getBoolean(companyId,PropsUtil.AUTH_IMPL_LDAP_ENABLED);
  if (!enabled) {
    if (_log.isDebugEnabled()) {
      _log.debug("Authenticator is not enabled");
    }
    return SUCCESS;
  }
  if (_log.isDebugEnabled()) {
    _log.debug("Authenticator is enabled");
  }
  Properties env=new Properties();
  String providerURL=PrefsPropsUtil.getString(companyId,PropsUtil.AUTH_IMPL_LDAP_PROVIDER_URL);
  String ldapContext=PrefsPropsUtil.getString(companyId,PropsUtil.AUTH_IMPL_LDAP_CONTEXT);
  env.put(Context.INITIAL_CONTEXT_FACTORY,PrefsPropsUtil.getString(companyId,PropsUtil.AUTH_IMPL_LDAP_FACTORY_INITIAL));
  env.put(Context.PROVIDER_URL,providerURL + StringPool.SLASH + ldapContext);
  env.put(Context.SECURITY_PRINCIPAL,PrefsPropsUtil.getString(companyId,PropsUtil.AUTH_IMPL_LDAP_SECURITY_PRINCIPAL));
  env.put(Context.SECURITY_CREDENTIALS,PrefsPropsUtil.getString(companyId,PropsUtil.AUTH_IMPL_LDAP_SECURITY_CREDENTIALS));
  if (_log.isDebugEnabled()) {
    StringWriter sw=new StringWriter();
    env.list(new PrintWriter(sw));
    _log.debug(sw.getBuffer().toString());
  }
  LdapContext ctx=null;
  try {
    ctx=new InitialLdapContext(env,null);
  }
 catch (  Exception e) {
    if (_log.isDebugEnabled()) {
      _log.debug("Failed to bind to the LDAP server");
    }
    return SUCCESS;
  }
  String filter=PrefsPropsUtil.getString(companyId,PropsUtil.AUTH_IMPL_LDAP_SEARCH_FILTER);
  if (_log.isDebugEnabled()) {
    _log.debug("Search filter before transformation " + filter);
  }
  filter=StringUtil.replace(filter,new String[]{"@company_id@","@email_address@","@user_id@"},new String[]{companyId,emailAddress,userId});
  if (_log.isDebugEnabled()) {
    _log.debug("Search filter after transformation " + filter);
  }
  SearchControls cons=new SearchControls(SearchControls.SUBTREE_SCOPE,1,0,null,false,false);
  NamingEnumeration enu=ctx.search(StringPool.BLANK,filter,cons);
  if (enu.hasMore()) {
    if (_log.isDebugEnabled()) {
      _log.debug("Search filter returned at least one result");
    }
    Binding binding=(Binding)enu.next();
    Attributes attrs=ctx.getAttributes(binding.getName());
    Properties userMappings=PropertiesUtil.load(PrefsPropsUtil.getString(companyId,PropsUtil.AUTH_IMPL_LDAP_USER_MAPPINGS));
    if (_log.isDebugEnabled()) {
      StringWriter sw=new StringWriter();
      userMappings.list(new PrintWriter(sw));
      _log.debug(sw.getBuffer().toString());
    }
    String creatorUserId=null;
    boolean autoUserId=false;
    if (Validator.isNull(userId)) {
      userId=LDAPUtil.getAttributeValue(attrs,userMappings.getProperty("userId"));
    }
    boolean autoPassword=false;
    String password1=password;
    String password2=password;
    boolean passwordReset=false;
    if (Validator.isNull(emailAddress)) {
      emailAddress=LDAPUtil.getAttributeValue(attrs,userMappings.getProperty("emailAddress"));
    }
    Locale locale=Locale.US;
    String firstName=LDAPUtil.getAttributeValue(attrs,userMappings.getProperty("firstName"));
    String middleName=LDAPUtil.getAttributeValue(attrs,userMappings.getProperty("middleName"));
    String lastName=LDAPUtil.getAttributeValue(attrs,userMappings.getProperty("lastName"));
    if (Validator.isNull(firstName) || Validator.isNull(lastName)) {
      String fullName=LDAPUtil.getAttributeValue(attrs,userMappings.getProperty("fullName"));
      String[] names=LDAPUtil.splitFullName(fullName);
      firstName=names[0];
      middleName=names[1];
      lastName=names[2];
    }
    String nickName=null;
    String prefixId=null;
    String suffixId=null;
    boolean male=true;
    int birthdayMonth=Calendar.JANUARY;
    int birthdayDay=1;
    int birthdayYear=1970;
    String jobTitle=LDAPUtil.getAttributeValue(attrs,userMappings.getProperty("jobTitle"));
    String organizationId=null;
    String locationId=null;
    boolean sendEmail=false;
    Attribute userPassword=attrs.get("userPassword");
    if (userPassword != null) {
      String ldapPassword=new String((byte[])userPassword.get());
      String encryptedPassword=password;
      String algorithm=PrefsPropsUtil.getString(companyId,PropsUtil.AUTH_IMPL_LDAP_PASSWORD_ENCRYPTION_ALGORITHM);
      if (Validator.isNotNull(algorithm)) {
        encryptedPassword="{" + algorithm + "}"+ Encryptor.digest(algorithm,password);
      }
      if (!ldapPassword.equals(encryptedPassword)) {
        _log.error("LDAP password " + ldapPassword + " does not match with given password "+ encryptedPassword+ " for user id "+ userId);
        return FAILURE;
      }
    }
 else {
      try {
        env.put(Context.SECURITY_PRINCIPAL,userId);
        env.put(Context.SECURITY_CREDENTIALS,password);
        ctx=new InitialLdapContext(env,null);
      }
 catch (      Exception e) {
        _log.error("Failed to bind to the LDAP server with " + userId + " "+ password,e);
        return FAILURE;
      }
    }
    LDAPImportUtil.addOrUpdateUser(creatorUserId,companyId,autoUserId,userId,autoPassword,password1,password2,passwordReset,emailAddress,locale,firstName,middleName,lastName,nickName,prefixId,suffixId,male,birthdayMonth,birthdayDay,birthdayYear,jobTitle,organizationId,locationId,sendEmail,true,false);
  }
 else {
    if (_log.isDebugEnabled()) {
      _log.debug("Search filter did not return any results");
    }
    if (PrefsPropsUtil.getBoolean(companyId,PropsUtil.AUTH_IMPL_LDAP_REQUIRED)) {
      if (Validator.isNotNull(userId)) {
        if (OmniadminUtil.isOmniadmin(userId)) {
          return SUCCESS;
        }
      }
 else       if (Validator.isNotNull(emailAddress)) {
        try {
          User user=UserLocalServiceUtil.getUserByEmailAddress(companyId,emailAddress);
          if (OmniadminUtil.isOmniadmin(user.getUserId())) {
            return SUCCESS;
          }
        }
 catch (        NoSuchUserException nsue) {
        }
      }
      return DNE;
    }
  }
  return SUCCESS;
}
