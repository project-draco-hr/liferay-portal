{
  if (reader == null) {
    throw new IOException("Reader closed");
  }
  if (len <= 0) {
    return 0;
  }
  int readNumber=0;
  while (true) {
    int inBufferAvailable=firstInvalidIndex - index;
    if ((inBufferAvailable + readNumber) >= len) {
      int leftSize=len - readNumber;
      System.arraycopy(buffer,index,b,readNumber,leftSize);
      index+=leftSize;
      return len;
    }
    if (inBufferAvailable <= 0) {
      readUnderlyingReader();
      inBufferAvailable=firstInvalidIndex - index;
      if (inBufferAvailable <= 0) {
        return readNumber == 0 ? -1 : readNumber;
      }
    }
 else {
      System.arraycopy(buffer,index,b,readNumber,inBufferAvailable);
      index+=inBufferAvailable;
      readNumber+=inBufferAvailable;
    }
  }
}
