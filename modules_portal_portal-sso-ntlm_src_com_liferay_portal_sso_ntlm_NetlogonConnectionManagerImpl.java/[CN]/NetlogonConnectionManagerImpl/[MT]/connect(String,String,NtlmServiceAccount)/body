{
  NtlmPasswordAuthentication ntlmPasswordAuthentication=new NtlmPasswordAuthentication(null,ntlmServiceAccount.getAccount(),ntlmServiceAccount.getPassword());
  String endpoint="ncacn_np:" + domainController + "[\\PIPE\\NETLOGON]";
  DcerpcHandle dcerpcHandle=DcerpcHandle.getHandle(endpoint,ntlmPasswordAuthentication);
  dcerpcHandle.bind();
  byte[] clientChallenge=new byte[8];
  BigEndianCodec.putLong(clientChallenge,0,SecureRandomUtil.nextLong());
  NetrServerReqChallenge netrServerReqChallenge=new NetrServerReqChallenge(domainControllerName,ntlmServiceAccount.getComputerName(),clientChallenge,new byte[8]);
  dcerpcHandle.sendrecv(netrServerReqChallenge);
  MD4 md4=new MD4();
  md4.update(ntlmServiceAccount.getPassword().getBytes("UTF-16LE"));
  byte[] sessionKey=computeSessionKey(md4.digest(),clientChallenge,netrServerReqChallenge.getServerChallenge());
  byte[] clientCredential=NetlogonCredentialUtil.computeNetlogonCredential(clientChallenge,sessionKey);
  long companyId=CompanyThreadLocal.getCompanyId();
  int negotiateFlags=0x600FFFFF;
  try {
    NtlmConfiguration ntlmConfiguration=_settingsFactory.getSettings(NtlmConfiguration.class,new CompanyServiceSettingsLocator(companyId,NtlmConstants.SERVICE_NAME));
    String negotiateFlagsString=ntlmConfiguration.negotiateFlags();
    if (negotiateFlagsString.startsWith("0x")) {
      negotiateFlags=Integer.valueOf(negotiateFlagsString.substring(2),16);
    }
  }
 catch (  SettingsException se) {
    _log.error("Unable to get Ntlm settings",se);
  }
  NetrServerAuthenticate3 netrServerAuthenticate3=new NetrServerAuthenticate3(domainControllerName,ntlmServiceAccount.getAccountName(),2,ntlmServiceAccount.getComputerName(),clientCredential,new byte[8],negotiateFlags);
  dcerpcHandle.sendrecv(netrServerAuthenticate3);
  byte[] serverCredential=NetlogonCredentialUtil.computeNetlogonCredential(netrServerReqChallenge.getServerChallenge(),sessionKey);
  if (!Arrays.equals(serverCredential,netrServerAuthenticate3.getServerCredential())) {
    throw new NtlmLogonException("Session key negotiation failed");
  }
  NetlogonConnection netLogonConnection=new NetlogonConnection(clientCredential,sessionKey);
  netLogonConnection.setDcerpcHandle(dcerpcHandle);
  return netLogonConnection;
}
