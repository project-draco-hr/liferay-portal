{
  String path=request.getRequestURI();
  String themeId=ParamUtil.getString(request,"themeId");
  long plid=ParamUtil.getLong(request,"plid");
  if (plid <= 0) {
    plid=ParamUtil.getLong(request,"p_l_id");
  }
  Theme theme=null;
  if (Validator.isNotNull(themeId)) {
    long companyId=PortalUtil.getCompanyId(request);
    theme=ThemeLocalServiceUtil.getTheme(companyId,themeId,false);
  }
 else   if (plid > 0) {
    Layout layout=LayoutLocalServiceUtil.getLayout(plid);
    theme=layout.getTheme();
    themeId=theme.getThemeId();
  }
 else   if (request.getAttribute(WebKeys.THEME) != null) {
    theme=(Theme)request.getAttribute(WebKeys.THEME);
    themeId=theme.getThemeId();
  }
 else   if (request.getAttribute(WebKeys.THEME_DISPLAY) != null) {
    ThemeDisplay themeDisplay=(ThemeDisplay)request.getAttribute(WebKeys.THEME_DISPLAY);
    theme=themeDisplay.getTheme();
    themeId=theme.getThemeId();
  }
 else   if (request.getAttribute(WebKeys.VIRTUAL_HOST_LAYOUT_SET) != null) {
    LayoutSet layoutSet=(LayoutSet)request.getAttribute(WebKeys.VIRTUAL_HOST_LAYOUT_SET);
    theme=layoutSet.getTheme();
    themeId=theme.getThemeId();
  }
  _log.debug("{themeId: " + themeId + ", path: "+ path+ "}");
  if (theme == null) {
    processFilter(ServletContextIncludeFilter.class,request,response,filterChain);
  }
 else {
    ServletContext servletContext=getFilterConfig().getServletContext();
    request.setAttribute(WebKeys.THEME,theme);
    request.setAttribute("path",path);
    RequestDispatcher requestDispatcher=servletContext.getRequestDispatcher(_WRAPPER_PATH);
    if (requestDispatcher != null) {
      requestDispatcher.include(request,response);
    }
  }
}
