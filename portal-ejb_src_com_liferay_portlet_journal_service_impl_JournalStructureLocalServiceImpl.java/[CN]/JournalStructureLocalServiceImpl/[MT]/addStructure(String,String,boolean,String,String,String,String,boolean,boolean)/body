{
  User user=UserUtil.findByPrimaryKey(userId);
  structureId=structureId.trim().toUpperCase();
  String groupId=PortalUtil.getPortletGroupId(plid);
  Date now=new Date();
  try {
    xsd=JournalUtil.formatXML(xsd);
  }
 catch (  DocumentException de) {
    throw new StructureXsdException();
  }
catch (  IOException ioe) {
    throw new StructureXsdException();
  }
  validate(user.getCompanyId(),structureId,autoStructureId,name,description,xsd);
  if (autoStructureId) {
    structureId=Long.toString(CounterServiceUtil.increment(JournalStructure.class.getName() + "." + user.getCompanyId()));
  }
  JournalStructurePK pk=new JournalStructurePK(user.getCompanyId(),structureId);
  JournalStructure structure=JournalStructureUtil.create(pk);
  structure.setGroupId(groupId);
  structure.setCompanyId(user.getCompanyId());
  structure.setUserId(user.getUserId());
  structure.setUserName(user.getFullName());
  structure.setCreateDate(now);
  structure.setModifiedDate(now);
  structure.setName(name);
  structure.setDescription(description);
  structure.setXsd(xsd);
  JournalStructureUtil.update(structure);
  addStructureResources(structure,addCommunityPermissions,addGuestPermissions);
  return structure;
}
