{
  String imageEditorPortletId=PortletProviderUtil.getPortletId(Image.class.getName(),PortletProvider.Action.EDIT);
  PortletURL imageEditorURL=PortletURLFactoryUtil.create(request,imageEditorPortletId,_themeDisplay.getPlid(),PortletRequest.RENDER_PHASE);
  imageEditorURL.setParameter("mvcRenderCommandName","/image_editor/view");
  try {
    imageEditorURL.setWindowState(LiferayWindowState.POP_UP);
  }
 catch (  Exception e) {
    throw new SystemException("Unable to set window state",e);
  }
  PortletURL editURL=_getLiferayPortletResponse().createActionURL(PortletKeys.DOCUMENT_LIBRARY_ADMIN);
  editURL.setParameter(ActionRequest.ACTION_NAME,"/image_editor/edit_file_entry_image_editor");
  editURL.setParameter("fileEntryId",String.valueOf(_fileEntry.getFileEntryId()));
  String fileEntryPreviewURL=DLUtil.getPreviewURL(_fileEntry,fileVersion,_themeDisplay,StringPool.BLANK);
  String onClick=_getLiferayPortletResponse().getNamespace() + "editWithImageEditor('" + imageEditorURL.toString()+ "', '"+ editURL.toString()+ "', '"+ _fileEntry.getFileName()+ "', '"+ fileEntryPreviewURL+ "');";
  JavaScriptMenuItem javascriptMenuItem=new JavaScriptMenuItem();
  javascriptMenuItem.setKey("#edit-with-image-editor");
  javascriptMenuItem.setLabel(LanguageUtil.get(request,"edit-with-image-editor"));
  javascriptMenuItem.setOnClick(onClick);
  String javaScript="/com/liferay/image/editor/integration/document/library/display/context/dependencies/" + "edit_with_image_editor_js.ftl";
  Class<?> clazz=getClass();
  URLTemplateResource urlTemplateResource=new URLTemplateResource(javaScript,clazz.getResource(javaScript));
  Template template=TemplateManagerUtil.getTemplate(TemplateConstants.LANG_TYPE_FTL,urlTemplateResource,false);
  template.put("namespace",_getLiferayPortletResponse().getNamespace());
  UnsyncStringWriter unsyncStringWriter=new UnsyncStringWriter();
  template.processTemplate(unsyncStringWriter);
  javascriptMenuItem.setJavaScript(unsyncStringWriter.toString());
  return javascriptMenuItem;
}
