{
  PortletSession ses=req.getPortletSession();
  ThemeDisplay themeDisplay=(ThemeDisplay)req.getAttribute(WebKeys.THEME_DISPLAY);
  Company company=themeDisplay.getCompany();
  boolean autoUserId=true;
  String userId=StringPool.BLANK;
  if (company.getAuthType().equals(Company.AUTH_TYPE_ID)) {
    autoUserId=false;
    userId=ParamUtil.getString(req,"userId");
  }
  boolean autoPassword=true;
  String password1=null;
  String password2=null;
  boolean passwordReset=true;
  String emailAddress=ParamUtil.getString(req,"emailAddress");
  String firstName=ParamUtil.getString(req,"firstName");
  String middleName=ParamUtil.getString(req,"middleName");
  String lastName=ParamUtil.getString(req,"lastName");
  String nickName=ParamUtil.getString(req,"nickName");
  String prefixId=ParamUtil.getString(req,"prefixId");
  String suffixId=ParamUtil.getString(req,"suffixId");
  boolean male=ParamUtil.get(req,"male",true);
  int birthdayMonth=ParamUtil.getInteger(req,"birthdayMonth");
  int birthdayDay=ParamUtil.getInteger(req,"birthdayDay");
  int birthdayYear=ParamUtil.getInteger(req,"birthdayYear");
  String jobTitle=ParamUtil.getString(req,"jobTitle");
  String organizationId=ParamUtil.getString(req,"organizationId");
  String locationId=ParamUtil.getString(req,"locationId");
  Captcha captcha=null;
  if (GetterUtil.getBoolean(PropsUtil.get(PropsUtil.CAPTCHA_CHALLENGE))) {
    captcha=(Captcha)ses.getAttribute(WebKeys.CAPTCHA,PortletSession.APPLICATION_SCOPE);
    if (captcha != null) {
      Boolean validResponse=captcha.validateResponse(ParamUtil.getString(req,"captcha"));
      if ((validResponse == null) || (validResponse.equals(Boolean.FALSE))) {
        ses.removeAttribute(WebKeys.CAPTCHA,PortletSession.APPLICATION_SCOPE);
        throw new CaptchaException();
      }
    }
 else {
      _log.error("Captcha is null");
    }
  }
  User user=UserServiceUtil.addUser(company.getCompanyId(),autoUserId,userId,autoPassword,password1,password2,passwordReset,emailAddress,themeDisplay.getLocale(),firstName,middleName,lastName,nickName,prefixId,suffixId,male,birthdayMonth,birthdayDay,birthdayYear,jobTitle,organizationId,locationId);
  if (captcha != null) {
    captcha.disposeChallenge();
    ses.removeAttribute(WebKeys.CAPTCHA,PortletSession.APPLICATION_SCOPE);
  }
  ActionRequestImpl reqImpl=(ActionRequestImpl)req;
  HttpServletRequest httpReq=reqImpl.getHttpServletRequest();
  SessionMessages.add(httpReq,"user_added",user.getEmailAddress());
  String redirect=themeDisplay.getPathMain() + "/portal/login?login=";
  if (company.getAuthType().equals(Company.AUTH_TYPE_ID)) {
    redirect+=user.getUserId();
  }
 else {
    redirect+=user.getEmailAddress();
  }
  res.sendRedirect(redirect);
}
