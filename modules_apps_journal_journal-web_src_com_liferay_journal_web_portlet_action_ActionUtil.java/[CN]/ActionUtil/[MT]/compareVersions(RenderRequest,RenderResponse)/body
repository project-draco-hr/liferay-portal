{
  ThemeDisplay themeDisplay=(ThemeDisplay)renderRequest.getAttribute(WebKeys.THEME_DISPLAY);
  long groupId=ParamUtil.getLong(renderRequest,"groupId");
  String articleId=ParamUtil.getString(renderRequest,"articleId");
  String sourceArticleId=ParamUtil.getString(renderRequest,"sourceVersion");
  int index=sourceArticleId.lastIndexOf(JournalPortlet.VERSION_SEPARATOR);
  if (index != -1) {
    sourceArticleId=sourceArticleId.substring(index + JournalPortlet.VERSION_SEPARATOR.length(),sourceArticleId.length());
  }
  double sourceVersion=GetterUtil.getDouble(sourceArticleId);
  String targetArticleId=ParamUtil.getString(renderRequest,"targetVersion");
  index=targetArticleId.lastIndexOf(JournalPortlet.VERSION_SEPARATOR);
  if (index != -1) {
    targetArticleId=targetArticleId.substring(index + JournalPortlet.VERSION_SEPARATOR.length(),targetArticleId.length());
  }
  double targetVersion=GetterUtil.getDouble(targetArticleId);
  if ((sourceVersion == 0) && (targetVersion == 0)) {
    List<JournalArticle> sourceArticles=JournalArticleServiceUtil.getArticlesByArticleId(groupId,articleId,0,1,new ArticleVersionComparator(false));
    JournalArticle sourceArticle=sourceArticles.get(0);
    sourceVersion=sourceArticle.getVersion();
    List<JournalArticle> targetArticles=JournalArticleServiceUtil.getArticlesByArticleId(groupId,articleId,0,1,new ArticleVersionComparator(true));
    JournalArticle targetArticle=targetArticles.get(0);
    targetVersion=targetArticle.getVersion();
  }
  if (sourceVersion > targetVersion) {
    double tempVersion=targetVersion;
    targetVersion=sourceVersion;
    sourceVersion=tempVersion;
  }
  String languageId=getLanguageId(renderRequest,groupId,articleId,sourceVersion,targetVersion);
  String diffHtmlResults=null;
  try {
    diffHtmlResults=JournalUtil.diffHtml(groupId,articleId,sourceVersion,targetVersion,languageId,new PortletRequestModel(renderRequest,renderResponse),themeDisplay);
  }
 catch (  CompareVersionsException cve) {
    renderRequest.setAttribute(WebKeys.DIFF_VERSION,cve.getVersion());
  }
  renderRequest.setAttribute(WebKeys.DIFF_HTML_RESULTS,diffHtmlResults);
  renderRequest.setAttribute(WebKeys.SOURCE_VERSION,sourceVersion);
  renderRequest.setAttribute(WebKeys.TARGET_VERSION,targetVersion);
}
