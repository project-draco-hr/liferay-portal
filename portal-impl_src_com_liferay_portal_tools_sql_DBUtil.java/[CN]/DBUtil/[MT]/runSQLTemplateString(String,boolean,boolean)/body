{
  if (evaluate) {
    try {
      template=evaluateVM(template);
    }
 catch (    Exception e) {
      _log.error(e,e);
    }
  }
  StringBuilder sb=new StringBuilder();
  BufferedReader br=new BufferedReader(new StringReader(template));
  String line=null;
  while ((line=br.readLine()) != null) {
    if (!line.startsWith("##")) {
      if (line.startsWith("@include ")) {
        int pos=line.indexOf(" ");
        String includeFileName=line.substring(pos + 1);
        ClassLoader classLoader=getClass().getClassLoader();
        InputStream is=classLoader.getResourceAsStream("com/liferay/portal/tools/sql/dependencies/" + includeFileName);
        if (is == null) {
          is=classLoader.getResourceAsStream(includeFileName);
        }
        String include=StringUtil.read(is);
        is.close();
        if (includeFileName.endsWith(".vm")) {
          try {
            include=evaluateVM(include);
          }
 catch (          Exception e) {
            _log.error(e,e);
          }
        }
        include=convertTimestamp(include);
        include=replaceTemplate(include,getTemplate());
        runSQLTemplateString(include,false,true);
      }
 else {
        sb.append(line);
        if (line.endsWith(";")) {
          String sql=sb.toString();
          sb=new StringBuilder();
          try {
            if (!sql.equals("COMMIT_TRANSACTION;")) {
              runSQL(sql);
            }
 else {
              if (_log.isDebugEnabled()) {
                _log.debug("Skip commit sql");
              }
            }
          }
 catch (          IOException ioe) {
            if (failOnError) {
              throw ioe;
            }
 else             if (_log.isWarnEnabled()) {
              _log.warn(ioe.getMessage());
            }
          }
catch (          SQLException sqle) {
            if (failOnError) {
              throw sqle;
            }
 else             if (_log.isWarnEnabled()) {
              String message=GetterUtil.getString(sqle.getMessage());
              if (!message.startsWith("Duplicate key name")) {
                _log.warn(sqle.getMessage());
              }
            }
          }
        }
      }
    }
  }
  br.close();
}
