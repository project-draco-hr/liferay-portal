{
  ExpandoTable table=expandoTablePersistence.findByPrimaryKey(tableId);
  ExpandoRow row=expandoRowPersistence.fetchByT_C(tableId,classPK);
  if (row == null) {
    long rowId=counterLocalService.increment();
    row=expandoRowPersistence.create(rowId);
    row.setCompanyId(table.getCompanyId());
    row.setTableId(tableId);
    row.setClassPK(classPK);
    expandoRowPersistence.update(row);
  }
  boolean rowModified=false;
  for (  ExpandoColumn column : columns) {
    String dataString=data.get(column.getName());
    if (dataString == null) {
      continue;
    }
    ExpandoValue value=expandoValuePersistence.fetchByC_R(column.getColumnId(),row.getRowId());
    if (value == null) {
      long valueId=counterLocalService.increment();
      value=expandoValuePersistence.create(valueId);
      value.setCompanyId(table.getCompanyId());
      value.setTableId(tableId);
      value.setColumnId(column.getColumnId());
      value.setRowId(row.getRowId());
      value.setClassNameId(classNameId);
      value.setClassPK(classPK);
    }
    if (value.isNew() || !Validator.equals(value.getData(),dataString)) {
      value.setData(dataString);
      expandoValuePersistence.update(value);
      rowModified=true;
    }
  }
  if (rowModified) {
    row.setModifiedDate(new Date());
    expandoRowPersistence.update(row);
  }
}
