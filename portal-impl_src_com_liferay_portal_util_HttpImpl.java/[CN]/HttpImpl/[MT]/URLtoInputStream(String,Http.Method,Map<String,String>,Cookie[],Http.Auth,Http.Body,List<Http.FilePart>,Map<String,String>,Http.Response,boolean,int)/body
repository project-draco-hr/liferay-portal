{
  URI uri=null;
  try {
    uri=new URI(location);
  }
 catch (  URISyntaxException urise) {
    throw new IOException("Invalid URI: " + location,urise);
  }
  BasicCookieStore basicCookieStore=null;
  CloseableHttpResponse closeableHttpResponse=null;
  HttpEntity httpEntity=null;
  try {
    _cookies.set(null);
    if (location == null) {
      return null;
    }
 else     if (!location.startsWith(Http.HTTP_WITH_SLASH) && !location.startsWith(Http.HTTPS_WITH_SLASH)) {
      location=Http.HTTP_WITH_SLASH + location;
    }
    HttpHost targetHttpHost=new HttpHost(uri.getHost(),uri.getPort());
    RequestConfig.Builder requestConfigBuilder=getRequestConfigBuilder(uri,timeout);
    RequestConfig requestConfig=requestConfigBuilder.build();
    CloseableHttpClient httpClient=getCloseableHttpClient(requestConfig.getProxy());
    HttpClientContext httpClientContext=HttpClientContext.create();
    RequestBuilder requestBuilder=null;
    if (method.equals(Http.Method.POST) || method.equals(Http.Method.PUT)) {
      if (method.equals(Http.Method.POST)) {
        requestBuilder=RequestBuilder.post(location);
      }
 else {
        requestBuilder=RequestBuilder.put(location);
      }
      if (body != null) {
        StringEntity stringEntity=new StringEntity(body.getContent(),body.getCharset());
        stringEntity.setContentType(body.getContentType());
        requestBuilder.setEntity(stringEntity);
      }
 else       if (method.equals(Http.Method.POST)) {
        if (!hasRequestHeader(requestBuilder,HttpHeaders.CONTENT_TYPE)) {
          ConnectionConfig.Builder connectionConfigBuilder=ConnectionConfig.custom();
          connectionConfigBuilder.setCharset(Charset.forName(StringPool.UTF8));
          _poolingHttpClientConnectionManager.setConnectionConfig(targetHttpHost,connectionConfigBuilder.build());
        }
        processPostMethod(requestBuilder,fileParts,parts);
      }
    }
 else     if (method.equals(Http.Method.DELETE)) {
      requestBuilder=RequestBuilder.delete(location);
    }
 else     if (method.equals(Http.Method.HEAD)) {
      requestBuilder=RequestBuilder.head(location);
    }
 else {
      requestBuilder=RequestBuilder.get(location);
    }
    if (headers != null) {
      for (      Map.Entry<String,String> header : headers.entrySet()) {
        requestBuilder.addHeader(header.getKey(),header.getValue());
      }
    }
    if ((method.equals(Http.Method.POST) || method.equals(Http.Method.PUT)) && ((body != null) || ((fileParts != null) && !fileParts.isEmpty()) || ((parts != null) && !parts.isEmpty())) && !hasRequestHeader(requestBuilder,HttpHeaders.CONTENT_TYPE)) {
      requestBuilder.addHeader(HttpHeaders.CONTENT_TYPE,ContentTypes.APPLICATION_X_WWW_FORM_URLENCODED_UTF8);
    }
    if (!hasRequestHeader(requestBuilder,HttpHeaders.USER_AGENT)) {
      requestBuilder.addHeader(HttpHeaders.USER_AGENT,_DEFAULT_USER_AGENT);
    }
    if (ArrayUtil.isNotEmpty(cookies)) {
      basicCookieStore=new BasicCookieStore();
      org.apache.http.cookie.Cookie[] httpCookies=toHttpCookies(cookies);
      basicCookieStore.addCookies(httpCookies);
      httpClientContext.setCookieStore(basicCookieStore);
      requestConfigBuilder.setCookieSpec(CookieSpecs.DEFAULT);
    }
    if (auth != null) {
      requestConfigBuilder.setAuthenticationEnabled(true);
      CredentialsProvider credentialProvider=new BasicCredentialsProvider();
      httpClientContext.setCredentialsProvider(credentialProvider);
      credentialProvider.setCredentials(new AuthScope(auth.getHost(),auth.getPort(),auth.getRealm()),new UsernamePasswordCredentials(auth.getUsername(),auth.getPassword()));
    }
    addProxyCredentials(uri,httpClientContext);
    requestBuilder.setConfig(requestConfigBuilder.build());
    closeableHttpResponse=httpClient.execute(targetHttpHost,requestBuilder.build(),httpClientContext);
    httpEntity=closeableHttpResponse.getEntity();
    response.setResponseCode(closeableHttpResponse.getStatusLine().getStatusCode());
    Header locationHeader=closeableHttpResponse.getFirstHeader("location");
    if (locationHeader != null) {
      String locationHeaderValue=locationHeader.getValue();
      if (!locationHeaderValue.equals(location)) {
        if (followRedirects) {
          EntityUtils.consumeQuietly(httpEntity);
          closeableHttpResponse.close();
          return URLtoInputStream(locationHeaderValue,Http.Method.GET,headers,cookies,auth,body,fileParts,parts,response,followRedirects,timeout);
        }
 else {
          response.setRedirect(locationHeaderValue);
        }
      }
    }
    long contentLengthLong=0;
    Header contentLengthHeader=closeableHttpResponse.getFirstHeader(HttpHeaders.CONTENT_LENGTH);
    if (contentLengthHeader != null) {
      contentLengthLong=GetterUtil.getLong(contentLengthHeader.getValue());
      response.setContentLengthLong(contentLengthLong);
      if (contentLengthLong > _MAX_BYTE_ARRAY_LENGTH) {
        response.setContentLength(-1);
      }
 else {
        int contentLength=(int)contentLengthLong;
        response.setContentLength(contentLength);
      }
    }
    Header contentTypeHeader=closeableHttpResponse.getFirstHeader(HttpHeaders.CONTENT_TYPE);
    if (contentTypeHeader != null) {
      response.setContentType(contentTypeHeader.getValue());
    }
    for (    Header header : closeableHttpResponse.getAllHeaders()) {
      response.addHeader(header.getName(),header.getValue());
    }
    InputStream inputStream=httpEntity.getContent();
    final CloseableHttpResponse referenceCloseableHttpResponse=closeableHttpResponse;
    final Reference<InputStream> reference=FinalizeManager.register(inputStream,new FinalizeAction(){
      @Override public void doFinalize(      Reference<?> reference){
        try {
          referenceCloseableHttpResponse.close();
        }
 catch (        IOException ioe) {
          if (_log.isDebugEnabled()) {
            _log.debug("Unable to close response",ioe);
          }
        }
      }
    }
,FinalizeManager.WEAK_REFERENCE_FACTORY);
    return new UnsyncFilterInputStream(inputStream){
      @Override public void close() throws IOException {
        super.close();
        referenceCloseableHttpResponse.close();
        reference.clear();
      }
    }
;
  }
 catch (  Exception e) {
    if (httpEntity != null) {
      EntityUtils.consumeQuietly(httpEntity);
    }
    if (closeableHttpResponse != null) {
      try {
        closeableHttpResponse.close();
      }
 catch (      IOException ioe) {
        if (_log.isWarnEnabled()) {
          _log.warn("Error closing response",e);
        }
      }
    }
    throw new IOException(e);
  }
 finally {
    try {
      if (basicCookieStore != null) {
        _cookies.set(toServletCookies(basicCookieStore.getCookies()));
      }
    }
 catch (    Exception e) {
      _log.error(e,e);
    }
  }
}
