{
  StringBuffer sb=request.getRequestURL();
  if (sb == null) {
    sb=new StringBuffer();
  }
  if (request.getQueryString() != null) {
    sb.append(StringPool.QUESTION);
    sb.append(request.getQueryString());
  }
  String proxyPath=PortalUtil.getPathProxy();
  if (Validator.isNotNull(proxyPath)) {
    int x=sb.indexOf(Http.PROTOCOL_DELIMITER) + Http.PROTOCOL_DELIMITER.length();
    int y=sb.indexOf(StringPool.SLASH,x);
    sb.insert(y,proxyPath);
  }
  String completeURL=sb.toString();
  if (request.isRequestedSessionIdFromURL()) {
    HttpSession session=request.getSession();
    String sessionId=session.getId();
    completeURL=PortalUtil.getURLWithSessionId(completeURL,sessionId);
  }
  if (_log.isWarnEnabled()) {
    if (completeURL.contains("?&")) {
      _log.warn("Invalid url " + completeURL);
    }
  }
  return completeURL;
}
