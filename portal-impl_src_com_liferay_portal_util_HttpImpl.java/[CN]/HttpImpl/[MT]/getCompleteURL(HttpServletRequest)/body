{
  StringBuffer sb=request.getRequestURL();
  if (sb == null) {
    sb=new StringBuffer();
  }
  if (request.getQueryString() != null) {
    sb.append(StringPool.QUESTION);
    sb.append(request.getQueryString());
  }
  String portalProxyPath=PortalUtil.getPathProxy();
  if (Validator.isNotNull(portalProxyPath)) {
    int pos1=sb.indexOf(Http.PROTOCOL_DELIMITER) + Http.PROTOCOL_DELIMITER.length();
    int pos2=sb.indexOf(StringPool.SLASH,pos1);
    sb.insert(pos2,portalProxyPath);
  }
  String completeURL=sb.toString();
  if (_log.isWarnEnabled()) {
    if (completeURL.contains("?&")) {
      _log.warn("Invalid url " + completeURL);
    }
  }
  return completeURL;
}
