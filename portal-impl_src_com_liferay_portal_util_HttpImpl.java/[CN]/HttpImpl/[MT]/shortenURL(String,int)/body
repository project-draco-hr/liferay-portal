{
  if (count == 0) {
    return null;
  }
  StringBundler sb=new StringBundler();
  String[] params=StringUtil.split(url,CharPool.AMPERSAND);
  for (int i=0; i < params.length; i++) {
    String param=params[i];
    if (param.contains("_backURL=") || param.contains("_redirect=") || param.contains("_returnToFullPageURL=")|| param.startsWith("redirect")) {
      int pos=param.indexOf(CharPool.EQUAL);
      String qName=param.substring(0,pos);
      String redirect=param.substring(pos + 1);
      try {
        redirect=decodeURL(redirect);
      }
 catch (      IllegalArgumentException iae) {
        if (_log.isDebugEnabled()) {
          _log.debug("Skipping undecodable parameter " + param,iae);
        }
        continue;
      }
      String newURL=shortenURL(redirect,count - 1);
      if (newURL != null) {
        newURL=encodeURL(newURL);
        sb.append(qName);
        sb.append(StringPool.EQUAL);
        sb.append(newURL);
        if (i < (params.length - 1)) {
          sb.append(StringPool.AMPERSAND);
        }
      }
    }
 else {
      sb.append(param);
      if (i < (params.length - 1)) {
        sb.append(StringPool.AMPERSAND);
      }
    }
  }
  return sb.toString();
}
