{
  User user=userPersistence.findByPrimaryKey(userId);
  long groupId=serviceContext.getScopeGroupId();
  name=name.trim();
  Date now=new Date();
  if (hasCategoryVocabulary(groupId,name)) {
    throw new DuplicateCategoryVocabularyException("A category vocabulary with the name " + name + " already exists");
  }
  long categoryVocabularyId=counterLocalService.increment();
  AssetCategoryVocabulary categoryVocabulary=assetCategoryVocabularyPersistence.create(categoryVocabularyId);
  categoryVocabulary.setGroupId(groupId);
  categoryVocabulary.setCompanyId(user.getCompanyId());
  categoryVocabulary.setUserId(user.getUserId());
  categoryVocabulary.setUserName(user.getFullName());
  categoryVocabulary.setCreateDate(now);
  categoryVocabulary.setModifiedDate(now);
  categoryVocabulary.setName(name);
  assetCategoryVocabularyPersistence.update(categoryVocabulary,false);
  if (serviceContext.getAddCommunityPermissions() || serviceContext.getAddGuestPermissions()) {
    addCategoryVocabularyResources(categoryVocabulary,serviceContext.getAddCommunityPermissions(),serviceContext.getAddGuestPermissions());
  }
 else {
    addCategoryVocabularyResources(categoryVocabulary,serviceContext.getCommunityPermissions(),serviceContext.getGuestPermissions());
  }
  return categoryVocabulary;
}
