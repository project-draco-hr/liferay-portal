{
  List<FileVersion> fileVersions=fileEntry.getFileVersions(WorkflowConstants.STATUS_ANY);
  FileVersion latestFileVersion=fileVersions.get(fileVersions.size() - 1);
  FileEntry destinationFileEntry=toRepository.addFileEntry(getUserId(),newFolderId,fileEntry.getTitle(),latestFileVersion.getMimeType(),latestFileVersion.getTitle(),latestFileVersion.getDescription(),StringPool.BLANK,latestFileVersion.getContentStream(false),latestFileVersion.getSize(),serviceContext);
  FileVersion oldDestinationFileVersion=destinationFileEntry.getFileVersion();
  dlAppHelperLocalService.addFileEntry(getUserId(),destinationFileEntry,oldDestinationFileVersion,serviceContext);
  for (int i=fileVersions.size() - 2; i >= 0; i--) {
    FileVersion fileVersion=fileVersions.get(i);
    FileVersion previousFileVersion=fileVersions.get(i + 1);
    try {
      destinationFileEntry=toRepository.updateFileEntry(getUserId(),destinationFileEntry.getFileEntryId(),fileVersion.getTitle(),fileVersion.getMimeType(),fileVersion.getTitle(),fileVersion.getDescription(),StringPool.BLANK,DLAppUtil.isMajorVersion(previousFileVersion,fileVersion),fileVersion.getContentStream(false),fileVersion.getSize(),serviceContext);
      FileVersion destinationFileVersion=destinationFileEntry.getFileVersion();
      dlAppHelperLocalService.updateFileEntry(getUserId(),destinationFileEntry,oldDestinationFileVersion,destinationFileVersion,serviceContext);
      oldDestinationFileVersion=destinationFileVersion;
    }
 catch (    PortalException pe) {
      toRepository.deleteFileEntry(destinationFileEntry.getFileEntryId());
      throw pe;
    }
  }
  return destinationFileEntry;
}
