{
  try {
    PortletSession ses=req.getPortletSession();
    String address=req.getParameter("recipient_address");
    String name=req.getParameter("recipient_name");
    PortletPreferences prefs=req.getPreferences();
    Message msg=new Message(req,prefs);
    if ((name != null) && (address != null)) {
      msg.setTo(name + " &#60;" + address+ "&#62;");
    }
 else     if (address != null) {
      msg.setTo(address);
    }
    StringBuffer msgBody=new StringBuffer();
    String signature=prefs.getValue("signature",StringPool.BLANK);
    if (Validator.isNotNull(signature)) {
      signature=JS.decodeURIComponent(signature);
      if (msg.isHTMLFormat()) {
        msgBody.append("<br><br>");
        msgBody.append(StringUtil.replace(signature,"\n","<br>"));
      }
 else {
        msgBody.append("\n\n\n");
        msgBody.append(signature);
      }
    }
    msg.setBody(msgBody.toString());
    ses.setAttribute(WebKeys.MAIL_MESSAGE_MODEL,msg,PortletSession.APPLICATION_SCOPE);
    PortletURL portletURL=((ActionResponseImpl)res).createRenderURL();
    portletURL.setParameter("struts_action","/mail/compose_message");
    res.sendRedirect(portletURL.toString());
  }
 catch (  Exception e) {
    e.printStackTrace();
    res.sendRedirect(ParamUtil.getString(req,"redirect"));
  }
}
