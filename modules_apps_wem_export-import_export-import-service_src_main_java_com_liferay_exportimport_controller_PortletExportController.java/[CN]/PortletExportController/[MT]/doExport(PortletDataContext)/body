{
  boolean exportPermissions=MapUtil.getBoolean(portletDataContext.getParameterMap(),PortletDataHandlerKeys.PERMISSIONS);
  if (_log.isDebugEnabled()) {
    _log.debug("Export permissions " + exportPermissions);
  }
  StopWatch stopWatch=new StopWatch();
  stopWatch.start();
  Layout layout=_layoutLocalService.getLayout(portletDataContext.getPlid());
  if (!layout.isTypeControlPanel() && !layout.isTypePanel() && !layout.isTypePortlet()) {
    throw new LayoutImportException("Layout type " + layout.getType() + " is not valid");
  }
  ServiceContext serviceContext=ServiceContextThreadLocal.getServiceContext();
  if (serviceContext == null) {
    serviceContext=new ServiceContext();
    serviceContext.setCompanyId(layout.getCompanyId());
    serviceContext.setSignedIn(false);
    long defaultUserId=_userLocalService.getDefaultUserId(layout.getCompanyId());
    serviceContext.setUserId(defaultUserId);
    ServiceContextThreadLocal.pushServiceContext(serviceContext);
  }
  long layoutSetBranchId=MapUtil.getLong(portletDataContext.getParameterMap(),"layoutSetBranchId");
  serviceContext.setAttribute("layoutSetBranchId",layoutSetBranchId);
  long scopeGroupId=portletDataContext.getGroupId();
  javax.portlet.PortletPreferences jxPortletPreferences=PortletPreferencesFactoryUtil.getLayoutPortletSetup(layout,portletDataContext.getPortletId());
  String scopeType=GetterUtil.getString(jxPortletPreferences.getValue("lfrScopeType",null));
  String scopeLayoutUuid=GetterUtil.getString(jxPortletPreferences.getValue("lfrScopeLayoutUuid",null));
  if (Validator.isNotNull(scopeType)) {
    Group scopeGroup=null;
    if (scopeType.equals("company")) {
      scopeGroup=_groupLocalService.getCompanyGroup(layout.getCompanyId());
    }
 else     if (Validator.isNotNull(scopeLayoutUuid)) {
      scopeGroup=layout.getScopeGroup();
    }
    if (scopeGroup != null) {
      scopeGroupId=scopeGroup.getGroupId();
    }
  }
  portletDataContext.setScopeType(scopeType);
  portletDataContext.setScopeLayoutUuid(scopeLayoutUuid);
  Document document=SAXReaderUtil.createDocument();
  Element rootElement=document.addElement("root");
  portletDataContext.setExportDataRootElement(rootElement);
  Element headerElement=rootElement.addElement("header");
  headerElement.addAttribute("available-locales",StringUtil.merge(LanguageUtil.getAvailableLocales(PortalUtil.getSiteGroupId(portletDataContext.getScopeGroupId()))));
  headerElement.addAttribute("build-number",String.valueOf(ReleaseInfo.getBuildNumber()));
  headerElement.addAttribute("export-date",Time.getRFC822());
  if (portletDataContext.hasDateRange()) {
    headerElement.addAttribute("start-date",String.valueOf(portletDataContext.getStartDate()));
    headerElement.addAttribute("end-date",String.valueOf(portletDataContext.getEndDate()));
  }
  headerElement.addAttribute("type","portlet");
  headerElement.addAttribute("company-id",String.valueOf(portletDataContext.getCompanyId()));
  headerElement.addAttribute("company-group-id",String.valueOf(portletDataContext.getCompanyGroupId()));
  headerElement.addAttribute("group-id",String.valueOf(scopeGroupId));
  headerElement.addAttribute("user-personal-site-group-id",String.valueOf(portletDataContext.getUserPersonalSiteGroupId()));
  headerElement.addAttribute("private-layout",String.valueOf(layout.isPrivateLayout()));
  headerElement.addAttribute("root-portlet-id",portletDataContext.getRootPortletId());
  Element missingReferencesElement=rootElement.addElement("missing-references");
  portletDataContext.setMissingReferencesElement(missingReferencesElement);
  Map<String,Boolean> exportPortletControlsMap=ExportImportHelperUtil.getExportPortletControlsMap(layout.getCompanyId(),portletDataContext.getPortletId(),portletDataContext.getParameterMap());
  exportPortlet(portletDataContext,layout,rootElement,exportPermissions,exportPortletControlsMap.get(PortletDataHandlerKeys.PORTLET_ARCHIVED_SETUPS),exportPortletControlsMap.get(PortletDataHandlerKeys.PORTLET_DATA),exportPortletControlsMap.get(PortletDataHandlerKeys.PORTLET_SETUP),exportPortletControlsMap.get(PortletDataHandlerKeys.PORTLET_USER_PREFERENCES));
  exportService(portletDataContext,rootElement,exportPortletControlsMap.get(PortletDataHandlerKeys.PORTLET_SETUP));
  exportAssetLinks(portletDataContext);
  exportExpandoTables(portletDataContext);
  exportLocks(portletDataContext);
  _deletionSystemEventExporter.exportDeletionSystemEvents(portletDataContext);
  if (exportPermissions) {
    _permissionExporter.exportPortletDataPermissions(portletDataContext);
  }
  ExportImportHelperUtil.writeManifestSummary(document,portletDataContext.getManifestSummary());
  if (_log.isInfoEnabled()) {
    _log.info("Exporting portlet took " + stopWatch.getTime() + " ms");
  }
  try {
    portletDataContext.addZipEntry("/manifest.xml",document.formattedString());
  }
 catch (  IOException ioe) {
    throw new SystemException(ioe);
  }
  ZipWriter zipWriter=portletDataContext.getZipWriter();
  return zipWriter.getFile();
}
