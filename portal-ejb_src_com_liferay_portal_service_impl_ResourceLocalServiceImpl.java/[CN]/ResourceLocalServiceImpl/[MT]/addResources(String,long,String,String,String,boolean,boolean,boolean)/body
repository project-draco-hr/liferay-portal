{
  long start=0;
  if (_log.isDebugEnabled()) {
    start=System.currentTimeMillis();
  }
  validate(companyId,name,portletActions);
  start=logAddResources(name,primKey,start,1);
  addResource(companyId,name,ResourceImpl.TYPE_CLASS,ResourceImpl.SCOPE_COMPANY,companyId);
  start=logAddResources(name,primKey,start,2);
  Group guestGroup=GroupLocalServiceUtil.getGroup(companyId,GroupImpl.GUEST);
  addResource(companyId,name,ResourceImpl.TYPE_CLASS,ResourceImpl.SCOPE_GROUP,String.valueOf(guestGroup.getGroupId()));
  start=logAddResources(name,primKey,start,3);
  if ((groupId > 0) && (guestGroup.getGroupId() != groupId)) {
    addResource(companyId,name,ResourceImpl.TYPE_CLASS,ResourceImpl.SCOPE_GROUP,String.valueOf(groupId));
  }
  start=logAddResources(name,primKey,start,4);
  if (primKey != null) {
    Resource resource=addResource(companyId,name,ResourceImpl.TYPE_CLASS,ResourceImpl.SCOPE_INDIVIDUAL,primKey);
    start=logAddResources(name,primKey,start,5);
    List permissions=PermissionLocalServiceUtil.addPermissions(companyId,name,resource.getResourceId(),portletActions);
    start=logAddResources(name,primKey,start,6);
    if (userId != null) {
      UserUtil.addPermissions(userId,permissions);
    }
    start=logAddResources(name,primKey,start,7);
    if ((groupId > 0) && addCommunityPermissions) {
      addCommunityPermissions(groupId,name,resource.getResourceId(),portletActions);
    }
    start=logAddResources(name,primKey,start,8);
    if (addGuestPermissions) {
      if ((groupId > 0) && addCommunityPermissions) {
        if (guestGroup.getGroupId() == groupId) {
          addGuestPermissions=false;
        }
      }
      if (addGuestPermissions) {
        addGuestPermissions(guestGroup.getGroupId(),name,resource.getResourceId(),portletActions);
      }
    }
    start=logAddResources(name,primKey,start,9);
  }
}
