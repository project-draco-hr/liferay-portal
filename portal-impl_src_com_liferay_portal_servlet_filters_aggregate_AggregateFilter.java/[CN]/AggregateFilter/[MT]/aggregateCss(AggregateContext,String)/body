{
  StringBundler sb=new StringBundler(content.length());
  int pos=0;
  while (true) {
    int commentX=content.indexOf(_CSS_COMMENT_BEGIN,pos);
    int commentY=content.indexOf(_CSS_COMMENT_END,commentX + _CSS_COMMENT_BEGIN.length());
    int importX=content.indexOf(_CSS_IMPORT_BEGIN,pos);
    int importY=content.indexOf(_CSS_IMPORT_END,importX + _CSS_IMPORT_BEGIN.length());
    if ((importX == -1) || (importY == -1)) {
      sb.append(content.substring(pos));
      break;
    }
 else     if ((commentX != -1) && (commentY != -1) && (commentX < importX)&& (commentY > importX)) {
      commentY+=_CSS_COMMENT_END.length();
      sb.append(content.substring(pos,commentY));
      pos=commentY;
    }
 else {
      sb.append(content.substring(pos,importX));
      String mediaQuery=StringPool.BLANK;
      int mediaQueryImportX=content.indexOf(CharPool.CLOSE_PARENTHESIS,importX + _CSS_IMPORT_BEGIN.length());
      int mediaQueryImportY=content.indexOf(CharPool.SEMICOLON,importX + _CSS_IMPORT_BEGIN.length());
      String importFileName=null;
      if (importY != mediaQueryImportX) {
        mediaQuery=content.substring(mediaQueryImportX + 1,mediaQueryImportY);
        importFileName=content.substring(importX + _CSS_IMPORT_BEGIN.length(),mediaQueryImportX);
      }
 else {
        importFileName=content.substring(importX + _CSS_IMPORT_BEGIN.length(),importY);
      }
      String importContent=aggregateContext.getContent(importFileName);
      if (importContent == null) {
        if (_log.isWarnEnabled()) {
          _log.warn("File " + aggregateContext.getFullPath(importFileName) + " does not exist");
        }
        importContent=StringPool.BLANK;
      }
      String importDir=StringPool.BLANK;
      int slashPos=importFileName.lastIndexOf(CharPool.SLASH);
      if (slashPos != -1) {
        importDir=StringPool.SLASH.concat(importFileName.substring(0,slashPos + 1));
      }
      aggregateContext.pushPath(importDir);
      importContent=aggregateCss(aggregateContext,importContent);
      aggregateContext.popPath(importDir);
      int importDepth=StringUtil.count(importFileName,StringPool.SLASH);
      String relativePath=StringPool.BLANK;
      for (int i=0; i < importDepth; i++) {
        relativePath+="../";
      }
      importContent=StringUtil.replace(importContent,new String[]{"url('" + relativePath,"url(\"" + relativePath,"url(" + relativePath},new String[]{"url('[$TEMP_RELATIVE_PATH$]","url(\"[$TEMP_RELATIVE_PATH$]","url([$TEMP_RELATIVE_PATH$]"});
      importContent=StringUtil.replace(importContent,"[$TEMP_RELATIVE_PATH$]",StringPool.BLANK);
      if (Validator.isNotNull(mediaQuery)) {
        sb.append(_CSS_MEDIA_QUERY);
        sb.append(CharPool.SPACE);
        sb.append(mediaQuery);
        sb.append(CharPool.OPEN_CURLY_BRACE);
        sb.append(importContent);
        sb.append(CharPool.CLOSE_CURLY_BRACE);
        pos=mediaQueryImportY + 1;
      }
 else {
        sb.append(importContent);
        pos=importY + _CSS_IMPORT_END.length();
      }
    }
  }
  return sb.toString();
}
