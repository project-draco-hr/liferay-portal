{
  String minifierType=ParamUtil.getString(request,"minifierType");
  String minifierBundleId=ParamUtil.getString(request,"minifierBundleId");
  String minifierBundleDirName=ParamUtil.getString(request,"minifierBundleDir");
  if (Validator.isNull(minifierType) || Validator.isNotNull(minifierBundleId) || Validator.isNotNull(minifierBundleDirName)) {
    return null;
  }
  String requestURI=request.getRequestURI();
  String resourcePath=requestURI;
  String contextPath=request.getContextPath();
  if (!contextPath.equals(StringPool.SLASH)) {
    resourcePath=resourcePath.substring(contextPath.length());
  }
  if (resourcePath.endsWith(_CSS_EXTENSION) && PortalUtil.isRightToLeft(request)) {
    int pos=resourcePath.lastIndexOf(StringPool.PERIOD);
    resourcePath=resourcePath.substring(0,pos) + "_rtl" + resourcePath.substring(pos);
  }
  URL resourceURL=_servletContext.getResource(resourcePath);
  if (resourceURL == null) {
    resourceURL=PortalWebResourcesUtil.getResource(resourcePath);
    if (resourceURL == null) {
      return null;
    }
  }
  String cacheCommonFileName=getCacheFileName(request);
  File cacheContentTypeFile=new File(_tempDir,cacheCommonFileName + "_E_CONTENT_TYPE");
  File cacheDataFile=new File(_tempDir,cacheCommonFileName + "_E_DATA");
  if (cacheDataFile.exists() && (cacheDataFile.lastModified() >= URLUtil.getLastModifiedTime(resourceURL))) {
    if (cacheContentTypeFile.exists()) {
      String contentType=FileUtil.read(cacheContentTypeFile);
      response.setContentType(contentType);
    }
    return cacheDataFile;
  }
  String content=null;
  if (resourcePath.endsWith(_CSS_EXTENSION)) {
    if (_log.isInfoEnabled()) {
      _log.info("Minifying CSS " + resourcePath);
    }
    content=getCssContent(request,response,resourceURL,resourcePath);
    response.setContentType(ContentTypes.TEXT_CSS);
    FileUtil.write(cacheContentTypeFile,ContentTypes.TEXT_CSS);
  }
 else   if (resourcePath.endsWith(_JAVASCRIPT_EXTENSION)) {
    if (_log.isInfoEnabled()) {
      _log.info("Minifying JavaScript " + resourcePath);
    }
    content=getJavaScriptContent(resourceURL);
    response.setContentType(ContentTypes.TEXT_JAVASCRIPT);
    FileUtil.write(cacheContentTypeFile,ContentTypes.TEXT_JAVASCRIPT);
  }
 else   if (resourcePath.endsWith(_JSP_EXTENSION)) {
    if (_log.isInfoEnabled()) {
      _log.info("Minifying JSP " + resourcePath);
    }
    BufferCacheServletResponse bufferCacheServletResponse=new BufferCacheServletResponse(response);
    processFilter(AggregateFilter.class,request,bufferCacheServletResponse,filterChain);
    bufferCacheServletResponse.finishResponse(false);
    content=bufferCacheServletResponse.getString();
    if (minifierType.equals("css")) {
      content=getCssContent(request,response,resourcePath,content);
    }
 else     if (minifierType.equals("js")) {
      content=getJavaScriptContent(resourcePath,content);
    }
    FileUtil.write(cacheContentTypeFile,bufferCacheServletResponse.getContentType());
  }
 else {
    return null;
  }
  FileUtil.write(cacheDataFile,content);
  return content;
}
