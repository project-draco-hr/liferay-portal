{
  LinkedHashMap<Long,long[]> scopes=new LinkedHashMap<>();
  scopes.put(Long.valueOf(0),new long[]{0});
  scopes.put(_USER_CLASS_NAME_ID,new long[]{userId});
  List<Group> groupsList=new ArrayList<>();
  List<Organization> organizations=OrganizationLocalServiceUtil.getUserOrganizations(userId);
  if (!organizations.isEmpty()) {
    List<Organization> organizationsList=new ArrayList<>();
    organizationsList.addAll(organizations);
    for (    Organization organization : organizations) {
      groupsList.add(organization.getGroup());
      List<Organization> parentOrganizations=OrganizationLocalServiceUtil.getParentOrganizations(organization.getOrganizationId());
      for (      Organization parentOrganization : parentOrganizations) {
        organizationsList.add(parentOrganization);
        groupsList.add(parentOrganization.getGroup());
      }
    }
    scopes.put(_ORGANIZATION_CLASS_NAME_ID,_getOrganizationIds(organizationsList));
  }
  List<Group> groups=GroupLocalServiceUtil.getUserGroups(userId,true);
  if (!groups.isEmpty()) {
    scopes.put(_GROUP_CLASS_NAME_ID,_getGroupIds(groups));
    groupsList.addAll(groups);
  }
  List<UserGroup> userGroups=UserGroupLocalServiceUtil.getUserUserGroups(userId);
  if (!userGroups.isEmpty()) {
    scopes.put(_USER_GROUP_CLASS_NAME_ID,_getUserGroupIds(userGroups));
    for (    UserGroup userGroup : userGroups) {
      groupsList.add(userGroup.getGroup());
    }
  }
  Set<Role> roles=new LinkedHashSet<>();
  if (!groupsList.isEmpty()) {
    roles.addAll(RoleLocalServiceUtil.getUserRelatedRoles(userId,groupsList));
    for (    Group group : groupsList) {
      roles.addAll(RoleLocalServiceUtil.getUserGroupRoles(userId,group.getGroupId()));
      roles.addAll(RoleLocalServiceUtil.getUserGroupGroupRoles(userId,group.getGroupId()));
    }
  }
 else {
    roles.addAll(RoleLocalServiceUtil.getUserRoles(userId));
  }
  List<Team> teams=TeamLocalServiceUtil.getUserTeams(userId);
  for (  Team team : teams) {
    roles.add(team.getRole());
  }
  if (_PERMISSIONS_CHECK_GUEST_ENABLED) {
    User user=UserLocalServiceUtil.getUserById(userId);
    Role guestRole=RoleLocalServiceUtil.getRole(user.getCompanyId(),RoleConstants.GUEST);
    roles.add(guestRole);
  }
  if (!roles.isEmpty()) {
    scopes.put(_ROLE_CLASS_NAME_ID,_getRoleIds(roles));
  }
  return scopes;
}
