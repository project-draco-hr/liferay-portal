{
  Dictionary<String,Object> properties=new HashMapDictionary<>();
  properties.put(URLConstants.URL_HANDLER_PROTOCOL,new String[]{"lpkg"});
  bundleContext.registerService(URLStreamHandlerService.class.getName(),new LPKGURLStreamHandlerService(_urls),properties);
  _warWrapperBundlerTracker=new BundleTracker<>(bundleContext,~Bundle.UNINSTALLED,new War1WrapperBundleTrackCustomizer(_lpkgWarBundleRegistry));
  _warWrapperBundlerTracker.open();
  _lpkgBundleTracker=new BundleTracker<>(bundleContext,~Bundle.UNINSTALLED,new LPKGBundleTrackerCustomizer(bundleContext,_urls));
  _lpkgBundleTracker.open();
  String deploymentDir=GetterUtil.getString(bundleContext.getProperty("lpkg.deployer.dir"),PropsValues.MODULE_FRAMEWORK_BASE_DIR + "/marketplace");
  Path deploymentDirPath=Paths.get(deploymentDir);
  Files.createDirectories(deploymentDirPath);
  Files.walkFileTree(deploymentDirPath,new SimpleFileVisitor<Path>(){
    @Override public FileVisitResult visitFile(    Path filePath,    BasicFileAttributes basicFileAttributes){
      Path fileNamePath=filePath.getFileName();
      String fileName=StringUtil.toLowerCase(fileNamePath.toString());
      if (!fileName.endsWith(".lpkg")) {
        return FileVisitResult.CONTINUE;
      }
      try {
        List<Bundle> bundles=deploy(bundleContext,filePath.toFile());
        for (        Bundle bundle : bundles) {
          Dictionary<String,String> headers=bundle.getHeaders();
          String fragmentHost=headers.get(Constants.FRAGMENT_HOST);
          if (fragmentHost != null) {
            continue;
          }
          try {
            bundle.start();
          }
 catch (          BundleException be) {
            _log.error("Unable to start " + bundle + " for "+ filePath,be);
          }
        }
      }
 catch (      Exception e) {
        _log.error("Unable to deploy LPKG file " + filePath,e);
      }
      return FileVisitResult.CONTINUE;
    }
  }
);
}
