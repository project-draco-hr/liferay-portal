{
  Object thisObject=invocation.getThis();
  Method method=invocation.getMethod();
  Class<?> targetClass=null;
  if (thisObject != null) {
    targetClass=thisObject.getClass();
  }
  TransactionAttribute transactionAttribute=getTransactionAttributeSource().getTransactionAttribute(method,targetClass);
  String joinpointIdentification=method.getDeclaringClass().getName().concat(".").concat(method.getName());
  TransactionInfo transactionInfo=createTransactionIfNecessary(getTransactionManager(),transactionAttribute,joinpointIdentification);
  Object returnValue=null;
  try {
    returnValue=invocation.proceed();
  }
 catch (  Throwable ex) {
    completeTransactionAfterThrowing(transactionInfo,ex);
    throw ex;
  }
 finally {
    cleanupTransactionInfo(transactionInfo);
  }
  commitTransactionAfterReturning(transactionInfo);
  return returnValue;
}
