{
  Method method=methodInvocation.getMethod();
  Class<?> targetClass=null;
  Object thisObject=methodInvocation.getThis();
  if (thisObject != null) {
    targetClass=thisObject.getClass();
  }
  TransactionAttributeSource transactionAttributeSource=getTransactionAttributeSource();
  TransactionAttribute transactionAttribute=transactionAttributeSource.getTransactionAttribute(method,targetClass);
  Class<?> declaringClass=method.getDeclaringClass();
  String joinPointIdentification=declaringClass.getName().concat(StringPool.PERIOD).concat(method.getName());
  TransactionInfo transactionInfo=createTransactionIfNecessary(getTransactionManager(),transactionAttribute,joinPointIdentification);
  Object returnValue=null;
  try {
    returnValue=methodInvocation.proceed();
  }
 catch (  Throwable throwable) {
    completeTransactionAfterThrowing(transactionInfo,throwable);
    throw throwable;
  }
 finally {
    cleanupTransactionInfo(transactionInfo);
  }
  commitTransactionAfterReturning(transactionInfo);
  return returnValue;
}
