{
  if (name.startsWith("DLFE-")) {
    name=name.substring(5);
  }
  name=FileUtil.stripExtension(name);
  FileEntry fileEntry=null;
  if (Validator.isNotNull(uuid) && (groupId > 0)) {
    fileEntry=DLAppServiceUtil.getFileEntryByUuidAndGroupId(uuid,groupId);
    folderId=fileEntry.getFolderId();
  }
  if (fileEntryId > 0) {
    fileEntry=DLAppServiceUtil.getFileEntry(fileEntryId);
  }
 else   if (fileShortcutId <= 0) {
    if (Validator.isNotNull(title)) {
      fileEntry=DLAppServiceUtil.getFileEntry(groupId,folderId,title);
    }
 else     if (Validator.isNotNull(name)) {
      DLFileEntry dlFileEntry=DLFileEntryLocalServiceUtil.fetchFileEntryByName(groupId,folderId,name);
      if (dlFileEntry == null) {
        List<DLFileEntry> dlFileEntries=DLFileEntryLocalServiceUtil.getFileEntries(folderId,name);
        if (!dlFileEntries.isEmpty()) {
          dlFileEntry=dlFileEntries.get(0);
        }
      }
      if (dlFileEntry != null) {
        PermissionChecker permissionChecker=PermissionThreadLocal.getPermissionChecker();
        DLFileEntryPermission.check(permissionChecker,dlFileEntry,ActionKeys.VIEW);
        fileEntry=new LiferayFileEntry(dlFileEntry);
      }
    }
  }
 else {
    DLFileShortcut fileShortcut=DLAppServiceUtil.getFileShortcut(fileShortcutId);
    fileEntryId=fileShortcut.getToFileEntryId();
    fileEntry=DLAppServiceUtil.getFileEntry(fileEntryId);
  }
  if (Validator.isNull(version)) {
    if ((fileEntry != null) && Validator.isNotNull(fileEntry.getVersion())) {
      version=fileEntry.getVersion();
    }
 else {
      throw new NoSuchFileEntryException();
    }
  }
  FileVersion fileVersion=fileEntry.getFileVersion(version);
  InputStream is=fileVersion.getContentStream(true);
  String fileName=fileVersion.getTitle();
  long contentLength=fileVersion.getSize();
  String contentType=fileVersion.getMimeType();
  if (Validator.isNotNull(targetExtension)) {
    String id=DLUtil.getTempFileId(fileEntry.getFileEntryId(),version);
    String sourceExtension=fileVersion.getExtension();
    if (!fileName.endsWith(StringPool.PERIOD + sourceExtension)) {
      fileName+=StringPool.PERIOD + sourceExtension;
    }
    File convertedFile=DocumentConversionUtil.convert(id,is,sourceExtension,targetExtension);
    if (convertedFile != null) {
      fileName=FileUtil.stripExtension(fileName).concat(StringPool.PERIOD).concat(targetExtension);
      is=new FileInputStream(convertedFile);
      contentLength=convertedFile.length();
      contentType=MimeTypesUtil.getContentType(fileName);
    }
  }
  ServletResponseUtil.sendFile(request,response,fileName,is,contentLength,contentType);
}
