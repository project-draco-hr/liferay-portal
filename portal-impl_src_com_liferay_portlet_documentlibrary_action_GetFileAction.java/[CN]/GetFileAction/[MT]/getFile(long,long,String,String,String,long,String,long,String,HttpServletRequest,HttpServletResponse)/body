{
  if (name.startsWith("DLFE-")) {
    name=name.substring(5);
  }
  name=FileUtil.stripExtension(name);
  FileEntry fileEntry=null;
  if (Validator.isNotNull(uuid) && (groupId > 0)) {
    fileEntry=DLAppServiceUtil.getFileEntryByUuidAndGroupId(uuid,groupId);
    folderId=fileEntry.getFolderId();
  }
  if (fileEntryId > 0) {
    fileEntry=DLAppServiceUtil.getFileEntry(fileEntryId);
  }
 else   if (fileShortcutId <= 0) {
    if (Validator.isNotNull(title)) {
      fileEntry=DLAppServiceUtil.getFileEntry(groupId,folderId,title);
    }
 else     if (Validator.isNotNull(name)) {
      DLFileEntry dlFileEntry=DLFileEntryLocalServiceUtil.fetchFileEntryByName(groupId,folderId,name);
      if (dlFileEntry == null) {
        List<DLFileEntry> dlFileEntries=DLFileEntryLocalServiceUtil.getFileEntries(folderId,name);
        if (!dlFileEntries.isEmpty()) {
          dlFileEntry=dlFileEntries.get(0);
        }
      }
      if (dlFileEntry != null) {
        ThemeDisplay themeDisplay=(ThemeDisplay)request.getAttribute(WebKeys.THEME_DISPLAY);
        PermissionChecker permissionChecker=themeDisplay.getPermissionChecker();
        DLFileEntryPermission.check(permissionChecker,dlFileEntry,ActionKeys.VIEW);
        fileEntry=new LiferayFileEntry(dlFileEntry);
      }
    }
  }
 else {
    FileShortcut fileShortcut=DLAppServiceUtil.getFileShortcut(fileShortcutId);
    fileEntryId=fileShortcut.getToFileEntryId();
    fileEntry=DLAppServiceUtil.getFileEntry(fileEntryId);
  }
  if (Validator.isNull(version)) {
    if ((fileEntry != null) && Validator.isNotNull(fileEntry.getVersion())) {
      version=fileEntry.getVersion();
    }
 else {
      throw new NoSuchFileEntryException("{fileEntryId=" + fileEntryId + "}");
    }
  }
  FileVersion fileVersion=fileEntry.getFileVersion(version);
  InputStream is=fileVersion.getContentStream(true);
  String fileName=fileVersion.getTitle();
  String sourceExtension=fileVersion.getExtension();
  if (Validator.isNotNull(sourceExtension) && !fileName.endsWith(StringPool.PERIOD + sourceExtension)) {
    fileName+=StringPool.PERIOD + sourceExtension;
  }
  long contentLength=fileVersion.getSize();
  String contentType=fileVersion.getMimeType();
  if (Validator.isNotNull(targetExtension)) {
    String id=DLUtil.getTempFileId(fileEntry.getFileEntryId(),version);
    File convertedFile=DocumentConversionUtil.convert(id,is,sourceExtension,targetExtension);
    if (convertedFile != null) {
      fileName=FileUtil.stripExtension(fileName).concat(StringPool.PERIOD).concat(targetExtension);
      is=new FileInputStream(convertedFile);
      contentLength=convertedFile.length();
      contentType=MimeTypesUtil.getContentType(fileName);
    }
  }
  FlashMagicBytesUtil.Result flashMagicBytesUtilResult=FlashMagicBytesUtil.check(is);
  if (flashMagicBytesUtilResult.isFlash()) {
    fileName=FileUtil.stripExtension(fileName) + ".swf";
  }
  is=flashMagicBytesUtilResult.getInputStream();
  ServletResponseUtil.sendFile(request,response,fileName,is,contentLength,contentType);
}
