{
  InputStream is=null;
  try {
    long companyId=themeDisplay.getCompanyId();
    long userId=themeDisplay.getUserId();
    if (fileShortcutId <= 0) {
      DLFileEntryPermission.check(themeDisplay.getPermissionChecker(),folderId,name,ActionKeys.VIEW);
    }
 else {
      DLFileShortcut fileShortcut=DLFileShortcutServiceUtil.getFileShortcut(fileShortcutId);
      folderId=fileShortcut.getToFolderId();
      name=fileShortcut.getToName();
    }
    DLFileEntry fileEntry=DLFileEntryLocalServiceUtil.getFileEntry(folderId,name);
    if (version > 0) {
      is=DLFileEntryLocalServiceUtil.getFileAsStream(companyId,userId,folderId,name,version);
    }
 else {
      is=DLFileEntryLocalServiceUtil.getFileAsStream(companyId,userId,folderId,name);
    }
    String contentType=MimeTypesUtil.getContentType(name);
    ServletResponseUtil.sendFile(res,fileEntry.getTitleWithExtension(),is,contentType);
  }
 catch (  PortalException pe) {
    res.sendError(HttpServletResponse.SC_NOT_FOUND,pe.getMessage());
  }
 finally {
    ServletResponseUtil.cleanUp(is);
  }
}
