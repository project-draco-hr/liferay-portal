{
  long companyId=themeDisplay.getCompanyId();
  long userId=themeDisplay.getUserId();
  name=FileUtil.stripExtension(name);
  DLFileEntry fileEntry=null;
  if (Validator.isNotNull(uuid) && (groupId > 0)) {
    try {
      fileEntry=DLFileEntryLocalServiceUtil.getFileEntryByUuidAndGroupId(uuid,groupId);
      folderId=fileEntry.getFolderId();
      name=fileEntry.getName();
    }
 catch (    Exception e) {
    }
  }
  if (fileShortcutId <= 0) {
    if (Validator.isNotNull(name)) {
      fileEntry=DLFileEntryLocalServiceUtil.getFileEntry(groupId,folderId,name);
      title=fileEntry.getTitle();
    }
 else     if (Validator.isNotNull(title)) {
      fileEntry=DLFileEntryLocalServiceUtil.getFileEntryByTitle(groupId,folderId,title);
      name=fileEntry.getName();
    }
    DLFileEntryPermission.check(themeDisplay.getPermissionChecker(),fileEntry,ActionKeys.VIEW);
  }
 else {
    DLFileShortcut fileShortcut=DLFileShortcutServiceUtil.getFileShortcut(fileShortcutId);
    folderId=fileShortcut.getToFolderId();
    name=fileShortcut.getToName();
    fileEntry=DLFileEntryLocalServiceUtil.getFileEntry(groupId,folderId,name);
  }
  if (Validator.isNull(version)) {
    if (Validator.isNotNull(fileEntry.getVersion())) {
      version=fileEntry.getVersion();
    }
 else {
      throw new NoSuchFileEntryException();
    }
  }
  InputStream is=DLFileEntryLocalServiceUtil.getFileAsStream(companyId,userId,groupId,folderId,name,version);
  boolean converted=false;
  String fileName=fileEntry.getTitle();
  if (Validator.isNotNull(targetExtension)) {
    String id=DocumentConversionUtil.getTempFileId(fileEntry.getFileEntryId(),version);
    String sourceExtension=FileUtil.getExtension(fileName);
    InputStream convertedIS=DocumentConversionUtil.convert(id,is,sourceExtension,targetExtension);
    if ((convertedIS != null) && (convertedIS != is)) {
      fileName=FileUtil.stripExtension(fileEntry.getTitle()).concat(StringPool.PERIOD).concat(targetExtension);
      is=convertedIS;
      converted=true;
    }
  }
  int contentLength=0;
  if (!converted) {
    if (DLUtil.compareVersions(version,fileEntry.getVersion()) >= 0) {
      contentLength=(int)fileEntry.getSize();
    }
 else {
      DLFileVersion fileVersion=DLFileVersionLocalServiceUtil.getFileVersion(groupId,folderId,name,version);
      contentLength=(int)fileVersion.getSize();
    }
  }
  String contentType=MimeTypesUtil.getContentType(fileName);
  ServletResponseUtil.sendFile(request,response,fileName,is,contentLength,contentType);
}
