{
  InputStream is=null;
  try {
    long companyId=themeDisplay.getCompanyId();
    long userId=themeDisplay.getUserId();
    DLFileEntry fileEntry=null;
    if (Validator.isNotNull(uuid) && (groupId > 0)) {
      try {
        fileEntry=DLFileEntryLocalServiceUtil.getFileEntryByUuidAndGroupId(uuid,groupId);
        folderId=fileEntry.getFolderId();
        name=fileEntry.getName();
      }
 catch (      Exception e) {
      }
    }
    if (fileShortcutId <= 0) {
      DLFileEntryPermission.check(themeDisplay.getPermissionChecker(),groupId,folderId,name,ActionKeys.VIEW);
    }
 else {
      DLFileShortcut fileShortcut=DLFileShortcutServiceUtil.getFileShortcut(fileShortcutId);
      folderId=fileShortcut.getToFolderId();
      name=fileShortcut.getToName();
    }
    if (fileEntry == null) {
      fileEntry=DLFileEntryLocalServiceUtil.getFileEntry(groupId,folderId,name);
    }
    if (version == 0) {
      version=fileEntry.getVersion();
    }
    is=DLFileEntryLocalServiceUtil.getFileAsStream(companyId,userId,groupId,folderId,name,version);
    boolean converted=false;
    String fileName=fileEntry.getTitleWithExtension();
    if (Validator.isNotNull(targetExtension)) {
      String id=DocumentConversionUtil.getTempFileId(fileEntry.getFileEntryId(),version);
      String sourceExtension=FileUtil.getExtension(name);
      InputStream convertedIS=DocumentConversionUtil.convert(id,is,sourceExtension,targetExtension);
      if ((convertedIS != null) && (convertedIS != is)) {
        StringBuilder sb=new StringBuilder();
        sb.append(fileEntry.getTitle());
        sb.append(StringPool.PERIOD);
        sb.append(targetExtension);
        fileName=sb.toString();
        is=convertedIS;
        converted=true;
      }
    }
    int contentLength=0;
    if (!converted) {
      if (version >= fileEntry.getVersion()) {
        contentLength=fileEntry.getSize();
      }
 else {
        DLFileVersion fileVersion=DLFileVersionLocalServiceUtil.getFileVersion(folderId,name,version);
        contentLength=fileVersion.getSize();
      }
    }
    String contentType=MimeTypesUtil.getContentType(fileName);
    ServletResponseUtil.sendFile(response,fileName,is,contentLength,contentType);
  }
  finally {
    ServletResponseUtil.cleanUp(is);
  }
}
