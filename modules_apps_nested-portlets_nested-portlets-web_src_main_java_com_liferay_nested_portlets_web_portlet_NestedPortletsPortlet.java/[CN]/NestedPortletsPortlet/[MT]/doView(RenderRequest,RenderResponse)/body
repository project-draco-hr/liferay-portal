{
  ThemeDisplay themeDisplay=(ThemeDisplay)renderRequest.getAttribute(WebKeys.THEME_DISPLAY);
  String layoutTemplateId=StringPool.BLANK;
  try {
    NestedPortletsDisplayContext nestedPortletsDisplayContext=new NestedPortletsDisplayContext(PortalUtil.getHttpServletRequest(renderRequest),_nestedPortletsConfiguration);
    layoutTemplateId=nestedPortletsDisplayContext.getLayoutTemplateId();
  }
 catch (  ConfigurationException ce) {
    if (_log.isWarnEnabled()) {
      _log.warn(ce,ce);
    }
  }
  String templateId=StringPool.BLANK;
  String templateContent=StringPool.BLANK;
  Map<String,String> columnIds=new HashMap<>();
  if (Validator.isNotNull(layoutTemplateId)) {
    Theme theme=themeDisplay.getTheme();
    LayoutTemplate layoutTemplate=_layoutTemplateLocalService.getLayoutTemplate(layoutTemplateId,false,theme.getThemeId());
    String content=layoutTemplate.getContent();
    Matcher processColumnMatcher=_processColumnPattern.matcher(content);
    while (processColumnMatcher.find()) {
      String columnId=processColumnMatcher.group(2);
      if (Validator.isNotNull(columnId)) {
        columnIds.put(columnId,renderResponse.getNamespace() + StringPool.UNDERLINE + columnId);
      }
    }
    processColumnMatcher.reset();
    StringBundler sb=new StringBundler(4);
    sb.append(theme.getThemeId());
    sb.append(LayoutTemplateConstants.CUSTOM_SEPARATOR);
    sb.append(renderResponse.getNamespace());
    sb.append(layoutTemplateId);
    templateId=sb.toString();
    content=processColumnMatcher.replaceAll("$1\\${$2}$3");
    Matcher columnIdMatcher=_columnIdPattern.matcher(content);
    templateContent=columnIdMatcher.replaceAll("$1" + renderResponse.getNamespace() + "$2$3");
  }
  checkLayout(themeDisplay.getLayout(),columnIds.values());
  PortletDisplay portletDisplay=themeDisplay.getPortletDisplay();
  renderRequest.setAttribute(NestedPortletsConfiguration.TEMPLATE_ID + portletDisplay.getId(),templateId);
  renderRequest.setAttribute(NestedPortletsConfiguration.TEMPLATE_CONTENT + portletDisplay.getId(),templateContent);
  Map<String,Object> vmVariables=(Map<String,Object>)renderRequest.getAttribute(WebKeys.VM_VARIABLES + portletDisplay.getId());
  if (vmVariables != null) {
    vmVariables.putAll(columnIds);
  }
 else {
    renderRequest.setAttribute(WebKeys.VM_VARIABLES + portletDisplay.getId(),columnIds);
  }
  renderRequest.setAttribute(NestedPortletsConfiguration.class.getName(),_nestedPortletsConfiguration);
  super.include(viewTemplate,renderRequest,renderResponse);
}
