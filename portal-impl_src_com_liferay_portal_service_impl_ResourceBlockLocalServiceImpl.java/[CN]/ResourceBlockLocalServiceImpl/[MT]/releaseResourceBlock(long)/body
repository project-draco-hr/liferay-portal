{
  Session session=resourceBlockPersistence.openSession();
  while (true) {
    try {
      String sql=CustomSQLUtil.get(_RELEASE_RESOURCE_BLOCK);
      SQLQuery sqlQuery=session.createSynchronizedSQLQuery(sql);
      QueryPos qPos=QueryPos.getInstance(sqlQuery);
      qPos.add(resourceBlockId);
      if (sqlQuery.executeUpdate() > 0) {
        ResourceBlock resourceBlock=(ResourceBlock)session.get(ResourceBlockImpl.class,Long.valueOf(resourceBlockId));
        if (resourceBlock.getReferenceCount() == 0) {
          sql=CustomSQLUtil.get(_DELETE_RESOURCE_BLOCK);
          sqlQuery=session.createSynchronizedSQLQuery(sql);
          qPos=QueryPos.getInstance(sqlQuery);
          qPos.add(resourceBlockId);
          sqlQuery.executeUpdate();
          PermissionCacheUtil.clearResourceBlockCache(resourceBlock.getCompanyId(),resourceBlock.getGroupId(),resourceBlock.getName());
        }
      }
      resourceBlockPersistence.closeSession(session);
      break;
    }
 catch (    ORMException orme) {
      if (_log.isWarnEnabled()) {
        _log.warn("Unable to decrement reference count for resource " + "block " + resourceBlockId + ". Retrying.");
      }
    }
  }
}
