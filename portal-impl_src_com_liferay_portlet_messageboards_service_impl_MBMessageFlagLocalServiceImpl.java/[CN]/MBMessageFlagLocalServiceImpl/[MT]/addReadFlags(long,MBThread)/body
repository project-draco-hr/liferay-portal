{
  User user=userPersistence.findByPrimaryKey(userId);
  if (user.isDefaultUser()) {
    return;
  }
  long messageId=thread.getRootMessageId();
  int flag=MBMessageFlagImpl.READ_FLAG;
  MBMessageFlag messageFlag=mbMessageFlagPersistence.fetchByU_M_F(userId,messageId,flag);
  if (messageFlag == null) {
    long messageFlagId=counterLocalService.increment();
    messageFlag=mbMessageFlagPersistence.create(messageFlagId);
    messageFlag.setUserId(userId);
    messageFlag.setModifiedDate(thread.getLastPostDate());
    messageFlag.setThreadId(thread.getThreadId());
    messageFlag.setMessageId(messageId);
    messageFlag.setFlag(flag);
    mbMessageFlagPersistence.update(messageFlag,false);
    try {
      mbMessageFlagPersistence.update(messageFlag,false);
    }
 catch (    SystemException se) {
      if (_log.isWarnEnabled()) {
        _log.warn("Add failed, fetch {userId=" + userId + ", messageId="+ messageId+ ",flag="+ flag+ "}");
      }
      messageFlag=mbMessageFlagPersistence.fetchByU_M_F(userId,messageId,flag,false);
      if (messageFlag == null) {
        throw se;
      }
    }
  }
  if (!DateUtil.equals(messageFlag.getModifiedDate(),thread.getLastPostDate(),true)) {
    messageFlag.setModifiedDate(thread.getLastPostDate());
    mbMessageFlagPersistence.update(messageFlag,false);
  }
}
