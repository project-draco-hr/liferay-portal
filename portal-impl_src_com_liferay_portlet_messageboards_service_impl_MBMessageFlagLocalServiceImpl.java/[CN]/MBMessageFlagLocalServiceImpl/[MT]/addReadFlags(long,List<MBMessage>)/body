{
  User user=userPersistence.findByPrimaryKey(userId);
  if (user.isDefaultUser()) {
    return;
  }
  for (  MBMessage message : messages) {
    long messageId=message.getMessageId();
    int flag=MBMessageFlagImpl.READ_FLAG;
    MBMessageFlag messageFlag=mbMessageFlagPersistence.fetchByU_M_F(userId,messageId,flag);
    if (messageFlag == null) {
      long messageFlagId=counterLocalService.increment();
      messageFlag=mbMessageFlagPersistence.create(messageFlagId);
      messageFlag.setUserId(userId);
      messageFlag.setThreadId(message.getThreadId());
      messageFlag.setMessageId(messageId);
      messageFlag.setFlag(flag);
      mbMessageFlagPersistence.update(messageFlag,false);
      try {
        mbMessageFlagPersistence.update(messageFlag,false);
      }
 catch (      SystemException se) {
        if (_log.isWarnEnabled()) {
          _log.warn("Add failed, fetch {userId=" + userId + ", messageId="+ messageId+ ",flag="+ flag+ "}");
        }
        messageFlag=mbMessageFlagPersistence.fetchByU_M_F(userId,messageId,flag,false);
        if (messageFlag == null) {
          throw se;
        }
      }
    }
  }
}
