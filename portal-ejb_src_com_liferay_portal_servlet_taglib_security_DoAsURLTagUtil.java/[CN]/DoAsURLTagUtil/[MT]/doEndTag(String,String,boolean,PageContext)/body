{
  try {
    HttpServletRequest req=(HttpServletRequest)pageContext.getRequest();
    ThemeDisplay themeDisplay=(ThemeDisplay)req.getAttribute(WebKeys.THEME_DISPLAY);
    Company company=themeDisplay.getCompany();
    Layout layout=themeDisplay.getLayout();
    String doAsURL=PortalUtil.getLayoutURL(layout,themeDisplay,false);
    if (Validator.isNull(doAsUserId)) {
      doAsUserId=company.getDefaultUser().getUserId();
    }
    doAsURL=Http.addParameter(doAsURL,"doAsUserId",Encryptor.encrypt(company.getKeyObj(),doAsUserId));
    if (Validator.isNotNull(var)) {
      pageContext.setAttribute(var,doAsURL);
    }
 else     if (writeOutput) {
      pageContext.getOut().print(doAsURL);
    }
    return doAsURL;
  }
 catch (  Exception e) {
    throw new JspException(e);
  }
}
