{
  long ownerId=PortletKeys.PREFS_OWNER_ID_DEFAULT;
  int ownerType=PortletKeys.PREFS_OWNER_TYPE_LAYOUT;
  if (PortletConstants.hasUserId(portletId)) {
    ownerId=PortletConstants.getUserId(portletId);
    ownerType=PortletKeys.PREFS_OWNER_TYPE_USER;
  }
  PortletPreferences portletInstancePortletPreferences=PortletPreferencesLocalServiceUtil.getPreferences(layout.getCompanyId(),ownerId,ownerType,layout.getPlid(),portletId);
  PortletInstanceSettings portletInstanceSettings=new PortletInstanceSettings(portletInstancePortletPreferences);
  PortletPreferences companyPortletPreferences=PortletPreferencesLocalServiceUtil.getPreferences(layout.getCompanyId(),layout.getCompanyId(),PortletKeys.PREFS_OWNER_TYPE_LAYOUT_DEFAULTS_COMPANY,0,portletId);
  portletInstanceSettings.setCompanyPortletPreferences(companyPortletPreferences);
  PortletPreferences groupPortletPreferences=PortletPreferencesLocalServiceUtil.getPreferences(layout.getCompanyId(),layout.getGroupId(),PortletKeys.PREFS_OWNER_TYPE_LAYOUT_DEFAULTS_GROUP,0,portletId);
  portletInstanceSettings.setGroupPortletPreferences(groupPortletPreferences);
  portletInstanceSettings.setPortalProperties(getPortalProperties(portletId));
  return portletInstanceSettings;
}
