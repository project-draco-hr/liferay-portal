{
  if (Validator.isNull(classPKField)) {
    throw new IllegalArgumentException("classPKField is null");
  }
  PermissionChecker permissionChecker=PermissionThreadLocal.getPermissionChecker();
  long companyId=0;
  if (groupIds.length == 1) {
    long groupId=groupIds[0];
    Group group=GroupLocalServiceUtil.fetchGroup(groupId);
    if (group != null) {
      companyId=group.getCompanyId();
      long[] roleIds=getRoleIds(groupId);
      try {
        if (ResourcePermissionLocalServiceUtil.hasResourcePermission(companyId,className,ResourceConstants.SCOPE_GROUP,String.valueOf(groupId),roleIds,ActionKeys.VIEW)) {
          return sql;
        }
        if (ResourcePermissionLocalServiceUtil.hasResourcePermission(companyId,className,ResourceConstants.SCOPE_GROUP_TEMPLATE,String.valueOf(GroupConstants.DEFAULT_PARENT_GROUP_ID),roleIds,ActionKeys.VIEW)) {
          return sql;
        }
      }
 catch (      PortalException pe) {
        if (_log.isDebugEnabled()) {
          _log.debug("Unable to get resource permissions for " + className + " with group "+ groupId,pe);
        }
      }
    }
  }
 else {
    for (    long groupId : groupIds) {
      Group group=GroupLocalServiceUtil.fetchGroup(groupId);
      if (group == null) {
        continue;
      }
      if (companyId == 0) {
        companyId=group.getCompanyId();
        continue;
      }
      if (group.getCompanyId() != companyId) {
        throw new IllegalArgumentException("Permission queries across multiple portal instances " + "are not supported");
      }
    }
  }
  if (companyId == 0) {
    companyId=permissionChecker.getCompanyId();
  }
  try {
    if (ResourcePermissionLocalServiceUtil.hasResourcePermission(companyId,className,ResourceConstants.SCOPE_COMPANY,String.valueOf(companyId),getRoleIds(0),ActionKeys.VIEW)) {
      return sql;
    }
  }
 catch (  PortalException pe) {
    if (_log.isDebugEnabled()) {
      _log.debug("Unable to get resource permissions for " + className + " with company "+ companyId,pe);
    }
  }
  String permissionJoin=StringPool.BLANK;
  if (Validator.isNotNull(bridgeJoin)) {
    permissionJoin=bridgeJoin;
  }
  permissionJoin+=CustomSQLUtil.get(JOIN_RESOURCE_PERMISSION);
  StringBundler sb=new StringBundler(8);
  sb.append("((ResourcePermission.primKeyId = ");
  sb.append(classPKField);
  if (Validator.isNotNull(groupIdField) && (groupIds.length > 0)) {
    sb.append(") AND (");
    sb.append(groupIdField);
    if (groupIds.length > 1) {
      sb.append(" IN (");
      sb.append(StringUtil.merge(groupIds));
      sb.append(StringPool.CLOSE_PARENTHESIS);
    }
 else {
      sb.append(" = ");
      sb.append(groupIds[0]);
    }
  }
  sb.append("))");
  StringBundler defaultResourceForGroupAdminSB=new StringBundler(3);
  if (Validator.isNotNull(groupIdField) && (groupIds.length > 1)) {
    boolean groupAdmin=false;
    StringBundler defaultResource=new StringBundler(4);
    defaultResource.append("(ResourcePermission.primKeyId = 0) AND ");
    defaultResource.append("(ResourcePermission.roleId = ");
    defaultResource.append(permissionChecker.getOwnerRoleId());
    defaultResource.append(")");
    StringBundler groupAdminSB=new StringBundler(groupIds.length);
    groupAdminSB.append(groupIdField);
    groupAdminSB.append(" IN (");
    for (int i=0; i < groupIds.length; i++) {
      if (!isEnabled(0,groupIds[i])) {
        groupAdminSB.append(groupIds[i]);
        groupAdminSB.append(',');
        groupAdmin=true;
      }
    }
    groupAdminSB.setIndex(groupAdminSB.index() - 1);
    groupAdminSB.append(")");
    if (groupAdmin) {
      defaultResourceForGroupAdminSB.append(defaultResource);
      defaultResourceForGroupAdminSB.append(" AND ");
      defaultResourceForGroupAdminSB.append(groupAdminSB);
    }
 else {
      defaultResourceForGroupAdminSB.append("[$FALSE$] <> [$FALSE$]");
    }
  }
 else {
    defaultResourceForGroupAdminSB.append("[$FALSE$] <> [$FALSE$]");
  }
  String roleIdsOrOwnerIdSQL=getRoleIdsOrOwnerIdSQL(permissionChecker,groupIds,userIdField);
  int scope=ResourceConstants.SCOPE_INDIVIDUAL;
  permissionJoin=StringUtil.replace(permissionJoin,new String[]{"[$CLASS_NAME$]","[$COMPANY_ID$]","[$PRIM_KEYS$]","[$RESOURCE_SCOPE_INDIVIDUAL$]","[$ROLE_IDS_OR_OWNER_ID$]","[$DEFAULT_RESOURCE_FOR_GROUP_ADMIN$]"},new String[]{className,String.valueOf(companyId),sb.toString(),String.valueOf(scope),roleIdsOrOwnerIdSQL,defaultResourceForGroupAdminSB.toString()});
  int pos=sql.indexOf(_WHERE_CLAUSE);
  if (pos != -1) {
    return sql.substring(0,pos + 1).concat(permissionJoin).concat(sql.substring(pos + 1));
  }
  pos=sql.indexOf(_GROUP_BY_CLAUSE);
  if (pos != -1) {
    return sql.substring(0,pos + 1).concat(permissionJoin).concat(sql.substring(pos + 1));
  }
  pos=sql.indexOf(_ORDER_BY_CLAUSE);
  if (pos != -1) {
    return sql.substring(0,pos + 1).concat(permissionJoin).concat(sql.substring(pos + 1));
  }
  return sql.concat(StringPool.SPACE).concat(permissionJoin);
}
