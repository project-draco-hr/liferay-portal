{
  String completeURL=HttpUtil.getCompleteURL(request);
  if (isCompress(request) && !isInclude(request) && BrowserSnifferUtil.acceptsGzip(request)&& !isAlreadyFiltered(request)) {
    if (_log.isDebugEnabled()) {
      _log.debug("Compressing " + completeURL);
    }
    request.setAttribute(SKIP_FILTER,Boolean.TRUE);
    CompressionResponse compressionResponse=new CompressionResponse(response);
    processFilter(CompressionFilter.class,request,compressionResponse,filterChain);
    compressionResponse.finishResponse();
    request.setAttribute(WebKeys.COMPRESSED_BYTES,compressionResponse.getOutputStream().getCompressedBytes());
  }
 else {
    if (_log.isDebugEnabled()) {
      _log.debug("Not compressing " + completeURL);
    }
    processFilter(CompressionFilter.class,request,response,filterChain);
  }
}
