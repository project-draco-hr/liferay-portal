{
  long imageId=getImageId(request);
  Image image=null;
  if (imageId > 0) {
    image=ImageServiceUtil.getImage(imageId);
    String path=GetterUtil.getString(request.getPathInfo());
    if (path.startsWith("/user_female_portrait") || path.startsWith("/user_male_portrait") || path.startsWith("/user_portrait")) {
      image=getUserPortraitImageResized(image,imageId);
    }
 else {
      long dlFileEntryId=ParamUtil.getLong(request,"dlFileEntryId");
      boolean dlSmallImage=ParamUtil.getBoolean(request,"dlSmallImage");
      if ((dlFileEntryId > 0) && dlSmallImage) {
        image=getImageThumbnail(image,dlFileEntryId);
      }
    }
  }
 else {
    String uuid=ParamUtil.getString(request,"uuid");
    long groupId=ParamUtil.getLong(request,"groupId");
    try {
      if (Validator.isNotNull(uuid) && (groupId > 0)) {
        DLFileEntry dlFileEntry=DLFileEntryLocalServiceUtil.getFileEntryByUuidAndGroupId(uuid,groupId);
        image=ImageServiceUtil.getImage(dlFileEntry.getLargeImageId());
      }
    }
 catch (    PrincipalException pe) {
      throw pe;
    }
catch (    Exception e) {
    }
  }
  if (getDefault) {
    if (image == null) {
      if (_log.isWarnEnabled()) {
        _log.warn("Get a default image for " + imageId);
      }
      image=getDefaultImage(request,imageId);
    }
  }
  return image;
}
