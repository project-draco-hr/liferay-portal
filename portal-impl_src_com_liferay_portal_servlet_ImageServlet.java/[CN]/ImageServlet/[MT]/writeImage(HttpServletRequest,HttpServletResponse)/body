{
  Image image=getImage(request,true);
  if (image == null) {
    throw new NoSuchImageException("Image is null");
  }
 else {
    String contentType=null;
    if (!image.getType().equals(ImageConstants.TYPE_NOT_AVAILABLE)) {
      contentType=MimeTypesUtil.getContentType(image.getType());
      response.setContentType(contentType);
    }
    String fileName=ParamUtil.getString(request,"fileName");
    try {
      if (Validator.isNotNull(fileName)) {
        ServletResponseUtil.sendFile(response,fileName,getImageBytes(request,image),contentType);
      }
 else {
        ServletResponseUtil.write(response,getImageBytes(request,image));
      }
    }
 catch (    Exception e) {
      if (_log.isWarnEnabled()) {
        _log.warn(e,e);
      }
    }
  }
}
