{
  long lastModified=getLastModified(req);
  if (lastModified > 0) {
    long ifModifiedSince=req.getDateHeader(HttpHeaders.IF_MODIFIED_SINCE);
    if ((ifModifiedSince > 0) && (ifModifiedSince == lastModified)) {
      res.setStatus(HttpServletResponse.SC_NOT_MODIFIED);
      return;
    }
  }
  if (lastModified > 0) {
    res.setDateHeader(HttpHeaders.LAST_MODIFIED,lastModified);
  }
  try {
    writeImage(req,res);
  }
 catch (  NullPointerException npe) {
    PortalUtil.sendError(HttpServletResponse.SC_NOT_FOUND,new NoSuchImageException(),req,res);
  }
}
