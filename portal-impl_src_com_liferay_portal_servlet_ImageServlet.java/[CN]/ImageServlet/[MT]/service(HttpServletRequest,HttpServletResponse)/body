{
  try {
    long companyId=PortalUtil.getCompanyId(request);
    User user=PortalUtil.getUser(request);
    if (user == null) {
      Company company=CompanyLocalServiceUtil.getCompany(companyId);
      user=company.getDefaultUser();
    }
    PrincipalThreadLocal.setName(user.getUserId());
    PermissionChecker permissionChecker=PermissionCheckerFactoryUtil.create(user,true);
    PermissionThreadLocal.setPermissionChecker(permissionChecker);
    if (_lastModified) {
      long lastModified=getLastModified(request);
      if (lastModified > 0) {
        long ifModifiedSince=request.getDateHeader(HttpHeaders.IF_MODIFIED_SINCE);
        if ((ifModifiedSince > 0) && (ifModifiedSince == lastModified)) {
          response.setStatus(HttpServletResponse.SC_NOT_MODIFIED);
          return;
        }
      }
      if (lastModified > 0) {
        response.setDateHeader(HttpHeaders.LAST_MODIFIED,lastModified);
      }
    }
    writeImage(request,response);
  }
 catch (  Exception e) {
    PortalUtil.sendError(HttpServletResponse.SC_NOT_FOUND,e,request,response);
  }
}
