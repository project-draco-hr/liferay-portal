{
  String completeURL=HttpUtil.getCompleteURL(request);
  if (isMatchingURL(completeURL)) {
    if (_log.isDebugEnabled()) {
      _log.debug("Processing " + completeURL);
    }
    CacheResponse cacheResponse=new CacheResponse(response,StringPool.UTF8);
    processFilter(VelocityFilter.class,request,cacheResponse,filterChain);
    VelocityContext context=new VelocityContext();
    StringReader reader=new StringReader(new String(cacheResponse.getData()));
    StringWriter writer=new StringWriter();
    ThemeDisplay themeDisplay=null;
    try {
      long companyId=ParamUtil.getLong(request,"companyId");
      Company company=CompanyLocalServiceUtil.getCompanyById(companyId);
      String contextPath=PortalUtil.getPathContext();
      String languageId=ParamUtil.getString(request,"languageId");
      Locale locale=LocaleUtil.fromLanguageId(languageId);
      String themeId=ParamUtil.getString(request,"themeId");
      String colorSchemeId=ParamUtil.getString(request,"colorSchemeId");
      boolean wapTheme=BrowserSnifferUtil.isWap(request);
      Theme theme=ThemeLocalServiceUtil.getTheme(companyId,themeId,wapTheme);
      ColorScheme colorScheme=ThemeLocalServiceUtil.getColorScheme(companyId,theme.getThemeId(),colorSchemeId,wapTheme);
      themeDisplay=ThemeDisplayFactory.create();
      themeDisplay.setCompany(company);
      themeDisplay.setLocale(locale);
      themeDisplay.setLookAndFeel(contextPath,theme,colorScheme);
      themeDisplay.setPathContext(contextPath);
      request.setAttribute(WebKeys.THEME_DISPLAY,themeDisplay);
      VelocityVariables.insertVariables(context,request);
      Velocity.evaluate(context,writer,VelocityFilter.class.getName(),reader);
    }
 catch (    Exception e) {
      _log.error(e,e);
    }
 finally {
      try {
        if (themeDisplay != null) {
          ThemeDisplayFactory.recycle(themeDisplay);
        }
      }
 catch (      Exception e) {
      }
    }
    CacheResponseData data=new CacheResponseData(writer.toString().getBytes(StringPool.UTF8),cacheResponse.getContentType(),cacheResponse.getHeaders());
    CacheResponseUtil.write(response,data);
  }
 else {
    if (_log.isDebugEnabled()) {
      _log.debug("Not processing " + completeURL);
    }
    processFilter(VelocityFilter.class,request,response,filterChain);
  }
}
