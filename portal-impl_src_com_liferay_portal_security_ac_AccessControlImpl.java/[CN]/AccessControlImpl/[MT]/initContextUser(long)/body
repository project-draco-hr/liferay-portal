{
  try {
    User user=UserLocalServiceUtil.getUser(userId);
    CompanyThreadLocal.setCompanyId(user.getCompanyId());
    PermissionChecker permissionChecker=PermissionCheckerFactoryUtil.create(user);
    PermissionThreadLocal.setPermissionChecker(permissionChecker);
    PrincipalThreadLocal.setName(userId);
    AccessControlThreadLocal.setRemoteAccess(false);
  }
 catch (  Exception e) {
    throw new AuthException(e.getMessage(),e);
  }
}
