{
  PropsUtilAdvice.setProps(PropsKeys.INTRABAND_MAILBOX_REAPER_THREAD_ENABLED,Boolean.TRUE.toString());
  PropsUtilAdvice.setProps(PropsKeys.INTRABAND_MAILBOX_STORAGE_LIFE,String.valueOf(0));
  Assert.assertEquals(0,MailboxUtil.depositMail(ByteBuffer.allocate(0)));
  Assert.assertEquals(1,MailboxUtil.depositMail(ByteBuffer.allocate(0)));
  Assert.assertEquals(2,MailboxUtil.depositMail(ByteBuffer.allocate(0)));
  Assert.assertEquals(3,MailboxUtil.depositMail(ByteBuffer.allocate(0)));
  Thread reaperThread=null;
  for (  Thread thread : ThreadUtil.getThreads()) {
    if ((thread != null) && thread.getName().equals(MailboxUtil.class.getName())) {
      reaperThread=thread;
      break;
    }
  }
  Assert.assertNotNull(reaperThread);
  reaperThread.interrupt();
  while (reaperThread.isInterrupted())   ;
  Assert.assertTrue(reaperThread.isAlive());
  BlockingQueue<Object> overdueMailQueue=ReflectionTestUtil.getFieldValue(MailboxUtil.class,"_overdueMailQueue");
  while (!overdueMailQueue.isEmpty())   ;
  ReceiptStubAdvice._throwException=true;
  RecorderUncaughtExceptionHandler recorderUncaughtExceptionHandler=new RecorderUncaughtExceptionHandler();
  reaperThread.setUncaughtExceptionHandler(recorderUncaughtExceptionHandler);
  overdueMailQueue.offer(createReceiptStub());
  recorderUncaughtExceptionHandler.await(10 * Time.MINUTE);
  Assert.assertFalse("Reaper thread " + reaperThread + " failed to join back after waiting for 10 mins",reaperThread.isAlive());
  Assert.assertSame(reaperThread,RecorderUncaughtExceptionHandler._thread);
  Throwable throwable=RecorderUncaughtExceptionHandler._throwable;
  Assert.assertSame(IllegalStateException.class,throwable.getClass());
  Assert.assertFalse(reaperThread.isAlive());
}
