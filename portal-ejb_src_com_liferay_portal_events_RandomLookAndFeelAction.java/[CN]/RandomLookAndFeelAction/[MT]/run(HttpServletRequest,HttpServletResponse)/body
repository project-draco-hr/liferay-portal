{
  try {
    PropsUtil.set(PropsUtil.LAST_MODIFIED_CHECK,"false");
    ThemeDisplay themeDisplay=(ThemeDisplay)req.getAttribute(WebKeys.THEME_DISPLAY);
    if (!themeDisplay.isSignedIn()) {
      return;
    }
    String requestURI=GetterUtil.getString(req.getRequestURI());
    if (!requestURI.endsWith("/portal/layout")) {
      return;
    }
    Layout layout=themeDisplay.getLayout();
    if ((layout == null) || layout.isShared()) {
      return;
    }
    Randomizer randomizer=Randomizer.getInstance();
    List themes=ThemeLocalUtil.getThemes(themeDisplay.getCompanyId());
    if (themes.size() > 0) {
      Theme theme=(Theme)themes.get(randomizer.nextInt(themes.size()));
      List colorSchemes=theme.getColorSchemes();
      ColorScheme colorScheme=(ColorScheme)colorSchemes.get(randomizer.nextInt(colorSchemes.size()));
      LayoutServiceUtil.updateLookAndFeel(layout.getLayoutId(),layout.getOwnerId(),theme.getThemeId(),colorScheme.getColorSchemeId());
      themeDisplay.setLookAndFeel(theme,colorScheme);
      req.setAttribute(WebKeys.THEME,theme);
      req.setAttribute(WebKeys.COLOR_SCHEME,colorScheme);
    }
  }
 catch (  Exception e) {
    _log.error(StackTraceUtil.getStackTrace(e));
    throw new ActionException(e);
  }
}
