{
  ThemeDisplay themeDisplay=(ThemeDisplay)request.getAttribute(WebKeys.THEME_DISPLAY);
  PermissionChecker permissionChecker=themeDisplay.getPermissionChecker();
  long groupId=ParamUtil.getLong(request,"groupId",themeDisplay.getScopeGroupId());
  if (primaryKey > 0) {
    try {
      groupId=getGroupId(primaryKey);
    }
 catch (    Exception e) {
      if (_log.isDebugEnabled()) {
        _log.debug(e,e);
      }
    }
  }
  if ((plid != LayoutConstants.DEFAULT_PLID) && (groupId == themeDisplay.getScopeGroupId())) {
    try {
      Layout layout=LayoutLocalServiceUtil.getLayout(plid);
      LayoutTypePortlet layoutTypePortlet=(LayoutTypePortlet)layout.getLayoutType();
      for (      String portletId : _portletIds) {
        if (layoutTypePortlet.hasPortletId(portletId) && LayoutPermissionUtil.contains(permissionChecker,layout,ActionKeys.VIEW)) {
          return new Object[]{plid,portletId};
        }
      }
    }
 catch (    NoSuchLayoutException nsle) {
    }
  }
  for (  String portletId : _portletIds) {
    plid=PortalUtil.getPlidFromPortletId(groupId,portletId);
    if (plid == LayoutConstants.DEFAULT_PLID) {
      continue;
    }
    Layout layout=LayoutLocalServiceUtil.getLayout(plid);
    if (LayoutPermissionUtil.contains(permissionChecker,layout,ActionKeys.VIEW)) {
      LayoutTypePortlet layoutTypePortlet=(LayoutTypePortlet)layout.getLayoutType();
      for (      String curPortletId : layoutTypePortlet.getPortletIds()) {
        String curRootPortletId=PortletConstants.getRootPortletId(curPortletId);
        if (portletId.equals(curRootPortletId)) {
          portletId=curPortletId;
          break;
        }
      }
      return new Object[]{plid,portletId};
    }
  }
  throw new NoSuchLayoutException();
}
