{
  if (_log.isDebugEnabled()) {
    _log.debug("Query " + query);
  }
  Hits hits=null;
  org.apache.lucene.search.IndexSearcher indexSearcher=null;
  org.apache.lucene.search.Sort luceneSort=null;
  try {
    indexSearcher=LuceneHelperUtil.getSearcher(companyId,true);
    indexSearcher.setDefaultFieldSortScoring(true,true);
    indexSearcher.setSimilarity(new FieldWeightSimilarity());
    if (sorts != null) {
      SortField[] sortFields=new SortField[sorts.length];
      for (int i=0; i < sorts.length; i++) {
        Sort sort=sorts[i];
        sortFields[i]=new SortField(sort.getFieldName(),sort.getType(),sort.isReverse());
      }
      luceneSort=new org.apache.lucene.search.Sort(sortFields);
    }
 else {
      luceneSort=new org.apache.lucene.search.Sort();
    }
    long startTime=System.currentTimeMillis();
    TopFieldDocs topFieldDocs=indexSearcher.search((org.apache.lucene.search.Query)QueryTranslatorUtil.translate(query),null,PropsValues.INDEX_SEARCH_LIMIT,luceneSort);
    long endTime=System.currentTimeMillis();
    float searchTime=(float)(endTime - startTime) / Time.SECOND;
    hits=toHits(indexSearcher,topFieldDocs,query,startTime,searchTime,start,end);
  }
 catch (  BooleanQuery.TooManyClauses tmc) {
    int maxClauseCount=BooleanQuery.getMaxClauseCount();
    BooleanQuery.setMaxClauseCount(Integer.MAX_VALUE);
    try {
      long startTime=System.currentTimeMillis();
      TopFieldDocs topFieldDocs=indexSearcher.search((org.apache.lucene.search.Query)QueryTranslatorUtil.translate(query),null,PropsValues.INDEX_SEARCH_LIMIT,luceneSort);
      long endTime=System.currentTimeMillis();
      float searchTime=(float)(endTime - startTime) / Time.SECOND;
      hits=toHits(indexSearcher,topFieldDocs,query,startTime,searchTime,start,end);
    }
 catch (    Exception e) {
      throw new SearchException(e);
    }
 finally {
      BooleanQuery.setMaxClauseCount(maxClauseCount);
    }
  }
catch (  ParseException pe) {
    _log.error("Query: " + query,pe);
    return new HitsImpl();
  }
catch (  Exception e) {
    throw new SearchException(e);
  }
 finally {
    try {
      if (indexSearcher != null) {
        indexSearcher.close();
      }
    }
 catch (    IOException ioe) {
      throw new SearchException(ioe);
    }
  }
  if (_log.isDebugEnabled()) {
    _log.debug("Search found " + hits.getLength() + " results in "+ hits.getSearchTime()+ "ms");
  }
  return hits;
}
