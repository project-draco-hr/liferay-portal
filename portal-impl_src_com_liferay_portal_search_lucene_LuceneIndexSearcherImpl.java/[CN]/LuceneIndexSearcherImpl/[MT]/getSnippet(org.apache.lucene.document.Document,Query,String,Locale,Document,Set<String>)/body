{
  TermCollectingFormatter termCollectingFormatter=new TermCollectingFormatter();
  String snippetField=DocumentImpl.getLocalizedName(locale,field);
  String[] values=doc.getValues(snippetField);
  String snippet=null;
  try {
    org.apache.lucene.search.Query luceneQuery=(org.apache.lucene.search.Query)QueryTranslatorUtil.translate(query);
    if ((values != null) && (values.length > 0)) {
      snippet=LuceneHelperUtil.getSnippet(luceneQuery,snippetField,StringUtil.merge(values),termCollectingFormatter);
    }
    if ((values == null) || (values.length == 0) || Validator.isNull(snippet)) {
      snippetField=field;
      values=doc.getValues(snippetField);
      if (Validator.isNull(values)) {
        return StringPool.BLANK;
      }
      snippet=LuceneHelperUtil.getSnippet(luceneQuery,field,StringUtil.merge(values),termCollectingFormatter);
    }
    if (Validator.isNull(snippet)) {
      return StringPool.BLANK;
    }
    matchingTerms.addAll(termCollectingFormatter.getCollectedTerms());
  }
 catch (  ParseException pe) {
    _log.error("Query " + query,pe);
  }
  hitDoc.addText(Field.SNIPPET + StringPool.UNDERLINE + snippetField,snippet);
  return snippet;
}
