{
  if (_log.isDebugEnabled()) {
    _log.debug("Query " + query);
  }
  Hits hits=null;
  org.apache.lucene.search.IndexSearcher indexSearcher=null;
  Map<String,Facet> facets=null;
  BrowseRequest browseRequest=null;
  Browsable browsable=null;
  try {
    indexSearcher=LuceneHelperUtil.getSearcher(searchContext.getCompanyId(),true);
    List<FacetHandler<?>> facetHandlers=new ArrayList<FacetHandler<?>>();
    facets=searchContext.getFacets();
    for (    Facet facet : facets.values()) {
      if (facet.isStatic()) {
        continue;
      }
      FacetConfiguration facetConfiguration=facet.getFacetConfiguration();
      if (facet instanceof MultiValueFacet) {
        MultiValueFacetHandler multiValueFacetHandler=new MultiValueFacetHandler(facetConfiguration.getFieldName(),facetConfiguration.getFieldName());
        JSONObject dataJSONObject=facetConfiguration.getData();
        if (dataJSONObject.has("maxTerms")) {
          multiValueFacetHandler.setMaxItems(dataJSONObject.getInt("maxTerms"));
        }
        facetHandlers.add(multiValueFacetHandler);
      }
 else       if (facet instanceof RangeFacet) {
        List<String> ranges=new ArrayList<String>();
        JSONObject dataJSONObject=facetConfiguration.getData();
        JSONArray rangesJSONArray=dataJSONObject.getJSONArray("ranges");
        if (rangesJSONArray != null) {
          for (int i=0; i < rangesJSONArray.length(); i++) {
            JSONObject rangeJSONObject=rangesJSONArray.getJSONObject(i);
            ranges.add(rangeJSONObject.getString("range"));
          }
        }
        RangeFacetHandler rangeFacetHandler=new RangeFacetHandler(facetConfiguration.getFieldName(),facetConfiguration.getFieldName(),ranges);
        rangeFacetHandler.setTermCountSize(TermCountSize.large);
        facetHandlers.add(rangeFacetHandler);
      }
 else       if (facet instanceof SimpleFacet) {
        SimpleFacetHandler simpleFacetHandler=new SimpleFacetHandler(facetConfiguration.getFieldName(),facetConfiguration.getFieldName());
        facetHandlers.add(simpleFacetHandler);
      }
    }
    BoboIndexReader boboIndexReader=BoboIndexReader.getInstance(indexSearcher.getIndexReader(),facetHandlers);
    SortField[] sortFields=new SortField[0];
    Sort[] sorts=searchContext.getSorts();
    if (sorts != null) {
      sortFields=new SortField[sorts.length];
      for (int i=0; i < sorts.length; i++) {
        Sort sort=sorts[i];
        sortFields[i]=new SortField(sort.getFieldName(),sort.getType(),sort.isReverse());
      }
    }
    browseRequest=new BrowseRequest();
    for (    Facet facet : facets.values()) {
      if (facet.isStatic()) {
        continue;
      }
      FacetConfiguration facetConfiguration=facet.getFacetConfiguration();
      FacetSpec facetSpec=new FacetSpec();
      facetSpec.setOrderBy(FacetSortSpec.valueOf(facetConfiguration.getOrder()));
      browseRequest.setFacetSpec(facet.getFieldName(),facetSpec);
    }
    browseRequest.setCount(PropsValues.INDEX_SEARCH_LIMIT);
    browseRequest.setOffset(0);
    browseRequest.setQuery((org.apache.lucene.search.Query)QueryTranslatorUtil.translate(query));
    browseRequest.setSort(sortFields);
    browsable=new BoboBrowser(boboIndexReader);
    long startTime=System.currentTimeMillis();
    BrowseResult browseResult=browsable.browse(browseRequest);
    BrowseHit[] browseHits=browseResult.getHits();
    long endTime=System.currentTimeMillis();
    float searchTime=(float)(endTime - startTime) / Time.SECOND;
    hits=toHits(indexSearcher,new HitDocs(browseHits),query,startTime,searchTime,searchContext.getStart(),searchContext.getEnd());
    Map<String,FacetAccessible> facetMap=browseResult.getFacetMap();
    for (    Map.Entry<String,FacetAccessible> entry : facetMap.entrySet()) {
      Facet facet=facets.get(entry.getKey());
      FacetAccessible facetAccessible=entry.getValue();
      FacetCollector facetCollector=new BoboFacetCollector(entry.getKey(),facetAccessible);
      facet.setFacetCollector(facetCollector);
    }
  }
 catch (  BooleanQuery.TooManyClauses tmc) {
    int maxClauseCount=BooleanQuery.getMaxClauseCount();
    BooleanQuery.setMaxClauseCount(Integer.MAX_VALUE);
    try {
      long startTime=System.currentTimeMillis();
      BrowseResult result=browsable.browse(browseRequest);
      BrowseHit[] browseHits=result.getHits();
      long endTime=System.currentTimeMillis();
      float searchTime=(float)(endTime - startTime) / Time.SECOND;
      hits=toHits(indexSearcher,new HitDocs(browseHits),query,startTime,searchTime,searchContext.getStart(),searchContext.getEnd());
      Map<String,FacetAccessible> facetMap=result.getFacetMap();
      for (      Map.Entry<String,FacetAccessible> entry : facetMap.entrySet()) {
        Facet facet=facets.get(entry.getKey());
        FacetAccessible facetAccessible=entry.getValue();
        FacetCollector facetCollector=new BoboFacetCollector(entry.getKey(),facetAccessible);
        facet.setFacetCollector(facetCollector);
      }
    }
 catch (    Exception e) {
      throw new SearchException(e);
    }
 finally {
      BooleanQuery.setMaxClauseCount(maxClauseCount);
    }
  }
catch (  ParseException pe) {
    _log.error("Query " + query,pe);
    return new HitsImpl();
  }
catch (  Exception e) {
    throw new SearchException(e);
  }
 finally {
    if (browsable != null) {
      try {
        browsable.close();
      }
 catch (      IOException ioe) {
        _log.error(ioe,ioe);
      }
    }
    if (indexSearcher != null) {
      try {
        indexSearcher.close();
      }
 catch (      IOException ioe) {
        _log.error(ioe,ioe);
      }
    }
  }
  if (_log.isDebugEnabled()) {
    _log.debug("Search found " + hits.getLength() + " results in "+ hits.getSearchTime()+ "ms");
  }
  return hits;
}
