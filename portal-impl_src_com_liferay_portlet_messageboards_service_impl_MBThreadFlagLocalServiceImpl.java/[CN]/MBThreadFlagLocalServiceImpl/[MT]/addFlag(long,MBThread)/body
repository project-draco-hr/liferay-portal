{
  User user=userPersistence.findByPrimaryKey(userId);
  if (user.isDefaultUser()) {
    return;
  }
  long threadId=thread.getThreadId();
  MBThreadFlag threadFlag=mbThreadFlagPersistence.fetchByU_T(userId,threadId);
  if (threadFlag == null) {
    long messageFlagId=counterLocalService.increment();
    threadFlag=mbThreadFlagPersistence.create(messageFlagId);
    threadFlag.setUserId(userId);
    threadFlag.setModifiedDate(thread.getLastPostDate());
    threadFlag.setThreadId(threadId);
    try {
      mbThreadFlagPersistence.update(threadFlag,false);
    }
 catch (    SystemException se) {
      if (_log.isWarnEnabled()) {
        _log.warn("Add failed, fetch {userId=" + userId + ", threadId="+ threadId+ "}");
      }
      threadFlag=mbThreadFlagPersistence.fetchByU_T(userId,threadId,false);
      if (threadFlag == null) {
        throw se;
      }
    }
  }
 else   if (!DateUtil.equals(threadFlag.getModifiedDate(),thread.getLastPostDate(),true)) {
    threadFlag.setModifiedDate(thread.getLastPostDate());
    mbThreadFlagPersistence.update(threadFlag,false);
  }
}
