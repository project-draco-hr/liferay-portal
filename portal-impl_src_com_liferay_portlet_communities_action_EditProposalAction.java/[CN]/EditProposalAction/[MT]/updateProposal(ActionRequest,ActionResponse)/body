{
  ThemeDisplay themeDisplay=(ThemeDisplay)req.getAttribute(WebKeys.THEME_DISPLAY);
  Layout layout=themeDisplay.getLayout();
  long proposalId=ParamUtil.getLong(req,"proposalId");
  String description=ParamUtil.getString(req,"description");
  if (proposalId <= 0) {
    long groupId=ParamUtil.getLong(req,"groupId");
    long reviewUserId=ParamUtil.getLong(req,"reviewUserId");
    String className=ParamUtil.getString(req,"className");
    String classPK=ParamUtil.getString(req,"classPK");
    String name=StringPool.BLANK;
    if (className.equals(Layout.class.getName())) {
      layout=LayoutLocalServiceUtil.getLayout(GetterUtil.getLong(classPK));
      name=layout.getName(LocaleUtil.getDefault());
    }
 else     if (className.equals(Portlet.class.getName())) {
      String portletId=classPK.substring(classPK.indexOf(PortletImpl.LAYOUT_SEPARATOR) + PortletImpl.LAYOUT_SEPARATOR.length());
      name=PortalUtil.getPortletTitle(portletId,themeDisplay.getCompanyId(),LocaleUtil.getDefault().toString());
    }
    boolean addCommunityPermissions=true;
    boolean addGuestPermissions=true;
    TasksProposalServiceUtil.addProposal(groupId,className,classPK,name,description,reviewUserId,addCommunityPermissions,addGuestPermissions);
  }
 else {
    int dueDateMonth=ParamUtil.getInteger(req,"dueDateMonth");
    int dueDateDay=ParamUtil.getInteger(req,"dueDateDay");
    int dueDateYear=ParamUtil.getInteger(req,"dueDateYear");
    int dueDateHour=ParamUtil.getInteger(req,"dueDateHour");
    int dueDateMinute=ParamUtil.getInteger(req,"dueDateMinute");
    TasksProposalServiceUtil.updateProposal(proposalId,description,dueDateMonth,dueDateDay,dueDateYear,dueDateHour,dueDateMinute);
    long groupId=ParamUtil.getLong(req,"groupId");
    Group group=GroupLocalServiceUtil.getGroup(groupId);
    int workflowStages=group.getWorkflowStages();
    long[][] userIdsPerStage=new long[workflowStages][0];
    for (int i=2; i <= workflowStages; i++) {
      long[] userIds=StringUtil.split(ParamUtil.getString(req,"reviewUserIds_" + i),0L);
      userIdsPerStage[i - 2]=userIds;
    }
    TasksReviewServiceUtil.updateReviews(proposalId,userIdsPerStage);
  }
}
