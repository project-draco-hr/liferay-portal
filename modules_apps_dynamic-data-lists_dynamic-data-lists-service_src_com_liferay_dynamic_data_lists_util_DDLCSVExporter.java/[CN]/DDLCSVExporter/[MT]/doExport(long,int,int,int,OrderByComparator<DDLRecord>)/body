{
  StringBundler sb=new StringBundler();
  DDMStructure ddmStructure=getDDMStructure(recordSetId);
  List<DDMFormField> ddmFormFields=getDDMFormFields(ddmStructure);
  for (  DDMFormField ddmFormField : ddmFormFields) {
    LocalizedValue label=ddmFormField.getLabel();
    sb.append(label.getString(getLocale()));
    sb.append(CharPool.COMMA);
  }
  sb.append(LanguageUtil.get(getLocale(),"status"));
  sb.append(StringPool.NEW_LINE);
  List<DDLRecord> records=DDLRecordLocalServiceUtil.getRecords(recordSetId,status,start,end,orderByComparator);
  Iterator<DDLRecord> iterator=records.iterator();
  while (iterator.hasNext()) {
    DDLRecord record=iterator.next();
    DDLRecordVersion recordVersion=record.getRecordVersion();
    DDMFormValues ddmFormValues=StorageEngineUtil.getDDMFormValues(recordVersion.getDDMStorageId());
    Fields fields=DDMFormValuesToFieldsConverterUtil.convert(ddmStructure,ddmFormValues);
    for (    DDMFormField ddmFormField : ddmFormFields) {
      String name=ddmFormField.getName();
      String value=StringPool.BLANK;
      if (fields.contains(name)) {
        Field field=fields.get(name);
        value=field.getRenderedValue(getLocale());
      }
      sb.append(CSVUtil.encode(value));
      sb.append(CharPool.COMMA);
    }
    sb.append(getStatusMessage(recordVersion.getStatus()));
    if (iterator.hasNext()) {
      sb.append(StringPool.NEW_LINE);
    }
  }
  String csv=sb.toString();
  return csv.getBytes();
}
