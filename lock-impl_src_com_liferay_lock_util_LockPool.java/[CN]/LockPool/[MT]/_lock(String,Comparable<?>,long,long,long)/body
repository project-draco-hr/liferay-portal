{
  Map<Comparable<?>,Lock> locksByPK=_getLocks(className,pk);
  Lock lock=locksByPK.get(pk);
  if (lock != null && lock.isExpired()) {
    _unlock(className,pk);
    lock=null;
  }
 else   if ((lock != null) && (lock.getUserId() != userId)) {
    throw new DuplicateLockException(lock);
  }
  if (lock == null) {
    lock=new LockImpl(className,pk,companyId,userId,expirationTime);
    locksByPK.put(pk,lock);
    _getLocksByCompanyId(companyId).add(lock);
    _getLocksByUserId(userId).add(lock);
  }
 else {
    lock.setExpirationTime(expirationTime);
  }
}
