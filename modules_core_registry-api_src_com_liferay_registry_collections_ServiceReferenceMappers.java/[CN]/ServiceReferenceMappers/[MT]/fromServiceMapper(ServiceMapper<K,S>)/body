{
  return new ServiceReferenceMapper<K,S>(){
    @Override public void map(    ServiceReference<S> serviceReference,    Emitter<K> emitter){
      Registry registry=RegistryUtil.getRegistry();
      S service=registry.getService(serviceReference);
      try {
        serviceMapper.map(service,emitter);
      }
  finally {
        registry.ungetService(serviceReference);
      }
    }
  }
;
}
