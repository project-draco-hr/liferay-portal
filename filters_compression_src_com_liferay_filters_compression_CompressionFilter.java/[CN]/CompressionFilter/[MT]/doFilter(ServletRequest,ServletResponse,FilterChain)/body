{
  if (_log.isDebugEnabled()) {
    if (useCompressionFilter) {
      _log.debug("Compression is enabled");
    }
 else {
      _log.debug("Compression is disabled");
    }
  }
  HttpServletRequest request=(HttpServletRequest)req;
  HttpServletResponse response=(HttpServletResponse)res;
  request.setCharacterEncoding(ENCODING);
  String completeURL=Http.getCompleteURL(request);
  if (useCompressionFilter && _isCompress(request) && !_isInclude(request)&& BrowserSniffer.acceptsGzip(request)&& !_isAlreadyFiltered(request)) {
    if (_log.isDebugEnabled()) {
      _log.debug("Compressing " + completeURL);
    }
    request.setAttribute(_ALREADY_FILTERED,Boolean.TRUE);
    CompressionResponse compressionResponse=new CompressionResponse(response);
    chain.doFilter(req,compressionResponse);
    compressionResponse.finishResponse();
  }
 else {
    if (_log.isDebugEnabled()) {
      _log.debug("Not compressing " + completeURL);
    }
    chain.doFilter(req,res);
  }
}
