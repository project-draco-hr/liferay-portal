{
  if (_logger.isDebugEnabled()) {
    _logger.debug("Copying file {} to {}",sourceSyncFile.getFilePathName(),targetSyncFile.getFilePathName());
  }
  Path tempFilePath=FileUtil.getTempFilePath(targetSyncFile);
  Files.copy(Paths.get(sourceSyncFile.getFilePathName()),tempFilePath,StandardCopyOption.REPLACE_EXISTING);
  FileKeyUtil.writeFileKey(tempFilePath,String.valueOf(targetSyncFile.getSyncFileId()),false);
  Watcher watcher=WatcherManager.getWatcher(getSyncAccountId());
  watcher.addDownloadedFilePathName(targetSyncFile.getFilePathName());
  boolean exists=Files.exists(Paths.get(targetSyncFile.getFilePathName()));
  try {
    Files.move(tempFilePath,Paths.get(targetSyncFile.getFilePathName()),StandardCopyOption.ATOMIC_MOVE,StandardCopyOption.REPLACE_EXISTING);
  }
 catch (  AccessDeniedException ade) {
    targetSyncFile.setState(SyncFile.STATE_ERROR);
    targetSyncFile.setUiEvent(SyncFile.UI_EVENT_ACCESS_DENIED_LOCAL);
    SyncFileService.update(targetSyncFile);
    return;
  }
  targetSyncFile.setState(SyncFile.STATE_SYNCED);
  if (GetterUtil.getBoolean(targetSyncFile.getLocalExtraSettingValue("restoreEvent"))) {
    targetSyncFile.unsetLocalExtraSetting("restoreEvent");
    targetSyncFile.setUiEvent(SyncFile.UI_EVENT_RESTORED_REMOTE);
  }
 else   if (exists) {
    targetSyncFile.setUiEvent(SyncFile.UI_EVENT_DOWNLOADED_UPDATE);
  }
 else {
    targetSyncFile.setUiEvent(SyncFile.UI_EVENT_DOWNLOADED_NEW);
  }
  SyncFileService.update(targetSyncFile);
  IODeltaUtil.copyChecksums(sourceSyncFile,targetSyncFile);
}
