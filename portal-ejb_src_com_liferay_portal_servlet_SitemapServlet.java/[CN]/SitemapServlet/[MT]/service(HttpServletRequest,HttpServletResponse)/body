{
  if (!PortalInstances.matches()) {
    return;
  }
  res.setContentType("text/xml; charset=utf-8");
  OutputStreamWriter out=new OutputStreamWriter(res.getOutputStream());
  try {
    String hostName=PortalUtil.getHost(req);
    String ownerId=req.getParameter("ownerId");
    LayoutSet layoutSet=null;
    if (ownerId != null) {
      layoutSet=LayoutSetLocalServiceUtil.getLayoutSet(ownerId);
    }
 else {
      layoutSet=LayoutSetLocalServiceUtil.getLayoutSet(_companyId,hostName);
    }
    if (Validator.isNull(hostName)) {
      hostName=PortalUtil.getHost(req);
    }
    String portalURL=PortalUtil.getPortalURL(hostName,req.getServerPort(),req.isSecure());
    String sitemap=SitemapUtil.getSitemap(layoutSet.getOwnerId(),portalURL + _mainPath);
    if (!res.isCommitted()) {
      out.write(sitemap);
    }
  }
 catch (  NoSuchLayoutSetException e) {
    res.sendError(404);
  }
catch (  Exception e) {
    if (_log.isWarnEnabled()) {
      _log.warn(StackTraceUtil.getStackTrace(e));
    }
  }
 finally {
    out.flush();
    out.close();
  }
}
