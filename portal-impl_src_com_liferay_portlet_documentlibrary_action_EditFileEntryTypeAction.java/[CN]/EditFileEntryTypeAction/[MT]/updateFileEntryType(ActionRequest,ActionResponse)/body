{
  ThemeDisplay themeDisplay=(ThemeDisplay)actionRequest.getAttribute(WebKeys.THEME_DISPLAY);
  long fileEntryTypeId=ParamUtil.getLong(actionRequest,"fileEntryTypeId");
  String name=ParamUtil.getString(actionRequest,"name");
  String description=ParamUtil.getString(actionRequest,"description");
  long[] ddmStructureIds=getLongArray(actionRequest,"ddmStructuresSearchContainerPrimaryKeys");
  long ddmStructureId=ParamUtil.getLong(actionRequest,"ddmStructureId");
  Map<Locale,String> nameMap=new HashMap<Locale,String>();
  nameMap.put(themeDisplay.getLocale(),name);
  Map<Locale,String> descriptionMap=new HashMap<Locale,String>();
  descriptionMap.put(themeDisplay.getLocale(),description);
  String xsd=ParamUtil.getString(actionRequest,"xsd");
  ServiceContext serviceContext=ServiceContextFactory.getInstance(DLFileEntryType.class.getName(),actionRequest);
  if (fileEntryTypeId <= 0) {
    long groupId=themeDisplay.getScopeGroupId();
    Group scopeGroup=GroupLocalServiceUtil.getGroup(groupId);
    if (scopeGroup.isLayout()) {
      groupId=scopeGroup.getParentGroupId();
    }
    DLFileEntryType fileEntryType=DLFileEntryTypeServiceUtil.addFileEntryType(groupId,name,description,ddmStructureIds,serviceContext);
    String ddmStructureKey="auto_" + fileEntryType.getFileEntryTypeId();
    DDMStructure ddmStructure=null;
    try {
      ddmStructure=DDMStructureServiceUtil.addStructure(themeDisplay.getScopeGroupId(),PortalUtil.getClassNameId(DLFileEntryMetadata.class),ddmStructureKey,nameMap,descriptionMap,xsd,"xml",serviceContext);
    }
 catch (    Exception e) {
      if (!(e instanceof RequiredStructureException) && !(e instanceof StructureDuplicateElementException) && !(e instanceof StructureNameException)&& !(e instanceof StructureXsdException)) {
        throw e;
      }
    }
    if (ddmStructure != null) {
      ddmStructureIds=ArrayUtil.append(ddmStructureIds,ddmStructure.getStructureId());
      DLFileEntryTypeServiceUtil.updateFileEntryType(fileEntryType.getFileEntryTypeId(),name,description,ddmStructureIds,serviceContext);
    }
  }
 else {
    DDMStructure ddmStructure=null;
    try {
      ddmStructure=DDMStructureServiceUtil.updateStructure(ddmStructureId,nameMap,descriptionMap,xsd,serviceContext);
    }
 catch (    Exception e) {
      if (!(e instanceof RequiredStructureException) && !(e instanceof StructureDuplicateElementException) && !(e instanceof StructureNameException)&& !(e instanceof StructureXsdException)) {
        throw e;
      }
    }
    if (ddmStructure != null) {
      ddmStructureIds=ArrayUtil.append(ddmStructureIds,ddmStructure.getStructureId());
    }
    DLFileEntryTypeServiceUtil.updateFileEntryType(fileEntryTypeId,name,description,ddmStructureIds,serviceContext);
  }
}
