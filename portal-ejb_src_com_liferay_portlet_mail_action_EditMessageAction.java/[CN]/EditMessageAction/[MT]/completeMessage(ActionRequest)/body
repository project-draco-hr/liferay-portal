{
  String cmd=ParamUtil.getString(req,Constants.CMD);
  User user=PortalUtil.getUser(req);
  long draftId=ParamUtil.getLong(req,"draftId");
  String to=ParamUtil.getString(req,"to");
  String cc=ParamUtil.getString(req,"cc");
  String bcc=ParamUtil.getString(req,"bcc");
  String subject=ParamUtil.getString(req,"subject");
  String body=ParamUtil.getString(req,"body");
  MailMessage mailMessage=new MailMessage();
  try {
    mailMessage.setFrom(new InternetAddress(user.getEmailAddress(),user.getFullName()));
    mailMessage.setTo(to);
    mailMessage.setCc(cc);
    mailMessage.setBcc(bcc);
  }
 catch (  Exception ex) {
    throw new RecipientException(ex);
  }
  mailMessage.setSubject(subject);
  mailMessage.setHtmlBody(body);
  Iterator itr=getAttachments(req).entrySet().iterator();
  while (itr.hasNext()) {
    Map.Entry entry=(Map.Entry)itr.next();
    String fileName=(String)entry.getKey();
    byte[] attachment=(byte[])entry.getValue();
    MailAttachment mailAttachment=new MailAttachment();
    mailAttachment.setFilename(fileName);
    mailAttachment.setContent(attachment);
    mailAttachment.setContentType(ContentTypeUtil.getContentType(fileName));
    mailMessage.appendAttachment(mailAttachment);
  }
  mailMessage.setRemoteAttachments(getRemoteAttachments(req));
  boolean send=cmd.equals(Constants.SEND);
  ActionRequestImpl actionReqImpl=(ActionRequestImpl)req;
  MailUtil.completeMessage(actionReqImpl.getHttpServletRequest(),mailMessage,send,draftId);
}
