{
  String cmd=ParamUtil.getString(req,Constants.CMD);
  User user=PortalUtil.getUser(req);
  String originalId=ParamUtil.getString(req,"originalId");
  boolean wasDraft=false;
  if (originalId.startsWith(_DRAFT_ID_PREFIX)) {
    wasDraft=true;
    originalId=originalId.substring(_DRAFT_ID_PREFIX.length());
  }
  String to=ParamUtil.getString(req,"to");
  String cc=ParamUtil.getString(req,"cc");
  String bcc=ParamUtil.getString(req,"bcc");
  String inReplyTo=ParamUtil.getString(req,"inReplyTo");
  String references=ParamUtil.getString(req,"references");
  String subject=ParamUtil.getString(req,"subject");
  String body=ParamUtil.getString(req,"body");
  MailMessage mailMessage=new MailMessage();
  try {
    MailAccount account=MailAccounts.getCurrentAccount(req);
    mailMessage.setFrom(new InternetAddress(account.getEmailAddress(),user.getFullName()));
    mailMessage.setTo(to);
    mailMessage.setCc(cc);
    mailMessage.setBcc(bcc);
    mailMessage.setInReplyTo(inReplyTo);
    mailMessage.setReferences(references);
  }
 catch (  Exception ex) {
    throw new RecipientException(ex);
  }
  mailMessage.setSubject(subject);
  mailMessage.setBody(body);
  Iterator itr=getAttachments(req).entrySet().iterator();
  while (itr.hasNext()) {
    Map.Entry entry=(Map.Entry)itr.next();
    String fileName=(String)entry.getKey();
    byte[] attachment=(byte[])entry.getValue();
    MailAttachment mailAttachment=new MailAttachment();
    mailAttachment.setFilename(fileName);
    mailAttachment.setContent(attachment);
    mailAttachment.setContentType(ContentTypeUtil.getContentType(fileName));
    mailMessage.appendAttachment(mailAttachment);
  }
  mailMessage.setRemoteAttachments(getRemoteAttachments(req));
  boolean send=cmd.equals(Constants.SEND);
  ActionRequestImpl actionReqImpl=(ActionRequestImpl)req;
  MailUtil.completeMessage(actionReqImpl.getHttpServletRequest(),mailMessage,send,originalId,wasDraft);
}
