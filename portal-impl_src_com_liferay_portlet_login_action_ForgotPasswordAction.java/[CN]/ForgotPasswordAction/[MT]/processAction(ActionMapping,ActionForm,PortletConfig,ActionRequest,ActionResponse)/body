{
  try {
    if (PropsValues.USERS_REMINDER_QUERIES_ENABLED) {
      PortletSession portletSession=actionRequest.getPortletSession();
      int step=ParamUtil.getInteger(actionRequest,"step");
      if (step == 1) {
        _checkCaptcha(actionRequest);
        portletSession.setAttribute(REMINDER_ATTEMPTS,0);
        portletSession.setAttribute(REMINDER_USER,"");
      }
      User user=getUser(actionRequest);
      portletSession.setAttribute(REMINDER_USER,user.getEmailAddress());
      actionRequest.setAttribute(ForgotPasswordAction.class.getName(),user);
      if (step == 2) {
        Integer reminderAttempts=(Integer)portletSession.getAttribute(REMINDER_ATTEMPTS);
        if (reminderAttempts == null) {
          reminderAttempts=0;
        }
 else         if (reminderAttempts >= 3) {
          _checkCaptcha(actionRequest);
        }
        reminderAttempts++;
        portletSession.setAttribute(REMINDER_ATTEMPTS,reminderAttempts);
        sendPassword(actionRequest,actionResponse);
      }
    }
 else {
      _checkCaptcha(actionRequest);
      sendPassword(actionRequest,actionResponse);
    }
  }
 catch (  Exception e) {
    if (e instanceof CaptchaTextException || e instanceof NoSuchUserException || e instanceof RequiredReminderQueryException|| e instanceof SendPasswordException|| e instanceof UserEmailAddressException|| e instanceof UserReminderQueryException) {
      SessionErrors.add(actionRequest,e.getClass().getName());
    }
 else {
      PortalUtil.sendError(e,actionRequest,actionResponse);
    }
  }
}
