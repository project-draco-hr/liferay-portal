{
  try {
    User user=getUser(actionRequest);
    if (PropsValues.USERS_REMINDER_QUERIES_ENABLED && Validator.isNotNull(user.getReminderQueryQuestion()) && Validator.isNotNull(user.getReminderQueryAnswer())) {
      int step=ParamUtil.getInteger(actionRequest,"step");
      if (step == 1) {
        if (PropsValues.CAPTCHA_CHECK_PORTAL_SEND_PASSWORD) {
          CaptchaUtil.check(actionRequest);
        }
        actionRequest.setAttribute(ForgotPasswordAction.class.getName(),user);
      }
 else {
        sendPassword(actionRequest,actionResponse);
      }
    }
 else {
      if (PropsValues.CAPTCHA_CHECK_PORTAL_SEND_PASSWORD) {
        CaptchaUtil.check(actionRequest);
      }
      sendPassword(actionRequest,actionResponse);
    }
  }
 catch (  Exception e) {
    if (e instanceof CaptchaTextException || e instanceof NoSuchUserException || e instanceof SendPasswordException|| e instanceof UserEmailAddressException|| e instanceof UserReminderQueryException) {
      SessionErrors.add(actionRequest,e.getClass().getName());
    }
 else {
      PortalUtil.sendError(e,actionRequest,actionResponse);
    }
  }
}
