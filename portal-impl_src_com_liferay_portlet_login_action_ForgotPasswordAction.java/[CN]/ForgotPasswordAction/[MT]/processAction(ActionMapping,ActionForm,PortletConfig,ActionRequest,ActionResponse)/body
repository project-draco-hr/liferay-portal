{
  try {
    if (PropsValues.USERS_REMINDER_QUERIES_ENABLED) {
      int step=ParamUtil.getInteger(actionRequest,"step");
      if (PropsValues.CAPTCHA_CHECK_PORTAL_SEND_PASSWORD && (step != 2)) {
        CaptchaUtil.check(actionRequest);
      }
      User user=getUser(actionRequest);
      if (PropsValues.CAPTCHA_CHECK_PORTAL_SEND_PASSWORD || user.hasReminderQuery()) {
        actionRequest.setAttribute(ForgotPasswordAction.class.getName(),user);
        PortletSession portletSession=actionRequest.getPortletSession();
        int failedAttempts=GetterUtil.getInteger((Integer)portletSession.getAttribute("failed-attempts"),0);
        if (step == 2) {
          if (PropsValues.CAPTCHA_CHECK_PORTAL_SEND_PASSWORD && (failedAttempts > 2)) {
            CaptchaUtil.check(actionRequest);
          }
          sendPassword(actionRequest,actionResponse);
        }
      }
    }
 else {
      if (PropsValues.CAPTCHA_CHECK_PORTAL_SEND_PASSWORD) {
        CaptchaUtil.check(actionRequest);
      }
      sendPassword(actionRequest,actionResponse);
    }
  }
 catch (  Exception e) {
    if (e instanceof CaptchaTextException || e instanceof NoSuchUserException || e instanceof RequiredReminderQueryException|| e instanceof SendPasswordException|| e instanceof UserEmailAddressException|| e instanceof UserReminderQueryException) {
      SessionErrors.add(actionRequest,e.getClass().getName());
    }
 else {
      PortalUtil.sendError(e,actionRequest,actionResponse);
    }
  }
}
