{
  User user=getUser(actionRequest);
  if (PropsValues.USERS_REMINDER_QUERIES_ENABLED) {
    if (PropsValues.USERS_REMINDER_QUERIES_REQUIRED && !user.hasReminderQuery()) {
      throw new RequiredReminderQueryException("No reminder query or answer is defined for user " + user.getUserId());
    }
    String answer=ParamUtil.getString(actionRequest,"answer");
    if (!user.getReminderQueryAnswer().equals(answer)) {
      throw new UserReminderQueryException();
    }
  }
  PortletPreferences preferences=actionRequest.getPreferences();
  String languageId=LanguageUtil.getLanguageId(actionRequest);
  long companyId=PortalUtil.getCompanyId(actionRequest);
  if (PrefsPropsUtil.getBoolean(companyId,PropsKeys.COMPANY_SECURITY_SEND_PASSWORD_RESET_LINK_ONLY)) {
    String emailFromName=preferences.getValue("emailFromName",null);
    String emailFromAddress=preferences.getValue("emailFromAddress",null);
    String emailToAddress=user.getEmailAddress();
    String subject=preferences.getValue("emailPasswordResetSubject_" + languageId,null);
    String body=preferences.getValue("emailPasswordResetBody_" + languageId,null);
    LoginUtil.sendPasswordResetLink(actionRequest,emailFromName,emailFromAddress,emailToAddress,subject,body);
  }
 else {
    String emailFromName=preferences.getValue("emailFromName",null);
    String emailFromAddress=preferences.getValue("emailFromAddress",null);
    String emailToAddress=user.getEmailAddress();
    String subject=preferences.getValue("emailPasswordSentSubject_" + languageId,null);
    String body=preferences.getValue("emailPasswordSentBody_" + languageId,null);
    LoginUtil.sendPassword(actionRequest,emailFromName,emailFromAddress,emailToAddress,subject,body);
  }
  sendRedirect(actionRequest,actionResponse);
}
