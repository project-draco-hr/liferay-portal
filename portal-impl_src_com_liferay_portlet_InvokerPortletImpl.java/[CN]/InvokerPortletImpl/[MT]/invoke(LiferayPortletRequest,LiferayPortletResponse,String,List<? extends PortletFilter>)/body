{
  FilterChain filterChain=new FilterChainImpl(_portlet,filters);
  if (_liferayPortletConfig.isWARFile()) {
    String invokerPortletName=_liferayPortletConfig.getInitParameter(INIT_INVOKER_PORTLET_NAME);
    if (invokerPortletName == null) {
      invokerPortletName=_liferayPortletConfig.getPortletName();
    }
    String path=StringPool.SLASH + invokerPortletName + "/invoke";
    ServletContext servletContext=_liferayPortletContext.getServletContext();
    RequestDispatcher requestDispatcher=servletContext.getRequestDispatcher(path);
    HttpServletRequest request=portletRequest.getHttpServletRequest();
    HttpServletResponse response=portletResponse.getHttpServletResponse();
    request.setAttribute(JavaConstants.JAVAX_PORTLET_PORTLET,_portlet);
    request.setAttribute(PortletRequest.LIFECYCLE_PHASE,lifecycle);
    request.setAttribute(PortletServlet.PORTLET_SERVLET_FILTER_CHAIN,filterChain);
    try {
      if (lifecycle.equals(PortletRequest.RESOURCE_PHASE)) {
        requestDispatcher.forward(request,response);
      }
 else {
        requestDispatcher.include(request,response);
      }
    }
 catch (    ServletException se) {
      Throwable cause=se.getRootCause();
      if (cause instanceof PortletException) {
        throw (PortletException)cause;
      }
      throw new PortletException(cause);
    }
  }
 else {
    PortletFilterUtil.doFilter(portletRequest,portletResponse,lifecycle,filterChain);
  }
  portletResponse.transferMarkupHeadElements();
  Map<String,String[]> properties=portletResponse.getProperties();
  if (MapUtil.isNotEmpty(properties)) {
    if (_expCache != null) {
      String[] expCache=properties.get(RenderResponse.EXPIRATION_CACHE);
      if ((expCache != null) && (expCache.length > 0) && (expCache[0] != null)) {
        _expCache=new Integer(GetterUtil.getInteger(expCache[0]));
      }
    }
  }
}
