{
  GroupBy groupBy=searchContext.getGroupBy();
  if (groupBy == null) {
    return;
  }
  Aggregations aggregations=searchResponse.getAggregations();
  Map<String,Aggregation> aggregationsMap=aggregations.getAsMap();
  Terms terms=(Terms)aggregationsMap.get(GroupByTranslator.GROUP_BY_AGGREGATION_PREFIX + groupBy.getField());
  List<Terms.Bucket> buckets=terms.getBuckets();
  for (  Terms.Bucket bucket : buckets) {
    Aggregations bucketAggregations=bucket.getAggregations();
    TopHits topHits=bucketAggregations.get(GroupByTranslator.TOP_HITS_AGGREGATION_NAME);
    SearchHits groupedSearchHits=topHits.getHits();
    Hits groupedHits=new HitsImpl();
    processSearchHits(groupedSearchHits,query,groupedHits);
    groupedHits.setLength((int)groupedSearchHits.getTotalHits());
    hits.addGroupedHits(bucket.getKey(),groupedHits);
  }
}
