{
  Client client=_elasticsearchConnectionManager.getClient();
  QueryConfig queryConfig=query.getQueryConfig();
  SearchRequestBuilder searchRequestBuilder=client.prepareSearch(getSelectedIndexNames(queryConfig,searchContext));
  searchRequestBuilder.setTypes(getSelectedTypes(queryConfig));
  addStats(searchRequestBuilder,searchContext);
  if (!count) {
    addFacets(searchRequestBuilder,searchContext);
    addGroupBy(searchRequestBuilder,searchContext,start,end);
    addHighlights(searchRequestBuilder,queryConfig);
    addPagination(searchRequestBuilder,start,end);
    addSelectedFields(searchRequestBuilder,queryConfig);
    addSort(searchRequestBuilder,searchContext.getSorts());
    searchRequestBuilder.setTrackScores(queryConfig.isScoreEnabled());
  }
 else {
    searchRequestBuilder.setSize(0);
  }
  if (query.getPostFilter() != null) {
    QueryBuilder postFilterQueryBuilder=_filterTranslator.translate(query.getPostFilter(),searchContext);
    searchRequestBuilder.setPostFilter(postFilterQueryBuilder);
  }
  QueryBuilder queryBuilder=_queryTranslator.translate(query,searchContext);
  if (query.getPreBooleanFilter() != null) {
    QueryBuilder preFilterQueryBuilder=_filterTranslator.translate(query.getPreBooleanFilter(),searchContext);
    BoolQueryBuilder boolQueryBuilder=QueryBuilders.boolQuery();
    boolQueryBuilder.filter(preFilterQueryBuilder);
    boolQueryBuilder.must(queryBuilder);
    queryBuilder=boolQueryBuilder;
  }
  searchRequestBuilder.setQuery(queryBuilder);
  SearchResponse searchResponse=searchRequestBuilder.get();
  if (_log.isInfoEnabled()) {
    _log.info("The search engine processed " + queryBuilder.toString() + " in "+ searchResponse.getTook());
  }
  return searchResponse;
}
