{
  FabricAgentRegistry fabricAgentRegistry=new FabricAgentRegistry(new LocalFabricAgent(new EmbeddedProcessExecutor()));
  Recorder recorder=new Recorder();
  fabricAgentRegistry.registerFabricAgentListener(recorder);
  FabricAgent fabricAgent1=new LocalFabricAgent(new EmbeddedProcessExecutor());
  Assert.assertTrue(fabricAgentRegistry.registerFabricAgent(fabricAgent1,recorder));
  recorder.validate(2,fabricAgent1,0);
  Assert.assertFalse(fabricAgentRegistry.registerFabricAgent(fabricAgent1,recorder));
  recorder.validate();
  List<FabricAgent> fabricAgents=fabricAgentRegistry.getFabricAgents();
  Assert.assertEquals(1,fabricAgents.size());
  Assert.assertTrue(fabricAgents.contains(fabricAgent1));
  FabricAgent fabricAgent2=new LocalFabricAgent(new EmbeddedProcessExecutor());
  Assert.assertTrue(fabricAgentRegistry.registerFabricAgent(fabricAgent2,null));
  recorder.validate(fabricAgent2,0);
  Assert.assertFalse(fabricAgentRegistry.registerFabricAgent(fabricAgent2,null));
  recorder.validate();
  fabricAgents=fabricAgentRegistry.getFabricAgents();
  Assert.assertEquals(2,fabricAgents.size());
  Assert.assertTrue(fabricAgents.contains(fabricAgent1));
  Assert.assertTrue(fabricAgents.contains(fabricAgent2));
  Assert.assertTrue(fabricAgentRegistry.unregisterFabricAgent(fabricAgent1,recorder));
  recorder.validate(2,fabricAgent1,1);
  Assert.assertFalse(fabricAgentRegistry.unregisterFabricAgent(fabricAgent1,recorder));
  recorder.validate();
  fabricAgents=fabricAgentRegistry.getFabricAgents();
  Assert.assertEquals(1,fabricAgents.size());
  Assert.assertTrue(fabricAgents.contains(fabricAgent2));
  Assert.assertTrue(fabricAgentRegistry.unregisterFabricAgent(fabricAgent2,null));
  recorder.validate(fabricAgent2,1);
  Assert.assertFalse(fabricAgentRegistry.unregisterFabricAgent(fabricAgent2,null));
  recorder.validate();
  fabricAgents=fabricAgentRegistry.getFabricAgents();
  Assert.assertTrue(fabricAgents.isEmpty());
}
