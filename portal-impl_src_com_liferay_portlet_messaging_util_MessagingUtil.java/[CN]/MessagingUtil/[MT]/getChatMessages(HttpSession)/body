{
  JSONArray ja=new JSONArray();
  JSONObject jo=new JSONObject();
  PacketCollector collector=getCollector(ses);
  Message message=getNextMessage(collector);
  Roster roster=getRoster(ses);
  while (message != null) {
    JSONObject jMsg=new JSONObject();
    String fromId=(String)message.getProperty("fromId");
    JSONUtil.put(jMsg,"body",message.getBody());
    JSONUtil.put(jMsg,"category",message.getProperty("category"));
    JSONUtil.put(jMsg,"toId",message.getProperty("toId"));
    JSONUtil.put(jMsg,"toName",message.getProperty("toName"));
    JSONUtil.put(jMsg,"fromId",fromId);
    JSONUtil.put(jMsg,"fromName",message.getProperty("fromName"));
    JSONUtil.put(jMsg,"status",getPresence(roster.getPresence(getXmppId(fromId))));
    ja.put(jMsg);
    message=getNextMessage(collector);
  }
  JSONUtil.put(jo,"chat",ja);
  JSONUtil.put(jo,"status","success");
  return jo;
}
