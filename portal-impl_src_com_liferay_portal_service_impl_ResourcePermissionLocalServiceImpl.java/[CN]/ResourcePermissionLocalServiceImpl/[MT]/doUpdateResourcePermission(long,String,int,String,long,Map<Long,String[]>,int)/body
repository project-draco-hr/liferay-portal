{
  boolean flushEnabled=PermissionThreadLocal.isFlushEnabled();
  PermissionThreadLocal.setIndexEnabled(false);
  try {
    long[] roleIds=ArrayUtil.toLongArray(roleIdsToActionIds.keySet());
    List<ResourcePermission> resourcePermissions=resourcePermissionPersistence.findByC_N_S_P_R(companyId,name,scope,primKey,roleIds);
    for (    ResourcePermission resourcePermission : resourcePermissions) {
      if (resourcePermission.getOwnerId() != ownerId) {
        continue;
      }
      long roleId=resourcePermission.getRoleId();
      String[] actionIds=roleIdsToActionIds.remove(roleId);
      doUpdateResourcePermission(companyId,name,scope,primKey,ownerId,roleId,actionIds,operator);
    }
    if (roleIdsToActionIds.isEmpty() || ((operator != ResourcePermissionConstants.OPERATOR_ADD) && (operator != ResourcePermissionConstants.OPERATOR_SET))) {
      return;
    }
    for (    Map.Entry<Long,String[]> entry : roleIdsToActionIds.entrySet()) {
      long roleId=entry.getKey();
      String[] actionIds=entry.getValue();
      doUpdateResourcePermission(companyId,name,scope,primKey,ownerId,roleId,actionIds,ResourcePermissionConstants.OPERATOR_ADD);
    }
  }
  finally {
    PermissionThreadLocal.setIndexEnabled(flushEnabled);
    PermissionCacheUtil.clearCache();
    SearchEngineUtil.updatePermissionFields(name,primKey);
  }
}
