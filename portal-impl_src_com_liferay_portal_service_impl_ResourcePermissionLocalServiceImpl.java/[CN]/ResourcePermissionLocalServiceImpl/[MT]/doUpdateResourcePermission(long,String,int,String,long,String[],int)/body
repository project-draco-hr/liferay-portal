{
  ResourcePermission resourcePermission=null;
  Map<Long,ResourcePermission> resourcePermissionMap=ResourcePermissionBagThreadLocal.getResourcePermissions();
  if (resourcePermissionMap == null) {
    resourcePermission=resourcePermissionPersistence.fetchByC_N_S_P_R(companyId,name,scope,primKey,roleId);
  }
 else {
    resourcePermission=resourcePermissionMap.get(roleId);
  }
  long oldActionIds=0;
  if (resourcePermission == null) {
    if ((operator == ResourcePermissionConstants.OPERATOR_REMOVE) || (actionIds.length == 0)) {
      return;
    }
    long resourcePermissionId=counterLocalService.increment(ResourcePermission.class.getName());
    resourcePermission=resourcePermissionPersistence.create(resourcePermissionId);
    resourcePermission.setCompanyId(companyId);
    resourcePermission.setName(name);
    resourcePermission.setScope(scope);
    resourcePermission.setPrimKey(primKey);
    resourcePermission.setRoleId(roleId);
  }
 else {
    oldActionIds=resourcePermission.getActionIds();
  }
  long actionIdsLong=resourcePermission.getActionIds();
  if (operator == ResourcePermissionConstants.OPERATOR_SET) {
    actionIdsLong=0;
  }
  for (  String actionId : actionIds) {
    ResourceAction resourceAction=resourceActionLocalService.getResourceAction(name,actionId);
    if ((operator == ResourcePermissionConstants.OPERATOR_ADD) || (operator == ResourcePermissionConstants.OPERATOR_SET)) {
      actionIdsLong|=resourceAction.getBitwiseValue();
    }
 else {
      actionIdsLong=actionIdsLong & (~resourceAction.getBitwiseValue());
    }
  }
  if (oldActionIds == actionIdsLong) {
    return;
  }
  if (actionIdsLong == 0) {
    resourcePermissionPersistence.remove(resourcePermission);
  }
 else {
    resourcePermission.setActionIds(actionIdsLong);
    resourcePermissionPersistence.update(resourcePermission,false);
  }
  PermissionCacheUtil.clearCache();
  SearchEngineUtil.updatePermissionFields(name,primKey);
}
