{
  ClusterExecutorImpl clusterExecutorImpl=getClusterExecutorImpl();
  try {
    BaseReceiverAdvice.reset(1);
    Channel channel=clusterExecutorImpl.getControlChannel();
    BaseReceiverAdvice.awaitMessageReceived();
    Object object=BaseReceiverAdvice.getJGroupsMessagePayload(channel.getReceiver(),channel.getAddress());
    ClusterRequest clusterRequest=(ClusterRequest)object;
    Assert.assertEquals(ClusterMessageType.NOTIFY,clusterRequest.getClusterMessageType());
    BaseReceiverAdvice.reset(1);
    String timestamp=String.valueOf(System.currentTimeMillis());
    MethodHandler methodHandler=new MethodHandler(testMethod1MethodKey,timestamp);
    clusterRequest=ClusterRequest.createUnicastRequest(methodHandler,clusterExecutorImpl.getLocalClusterNodeAddress());
    clusterExecutorImpl.setShortcutLocalMethod(false);
    clusterExecutorImpl.execute(clusterRequest);
    BaseReceiverAdvice.awaitMessageReceived();
    object=BaseReceiverAdvice.getJGroupsMessagePayload(channel.getReceiver(),channel.getAddress());
    clusterRequest=(ClusterRequest)object;
    Assert.assertEquals(ClusterMessageType.EXECUTE,clusterRequest.getClusterMessageType());
    Assert.assertEquals(methodHandler.toString(),clusterRequest.getMethodHandler().toString());
    BaseReceiverAdvice.reset(1);
    timestamp=String.valueOf(System.currentTimeMillis());
    clusterRequest=ClusterRequest.createUnicastRequest(new MethodHandler(testMethod1MethodKey,timestamp),clusterExecutorImpl.getLocalClusterNodeAddress());
    clusterExecutorImpl.setShortcutLocalMethod(true);
    FutureClusterResponses futureClusterResponses=clusterExecutorImpl.execute(clusterRequest);
    BaseReceiverAdvice.awaitMessageReceived();
    Assert.assertNull(BaseReceiverAdvice.getJGroupsMessagePayload(channel.getReceiver(),channel.getAddress()));
    assertFutureClusterResponsesWithoutException(futureClusterResponses.get(),clusterRequest.getUuid(),timestamp,clusterExecutorImpl.getLocalClusterNodeAddress());
  }
  finally {
    clusterExecutorImpl.destroy();
  }
}
