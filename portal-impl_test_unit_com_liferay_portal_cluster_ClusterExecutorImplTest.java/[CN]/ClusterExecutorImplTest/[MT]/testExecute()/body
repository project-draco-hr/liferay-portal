{
  ClusterExecutorImpl clusterExecutorImpl=getClusterExecutorImpl();
  TestClusterChannel.clearAllMessages();
  List<Serializable> multicastMessages=TestClusterChannel.getMulticastMessages();
  List<ObjectValuePair<Serializable,Address>> unicastMessages=TestClusterChannel.getUnicastMessages();
  Assert.assertTrue(multicastMessages.isEmpty());
  Assert.assertTrue(unicastMessages.isEmpty());
  ClusterRequest clusterRequest=ClusterRequest.createMulticastRequest(StringPool.BLANK);
  FutureClusterResponses futureClusterResponses=clusterExecutorImpl.execute(clusterRequest);
  Assert.assertEquals(1,multicastMessages.size());
  Assert.assertTrue(multicastMessages.contains(clusterRequest));
  Assert.assertTrue(unicastMessages.isEmpty());
  ClusterNodeResponses clusterNodeResponses=futureClusterResponses.get();
  Assert.assertEquals(1,clusterNodeResponses.size());
  TestClusterChannel.clearAllMessages();
  Assert.assertTrue(multicastMessages.isEmpty());
  Assert.assertTrue(unicastMessages.isEmpty());
  clusterRequest=ClusterRequest.createMulticastRequest(StringPool.BLANK,true);
  futureClusterResponses=clusterExecutorImpl.execute(clusterRequest);
  Assert.assertEquals(1,multicastMessages.size());
  Assert.assertTrue(multicastMessages.contains(clusterRequest));
  Assert.assertTrue(unicastMessages.isEmpty());
  clusterNodeResponses=futureClusterResponses.get();
  Assert.assertEquals(0,clusterNodeResponses.size());
  TestClusterChannel.clearAllMessages();
  Assert.assertTrue(multicastMessages.isEmpty());
  Assert.assertTrue(unicastMessages.isEmpty());
  ClusterNode localClusterNode=clusterExecutorImpl.getLocalClusterNode();
  clusterRequest=ClusterRequest.createUnicastRequest(clusterRequest,localClusterNode.getClusterNodeId());
  futureClusterResponses=clusterExecutorImpl.execute(clusterRequest);
  Assert.assertTrue(multicastMessages.isEmpty());
  Assert.assertTrue(unicastMessages.isEmpty());
  clusterNodeResponses=futureClusterResponses.get();
  Assert.assertEquals(1,clusterNodeResponses.size());
  TestClusterChannel.clearAllMessages();
  Assert.assertTrue(multicastMessages.isEmpty());
  Assert.assertTrue(unicastMessages.isEmpty());
  Address newAddress=new TestAddress("test.address");
  ClusterNode newClusterNode=new ClusterNode("test.cluster.node",InetAddress.getLoopbackAddress());
  clusterExecutorImpl.memberJoined(newAddress,newClusterNode);
  clusterRequest=ClusterRequest.createUnicastRequest(clusterRequest,newClusterNode.getClusterNodeId());
  futureClusterResponses=clusterExecutorImpl.execute(clusterRequest);
  Assert.assertTrue(multicastMessages.isEmpty());
  Assert.assertEquals(1,unicastMessages.size());
  ObjectValuePair<Serializable,Address> receivedMessage=unicastMessages.get(0);
  Assert.assertEquals(clusterRequest,receivedMessage.getKey());
  Assert.assertEquals(newAddress,receivedMessage.getValue());
}
