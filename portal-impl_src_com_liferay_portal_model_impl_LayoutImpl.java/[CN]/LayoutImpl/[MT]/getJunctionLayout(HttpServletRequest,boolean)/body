{
  HttpSession ses=req.getSession();
  Layout junctionLayout=this;
  boolean junctionPoint=getType().equals(LayoutConstants.TYPE_JUNCTION_POINT);
  boolean useDeepHistory=deepHistory && !junctionPoint;
  while (junctionPoint || useDeepHistory) {
    String key=_getJunctionLayoutKey(junctionLayout.getPlid(),!junctionPoint);
    Long junctionPlid=(Long)ses.getAttribute(key);
    if ((junctionPlid == null) && junctionPoint && (deepHistory || !junctionLayout.getHidden())) {
      List<Layout> junctionLayouts=junctionLayout.getJunctionLayouts();
      if (junctionLayouts.size() == 1) {
        junctionPlid=new Long((junctionLayouts.get(0)).getPlid());
        ses.setAttribute(key,junctionPlid);
      }
 else {
        ses.setAttribute(key,new Integer(0));
      }
    }
    if ((junctionPlid != null) && (junctionPlid.longValue() > 0) && (junctionPlid.longValue() != junctionLayout.getPlid())) {
      try {
        junctionLayout=LayoutLocalServiceUtil.getLayout(junctionPlid.longValue());
        junctionPoint=junctionLayout.getType().equals(LayoutConstants.TYPE_JUNCTION_POINT);
        continue;
      }
 catch (      NoSuchLayoutException nsle) {
        ses.removeAttribute(key);
      }
    }
    break;
  }
  return junctionLayout;
}
