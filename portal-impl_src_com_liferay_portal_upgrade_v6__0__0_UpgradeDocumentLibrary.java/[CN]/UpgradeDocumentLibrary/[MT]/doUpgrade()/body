{
  Connection con=null;
  PreparedStatement ps=null;
  ResultSet rs=null;
  try {
    con=DataAccess.getUpgradeOptimizedConnection();
    ps=con.prepareStatement("select * from DLFileEntry");
    rs=ps.executeQuery();
    while (rs.next()) {
      long companyId=rs.getLong("companyId");
      long groupId=rs.getLong("groupId");
      long folderId=rs.getLong("folderId");
      String name=rs.getString("name");
      long repositoryId=folderId;
      if (repositoryId == DLFolderConstants.DEFAULT_PARENT_FOLDER_ID) {
        repositoryId=groupId;
      }
      String newName=DLFileEntryNameUpgradeColumnImpl.getNewName(name);
      if (!newName.equals(name)) {
        try {
          DLStoreUtil.updateFile(companyId,repositoryId,name,newName);
        }
 catch (        Exception e) {
          if (_log.isWarnEnabled()) {
            _log.warn("Unable to update file for " + name,e);
          }
        }
      }
    }
  }
  finally {
    DataAccess.cleanUp(con,ps,rs);
  }
  synchronizeFileVersions();
  UpgradeColumn nameColumn=new DLFileEntryNameUpgradeColumnImpl("name");
  UpgradeColumn titleColumn=new DLFileEntryTitleUpgradeColumnImpl(nameColumn,"title");
  UpgradeColumn versionColumn=new DLFileEntryVersionUpgradeColumnImpl("version");
  UpgradeTable upgradeTable=UpgradeTableFactoryUtil.getUpgradeTable(DLFileEntryTable.TABLE_NAME,DLFileEntryTable.TABLE_COLUMNS,nameColumn,titleColumn,versionColumn);
  upgradeTable.setCreateSQL(DLFileEntryTable.TABLE_SQL_CREATE);
  upgradeTable.setIndexesSQL(DLFileEntryTable.TABLE_SQL_ADD_INDEXES);
  upgradeTable.setAllowUniqueIndexes(true);
  upgradeTable.updateTable();
  upgradeTable=UpgradeTableFactoryUtil.getUpgradeTable(DLFileRankTable.TABLE_NAME,DLFileRankTable.TABLE_COLUMNS,nameColumn);
  upgradeTable.setCreateSQL(DLFileRankTable.TABLE_SQL_CREATE);
  upgradeTable.setIndexesSQL(DLFileRankTable.TABLE_SQL_ADD_INDEXES);
  upgradeTable.updateTable();
  UpgradeColumn toNameColumn=new DLFileEntryNameUpgradeColumnImpl("toName");
  upgradeTable=UpgradeTableFactoryUtil.getUpgradeTable(DLFileShortcutTable.TABLE_NAME,DLFileShortcutTable.TABLE_COLUMNS,toNameColumn);
  upgradeTable.setCreateSQL(DLFileShortcutTable.TABLE_SQL_CREATE);
  upgradeTable.setIndexesSQL(DLFileShortcutTable.TABLE_SQL_ADD_INDEXES);
  upgradeTable.updateTable();
  upgradeTable=UpgradeTableFactoryUtil.getUpgradeTable(DLFileVersionTable.TABLE_NAME,DLFileVersionTable.TABLE_COLUMNS,nameColumn,versionColumn);
  upgradeTable.setCreateSQL(DLFileVersionTable.TABLE_SQL_CREATE);
  upgradeTable.setIndexesSQL(DLFileVersionTable.TABLE_SQL_ADD_INDEXES);
  upgradeTable.updateTable();
}
