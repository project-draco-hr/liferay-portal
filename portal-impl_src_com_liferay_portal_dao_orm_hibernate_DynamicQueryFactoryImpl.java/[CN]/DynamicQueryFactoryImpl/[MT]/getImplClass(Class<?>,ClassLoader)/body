{
  Class<?> implClass=clazz;
  String className=clazz.getName();
  if (className.endsWith("Impl")) {
    return implClass;
  }
  if (classLoader == null) {
    Thread currentThread=Thread.currentThread();
    classLoader=currentThread.getContextClassLoader();
  }
  Package pakkage=clazz.getPackage();
  String implClassName=pakkage.getName() + ".impl." + clazz.getSimpleName()+ "Impl";
  try {
    implClass=getImplClass(implClassName,classLoader);
  }
 catch (  Exception e1) {
    if (classLoader != _portalClassLoader) {
      try {
        implClass=getImplClass(implClassName,_portalClassLoader);
      }
 catch (      Exception e2) {
        _log.error("Unable find model " + implClassName,e2);
      }
    }
 else {
      _log.error("Unable find model " + implClassName,e1);
    }
  }
  PACLPolicy paclPolicy=PACLClassUtil.getPACLPolicyByReflection(_log.isDebugEnabled());
  if (_log.isDebugEnabled()) {
    if (paclPolicy != null) {
      _log.debug("Retrieved PACL policy for " + paclPolicy.getServletContextName());
    }
  }
  if (paclPolicy != null) {
    if (!paclPolicy.hasDynamicQuery(implClass)) {
      throw new SecurityException("Attempted to create a dynamic query for " + implClass);
    }
  }
  return implClass;
}
