{
  userId=userId.trim().toLowerCase();
  emailAddress=emailAddress.trim().toLowerCase();
  Date now=new Date();
  validate(userId,emailAddress,firstName,lastName,smsSn);
  User user=UserUtil.findByPrimaryKey(userId);
  validateOrganizations(user.getCompanyId(),organizationId,locationId);
  user.setModifiedDate(now);
  if (!emailAddress.equals(user.getEmailAddress())) {
    if (!user.hasCompanyMx() && user.hasCompanyMx(emailAddress)) {
      MailServiceUtil.addUser(userId,password,firstName,middleName,lastName,emailAddress);
    }
 else     if (user.hasCompanyMx() && user.hasCompanyMx(emailAddress)) {
      MailServiceUtil.updateEmailAddress(userId,emailAddress);
    }
 else     if (user.hasCompanyMx() && !user.hasCompanyMx(emailAddress)) {
      MailServiceUtil.deleteEmailAddress(userId);
    }
    user.setEmailAddress(emailAddress);
  }
  user.setLanguageId(languageId);
  user.setTimeZoneId(timeZoneId);
  user.setGreeting(greeting);
  user.setResolution(resolution);
  user.setComments(comments);
  UserUtil.update(user);
  Date birthday=PortalUtil.getDate(birthdayMonth,birthdayDay,birthdayYear,new ContactBirthdayException());
  String contactId=userId;
  Contact contact=null;
  try {
    contact=ContactUtil.findByPrimaryKey(contactId);
  }
 catch (  NoSuchContactException nsce) {
    contact=ContactUtil.create(contactId);
    contact.setCompanyId(user.getCompanyId());
    contact.setUserId(StringPool.BLANK);
    contact.setUserName(StringPool.BLANK);
    contact.setCreateDate(now);
    contact.setAccountId(user.getCompanyId());
    contact.setParentContactId(Contact.DEFAULT_PARENT_CONTACT_ID);
  }
  contact.setModifiedDate(now);
  contact.setFirstName(firstName);
  contact.setMiddleName(middleName);
  contact.setLastName(lastName);
  contact.setNickName(nickName);
  contact.setPrefixId(prefixId);
  contact.setSuffixId(suffixId);
  contact.setMale(male);
  contact.setBirthday(birthday);
  contact.setSmsSn(smsSn);
  contact.setAimSn(aimSn);
  contact.setIcqSn(icqSn);
  contact.setMsnSn(msnSn);
  contact.setSkypeSn(skypeSn);
  contact.setYmSn(ymSn);
  contact.setJobTitle(jobTitle);
  ContactUtil.update(contact);
  if (Validator.isNotNull(organizationId) && Validator.isNotNull(locationId)) {
    UserUtil.setOrganizations(userId,new String[]{organizationId,locationId});
  }
  return user;
}
