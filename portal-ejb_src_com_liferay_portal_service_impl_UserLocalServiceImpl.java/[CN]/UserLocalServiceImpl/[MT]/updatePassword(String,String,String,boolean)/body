{
  userId=userId.trim().toLowerCase();
  validatePassword(userId,password1,password2);
  User user=UserUtil.findByPrimaryKey(userId);
  String oldEncPwd=user.getPassword();
  if (!user.isPasswordEncrypted()) {
    oldEncPwd=PwdEncryptor.encrypt(user.getPassword());
  }
  String newEncPwd=PwdEncryptor.encrypt(password1);
  int passwordsLifespan=GetterUtil.getInteger(PropsUtil.get(PropsUtil.PASSWORDS_LIFESPAN));
  Date expirationDate=null;
  if (passwordsLifespan > 0) {
    expirationDate=new Date(System.currentTimeMillis() + Time.DAY * passwordsLifespan);
  }
  if (user.hasCompanyMx()) {
    try {
      MailServiceUtil.updatePassword(userId,password1);
    }
 catch (    RemoteException re) {
      throw new SystemException(re);
    }
  }
  user.setPassword(newEncPwd);
  user.setPasswordUnencrypted(password1);
  user.setPasswordEncrypted(true);
  user.setPasswordExpirationDate(expirationDate);
  user.setPasswordReset(passwordReset);
  UserUtil.update(user);
  PasswordTrackerLocalServiceUtil.trackPassword(userId,oldEncPwd);
  return user;
}
