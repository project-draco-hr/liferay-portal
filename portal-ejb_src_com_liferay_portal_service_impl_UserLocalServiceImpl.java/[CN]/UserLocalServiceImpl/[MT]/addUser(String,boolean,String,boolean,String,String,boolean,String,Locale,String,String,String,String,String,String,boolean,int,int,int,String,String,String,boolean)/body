{
  userId=userId.trim().toLowerCase();
  emailAddress=emailAddress.trim().toLowerCase();
  Date now=new Date();
  boolean alwaysAutoUserId=GetterUtil.getBoolean(PropsUtil.get(PropsUtil.USERS_ID_ALWAYS_AUTOGENERATE));
  if (alwaysAutoUserId) {
    autoUserId=true;
  }
  validate(companyId,autoUserId,userId,autoPassword,password1,password2,emailAddress,firstName,lastName,organizationId,locationId);
  validateOrganizations(companyId,organizationId,locationId);
  if (autoUserId) {
    userId=companyId + "." + Long.toString(CounterServiceUtil.increment(User.class.getName() + "." + companyId));
  }
  if (autoPassword) {
    password1=PwdToolkitUtil.generate();
  }
  int passwordsLifespan=GetterUtil.getInteger(PropsUtil.get(PropsUtil.PASSWORDS_LIFESPAN));
  Date expirationDate=null;
  if (passwordsLifespan > 0) {
    expirationDate=new Date(System.currentTimeMillis() + Time.DAY * passwordsLifespan);
  }
  User defaultUser=getDefaultUser(companyId);
  String fullName=User.getFullName(firstName,middleName,lastName);
  String greeting=null;
  try {
    greeting=LanguageUtil.get(companyId,locale,"welcome") + ", " + fullName+ "!";
  }
 catch (  LanguageException le) {
    greeting="Welcome, " + fullName + "!";
  }
  User user=UserUtil.create(userId);
  user.setCompanyId(companyId);
  user.setCreateDate(now);
  user.setModifiedDate(now);
  user.setPassword(PwdEncryptor.encrypt(password1));
  user.setPasswordUnencrypted(password1);
  user.setPasswordEncrypted(true);
  user.setPasswordExpirationDate(expirationDate);
  user.setPasswordReset(passwordReset);
  user.setEmailAddress(emailAddress);
  user.setLanguageId(locale.toString());
  user.setTimeZoneId(defaultUser.getTimeZoneId());
  user.setGreeting(greeting);
  user.setResolution(defaultUser.getResolution());
  user.setActive(true);
  UserUtil.update(user);
  if (user.hasCompanyMx()) {
    MailServiceUtil.addUser(userId,password1,firstName,middleName,lastName,emailAddress);
  }
  Date birthday=PortalUtil.getDate(birthdayMonth,birthdayDay,birthdayYear,new ContactBirthdayException());
  String contactId=userId;
  Contact contact=ContactUtil.create(contactId);
  contact.setCompanyId(user.getCompanyId());
  contact.setUserId(StringPool.BLANK);
  contact.setUserName(StringPool.BLANK);
  contact.setCreateDate(now);
  contact.setModifiedDate(now);
  contact.setAccountId(user.getCompanyId());
  contact.setParentContactId(Contact.DEFAULT_PARENT_CONTACT_ID);
  contact.setFirstName(firstName);
  contact.setMiddleName(middleName);
  contact.setLastName(lastName);
  contact.setNickName(nickName);
  contact.setPrefixId(prefixId);
  contact.setSuffixId(suffixId);
  contact.setMale(male);
  contact.setBirthday(birthday);
  contact.setJobTitle(jobTitle);
  ContactUtil.update(contact);
  if (Validator.isNotNull(organizationId) && Validator.isNotNull(locationId)) {
    UserUtil.setOrganizations(userId,new String[]{organizationId,locationId});
  }
  GroupLocalServiceUtil.addGroup(user.getCompanyId(),User.class.getName(),user.getPrimaryKey().toString(),null,null);
  List groups=new ArrayList();
  String[] defaultGroupNames=AdminUtil.getDefaultGroupNames(companyId);
  for (int i=0; i < defaultGroupNames.length; i++) {
    try {
      Group group=GroupFinder.findByC_N_2(companyId,defaultGroupNames[i]);
      groups.add(group);
    }
 catch (    NoSuchGroupException nsge) {
    }
  }
  UserUtil.setGroups(userId,groups);
  List roles=new ArrayList();
  String[] defaultRoleNames=AdminUtil.getDefaultRoleNames(companyId);
  for (int i=0; i < defaultRoleNames.length; i++) {
    try {
      Role role=RoleFinder.findByC_N_2(companyId,defaultRoleNames[i]);
      roles.add(role);
    }
 catch (    NoSuchRoleException nsge) {
    }
  }
  UserUtil.setRoles(userId,roles);
  if (sendEmail) {
    sendEmail(user,password1);
  }
  return user;
}
