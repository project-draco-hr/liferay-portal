{
  FlagsRequest flagsRequest=(FlagsRequest)message.getPayload();
  ServiceContext serviceContext=flagsRequest.getServiceContext();
  long companyId=serviceContext.getCompanyId();
  Company company=CompanyLocalServiceUtil.getCompany(serviceContext.getCompanyId());
  Layout layout=LayoutLocalServiceUtil.getLayout(serviceContext.getPlid());
  Group group=layout.getGroup();
  String groupName=HtmlUtil.escape(group.getDescriptiveName());
  String reporterUserName=null;
  String reporterEmailAddress=null;
  User reporterUser=UserLocalServiceUtil.getUserById(serviceContext.getUserId());
  Locale locale=LocaleUtil.getDefault();
  if (reporterUser.isDefaultUser()) {
    reporterUserName=LanguageUtil.get(locale,"anonymous");
  }
 else {
    reporterUserName=reporterUser.getFullName();
    reporterEmailAddress=reporterUser.getEmailAddress();
  }
  String reportedUserName=StringPool.BLANK;
  String reportedEmailAddress=StringPool.BLANK;
  String reportedURL=StringPool.BLANK;
  User reportedUser=UserLocalServiceUtil.getUserById(flagsRequest.getReportedUserId());
  if (reportedUser.isDefaultUser()) {
    reportedUserName=HtmlUtil.escape(group.getDescriptiveName());
  }
 else {
    reportedUserName=HtmlUtil.escape(reportedUser.getFullName());
    reportedEmailAddress=reportedUser.getEmailAddress();
    reportedURL=reportedUser.getDisplayURL(serviceContext.getPortalURL(),serviceContext.getPathMain());
  }
  String contentType=ResourceActionsUtil.getModelResource(locale,flagsRequest.getClassName());
  String reason=LanguageUtil.get(locale,flagsRequest.getReason());
  String fromName=PrefsPropsUtil.getStringFromNames(companyId,PropsKeys.FLAGS_EMAIL_FROM_NAME,PropsKeys.ADMIN_EMAIL_FROM_NAME);
  String fromAddress=PrefsPropsUtil.getStringFromNames(companyId,PropsKeys.FLAGS_EMAIL_FROM_ADDRESS,PropsKeys.ADMIN_EMAIL_FROM_ADDRESS);
  String subject=PrefsPropsUtil.getContent(companyId,PropsKeys.FLAGS_EMAIL_SUBJECT);
  String body=PrefsPropsUtil.getContent(companyId,PropsKeys.FLAGS_EMAIL_BODY);
  List<User> recipients=getRecipients(companyId,serviceContext.getScopeGroupId());
  for (  User recipient : recipients) {
    try {
      notify(company,groupName,reporterEmailAddress,reporterUserName,reportedEmailAddress,reportedUserName,reportedURL,flagsRequest.getClassPK(),flagsRequest.getContentTitle(),contentType,flagsRequest.getContentURL(),reason,fromName,fromAddress,recipient.getFullName(),recipient.getEmailAddress(),subject,body,serviceContext);
    }
 catch (    IOException ioe) {
      if (_log.isWarnEnabled()) {
        _log.warn(ioe);
      }
    }
  }
}
