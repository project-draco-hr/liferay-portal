{
  if (inputStream == null) {
    throw new IOException("InputStream is null");
  }
  File tempFile=new File(getFilePath(fileName));
  try {
    if (!tempFile.exists() || (tempFile.exists() && (tempFile.lastModified() < lastModifiedDate))) {
      File parentFile=tempFile.getParentFile();
      parentFile.mkdirs();
      FileOutputStream outputStream=new FileOutputStream(tempFile);
      StreamUtil.transfer(inputStream,outputStream);
    }
  }
  finally {
    StreamUtil.cleanUp(inputStream);
  }
  return tempFile;
}
