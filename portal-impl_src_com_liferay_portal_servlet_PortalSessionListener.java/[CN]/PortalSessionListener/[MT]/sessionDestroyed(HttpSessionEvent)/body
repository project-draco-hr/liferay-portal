{
  if (PropsValues.SESSION_DISABLED) {
    return;
  }
  HttpSession session=event.getSession();
  PortalSessionContext.remove(session.getId());
  try {
    Long userIdObj=(Long)session.getAttribute(WebKeys.USER_ID);
    if (userIdObj == null) {
      _log.warn("User id is not in the session");
    }
    if (userIdObj == null) {
      return;
    }
    session.removeAttribute(Globals.LOCALE_KEY);
    if (PropsValues.LIVE_USERS_ENABLED) {
      long userId=userIdObj.longValue();
      long companyId=getCompanyId(userId);
      String sessionId=session.getId();
      Message message=new Message(MessageTypes.LIVE_USER_MESSAGE);
      JSONObject jsonObj=JSONFactoryUtil.createJSONObject();
      jsonObj.put("command","signOut");
      jsonObj.put("companyId",companyId);
      jsonObj.put("userId",userId);
      jsonObj.put("sessionId",sessionId);
      message.setPayload(jsonObj.toString());
      MessageBusUtil.sendMessage(DestinationNames.LIVE_USERS,message);
    }
    Message message=new Message(MessageTypes.RUON_MESSAGE);
    message.setDestination(DestinationNames.RUON);
    JSONObject ruonJSON=JSONFactoryUtil.createJSONObject();
    JSONObject setPresenceStatusRequestJSON=JSONFactoryUtil.createJSONObject();
    setPresenceStatusRequestJSON.put("userId",userIdObj.toString());
    setPresenceStatusRequestJSON.put("status","offline");
    ruonJSON.put("setPresenceStatusRequest",setPresenceStatusRequestJSON);
    message.setPayload(ruonJSON.toString());
    MessageBusUtil.sendMessage(DestinationNames.RUON,message);
  }
 catch (  IllegalStateException ise) {
    _log.warn("Please upgrade to a servlet 2.4 compliant container");
  }
catch (  Exception e) {
    _log.error(e,e);
  }
  session.removeAttribute(WebKeys.PORTLET_SESSION_TRACKER);
  try {
    EventsProcessor.process(PropsKeys.SERVLET_SESSION_DESTROY_EVENTS,PropsValues.SERVLET_SESSION_DESTROY_EVENTS,session);
  }
 catch (  ActionException ae) {
    _log.error(ae,ae);
  }
}
