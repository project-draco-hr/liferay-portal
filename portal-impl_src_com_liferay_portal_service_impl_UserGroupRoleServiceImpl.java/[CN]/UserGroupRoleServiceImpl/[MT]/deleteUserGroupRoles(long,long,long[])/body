{
  List<UserGroupRole> filteredOrganizationUserGroupRoles=new ArrayList<UserGroupRole>();
  List<UserGroupRole> filteredSiteUserGroupRoles=new ArrayList<UserGroupRole>();
  Group group=groupLocalService.getGroup(groupId);
  for (  long roleId : roleIds) {
    Role role=roleLocalService.getRole(roleId);
    UserGroupRolePermissionUtil.check(getPermissionChecker(),group,role);
    UserGroupRolePK userGroupRolePK=new UserGroupRolePK(userId,groupId,roleId);
    UserGroupRole userGroupRole=userGroupRolePersistence.create(userGroupRolePK);
    if (role.getType() == RoleConstants.TYPE_ORGANIZATION) {
      if (!OrganizationMembershipPolicyUtil.isRoleProtected(getPermissionChecker(),userId,group.getOrganizationId(),roleId)) {
        filteredOrganizationUserGroupRoles.add(userGroupRole);
      }
    }
 else     if ((role.getType() == RoleConstants.TYPE_SITE) && !SiteMembershipPolicyUtil.isRoleProtected(getPermissionChecker(),userId,groupId,roleId)) {
      filteredSiteUserGroupRoles.add(userGroupRole);
    }
  }
  if (filteredOrganizationUserGroupRoles.isEmpty() && filteredSiteUserGroupRoles.isEmpty()) {
    return;
  }
  if (!filteredOrganizationUserGroupRoles.isEmpty()) {
    OrganizationMembershipPolicyUtil.checkRoles(null,filteredOrganizationUserGroupRoles);
  }
  if (!filteredSiteUserGroupRoles.isEmpty()) {
    SiteMembershipPolicyUtil.checkRoles(null,filteredSiteUserGroupRoles);
  }
  userGroupRoleLocalService.deleteUserGroupRoles(userId,groupId,roleIds);
  if (!filteredOrganizationUserGroupRoles.isEmpty()) {
    OrganizationMembershipPolicyUtil.propagateRoles(null,filteredOrganizationUserGroupRoles);
  }
  if (!filteredSiteUserGroupRoles.isEmpty()) {
    SiteMembershipPolicyUtil.propagateRoles(null,filteredSiteUserGroupRoles);
  }
}
