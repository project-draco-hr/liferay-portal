{
  List<UserGroupRole> filteredUserGroupRoles=new ArrayList<UserGroupRole>();
  List<UserGroupRole> filteredUserOrganizationRoles=new ArrayList<UserGroupRole>();
  for (  long roleId : roleIds) {
    UserGroupRolePermissionUtil.check(getPermissionChecker(),groupId,roleId);
    Role role=roleLocalService.getRole(roleId);
    UserGroupRolePK userGroupRolePK=new UserGroupRolePK(userId,groupId,roleId);
    UserGroupRole userGroupRole=userGroupRoleLocalService.createUserGroupRole(userGroupRolePK);
    if (role.getType() == RoleConstants.TYPE_ORGANIZATION) {
      Group group=groupLocalService.getGroup(groupId);
      if (!OrganizationMembershipPolicyUtil.isRoleProtected(getPermissionChecker(),userId,group.getOrganizationId(),roleId)) {
        filteredUserOrganizationRoles.add(userGroupRole);
      }
    }
 else     if ((role.getType() == RoleConstants.TYPE_SITE) && !SiteMembershipPolicyUtil.isRoleProtected(getPermissionChecker(),userId,groupId,roleId)) {
      filteredUserGroupRoles.add(userGroupRole);
    }
  }
  if (filteredUserGroupRoles.isEmpty() && filteredUserOrganizationRoles.isEmpty()) {
    return;
  }
  if (!filteredUserGroupRoles.isEmpty()) {
    SiteMembershipPolicyUtil.checkRoles(null,filteredUserGroupRoles);
  }
  if (!filteredUserOrganizationRoles.isEmpty()) {
    OrganizationMembershipPolicyUtil.checkRoles(null,filteredUserGroupRoles);
  }
  userGroupRoleLocalService.deleteUserGroupRoles(userId,groupId,roleIds);
  if (!filteredUserGroupRoles.isEmpty()) {
    SiteMembershipPolicyUtil.propagateRoles(null,filteredUserGroupRoles);
  }
  if (!filteredUserOrganizationRoles.isEmpty()) {
    OrganizationMembershipPolicyUtil.propagateRoles(null,filteredUserOrganizationRoles);
  }
}
