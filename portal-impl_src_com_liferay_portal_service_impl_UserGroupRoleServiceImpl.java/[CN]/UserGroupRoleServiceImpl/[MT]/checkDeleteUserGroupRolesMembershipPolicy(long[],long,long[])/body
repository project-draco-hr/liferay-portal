{
  MembershipPolicyException membershipPolicyException=null;
  Group group=groupLocalService.getGroup(groupId);
  for (  long roleId : roleIds) {
    Role role=rolePersistence.findByPrimaryKey(roleId);
    for (    long userId : userIds) {
      User user=userPersistence.findByPrimaryKey(userId);
      Set<Role> mandatoryRoles=MembershipPolicyUtil.getMandatoryRoles(group,user);
      if (!mandatoryRoles.contains(role)) {
        continue;
      }
      if (membershipPolicyException == null) {
        membershipPolicyException=new MembershipPolicyException(MembershipPolicyException.ROLE_MEMBERSHIP_REQUIRED);
        membershipPolicyException.addGroup(group);
      }
      if (!membershipPolicyException.getUsers().contains(user)) {
        membershipPolicyException.addUser(user);
      }
      if (!membershipPolicyException.getRoles().contains(role)) {
        membershipPolicyException.addRole(role);
      }
    }
  }
  if (membershipPolicyException != null) {
    throw membershipPolicyException;
  }
}
