{
  Map<String,PortletContext> portletContexts=_pool.get(portlet.getRootPortletId());
  if (portletContexts == null) {
    portletContexts=new ConcurrentHashMap<>();
    _pool.put(portlet.getRootPortletId(),portletContexts);
  }
  PortletContext portletContext=portletContexts.get(portlet.getPortletId());
  if (portletContext != null) {
    return DoPrivilegedUtil.wrap(portletContext);
  }
  PortletApp portletApp=portlet.getPortletApp();
  if (portletApp.isWARFile()) {
    PortletBag portletBag=PortletBagPool.get(portlet.getRootPortletId());
    if (portletBag == null) {
      _log.error("Portlet " + portlet.getRootPortletId() + " has a null portlet bag");
    }
    servletContext=portletBag.getServletContext();
  }
  portletContext=new PortletContextImpl(portlet,servletContext);
  portletContexts.put(portlet.getPortletId(),portletContext);
  return DoPrivilegedUtil.wrap(portletContext);
}
