{
  Map<String,PortletContext> portletContexts=_pool.get(portlet.getRootPortletId());
  if (portletContexts == null) {
    portletContexts=new ConcurrentHashMap<String,PortletContext>();
    _pool.put(portlet.getRootPortletId(),portletContexts);
  }
  PortletContext portletContext=portletContexts.get(portlet.getPortletId());
  if (portletContext == null) {
    PortletApp portletApp=portlet.getPortletApp();
    if (portletApp.isWARFile()) {
      PortletBag portletBag=PortletBagPool.get(portlet.getRootPortletId());
      if (portletBag == null) {
        _log.error("Portlet " + portlet.getRootPortletId() + " has a null portlet bag");
      }
      ctx=portletBag.getServletContext();
    }
    portletContext=new PortletContextImpl(portlet,ctx);
    VelocityContextPool.put(portletContext.getPortletContextName(),ctx);
    portletContexts.put(portlet.getPortletId(),portletContext);
  }
  return portletContext;
}
