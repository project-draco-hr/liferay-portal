{
  LayoutTypePortlet layoutTypePortlet=(LayoutTypePortlet)layout.getLayoutType();
  String newPortletId=layoutTypePortlet.addPortletId(userId,portletId,columnId,-1);
  LayoutLocalServiceUtil.updateLayout(layout.getGroupId(),layout.isPrivateLayout(),layout.getLayoutId(),layout.getTypeSettings());
  if (preferenceMap == null) {
    return newPortletId;
  }
  PortletPreferences portletPreferences=getPortletPreferences(layout.getCompanyId(),layout.getPlid(),newPortletId);
  for (  String key : preferenceMap.keySet()) {
    portletPreferences.setValues(key,preferenceMap.get(key));
  }
  updatePortletPreferences(layout.getPlid(),newPortletId,portletPreferences);
  return newPortletId;
}
