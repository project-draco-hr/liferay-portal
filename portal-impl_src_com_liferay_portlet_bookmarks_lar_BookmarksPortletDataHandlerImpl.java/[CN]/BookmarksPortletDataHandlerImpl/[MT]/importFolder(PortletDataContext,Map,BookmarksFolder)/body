{
  BookmarksFolder existingFolder=BookmarksFolderUtil.fetchByPrimaryKey(folder.getPrimaryKey());
  Long newParentFolderId=(Long)folderPKs.get(new Long(folder.getParentFolderId()));
  if (newParentFolderId == null) {
    newParentFolderId=new Long(folder.getParentFolderId());
  }
  if ((existingFolder == null) || (existingFolder.getGroupId() != context.getGroupId())) {
    long plid=context.getPlid();
    boolean addCommunityPermissions=true;
    boolean addGuestPermissions=true;
    BookmarksFolder newFolder=BookmarksFolderLocalServiceUtil.addFolder(folder.getUserId(),plid,newParentFolderId.longValue(),folder.getName(),folder.getDescription(),addCommunityPermissions,addGuestPermissions);
    folderPKs.put(folder.getPrimaryKeyObj(),newFolder.getPrimaryKeyObj());
  }
 else {
    folder.setParentFolderId(newParentFolderId.longValue());
    BookmarksFolderUtil.update(folder,true);
  }
}
