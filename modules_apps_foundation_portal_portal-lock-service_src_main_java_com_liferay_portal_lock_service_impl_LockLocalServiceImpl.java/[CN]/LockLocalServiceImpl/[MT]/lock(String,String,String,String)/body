{
  Lock lock=lockFinder.fetchByC_K(className,key,LockMode.UPGRADE);
  if (lock == null) {
    long lockId=counterLocalService.increment();
    lock=lockPersistence.create(lockId);
    lock.setCreateDate(new Date());
    lock.setClassName(className);
    lock.setKey(key);
    lock.setOwner(updatedOwner);
    lockPersistence.update(lock);
    lock.setNew(true);
    lockPersistence.flush();
  }
 else   if (Validator.equals(lock.getOwner(),expectedOwner)) {
    lock.setCreateDate(new Date());
    lock.setClassName(className);
    lock.setKey(key);
    lock.setOwner(updatedOwner);
    lockPersistence.update(lock);
    lock.setNew(true);
    lockPersistence.flush();
  }
  return lock;
}
