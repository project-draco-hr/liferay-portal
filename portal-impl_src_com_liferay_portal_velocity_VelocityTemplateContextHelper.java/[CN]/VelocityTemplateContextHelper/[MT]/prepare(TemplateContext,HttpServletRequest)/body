{
  super.prepare(templateContext,request);
  ThemeDisplay themeDisplay=(ThemeDisplay)request.getAttribute(WebKeys.THEME_DISPLAY);
  if (themeDisplay != null) {
    templateContext.put("init",themeDisplay.getPathContext() + TemplateResourceParser.SERVLET_SEPARATOR + "/html/themes/_unstyled/templates/init.vm");
  }
  Theme theme=(Theme)request.getAttribute(WebKeys.THEME);
  if ((theme == null) && (themeDisplay != null)) {
    theme=themeDisplay.getTheme();
  }
  if (theme != null) {
    String servletContextName=GetterUtil.getString(theme.getServletContextName());
    templateContext.put("fullCssPath",servletContextName + theme.getVelocityResourceListener() + theme.getCssPath());
    templateContext.put("fullTemplatesPath",servletContextName + theme.getVelocityResourceListener() + theme.getTemplatesPath());
  }
  Map<String,Object> vmVariables=(Map<String,Object>)request.getAttribute(WebKeys.VM_VARIABLES);
  if (vmVariables != null) {
    for (    Map.Entry<String,Object> entry : vmVariables.entrySet()) {
      String key=entry.getKey();
      Object value=entry.getValue();
      if (Validator.isNotNull(key)) {
        templateContext.put(key,value);
      }
    }
  }
}
