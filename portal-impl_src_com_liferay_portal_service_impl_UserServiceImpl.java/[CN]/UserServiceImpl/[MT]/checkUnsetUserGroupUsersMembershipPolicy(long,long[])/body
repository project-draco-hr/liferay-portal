{
  MembershipPolicyException membershipPolicyException=null;
  UserGroup userGroup=userGroupPersistence.findByPrimaryKey(userGroupId);
  for (  long userId : userIds) {
    User user=userPersistence.findByPrimaryKey(userId);
    Set<UserGroup> mandatoryUserGroups=MembershipPolicyUtil.getMandatoryUserGroups(user);
    if (mandatoryUserGroups.contains(userGroup)) {
      if (membershipPolicyException == null) {
        membershipPolicyException=new MembershipPolicyException(MembershipPolicyException.USER_GROUP_MEMBERSHIP_REQUIRED);
        membershipPolicyException.addUserGroup(userGroup);
      }
      membershipPolicyException.addUser(user);
    }
  }
  if (membershipPolicyException != null) {
    throw membershipPolicyException;
  }
}
