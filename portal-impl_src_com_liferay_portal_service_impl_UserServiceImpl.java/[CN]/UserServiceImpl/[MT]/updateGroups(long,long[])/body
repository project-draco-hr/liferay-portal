{
  UserPermissionUtil.check(getPermissionChecker(),userId,ActionKeys.UPDATE);
  for (  long groupId : groupIds) {
    GroupPermissionUtil.check(getPermissionChecker(),groupId,ActionKeys.ASSIGN_MEMBERS);
  }
  List<Group> oldGroups=groupLocalService.getUserGroups(userId);
  for (  Group group : oldGroups) {
    if (!ArrayUtil.contains(groupIds,group.getGroupId()) && !GroupPermissionUtil.contains(getPermissionChecker(),group.getGroupId(),ActionKeys.ASSIGN_MEMBERS)) {
      groupIds=ArrayUtil.append(groupIds,group.getGroupId());
    }
  }
  userLocalService.updateGroups(userId,groupIds);
}
