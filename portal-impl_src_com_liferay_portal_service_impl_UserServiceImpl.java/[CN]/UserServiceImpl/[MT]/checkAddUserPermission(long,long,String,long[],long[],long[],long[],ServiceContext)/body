{
  Company company=companyPersistence.findByPrimaryKey(companyId);
  if (groupIds != null) {
    checkGroups(CompanyConstants.SYSTEM,groupIds);
  }
  if (organizationIds != null) {
    checkOrganizations(CompanyConstants.SYSTEM,organizationIds);
  }
  if (roleIds != null) {
    checkRoles(CompanyConstants.SYSTEM,roleIds);
  }
  if (userGroupIds != null) {
    checkUserGroupIds(CompanyConstants.SYSTEM,userGroupIds);
  }
  boolean anonymousUser=GetterUtil.getBoolean(serviceContext.getAttribute("anonymousUser"));
  if ((creatorUserId != 0) || (!company.isStrangers() && !anonymousUser)) {
    if (!PortalPermissionUtil.contains(getPermissionChecker(),ActionKeys.ADD_USER) && !OrganizationPermissionUtil.contains(getPermissionChecker(),organizationIds,ActionKeys.ASSIGN_MEMBERS)) {
      throw new PrincipalException();
    }
  }
  if ((creatorUserId == 0) || (creatorUserId == getDefaultUserId(companyId))) {
    if (!company.isStrangersWithMx() && company.hasCompanyMx(emailAddress)) {
      throw new ReservedUserEmailAddressException();
    }
  }
}
