{
  Company company=companyPersistence.findByPrimaryKey(companyId);
  if (groupIds != null) {
    checkGroups(0,groupIds,null,null);
  }
  if (organizationIds != null) {
    checkOrganizations(0,organizationIds,null,null);
  }
  if (roleIds != null) {
    checkRoles(0,roleIds,null,null);
  }
  if (userGroupIds != null) {
    checkUserGroupIds(0,userGroupIds,null,null);
  }
  boolean anonymousUser=ParamUtil.getBoolean(serviceContext,"anonymousUser");
  long defaultUserId=userLocalService.getDefaultUserId(companyId);
  if (((creatorUserId != 0) && (creatorUserId != defaultUserId)) || (!company.isStrangers() && !anonymousUser)) {
    if (!PortalPermissionUtil.contains(getPermissionChecker(),ActionKeys.ADD_USER) && !OrganizationPermissionUtil.contains(getPermissionChecker(),organizationIds,ActionKeys.ASSIGN_MEMBERS)) {
      throw new PrincipalException();
    }
  }
  if ((creatorUserId == 0) || (creatorUserId == defaultUserId)) {
    if (!company.isStrangersWithMx() && company.hasCompanyMx(emailAddress)) {
      throw new ReservedUserEmailAddressException();
    }
  }
}
