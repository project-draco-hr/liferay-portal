{
  MembershipPolicyException membershipPolicyException=null;
  Role role=rolePersistence.findByPrimaryKey(roleId);
  for (  long userId : userIds) {
    User user=userPersistence.findByPrimaryKey(userId);
    Set<Role> mandatoryRoles=MembershipPolicyUtil.getMandatoryRoles(user);
    if (!mandatoryRoles.contains(role)) {
      continue;
    }
    if (membershipPolicyException == null) {
      membershipPolicyException=new MembershipPolicyException(MembershipPolicyException.ROLE_MEMBERSHIP_REQUIRED);
      membershipPolicyException.addRole(role);
    }
    membershipPolicyException.addUser(user);
  }
  if (membershipPolicyException != null) {
    throw membershipPolicyException;
  }
}
