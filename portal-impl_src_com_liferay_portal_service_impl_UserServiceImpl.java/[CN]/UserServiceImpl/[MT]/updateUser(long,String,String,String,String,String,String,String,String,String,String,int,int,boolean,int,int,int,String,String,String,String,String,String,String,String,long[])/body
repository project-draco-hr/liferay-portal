{
  checkPermission(userId,organizationIds,ActionKeys.UPDATE);
  long curUserId=getUserId();
  if (curUserId == userId) {
    emailAddress=emailAddress.trim().toLowerCase();
    User user=UserUtil.findByPrimaryKey(userId);
    if (!emailAddress.equalsIgnoreCase(user.getEmailAddress())) {
      if (!user.hasCompanyMx() && user.hasCompanyMx(emailAddress)) {
        Company company=CompanyUtil.findByPrimaryKey(user.getCompanyId());
        if (!company.isStrangersWithMx()) {
          throw new ReservedUserEmailAddressException();
        }
      }
    }
  }
  return UserLocalServiceUtil.updateUser(userId,password,screenName,emailAddress,languageId,timeZoneId,greeting,comments,firstName,middleName,lastName,prefixId,suffixId,male,birthdayMonth,birthdayDay,birthdayYear,smsSn,aimSn,icqSn,jabberSn,msnSn,skypeSn,ymSn,jobTitle,organizationIds);
}
