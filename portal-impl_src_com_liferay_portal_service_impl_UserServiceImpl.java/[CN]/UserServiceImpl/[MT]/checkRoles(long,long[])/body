{
  long[] oldRoleIds=null;
  PermissionChecker permissionChecker=getPermissionChecker();
  if (userId != CompanyConstants.SYSTEM) {
    List<Role> oldRoles=roleLocalService.getUserRoles(userId);
    oldRoleIds=new long[oldRoles.size()];
    for (int i=0; i < oldRoles.size(); i++) {
      Role role=oldRoles.get(i);
      if (!ArrayUtil.contains(roleIds,role.getRoleId()) && (!RolePermissionUtil.contains(permissionChecker,role.getRoleId(),ActionKeys.ASSIGN_MEMBERS) || RoleMembershipPolicyUtil.isRoleRequired(userId,role.getRoleId()))) {
        roleIds=ArrayUtil.append(roleIds,role.getRoleId());
      }
      oldRoleIds[i]=role.getRoleId();
    }
  }
  for (  long roleId : roleIds) {
    if ((oldRoleIds != null) && ArrayUtil.contains(oldRoleIds,roleId)) {
      continue;
    }
    RolePermissionUtil.check(permissionChecker,roleId,ActionKeys.ASSIGN_MEMBERS);
  }
  if (userId != CompanyConstants.SYSTEM) {
    return UsersAdminUtil.addRequiredRoles(userId,roleIds);
  }
 else {
    return roleIds;
  }
}
