{
  UserPermissionUtil.check(getPermissionChecker(),userId,organizationIds,ActionKeys.UPDATE);
  long curUserId=getUserId();
  if (curUserId == userId) {
    emailAddress=emailAddress.trim().toLowerCase();
    User user=userPersistence.findByPrimaryKey(userId);
    if (!emailAddress.equalsIgnoreCase(user.getEmailAddress())) {
      if (!user.hasCompanyMx() && user.hasCompanyMx(emailAddress)) {
        Company company=companyPersistence.findByPrimaryKey(user.getCompanyId());
        if (!company.isStrangersWithMx()) {
          throw new ReservedUserEmailAddressException();
        }
      }
    }
  }
  for (  long organizationId : organizationIds) {
    OrganizationPermissionUtil.check(getPermissionChecker(),organizationId,ActionKeys.ASSIGN_MEMBERS);
  }
  List<Organization> oldOrganizations=organizationLocalService.getUserOrganizations(userId);
  for (  Organization organization : oldOrganizations) {
    if (!ArrayUtil.contains(organizationIds,organization.getOrganizationId()) && !OrganizationPermissionUtil.contains(getPermissionChecker(),organization.getOrganizationId(),ActionKeys.ASSIGN_MEMBERS)) {
      organizationIds=ArrayUtil.append(organizationIds,organization.getOrganizationId());
    }
  }
  return userLocalService.updateUser(userId,oldPassword,newPassword1,newPassword2,passwordReset,screenName,emailAddress,languageId,timeZoneId,greeting,comments,firstName,middleName,lastName,prefixId,suffixId,male,birthdayMonth,birthdayDay,birthdayYear,smsSn,aimSn,facebookSn,icqSn,jabberSn,msnSn,mySpaceSn,skypeSn,twitterSn,ymSn,jobTitle,organizationIds);
}
