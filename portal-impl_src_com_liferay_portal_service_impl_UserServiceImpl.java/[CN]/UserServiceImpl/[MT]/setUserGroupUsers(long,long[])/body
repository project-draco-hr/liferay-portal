{
  UserGroupPermissionUtil.check(getPermissionChecker(),userGroupId,ActionKeys.ASSIGN_MEMBERS);
  List<Long> unsetUserIds=new ArrayList<Long>(userIds.length);
  List<User> users=userGroupPersistence.getUsers(userGroupId);
  for (  User user : users) {
    if (!ArrayUtil.contains(userIds,user.getUserId())) {
      unsetUserIds.add(user.getUserId());
    }
  }
  if (!unsetUserIds.isEmpty()) {
    UserGroupMembershipPolicyUtil.checkMembership(ArrayUtil.toLongArray(unsetUserIds),null,new long[]{userGroupId});
  }
  if (userIds.length > 0) {
    UserGroupMembershipPolicyUtil.checkMembership(userIds,new long[]{userGroupId},null);
  }
  userLocalService.setUserGroupUsers(userGroupId,userIds);
  if (!unsetUserIds.isEmpty()) {
    UserGroupMembershipPolicyUtil.propagateMembership(ArrayUtil.toLongArray(unsetUserIds),null,new long[]{userGroupId});
  }
  if (userIds.length > 0) {
    UserGroupMembershipPolicyUtil.propagateMembership(userIds,new long[]{userGroupId},null);
  }
}
