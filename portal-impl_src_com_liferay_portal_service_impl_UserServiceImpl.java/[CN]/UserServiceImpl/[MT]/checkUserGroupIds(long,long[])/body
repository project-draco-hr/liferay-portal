{
  long[] oldUserGroupIds=null;
  PermissionChecker permissionChecker=getPermissionChecker();
  User user=null;
  if (userId != CompanyConstants.SYSTEM) {
    user=userPersistence.findByPrimaryKey(userId);
    List<UserGroup> oldUserGroups=userGroupLocalService.getUserUserGroups(userId);
    oldUserGroupIds=new long[oldUserGroups.size()];
    for (int i=0; i < oldUserGroups.size(); i++) {
      UserGroup userGroup=oldUserGroups.get(i);
      if (!ArrayUtil.contains(userGroupIds,userGroup.getUserGroupId()) && (!UserGroupPermissionUtil.contains(permissionChecker,userGroup.getUserGroupId(),ActionKeys.ASSIGN_MEMBERS) || UserGroupMembershipPolicyUtil.isMembershipRequired(userId,userGroup.getUserGroupId()))) {
        userGroupIds=ArrayUtil.append(userGroupIds,userGroup.getUserGroupId());
      }
      oldUserGroupIds[i]=userGroup.getUserGroupId();
    }
  }
  for (  long userGroupId : userGroupIds) {
    if ((oldUserGroupIds == null) || !ArrayUtil.contains(oldUserGroupIds,userGroupId)) {
      UserGroupPermissionUtil.check(permissionChecker,userGroupId,ActionKeys.ASSIGN_MEMBERS);
    }
  }
  return userGroupIds;
}
