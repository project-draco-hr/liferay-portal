{
  long[] oldUserGroupIds=null;
  PermissionChecker permissionChecker=getPermissionChecker();
  User user=userPersistence.findByPrimaryKey(userId);
  if (userId != CompanyConstants.SYSTEM) {
    Set<UserGroup> mandatoryUserGroups=MembershipPolicyUtil.getMandatoryUserGroups(user);
    List<UserGroup> oldUserGroups=userGroupLocalService.getUserUserGroups(userId);
    oldUserGroupIds=new long[oldUserGroups.size()];
    for (int i=0; i < oldUserGroups.size(); i++) {
      UserGroup userGroup=oldUserGroups.get(i);
      if (!ArrayUtil.contains(userGroupIds,userGroup.getUserGroupId()) && (!UserGroupPermissionUtil.contains(permissionChecker,userGroup.getUserGroupId(),ActionKeys.ASSIGN_MEMBERS) || mandatoryUserGroups.contains(userGroup))) {
        userGroupIds=ArrayUtil.append(userGroupIds,userGroup.getUserGroupId());
      }
      oldUserGroupIds[i]=userGroup.getUserGroupId();
    }
  }
  MembershipPolicyException membershipPolicyException=null;
  for (  long userGroupId : userGroupIds) {
    if ((oldUserGroupIds == null) || !ArrayUtil.contains(oldUserGroupIds,userGroupId)) {
      UserGroupPermissionUtil.check(permissionChecker,userGroupId,ActionKeys.ASSIGN_MEMBERS);
      UserGroup userGroup=userGroupPersistence.findByPrimaryKey(userGroupId);
      if (!MembershipPolicyUtil.isMembershipAllowed(userGroup,user)) {
        if (membershipPolicyException == null) {
          membershipPolicyException=new MembershipPolicyException(MembershipPolicyException.USER_GROUP_MEMBERSHIP_NOT_ALLOWED);
          membershipPolicyException.addUser(user);
        }
        membershipPolicyException.addUserGroup(userGroup);
      }
    }
  }
  if (membershipPolicyException != null) {
    throw membershipPolicyException;
  }
  return userGroupIds;
}
