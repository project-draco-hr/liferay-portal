{
  long creatorUserId=0;
  try {
    creatorUserId=getGuestOrUserId();
  }
 catch (  PrincipalException pe) {
  }
  checkAddUserPermission(creatorUserId,companyId,emailAddress,groupIds,organizationIds,roleIds,userGroupIds,serviceContext);
  User user=userLocalService.addUserWithWorkflow(creatorUserId,companyId,autoPassword,password1,password2,autoScreenName,screenName,emailAddress,facebookId,openId,locale,firstName,middleName,lastName,prefixId,suffixId,male,birthdayMonth,birthdayDay,birthdayYear,jobTitle,groupIds,organizationIds,roleIds,userGroupIds,sendEmail,serviceContext);
  if (groupIds != null) {
    SiteMembershipPolicyUtil.propagateMembership(new long[]{user.getUserId()},groupIds,null);
  }
  if (organizationIds != null) {
    OrganizationMembershipPolicyUtil.propagateMembership(new long[]{user.getUserId()},organizationIds,null);
  }
  if (roleIds != null) {
    RoleMembershipPolicyUtil.propagateRoles(new long[]{user.getUserId()},roleIds,null);
  }
  if (userGroupIds != null) {
    UserGroupMembershipPolicyUtil.propagateMembership(new long[]{user.getUserId()},userGroupIds,null);
  }
  return user;
}
