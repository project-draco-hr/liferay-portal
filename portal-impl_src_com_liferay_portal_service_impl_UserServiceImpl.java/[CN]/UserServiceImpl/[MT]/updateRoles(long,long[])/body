{
  UserPermissionUtil.check(getPermissionChecker(),userId,ActionKeys.UPDATE);
  for (  long roleId : roleIds) {
    RolePermissionUtil.check(getPermissionChecker(),roleId,ActionKeys.ASSIGN_MEMBERS);
  }
  List<Role> oldRoles=roleLocalService.getUserRoles(userId);
  for (  Role role : oldRoles) {
    if (!ArrayUtil.contains(roleIds,role.getRoleId()) && !RolePermissionUtil.contains(getPermissionChecker(),role.getRoleId(),ActionKeys.ASSIGN_MEMBERS)) {
      roleIds=ArrayUtil.append(roleIds,role.getRoleId());
    }
  }
  userLocalService.updateRoles(userId,roleIds);
}
