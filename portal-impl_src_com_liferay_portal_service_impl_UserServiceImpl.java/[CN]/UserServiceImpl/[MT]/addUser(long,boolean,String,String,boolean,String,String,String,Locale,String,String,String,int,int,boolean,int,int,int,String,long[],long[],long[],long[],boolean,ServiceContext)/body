{
  Company company=companyPersistence.findByPrimaryKey(companyId);
  long creatorUserId=0;
  try {
    creatorUserId=getUserId();
  }
 catch (  PrincipalException pe) {
  }
  if ((creatorUserId != 0) || !company.isStrangers()) {
    PortalPermissionUtil.check(getPermissionChecker(),ActionKeys.ADD_USER);
  }
  if (creatorUserId == 0) {
    if (!company.isStrangersWithMx() && company.hasCompanyMx(emailAddress)) {
      throw new ReservedUserEmailAddressException();
    }
  }
  return userLocalService.addUser(creatorUserId,companyId,autoPassword,password1,password2,autoScreenName,screenName,emailAddress,openId,locale,firstName,middleName,lastName,prefixId,suffixId,male,birthdayMonth,birthdayDay,birthdayYear,jobTitle,groupIds,organizationIds,roleIds,userGroupIds,sendEmail,serviceContext);
}
