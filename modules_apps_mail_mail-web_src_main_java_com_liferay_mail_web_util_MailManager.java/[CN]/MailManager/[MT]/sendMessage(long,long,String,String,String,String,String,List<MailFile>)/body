{
  try {
    Mailbox mailbox=MailboxFactoryUtil.getMailbox(_user.getUserId(),accountId,_passwordRetriever.getPassword(accountId));
    Message message=mailbox.saveDraft(accountId,messageId,to,cc,bcc,subject,body,mailFiles);
    mailbox.sendMessage(accountId,message.getMessageId());
    return createJSONResult("success","sent-successfully");
  }
 catch (  FileSizeException fse) {
    return createJSONResult("failure","attachment-is-too-large");
  }
catch (  MailException me) {
    if (me.getType() == MailException.MESSAGE_HAS_NO_RECIPIENTS) {
      return createJSONResult("failure","please-specify-at-least-one-recipient");
    }
 else     if (me.getType() == MailException.MESSAGE_INVALID_ADDRESS) {
      return createJSONResult("failure","please-make-sure-the-following-address-is-properly" + "-formatted",HtmlUtil.escape(me.getValue()));
    }
    _log.error(me,me);
    return createJSONResult("failure","unable-to-send-message");
  }
}
