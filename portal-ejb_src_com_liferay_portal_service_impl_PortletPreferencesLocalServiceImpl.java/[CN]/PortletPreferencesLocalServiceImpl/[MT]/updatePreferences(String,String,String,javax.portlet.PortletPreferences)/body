{
  PortletPreferences portletPreferences=null;
  try {
    portletPreferences=PortletPreferencesUtil.findByO_L_P(ownerId,layoutId,portletId);
  }
 catch (  NoSuchPortletPreferencesException nsppe) {
    long portletPreferencesId=CounterLocalServiceUtil.increment();
    portletPreferences=PortletPreferencesUtil.create(portletPreferencesId);
    portletPreferences.setOwnerId(ownerId);
    portletPreferences.setLayoutId(layoutId);
    portletPreferences.setPortletId(portletId);
  }
  PortletPreferencesImpl prefsImpl=(PortletPreferencesImpl)prefs;
  String xml=PortletPreferencesSerializer.toXML(prefsImpl);
  portletPreferences.setPreferences(xml);
  PortletPreferencesUtil.update(portletPreferences);
  PortletPreferencesLocalUtil.clearPreferencesPool(ownerId);
  return portletPreferences;
}
