{
  Map prefsPool=PortletPreferencesLocalUtil.getPreferencesPool(pk.ownerId);
  PortletPreferencesImpl prefs=(PortletPreferencesImpl)prefsPool.get(pk);
  if (prefs == null) {
    PortletPreferences portletPreferences=null;
    Portlet portlet=PortletLocalServiceUtil.getPortletById(companyId,pk.portletId);
    if (portlet == null) {
      _log.warn("Returning preferences for a portlet that does not exist");
      return PortletPreferencesSerializer.fromXML(companyId,pk,Portlet.DEFAULT_PREFERENCES);
    }
    try {
      portletPreferences=PortletPreferencesUtil.findByPrimaryKey(pk);
    }
 catch (    NoSuchPortletPreferencesException nsppe) {
      portletPreferences=PortletPreferencesUtil.create(pk);
      if (pk.portletId.equals(PortletKeys.LIFERAY_PORTAL)) {
        portletPreferences.setPreferences(Portlet.DEFAULT_PREFERENCES);
      }
 else {
        portletPreferences.setPreferences(portlet.getDefaultPreferences());
      }
      PortletPreferencesUtil.update(portletPreferences);
    }
    prefs=PortletPreferencesSerializer.fromXML(companyId,pk,portletPreferences.getPreferences());
    prefsPool.put(pk,prefs);
  }
  return (PortletPreferencesImpl)prefs.clone();
}
