{
  Map prefsPool=PortletPreferencesLocalUtil.getPreferencesPool(ownerId);
  String key=encodeKey(ownerId,layoutId,portletId);
  PortletPreferencesImpl prefs=(PortletPreferencesImpl)prefsPool.get(key);
  if (prefs == null) {
    PortletPreferences portletPreferences=null;
    Portlet portlet=PortletLocalServiceUtil.getPortletById(companyId,portletId);
    try {
      portletPreferences=PortletPreferencesUtil.findByO_L_P(ownerId,layoutId,portletId);
    }
 catch (    NoSuchPortletPreferencesException nsppe) {
      long portletPreferencesId=CounterLocalServiceUtil.increment();
      portletPreferences=PortletPreferencesUtil.create(portletPreferencesId);
      portletPreferences.setOwnerId(ownerId);
      portletPreferences.setLayoutId(layoutId);
      portletPreferences.setPortletId(portletId);
      if (portlet == null) {
        portletPreferences.setPreferences(PortletImpl.DEFAULT_PREFERENCES);
      }
 else {
        portletPreferences.setPreferences(portlet.getDefaultPreferences());
      }
      PortletPreferencesUtil.update(portletPreferences);
    }
    prefs=PortletPreferencesSerializer.fromXML(companyId,ownerId,layoutId,portletId,portletPreferences.getPreferences());
    prefsPool.put(key,prefs);
  }
  return (PortletPreferencesImpl)prefs.clone();
}
