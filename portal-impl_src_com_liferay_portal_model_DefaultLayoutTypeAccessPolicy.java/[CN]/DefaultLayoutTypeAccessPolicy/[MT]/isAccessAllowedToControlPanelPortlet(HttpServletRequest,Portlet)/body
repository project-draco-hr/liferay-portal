{
  PermissionChecker permissionChecker=PermissionThreadLocal.getPermissionChecker();
  ThemeDisplay themeDisplay=(ThemeDisplay)request.getAttribute(WebKeys.THEME_DISPLAY);
  if (PortletPermissionUtil.hasControlPanelAccessPermission(permissionChecker,themeDisplay.getScopeGroupId(),portlet)) {
    return;
  }
  if (isAccessGrantedByRuntimePortlet(request,portlet)) {
    return;
  }
  if (isAccessGrantedByPortletAuthenticationToken(request,portlet)) {
    return;
  }
  throw new PrincipalException();
}
