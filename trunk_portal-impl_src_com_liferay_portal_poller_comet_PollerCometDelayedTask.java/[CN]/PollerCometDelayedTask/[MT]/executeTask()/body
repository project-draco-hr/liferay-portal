{
  CometRequest cometRequest=_cometSession.getCometRequest();
  try {
    List<NotificationEvent> notificationEvents=ChannelHubManagerUtil.getNotificationEvents(cometRequest.getCompanyId(),cometRequest.getUserId(),false);
    JSONArray jsonArray=JSONFactoryUtil.createJSONArray();
    if (_pollerResponseHeaderJSONObject != null) {
      jsonArray.put(_pollerResponseHeaderJSONObject);
    }
    for (    NotificationEvent notificationEvent : notificationEvents) {
      jsonArray.put(notificationEvent.toJSONObject());
    }
    CometResponse cometResponse=_cometSession.getCometResponse();
    cometResponse.writeData(jsonArray.toString());
    ChannelHubManagerUtil.removeTransientNotificationEvents(cometRequest.getCompanyId(),cometRequest.getUserId(),notificationEvents);
  }
 catch (  UnknownChannelException uce) {
    if (_log.isDebugEnabled()) {
      _log.debug("Unable to complete processing because user session ended",uce);
    }
  }
 finally {
    _cometSession.close();
  }
}
