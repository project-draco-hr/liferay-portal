{
  JSONArray ja=new JSONArray();
  JSONObject jo=new JSONObject();
  PacketCollector collector=getCollector(ses);
  Message message=getNextMessage(collector);
  Roster roster=getRoster(ses);
  while (message != null) {
    JSONObject jMsg=new JSONObject();
    String fromId=(String)message.getProperty("fromId");
    jMsg.put("body",message.getBody());
    jMsg.put("category",message.getProperty("category"));
    jMsg.put("toId",message.getProperty("toId"));
    jMsg.put("toName",message.getProperty("toName"));
    jMsg.put("fromId",fromId);
    jMsg.put("fromName",message.getProperty("fromName"));
    jMsg.put("status",getPresence(roster.getPresence(getXmppId(fromId))));
    ja.put(jMsg);
    message=getNextMessage(collector);
  }
  jo.put("chat",ja);
  jo.put("status","success");
  return jo;
}
