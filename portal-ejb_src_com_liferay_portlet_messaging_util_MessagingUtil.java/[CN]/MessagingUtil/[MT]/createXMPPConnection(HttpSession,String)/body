{
  if (isJabberEnabled()) {
    XMPPConnection connection;
    String serverIp=GetterUtil.getString(PropsUtil.get(PropsUtil.JABBER_XMPP_SERVER_ADDRESS),"localhost");
    int serverPort=GetterUtil.getInteger(PropsUtil.get(PropsUtil.JABBER_XMPP_SERVER_PORT),5222);
    String userPassword=GetterUtil.getString(PropsUtil.get(PropsUtil.JABBER_XMPP_USER_PASSWORD),"liferayllc");
    try {
      connection=new XMPPConnection(serverIp,serverPort);
    }
 catch (    XMPPException e) {
      return;
    }
    try {
      connection.login(userId,userPassword,ses.getId());
    }
 catch (    XMPPException e) {
      AccountManager account=connection.getAccountManager();
      account.createAccount(userId,userPassword);
      connection.close();
      connection=new XMPPConnection(serverIp,serverPort);
      connection.login(userId,userPassword,ses.getId());
    }
    PacketFilter filter=new PacketTypeFilter(Message.class);
    PacketCollector collector=connection.createPacketCollector(filter);
    ses.setAttribute(WebKeys.JABBER_XMPP_CONNECTION,connection);
    ses.setAttribute(WebKeys.JABBER_XMPP_COLLECTOR,collector);
    ses.setAttribute(WebKeys.JABBER_XMPP_ROSTER,connection.getRoster());
  }
}
