{
  UploadPortletRequest uploadReq=PortalUtil.getUploadPortletRequest(req);
  String cmd=ParamUtil.getString(uploadReq,Constants.CMD);
  String folderId=ParamUtil.getString(uploadReq,"folderId");
  String title=ParamUtil.getString(uploadReq,"title");
  String description=ParamUtil.getString(uploadReq,"description");
  byte[] byteArray=FileUtil.getBytes(uploadReq.getFile("file"));
  String redirect=ParamUtil.getString(uploadReq,"fileEntryRedirect");
  if (cmd.equals(Constants.ADD)) {
    String fileName=uploadReq.getFileName("file");
    if (byteArray == null || byteArray.length == 0) {
      throw new FileSizeException();
    }
    boolean addCommunityPermissions=ParamUtil.getBoolean(uploadReq,"addCommunityPermissions");
    boolean addGuestPermissions=ParamUtil.getBoolean(uploadReq,"addGuestPermissions");
    DLFileEntryServiceUtil.addFileEntry(folderId,fileName,title,description,byteArray,addCommunityPermissions,addGuestPermissions);
    redirect+=Http.encodeURL(fileName);
  }
 else {
    String name=ParamUtil.getString(uploadReq,"name");
    if (byteArray == null || byteArray.length == 0) {
      DLFileEntryServiceUtil.updateFileEntry(folderId,name,title,description);
    }
 else {
      String sourceFileName=uploadReq.getFileName("file");
      DLFileEntryServiceUtil.updateFileEntry(folderId,name,sourceFileName,byteArray);
    }
  }
  res.sendRedirect(redirect);
}
