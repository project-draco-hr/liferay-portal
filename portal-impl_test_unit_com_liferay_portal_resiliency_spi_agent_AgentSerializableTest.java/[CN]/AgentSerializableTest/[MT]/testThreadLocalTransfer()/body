{
  ThreadLocalDistributor threadLocalDistributor=new ThreadLocalDistributor();
  threadLocalDistributor.setThreadLocalSources(Arrays.asList(new KeyValuePair(AgentSerializableTest.class.getName(),"_threadLocal")));
  threadLocalDistributor.afterPropertiesSet();
  Field threadLocalValuesField=ReflectionUtil.getDeclaredField(ThreadLocalDistributor.class,"_threadLocalValues");
  Serializable[] serializables=(Serializable[])threadLocalValuesField.get(threadLocalDistributor);
  Assert.assertNotNull(serializables);
  Assert.assertEquals(1,serializables.length);
  Assert.assertNull(serializables[0]);
  String threadLocalValue="threadLocalValue";
  _threadLocal.set(threadLocalValue);
  AgentSerializable agentSerializable=new AgentSerializable();
  Field threadLocalDistributorsField=ReflectionUtil.getDeclaredField(AgentSerializable.class,"_threadLocalDistributors");
  Assert.assertNull(threadLocalDistributorsField.get(agentSerializable));
  agentSerializable.captureThreadLocals();
  ThreadLocalDistributor[] threadLocalDistributors=(ThreadLocalDistributor[])threadLocalDistributorsField.get(agentSerializable);
  Assert.assertNotNull(threadLocalDistributors);
  Assert.assertEquals(1,threadLocalDistributors.length);
  Assert.assertSame(threadLocalDistributor,threadLocalDistributors[0]);
  serializables=(Serializable[])threadLocalValuesField.get(threadLocalDistributor);
  Assert.assertNotNull(serializables);
  Assert.assertEquals(1,serializables.length);
  Assert.assertEquals(threadLocalValue,serializables[0]);
  _threadLocal.remove();
  agentSerializable.restoreThreadLocals();
  Assert.assertEquals(threadLocalValue,_threadLocal.get());
  _threadLocal.remove();
}
