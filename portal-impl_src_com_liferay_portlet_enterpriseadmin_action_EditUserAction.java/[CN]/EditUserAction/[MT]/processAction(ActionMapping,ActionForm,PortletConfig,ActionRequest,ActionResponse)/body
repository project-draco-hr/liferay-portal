{
  String cmd=ParamUtil.getString(req,Constants.CMD);
  try {
    User user=null;
    String oldScreenName=StringPool.BLANK;
    if (cmd.equals(Constants.ADD) || cmd.equals(Constants.UPDATE)) {
      Object[] returnValue=updateUser(req);
      user=(User)returnValue[0];
      oldScreenName=((String)returnValue[1]);
    }
 else     if (cmd.equals(Constants.DEACTIVATE) || cmd.equals(Constants.DELETE) || cmd.equals(Constants.RESTORE)) {
      deleteUsers(req);
    }
 else     if (cmd.equals("deleteRole")) {
      deleteRole(req);
    }
 else     if (cmd.equals("unlock")) {
      user=updateLockout(req);
    }
    String redirect=ParamUtil.getString(req,"redirect");
    if (user != null) {
      if (Validator.isNotNull(oldScreenName)) {
        ThemeDisplay themeDisplay=(ThemeDisplay)req.getAttribute(WebKeys.THEME_DISPLAY);
        Group group=user.getGroup();
        if (group.getGroupId() == themeDisplay.getPortletGroupId()) {
          Layout layout=themeDisplay.getLayout();
          String friendlyURLPath=group.getPathFriendlyURL(layout.isPrivateLayout(),themeDisplay);
          String oldPath=friendlyURLPath + StringPool.SLASH + oldScreenName;
          String newPath=friendlyURLPath + StringPool.SLASH + user.getScreenName();
          redirect=StringUtil.replace(redirect,oldPath,newPath);
          redirect=StringUtil.replace(redirect,HttpUtil.encodeURL(oldPath),HttpUtil.encodeURL(newPath));
        }
      }
      redirect+=user.getUserId();
    }
    sendRedirect(req,res,redirect);
  }
 catch (  Exception e) {
    if (e instanceof NoSuchUserException || e instanceof PrincipalException) {
      SessionErrors.add(req,e.getClass().getName());
      setForward(req,"portlet.enterprise_admin.error");
    }
 else     if (e instanceof ContactFirstNameException || e instanceof ContactLastNameException || e instanceof DuplicateUserEmailAddressException|| e instanceof DuplicateUserScreenNameException|| e instanceof RequiredUserException|| e instanceof ReservedUserEmailAddressException|| e instanceof ReservedUserScreenNameException|| e instanceof UserEmailAddressException|| e instanceof UserIdException|| e instanceof UserPasswordException|| e instanceof UserScreenNameException|| e instanceof UserSmsException) {
      SessionErrors.add(req,e.getClass().getName(),e);
      if (e instanceof RequiredUserException) {
        res.sendRedirect(ParamUtil.getString(req,"redirect"));
      }
    }
 else {
      throw e;
    }
  }
}
