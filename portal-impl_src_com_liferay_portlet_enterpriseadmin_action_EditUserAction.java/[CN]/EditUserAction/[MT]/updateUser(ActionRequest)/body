{
  String cmd=ParamUtil.getString(req,Constants.CMD);
  ThemeDisplay themeDisplay=(ThemeDisplay)req.getAttribute(WebKeys.THEME_DISPLAY);
  boolean autoPassword=true;
  String password1=null;
  String password2=null;
  boolean autoScreenName=false;
  String screenName=ParamUtil.getString(req,"screenName");
  String emailAddress=ParamUtil.getString(req,"emailAddress");
  String firstName=ParamUtil.getString(req,"firstName");
  String middleName=ParamUtil.getString(req,"middleName");
  String lastName=ParamUtil.getString(req,"lastName");
  int prefixId=ParamUtil.getInteger(req,"prefixId");
  int suffixId=ParamUtil.getInteger(req,"suffixId");
  boolean male=ParamUtil.get(req,"male",true);
  int birthdayMonth=ParamUtil.getInteger(req,"birthdayMonth");
  int birthdayDay=ParamUtil.getInteger(req,"birthdayDay");
  int birthdayYear=ParamUtil.getInteger(req,"birthdayYear");
  String jobTitle=ParamUtil.getString(req,"jobTitle");
  long[] organizationIds=StringUtil.split(ParamUtil.getString(req,"organizationIds"),0L);
  boolean sendEmail=true;
  User user=null;
  String oldScreenName=StringPool.BLANK;
  if (cmd.equals(Constants.ADD)) {
    user=UserServiceUtil.addUser(themeDisplay.getCompanyId(),autoPassword,password1,password2,autoScreenName,screenName,emailAddress,themeDisplay.getLocale(),firstName,middleName,lastName,prefixId,suffixId,male,birthdayMonth,birthdayDay,birthdayYear,jobTitle,organizationIds,sendEmail);
  }
 else {
    user=PortalUtil.getSelectedUser(req);
    String password=AdminUtil.getUpdateUserPassword(req,user.getUserId());
    Contact contact=user.getContact();
    String tempOldScreenName=user.getScreenName();
    user=UserServiceUtil.updateUser(user.getUserId(),password,screenName,emailAddress,user.getLanguageId(),user.getTimeZoneId(),user.getGreeting(),user.getComments(),firstName,middleName,lastName,prefixId,suffixId,male,birthdayMonth,birthdayDay,birthdayYear,contact.getSmsSn(),contact.getAimSn(),contact.getIcqSn(),contact.getJabberSn(),contact.getMsnSn(),contact.getSkypeSn(),contact.getYmSn(),jobTitle,organizationIds);
    if (!tempOldScreenName.equals(user.getScreenName())) {
      oldScreenName=tempOldScreenName;
    }
  }
  return new Object[]{user,oldScreenName};
}
