{
  String cmd=ParamUtil.getString(req,Constants.CMD);
  ThemeDisplay themeDisplay=(ThemeDisplay)req.getAttribute(WebKeys.THEME_DISPLAY);
  boolean autoPassword=true;
  String password1=null;
  String password2=null;
  boolean autoScreenName=false;
  String screenName=ParamUtil.getString(req,"screenName");
  String emailAddress=ParamUtil.getString(req,"emailAddress");
  String languageId=ParamUtil.getString(req,"languageId");
  String timeZoneId=ParamUtil.getString(req,"timeZoneId");
  String greeting=ParamUtil.getString(req,"greeting");
  String firstName=ParamUtil.getString(req,"firstName");
  String middleName=ParamUtil.getString(req,"middleName");
  String lastName=ParamUtil.getString(req,"lastName");
  int prefixId=ParamUtil.getInteger(req,"prefixId");
  int suffixId=ParamUtil.getInteger(req,"suffixId");
  boolean male=ParamUtil.get(req,"male",true);
  int birthdayMonth=ParamUtil.getInteger(req,"birthdayMonth");
  int birthdayDay=ParamUtil.getInteger(req,"birthdayDay");
  int birthdayYear=ParamUtil.getInteger(req,"birthdayYear");
  String comments=ParamUtil.getString(req,"comments");
  String smsSn=ParamUtil.getString(req,"smsSn");
  String aimSn=ParamUtil.getString(req,"aimSn");
  String icqSn=ParamUtil.getString(req,"icqSn");
  String jabberSn=ParamUtil.getString(req,"jabberSn");
  String msnSn=ParamUtil.getString(req,"msnSn");
  String skypeSn=ParamUtil.getString(req,"skypeSn");
  String ymSn=ParamUtil.getString(req,"ymSn");
  String jobTitle=ParamUtil.getString(req,"jobTitle");
  long[] organizationIds=StringUtil.split(ParamUtil.getString(req,"organizationIds"),0L);
  boolean sendEmail=true;
  User user=null;
  String oldScreenName=StringPool.BLANK;
  if (cmd.equals(Constants.ADD)) {
    user=UserServiceUtil.addUser(themeDisplay.getCompanyId(),autoPassword,password1,password2,autoScreenName,screenName,emailAddress,themeDisplay.getLocale(),firstName,middleName,lastName,prefixId,suffixId,male,birthdayMonth,birthdayDay,birthdayYear,jobTitle,organizationIds,sendEmail);
  }
 else {
    user=PortalUtil.getSelectedUser(req);
    String oldPassword=AdminUtil.getUpdateUserPassword(req,user.getUserId());
    String newPassword1=ParamUtil.getString(req,"password1");
    String newPassword2=ParamUtil.getString(req,"password2");
    boolean passwordReset=ParamUtil.getBoolean(req,"passwordReset");
    String tempOldScreenName=user.getScreenName();
    user=UserServiceUtil.updateUser(user.getUserId(),oldPassword,newPassword1,newPassword2,passwordReset,screenName,emailAddress,languageId,timeZoneId,greeting,comments,firstName,middleName,lastName,prefixId,suffixId,male,birthdayMonth,birthdayDay,birthdayYear,smsSn,aimSn,icqSn,jabberSn,msnSn,skypeSn,ymSn,jobTitle,organizationIds);
    if (!tempOldScreenName.equals(user.getScreenName())) {
      oldScreenName=tempOldScreenName;
    }
    if (user.getUserId() == themeDisplay.getUserId()) {
      HttpServletRequest httpReq=PortalUtil.getHttpServletRequest(req);
      HttpSession httpSes=httpReq.getSession();
      httpSes.removeAttribute(Globals.LOCALE_KEY);
      PortletSession ses=req.getPortletSession();
      CachePortlet.clearResponses(ses);
      if (Validator.isNotNull(newPassword1)) {
        ses.setAttribute(WebKeys.USER_PASSWORD,newPassword1,PortletSession.APPLICATION_SCOPE);
      }
    }
  }
  return new Object[]{user,oldScreenName};
}
