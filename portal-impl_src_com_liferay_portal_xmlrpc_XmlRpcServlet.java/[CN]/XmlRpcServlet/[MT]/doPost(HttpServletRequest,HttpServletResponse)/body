{
  Response rpcResponse=null;
  try {
    long companyId=PortalInstances.getCompanyId(request);
    InputStream is=request.getInputStream();
    String xml=StringUtil.read(is);
    Tuple parsedMethod=XmlRpcUtil.parseMethod(xml);
    String methodName=(String)parsedMethod.getObject(0);
    Object[] args=(Object[])parsedMethod.getObject(1);
    rpcResponse=invokeMethod(companyId,methodName,args);
  }
 catch (  IOException ioe) {
    rpcResponse=new Fault(XmlRpcConstants.NOT_WELL_FORMED,"XML is not well formed");
    if (_log.isDebugEnabled()) {
      _log.debug(ioe,ioe);
    }
  }
catch (  XmlRpcException xre) {
    _log.error(xre,xre);
  }
  if (rpcResponse == null) {
    rpcResponse=new Fault(XmlRpcConstants.SYSTEM_ERROR,"Unknown error occurred");
  }
  response.setCharacterEncoding(StringPool.UTF8);
  response.setContentType(ContentTypes.TEXT_XML);
  response.setStatus(HttpServletResponse.SC_OK);
  try {
    ServletResponseUtil.write(response,rpcResponse.toXml());
  }
 catch (  Exception e) {
    if (_log.isWarnEnabled()) {
      _log.warn(e);
    }
    response.setStatus(HttpServletResponse.SC_PRECONDITION_FAILED);
  }
}
