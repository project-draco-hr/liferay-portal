{
  Document document=null;
  boolean checkedOut=false;
  try {
    Session session=getSession();
    String versionSeriesId=toFileEntryId(fileEntryId);
    document=(Document)session.getObject(versionSeriesId);
    document.refresh();
    Document oldVersion=null;
    List<Document> documentVersions=document.getAllVersions();
    for (    Document currentVersion : documentVersions) {
      String currentVersionLabel=currentVersion.getVersionLabel();
      if (Validator.isNull(currentVersionLabel)) {
        currentVersionLabel=DLFileEntryConstants.DEFAULT_VERSION;
      }
      if (currentVersionLabel.equals(version)) {
        oldVersion=currentVersion;
        break;
      }
    }
    String changeLog="Reverted to " + version;
    String title=oldVersion.getName();
    ContentStream contentStream=oldVersion.getContentStream();
    AllowableActions allowableActions=document.getAllowableActions();
    Set<Action> allowableActionsSet=allowableActions.getAllowableActions();
    if (allowableActionsSet.contains(Action.CAN_CHECK_OUT)) {
      document.checkOut();
      checkedOut=true;
    }
    document=document.getObjectOfLatestVersion(false);
    String oldTitle=document.getName();
    Map<String,Object> properties=null;
    if (Validator.isNotNull(title) && !title.equals(oldTitle)) {
      properties=new HashMap<String,Object>();
      properties.put(PropertyIds.NAME,title);
    }
    checkUpdatable(allowableActionsSet,properties,contentStream);
    if (checkedOut) {
      document.checkIn(true,properties,contentStream,changeLog);
      checkedOut=false;
    }
 else {
      if (properties != null) {
        document=(Document)document.updateProperties(properties);
      }
      document.setContentStream(contentStream,true);
    }
    document=(Document)session.getObject(versionSeriesId);
    document.refresh();
  }
 catch (  PortalException pe) {
    throw pe;
  }
catch (  SystemException se) {
    throw se;
  }
catch (  Exception e) {
    processException(e);
    throw new RepositoryException(e);
  }
 finally {
    if (checkedOut) {
      document.cancelCheckOut();
    }
  }
}
