{
  String login=PrincipalThreadLocal.getName();
  String password=PrincipalThreadLocal.getPassword();
  try {
    String authType=CompanyLocalServiceUtil.getCompany(CompanyThreadLocal.getCompanyId()).getAuthType();
    if (!authType.equals(CompanyConstants.AUTH_TYPE_ID)) {
      User user=UserLocalServiceUtil.getUser(GetterUtil.getLong(login));
      if (authType.equals(CompanyConstants.AUTH_TYPE_EA)) {
        login=user.getEmailAddress();
      }
 else       if (authType.equals(CompanyConstants.AUTH_TYPE_SN)) {
        login=user.getScreenName();
      }
    }
  }
 catch (  Exception e) {
    throw new RepositoryException(e);
  }
  Map<String,String> parameter=new HashMap<String,String>();
  parameter.put(SessionParameter.USER,login);
  parameter.put(SessionParameter.PASSWORD,password);
  parameter.put(SessionParameter.LOCALE_ISO3166_COUNTRY,LocaleUtil.getDefault().getCountry());
  parameter.put(SessionParameter.LOCALE_ISO639_LANGUAGE,LocaleUtil.getDefault().getLanguage());
  UnicodeProperties typeSettingsProperties=getTypeSettingsProperties();
  if (typeSettingsProperties.containsKey(ATOMPUB_URL)) {
    parameter.put(SessionParameter.BINDING_TYPE,BindingType.ATOMPUB.value());
    putParameter(parameter,SessionParameter.ATOMPUB_URL,ATOMPUB_URL);
    putParameter(parameter,SessionParameter.REPOSITORY_ID,REPOSITORY_ID);
  }
 else {
    parameter.put(SessionParameter.BINDING_TYPE,BindingType.WEBSERVICES.value());
    putParameter(parameter,SessionParameter.REPOSITORY_ID,REPOSITORY_ID);
    putParameter(parameter,SessionParameter.WEBSERVICES_ACL_SERVICE,WEBSERVICES_ACL_SERVICE);
    putParameter(parameter,SessionParameter.WEBSERVICES_DISCOVERY_SERVICE,WEBSERVICES_DISCOVERY_SERVICE);
    putParameter(parameter,SessionParameter.WEBSERVICES_MULTIFILING_SERVICE,WEBSERVICES_MULTIFILING_SERVICE);
    putParameter(parameter,SessionParameter.WEBSERVICES_NAVIGATION_SERVICE,WEBSERVICES_NAVIGATION_SERVICE);
    putParameter(parameter,SessionParameter.WEBSERVICES_OBJECT_SERVICE,WEBSERVICES_OBJECT_SERVICE);
    putParameter(parameter,SessionParameter.WEBSERVICES_POLICY_SERVICE,WEBSERVICES_POLICY_SERVICE);
    putParameter(parameter,SessionParameter.WEBSERVICES_RELATIONSHIP_SERVICE,WEBSERVICES_RELATIONSHIP_SERVICE);
    putParameter(parameter,SessionParameter.WEBSERVICES_REPOSITORY_SERVICE,WEBSERVICES_REPOSITORY_SERVICE);
    putParameter(parameter,SessionParameter.WEBSERVICES_VERSIONING_SERVICE,WEBSERVICES_VERSIONING_SERVICE);
  }
  return _sessionFactory.createSession(parameter);
}
