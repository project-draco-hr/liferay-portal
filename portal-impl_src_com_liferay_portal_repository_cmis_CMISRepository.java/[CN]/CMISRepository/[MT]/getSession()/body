{
  Session session=_cmisSessions.get();
  if (session != null) {
    return session;
  }
  String password=PrincipalThreadLocal.getPassword();
  String login=getLogin();
  Map<String,String> parameters=new HashMap<String,String>();
  parameters.put(SessionParameter.USER,login);
  parameters.put(SessionParameter.PASSWORD,password);
  parameters.put(SessionParameter.LOCALE_ISO3166_COUNTRY,LocaleUtil.getDefault().getCountry());
  parameters.put(SessionParameter.LOCALE_ISO639_LANGUAGE,LocaleUtil.getDefault().getLanguage());
  UnicodeProperties typeSettingsProperties=getTypeSettingsProperties();
  if (isAtomPub()) {
    parameters.put(SessionParameter.BINDING_TYPE,BindingType.ATOMPUB.value());
    putParameter(parameters,SessionParameter.ATOMPUB_URL,CMISAtomPubRepository.ATOMPUB_URL);
  }
 else {
    parameters.put(SessionParameter.BINDING_TYPE,BindingType.WEBSERVICES.value());
    putParameter(parameters,SessionParameter.WEBSERVICES_ACL_SERVICE,CMISWebServicesRepository.WEBSERVICES_ACL_SERVICE);
    putParameter(parameters,SessionParameter.WEBSERVICES_DISCOVERY_SERVICE,CMISWebServicesRepository.WEBSERVICES_DISCOVERY_SERVICE);
    putParameter(parameters,SessionParameter.WEBSERVICES_MULTIFILING_SERVICE,CMISWebServicesRepository.WEBSERVICES_MULTIFILING_SERVICE);
    putParameter(parameters,SessionParameter.WEBSERVICES_NAVIGATION_SERVICE,CMISWebServicesRepository.WEBSERVICES_NAVIGATION_SERVICE);
    putParameter(parameters,SessionParameter.WEBSERVICES_OBJECT_SERVICE,CMISWebServicesRepository.WEBSERVICES_OBJECT_SERVICE);
    putParameter(parameters,SessionParameter.WEBSERVICES_POLICY_SERVICE,CMISWebServicesRepository.WEBSERVICES_POLICY_SERVICE);
    putParameter(parameters,SessionParameter.WEBSERVICES_RELATIONSHIP_SERVICE,CMISWebServicesRepository.WEBSERVICES_RELATIONSHIP_SERVICE);
    putParameter(parameters,SessionParameter.WEBSERVICES_REPOSITORY_SERVICE,CMISWebServicesRepository.WEBSERVICES_REPOSITORY_SERVICE);
    putParameter(parameters,SessionParameter.WEBSERVICES_VERSIONING_SERVICE,CMISWebServicesRepository.WEBSERVICES_VERSIONING_SERVICE);
  }
  checkRepository(parameters,typeSettingsProperties);
  Session newSession=_sessionFactory.createSession(parameters);
  _cmisSessions.set(newSession);
  return newSession;
}
