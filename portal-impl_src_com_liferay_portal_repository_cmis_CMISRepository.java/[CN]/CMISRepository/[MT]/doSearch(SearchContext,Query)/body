{
  long startTime=System.currentTimeMillis();
  Session session=getSession();
  RepositoryInfo repositoryInfo=session.getRepositoryInfo();
  RepositoryCapabilities repositoryCapabilities=repositoryInfo.getCapabilities();
  QueryConfig queryConfig=searchContext.getQueryConfig();
  CapabilityQuery capabilityQuery=repositoryCapabilities.getQueryCapability();
  queryConfig.setAttribute("capabilityQuery",capabilityQuery.value());
  String productName=repositoryInfo.getProductName();
  String productVersion=repositoryInfo.getProductVersion();
  queryConfig.setAttribute("repositoryProductName",productName);
  queryConfig.setAttribute("repositoryProductVersion",productVersion);
  String queryString=CMISSearchQueryBuilderUtil.buildQuery(searchContext,query);
  if (_cmisRepositoryDetector.isNuxeo5_4()) {
    queryString+=" AND (" + PropertyIds.IS_LATEST_VERSION + " = true)";
  }
  if (_log.isDebugEnabled()) {
    _log.debug("CMIS search query: " + queryString);
  }
  ItemIterable<QueryResult> queryResults=null;
  if (_cmisRepositoryDetector.isNuxeo5_5OrHigher()) {
    queryResults=session.query(queryString,true);
  }
 else {
    queryResults=session.query(queryString,false);
  }
  int start=searchContext.getStart();
  int end=searchContext.getEnd();
  if ((start == QueryUtil.ALL_POS) && (end == QueryUtil.ALL_POS)) {
    start=0;
  }
  int total=0;
  List<com.liferay.portal.kernel.search.Document> documents=new ArrayList<com.liferay.portal.kernel.search.Document>();
  List<String> snippets=new ArrayList<String>();
  List<Float> scores=new ArrayList<Float>();
  for (  QueryResult queryResult : queryResults) {
    total++;
    if (total <= start) {
      continue;
    }
    if ((total > end) && (end != QueryUtil.ALL_POS)) {
      continue;
    }
    com.liferay.portal.kernel.search.Document document=new DocumentImpl();
    String objectId=queryResult.getPropertyValueByQueryName(PropertyIds.OBJECT_ID);
    if (_log.isDebugEnabled()) {
      _log.debug("Search result object ID " + objectId);
    }
    FileEntry fileEntry=null;
    try {
      fileEntry=toFileEntry(objectId,true);
    }
 catch (    Exception e) {
      if (_log.isDebugEnabled()) {
        Throwable cause=e.getCause();
        if (cause != null) {
          cause=cause.getCause();
        }
        if (cause instanceof CmisObjectNotFoundException) {
          _log.debug("Search result ignored for CMIS document which " + "has a version with an invalid object ID " + cause.getMessage());
        }
 else {
          _log.debug("Search result ignored for invalid object ID",e);
        }
      }
      total--;
      continue;
    }
    DocumentHelper documentHelper=new DocumentHelper(document);
    documentHelper.setEntryKey(fileEntry.getModelClassName(),fileEntry.getFileEntryId());
    document.addKeyword(Field.TITLE,fileEntry.getTitle());
    documents.add(document);
    if (queryConfig.isScoreEnabled()) {
      Object scoreObj=queryResult.getPropertyValueByQueryName("HITS");
      if (scoreObj != null) {
        scores.add(Float.valueOf(scoreObj.toString()));
      }
 else {
        scores.add(1.0f);
      }
    }
 else {
      scores.add(1.0f);
    }
    snippets.add(StringPool.BLANK);
  }
  float searchTime=(float)(System.currentTimeMillis() - startTime) / Time.SECOND;
  Hits hits=new HitsImpl();
  hits.setDocs(documents.toArray(new com.liferay.portal.kernel.search.Document[documents.size()]));
  hits.setLength(total);
  hits.setQuery(query);
  hits.setQueryTerms(new String[0]);
  hits.setScores(ArrayUtil.toFloatArray(scores));
  hits.setSearchTime(searchTime);
  hits.setSnippets(snippets.toArray(new String[snippets.size()]));
  hits.setStart(startTime);
  return hits;
}
