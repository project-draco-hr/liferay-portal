{
  String content=FileUtil.read(webXml);
  int x=content.indexOf("<display-name>");
  if (x != -1) {
    int y=content.indexOf("</display-name>",x);
    y=content.indexOf(">",y) + 1;
    content=content.substring(0,x) + content.substring(y);
  }
  Document document=SAXReaderUtil.read(content);
  Element rootElement=document.getRootElement();
  double webXmlVersion=GetterUtil.getDouble(rootElement.attributeValue("version"),2.3);
  if (!PropsValues.TCK_URL && (webXmlVersion <= 2.3)) {
    throw new AutoDeployException(webXml.getName() + " must be updated to the Servlet 2.4 specification");
  }
  StringBundler sb=new StringBundler(5);
  sb.append("<listener>");
  sb.append("<listener-class>");
  boolean hasCustomServletListener=false;
  List<Element> listenerElements=rootElement.elements("listener");
  for (  Element listenerElement : listenerElements) {
    String listenerClass=GetterUtil.getString(listenerElement.elementText("listener-class"));
    if (listenerClass.equals(SerializableSessionAttributeListener.class.getName()) || listenerClass.equals(SecurePluginContextListener.class.getName())) {
      continue;
    }
    hasCustomServletListener=true;
    break;
  }
  boolean securityManagerEnabled=false;
  Properties properties=getPluginPackageProperties(srcFile);
  if (properties != null) {
    securityManagerEnabled=GetterUtil.getBoolean(properties.getProperty("security-manager-enabled"));
  }
  if (hasCustomServletListener || securityManagerEnabled) {
    sb.append(SecurePluginContextListener.class.getName());
  }
 else {
    sb.append(PluginContextListener.class.getName());
  }
  sb.append("</listener-class>");
  sb.append("</listener>");
  String pluginContextListenerContent=sb.toString();
  String extraContent=getExtraContent(webXmlVersion,srcFile,displayName);
  int pos=content.indexOf("<listener>");
  if (pos == -1) {
    pos=content.indexOf("</web-app>");
  }
  String newContent=content.substring(0,pos) + pluginContextListenerContent + extraContent+ content.substring(pos);
  newContent=updateLiferayWebXml(webXmlVersion,srcFile,newContent);
  newContent=secureWebXml(newContent,hasCustomServletListener,securityManagerEnabled);
  newContent=WebXMLBuilder.organizeWebXML(newContent);
  FileUtil.write(webXml,newContent,true);
  if (_log.isInfoEnabled()) {
    _log.info("Modifying Servlet " + webXmlVersion + " "+ webXml);
  }
}
