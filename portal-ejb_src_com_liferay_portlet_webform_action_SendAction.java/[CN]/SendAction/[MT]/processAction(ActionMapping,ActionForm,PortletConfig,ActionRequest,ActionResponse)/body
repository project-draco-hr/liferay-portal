{
  int maxNumOfFields=GetterUtil.getInteger(config.getInitParameter("max-num-of-fields"),10);
  List fieldValues=new ArrayList();
  for (int i=1; i <= maxNumOfFields; i++) {
    fieldValues.add(req.getParameter("field" + i));
  }
  PortletPreferences prefs=PortletPreferencesFactory.getPortletSetup(req,config.getPortletName(),true,true);
  boolean formInputOk=validate(fieldValues,prefs,maxNumOfFields);
  if (formInputOk) {
    boolean sent=sendEmail(fieldValues,prefs);
    if (!sent) {
      SessionErrors.add(req,"messageNotSent");
    }
 else {
      SessionMessages.add(req,"messageSent");
    }
  }
 else {
    SessionErrors.add(req,"pleaseFillAllFields");
  }
  sendRedirect(req,res);
}
