{
  if (_log.isDebugEnabled()) {
    _log.debug("Properties: " + properties);
  }
  try {
    if (configuration == null) {
      if (configurationModel.isFactory()) {
        if (_log.isDebugEnabled()) {
          _log.debug("Creating factory PID");
        }
        configuration=_configurationAdmin.createFactoryConfiguration(configurationModel.getID(),configurationModel.getBundleLocation());
      }
 else {
        if (_log.isDebugEnabled()) {
          _log.debug("Creating instance PID");
        }
        configuration=_configurationAdmin.getConfiguration(configurationModel.getID(),configurationModel.getBundleLocation());
      }
    }
    Dictionary<String,Object> configuredProperties=configuration.getProperties();
    if (configuredProperties == null) {
      configuredProperties=new Hashtable<>();
    }
    if (_log.isDebugEnabled()) {
      _log.debug("Configuration properties: " + configuration.getProperties());
    }
    Enumeration<String> keys=properties.keys();
    while (keys.hasMoreElements()) {
      String key=keys.nextElement();
      Object value=properties.get(key);
      configuredProperties.put(key,value);
    }
    if (configurationModel.isCompanyFactory()) {
      configuredProperties.put(ConfigurationModel.PROPERTY_KEY_COMPANY_ID,ConfigurationModel.PROPERTY_VALUE_COMPANY_ID_DEFAULT);
    }
    configuration.update(configuredProperties);
  }
 catch (  IOException ioe) {
    throw new PortletException(ioe);
  }
}
