{
  Element fileEntryElement=portletDataContext.getExportDataElement(fileEntry,FileEntry.class);
  String fileEntryPath=ExportImportPathUtil.getModelPath(fileEntry.getGroupId(),FileEntry.class.getName(),fileEntry.getFileEntryId());
  if (!fileEntry.isDefaultRepository()) {
    Repository repository=RepositoryUtil.findByPrimaryKey(fileEntry.getRepositoryId());
    StagedModelDataHandlerUtil.exportStagedModel(portletDataContext,repository);
    portletDataContext.addReferenceElement(fileEntry,fileEntryElement,repository,PortletDataContext.REFERENCE_TYPE_STRONG,false);
    portletDataContext.addClassedModel(fileEntryElement,fileEntryPath,fileEntry,DLPortletDataHandler.NAMESPACE);
    if (repository.getClassNameId() != PortalUtil.getClassNameId(LiferayRepository.class.getName())) {
      return;
    }
  }
  FileVersion fileVersion=fileEntry.getFileVersion();
  if (!fileVersion.isApproved() && !fileVersion.isInTrash()) {
    return;
  }
  if (fileEntry.getFolderId() != DLFolderConstants.DEFAULT_PARENT_FOLDER_ID) {
    StagedModelDataHandlerUtil.exportStagedModel(portletDataContext,fileEntry.getFolder());
  }
  LiferayFileEntry liferayFileEntry=(LiferayFileEntry)fileEntry;
  liferayFileEntry.setCachedFileVersion(fileVersion);
  if (!portletDataContext.isPerformDirectBinaryImport()) {
    InputStream is=null;
    try {
      is=FileEntryUtil.getContentStream(fileEntry);
    }
 catch (    NoSuchFileException nsfe) {
    }
    if (is == null) {
      if (_log.isWarnEnabled()) {
        _log.warn("No file found for file entry " + fileEntry.getFileEntryId());
      }
      fileEntryElement.detach();
      return;
    }
    try {
      String binPath=ExportImportPathUtil.getModelPath(fileEntry,fileEntry.getVersion());
      portletDataContext.addZipEntry(binPath,is);
      fileEntryElement.addAttribute("bin-path",binPath);
    }
  finally {
      try {
        is.close();
      }
 catch (      IOException ioe) {
        _log.error(ioe,ioe);
      }
    }
  }
  if (portletDataContext.getBooleanParameter(DLPortletDataHandler.NAMESPACE,"ranks")) {
    List<DLFileRank> fileRanks=DLFileRankUtil.findByFileEntryId(fileEntry.getFileEntryId());
    for (    DLFileRank fileRank : fileRanks) {
      StagedModelDataHandlerUtil.exportStagedModel(portletDataContext,fileRank);
      portletDataContext.addReferenceElement(fileEntry,fileEntryElement,fileRank,PortletDataContext.REFERENCE_TYPE_EMBEDDED,false);
    }
  }
  if (portletDataContext.getBooleanParameter(DLPortletDataHandler.NAMESPACE,"previews-and-thumbnails")) {
    DLProcessorRegistryUtil.exportGeneratedFiles(portletDataContext,fileEntry,fileEntryElement);
  }
  exportMetaData(portletDataContext,fileEntryElement,fileEntry);
  portletDataContext.addClassedModel(fileEntryElement,fileEntryPath,fileEntry,DLPortletDataHandler.NAMESPACE);
}
