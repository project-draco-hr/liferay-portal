{
  if (_log.isDebugEnabled()) {
    _log.debug("Starting initial bundles");
  }
  BundleContext bundleContext=_framework.getBundleContext();
  ThrowableCollector throwableCollector=new ThrowableCollector();
  Dictionary<String,Object> dictionary=new HashMapDictionary<>();
  dictionary.put("throwable.collector","initial.bundles");
  bundleContext.registerService(ThrowableCollector.class,throwableCollector,dictionary);
  final List<Bundle> bundles=new ArrayList<>();
  Files.walkFileTree(Paths.get(PropsValues.MODULE_FRAMEWORK_BASE_DIR,"/static/"),new SimpleFileVisitor<Path>(){
    @Override public FileVisitResult visitFile(    Path filePath,    BasicFileAttributes basicFileAttributes) throws IOException {
      Path fileNamePath=filePath.getFileName();
      String fileName=StringUtil.toLowerCase(fileNamePath.toString());
      if (fileName.endsWith(".jar")) {
        try (InputStream inputStream=Files.newInputStream(filePath)){
          filePath=filePath.toAbsolutePath();
          Bundle bundle=_installInitialBundle(filePath.toString(),inputStream);
          if (bundle != null) {
            bundles.add(bundle);
          }
        }
       }
      return FileVisitResult.CONTINUE;
    }
  }
);
  File file=new File(bundleContext.getProperty("lpkg.deployer.dir") + StringPool.SLASH + "static.lpkg");
  if (file.exists()) {
    ZipFile zipFile=new ZipFile(file);
    Enumeration<? extends ZipEntry> enumeration=zipFile.entries();
    while (enumeration.hasMoreElements()) {
      ZipEntry zipEntry=enumeration.nextElement();
      String name=StringUtil.toLowerCase(zipEntry.getName());
      if (!name.endsWith(".jar")) {
        continue;
      }
      try (InputStream inputStream=zipFile.getInputStream(zipEntry)){
        Bundle bundle=_installInitialBundle(StringPool.SLASH.concat(zipEntry.getName()),inputStream);
        if (bundle != null) {
          bundles.add(bundle);
        }
      }
     }
  }
  FrameworkStartLevel frameworkStartLevel=_framework.adapt(FrameworkStartLevel.class);
  frameworkStartLevel.setStartLevel(PropsValues.MODULE_FRAMEWORK_BEGINNING_START_LEVEL);
  for (  final Bundle bundle : bundles) {
    if (_isFragmentBundle(bundle)) {
      continue;
    }
    final CountDownLatch countDownLatch=new CountDownLatch(1);
    BundleTracker<Void> bundleTracker=new BundleTracker<Void>(_framework.getBundleContext(),Bundle.ACTIVE,null){
      @Override public Void addingBundle(      Bundle trackedBundle,      BundleEvent bundleEvent){
        if (trackedBundle == bundle) {
          countDownLatch.countDown();
          close();
        }
        return null;
      }
    }
;
    bundleTracker.open();
    countDownLatch.await();
  }
  throwableCollector.rethrow();
  if (_log.isDebugEnabled()) {
    _log.debug("Started initial bundles");
  }
  Bundle[] installedBundles=bundleContext.getBundles();
  List<String> hostBundleSymbolicNames=new ArrayList<>();
  for (  Bundle bundle : installedBundles) {
    BundleStartLevel bundleStartLevel=bundle.adapt(BundleStartLevel.class);
    if (bundleStartLevel.getStartLevel() != PropsValues.MODULE_FRAMEWORK_DYNAMIC_INSTALL_START_LEVEL) {
      continue;
    }
    Dictionary<String,String> headers=bundle.getHeaders();
    String fragmentHost=headers.get(Constants.FRAGMENT_HOST);
    if (fragmentHost == null) {
      continue;
    }
    int index=fragmentHost.indexOf(CharPool.SEMICOLON);
    if (index != -1) {
      fragmentHost=fragmentHost.substring(0,index);
    }
    hostBundleSymbolicNames.add(fragmentHost);
  }
  List<Bundle> hostBundles=new ArrayList<>();
  for (  Bundle bundle : installedBundles) {
    if (hostBundleSymbolicNames.contains(bundle.getSymbolicName())) {
      hostBundles.add(bundle);
    }
  }
  FrameworkWiring frameworkWiring=_framework.adapt(FrameworkWiring.class);
  frameworkWiring.refreshBundles(hostBundles);
}
