{
  if (_log.isTraceEnabled()) {
    _log.trace("Initializing OSGi Framework");
  }
  List<ServiceLoaderCondition> serviceLoaderConditions=ServiceLoader.load(ServiceLoaderCondition.class);
  ServiceLoaderCondition serviceLoaderCondition=serviceLoaderConditions.get(0);
  if (_log.isTraceEnabled()) {
    _log.trace("Using conditional loading to find framework factory {" + serviceLoaderCondition.getClass().getName() + "}");
  }
  List<FrameworkFactory> frameworkFactories=ServiceLoader.load(FrameworkFactory.class,serviceLoaderCondition);
  FrameworkFactory frameworkFactory=frameworkFactories.get(0);
  if (_log.isTraceEnabled()) {
    _log.trace("Using framework factory {" + frameworkFactory.getClass().getName() + "}");
  }
  Map<String,String> properties=_buildFrameworkProperties(frameworkFactory.getClass());
  if (_log.isTraceEnabled()) {
    _log.trace("Creating the framework instance");
  }
  _framework=frameworkFactory.newFramework(properties);
  if (_log.isTraceEnabled()) {
    _log.trace("Initializing the framework");
  }
  _framework.init();
  if (_log.isTraceEnabled()) {
    _log.trace("Binding the framework to the registry API");
  }
  RegistryUtil.setRegistry(new RegistryImpl(_framework.getBundleContext()));
  if (_log.isTraceEnabled()) {
    _log.trace("Binding the framework to the service tracker map factory");
  }
  ServiceTrackerMapFactoryUtil.setServiceTrackerMapFactory(new ServiceTrackerMapFactoryImpl(_framework.getBundleContext()));
  if (_log.isTraceEnabled()) {
    _log.trace("Framework initialization phase complete");
  }
}
