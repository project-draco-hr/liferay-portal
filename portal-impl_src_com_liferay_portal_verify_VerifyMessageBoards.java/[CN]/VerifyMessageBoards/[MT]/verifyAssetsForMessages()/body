{
  try (LoggingTimer loggingTimer=new LoggingTimer()){
    List<MBMessage> messages=MBMessageLocalServiceUtil.getNoAssetMessages();
    if (_log.isDebugEnabled()) {
      _log.debug("Processing " + messages.size() + " messages with no asset");
    }
    for (    MBMessage message : messages) {
      try {
        MBMessageLocalServiceUtil.updateAsset(message.getUserId(),message,null,null,null);
        if (message.getStatus() == WorkflowConstants.STATUS_DRAFT) {
          boolean visible=false;
          if (message.isApproved() && ((message.getClassNameId() == 0) || (message.getParentMessageId() != 0))) {
            visible=true;
          }
          AssetEntryLocalServiceUtil.updateEntry(message.getWorkflowClassName(),message.getMessageId(),null,null,true,visible);
        }
      }
 catch (      Exception e) {
        if (_log.isWarnEnabled()) {
          _log.warn("Unable to update asset for message " + message.getMessageId() + ": "+ e.getMessage());
        }
      }
    }
    if (_log.isDebugEnabled()) {
      _log.debug("Assets verified for messages");
    }
  }
 }
