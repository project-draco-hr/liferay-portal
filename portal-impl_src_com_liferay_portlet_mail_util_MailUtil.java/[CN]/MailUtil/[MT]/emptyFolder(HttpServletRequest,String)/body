{
  try {
    MailSessionLock.lock(req);
    String lastFolderName=getFolderName(req);
    IMAPFolder folder=_getFolder(req,folderName);
    long[] ids=new long[0];
    try {
      Message[] msgs=folder.getMessages();
      FetchProfile fetchProfile=new FetchProfile();
      fetchProfile.add(FetchProfile.Item.ENVELOPE);
      folder.fetch(msgs,fetchProfile);
      ids=new long[msgs.length];
      for (int i=0; i < msgs.length; i++) {
        ids[i]=folder.getUID(msgs[i]);
      }
      Message[] messages=folder.getMessagesByUID(ids);
      folder.setFlags(messages,new Flags(Flags.Flag.DELETED),true);
      folder.expunge();
    }
 catch (    MessagingException me) {
      throw new FolderException(me);
    }
 finally {
      setFolder(req,lastFolderName);
    }
  }
  finally {
    MailSessionLock.unlock(req);
  }
}
