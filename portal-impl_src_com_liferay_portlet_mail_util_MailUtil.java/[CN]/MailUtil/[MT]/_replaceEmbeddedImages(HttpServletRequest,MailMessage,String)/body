{
  HttpSession ses=req.getSession();
  String prefix=ses.getId() + System.currentTimeMillis();
  int count=0;
  String body=mailMessage.getBody();
  if (_log.isDebugEnabled()) {
    _log.debug("Body before replacing embedded images\n" + body);
  }
  int x=body.indexOf(url);
  while (x >= 0) {
    int y=body.indexOf("-1",x);
    if (y > 0) {
      y+=2;
      String attachmentPath=body.substring(x,y);
      String fileName=HttpUtil.getParameter(attachmentPath,"fileName");
      String contentPath=HttpUtil.getParameter(attachmentPath,"contentPath");
      String contentId=prefix + count;
      Object[] parts=getAttachment(req,contentPath);
      MailAttachment mailAttachment=new MailAttachment();
      mailAttachment.setFilename(fileName);
      mailAttachment.setContent((byte[])parts[0]);
      mailAttachment.setContentType((String)parts[1]);
      mailAttachment.setContentId(StringPool.LESS_THAN + contentId + StringPool.GREATER_THAN);
      mailMessage.appendAttachment(mailAttachment);
      body=StringUtil.replace(body,attachmentPath,"cid:" + contentId);
      count++;
      x=body.indexOf(url);
    }
 else {
      x=body.indexOf(url,x + 1);
    }
  }
  if (count > 0) {
    mailMessage.setBody(body);
  }
  if (_log.isDebugEnabled()) {
    _log.debug("Body after replacing embedded images\n" + body);
  }
}
