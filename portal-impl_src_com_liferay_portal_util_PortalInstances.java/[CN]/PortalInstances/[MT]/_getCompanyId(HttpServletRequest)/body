{
  if (_log.isDebugEnabled()) {
    _log.debug("Get company id");
  }
  long companyId=PortalUtil.getCompanyId(req);
  if (_log.isDebugEnabled()) {
    _log.debug("Company id from request " + companyId);
  }
  if (companyId > 0) {
    return companyId;
  }
  String host=PortalUtil.getHost(req);
  if (_log.isDebugEnabled()) {
    _log.debug("Host " + host);
  }
  companyId=_getCompanyIdByVirtualHost(host);
  if (_log.isDebugEnabled()) {
    _log.debug("Company id from host " + companyId);
  }
  if (companyId <= 0) {
    LayoutSet layoutSet=_getLayoutSetByVirtualHost(host);
    if (layoutSet != null) {
      companyId=layoutSet.getCompanyId();
      if (_log.isDebugEnabled()) {
        _log.debug("Company id " + companyId + " is associated with "+ "layout set "+ layoutSet.getLayoutSetId());
      }
      req.setAttribute(WebKeys.VIRTUAL_HOST_LAYOUT_SET,layoutSet);
    }
  }
  if (companyId <= 0) {
    companyId=_getDefaultCompanyId();
    if (_log.isDebugEnabled()) {
      _log.debug("Default company id " + companyId);
    }
  }
  if (_log.isDebugEnabled()) {
    _log.debug("Set company id " + companyId);
  }
  req.setAttribute(WebKeys.COMPANY_ID,new Long(companyId));
  return companyId;
}
