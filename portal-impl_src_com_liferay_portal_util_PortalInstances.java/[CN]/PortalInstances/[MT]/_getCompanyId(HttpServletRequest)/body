{
  if (_log.isDebugEnabled()) {
    _log.debug("Get company id");
  }
  Long companyIdObj=(Long)request.getAttribute(WebKeys.COMPANY_ID);
  if (_log.isDebugEnabled()) {
    _log.debug("Company id from request " + companyIdObj);
  }
  if (companyIdObj != null) {
    return companyIdObj.longValue();
  }
  String host=PortalUtil.getHost(request);
  if (_log.isDebugEnabled()) {
    _log.debug("Host " + host);
  }
  long companyId=_getCompanyIdByVirtualHosts(host);
  if (_log.isDebugEnabled()) {
    _log.debug("Company id from host " + companyId);
  }
  if (companyId <= 0) {
    LayoutSet layoutSet=_getLayoutSetByVirtualHosts(host);
    if (layoutSet != null) {
      companyId=layoutSet.getCompanyId();
      if (_log.isDebugEnabled()) {
        _log.debug("Company id " + companyId + " is associated with "+ "layout set "+ layoutSet.getLayoutSetId());
      }
      request.setAttribute(WebKeys.VIRTUAL_HOST_LAYOUT_SET,layoutSet);
    }
  }
  if (companyId <= 0) {
    companyId=GetterUtil.getLong(CookieKeys.getCookie(request,CookieKeys.COMPANY_ID));
    if (_log.isDebugEnabled()) {
      _log.debug("Company id from cookie " + companyId);
    }
  }
  if (companyId <= 0) {
    companyId=_getDefaultCompanyId();
    if (_log.isDebugEnabled()) {
      _log.debug("Default company id " + companyId);
    }
  }
  if (_log.isDebugEnabled()) {
    _log.debug("Set company id " + companyId);
  }
  request.setAttribute(WebKeys.COMPANY_ID,new Long(companyId));
  CompanyThreadLocal.setCompanyId(companyId);
  if (Validator.isNotNull(PropsValues.VIRTUAL_HOSTS_DEFAULT_COMMUNITY_NAME)) {
    try {
      Group group=GroupLocalServiceUtil.getGroup(companyId,PropsValues.VIRTUAL_HOSTS_DEFAULT_COMMUNITY_NAME);
      LayoutSet layoutSet=LayoutSetLocalServiceUtil.getLayoutSet(group.getGroupId(),false);
      if (Validator.isNull(layoutSet.getVirtualHost())) {
        request.setAttribute(WebKeys.VIRTUAL_HOST_LAYOUT_SET,layoutSet);
      }
    }
 catch (    Exception e) {
      _log.error(e,e);
    }
  }
  return companyId;
}
