{
  if (_log.isDebugEnabled()) {
    _log.debug("Get company id");
  }
  Long companyIdObj=(Long)req.getAttribute(WebKeys.COMPANY_ID);
  if (_log.isDebugEnabled()) {
    _log.debug("Company id from request " + companyIdObj);
  }
  if (companyIdObj != null) {
    return companyIdObj.longValue();
  }
  String host=PortalUtil.getHost(req);
  if (_log.isDebugEnabled()) {
    _log.debug("Host " + host);
  }
  long companyId=_getCompanyIdByVirtualHost(host);
  if (_log.isDebugEnabled()) {
    _log.debug("Company id from host " + companyId);
  }
  if (companyId <= 0) {
    LayoutSet layoutSet=_getLayoutSetByVirtualHost(host);
    if (layoutSet != null) {
      companyId=layoutSet.getCompanyId();
      if (_log.isDebugEnabled()) {
        _log.debug("Company id " + companyId + " is associated with "+ "layout set "+ layoutSet.getLayoutSetId());
      }
      req.setAttribute(WebKeys.VIRTUAL_HOST_LAYOUT_SET,layoutSet);
    }
  }
  if (companyId <= 0) {
    companyId=GetterUtil.getLong(CookieUtil.get(req.getCookies(),CookieKeys.COMPANY_ID));
    if (_log.isDebugEnabled()) {
      _log.debug("Company id from cookie " + companyId);
    }
  }
  if (companyId <= 0) {
    companyId=_getDefaultCompanyId();
    if (_log.isDebugEnabled()) {
      _log.debug("Default company id " + companyId);
    }
  }
  if (_log.isDebugEnabled()) {
    _log.debug("Set company id " + companyId);
  }
  req.setAttribute(WebKeys.COMPANY_ID,new Long(companyId));
  CompanyThreadLocal.setCompanyId(companyId);
  return companyId;
}
