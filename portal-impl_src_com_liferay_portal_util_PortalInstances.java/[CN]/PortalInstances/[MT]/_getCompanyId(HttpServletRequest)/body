{
  if (_log.isDebugEnabled()) {
    _log.debug("Get company id");
  }
  Long companyIdObj=(Long)request.getAttribute(WebKeys.COMPANY_ID);
  if (_log.isDebugEnabled()) {
    _log.debug("Company id from request " + companyIdObj);
  }
  if (companyIdObj != null) {
    return companyIdObj.longValue();
  }
  long companyId=_getCompanyIdByVirtualHosts(request);
  if (_log.isDebugEnabled()) {
    _log.debug("Company id from host " + companyId);
  }
  if (companyId <= 0) {
    long cookieCompanyId=GetterUtil.getLong(CookieKeys.getCookie(request,CookieKeys.COMPANY_ID,false));
    if (cookieCompanyId > 0) {
      try {
        CompanyLocalServiceUtil.getCompanyById(cookieCompanyId);
        companyId=cookieCompanyId;
        if (_log.isDebugEnabled()) {
          _log.debug("Company id from cookie " + companyId);
        }
      }
 catch (      NoSuchCompanyException nsce) {
        if (_log.isWarnEnabled()) {
          _log.warn("Company id from cookie " + cookieCompanyId + " does not exist");
        }
      }
catch (      Exception e) {
        _log.error(e,e);
      }
    }
  }
  if (companyId <= 0) {
    companyId=_getDefaultCompanyId();
    if (_log.isDebugEnabled()) {
      _log.debug("Default company id " + companyId);
    }
  }
  if (_log.isDebugEnabled()) {
    _log.debug("Set company id " + companyId);
  }
  request.setAttribute(WebKeys.COMPANY_ID,new Long(companyId));
  CompanyThreadLocal.setCompanyId(companyId);
  if (Validator.isNotNull(PropsValues.VIRTUAL_HOSTS_DEFAULT_SITE_NAME) && (request.getAttribute(WebKeys.VIRTUAL_HOST_LAYOUT_SET) == null)) {
    try {
      Group group=GroupLocalServiceUtil.getGroup(companyId,PropsValues.VIRTUAL_HOSTS_DEFAULT_SITE_NAME);
      LayoutSet layoutSet=LayoutSetLocalServiceUtil.getLayoutSet(group.getGroupId(),false);
      if (Validator.isNull(layoutSet.getVirtualHostname())) {
        request.setAttribute(WebKeys.VIRTUAL_HOST_LAYOUT_SET,layoutSet);
      }
    }
 catch (    Exception e) {
      _log.error(e,e);
    }
  }
  return companyId;
}
