{
  EntityID entityID=WindowInvokerUtil.getEntityID(portlet);
  ChannelState channelWindowState=new ChannelState(windowState.toString());
  ChannelMode channelPortletMode=new ChannelMode(portletMode.toString());
  PortletWindowContext portletWindowContext=new PortletWindowContextImpl(req,portlet,lifecycle);
  ChannelURLFactory channelURLFactory=new PortletWindowURLFactory(req,portlet,channelWindowState,channelPortletMode,plid);
  if (lifecycle.equals(PortletRequest.ACTION_PHASE) || lifecycle.equals(PortletRequest.RESOURCE_PHASE)) {
    ChannelState newWindowState=windowRequestReader.readNewWindowState(req);
    if (newWindowState != null) {
      channelWindowState=newWindowState;
    }
    ChannelMode newPortletWindowMode=windowRequestReader.readNewPortletWindowMode(req);
    if (newPortletWindowMode != null) {
      channelPortletMode=newPortletWindowMode;
    }
  }
  Container container=ContainerFactory.getContainer(ContainerType.PORTLET_CONTAINER);
  ContainerRequest containerRequest=null;
  if (lifecycle.equals(PortletRequest.ACTION_PHASE)) {
    containerRequest=container.createExecuteActionRequest(req,entityID,channelWindowState,channelPortletMode,portletWindowContext,channelURLFactory,windowRequestReader);
  }
 else   if (lifecycle.equals(PortletRequest.RENDER_PHASE)) {
    containerRequest=container.createGetMarkUpRequest(req,entityID,channelWindowState,channelPortletMode,portletWindowContext,channelURLFactory);
  }
 else   if (lifecycle.equals(PortletRequest.RESOURCE_PHASE)) {
    containerRequest=container.createGetResourceRequest(req,entityID,channelWindowState,channelPortletMode,portletWindowContext,channelURLFactory,windowRequestReader);
  }
  if (containerRequest != null) {
    String namespace=PortalUtil.getPortletNamespace(portlet.getPortletId());
    StringBuilder windowID=new StringBuilder();
    windowID.append(portlet.getPortletId());
    windowID.append(PortletSessionImpl.LAYOUT_SEPARATOR);
    windowID.append(plid);
    containerRequest.setAllowableWindowStates(windowStates);
    containerRequest.setAllowableChannelModes(portletModes);
    containerRequest.setNamespace(namespace);
    containerRequest.setPortalInfo(ReleaseInfo.getReleaseInfo());
    containerRequest.setWindowID(windowID.toString());
  }
  return containerRequest;
}
