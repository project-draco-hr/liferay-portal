{
  LayoutSet layoutSet=LayoutSetLocalServiceUtil.getLayoutSet(ownerId);
  Group guestGroup=GroupLocalServiceUtil.getGroup(layoutSet.getCompanyId(),GroupImpl.GUEST);
  Document doc=DocumentHelper.createDocument();
  Element root=doc.addElement("root");
  Element header=root.addElement("header");
  header.addAttribute("build-number",String.valueOf(ReleaseInfo.getBuildNumber()));
  header.addAttribute("owner-id",ownerId);
  header.addAttribute("export-date",Time.getRFC822());
  header.addAttribute("theme-id",layoutSet.getThemeId());
  header.addAttribute("color-scheme-id",layoutSet.getColorSchemeId());
  Iterator itr=getLayouts(ownerId).iterator();
  while (itr.hasNext()) {
    Layout layout=(Layout)itr.next();
    Element layoutEl=root.addElement("layout");
    layoutEl.addAttribute("layout-id",layout.getLayoutId());
    layoutEl.addElement("parent-layout-id").addText(layout.getParentLayoutId());
    layoutEl.addElement("name").addCDATA(layout.getName());
    layoutEl.addElement("type").addText(layout.getType());
    layoutEl.addElement("type-settings").addCDATA(layout.getTypeSettings());
    layoutEl.addElement("hidden").addText(String.valueOf(layout.getHidden()));
    layoutEl.addElement("friendly-url").addText(layout.getFriendlyURL());
    layoutEl.addElement("theme-id").addText(layout.getThemeId());
    layoutEl.addElement("color-scheme-id").addText(layout.getColorSchemeId());
    layoutEl.addElement("priority").addText(String.valueOf(layout.getPriority()));
    Element permissionsEl=layoutEl.addElement("permissions");
    exportLayoutPermissions(layout,layout.getGroupId(),permissionsEl,"community-actions");
    if (!layout.getGroupId().equals(guestGroup.getGroupId())) {
      exportLayoutPermissions(layout,guestGroup.getGroupId(),permissionsEl,"guest-actions");
    }
    if (layout.getType().equals(LayoutImpl.TYPE_PORTLET)) {
      LayoutTypePortlet layoutTypePortlet=(LayoutTypePortlet)layout.getLayoutType();
      List portletIds=layoutTypePortlet.getPortletIds();
      for (int i=0; i < portletIds.size(); i++) {
        String portletId=(String)portletIds.get(i);
        Element portletEl=permissionsEl.addElement("portlet");
        portletEl.addAttribute("portlet-id",portletId);
        exportPortletPermissions(portletId,layout,layout.getGroupId(),portletEl,"community-actions");
        if (!layout.getGroupId().equals(guestGroup.getGroupId())) {
          exportPortletPermissions(portletId,layout,guestGroup.getGroupId(),portletEl,"guest-actions");
        }
      }
    }
  }
  itr=PortletPreferencesLocalServiceUtil.getPortletPreferences(ownerId).iterator();
  while (itr.hasNext()) {
    PortletPreferences prefs=(PortletPreferences)itr.next();
    Element el=root.addElement("portlet-preferences");
    String portletId=prefs.getPortletId();
    String layoutId=prefs.getLayoutId();
    el.addAttribute("portlet-id",portletId);
    el.addAttribute("layout-id",layoutId);
    el.addElement("preferences").addCDATA(prefs.getPreferences());
    Portlet portlet=PortletLocalServiceUtil.getPortletById(layoutSet.getCompanyId(),portletId);
    if (portlet != null) {
      PortletDataHandler portletDataHandler=portlet.getPortletDataHandler();
      if (portletDataHandler != null) {
        String data=StringPool.BLANK;
        try {
          data=portletDataHandler.exportData(layoutSet.getCompanyId(),layoutSet.getGroupId());
        }
 catch (        PortletDataException pde) {
          throw new PortalException(pde);
        }
        el=root.addElement("portlet-data");
        el.addAttribute("portlet-id",portletId);
        el.addElement("data").addCDATA(data);
      }
    }
  }
  try {
    ZipWriter zipWriter=new ZipWriter();
    zipWriter.addEntry("layouts.xml",XMLFormatter.toString(doc));
    return zipWriter.finish();
  }
 catch (  IOException ioe) {
    throw new SystemException(ioe);
  }
}
