{
  long userId=portletDataContext.getUserId(threadFlag.getUserUuid());
  Map<Long,Long> messageIds=(Map<Long,Long>)portletDataContext.getNewPrimaryKeysMap(MBMessage.class);
  long threadId=MapUtil.getLong(messageIds,threadFlag.getThreadId(),threadFlag.getThreadId());
  MBThread thread=MBThreadUtil.fetchByPrimaryKey(threadId);
  if (thread == null) {
    String rootMessageUuid=threadFlagElement.attributeValue("root-message-uuid");
    MBMessage rootMessage=MBMessageUtil.fetchByUUID_G(rootMessageUuid,portletDataContext.getScopeGroupId());
    if (rootMessage != null) {
      thread=rootMessage.getThread();
    }
  }
  if (thread == null) {
    return;
  }
  ServiceContext serviceContext=portletDataContext.createServiceContext(threadFlagElement,threadFlag,NAMESPACE);
  MBThreadFlagLocalServiceUtil.addThreadFlag(userId,thread,serviceContext);
}
