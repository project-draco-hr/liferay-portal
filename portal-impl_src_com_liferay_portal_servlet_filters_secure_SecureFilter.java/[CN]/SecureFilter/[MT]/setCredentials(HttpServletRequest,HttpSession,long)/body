{
  User user=UserLocalServiceUtil.getUser(userId);
  String userIdString=String.valueOf(userId);
  request=new ProtectedServletRequest(request,userIdString);
  session.setAttribute(WebKeys.USER,user);
  session.setAttribute(_AUTHENTICATED_USER,userIdString);
  if (_usePermissionChecker) {
    PrincipalThreadLocal.setName(userId);
    PermissionChecker permissionChecker=PermissionCheckerFactoryUtil.create(user,false);
    PermissionThreadLocal.setPermissionChecker(permissionChecker);
  }
  return request;
}
