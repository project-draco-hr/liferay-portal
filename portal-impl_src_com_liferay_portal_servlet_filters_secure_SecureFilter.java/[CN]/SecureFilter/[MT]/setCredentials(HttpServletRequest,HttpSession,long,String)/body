{
  User user=UserLocalServiceUtil.getUser(userId);
  String userIdString=String.valueOf(userId);
  request=new ProtectedServletRequest(request,userIdString,authType);
  session.setAttribute(WebKeys.USER,user);
  session.setAttribute(_AUTHENTICATED_USER,userIdString);
  if (_usePermissionChecker) {
    PrincipalThreadLocal.setName(userId);
    PrincipalThreadLocal.setPassword(PortalUtil.getUserPassword(request));
    PermissionChecker permissionChecker=PermissionCheckerFactoryUtil.create(user);
    PermissionThreadLocal.setPermissionChecker(permissionChecker);
  }
  return request;
}
