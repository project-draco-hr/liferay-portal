{
  HttpSession session=request.getSession();
  long userId=GetterUtil.getLong((String)session.getAttribute(_AUTHENTICATED_USER));
  if (userId > 0) {
    request=new ProtectedServletRequest(request,String.valueOf(userId));
  }
 else {
    try {
      userId=PortalUtil.getDigestAuthUserId(request);
    }
 catch (    Exception e) {
      _log.error(e);
    }
    if (userId > 0) {
      String userIdString=String.valueOf(userId);
      request=new ProtectedServletRequest(request,userIdString);
      session.setAttribute(_AUTHENTICATED_USER,userIdString);
    }
 else {
      long companyId=PortalInstances.getCompanyId(request);
      String remoteAddr=request.getRemoteAddr();
      String nonce=NonceUtil.generate(companyId,remoteAddr);
      StringBundler sb=new StringBundler(128);
      sb.append(_DIGEST_REALM);
      sb.append(",\nnonce=\"" + nonce + "\"");
      response.setHeader(HttpHeaders.WWW_AUTHENTICATE,sb.toString());
      response.setStatus(HttpServletResponse.SC_UNAUTHORIZED);
      return null;
    }
  }
  return request;
}
