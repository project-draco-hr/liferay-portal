{
  User user=UserUtil.findByPrimaryKey(userId);
  articleId=articleId.trim().toUpperCase();
  Date now=new Date();
  Date displayDate=PortalUtil.getDate(displayDateMonth,displayDateDay,displayDateYear,displayDateHour,displayDateMinute,user.getTimeZone(),new ArticleDisplayDateException());
  Date expirationDate=null;
  if (!neverExpire) {
    expirationDate=PortalUtil.getDate(expirationDateMonth,expirationDateDay,expirationDateYear,expirationDateHour,expirationDateMinute,user.getTimeZone(),new ArticleExpirationDateException());
  }
  Date reviewDate=null;
  if (!neverReview) {
    reviewDate=PortalUtil.getDate(reviewDateMonth,reviewDateDay,reviewDateYear,reviewDateHour,reviewDateMinute,user.getTimeZone(),new ArticleReviewDateException());
  }
  validate(user.getCompanyId(),title,content,groupId,structureId,templateId);
  JournalArticlePK oldPK=new JournalArticlePK(user.getCompanyId(),groupId,articleId,version);
  JournalArticle oldArticle=JournalArticleUtil.findByPrimaryKey(oldPK);
  JournalArticle article=null;
  if (incrementVersion) {
    double latestVersion=getLatestVersion(user.getCompanyId(),groupId,articleId);
    JournalArticlePK pk=new JournalArticlePK(user.getCompanyId(),groupId,articleId,MathUtil.format(latestVersion + 0.1,1,1));
    article=JournalArticleUtil.create(pk);
    article.setCompanyId(user.getCompanyId());
    article.setGroupId(oldArticle.getGroupId());
    article.setUserId(user.getUserId());
    article.setUserName(user.getFullName());
    article.setCreateDate(now);
  }
 else {
    article=oldArticle;
  }
  content=format(article.getCompanyId(),groupId,articleId,article.getVersion(),incrementVersion,content,structureId,images);
  boolean approved=oldArticle.isApproved();
  if (incrementVersion) {
    approved=false;
  }
  boolean expired=oldArticle.isExpired();
  if (incrementVersion) {
    expired=false;
  }
  article.setModifiedDate(now);
  article.setTitle(title);
  article.setDescription(description);
  article.setContent(content);
  article.setType(type);
  article.setStructureId(structureId);
  article.setTemplateId(templateId);
  article.setDisplayDate(displayDate);
  article.setApproved(approved);
  article.setExpired(expired);
  article.setExpirationDate(expirationDate);
  article.setReviewDate(reviewDate);
  JournalArticleUtil.update(article);
  if (incrementVersion) {
    sendEmail(article,articleURL,prefs,"requested");
  }
  try {
    if (article.isApproved()) {
      Indexer.updateArticle(article.getCompanyId(),article.getGroupId(),article.getArticleId(),article.getVersion(),article.getTitle(),article.getContent(),article.getContent(),article.getType(),article.getDisplayDate());
    }
  }
 catch (  IOException ioe) {
    _log.error("Indexing " + article.getPrimaryKey(),ioe);
  }
  return article;
}
