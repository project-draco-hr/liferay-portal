{
  User user=userPersistence.findByPrimaryKey(userId);
  folderId=dlFolderLocalService.getFolderId(user.getCompanyId(),folderId);
  String name=String.valueOf(counterLocalService.increment(DLFileEntry.class.getName()));
  String extension=getExtension(title,serviceContext);
  Long fileEntryTypeId=(Long)serviceContext.getAttribute("fileEntryTypeId");
  if (fileEntryTypeId == null) {
    fileEntryTypeId=0L;
  }
  Date now=new Date();
  validateFile(groupId,folderId,title,extension,is);
  long fileEntryId=counterLocalService.increment();
  DLFileEntry dlFileEntry=dlFileEntryPersistence.create(fileEntryId);
  dlFileEntry.setUuid(serviceContext.getUuid());
  dlFileEntry.setGroupId(groupId);
  dlFileEntry.setCompanyId(user.getCompanyId());
  dlFileEntry.setUserId(user.getUserId());
  dlFileEntry.setUserName(user.getFullName());
  dlFileEntry.setVersionUserId(user.getUserId());
  dlFileEntry.setVersionUserName(user.getFullName());
  dlFileEntry.setCreateDate(serviceContext.getCreateDate(now));
  dlFileEntry.setModifiedDate(serviceContext.getModifiedDate(now));
  dlFileEntry.setRepositoryId(repositoryId);
  dlFileEntry.setFolderId(folderId);
  dlFileEntry.setName(name);
  dlFileEntry.setExtension(extension);
  dlFileEntry.setMimeType(mimeType);
  dlFileEntry.setTitle(title);
  dlFileEntry.setDescription(description);
  dlFileEntry.setFileEntryTypeId(fileEntryTypeId);
  dlFileEntry.setVersion(DLFileEntryConstants.DEFAULT_VERSION);
  dlFileEntry.setSize(size);
  dlFileEntry.setReadCount(DLFileEntryConstants.DEFAULT_READ_COUNT);
  dlFileEntryPersistence.update(dlFileEntry,false);
  if (serviceContext.getAddGroupPermissions() || serviceContext.getAddGuestPermissions()) {
    addFileEntryResources(dlFileEntry,serviceContext.getAddGroupPermissions(),serviceContext.getAddGuestPermissions());
  }
 else {
    addFileEntryResources(dlFileEntry,serviceContext.getGroupPermissions(),serviceContext.getGuestPermissions());
  }
  DLFileVersion dlFileVersion=addFileVersion(user,dlFileEntry,serviceContext.getModifiedDate(now),extension,mimeType,title,description,null,StringPool.BLANK,fileEntryTypeId,DLFileEntryConstants.DEFAULT_VERSION,size,WorkflowConstants.STATUS_DRAFT,serviceContext);
  if (folderId != DLFolderConstants.DEFAULT_PARENT_FOLDER_ID) {
    DLFolder dlFolder=dlFolderPersistence.findByPrimaryKey(folderId);
    dlFolder.setLastPostDate(dlFileEntry.getModifiedDate());
    dlFolderPersistence.update(dlFolder,false);
  }
  updateAsset(userId,dlFileEntry,dlFileVersion,serviceContext.getAssetCategoryIds(),serviceContext.getAssetTagNames(),serviceContext.getAssetLinkEntryIds());
  dlAppHelperLocalService.addFileEntry(new LiferayFileEntry(dlFileEntry),new LiferayFileVersion(dlFileVersion),serviceContext);
  dlLocalService.addFile(user.getCompanyId(),PortletKeys.DOCUMENT_LIBRARY,dlFileEntry.getGroupId(),dlFileEntry.getDataRepositoryId(),name,false,fileEntryId,dlFileEntry.getLuceneProperties(),dlFileEntry.getModifiedDate(),serviceContext,is);
  WorkflowHandlerRegistryUtil.startWorkflowInstance(user.getCompanyId(),groupId,userId,DLFileEntry.class.getName(),fileEntryId,dlFileEntry,serviceContext);
  return dlFileEntry;
}
