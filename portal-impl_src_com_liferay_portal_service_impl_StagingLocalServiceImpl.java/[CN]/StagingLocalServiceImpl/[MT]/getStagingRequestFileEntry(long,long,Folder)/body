{
  FileEntry stagingRequestFileEntry=fetchStagingRequestFileEntry(stagingRequestId,folder);
  if (stagingRequestFileEntry != null) {
    return stagingRequestFileEntry;
  }
  FileOutputStream fileOutputStream=null;
  File tempFile=null;
  try {
    tempFile=FileUtil.createTempFile("lar");
    fileOutputStream=new FileOutputStream(tempFile);
    List<FileEntry> fileEntries=PortletFileRepositoryUtil.getPortletFileEntries(folder.getGroupId(),folder.getFolderId(),new RepositoryModelNameComparator<FileEntry>(true));
    for (    FileEntry fileEntry : fileEntries) {
      try {
        StreamUtil.transfer(fileEntry.getContentStream(),StreamUtil.uncloseable(fileOutputStream));
      }
  finally {
        PortletFileRepositoryUtil.deletePortletFileEntry(fileEntry.getFileEntryId());
      }
    }
    String checksum=FileUtil.getMD5Checksum(tempFile);
    if (!checksum.equals(folder.getName())) {
      throw new SystemException("Invalid checksum for LAR file");
    }
    PortletFileRepositoryUtil.addPortletFileEntry(folder.getGroupId(),userId,Group.class.getName(),folder.getGroupId(),_PORTLET_REPOSITORY_ID,folder.getFolderId(),tempFile,getAssembledFileName(stagingRequestId),ContentTypes.APPLICATION_ZIP,false);
    stagingRequestFileEntry=fetchStagingRequestFileEntry(stagingRequestId,folder);
    if (stagingRequestFileEntry == null) {
      throw new SystemException("Unable to assemble LAR file");
    }
    return stagingRequestFileEntry;
  }
 catch (  IOException ioe) {
    throw new SystemException("Unable to reassemble LAR file",ioe);
  }
 finally {
    StreamUtil.cleanUp(fileOutputStream);
    FileUtil.delete(tempFile);
  }
}
