{
  long companyId=targetLayout.getCompanyId();
  LayoutTypePortlet sourceLayoutTypePortlet=(LayoutTypePortlet)sourceLayout.getLayoutType();
  List<String> sourcePortletIds=sourceLayoutTypePortlet.getPortletIds();
  for (  String sourcePortletId : sourcePortletIds) {
    PortletPreferencesIds portletPreferencesIds=PortletPreferencesFactoryUtil.getPortletPreferencesIds(request,targetLayout,sourcePortletId);
    PortletPreferencesLocalServiceUtil.getPreferences(portletPreferencesIds);
    PortletPreferencesIds sourcePortletPreferencesIds=PortletPreferencesFactoryUtil.getPortletPreferencesIds(request,sourceLayout,sourcePortletId);
    PortletPreferences sourcePreferences=PortletPreferencesLocalServiceUtil.getPreferences(sourcePortletPreferencesIds);
    PortletPreferencesLocalServiceUtil.updatePreferences(portletPreferencesIds.getOwnerId(),portletPreferencesIds.getOwnerType(),portletPreferencesIds.getPlid(),portletPreferencesIds.getPortletId(),sourcePreferences);
    PortletPreferences targetPreferences=PortletPreferencesLocalServiceUtil.getPreferences(companyId,PortletKeys.PREFS_OWNER_ID_DEFAULT,PortletKeys.PREFS_OWNER_TYPE_LAYOUT,targetLayout.getPlid(),sourcePortletId);
    sourcePreferences=PortletPreferencesLocalServiceUtil.getPreferences(companyId,PortletKeys.PREFS_OWNER_ID_DEFAULT,PortletKeys.PREFS_OWNER_TYPE_LAYOUT,sourceLayout.getPlid(),sourcePortletId);
    PortletPreferencesLocalServiceUtil.updatePreferences(PortletKeys.PREFS_OWNER_ID_DEFAULT,PortletKeys.PREFS_OWNER_TYPE_LAYOUT,targetLayout.getPlid(),sourcePortletId,sourcePreferences);
    String scopeType=GetterUtil.getString(sourcePreferences.getValue("lfrScopeType",null));
    if (scopeType.equals("layout")) {
      ThemeDisplay themeDisplay=(ThemeDisplay)request.getAttribute(WebKeys.THEME_DISPLAY);
      String languageId=themeDisplay.getLanguageId();
      Layout targetScopeLayout=LayoutLocalServiceUtil.getLayoutByUuidAndGroupId(targetLayout.getUuid(),targetLayout.getGroupId());
      if (!targetScopeLayout.hasScopeGroup()) {
        GroupLocalServiceUtil.addGroup(themeDisplay.getUserId(),Layout.class.getName(),targetLayout.getPlid(),targetLayout.getName(languageId),null,0,null,false,true,null);
      }
      String portletTitle=PortalUtil.getPortletTitle(sourcePortletId,languageId);
      String newPortletTitle=PortalUtil.getNewPortletTitle(portletTitle,String.valueOf(sourceLayout.getLayoutId()),targetLayout.getName(languageId));
      targetPreferences.setValue("lfrScopeType","layout");
      targetPreferences.setValue("lfrScopeLayoutUuid",targetLayout.getUuid());
      targetPreferences.setValue("groupId",String.valueOf(targetLayout.getGroupId()));
      targetPreferences.setValue("portletSetupTitle_" + languageId,newPortletTitle);
      targetPreferences.setValue("portletSetupUseCustomTitle",Boolean.TRUE.toString());
      targetPreferences.store();
    }
  }
}
