{
  UploadPortletRequest uploadPortletRequest=PortalUtil.getUploadPortletRequest(portletRequest);
  ThemeDisplay themeDisplay=(ThemeDisplay)portletRequest.getAttribute(WebKeys.THEME_DISPLAY);
  JSONObject imageJSONObject=JSONFactoryUtil.createJSONObject();
  InputStream inputStream=null;
  try {
    imageJSONObject.put("attributeDataImageId",EditorConstants.ATTRIBUTE_DATA_IMAGE_ID);
    String parameterName=getParameterName();
    String fileName=uploadPortletRequest.getFileName(parameterName);
    String contentType=uploadPortletRequest.getContentType(parameterName);
    long size=uploadPortletRequest.getSize(parameterName);
    validateFile(fileName,contentType,size);
    long folderId=getFolderId(uploadPortletRequest);
    String uniqueFileName=getUniqueFileName(themeDisplay,fileName,folderId);
    inputStream=uploadPortletRequest.getFileAsStream(parameterName);
    FileEntry fileEntry=addFileEntry(themeDisplay.getUserId(),themeDisplay.getScopeGroupId(),folderId,uniqueFileName,contentType,inputStream,size,getServiceContext(uploadPortletRequest));
    imageJSONObject.put("fileEntryId",fileEntry.getFileEntryId());
    imageJSONObject.put("url",getURL(fileEntry,themeDisplay));
    return imageJSONObject;
  }
 catch (  IOException ioe) {
    throw new SystemException(ioe);
  }
 finally {
    StreamUtil.cleanUp(inputStream);
  }
}
