{
  PortletApp portletApp=portletFilterModel.getPortletApp();
  Map<String,PortletFilter> portletFilters=_portletFilters.get(portletApp.getServletContextName());
  if (portletFilters == null) {
    portletFilters=new ConcurrentHashMap<String,PortletFilter>();
    _portletFilters.put(portletApp.getServletContextName(),portletFilters);
  }
  PortletFilter portletFilter=portletFilters.get(portletFilterModel.getFilterName());
  if (portletFilter != null) {
    return portletFilter;
  }
  FilterConfig filterConfig=FilterConfigFactory.create(portletFilterModel,portletContext);
  if (portletApp.isWARFile()) {
    PortletContextBag portletContextBag=PortletContextBagPool.get(portletApp.getServletContextName());
    Map<String,PortletFilter> curPortletFilters=portletContextBag.getPortletFilters();
    portletFilter=curPortletFilters.get(portletFilterModel.getFilterName());
    portletFilter=_init(portletFilterModel,filterConfig,portletFilter);
  }
 else {
    portletFilter=_init(portletFilterModel,filterConfig);
  }
  portletFilters.put(portletFilterModel.getFilterName(),portletFilter);
  return portletFilter;
}
