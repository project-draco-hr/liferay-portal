{
  User user=userPersistence.findByPrimaryKey(userId);
  DDMForm parentDDMForm=getParentDDMForm(parentStructureId);
  validate(nameMap,parentDDMForm,ddmForm);
  structure.setParentStructureId(parentStructureId);
  DDMStructureVersion latestStructureVersion=ddmStructureVersionLocalService.getLatestStructureVersion(structure.getStructureId());
  boolean majorVersion=GetterUtil.getBoolean(serviceContext.getAttribute("majorVersion"));
  String version=getNextVersion(latestStructureVersion.getVersion(),majorVersion);
  structure.setVersion(version);
  structure.setNameMap(nameMap);
  structure.setVersionUserId(user.getUserId());
  structure.setVersionUserName(user.getFullName());
  structure.setDescriptionMap(descriptionMap);
  structure.setDefinition(ddmFormJSONSerializer.serialize(ddmForm));
  DDMStructureVersion structureVersion=addStructureVersion(user,structure,version,serviceContext);
  ddmStructureLayoutLocalService.addStructureLayout(structureVersion.getUserId(),structureVersion.getGroupId(),structureVersion.getStructureVersionId(),ddmFormLayout,serviceContext);
  if (!structureVersion.isApproved()) {
    return structure;
  }
  ddmStructurePersistence.update(structure);
  syncStructureTemplatesFields(structure);
  updateDataProviderInstanceLinks(structure.getGroupId(),structure.getStructureId(),ddmForm);
  reindexStructure(structure,serviceContext);
  return structure;
}
