{
  String portletId=getModulePortletId(modulePath);
  Portlet portlet=PortletLocalServiceUtil.getPortletById(portletId);
  if (portlet.isUndeployedPortlet()) {
    return null;
  }
  PortletApp portletApp=portlet.getPortletApp();
  ServletContext servletContext=portletApp.getServletContext();
  String resourcePath=getResourcePath(modulePath);
  String contextPath=servletContext.getContextPath();
  if (resourcePath.startsWith(contextPath)) {
    resourcePath=resourcePath.substring(contextPath.length());
  }
  URL url=servletContext.getResource(resourcePath);
  if (url != null) {
    return url;
  }
  url=new URL(request.getScheme(),request.getLocalAddr(),request.getLocalPort(),contextPath + resourcePath);
  HttpURLConnection urlConnection=(HttpURLConnection)url.openConnection();
  try {
    if (urlConnection.getResponseCode() == HttpServletResponse.SC_OK) {
      return url;
    }
    throw new ServletException("Resource " + resourcePath + " does not exist in "+ portlet.getContextPath());
  }
  finally {
    try {
      InputStream inputStream=urlConnection.getInputStream();
      inputStream.close();
    }
 catch (    IOException ioe) {
    }
  }
}
