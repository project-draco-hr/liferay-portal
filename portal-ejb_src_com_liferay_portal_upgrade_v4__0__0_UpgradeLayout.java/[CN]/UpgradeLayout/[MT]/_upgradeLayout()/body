{
  Connection con=null;
  PreparedStatement ps=null;
  ResultSet rs=null;
  try {
    Set groupIds=new HashSet();
    con=DataAccess.getConnection(Constants.DATA_SOURCE);
    ps=con.prepareStatement(_UPGRADE_LAYOUT_1);
    rs=ps.executeQuery();
    while (rs.next()) {
      String oldLayoutId=rs.getString("layoutId");
      String oldOwnerId=rs.getString("ownerId");
      String companyId=rs.getString("companyId");
      String oldParentLayoutId=rs.getString("parentLayoutId");
      String oldName=rs.getString("name");
      String oldTypeSettings=rs.getString("typeSettings");
      _log.debug("Upgrading layout " + new LayoutPK(oldLayoutId,oldOwnerId));
      String newLayoutId=_getNewLayoutId(oldLayoutId);
      String newOwnerId=null;
      int pos=oldLayoutId.indexOf(".");
      if (pos != -1) {
        String groupId=oldLayoutId.substring(0,pos);
        if (!groupIds.contains(groupId)) {
          String[] lookAndFeel=_getLookAndFeelByGroupId(groupId);
          LayoutSetLocalServiceUtil.addLayoutSet(Layout.PRIVATE + groupId,companyId);
          LayoutSetLocalServiceUtil.updateLookAndFeel(Layout.PRIVATE + groupId,lookAndFeel[0],lookAndFeel[1]);
          LayoutSetLocalServiceUtil.addLayoutSet(Layout.PUBLIC + groupId,companyId);
          LayoutSetLocalServiceUtil.updateLookAndFeel(Layout.PUBLIC + groupId,lookAndFeel[0],lookAndFeel[1]);
        }
        groupIds.add(groupId);
        Group group=GroupLocalServiceUtil.getGroup(groupId);
        if (group.getName().equals("Guest")) {
          newOwnerId=Layout.PUBLIC + groupId;
        }
 else         if (group.getName().equals("General User")) {
          continue;
        }
 else {
          newOwnerId=Layout.PRIVATE + groupId;
        }
      }
 else {
        String userId=oldOwnerId;
        Group group=null;
        try {
          group=GroupLocalServiceUtil.getUserGroup(companyId,userId);
        }
 catch (        NoSuchGroupException nsge) {
          group=GroupLocalServiceUtil.addGroup(userId,User.class.getName(),userId,null,null,null,null);
          String groupId=group.getGroupId();
          String[] lookAndFeel=_getLookAndFeelByUserId(userId);
          LayoutSetLocalServiceUtil.updateLookAndFeel(Layout.PRIVATE + groupId,lookAndFeel[0],lookAndFeel[1]);
          LayoutSetLocalServiceUtil.updateLookAndFeel(Layout.PUBLIC + groupId,lookAndFeel[0],lookAndFeel[1]);
        }
        newOwnerId=Layout.PRIVATE + group.getGroupId();
      }
      String newParentLayoutId=_getNewLayoutId(oldParentLayoutId);
      String newName=_getNewLayoutName(oldName);
      String newTypeSettings=_getNewLayoutTypeSettings(oldTypeSettings);
      ps=con.prepareStatement(_UPGRADE_LAYOUT_2);
      ps.setString(1,newLayoutId);
      ps.setString(2,newOwnerId);
      ps.setString(3,newParentLayoutId);
      ps.setString(4,newName);
      ps.setString(5,newTypeSettings);
      ps.setString(6,oldLayoutId);
      ps.setString(7,oldOwnerId);
      ps.executeUpdate();
      _upgradePortletPreferences(oldLayoutId,oldOwnerId,newOwnerId);
      LayoutSetLocalServiceUtil.updatePageCount(newOwnerId);
    }
  }
  finally {
    DataAccess.cleanUp(con,ps,rs);
  }
}
