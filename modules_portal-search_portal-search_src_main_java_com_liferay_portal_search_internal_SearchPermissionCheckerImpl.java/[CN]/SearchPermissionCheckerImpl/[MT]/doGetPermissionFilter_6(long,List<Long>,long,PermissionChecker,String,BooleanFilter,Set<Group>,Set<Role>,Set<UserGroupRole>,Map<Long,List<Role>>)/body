{
  BooleanFilter permissionBooleanFilter=new BooleanFilter();
  if (userId > 0) {
    permissionBooleanFilter.addTerm(Field.USER_ID,userId);
  }
  TermsFilter groupsTermsFilter=new TermsFilter(Field.GROUP_ID);
  TermsFilter groupRolesTermsFilter=new TermsFilter(Field.GROUP_ROLE_ID);
  TermsFilter rolesTermsFilter=new TermsFilter(Field.ROLE_ID);
  for (  Role role : roles) {
    String roleName=role.getName();
    if (roleName.equals(RoleConstants.ADMINISTRATOR)) {
      return booleanFilter;
    }
    if (_resourcePermissionLocalService.hasResourcePermission(companyId,className,ResourceConstants.SCOPE_COMPANY,String.valueOf(companyId),role.getRoleId(),ActionKeys.VIEW)) {
      return booleanFilter;
    }
    if ((role.getType() == RoleConstants.TYPE_REGULAR) && _resourcePermissionLocalService.hasResourcePermission(companyId,className,ResourceConstants.SCOPE_GROUP_TEMPLATE,String.valueOf(GroupConstants.DEFAULT_PARENT_GROUP_ID),role.getRoleId(),ActionKeys.VIEW)) {
      return booleanFilter;
    }
    for (    Group group : groups) {
      if (permissionChecker.isGroupAdmin(group.getGroupId()) || _resourcePermissionLocalService.hasResourcePermission(companyId,className,ResourceConstants.SCOPE_GROUP,String.valueOf(group.getGroupId()),role.getRoleId(),ActionKeys.VIEW)) {
        groupsTermsFilter.addValue(String.valueOf(group.getGroupId()));
      }
      if ((role.getType() != RoleConstants.TYPE_REGULAR) && _resourcePermissionLocalService.hasResourcePermission(companyId,className,ResourceConstants.SCOPE_GROUP_TEMPLATE,String.valueOf(GroupConstants.DEFAULT_PARENT_GROUP_ID),role.getRoleId(),ActionKeys.VIEW)) {
        List<Role> groupRoles=groupIdsToRoles.get(group.getGroupId());
        if (groupRoles.contains(role)) {
          groupsTermsFilter.addValue(String.valueOf(group.getGroupId()));
        }
      }
      if (group.isSite() && !roleName.equals(RoleConstants.SITE_MEMBER) && (role.getType() == RoleConstants.TYPE_SITE)) {
        groupRolesTermsFilter.addValue(group.getGroupId() + StringPool.DASH + role.getRoleId());
      }
    }
    if (ListUtil.isNotEmpty(groupIds)) {
      for (      long groupId : groupIds) {
        if (_resourcePermissionLocalService.hasResourcePermission(companyId,className,ResourceConstants.SCOPE_GROUP,String.valueOf(groupId),role.getRoleId(),ActionKeys.VIEW)) {
          groupsTermsFilter.addValue(String.valueOf(groupId));
        }
      }
    }
    rolesTermsFilter.addValue(String.valueOf(role.getRoleId()));
  }
  for (  Group group : groups) {
    addRequiredMemberRole(group,groupRolesTermsFilter);
  }
  for (  UserGroupRole userGroupRole : userGroupRoles) {
    groupRolesTermsFilter.addValue(userGroupRole.getGroupId() + StringPool.DASH + userGroupRole.getRoleId());
  }
  if (!groupsTermsFilter.isEmpty()) {
    permissionBooleanFilter.add(groupsTermsFilter);
  }
  if (!groupRolesTermsFilter.isEmpty()) {
    permissionBooleanFilter.add(groupRolesTermsFilter);
  }
  if (!rolesTermsFilter.isEmpty()) {
    permissionBooleanFilter.add(rolesTermsFilter);
  }
  if (!permissionBooleanFilter.hasClauses()) {
    return booleanFilter;
  }
  BooleanFilter fullBooleanFilter=new BooleanFilter();
  if ((booleanFilter != null) && booleanFilter.hasClauses()) {
    fullBooleanFilter.add(booleanFilter,BooleanClauseOccur.MUST);
  }
  fullBooleanFilter.add(permissionBooleanFilter,BooleanClauseOccur.MUST);
  return fullBooleanFilter;
}
