{
  HttpServletRequest request=PortalUtil.getHttpServletRequest(renderRequest);
  ThemeDisplay themeDisplay=(ThemeDisplay)renderRequest.getAttribute(WebKeys.THEME_DISPLAY);
  double version=ParamUtil.getDouble(request,"version");
  PortletURL curViewPageURL=PortletURLUtil.clone(viewPageURL,renderResponse);
  PortletURL curEditPageURL=PortletURLUtil.clone(editPageURL,renderResponse);
  String attachmentURLPrefix=themeDisplay.getPathMain() + "/wiki/get_page_attachment?p_l_id=" + themeDisplay.getPlid()+ "&nodeId="+ wikiPage.getNodeId()+ "&title="+ HttpUtil.encodeURL(wikiPage.getTitle())+ "&fileName=";
  WikiPageDisplay pageDisplay=null;
  if (!preview && (version == 0)) {
    pageDisplay=WikiCacheUtil.getDisplay(wikiPage.getNodeId(),title,curViewPageURL,curEditPageURL,attachmentURLPrefix);
  }
  String formattedContent=null;
  if (pageDisplay != null) {
    formattedContent=pageDisplay.getFormattedContent();
  }
 else {
    formattedContent=WikiUtil.convert(wikiPage,curViewPageURL,curEditPageURL,attachmentURLPrefix);
  }
  return formattedContent;
}
