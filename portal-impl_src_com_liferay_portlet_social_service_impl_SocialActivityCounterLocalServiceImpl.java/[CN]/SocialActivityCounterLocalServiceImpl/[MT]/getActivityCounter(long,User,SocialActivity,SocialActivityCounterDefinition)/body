{
  int ownerType=activityCounterDefinition.getOwnerType();
  long classNameId=getClassNameId(activity.getAssetEntry(),ownerType);
  long classPK=getClassPK(user,activity.getAssetEntry(),ownerType);
  SocialActivityCounter activityCounter=fetchLatestActivityCounter(groupId,classNameId,classPK,activityCounterDefinition.getName(),ownerType);
  if (activityCounter == null) {
    activityCounter=createActivityCounter(groupId,classNameId,classPK,activityCounterDefinition.getName(),ownerType,0,0,activityCounterDefinition.getPeriodLength());
  }
 else   if (!activityCounter.isActivePeriod(activityCounterDefinition.getPeriodLength())) {
    activityCounter=createActivityCounter(groupId,classNameId,classPK,activityCounterDefinition.getName(),ownerType,activityCounter.getTotalValue(),activityCounter.getActivityCounterId(),activityCounterDefinition.getPeriodLength());
  }
  if (activityCounterDefinition.getLimitValue() > 0) {
    SocialActivityLimit activityLimit=socialActivityLimitPersistence.fetchByG_U_C_C_A_A(groupId,user.getUserId(),activity.getClassNameId(),getLimitClassPK(activity,activityCounterDefinition),activity.getType(),activityCounterDefinition.getName());
    if (activityLimit == null) {
      createActivityLimit(groupId,user,activity,activityCounterDefinition);
    }
  }
  return activityCounter;
}
