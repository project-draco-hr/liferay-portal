{
  SocialActivityCounter activityCounter=null;
  String lockKey=getLockKey(groupId,classNameId,classPK,name,ownerType);
  Lock lock=null;
  while (true) {
    try {
      lock=lockLocalService.lock(SocialActivityCounter.class.getName(),lockKey,lockKey,false);
    }
 catch (    Exception e) {
      if (_log.isWarnEnabled()) {
        _log.warn("Unable to acquire activity counter lock. Retrying.");
      }
      continue;
    }
    if (lock.isNew()) {
      try {
        if (DBFactoryUtil.getDB() instanceof HypersonicDB) {
          activityCounter=createActivityCounter(groupId,classNameId,classPK,name,ownerType,currentValue,totalValue,startPeriod,endPeriod);
        }
 else {
          activityCounter=socialActivityCounterLocalService.createActivityCounter(groupId,classNameId,classPK,name,ownerType,currentValue,totalValue,startPeriod,endPeriod);
        }
      }
  finally {
        lockLocalService.unlock(SocialActivityCounter.class.getName(),lockKey,lockKey,false);
      }
      break;
    }
    Date createDate=lock.getCreateDate();
    if ((System.currentTimeMillis() - createDate.getTime()) >= PropsValues.SOCIAL_ACTIVITY_COUNTER_LOCK_TIMEOUT) {
      lockLocalService.unlock(SocialActivityCounter.class.getName(),lockKey,lock.getOwner(),false);
      if (_log.isWarnEnabled()) {
        _log.warn("Forcibly removed lock " + lock + ". See "+ PropsKeys.SOCIAL_ACTIVITY_COUNTER_LOCK_TIMEOUT);
      }
    }
 else {
      try {
        Thread.sleep(PropsValues.SOCIAL_ACTIVITY_COUNTER_LOCK_RETRY_DELAY);
      }
 catch (      InterruptedException ie) {
        if (_log.isWarnEnabled()) {
          _log.warn("Interrupted while waiting to reacquire lock",ie);
        }
      }
    }
  }
  return activityCounter;
}
