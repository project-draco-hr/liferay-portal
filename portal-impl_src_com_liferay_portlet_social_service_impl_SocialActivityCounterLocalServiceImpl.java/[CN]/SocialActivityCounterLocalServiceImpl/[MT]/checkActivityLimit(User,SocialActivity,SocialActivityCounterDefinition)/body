{
  if (activityCounterDefinition.getLimitValue() == 0) {
    return true;
  }
  long classPK=activity.getClassPK();
  String name=activityCounterDefinition.getName();
  if (name.equals(SocialActivityCounterConstants.NAME_PARTICIPATION)) {
    classPK=0;
  }
  SocialActivityLimit activityLimit=socialActivityLimitPersistence.fetchByG_U_C_C_A_A(activity.getGroupId(),user.getUserId(),activity.getClassNameId(),classPK,activity.getType(),activityCounterDefinition.getName());
  if (activityLimit == null) {
    try {
      activityLimit=socialActivityLimitLocalService.addActivityLimit(user.getUserId(),activity.getGroupId(),activity.getClassNameId(),classPK,activity.getType(),activityCounterDefinition.getName(),activityCounterDefinition.getLimitPeriod());
    }
 catch (    SystemException se) {
      activityLimit=socialActivityLimitPersistence.fetchByG_U_C_C_A_A(activity.getGroupId(),user.getUserId(),activity.getClassNameId(),classPK,activity.getType(),activityCounterDefinition.getName());
      if (activityLimit == null) {
        throw se;
      }
    }
  }
  int count=activityLimit.getCount(activityCounterDefinition.getLimitPeriod());
  if (count < activityCounterDefinition.getLimitValue()) {
    activityLimit.setCount(activityCounterDefinition.getLimitPeriod(),count + 1);
    socialActivityLimitPersistence.update(activityLimit,false);
    return true;
  }
  return false;
}
