{
  String cmd=ParamUtil.getString(req,Constants.CMD);
  String layoutId=ParamUtil.getString(req,"layoutId");
  String ownerId=ParamUtil.getString(req,"ownerId");
  String groupId=ParamUtil.getString(req,"groupId");
  boolean privateLayout=ParamUtil.getBoolean(req,"privateLayout");
  String parentLayoutId=ParamUtil.getString(req,"parentLayoutId");
  String name=ParamUtil.getString(req,"name");
  String languageId=ParamUtil.getString(req,"curLanguageId");
  String type=ParamUtil.getString(req,"type");
  boolean hidden=ParamUtil.getBoolean(req,"hidden");
  String friendlyURL=ParamUtil.getString(req,"friendlyURL");
  String copyLayoutId=ParamUtil.getString(req,"copyLayoutId");
  if (cmd.equals(Constants.ADD)) {
    Layout layout=LayoutServiceUtil.addLayout(groupId,privateLayout,parentLayoutId,name,type,hidden,friendlyURL);
    if (type.equals(Layout.TYPE_PORTLET)) {
      LayoutTypePortlet layoutTypePortlet=(LayoutTypePortlet)layout.getLayoutType();
      layoutTypePortlet.setLayoutTemplateId(PropsUtil.get(PropsUtil.LAYOUT_DEFAULT_TEMPLATE_ID));
      LayoutServiceUtil.updateLayout(layout.getLayoutId(),layout.getOwnerId(),layout.getTypeSettings());
    }
  }
 else {
    Layout layout=LayoutServiceUtil.updateLayout(layoutId,ownerId,parentLayoutId,name,languageId,type,hidden,friendlyURL);
    if (!type.equals(Layout.TYPE_PORTLET)) {
      layout.setTypeSettingsProperties(pageForm.getTypeSettingsProperties());
      LayoutServiceUtil.updateLayout(layoutId,ownerId,layout.getTypeSettings());
    }
 else     if ((Validator.isNotNull(copyLayoutId)) && (!copyLayoutId.equals(layout.getLayoutId()))) {
      try {
        Layout copyLayout=LayoutLocalServiceUtil.getLayout(copyLayoutId,ownerId);
        if (copyLayout.getType().equals(Layout.TYPE_PORTLET)) {
          LayoutServiceUtil.updateLayout(layoutId,ownerId,copyLayout.getTypeSettings());
          copyPreferences(req,layout,copyLayout);
        }
      }
 catch (      NoSuchLayoutException nsle) {
      }
    }
  }
}
