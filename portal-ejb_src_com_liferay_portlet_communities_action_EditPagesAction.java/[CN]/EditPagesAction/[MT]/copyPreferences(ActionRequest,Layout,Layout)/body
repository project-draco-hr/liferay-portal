{
  long companyId=layout.getCompanyId();
  LayoutTypePortlet copyLayoutTypePortlet=(LayoutTypePortlet)copyLayout.getLayoutType();
  List copyPortletIds=copyLayoutTypePortlet.getPortletIds();
  for (int i=0; i < copyPortletIds.size(); i++) {
    String copyPortletId=(String)copyPortletIds.get(i);
    ActionRequestImpl reqImpl=(ActionRequestImpl)req;
    HttpServletRequest httpReq=(HttpServletRequest)reqImpl.getHttpServletRequest();
    PortletPreferencesIds portletPreferencesIds=PortletPreferencesFactory.getPortletPreferencesIds(httpReq,layout,copyPortletId);
    PortletPreferencesLocalServiceUtil.getPreferences(portletPreferencesIds);
    PortletPreferencesIds copyPortletPreferencesIds=PortletPreferencesFactory.getPortletPreferencesIds(httpReq,copyLayout,copyPortletId);
    PortletPreferences copyPrefs=PortletPreferencesLocalServiceUtil.getPreferences(copyPortletPreferencesIds);
    PortletPreferencesLocalServiceUtil.updatePreferences(portletPreferencesIds.getOwnerId(),portletPreferencesIds.getOwnerType(),portletPreferencesIds.getPlid(),portletPreferencesIds.getPortletId(),copyPrefs);
    PortletPreferencesLocalServiceUtil.getPreferences(companyId,PortletKeys.PREFS_OWNER_ID_DEFAULT,PortletKeys.PREFS_OWNER_TYPE_LAYOUT,layout.getPlid(),copyPortletId);
    copyPrefs=PortletPreferencesLocalServiceUtil.getPreferences(companyId,PortletKeys.PREFS_OWNER_ID_DEFAULT,PortletKeys.PREFS_OWNER_TYPE_LAYOUT,copyLayout.getPlid(),copyPortletId);
    PortletPreferencesLocalServiceUtil.updatePreferences(PortletKeys.PREFS_OWNER_ID_DEFAULT,PortletKeys.PREFS_OWNER_TYPE_LAYOUT,layout.getPlid(),copyPortletId,copyPrefs);
  }
}
