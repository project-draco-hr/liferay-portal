{
  long classNameId=getRepositoryClassNameId(repositoryId);
  RepositoryDefinition repositoryDefinition=getRepositoryDefinition(classNameId);
  RepositoryCreator repositoryCreator=repositoryDefinition.getRepositoryCreator();
  Repository repository=repositoryCreator.createRepository(repositoryId);
  Map<Class<? extends Capability>,Capability> externalSupportedCapabilities=repositoryDefinition.getSupportedCapabilities();
  Set<Class<? extends Capability>> externalExportedCapabilityClasses=repositoryDefinition.getExportedCapabilities();
  CMISRepositoryHandler cmisRepositoryHandler=getCMISRepositoryHandler(repository);
  if (cmisRepositoryHandler != null) {
    externalSupportedCapabilities=new HashMap<Class<? extends Capability>,Capability>(externalSupportedCapabilities);
    externalSupportedCapabilities.put(CMISRepositoryHandler.class,cmisRepositoryHandler);
    externalExportedCapabilityClasses=new HashSet<Class<? extends Capability>>(externalExportedCapabilityClasses);
    externalExportedCapabilityClasses.add(CMISRepositoryHandler.class);
  }
  return new CapabilityRepository(repository,externalSupportedCapabilities,externalExportedCapabilityClasses,repositoryDefinition.getRepositoryEventTrigger());
}
