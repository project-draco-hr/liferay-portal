{
  PortletSession portletSession=actionRequest.getPortletSession();
  int step=ParamUtil.getInteger(actionRequest,"step");
  if (step == 1) {
    checkCaptcha(actionRequest);
    portletSession.removeAttribute(WebKeys.FORGOT_PASSWORD_REMINDER_ATTEMPTS);
    portletSession.removeAttribute(WebKeys.FORGOT_PASSWORD_REMINDER_USER_EMAIL_ADDRESS);
  }
  User user=getUser(actionRequest);
  portletSession.setAttribute(WebKeys.FORGOT_PASSWORD_REMINDER_USER_EMAIL_ADDRESS,user.getEmailAddress());
  actionRequest.setAttribute(WebKeys.FORGOT_PASSWORD_REMINDER_USER,user);
  if (step == 2) {
    Integer reminderAttempts=(Integer)portletSession.getAttribute(WebKeys.FORGOT_PASSWORD_REMINDER_ATTEMPTS);
    if (reminderAttempts == null) {
      reminderAttempts=0;
    }
 else     if (reminderAttempts > 2) {
      checkCaptcha(actionRequest);
    }
    reminderAttempts++;
    portletSession.setAttribute(WebKeys.FORGOT_PASSWORD_REMINDER_ATTEMPTS,reminderAttempts);
    sendPassword(actionRequest,actionResponse);
  }
}
