{
  try {
    SyncUtil.checkSyncEnabled(0);
    User user=getGuestOrUser();
    SyncContext syncContext=new SyncContext();
    String authType=PrefsPropsUtil.getString(CompanyThreadLocal.getCompanyId(),PropsKeys.COMPANY_SECURITY_AUTH_TYPE,PropsUtil.get(PropsKeys.COMPANY_SECURITY_AUTH_TYPE));
    syncContext.setAuthType(authType);
    boolean oAuthEnabled=PrefsPropsUtil.getBoolean(user.getCompanyId(),SyncConstants.SYNC_OAUTH_ENABLED);
    if (oAuthEnabled) {
      String oAuthConsumerKey=PrefsPropsUtil.getString(user.getCompanyId(),SyncConstants.SYNC_OAUTH_CONSUMER_KEY);
      syncContext.setOAuthConsumerKey(oAuthConsumerKey);
      String oAuthConsumerSecret=PrefsPropsUtil.getString(user.getCompanyId(),SyncConstants.SYNC_OAUTH_CONSUMER_SECRET);
      syncContext.setOAuthConsumerSecret(oAuthConsumerSecret);
    }
    syncContext.setOAuthEnabled(oAuthEnabled);
    syncContext.setPortletPreferencesMap(getPortletPreferencesMap());
    Bundle bundle=FrameworkUtil.getBundle(this.getClass());
    syncContext.setPluginVersion(String.valueOf(bundle.getVersion()));
    if (!user.isDefaultUser()) {
      syncContext.setPortalBuildNumber(ReleaseInfo.getBuildNumber());
      syncContext.setUser(user);
      if (!syncDeviceSupports(SyncDeviceConstants.FEATURE_SET_1)) {
        syncContext.setUserSitesGroups(getUserSitesGroups());
      }
    }
    return syncContext;
  }
 catch (  PortalException pe) {
    throw new PortalException(SyncUtil.buildExceptionMessage(pe),pe);
  }
}
