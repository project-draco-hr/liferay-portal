{
  ShardDataSourceTargetSource shardDataSourceTargetSource=(ShardDataSourceTargetSource)InfrastructureUtil.getShardDataSourceTargetSource();
  if (shardDataSourceTargetSource == null) {
    return getSessionFactoryImplementor();
  }
  DataSource dataSource=shardDataSourceTargetSource.getDataSource();
  SessionFactory sessionFactory=getCachedSessionFactory(dataSource);
  if (sessionFactory != null) {
    return sessionFactory;
  }
  sessionFactory=createSessionFactory(dataSource);
  if (sessionFactory != null) {
    cacheSessionFactory(dataSource,sessionFactory);
  }
  return sessionFactory;
}
