{
  ShardDataSourceTargetSource shardDataSourceTargetSource=(ShardDataSourceTargetSource)InfrastructureUtil.getShardDataSourceTargetSource();
  if (shardDataSourceTargetSource != null) {
    DataSource dataSource=shardDataSourceTargetSource.getDataSource();
    SessionFactory sessionFactory=_sessionFactories.get(dataSource);
    if (sessionFactory == null) {
      PortletHibernateConfiguration portletHibernateConfiguration=new PortletHibernateConfiguration();
      portletHibernateConfiguration.setDataSource(dataSource);
      try {
        sessionFactory=portletHibernateConfiguration.buildSessionFactory();
      }
 catch (      Exception e) {
        _log.error(e,e);
        return null;
      }
      _sessionFactories.put(dataSource,sessionFactory);
    }
    return sessionFactory;
  }
 else {
    return getSessionFactoryImplementor();
  }
}
