{
  ShardDataSourceTargetSource shardDataSourceTargetSource=InfrastructureUtil.getShardDataSourceTargetSource();
  if (shardDataSourceTargetSource == null) {
    return getSessionFactoryImplementor();
  }
  DataSource dataSource=shardDataSourceTargetSource.getDataSource();
  SessionFactory sessionFactory=getSessionFactory(dataSource);
  if (sessionFactory != null) {
    return sessionFactory;
  }
  sessionFactory=createSessionFactory(dataSource);
  if (sessionFactory != null) {
    putSessionFactory(dataSource,sessionFactory);
  }
  return sessionFactory;
}
