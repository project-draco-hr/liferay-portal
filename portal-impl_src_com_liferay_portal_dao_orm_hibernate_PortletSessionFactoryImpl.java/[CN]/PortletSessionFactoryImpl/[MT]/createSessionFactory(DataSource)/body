{
  String servletContextName=PortletClassLoaderUtil.getServletContextName();
  ClassLoader classLoader=getSessionFactoryClassLoader();
  PortletClassLoaderUtil.setServletContextName(ClassLoaderPool.getContextName(classLoader));
  try {
    PortletHibernateConfiguration portletHibernateConfiguration=new PortletHibernateConfiguration();
    portletHibernateConfiguration.setDataSource(dataSource);
    SessionFactory sessionFactory;
    try {
      sessionFactory=portletHibernateConfiguration.buildSessionFactory();
    }
 catch (    Exception e) {
      _log.error(e,e);
      return null;
    }
    return sessionFactory;
  }
  finally {
    PortletClassLoaderUtil.setServletContextName(servletContextName);
  }
}
