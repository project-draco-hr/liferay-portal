{
  Locale locale=null;
  if (request != null) {
    ThemeDisplay themeDisplay=(ThemeDisplay)request.getAttribute(WebKeys.THEME_DISPLAY);
    locale=themeDisplay.getLocale();
  }
 else {
    locale=LocaleThreadLocal.getThemeDisplayLocale();
  }
  if (locale == null) {
    locale=LocaleUtil.getDefault();
  }
  return locale;
}
