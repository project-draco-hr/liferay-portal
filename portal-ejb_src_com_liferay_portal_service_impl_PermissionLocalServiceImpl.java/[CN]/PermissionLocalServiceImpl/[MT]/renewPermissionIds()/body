{
  List permissions=PermissionUtil.findAll();
  Map orgGroupMap=new HashMap(permissions.size());
  Map groupMap=new HashMap(permissions.size());
  Map roleMap=new HashMap(permissions.size());
  Map userMap=new HashMap(permissions.size());
  for (Iterator itr=permissions.iterator(); itr.hasNext(); ) {
    Permission permission=(Permission)itr.next();
    long permissionId=permission.getPermissionId();
    Long wrappedPermissionId=new Long(permissionId);
    groupMap.put(wrappedPermissionId,PermissionUtil.getGroups(permissionId));
    roleMap.put(wrappedPermissionId,PermissionUtil.getRoles(permissionId));
    userMap.put(wrappedPermissionId,PermissionUtil.getUsers(permissionId));
    orgGroupMap.put(wrappedPermissionId,OrgGroupPermissionUtil.findByPermissionId(permissionId));
    PermissionUtil.remove(permissionId);
  }
  for (Iterator itr=permissions.iterator(); itr.hasNext(); ) {
    Permission permission=(Permission)itr.next();
    Long oldPermissionId=new Long(permission.getPermissionId());
    long newPermissionId=CounterLocalServiceUtil.increment(Counter.class.getName());
    Permission newPermission=PermissionUtil.create(newPermissionId);
    newPermission.setActionId(permission.getActionId());
    newPermission.setCompanyId(permission.getCompanyId());
    newPermission.setResourceId(permission.getResourceId());
    PermissionUtil.update(newPermission);
    PermissionUtil.addGroups(newPermissionId,(List)groupMap.get(oldPermissionId));
    PermissionUtil.addRoles(newPermissionId,(List)roleMap.get(oldPermissionId));
    PermissionUtil.addUsers(newPermissionId,(List)userMap.get(oldPermissionId));
    List orgGroupList=(List)orgGroupMap.get(oldPermissionId);
    for (Iterator itr2=orgGroupList.iterator(); itr2.hasNext(); ) {
      OrgGroupPermission oldOrgGroupPermission=(OrgGroupPermission)itr2;
      OrgGroupPermission newOrgGroupPermission=OrgGroupPermissionUtil.create(new OrgGroupPermissionPK());
      newOrgGroupPermission.setGroupId(oldOrgGroupPermission.getGroupId());
      newOrgGroupPermission.setOrganizationId(oldOrgGroupPermission.getOrganizationId());
      newOrgGroupPermission.setPermissionId(newPermissionId);
      OrgGroupPermissionUtil.update(newOrgGroupPermission);
    }
  }
}
