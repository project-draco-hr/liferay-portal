{
  if (parentFolderId == IGFolderImpl.DEFAULT_PARENT_FOLDER_ID) {
    return parentFolderId;
  }
  if (folder.getFolderId() == parentFolderId) {
    return folder.getParentFolderId();
  }
 else {
    IGFolder parentFolder=igFolderPersistence.fetchByPrimaryKey(parentFolderId);
    if ((parentFolder == null) || (folder.getGroupId() != parentFolder.getGroupId())) {
      return folder.getParentFolderId();
    }
    List<Long> subfolderIds=new ArrayList<Long>();
    getSubfolderIds(subfolderIds,folder.getGroupId(),folder.getFolderId());
    if (subfolderIds.contains(new Long(parentFolderId))) {
      return folder.getParentFolderId();
    }
    return parentFolderId;
  }
}
