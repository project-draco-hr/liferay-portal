{
  User user=userPersistence.findByPrimaryKey(userId);
  parentFolderId=getParentFolderId(groupId,parentFolderId);
  Date now=new Date();
  validate(name);
  long folderId=counterLocalService.increment();
  IGFolder folder=igFolderPersistence.create(folderId);
  folder.setGroupId(groupId);
  folder.setCompanyId(user.getCompanyId());
  folder.setUserId(user.getUserId());
  folder.setCreateDate(now);
  folder.setModifiedDate(now);
  folder.setParentFolderId(parentFolderId);
  folder.setName(name);
  folder.setDescription(description);
  igFolderPersistence.update(folder);
  if ((addCommunityPermissions != null) && (addGuestPermissions != null)) {
    addFolderResources(folder,addCommunityPermissions.booleanValue(),addGuestPermissions.booleanValue());
  }
 else {
    addFolderResources(folder,communityPermissions,guestPermissions);
  }
  return folder;
}
