{
  DDLRecord record=ddlRecordPersistence.findByPrimaryKey(recordId);
  DDLRecordSet recordSet=record.getRecordSet();
  DDLRecordVersion recordVersion=record.getLatestRecordVersion();
  if (mergeFields) {
    DDMFormValues existingDDMFormValues=storageEngine.getDDMFormValues(recordVersion.getDDMStorageId());
    Fields existingFields=ddmFormValuesToFieldsConverter.convert(recordSet.getDDMStructure(),existingDDMFormValues);
    fields=ddm.mergeFields(fields,existingFields);
  }
  DDMFormValues ddmFormValues=FieldsToDDMFormValuesConverterUtil.convert(recordSet.getDDMStructure(),fields);
  return ddlRecordLocalService.updateRecord(userId,recordId,majorVersion,displayIndex,ddmFormValues,serviceContext);
}
