{
  if (size < _MINIMUM_INCREMENT_SIZE) {
    size=_MINIMUM_INCREMENT_SIZE;
  }
  CounterRegister register=getCounterRegister(name);
synchronized (register) {
    long newValue=register.getCurrentValue() + size;
    if (newValue > register.getDbValue()) {
      while (newValue > register.getDbValue()) {
        register.setDbValue(register.getDbValue() + register.getDbIncrement());
      }
      Session session=null;
      try {
        session=openSession();
        Counter counter=(Counter)session.get(Counter.class,register.getName(),LockMode.UPGRADE);
        counter.setCurrentId(register.getDbValue());
        session.save(counter);
        session.flush();
      }
 catch (      HibernateException he) {
        throw new SystemException(he);
      }
 finally {
        closeSession(session);
      }
    }
    register.setCurrentValue(newValue);
    return newValue;
  }
}
