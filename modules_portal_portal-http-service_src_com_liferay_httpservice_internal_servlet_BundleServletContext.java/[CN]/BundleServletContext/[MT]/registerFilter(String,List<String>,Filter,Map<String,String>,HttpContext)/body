{
  validateFilter(filterName,filter,urlPatterns,httpContext);
  Thread currentThread=Thread.currentThread();
  ClassLoader contextClassLoader=currentThread.getContextClassLoader();
  try {
    currentThread.setContextClassLoader(getClassLoader());
    FilterConfig filterConfig=new BundleFilterConfig(this,filterName,initParameters,httpContext);
    filter.init(filterConfig);
    _filtersByFilterNames.put(filterName,filter);
    if (_log.isInfoEnabled()) {
      _log.info("Registered filter " + filterName);
    }
    for (    String urlPattern : urlPatterns) {
      _filtersByURLPatterns.put(urlPattern,filter);
      if (_log.isInfoEnabled()) {
        _log.info("Mapped filter " + filterName + " to "+ getContextPath()+ urlPattern);
      }
    }
    FilterServiceRanking filterServiceRanking=new FilterServiceRanking();
    filterServiceRanking.setFilterName(filterName);
    int serviceRanking=_FILTER_SERVICE_RANKING_DEFAULT;
    if (initParameters != null) {
      serviceRanking=GetterUtil.getInteger(initParameters.remove("service.ranking"),_FILTER_SERVICE_RANKING_DEFAULT);
    }
    filterServiceRanking.setServiceRanking(serviceRanking);
    filterServiceRanking.setUrlPattterns(urlPatterns);
    _filterServiceRankings.add(filterServiceRanking);
  }
  finally {
    currentThread.setContextClassLoader(contextClassLoader);
  }
}
