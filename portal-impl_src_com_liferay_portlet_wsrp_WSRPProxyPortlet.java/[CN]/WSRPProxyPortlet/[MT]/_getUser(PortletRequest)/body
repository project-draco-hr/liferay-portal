{
  User user=null;
  Principal userPrincipal=request.getUserPrincipal();
  if (userPrincipal != null) {
    String userKey=userPrincipal.getName();
    user=_consumerEnv.getUserRegistry().getUser(userKey);
    if (user == null) {
      user=new UserImpl(userKey);
      UserContext userContext=new UserContext();
      userContext.setProfile(_fillUserProfile(request));
      userContext.setUserContextKey(userKey);
      user.setUserContext(userContext);
      _consumerEnv.getUserRegistry().addUser(user);
    }
  }
  return user;
}
