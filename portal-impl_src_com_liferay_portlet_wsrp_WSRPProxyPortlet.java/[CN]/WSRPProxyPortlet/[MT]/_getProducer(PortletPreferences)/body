{
  final String MN="getProducer";
  if (_logger.isLogging(Logger.TRACE_HIGH)) {
    _logger.text(Logger.TRACE_HIGH,MN,"Trying to load producer with ID :" + _getProducerID(preferences));
  }
  String producerID=_getProducerID(preferences);
  ProducerRegistry producerReg=_consumerEnv.getProducerRegistry();
  Producer producer=producerReg.getProducer(producerID);
  if (producer == null) {
    String wsrpServiceUrl=preferences.getValue("wsrp-service-url",StringPool.BLANK);
    String markupEndpoint=preferences.getValue("markup-endpoint",StringPool.BLANK);
    String serviceDescriptionEndpoint=preferences.getValue("service-description-endpoint",StringPool.BLANK);
    String registrationEndpoint=preferences.getValue("registration-endpoint",StringPool.BLANK);
    String portletManagementEndpoint=preferences.getValue("portlet-management-endpoint",StringPool.BLANK);
    markupEndpoint=wsrpServiceUrl + "/" + markupEndpoint;
    serviceDescriptionEndpoint=wsrpServiceUrl + "/" + serviceDescriptionEndpoint;
    registrationEndpoint=wsrpServiceUrl + "/" + registrationEndpoint;
    portletManagementEndpoint=wsrpServiceUrl + "/" + portletManagementEndpoint;
    RegistrationData regData=new RegistrationData();
    regData.setConsumerName("Liferay WSRP Agent");
    regData.setConsumerAgent("Liferay WSRP Agent");
    producer=new ProducerImpl(producerID,markupEndpoint,serviceDescriptionEndpoint,registrationEndpoint,portletManagementEndpoint,regData);
    producerReg.addProducer(producer);
  }
  if (producer == null) {
    WSRPXHelper.throwX(_logger,Logger.ERROR,MN,ErrorCodes.PRODUCER_DOES_NOT_EXIST);
  }
  return producer;
}
