{
  String MN="render";
  if (_logger.isLogging(Logger.TRACE_HIGH)) {
    _logger.entry(Logger.TRACE_HIGH,MN);
  }
  try {
    renderResponse.setContentType(request.getResponseContentType());
    User user=_getUser(request);
    String userID=null;
    if (user != null) {
      userID=user.getUserID();
    }
    PortletPreferences preferences=request.getPreferences();
    PortletKey portletKey=_getPortletKey(preferences);
    WSRPPortlet portlet=_getPortlet(portletKey,preferences);
    PortletWindowSession windowSession=_getWindowSession(userID,portlet,request);
    PortletDriver portletDriver=_consumerEnv.getPortletDriverRegistry().getPortletDriver(portlet);
    MarkupRequest markupRequest=new WSRPRequestImpl(windowSession,request,true);
synchronized (_urlGenLock) {
      Company company=null;
      try {
        company=PortalUtil.getCompany(request);
      }
 catch (      Exception e) {
        throw new PortletException(e);
      }
      URLGenerator urlGenerator=new URLGeneratorImpl(renderResponse,company.getKeyObj());
      URLTemplateComposer templateComposer=_consumerEnv.getTemplateComposer();
      if (templateComposer != null) {
        templateComposer.setURLGenerator(urlGenerator);
      }
      _consumerEnv.getURLRewriter().setURLGenerator(urlGenerator);
    }
    MarkupResponse response=null;
    try {
      response=portletDriver.getMarkup(markupRequest,userID);
      _checker.check(response);
    }
 catch (    java.rmi.RemoteException wsrpFault) {
      WSRPXHelper.handleWSRPFault(_logger,wsrpFault);
    }
    if (response != null) {
      if (windowSession != null) {
        _updateSessionContext(response.getSessionContext(),windowSession.getPortletSession());
      }
      _processMarkupContext(response.getMarkupContext(),request,renderResponse);
    }
    if (windowSession != null) {
      windowSession.updateMarkupCache(null);
    }
  }
 catch (  WSRPException e) {
    throw new PortletException("Error occured while retrieving markup",e);
  }
 finally {
    if (_logger.isLogging(Logger.TRACE_HIGH)) {
      _logger.exit(Logger.TRACE_HIGH,MN);
    }
  }
}
