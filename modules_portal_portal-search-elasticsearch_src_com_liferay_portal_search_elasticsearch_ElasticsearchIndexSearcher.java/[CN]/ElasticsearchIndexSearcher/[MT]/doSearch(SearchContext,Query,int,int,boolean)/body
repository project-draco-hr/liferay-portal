{
  Client client=_elasticsearchConnectionManager.getClient();
  QueryConfig queryConfig=query.getQueryConfig();
  String[] selectedIndexNames=queryConfig.getSelectedIndexNames();
  SearchRequestBuilder searchRequestBuilder=null;
  if (ArrayUtil.isEmpty(selectedIndexNames)) {
    searchRequestBuilder=client.prepareSearch(String.valueOf(searchContext.getCompanyId()));
  }
 else {
    searchRequestBuilder=client.prepareSearch(selectedIndexNames);
  }
  if (!count) {
    addFacets(searchRequestBuilder,searchContext);
    addHighlights(searchRequestBuilder,queryConfig);
    addPagination(searchRequestBuilder,start,end);
    addSelectedFields(searchRequestBuilder,queryConfig);
    addSort(searchRequestBuilder,searchContext.getSorts());
    searchRequestBuilder.setTrackScores(queryConfig.isScoreEnabled());
  }
 else {
    searchRequestBuilder.setSize(0);
  }
  QueryBuilder queryBuilder=QueryBuilders.queryString(query.toString());
  searchRequestBuilder.setQuery(queryBuilder);
  String[] selectedTypes=queryConfig.getSelectedTypes();
  if (ArrayUtil.isEmpty(selectedTypes)) {
    searchRequestBuilder.setTypes(DocumentTypes.LIFERAY);
  }
 else {
    searchRequestBuilder.setTypes(selectedTypes);
  }
  SearchRequest searchRequest=searchRequestBuilder.request();
  ActionFuture<SearchResponse> future=client.search(searchRequest);
  SearchResponse searchResponse=future.actionGet();
  if (_log.isInfoEnabled()) {
    _log.info("The search engine processed " + queryBuilder.toString() + "in "+ searchResponse.getTook());
  }
  return searchResponse;
}
