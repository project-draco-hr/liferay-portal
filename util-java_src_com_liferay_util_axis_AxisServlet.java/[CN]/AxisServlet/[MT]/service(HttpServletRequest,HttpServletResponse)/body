{
  try {
    if (!_ready) {
      return;
    }
    StringServletResponse stringResponse=new StringServletResponse(response);
    super.service(request,stringResponse);
    String contentType=stringResponse.getContentType();
    response.setContentType(contentType);
    String content=stringResponse.getString();
    if (_fixContent) {
      if (contentType.contains(ContentTypes.TEXT_HTML)) {
        content=_HTML_TOP_WRAPPER.concat(content).concat(_HTML_BOTTOM_WRAPPER);
      }
 else       if (contentType.contains(ContentTypes.TEXT_XML)) {
        content=fixXml(content);
      }
    }
    ServletResponseUtil.write(new UncommittedServletResponse(response),content.getBytes(StringPool.UTF8));
  }
 catch (  IOException ioe) {
    throw ioe;
  }
catch (  ServletException se) {
    throw se;
  }
catch (  Exception e) {
    throw new ServletException(e);
  }
 finally {
    try {
      ThreadLocal<?> cacheThreadLocal=(ThreadLocal<?>)_cacheField.get(null);
      if (cacheThreadLocal != null) {
        cacheThreadLocal.remove();
      }
    }
 catch (    Exception e) {
      _log.error(e,e);
    }
  }
}
