{
  try {
    if (!_ready) {
      return;
    }
    BufferCacheServletResponse bufferCacheServletResponse=new BufferCacheServletResponse(response);
    super.service(request,bufferCacheServletResponse);
    String contentType=bufferCacheServletResponse.getContentType();
    response.setContentType(contentType);
    String content=bufferCacheServletResponse.getString();
    if (_fixContent) {
      if (contentType.contains(ContentTypes.TEXT_HTML)) {
        content=_HTML_TOP_WRAPPER.concat(content).concat(_HTML_BOTTOM_WRAPPER);
      }
 else       if (contentType.contains(ContentTypes.TEXT_XML)) {
        content=fixXml(content);
      }
    }
    ServletResponseUtil.write(new UncommittedServletResponse(response),content.getBytes(StringPool.UTF8));
  }
 catch (  IOException ioe) {
    throw ioe;
  }
catch (  ServletException se) {
    throw se;
  }
catch (  Exception e) {
    throw new ServletException(e);
  }
 finally {
    try {
      ThreadLocal<?> cache=(ThreadLocal<?>)_cacheField.get(null);
      if (cache != null) {
        cache.remove();
      }
    }
 catch (    Exception e) {
      _log.error(e,e);
    }
  }
}
