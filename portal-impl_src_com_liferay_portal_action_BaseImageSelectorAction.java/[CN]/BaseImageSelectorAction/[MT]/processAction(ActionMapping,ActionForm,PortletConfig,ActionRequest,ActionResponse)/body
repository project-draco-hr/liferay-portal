{
  UploadPortletRequest uploadPortletRequest=PortalUtil.getUploadPortletRequest(actionRequest);
  ThemeDisplay themeDisplay=(ThemeDisplay)actionRequest.getAttribute(WebKeys.THEME_DISPLAY);
  checkPermission(themeDisplay.getScopeGroupId(),themeDisplay.getPermissionChecker());
  UploadException uploadException=(UploadException)actionRequest.getAttribute(WebKeys.UPLOAD_EXCEPTION);
  if (uploadException != null) {
    if (uploadException.isExceededLiferayFileItemSizeLimit()) {
      throw new LiferayFileItemException();
    }
 else     if (uploadException.isExceededSizeLimit()) {
      throw new FileSizeException(uploadException.getCause());
    }
    throw new PortalException(uploadException.getCause());
  }
  JSONObject jsonObject=JSONFactoryUtil.createJSONObject();
  InputStream inputStream=null;
  try {
    JSONObject imageJSONObject=JSONFactoryUtil.createJSONObject();
    imageJSONObject.put("dataImageIdAttribute",EditorConstants.DATA_IMAGE_ID_ATTRIBUTE);
    String fileName=uploadPortletRequest.getFileName("imageSelectorFileName");
    String contentType=uploadPortletRequest.getContentType("imageSelectorFileName");
    long size=uploadPortletRequest.getSize("imageSelectorFileName");
    validateFile(fileName,contentType,size);
    inputStream=uploadPortletRequest.getFileAsStream("imageSelectorFileName");
    String mimeType=MimeTypesUtil.getContentType(inputStream,fileName);
    FileEntry fileEntry=TempFileEntryUtil.addTempFileEntry(themeDisplay.getScopeGroupId(),themeDisplay.getUserId(),_TEMP_FOLDER_NAME,StringUtil.randomString() + fileName,inputStream,mimeType);
    imageJSONObject.put("dataImageIdAttribute",EditorConstants.DATA_IMAGE_ID_ATTRIBUTE);
    imageJSONObject.put("fileEntryId",fileEntry.getFileEntryId());
    imageJSONObject.put("url",PortletFileRepositoryUtil.getPortletFileEntryURL(themeDisplay,fileEntry,StringPool.BLANK));
    jsonObject.put("image",imageJSONObject);
    jsonObject.put("success",Boolean.TRUE);
  }
 catch (  Exception e) {
    handleUploadException(actionRequest,actionResponse,e,jsonObject);
  }
 finally {
    StreamUtil.cleanUp(inputStream);
  }
  writeJSON(actionRequest,actionResponse,jsonObject);
}
